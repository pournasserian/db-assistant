{"Title":null,"Name":"Default","Description":null,"ConnectionString":null,"Tables":[{"Name":"AssignmentFailureReason","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false}]},{"Name":"AssignmentMethod","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"AssignmentType","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false}]},{"Name":"CheckStatusDeliveryServiceProvider","Schema":"dbo","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ProviderOrderId","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false},{"Name":"JsonValue","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":-1,"IsPrimaryKey":false}]},{"Name":"CityDefaultCoefficientAvailable","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CityId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"FromDistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ToDistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DelaySecond","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OrderCategoryId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"VendorId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ProvinceId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"CoefficientConfigByPendingOrder","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CityId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"FromPercentage","DataType":"float","Precision":53,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ToPercentage","DataType":"float","Precision":53,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"Alopeyk","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"Motopeyk","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"Miare","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false}]},{"Name":"CoefficientProviderConfig","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"StoreId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FromDistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ToDistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DelaySecond","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"DeliveryServiceProvider","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"DefaultFleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false},{"Name":"MainOperationStaffId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"DeliveryServiceProviderMapperStatus","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"DeliveryServiceProviderRequestMapper","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderOrderId","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":100,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderMapperStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Version","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"Price","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"DispatchRequest","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"PolygonStoreId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DispatchRequestStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CourierRequestTypeId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ParcelReferenceCode","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ClientLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ClientAddress","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1024,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryStartTime","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryDeadLineTime","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryStartTimePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryDeadLineTimePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ModifierUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":100,"IsPrimaryKey":false},{"Name":"VendorParcelCode","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":32,"IsPrimaryKey":false},{"Name":"AssignmentTryCount","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"RowVersion","DataType":"timestamp","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"IsExclusiveDelivery","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__DispatchR__IsExc__042044DF","DefaultValue":"((0))","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"IsNightly","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__DispatchR__IsNig__154AD0E1","DefaultValue":"((0))","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"VendorId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__DispatchR__Vendo__217B9D9C","DefaultValue":"((37))","IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsWaitingForSupport","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__DispatchR__IsWai__17881F0E","DefaultValue":"((0))","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__DispatchR__Deliv__62B52F73","DefaultValue":"((1))","IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"DeliveryCode","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_DispatchRequest_DeliveryCode","DefaultValue":"((1))","IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Plaque","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":200,"IsPrimaryKey":false},{"Name":"Unit","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":100,"IsPrimaryKey":false},{"Name":"Floor","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":100,"IsPrimaryKey":false},{"Name":"PickupStartTime","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"PickupDeadLineTime","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"PickupStartTimePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"PickupDeadLineTimePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"Version","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_DispatchRequest_Version","DefaultValue":"((0))","IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"PreparationTime","DataType":"datetime","Precision":23,"Scale":3,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"SearchingStartTime","DataType":"datetime","Precision":23,"Scale":3,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"DispatchRequestAttribute","Schema":"DP","Columns":[{"Name":"Id","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"DispatchRequestAttributeAllowedValue","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DispatchRequestAttributeId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"DispatchRequestAttributeValue","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DispatchRequestAttributeAllowedValueId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"DispatchRequestFleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetPreAssignmentStateId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__DispatchR__Deliv__6685C057","DefaultValue":"((1))","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__DispatchR__Creat__6779E490","DefaultValue":"(\u0027System|System\u0027)","IsNullable":false,"MaxLength":50,"IsPrimaryKey":false}]},{"Name":"DispatchRequestStatus","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false},{"Name":"DispatchRequestStatusCategoryId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"DispatchRequestStatusCategory","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false}]},{"Name":"DispatchRequestStatusHistory","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DispatchRequestStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"Location","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ExceptionDescription","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8000,"IsPrimaryKey":false},{"Name":"DistanceFromPointMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsOutOfLocation","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__DispatchR__IsOut__09560295","DefaultValue":"((0))","IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false},{"Name":"Version","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_DispatchRequestStatusHistory_Version","DefaultValue":"((0))","IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"CustomerRoleId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"EntityType","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"ErrorLog","Schema":"SB","Columns":[{"Name":"ErrorTime","DataType":"datetime","Precision":23,"Scale":3,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":256,"IsPrimaryKey":false},{"Name":"ErrorNumber","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ErrorSevirity","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ErrorState","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ErrorProcedure","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":256,"IsPrimaryKey":false},{"Name":"ErrorLine","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ErrorMessage","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8000,"IsPrimaryKey":false},{"Name":"CommandMSG","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8000,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"HashID","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState_2","Schema":"DP","Columns":[{"Name":"Id","DataType":"uniqueidentifier","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_FleetPreAssignmentState_2_id","DefaultValue":"(newid())","IsNullable":false,"MaxLength":16,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentState_tbl","Schema":"dbo","Columns":[{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"fleetlat","DataType":"float","Precision":53,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"fleetlong","DataType":"float","Precision":53,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1000,"IsPrimaryKey":false},{"Name":"StartlocationToPickuplat","DataType":"float","Precision":53,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"StartlocationToPickuplong","DataType":"float","Precision":53,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":50,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentStateLog","Schema":"DP","Columns":[{"Name":"Id","DataType":"uniqueidentifier","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":16,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPreAssignmentStateLog_2","Schema":"DP","Columns":[{"Name":"Id","DataType":"uniqueidentifier","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":16,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TodayDeliveredParcelCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ArrivalDurationTime","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetLocation","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DispatchRequestIds","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2000,"IsPrimaryKey":false},{"Name":"OngoingDispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OngoingShipments","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4000,"IsPrimaryKey":false},{"Name":"StartlocationToPickup","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetPricingConfigMapper","Schema":"DP","Columns":[{"Name":"DispatchRequestAttributeAllowedValueId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetPricingConfigId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"FleetRadius","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"PendingOrderFrom","DataType":"decimal","Precision":5,"Scale":2,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":5,"IsPrimaryKey":false},{"Name":"PendingOrderTo","DataType":"decimal","Precision":5,"Scale":2,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":5,"IsPrimaryKey":false},{"Name":"PendingOrderMaxDistance","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PendingOrderMaxEta","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ProposeRadius","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"ForecastFleet","Schema":"DP","Columns":[{"Name":"ProvinceId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CityId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"EstimatedOrder","DataType":"float","Precision":53,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"EstimatedBiker","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Mo2b","DataType":"float","Precision":53,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"BikerShortage","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"ForecastFleet_Archive","Schema":"DP","Columns":[{"Name":"ProvinceId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CityId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"EstimatedOrder","DataType":"float","Precision":53,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"EstimatedBiker","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Mo2b","DataType":"float","Precision":53,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"BikerShortage","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"MapServiceProvider","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Title","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":64,"IsPrimaryKey":false}]},{"Name":"MapServiceProviderApi","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"MapServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"APIName","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"APITitle","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":256,"IsPrimaryKey":false}]},{"Name":"NavigationServiceCallingRecord","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"MapServiceProviderApiId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ActionMethod","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":64,"IsPrimaryKey":false},{"Name":"Body","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ResponseJson","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ResponseCode","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"NotificationHistory","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"datetime","Precision":23,"Scale":3,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"char","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":23,"IsPrimaryKey":false},{"Name":"EntityTypeId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"NotificationTypeId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Value","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"NotificationType","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"NotPickupRequestReviewMethod","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"OperationFailureReason","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OperationTypeId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ParentId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false},{"Name":"OnlyForExclusiveDelivery","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"IsDescriptionRequired","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OnlyForOperationStaff","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"UnsuccessfulOperationReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"OperationStaff","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CustomerId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Code","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FirstName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false},{"Name":"LastName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false},{"Name":"Mobile","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"OperationType","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false},{"Name":"FixedTimeSpentSeconds","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"DynamicTimeSpentSeconds","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false}]},{"Name":"Polygon","Schema":"DP","Columns":[{"Name":"Id","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"CityId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Border","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"AssignmentMethodId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"MaximumDispatchRadiusMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_Polygon_MaximumDispatchRadiusMeter","DefaultValue":"((900))","IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"RequiredConfirmationDispatchingTimeTypeId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"PersianTitle","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":500,"IsPrimaryKey":false},{"Name":"HasPolygonCapacity","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"PolygonAssignmentReason","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false}]},{"Name":"PolygonAssignmentResult","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"StoreId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"PolygonAssignmentReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"IsSuccessful","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"PolygonBorderModificationHistory","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"Border","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":50,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"PolygonCapacityHistory","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"OldHasPolygonCapacity","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":50,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"PolygonConfig","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":256,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DefaultValue","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":16,"IsPrimaryKey":false},{"Name":"IsOverwriteAllowed","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false},{"Name":"ValueDataType","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":20,"IsPrimaryKey":false},{"Name":"MinValue","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":16,"IsPrimaryKey":false},{"Name":"MaxValue","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":16,"IsPrimaryKey":false}]},{"Name":"PolygonConfigHistory","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"PolygonConfigId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":256,"IsPrimaryKey":false},{"Name":"DefaultValue","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":16,"IsPrimaryKey":false},{"Name":"IsOverwriteAllowed","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false},{"Name":"ValueDataType","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":20,"IsPrimaryKey":false},{"Name":"MinValue","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":16,"IsPrimaryKey":false},{"Name":"MaxValue","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":16,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"PolygonConfigOverwrite","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"PolygonConfigId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Value","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":16,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"PolygonConfigOverwriteHistory","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"PolygonConfigOverwriteId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"PolygonConfigId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Value","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":16,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"PolygonOperationStaff","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"OperationStaffId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ModifierUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":100,"IsPrimaryKey":false}]},{"Name":"PolygonStore","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"StoreId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ModifierUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":100,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false},{"Name":"AssignmentType","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_PolygonStore_AssignmentType","DefaultValue":"((2))","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"IsApprovedByOperationStaff","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ApproveDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ApproveDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ApproverUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":100,"IsPrimaryKey":false}]},{"Name":"PreAssignmentStoreScore","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"StoreId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Score","DataType":"decimal","Precision":8,"Scale":2,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":5,"IsPrimaryKey":false},{"Name":"RunCode","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"StoreFactor","DataType":"decimal","Precision":3,"Scale":2,"IsIdentity":false,"DefaultConstraint":"DF__PreAssign__Score__478C37EB","DefaultValue":"((1))","IsNullable":false,"MaxLength":5,"IsPrimaryKey":false}]},{"Name":"PreparationTimeHistory","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DispatchRequestVersion","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"PreparationTime","DataType":"datetime","Precision":23,"Scale":3,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"datetime","Precision":23,"Scale":3,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"SearchingStartTime","DataType":"datetime","Precision":23,"Scale":3,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"SearchingTimeSecond","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ArraivalEstimationSecond","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PreparationTimeReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":256,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":512,"IsPrimaryKey":false}]},{"Name":"PreparationTimeReason","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":250,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":512,"IsPrimaryKey":false}]},{"Name":"Published","Schema":"CAP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"Version","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":40,"IsPrimaryKey":false},{"Name":"Name","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":400,"IsPrimaryKey":false},{"Name":"Content","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"Retries","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Added","DataType":"datetime2","Precision":27,"Scale":7,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ExpiresAt","DataType":"datetime2","Precision":27,"Scale":7,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"StatusName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false}]},{"Name":"Received","Schema":"CAP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"Version","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":40,"IsPrimaryKey":false},{"Name":"Name","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":400,"IsPrimaryKey":false},{"Name":"Group","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":400,"IsPrimaryKey":false},{"Name":"Content","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"Retries","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Added","DataType":"datetime2","Precision":27,"Scale":7,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ExpiresAt","DataType":"datetime2","Precision":27,"Scale":7,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"StatusName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false}]},{"Name":"RefusalReason","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":200,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_RefusalReason_IsActive","DefaultValue":"((1))","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"OperationFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_RefusalReason_DeliveryServiceProviderId","DefaultValue":"((2))","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"RequiredConfirmationDispatchingTimeType","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false}]},{"Name":"Shipment","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ShipmentNumber","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"TotalEstimatedDurationSeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"TotalDistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"UpdateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ModifierUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":100,"IsPrimaryKey":false},{"Name":"SuggestedRoute","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"RowVersion","DataType":"timestamp","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"SuggestedRouteJson","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__Shipment__Delive__61C10B3A","DefaultValue":"((1))","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"FleetShiftId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"TypeOfShipmentId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ApproveShipmentTime","DataType":"datetime","Precision":23,"Scale":3,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"FleetToSourceJsonRoute","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"FleetToSourceRoute","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false}]},{"Name":"ShipmentDestinationPoint","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"OperationTypeId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ShipmentDestinationPointStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"AssignmentMethodId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Location","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"IsVendorLocation","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"SequenceNumber","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DisplacementMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"EstimatedDurationSeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"EstimatedOperationTimeSeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"EstimatedArrivalTime","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"EstimatedArrivalTimePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ModifierUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":100,"IsPrimaryKey":false},{"Name":"MapServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"RowVersion","DataType":"timestamp","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"IsApproachedByDriver","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__ShipmentD__IsApp__710D706B","DefaultValue":"(\u0027False\u0027)","IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"FleetPayableCost","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"BikerWaitingStartTime","DataType":"datetime","Precision":23,"Scale":3,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"BikerWaitingDuration","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"BikerWaitingFleetInCome","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"ShipmentDestinationPointDispatchRequest","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ShipmentDestinationPointId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"Version","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_ShipmentDestinationPointDispatchRequest_Version","DefaultValue":"((0))","IsNullable":true,"MaxLength":2,"IsPrimaryKey":false}]},{"Name":"ShipmentDestinationPointStatus","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false}]},{"Name":"ShipmentFleetLocationHistory","Schema":"DP","Columns":[{"Name":"FleetLocationHistoryId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"ShipmentModificationHistory","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ShipmentModificationReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"StoreId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DispatchRequestCount","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"TotalEstimatedDurationSeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"TotalDistanceMeter","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"SuggestedRoute","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ArrivalDelaySeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ShipmentData","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ShipmentModifier","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":50,"IsPrimaryKey":false}]},{"Name":"ShipmentModificationReason","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false}]},{"Name":"ShipmentStatus","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false}]},{"Name":"ShipmentStatusHistory","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ShipmentStatusId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"Store","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"VendorId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Location","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"ResponsibleMobile","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ResponsibleName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Phone","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"Address","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":512,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CityId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"VendorCode","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":50,"IsPrimaryKey":false},{"Name":"OrderCategoryId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_Store_OrderCategoryId","DefaultValue":"((5))","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"StoreType","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_Store_StoreType","DefaultValue":"((1))","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"StorePendingOrder","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"StoreId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PendingOrder","DataType":"decimal","Precision":5,"Scale":2,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":5,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"datetime","Precision":23,"Scale":3,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UnassignedOrdersCount","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"AssignedOrdersCount","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"StorePreAssignmentScoreDetail","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PreAssignmentStoreScoreId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"DispatchRequestPoint","DataType":"decimal","Precision":3,"Scale":2,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":5,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"StoreScoreCategoryConfiguration","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"From","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"To","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__StoreScor__IsAct__3BE3E467","DefaultValue":"(\u00271\u0027)","IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"DefaultPoint","DataType":"decimal","Precision":5,"Scale":2,"IsIdentity":false,"DefaultConstraint":"DF__StoreScor__Defau__34796377","DefaultValue":"((1))","IsNullable":false,"MaxLength":5,"IsPrimaryKey":false}]},{"Name":"StoreScoreSetting","Schema":"DP","Columns":[{"Name":"Id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"PolygonId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":2,"IsPrimaryKey":false},{"Name":"StoreScoreCategoryConfigurationId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Point","DataType":"decimal","Precision":5,"Scale":2,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":5,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false}]},{"Name":"StoreTechnicalBasicInformation","Schema":"DP","Columns":[{"Name":"StoreId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsCheckingArrivalPossible","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ScoreFactor","DataType":"decimal","Precision":5,"Scale":2,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":5,"IsPrimaryKey":false},{"Name":"TimeIntervalUntilCancellation","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"NotPickupRequestReviewMethodId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"NumberOfRequestsForNotPickupWithVendorProblem","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"NotPickupRequestReviewThresholdMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureAfterOriginArrivalMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetAssignmentFirstNotifyMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetAssignmentSecondNotifyMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureAfterAssignmentMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetPickupNotificationMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ReturnRequestResponseThresholdMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetForcedBikerWaiting","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsDeliveryCodeRequired","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"IsReturnCodeRequired","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"MinimumValueForDeliveryCode","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsDeliveryCodeIssuedByVendor","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"StoreOrderPriority","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__StoreTech__Store__6BA04686","DefaultValue":"((1))","IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"MaximumAssignmentRadius","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ForcedAssignmentRadius","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"MaximumOriginArrivalEtaSeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"StoreTechnicalBasicInformationDefault","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CityId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"VendorId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"OrderCategoryId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"IsCheckingArrivalPossible","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"ScoreFactor","DataType":"decimal","Precision":5,"Scale":2,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":5,"IsPrimaryKey":false},{"Name":"TimeIntervalUntilCancellation","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"NotPickupRequestReviewMethodId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"NumberOfRequestsForNotPickupWithVendorProblem","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"NotPickupRequestReviewThresholdMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureAfterOriginArrivalMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetAssignmentFirstNotifyMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetAssignmentSecondNotifyMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureAfterAssignmentMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetPickupNotificationMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ReturnRequestResponseThresholdMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetForcedBikerWaiting","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsDeliveryCodeRequired","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"IsReturnCodeRequired","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"MinimumValueForDeliveryCode","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsDeliveryCodeIssuedByVendor","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"StoreOrderPriority","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__StoreTech__Store__074860FB","DefaultValue":"((1))","IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"MaximumAssignmentRadius","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ForcedAssignmentRadius","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"MaximumOriginArrivalEtaSeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ProvinceId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"StoreTechnicalBasicInformationDefaultLog","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CityId","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"VendorId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsCheckingArrivalPossible","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false},{"Name":"ScoreFactor","DataType":"decimal","Precision":5,"Scale":2,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":5,"IsPrimaryKey":false},{"Name":"TimeIntervalUntilCancellation","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"NotPickupRequestReviewMethodId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"NumberOfRequestsForNotPickupWithVendorProblem","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"NotPickupRequestReviewThresholdMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureAfterOriginArrivalMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetAssignmentFirstNotifyMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetAssignmentSecondNotifyMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureAfterAssignmentMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetPickupNotificationMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ReturnRequestResponseThresholdMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetForcedBikerWaiting","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsDeliveryCodeRequired","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"IsReturnCodeRequired","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"MinimumValueForDeliveryCode","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsDeliveryCodeIssuedByVendor","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"StoreOrderPriority","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__StoreTech__Store__0B18F1DF","DefaultValue":"((1))","IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"MaximumAssignmentRadius","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ForcedAssignmentRadius","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"MaximumOriginArrivalEtaSeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"OrderCategoryId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"StoreTechnicalBasicInformationDefaultId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"ProvinceId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"StoreTechnicalBasicInformationLog","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"StoreId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsCheckingArrivalPossible","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":100,"IsPrimaryKey":false},{"Name":"ScoreFactor","DataType":"decimal","Precision":5,"Scale":2,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":5,"IsPrimaryKey":false},{"Name":"TimeIntervalUntilCancellation","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"NotPickupRequestReviewMethodId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"NumberOfRequestsForNotPickupWithVendorProblem","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"NotPickupRequestReviewThresholdMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureAfterOriginArrivalMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetAssignmentFirstNotifyMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetAssignmentSecondNotifyMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureAfterAssignmentMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetPickupNotificationMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetRecaptureMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ReturnRequestResponseThresholdMinutes","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"FleetForcedBikerWaiting","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsDeliveryCodeRequired","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"IsReturnCodeRequired","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"MinimumValueForDeliveryCode","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"IsDeliveryCodeIssuedByVendor","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"StoreOrderPriority","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF__StoreTech__Store__6C946ABF","DefaultValue":"((1))","IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"MaximumAssignmentRadius","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"ForcedAssignmentRadius","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"MaximumOriginArrivalEtaSeconds","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"sysdiagrams","Schema":"dbo","Columns":[{"Name":"name","DataType":"sysname","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"principal_id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"diagram_id","DataType":"int","Precision":10,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":4,"IsPrimaryKey":false},{"Name":"version","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"definition","DataType":"varbinary","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false}]},{"Name":"ThirdPartyDispatchRequestQueue","Schema":"DP","Columns":[{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"DataValue","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"Status","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"ThirdPartyDispatchRequestQueue_Old","Schema":"DP","Columns":[{"Name":"DeliveryServiceProviderId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DataValue","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"Sent","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false}]},{"Name":"TypeOfShipment","Schema":"DP","Columns":[{"Name":"Id","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Name","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":128,"IsPrimaryKey":false},{"Name":"Title","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":256,"IsPrimaryKey":false},{"Name":"IsActive","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1020,"IsPrimaryKey":false}]},{"Name":"UnsuccessfulOperationRequestHistory","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"OperationTypeId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreatorUserName","DataType":"varchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":50,"IsPrimaryKey":false},{"Name":"FleetId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"OperationStaffId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false},{"Name":"Location","DataType":"geometry","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":-1,"IsPrimaryKey":false},{"Name":"OperationFailureReasonId","DataType":"tinyint","Precision":3,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1,"IsPrimaryKey":false},{"Name":"Description","DataType":"nvarchar","Precision":0,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":1024,"IsPrimaryKey":false},{"Name":"ShipmentId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"Version","DataType":"smallint","Precision":5,"Scale":0,"IsIdentity":false,"DefaultConstraint":"DF_UnsuccessfulOperationRequestHistory_Version","DefaultValue":"((0))","IsNullable":true,"MaxLength":2,"IsPrimaryKey":false},{"Name":"CustomerRoleId","DataType":"int","Precision":10,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":4,"IsPrimaryKey":false}]},{"Name":"ZapDispatchRequest","Schema":"DP","Columns":[{"Name":"Id","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":true,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"DispatchRequestId","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"IsDeleted","DataType":"bit","Precision":1,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":1,"IsPrimaryKey":false},{"Name":"CreateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"CreateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":false,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDate","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false},{"Name":"UpdateDatePersian","DataType":"bigint","Precision":19,"Scale":0,"IsIdentity":false,"DefaultConstraint":null,"DefaultValue":null,"IsNullable":true,"MaxLength":8,"IsPrimaryKey":false}]}],"Views":[],"StoreProcedures":[{"Name":"AcceptOrderHelper","Schema":"dbo","Definition":"CREATE PROC [dbo].[AcceptOrderHelper]\r\n\r\nAS\r\n\r\n\r\nSET NOCOUNT ON\r\n\r\nDECLARE @Now NVARCHAR(MAX),\r\n\t\t@VendorApiCallingHistory_PastDays NVARCHAR(MAX)\r\n\r\nSELECT @Now = FORMAT(GETDATE(),\u0027yyyyMMdd\u0027,\u0027fa\u0027)\u002B\u0027060000000\u0027\r\nSELECT @VendorApiCallingHistory_PastDays = FORMAT(DATEADD(DAY,-3, GETDATE()),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027\r\n--select FORMAT(GETDATE(),\u0027yyyyMMdd\u0027,\u0027fa\u0027)\u002B\u0027060000000\u0027\r\n\r\n\r\n\r\nDECLARE @1Min NVARCHAR(MAX),\r\n\t\t@2Min NVARCHAR(MAX)\r\n\r\nSELECT @1Min = FORMAT(DATEADD(MINUTE,-1, GETDATE()),\u0027yyyyMMddhhmm\u0027)\u002B\u002700000\u0027\r\nSELECT @2Min = FORMAT(DATEADD(MINUTE,-2, GETDATE()),\u0027yyyyMMddhhmm\u0027)\u002B\u002700000\u0027\r\n\r\nDROP TABLE IF EXISTS #T\r\nCREATE TABLE #T(T NVARCHAR(max))\r\n\r\nDECLARE @DispatchRequestId NVARCHAR(max)\r\n    DECLARE DispatchRequest CURSOR\r\n    FOR SELECT  Request FROM \r\nCS_Log.[Haf].[VendorApiCallingHistory] WITH (NOLOCK)\r\nWHERE Url LIKE N\u0027%accept%\u0027\r\nAND CreateDate \u003E= @1Min\r\n    OPEN DispatchRequest;\r\n\r\n    FETCH NEXT FROM DispatchRequest INTO \r\n        @DispatchRequestId\r\n\r\n    WHILE @@FETCH_STATUS = 0\r\n        BEGIN\r\n            \r\n            DECLARE @TBL TABLE ( Req NVARCHAR(MAX) , Res NVARCHAR(MAX) , CD BIGINT, CDP BIGINT)\t\t\r\n\r\n\r\n\r\n\t\t\r\n\t\t\t\tDECLARE @Res NVARCHAR(MAX),\r\n\t\t\t\t\t\t@Req\tNVARCHAR(MAX)\r\n\t\t\t\t\r\n\t\t\t\tSET @Res = NULL\r\n\t\t\r\n\t\t\t\tSELECT @Req = SUBSTRING(@DispatchRequestId,CHARINDEX(\u0027\u0022OrderPartId\u0022:\u0022\u0027,@DispatchRequestId,1) \u002B LEN(\u0027\u0022OrderPartId\u0022:\u0022\u0027), 8)\r\n\t\t\t\tINSERT INTO #T\r\n\t\t\t\tSELECT @Req\r\n\r\n\t\t\t\r\n\r\n            FETCH NEXT FROM DispatchRequest INTO \r\n                @DispatchRequestId\r\n        END;\r\n\r\n    CLOSE DispatchRequest;\r\n\r\n    DEALLOCATE DispatchRequest;\r\n\r\n; WITH CTE_Parcels AS\r\n(\r\n\tSELECT DISTINCT p.ID , 1 AS [Type]\r\n\tFROM CS_OrderManagement.OM.Parcel AS p  WITH (NOLOCK)\r\n\tINNER JOIN CS_OrderManagement.OM.ParcelStatusHistory AS ph WITH (NOLOCK)\r\n\t\tON p.ID = ph.ParcelId\r\n\t\tAND ph.ParcelStatusId = 30\r\n\tWHERE pH.CreateDate \u003E= @2Min\r\n\tAND p.ParcelStatusId IN (30,35,40,80)\r\n\tAND p.VendorParcelCode NOT IN (SELECT T COLLATE Persian_100_CI_AI_SC_UTF8 FROM #T AS t)\r\n\tUNION ALL\r\n\tSELECT DISTINCT p.ID , 2 AS [Type]\r\n\tFROM CS_OrderManagement.OM.Parcel p WITH (NOLOCK)\r\n\tWHERE p.ParcelStatusId IN ( 30,35,40 ) and p.DeliveryDatePersian \u003E= @Now\r\n),CTE_P AS\r\n(\r\n\t   SELECT dr.VendorId, p.VendorParcelCode,dr.ParcelReferenceCode,p.ID as ParcelID, cr.VendorRedirectCode AS OrderID , ci.FleetId , cp.NationalCode , cph.PhoneNumber AS MobileNumber , parcels.Type , CASE WHEN p.ParcelStatusId = 40 THEN p.DeliveryCode ELSE NULL END  DeliveryCode\r\n\t   FROM CTE_Parcels parcels\r\n\t   INNER JOIN CS_OrderManagement.OM.Parcel p WITH (NOLOCK)\r\n\t\t\tON parcels.Id = p.ID\t\t\t\r\n\t   INNER JOIN CS_OrderManagement.OM.CourierInformation  ci WITH (NOLOCK)\r\n\t   \t   ON p.ID = ci.ParcelId\r\n\t   INNER JOIN CS_OrderManagement.OM.CourierRequest cr WITH (NOLOCK)\r\n\t   \t   ON p.CourierRequestId = cr.ID\r\n\t   INNER JOIN CS_Dispatcher.DP.DispatchRequest dr WITH (NOLOCK)\r\n\t   \t   ON p.DispatchRequestId = dr.ID\r\n\t   INNER JOIN CS_DriverManagement.DM.Fleet f WITH (NOLOCK)\r\n\t   \t   ON ci.FleetId = f.ID\r\n\t   INNER JOIN CS_DriverManagement.DM.Driver d WITH (NOLOCK)\r\n\t   \t   ON f.DriverId = d.ID\r\n\t   INNER JOIN CS_UserManagement.UM.CustomerProfile cp WITH (NOLOCK)\r\n\t   \t   ON d.CustomerId = cp.CustomerId\r\n\t   LEFT JOIN CS_UserManagement.um.CustomerPhone cph ON cph.CustomerId=d.CustomerId AND cph.IsDefault=1 AND cph.PhoneNumberType=1-- Mobile\r\n\t   --WHERE p.ParcelStatusId IN ( 30,35,40 ) and p.DeliveryDatePersian \u003E= @Now\r\n), CTE_H AS\r\n(\r\n\tSELECT SQ.* FROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\t\tRequest,\r\n\t\t\t\tREPLACE(SUBSTRING(SS_Request,1,CHARINDEX(\u0027\u0022\u0027,SS_Request,1)),\u0027\u0022\u0027,\u0027\u0027) VendorParcelCode\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tRequest,\r\n\t\t\t\t\tSS_Request\r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT ID,\r\n\t\t\t\t\t\tRequest,\r\n\t\t\t\t\t\tTRIM(SUBSTRING(Request,CHARINDEX(\u0027\u0022OrderPartId\u0022:\u0022\u0027,Request,1) \u002B LEN(\u0027\u0022OrderPartId\u0022:\u0022\u0027),LEN(Request))) SS_Request\r\n\t\t\t\t\tFROM\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT ID,\r\n\t\t\t\t\t\t\tREPLACE(REPLACE(Request,\u0027\\\u0027,\u0027\u0027),\u0027 \u0027,\u0027\u0027) Request \r\n\t\t\t\t\t\tFROM [CS_Log].[Haf].[VendorApiCallingHistory] h WITH (NOLOCK)\r\n\t\t\t\t\t\tWHERE Url LIKE \u0027%ACCEPT%\u0027\r\n\t\t\t\t\t\tAND REPLACE(Request,\u0027\\\u0027,\u0027\u0027) LIKE \u0027%OrderPartId%\u0027\r\n\t\t\t\t\t\tAND h.CreateDate \u003E= @VendorApiCallingHistory_PastDays\r\n\t\t\t\t\t\t--AND h.ID = 7717055\r\n\t\t\t\t\t) SQ\r\n\t\t\t\t) SQ\r\n\t\t\t\tWHERE CHARINDEX(\u0027\u0022\u0027,SS_Request,1) \u003E 0\r\n\t\t\t) SQ\r\n\t)SQ\r\n\tINNER JOIN CTE_P p \r\n\t\tON p.VendorParcelCode = SQ.VendorParcelCode\r\n\t\tAND p.Type = 2\r\n)\r\n\r\nSELECT DISTINCT\r\n\tp.VendorParcelCode,\r\n\tp.ParcelReferenceCode,\r\n\tp.ParcelID, \r\n\tp.OrderID , \r\n\tp.FleetId , \r\n\tp.NationalCode , \r\n\tp.MobileNumber ,\r\n\tp.DeliveryCode ,\r\n\tp.VendorID\r\nFROM CTE_P p\r\nLEFT JOIN CTE_H h\r\n\t   ON p.VendorParcelCode = h.VendorParcelCode\r\nWHERE \r\n(\r\n\t( h.Request IS NULL AND p.Type = 2 )\r\nOR\tp.Type = 1\r\n)\r\n"},{"Name":"Cross_INSERT_Auto_Dispatch","Schema":"dbo","Definition":"--select top 10  * from TESTDispatch order by CreateDate desc \r\nCREATE   PROCEDURE [dbo].[Cross_INSERT_Auto_Dispatch] \r\n--DECLARE\r\n\t@JsonMain\t\t\tNVARCHAR(MAX),--=(SELECT DispatchRequestJSON FROM TESTDispatch where CreateDate=\u00272022-07-05 16:17:10.770\u0027)  ,--=\u0027[{\u0022SelectedDispatchRequestIds\u0022:[2815,2821,2829,2836,2858],\u0022ShipmentFleetId\u0022:183,\u0022FleetPreAssignments\u0022:[{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2815,\u0022FailureReasons\u0022:20,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:2144,\u0022DistanceMeter\u0022:18952,\u0022CreateDate\u0022:20220613135252392,\u0022CreateDatePersian\u0022:14010323135252392},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2878,\u0022FailureReasons\u0022:30,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2142,\u0022DistanceMeter\u0022:19010,\u0022CreateDate\u0022:20220613135252394,\u0022CreateDatePersian\u0022:14010323135252394},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2821,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2142,\u0022DistanceMeter\u0022:19010,\u0022CreateDate\u0022:20220613135252394,\u0022CreateDatePersian\u0022:14010323135252394},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2815,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2142,\u0022DistanceMeter\u0022:19010,\u0022CreateDate\u0022:20220613135252394,\u0022CreateDatePersian\u0022:14010323135252394},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2829,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2142,\u0022DistanceMeter\u0022:19010,\u0022CreateDate\u0022:20220613135252394,\u0022CreateDatePersian\u0022:14010323135252394},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2836,\u0022FailureReasons\u0022:20,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:2144,\u0022DistanceMeter\u0022:18952,\u0022CreateDate\u0022:20220613135252392,\u0022CreateDatePersian\u0022:14010323135252392},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2883,\u0022FailureReasons\u0022:20,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:2144,\u0022DistanceMeter\u0022:18952,\u0022CreateDate\u0022:20220613135252393,\u0022CreateDatePersian\u0022:14010323135252393},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2872,\u0022FailureReasons\u0022:30,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2142,\u0022DistanceMeter\u0022:19010,\u0022CreateDate\u0022:20220613135252394,\u0022CreateDatePersian\u0022:14010323135252394},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2836,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2142,\u0022DistanceMeter\u0022:19010,\u0022CreateDate\u0022:20220613135252394,\u0022CreateDatePersian\u0022:14010323135252394},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2858,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2142,\u0022DistanceMeter\u0022:19010,\u0022CreateDate\u0022:20220613135252394,\u0022CreateDatePersian\u0022:14010323135252394},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2872,\u0022FailureReasons\u0022:20,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:2144,\u0022DistanceMeter\u0022:18952,\u0022CreateDate\u0022:20220613135252393,\u0022CreateDatePersian\u0022:14010323135252393},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2878,\u0022FailureReasons\u0022:20,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:2144,\u0022DistanceMeter\u0022:18952,\u0022CreateDate\u0022:20220613135252392,\u0022CreateDatePersian\u0022:14010323135252392}],\u0022Shipment\u0022:null},{\u0022SelectedDispatchRequestIds\u0022:[2816,2825,2831,2864,2866],\u0022ShipmentFleetId\u0022:150,\u0022FleetPreAssignments\u0022:[{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2816,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135252771,\u0022CreateDatePersian\u0022:14010323135252771},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2831,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135252771,\u0022CreateDatePersian\u0022:14010323135252771},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2825,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135252771,\u0022CreateDatePersian\u0022:14010323135252771},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2864,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135252771,\u0022CreateDatePersian\u0022:14010323135252771},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2866,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135252771,\u0022CreateDatePersian\u0022:14010323135252771},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2816,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:2277,\u0022DistanceMeter\u0022:20367,\u0022CreateDate\u0022:20220613135252825,\u0022CreateDatePersian\u0022:14010323135252825},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2825,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:2277,\u0022DistanceMeter\u0022:20367,\u0022CreateDate\u0022:20220613135252825,\u0022CreateDatePersian\u0022:14010323135252825},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2864,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:2277,\u0022DistanceMeter\u0022:20367,\u0022CreateDate\u0022:20220613135252825,\u0022CreateDatePersian\u0022:14010323135252825},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2831,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:2277,\u0022DistanceMeter\u0022:20367,\u0022CreateDate\u0022:20220613135252825,\u0022CreateDatePersian\u0022:14010323135252825},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2866,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:2277,\u0022DistanceMeter\u0022:20367,\u0022CreateDate\u0022:20220613135252825,\u0022CreateDatePersian\u0022:14010323135252825}],\u0022Shipment\u0022:null},{\u0022SelectedDispatchRequestIds\u0022:[],\u0022ShipmentFleetId\u0022:0,\u0022FleetPreAssignments\u0022:[{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2822,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253005,\u0022CreateDatePersian\u0022:14010323135253005},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2837,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253005,\u0022CreateDatePersian\u0022:14010323135253005},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2826,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253005,\u0022CreateDatePersian\u0022:14010323135253005},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2824,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253005,\u0022CreateDatePersian\u0022:14010323135253005},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2856,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253005,\u0022CreateDatePersian\u0022:14010323135253005},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2868,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2996819 35.7294088\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253005,\u0022CreateDatePersian\u0022:14010323135253005},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2822,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253006,\u0022CreateDatePersian\u0022:14010323135253006},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2826,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253006,\u0022CreateDatePersian\u0022:14010323135253006},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2824,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253006,\u0022CreateDatePersian\u0022:14010323135253006},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2837,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253006,\u0022CreateDatePersian\u0022:14010323135253006},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2856,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253006,\u0022CreateDatePersian\u0022:14010323135253006},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2868,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253006,\u0022CreateDatePersian\u0022:14010323135253006}],\u0022Shipment\u0022:null},{\u0022SelectedDispatchRequestIds\u0022:[2823,2830],\u0022ShipmentFleetId\u0022:197,\u0022FleetPreAssignments\u0022:[{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2823,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2093,\u0022DistanceMeter\u0022:23291,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2830,\u0022FailureReasons\u0022:5,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2093,\u0022DistanceMeter\u0022:23291,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2834,\u0022FailureReasons\u0022:30,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2093,\u0022DistanceMeter\u0022:23291,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2838,\u0022FailureReasons\u0022:30,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2093,\u0022DistanceMeter\u0022:23291,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2840,\u0022FailureReasons\u0022:30,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2093,\u0022DistanceMeter\u0022:23291,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2839,\u0022FailureReasons\u0022:30,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2093,\u0022DistanceMeter\u0022:23291,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2841,\u0022FailureReasons\u0022:30,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2093,\u0022DistanceMeter\u0022:23291,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2880,\u0022FailureReasons\u0022:30,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:2093,\u0022DistanceMeter\u0022:23291,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044}],\u0022Shipment\u0022:null},{\u0022SelectedDispatchRequestIds\u0022:[],\u0022ShipmentFleetId\u0022:0,\u0022FleetPreAssignments\u0022:[{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2827,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253129,\u0022CreateDatePersian\u0022:14010323135253129},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2854,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253129,\u0022CreateDatePersian\u0022:14010323135253129},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2881,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253129,\u0022CreateDatePersian\u0022:14010323135253129},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2835,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253129,\u0022CreateDatePersian\u0022:14010323135253129},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2862,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253129,\u0022CreateDatePersian\u0022:14010323135253129}],\u0022Shipment\u0022:null},{\u0022SelectedDispatchRequestIds\u0022:[],\u0022ShipmentFleetId\u0022:0,\u0022FleetPreAssignments\u0022:[{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2828,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253138,\u0022CreateDatePersian\u0022:14010323135253138},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2833,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253138,\u0022CreateDatePersian\u0022:14010323135253138},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2874,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253138,\u0022CreateDatePersian\u0022:14010323135253138},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2860,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253138,\u0022CreateDatePersian\u0022:14010323135253138},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2877,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253138,\u0022CreateDatePersian\u0022:14010323135253138},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2875,\u0022FailureReasons\u0022:10,\u0022Point\u0022:\u002251.2993545 35.7292844\u0022,\u0022ArrivalDurationTime\u0022:0,\u0022DistanceMeter\u0022:0,\u0022CreateDate\u0022:20220613135253138,\u0022CreateDatePersian\u0022:14010323135253138}],\u0022Shipment\u0022:null}]\u0027,\r\n\t@JsonShipments\t\tNVARCHAR(MAX),--=(SELECT ShipmentJSON FROM TESTDispatch where CreateDate=\u00272022-07-05 16:17:10.770\u0027),--=\u0027[{\u0022FleetId\u0022:183,\u0022TotalDistanceMeter\u0022:21942,\u0022TotalEstimatedDurationSeconds\u0022:4330,\u0022Status\u0022:10,\u0022ShipmentDestinationPoints\u0022:[{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2815,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.48301452398301 35.731995392373676\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:19010,\u0022EstimatedDurationSeconds\u0022:2142,\u0022EstimatedOperationTimeSeconds\u0022:550,\u0022EstimatedArrivalTime\u0022:20220613142834397,\u0022EstimatedArrivalTimePersian\u0022:14010323142834397,\u0022CreateDate\u0022:20220613135252398,\u0022CreateDatePersian\u0022:14010323135252398},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2821,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.48301452398301 35.731995392373676\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:19010,\u0022EstimatedDurationSeconds\u0022:2142,\u0022EstimatedOperationTimeSeconds\u0022:550,\u0022EstimatedArrivalTime\u0022:20220613142834397,\u0022EstimatedArrivalTimePersian\u0022:14010323142834397,\u0022CreateDate\u0022:20220613135252398,\u0022CreateDatePersian\u0022:14010323135252398},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2836,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.48301452398301 35.731995392373676\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:19010,\u0022EstimatedDurationSeconds\u0022:2142,\u0022EstimatedOperationTimeSeconds\u0022:550,\u0022EstimatedArrivalTime\u0022:20220613142834397,\u0022EstimatedArrivalTimePersian\u0022:14010323142834397,\u0022CreateDate\u0022:20220613135252398,\u0022CreateDatePersian\u0022:14010323135252398},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2858,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.48301452398301 35.731995392373676\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:19010,\u0022EstimatedDurationSeconds\u0022:2142,\u0022EstimatedOperationTimeSeconds\u0022:550,\u0022EstimatedArrivalTime\u0022:20220613142834397,\u0022EstimatedArrivalTimePersian\u0022:14010323142834397,\u0022CreateDate\u0022:20220613135252398,\u0022CreateDatePersian\u0022:14010323135252398},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2829,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.48301452398301 35.731995392373676\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:19010,\u0022EstimatedDurationSeconds\u0022:2142,\u0022EstimatedOperationTimeSeconds\u0022:550,\u0022EstimatedArrivalTime\u0022:20220613142834397,\u0022EstimatedArrivalTimePersian\u0022:14010323142834397,\u0022CreateDate\u0022:20220613135252397,\u0022CreateDatePersian\u0022:14010323135252397},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2815,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.48384194116184 35.71424918102128\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:2932,\u0022EstimatedDurationSeconds\u0022:459,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613145123760,\u0022EstimatedArrivalTimePersian\u0022:14010323144939760,\u0022CreateDate\u0022:20220613135252760,\u0022CreateDatePersian\u0022:14010323135252760},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2815,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.48384194116184 35.71424918102128\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:5368,\u0022EstimatedDurationSeconds\u0022:724,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613145123760,\u0022EstimatedArrivalTimePersian\u0022:14010323144939760,\u0022CreateDate\u0022:20220613135252760,\u0022CreateDatePersian\u0022:14010323135252760},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2815,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.48384194116184 35.71424918102128\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:5222,\u0022EstimatedDurationSeconds\u0022:600,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613145344760,\u0022EstimatedArrivalTimePersian\u0022:14010323150502760,\u0022CreateDate\u0022:20220613135252760,\u0022CreateDatePersian\u0022:14010323135252760},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2815,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.48384194116184 35.71424918102128\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:3988,\u0022EstimatedDurationSeconds\u0022:355,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613144939760,\u0022EstimatedArrivalTimePersian\u0022:14010323150502760,\u0022CreateDate\u0022:20220613135252760,\u0022CreateDatePersian\u0022:14010323135252760},{\u0022FleetId\u0022:183,\u0022DispatchRequestId\u0022:2815,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.48384194116184 35.71424918102128\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:10424,\u0022EstimatedDurationSeconds\u0022:1278,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613150502760,\u0022EstimatedArrivalTimePersian\u0022:14010323150502760,\u0022CreateDate\u0022:20220613135252760,\u0022CreateDatePersian\u0022:14010323135252760}],\u0022SuggestedRoute\u0022:\u002251.482868 35.732103,51.484823 35.733778,51.487338 35.733427,51.486928 35.731293,51.486266 35.73138,51.485136 35.731382,51.484323 35.729375,51.482346 35.7151,51.483217 35.714334,51.483846 35.714315,51.483846 35.714315,51.485085 35.71427,51.485297 35.720797,51.475831 35.722022,51.464156 35.73097,51.463465 35.7313,51.463021 35.731457,51.459124 35.730835,51.457986 35.730231,51.450989 35.729981,51.450567 35.727965,51.483846 35.714315,51.450782 35.723497,51.450787 35.72339,51.450567 35.727965,51.445242 35.727895,51.445185 35.731402,51.427398 35.730277,51.421906 35.729408,51.420557 35.730926,51.421964 35.735903,51.422401 35.737408,51.424401 35.740159,51.483846 35.714315,51.429564 35.740343,51.436163 35.742504,51.435684 35.742009,51.42285 35.758739,51.42078 35.760441,51.421644 35.764512,51.428296 35.776531,51.428365 35.777826,51.456626 35.791494,51.460421 35.793043,51.462873 35.792897,51.461684 35.79108,51.461605 35.791279,51.461076 35.790835,51.483846 35.714315,51.461258 35.790988,51.461605 35.791279,51.461337 35.791952,51.462953 35.792333,51.463 35.792404,51.463558 35.792722,51.483604 35.788789,51.489259 35.786276,51.490218 35.783392,51.489255 35.777498,51.483846 35.714315\u0022,\u0022ShipmentNumber\u0022:1655112172372,\u0022CreateDate\u0022:20220613135252395,\u0022CreateDatePersian\u0022:14010323135252395},{\u0022FleetId\u0022:150,\u0022TotalDistanceMeter\u0022:39960,\u0022TotalEstimatedDurationSeconds\u0022:7044,\u0022Status\u0022:10,\u0022ShipmentDestinationPoints\u0022:[{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2825,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.49327397346497 35.72780635462807\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:20367,\u0022EstimatedDurationSeconds\u0022:2277,\u0022EstimatedOperationTimeSeconds\u0022:550,\u0022EstimatedArrivalTime\u0022:20220613143049826,\u0022EstimatedArrivalTimePersian\u0022:14010323143049826,\u0022CreateDate\u0022:20220613135252826,\u0022CreateDatePersian\u0022:14010323135252826},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2816,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.49327397346497 35.72780635462807\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:20367,\u0022EstimatedDurationSeconds\u0022:2277,\u0022EstimatedOperationTimeSeconds\u0022:550,\u0022EstimatedArrivalTime\u0022:20220613143049826,\u0022EstimatedArrivalTimePersian\u0022:14010323143049826,\u0022CreateDate\u0022:20220613135252826,\u0022CreateDatePersian\u0022:14010323135252826},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2831,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.49327397346497 35.72780635462807\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:20367,\u0022EstimatedDurationSeconds\u0022:2277,\u0022EstimatedOperationTimeSeconds\u0022:550,\u0022EstimatedArrivalTime\u0022:20220613143049826,\u0022EstimatedArrivalTimePersian\u0022:14010323143049826,\u0022CreateDate\u0022:20220613135252826,\u0022CreateDatePersian\u0022:14010323135252826},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2864,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.49327397346497 35.72780635462807\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:20367,\u0022EstimatedDurationSeconds\u0022:2277,\u0022EstimatedOperationTimeSeconds\u0022:550,\u0022EstimatedArrivalTime\u0022:20220613143049826,\u0022EstimatedArrivalTimePersian\u0022:14010323143049826,\u0022CreateDate\u0022:20220613135252826,\u0022CreateDatePersian\u0022:14010323135252826},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2866,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.49327397346497 35.72780635462807\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:20367,\u0022EstimatedDurationSeconds\u0022:2277,\u0022EstimatedOperationTimeSeconds\u0022:550,\u0022EstimatedArrivalTime\u0022:20220613143049826,\u0022EstimatedArrivalTimePersian\u0022:14010323143049826,\u0022CreateDate\u0022:20220613135252826,\u0022CreateDatePersian\u0022:14010323135252826},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2825,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.46988417337308 35.73283393690476\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:3210,\u0022EstimatedDurationSeconds\u0022:425,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613145304997,\u0022EstimatedArrivalTimePersian\u0022:14010323150537997,\u0022CreateDate\u0022:20220613135252997,\u0022CreateDatePersian\u0022:14010323135252997},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2825,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.46988417337308 35.73283393690476\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:2698,\u0022EstimatedDurationSeconds\u0022:393,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613150537997,\u0022EstimatedArrivalTimePersian\u0022:14010323150537997,\u0022CreateDate\u0022:20220613135252998,\u0022CreateDatePersian\u0022:14010323135252998},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2825,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.46988417337308 35.73283393690476\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:6329,\u0022EstimatedDurationSeconds\u0022:569,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613152106997,\u0022EstimatedArrivalTimePersian\u0022:14010323152106997,\u0022CreateDate\u0022:20220613135252998,\u0022CreateDatePersian\u0022:14010323135252998},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2825,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.46988417337308 35.73283393690476\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:2130,\u0022EstimatedDurationSeconds\u0022:214,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613153040997,\u0022EstimatedArrivalTimePersian\u0022:14010323153040998,\u0022CreateDate\u0022:20220613135252998,\u0022CreateDatePersian\u0022:14010323135252998},{\u0022FleetId\u0022:150,\u0022DispatchRequestId\u0022:2825,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.46988417337308 35.73283393690476\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:5226,\u0022EstimatedDurationSeconds\u0022:816,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613155016998,\u0022EstimatedArrivalTimePersian\u0022:14010323155016998,\u0022CreateDate\u0022:20220613135252998,\u0022CreateDatePersian\u0022:14010323135252998}],\u0022SuggestedRoute\u0022:\u002251.493315 35.727801,51.493493 35.728681,51.493374 35.730499,51.48937 35.730927,51.489583 35.732178,51.48381 35.732918,51.482483 35.73188,51.479664 35.732229,51.470359 35.732085,51.468381 35.73273,51.46869 35.73343,51.469981 35.73305,51.469981 35.73305,51.472119 35.732265,51.470359 35.732085,51.468381 35.73273,51.471455 35.739596,51.475291 35.73888,51.475358 35.739093,51.468885 35.740155,51.469921 35.742495,51.469981 35.73305,51.469529 35.742587,51.468298 35.742874,51.466116 35.740529,51.463755 35.740624,51.462791 35.740943,51.46325 35.7447,51.465429 35.754851,51.47715 35.77737,51.478344 35.777821,51.478542 35.777758,51.478066 35.776438,51.483476 35.775688,51.469981 35.73305,51.48378 35.773459,51.483144 35.768934,51.485578 35.768397,51.485645 35.768257,51.484925 35.766257,51.485198 35.765646,51.485093 35.764269,51.484561 35.758693,51.469981 35.73305,51.48337 35.758438,51.485183 35.758636,51.485014 35.758504,51.484856 35.759003,51.485116 35.758844,51.48421 35.759047,51.455632 35.755556,51.452826 35.754534,51.453173 35.754143,51.454071 35.754637,51.454927 35.754997,51.458813 35.75606,51.459236 35.755949,51.459952 35.757207,51.459786 35.757144,51.45968 35.756742,51.469981 35.73305\u0022,\u0022ShipmentNumber\u0022:1655112172825,\u0022CreateDate\u0022:20220613135252825,\u0022CreateDatePersian\u0022:14010323135252826},{\u0022FleetId\u0022:197,\u0022TotalDistanceMeter\u0022:29161,\u0022TotalEstimatedDurationSeconds\u0022:3990,\u0022Status\u0022:10,\u0022ShipmentDestinationPoints\u0022:[{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2823,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.495068371295936 35.73682450485504\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:23291,\u0022EstimatedDurationSeconds\u0022:2093,\u0022EstimatedOperationTimeSeconds\u0022:400,\u0022EstimatedArrivalTime\u0022:20220613142746044,\u0022EstimatedArrivalTimePersian\u0022:14010323142746044,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2830,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:5,\u0022Location\u0022:\u002251.495068371295936 35.73682450485504\u0022,\u0022IsVendorLocation\u0022:true,\u0022SequenceNumber\u0022:1,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:23291,\u0022EstimatedDurationSeconds\u0022:2093,\u0022EstimatedOperationTimeSeconds\u0022:400,\u0022EstimatedArrivalTime\u0022:20220613142746044,\u0022EstimatedArrivalTimePersian\u0022:14010323142746044,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2823,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.474580840735804 35.74133423716735\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:3687,\u0022EstimatedDurationSeconds\u0022:475,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613145923121,\u0022EstimatedArrivalTimePersian\u0022:14010323145923121,\u0022CreateDate\u0022:20220613135253121,\u0022CreateDatePersian\u0022:14010323135253121},{\u0022FleetId\u0022:197,\u0022DispatchRequestId\u0022:2823,\u0022ShipmentDestinationPointStatusId\u0022:10,\u0022OperationTypeId\u0022:10,\u0022Location\u0022:\u002251.474580840735804 35.74133423716735\u0022,\u0022IsVendorLocation\u0022:false,\u0022SequenceNumber\u0022:2,\u0022DisplacementMeter\u0022:0,\u0022DistanceMeter\u0022:2183,\u0022EstimatedDurationSeconds\u0022:302,\u0022EstimatedOperationTimeSeconds\u0022:360,\u0022EstimatedArrivalTime\u0022:20220613144528121,\u0022EstimatedArrivalTimePersian\u0022:14010323145923121,\u0022CreateDate\u0022:20220613135253121,\u0022CreateDatePersian\u0022:14010323135253121}],\u0022SuggestedRoute\u0022:\u002251.495071 35.736825,51.495132 35.737129,51.48953 35.737857,51.486791 35.738227,51.48551 35.740416,51.482984 35.740897,51.481915 35.740369,51.480483 35.74076,51.480397 35.740535,51.474974 35.741917,51.474724 35.741296,51.474724 35.741296,51.47456 35.740892,51.470885 35.741474,51.470138 35.739977,51.451754 35.741715,51.447882 35.74213,51.447962 35.744717,51.447793 35.744953,51.444093 35.745913,51.443815 35.744405,51.474724 35.741296\u0022,\u0022ShipmentNumber\u0022:1655112173044,\u0022CreateDate\u0022:20220613135253044,\u0022CreateDatePersian\u0022:14010323135253044}]\u0027,\r\n\t@Result\t\t\t\tNVARCHAR(MAX) OUTPUT\r\nAS\r\n\tSET STATISTICS IO off\r\n\tSET STATISTICS TIME off\r\n\tSET XACT_ABORT ON\r\n\tSET DEADLOCK_PRIORITY LOW\r\n\tINSERT INTO TESTDispatch\r\n\tVALUES(@JsonMain,\r\n\t@JsonShipments,\r\n\tGETDATE()\r\n\t)\r\n\r\n--\treturn\r\n\r\n\tDECLARE @Result_DispatchRequestIds\tTABLE \r\n\t(\r\n\t\tDispatchRequestId BIGINT\r\n\t)\r\n\tDECLARE @ShipmentNumber\t\tBIGINT=NULL\r\n\tDECLARE @CreateDate\t\t\tBIGINT=CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE @CreateDatePersian\tBIGINT=CONCAT(REPLACE(REPLACE(REPLACE(dbo.ConvertToShamsi(GETDATE()),\u0027/\u0027,\u0027\u0027),\u0027:\u0027,\u0027\u0027),\u0027 \u0027,\u0027\u0027),REPLACE(REPLACE(CAST(GETDATE() as time(3)),\u0027:\u0027,\u0027\u0027),\u0027.\u0027,\u0027\u0027))\r\n\r\n\r\n\tBEGIN TRY\r\n\r\n\t\tDROP TABLE IF EXISTS #FleetIds\r\n\t\tCREATE TABLE #FleetIds \r\n\t\t(\r\n\t\t\tID BIGINT\r\n\t\t)\r\n\t\tDROP TABLE IF EXISTS #DispatchRequest\r\n\t\t\tSELECT\t\t\r\n\t\t\t\t\tShipmentFleetId,\r\n\t\t\t\t\tFleetId,\r\n\t\t\t\t\tDispatchRequestId,\r\n\t\t\t\t\tFailureReasons,\r\n\t\t\t\t\tCASE WHEN ISNULL(Point,\u0027\u0027) \u003C\u003E\u0027\u0027  THEN CONCAT(\u0027POINT (\u0027,Point,\u0027)\u0027) ELSE NULL END Point,\r\n\t\t\t\t\tArrivalDurationTime,\r\n\t\t\t\t\tDistanceMeter,\r\n\t\t\t\t\tCreateDate,\r\n\t\t\t\t\tCreateDatePersian,\r\n\r\n\t\t\t\t\tCAST(CreateDateWithoutMiliSecond AS BIGINT)\t\t\tCreateDateWithoutMiliSecond,\r\n\t\t\t\t\tCAST(CreateDatePersianWithoutMiliSecond AS BIGINT)\tCreateDatePersianWithoutMiliSecond,\r\n\r\n\t\t\t\t\tCAST(CreateDateWithoutSecond AS BIGINT)\t\t\t\tCreateDateWithoutSecond,\r\n\t\t\t\t\tCAST(CreateDatePersianWithoutSecond AS BIGINT)\t\tCreateDatePersianWithoutSecond,\r\n\r\n\t\t\t\t\tPolygonStoreId\r\n\r\n\r\n\t\tINTO #DispatchRequest\r\n\t\tFROM \r\n\t\t(\r\n\t\t\tSELECT\t\r\n\t\t\t\t\tShipmentFleetId,\r\n\t\t\t\t\tFleetId,\r\n\t\t\t\t\tDispatchRequestId,\r\n\t\t\t\t\tFailureReasons,\r\n\t\t\t\t\tPoint,\r\n\t\t\t\t\tArrivalDurationTime,\r\n\t\t\t\t\tDistanceMeter,\r\n\t\t\t\t\tCreateDate,\r\n\t\t\t\t\tCreateDatePersian,\r\n\t\t\t\t\tCONCAT(LEFT(CreateDate,14),\u0027000\u0027)\t\t\t\t\tCreateDateWithoutMiliSecond, \r\n\t\t\t\t\tCONCAT(LEFT(CreateDatePersian,14),\u0027000\u0027)\t\t\tCreateDatePersianWithoutMiliSecond,\r\n\r\n\t\t\t\t\tCONCAT(LEFT(CreateDate,12),\u002700000\u0027)\t\t\t\t\tCreateDateWithoutSecond ,\r\n\t\t\t\t\tCONCAT(LEFT(CreateDatePersian,12),\u002700000\u0027)\t\t\tCreateDatePersianWithoutSecond ,\r\n\r\n\t\t\t\t\tPolygonStoreId\r\n\r\n\t\t\tFROM OPENJSON(@JsonMain)\r\n\t\t\tWITH\r\n\t\t\t(\r\n\t\t\t\tFleetPreAssignments\t\t\t\t\tNVARCHAR(MAX)\t\u0027$.FleetPreAssignments\u0027\t\t\t\tAS JSON,\r\n\t\t\t\tShipmentFleetId\t\t\t\t\t\tINT\t\t\t\t\u0027$.ShipmentFleetId\u0027\r\n\t\t\t) Main\r\n\t\t\tCROSS APPLY OPENJSON(FleetPreAssignments)\r\n\t\t\tWITH\r\n\t\t\t(\r\n\t\t\t\tFleetId\t\t\t\t\t\t\t\tINT\t\t\t\t\u0027$.FleetId\u0027,\r\n\t\t\t\tDispatchRequestId\t\t\t\t\tBIGINT\t\t\t\u0027$.DispatchRequestId\u0027,\r\n\t\t\t\tFailureReasons\t\t\t\t\t\tTINYINT\t\t\t\u0027$.FailureReasons\u0027,\r\n\t\t\t\tPoint\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t\u0027$.Point\u0027\t\t,\r\n\t\t\t\tArrivalDurationTime\t\t\t\t\tINT\t\t\t\t\u0027$.ArrivalDurationTime\u0027,\r\n\t\t\t\tDistanceMeter\t\t\t\t\t\tINT\t\t\t\t\u0027$.DistanceMeter\u0027,\r\n\t\t\t\tCreateDate\t\t\t\t\t\t\tBIGINT\t\t\t\u0027$.CreateDate\u0027,\r\n\t\t\t\tCreateDatePersian\t\t\t\t\tBIGINT\t\t\t\u0027$.CreateDatePersian\u0027,\r\n\t\t\t\tPolygonStoreId\t\t\t\t\t\tBIGINT\t\t\t\u0027$.PolygonStoreId\u0027\r\n\t\t\t) \r\n\t\t\tWHERE FleetId IS NOT NULL\r\n\t\t)x\r\n\t\t\r\n\r\n\t\tDROP TABLE IF EXISTS #ShipmentDestinationPoint\r\n\t\tSELECT\t----Shipment\r\n\t\t\t\tShipmentFleetId,\r\n\t\t\t\tTotalDistanceMeter,\r\n\t\t\t\tTotalEstimatedDurationSeconds,\r\n\t\t\t\t[Status] ShipmentStatusId,\r\n\r\n\t\t\t\tCASE WHEN suggestedRoute IS NOT NULL THEN CONCAT(\u0027MULTIPOINT ((\u0027,replace(suggestedRoute,\u0027,\u0027,\u0027), (\u0027),\u0027))\u0027) ELSE NULL END suggestedRoute,\r\n\t\t\t\tShipmentNumber,\r\n\t\t\t\tCreateDateShipment,\r\n\t\t\t\tCreateDatePersianShipment,\r\n\t\t\t\tFleetId,\r\n\t\t\t\tDispatchRequestId,\r\n\t\t\t\tShipmentDestinationPointStatusId,\r\n\t\t\t\tOperationTypeId\t,\t\t\t\t\t\r\n\t\t\t\tCASE WHEN Location IS NOT NULL THEN CONCAT(\u0027POINT (\u0027,Location,\u0027)\u0027) ELSE NULL END Location,\r\n\t\t\t\tIsVendorLocation,\t\t\t\t\t\r\n\t\t\t\tSequenceNumber\t,\t\t\t\t\t\r\n\t\t\t\tDisplacementMeter,\t\t\t\t\t\r\n\t\t\t\tDistanceMeter,\t\t\t\t\t\t\r\n\t\t\t\tEstimatedDurationSeconds,\t\t\t\r\n\t\t\t\tEstimatedOperationTimeSeconds,\t\t\r\n\t\t\t\tEstimatedArrivalTime,\t\t\t\t\r\n\t\t\t\tEstimatedArrivalTimePersian,\r\n\t\t\t\tCreateDate,\r\n\t\t\t\tCreateDatePersian\r\n\r\n\t\tINTO #ShipmentDestinationPoint\r\n\t\tFROM OPENJSON(@JsonShipments)\r\n\t\tWITH\r\n\t\t(\r\n\t\t\tShipmentFleetId\t\t\t\t\t\tINT\t\t\t\t\u0027$.FleetId\u0027,\r\n\t\t\tTotalDistanceMeter\t\t\t\t\tINT\t\t\t\t\u0027$.TotalDistanceMeter\u0027,\r\n\t\t\tTotalEstimatedDurationSeconds\t\tSMALLINT\t\t\u0027$.TotalEstimatedDurationSeconds\u0027,\r\n\t\t\t[Status]\t\t\t\t\t\t\tTINYINT\t\t\t\u0027$.Status\u0027,\r\n\t\t\tSuggestedRoute\t\t\t\t\t\tNVARCHAR(MAX)\t\u0027$.SuggestedRoute\u0027\t\t\t\t,\r\n\t\t\tShipmentNumber\t\t\t\t\t\tBIGINT\t\t\t\u0027$.ShipmentNumber\u0027,\r\n\t\t\tCreateDateShipment\t\t\t\t\tBIGINT\t\t\t\u0027$.CreateDate\u0027,\r\n\t\t\tCreateDatePersianShipment\t\t\tBIGINT\t\t\t\u0027$.CreateDatePersian\u0027,\r\n\t\t\tShipmentDestinationPoints\t\t\tNVARCHAR(MAX)\t\u0027$.ShipmentDestinationPoints\u0027\tAS JSON\r\n\t\t)\r\n\t\tCROSS APPLY OPENJSON(ShipmentDestinationPoints)\r\n\t\tWITH\r\n\t\t(\r\n\t\t\tFleetId\t\t\t\t\t\t\t\tINT\t\t\t\t\u0027$.FleetId\u0027,\r\n\t\t\tDispatchRequestId\t\t\t\t\tBIGINT\t\t\t\u0027$.DispatchRequestId\u0027,\r\n\t\t\tShipmentDestinationPointStatusId\tTINYINT\t\t\t\u0027$.ShipmentDestinationPointStatusId\u0027,\r\n\t\t\tOperationTypeId\t\t\t\t\t\tTINYINT\t\t\t\u0027$.OperationTypeId\u0027,\r\n\t\t\tLocation\t\t\t\t\t\t\tNVARCHAR(MAX)\t\u0027$.Location\u0027\t\t\t\t\t\t\t,\r\n\t\t\tIsVendorLocation\t\t\t\t\tBIT\t\t\t\t\u0027$.IsVendorLocation\u0027,\r\n\t\t\tSequenceNumber\t\t\t\t\t\tTINYINT\t\t\t\u0027$.SequenceNumber\u0027,\r\n\t\t\tDisplacementMeter\t\t\t\t\tINT\t\t\t\t\u0027$.DisplacementMeter\u0027,\r\n\t\t\tDistanceMeter\t\t\t\t\t\tINT\t\t\t\t\u0027$.DistanceMeter\u0027,\r\n\t\t\tEstimatedDurationSeconds\t\t\tSMALLINT\t\t\u0027$.EstimatedDurationSeconds\u0027,\r\n\t\t\tEstimatedOperationTimeSeconds\t\tINT\t\t\t\t\u0027$.EstimatedOperationTimeSeconds\u0027,\r\n\t\t\tEstimatedArrivalTime\t\t\t\tBIGINT\t\t\t\u0027$.EstimatedArrivalTime\u0027,\r\n\t\t\tEstimatedArrivalTimePersian\t\t\tBIGINT\t\t\t\u0027$.EstimatedArrivalTimePersian\u0027,\r\n\t\t\tCreateDate\t\t\t\t\t\t\tBIGINT\t\t\t\u0027$.CreateDate\u0027,\r\n\t\t\tCreateDatePersian\t\t\t\t\tBIGINT\t\t\t\u0027$.CreateDatePersian\u0027\r\n\t\t)\r\n\r\n\r\n\t\t--select * from #DispatchRequest\r\n\t\t--select * from #ShipmentDestinationPoint\r\n\t\t/************************************************************************************/\r\n\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\tDECLARE @Shipment TABLE\r\n\t\t(\r\n\t\t\tShipmentId\t\t\tBIGINT,\r\n\t\t\tShipmentStatusId\tTINYINT,\r\n\t\t\tFleetId\t\t\t\tINT\r\n\t\t)\r\n\t\t\t\t\r\n\t\tBEGIN TRANSACTION;\r\n\r\n\r\n\t\t\tINSERT INTO dp.Shipment(\r\n\t\t\t\t\t\t\t\t\t\t\t\tFleetId\r\n\t\t\t\t\t\t\t\t\t\t\t,ShipmentNumber\r\n\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t,ShipmentStatusId\r\n\t\t\t\t\t\t\t\t\t\t\t,TotalEstimatedDurationSeconds\r\n\t\t\t\t\t\t\t\t\t\t\t,TotalDistanceMeter\r\n\t\t\t\t\t\t\t\t\t\t\t,UpdateDate\r\n\t\t\t\t\t\t\t\t\t\t\t,UpdateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t,ModifierUserName\r\n\t\t\t\t\t\t\t\t\t\t\t,SuggestedRoute\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tOUTPUT INSERTED.Id,INSERTED.ShipmentStatusId,INSERTED.FleetId INTO @Shipment\r\n\t\t\tSELECT\tDISTINCT \r\n\t\t\t\t\tsdp.ShipmentFleetId,\t\t\t\t--FleetId\r\n\t\t\t\t\tsdp.ShipmentNumber,\t\t\t\t\t--ShipmentNumber\r\n\t\t\t\t\tsdp.CreateDateShipment ,\t\t\t--CreateDate\r\n\t\t\t\t\tsdp.CreateDatePersianShipment,\t\t--CreateDatePersian\r\n\t\t\t\t\tsdp.ShipmentStatusId,\t\t\t\t--ShipmentStatusId\r\n\t\t\t\t\tsdp.TotalEstimatedDurationSeconds,\t--TotalEstimatedDurationSeconds\r\n\t\t\t\t\tsdp.TotalDistanceMeter,\t\t\t\t--TotalDistanceMeter\r\n\t\t\t\t\tNULL,\t\t\t\t\t\t\t\t--UpdateDate\r\n\t\t\t\t\tNULL,\t\t\t\t\t\t\t\t--UpdateDatePersian\r\n\t\t\t\t\t\u0027system\u0027,\t\t\t\t\t\t\t--ModifierUserName\r\n\t\t\t\t\tsdp.SuggestedRoute\t\t\t\t\t--SuggestedRoute--Change Input FORMAT\t\t\t\t\t\t\t\t\t\t\r\n\t\t\tFROM #ShipmentDestinationPoint sdp \r\n\t\t\tINNER JOIN CS_DriverManagement.DM.Fleet f ON sdp.ShipmentFleetId=f.Id\r\n\t\t\t--WHERE f.FleetStatusId=5/*Ready*/\r\n\t\t\t\r\n\r\n\r\n\t\t\t\r\n\t\t\tINSERT INTO DP.ShipmentStatusHistory(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tShipmentStatusId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,ShipmentId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tSELECT \tDISTINCT\r\n\t\t\t\t\tsdp.ShipmentStatusId,\t\t\t--ShipmentStatusId \r\n\t\t\t\t\ts.ShipmentId,\t\t\t\t\t--ShipmentId VARIABLE\r\n\t\t\t\t\tCreateDateShipment,\t\t\t\t--CreateDate \r\n\t\t\t\t\tCreateDatePersianShipment\t\t--CreateDatePersian \r\n\t\t\tFROM #ShipmentDestinationPoint sdp \r\n\t\t\tINNER JOIN @Shipment s ON s.FleetId=sdp.shipmentFleetId\r\n\t\t\t\t\r\n\r\n\t\t\tDECLARE @InsertedFleetPreAssignmentStateIds_Successful TABLE\r\n\t\t\t(\r\n\t\t\t\tFleetPreAssignmentStateId\tBIGINT,\r\n\t\t\t\tShipmentid\t\t\t\t\tBIGINT,\r\n\t\t\t\tArrivalDurationTime\t\t\tBIGINT,\r\n\t\t\t\tDistanceMeter\t\t\t\tBIGINT,\r\n\t\t\t\tCreateDate\t\t\t\t\tBIGINT,\r\n\t\t\t\tCreateDatePersian\t\t\tBIGINT,\r\n\t\t\t\tFleetId\t\t\t\t\t\tINT\r\n\t\t\t)\r\n\r\n\t\t\tDECLARE @InsertedFleetPreAssignmentStateIds_Unsuccessful TABLE\r\n\t\t\t(\r\n\t\t\t\tFleetPreAssignmentStateId\tBIGINT,\r\n\t\t\t\tArrivalDurationTime\t\t\tBIGINT,\r\n\t\t\t\tDistanceMeter\t\t\t\tBIGINT,\r\n\t\t\t\tCreateDate\t\t\t\t\tBIGINT,\r\n\t\t\t\tCreateDatePersian\t\t\tBIGINT,\r\n\t\t\t\tFleetId\t\t\t\t\t\tINT,\r\n\t\t\t\tFailureReasons\t\t\t\tTINYINT,\r\n\t\t\t\tDispatchRequestIds\t\t\tVARCHAR(2000)\r\n\t\t\t)\r\n\r\n\t\t\t\t\t\t\r\n\t\t\t--Succsesful Situation\r\n\t\t\tINSERT INTO dp.FleetPreAssignmentState(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t FleetId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,ShipmentId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,FleetStatusId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,TodayDeliveredParcelCount\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,ArrivalDurationTime\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,DistanceMeter\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,FleetLocation\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,AssignmentFailureReasonId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tOUTPUT INSERTED.Id,INSERTED.Shipmentid,INSERTED.ArrivalDurationTime,INSERTED.DistanceMeter,INSERTED.CreateDate,INSERTED.CreateDatePersian,INSERTED.FleetId \r\n\t\t\tINTO @InsertedFleetPreAssignmentStateIds_Successful\r\n\t\t\tSELECT\t\tFleetId,\t\t\r\n\t\t\t\t\t\tShipmentid,\t\t\t\t\r\n\t\t\t\t\t\tFleetStatusId,\t\r\n\t\t\t\t\t\tNULL,\t\t\t\t\t\t--TodayDeliveredParcelCount\r\n\t\t\t\t\t\tArrivalDurationTime,\t\r\n\t\t\t\t\t\tDistanceMeter,\t\t\t\r\n\t\t\t\t\t\tCreateDateWithoutSecond,\t\t\r\n\t\t\t\t\t\tCreateDatePersianWithoutSecond,\t\r\n\t\t\t\t\t\tPoint,\r\n\t\t\t\t\t\tAssignmentFailureReasonId\r\n\t\t\tFROM \r\n\t\t\t(\r\n\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\ts.FleetId,\t\t\r\n\t\t\t\t\t\ts.Shipmentid,\t\t\t\t\r\n\t\t\t\t\t\t5/*READY*/\t\t\t\t\tFleetStatusId,\t\r\n\t\t\t\t\t\t--NULL,\t\t\t\t\t\t--TodayDeliveredParcelCount\r\n\t\t\t\t\t\tdr.ArrivalDurationTime,\t\r\n\t\t\t\t\t\tdr.DistanceMeter,\t\t\t\r\n\t\t\t\t\t\tdr.CreateDateWithoutSecond,\t\t\r\n\t\t\t\t\t\tdr.CreateDatePersianWithoutSecond,\t\r\n\t\t\t\t\t\tdr.Point,\r\n\t\t\t\t\t\t5/*SELECTED*/\t\t\t\tAssignmentFailureReasonId,\r\n\t\t\t\t\t\tdr.polygonStoreId\r\n\t\t\t\tFROM #DispatchRequest dr\r\n\t\t\t\tINNER JOIN @Shipment s ON\t\tdr.shipmentFleetId=dr.FleetId\r\n\t\t\t\t\t\t\t\t\t\t\tAND dr.shipmentFleetId=s.FleetId\r\n\t\t\t\t\t\t\t\t\t\t\tAND dr.FailureReasons=5\r\n\t\t\t)x\r\n\t\r\n\t\t\r\n\r\n\t\t\r\n\r\n\t\t\t--UnSuccsesful Situation\r\n\t\t\tINSERT INTO dp.FleetPreAssignmentState(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t FleetId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,ShipmentId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,FleetStatusId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,TodayDeliveredParcelCount\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,ArrivalDurationTime\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,DistanceMeter\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,FleetLocation\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,AssignmentFailureReasonId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,DispatchRequestIds\r\n\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tOUTPUT\tINSERTED.Id,\r\n\t\t\t\t\tINSERTED.ArrivalDurationTime,\r\n\t\t\t\t\tINSERTED.DistanceMeter,\r\n\t\t\t\t\tINSERTED.CreateDate,\r\n\t\t\t\t\tINSERTED.CreateDatePersian,\r\n\t\t\t\t\tINSERTED.FleetId,\r\n\t\t\t\t\tINSERTED.AssignmentFailureReasonId ,\r\n\t\t\t\t\tINSERTED.DispatchRequestIds\r\n\r\n\t\t\tINTO @InsertedFleetPreAssignmentStateIds_Unsuccessful\r\n\t\t\tSELECT \r\n\t\t\t\t\tDISTINCT \r\n\t\t\t\t\t\t\tdri.FleetId,\r\n\t\t\t\t\t\t\tNULL,\r\n\t\t\t\t\t\t\t(SELECT FleetStatusId FROM dp.Fleet f WHERE f.Id=dr.FleetId AND f.IsActive=1) FleetStatusId\t,\r\n\t\t\t\t\t\t\tNULL,\r\n\t\t\t\t\t\t\tdr.ArrivalDurationTime,\t\t\t\r\n\t\t\t\t\t\t\tdr.DistanceMeter,\t\t\t\t\t\r\n\t\t\t\t\t\t\tdr.CreateDateWithoutSecond ,\r\n\t\t\t\t\t\t\tdr.CreateDatePersianWithoutSecond ,\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdr.Point,\r\n\t\t\t\t\t\t\tdri.FailureReasons\t,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--AssignmentFailureReasonId\r\n\t\t\t\t\t\t\t--dr.PolygonStoreId,\r\n\t\t\t\t\t\t\tdri.dispatchRequestIds\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\tSELECT\t\r\n\t\t\t\t\tDISTINCT \r\n\t\t\t\t\tdr.FleetId,\r\n\t\t\t\t\tdr.FailureReasons\t,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--AssignmentFailureReasonId\r\n\t\t\t\t\tdr.PolygonStoreId,\r\n\t\t\t\t\tstring_agg(dr.dispatchRequestId,\u0027,\u0027) dispatchRequestIds\r\n\t\t\tFROM #DispatchRequest dr\r\n\t\t\tWHERE  (dr.fleetid\u003C\u003Edr.shipmentFleetId )\r\n\t\t\tOR (dr.fleetid=dr.shipmentFleetId AND dr.failureReasons\u003C\u003E5)\r\n\t\t\tGROUP BY dr.FleetId,dr.FailureReasons,PolygonStoreId\r\n\t\t\t)dri\r\n\t\t\tINNER JOIN #DispatchRequest dr ON dri.fleetid=dr.fleetid\r\n\t\t\t\t\t\t\t\t\t\t\tAND dri.failureReasons=dr.failureReasons\r\n\t\t\t\t\t\t\t\t\t\t\tAND dri.PolygonStoreId=dr.PolygonStoreId\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t--Succsesful Situation\r\n\t\t\tINSERT INTO DP.DispatchRequestFleetPreAssignmentState\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t DispatchRequestId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,FleetPreAssignmentStateId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tSELECT DISTINCT dr.DispatchRequestId,u.FleetPreAssignmentStateId,u.CreateDate,u.CreateDatePersian\r\n\t\t\tfrom @InsertedFleetPreAssignmentStateIds_successful u\r\n\t\t\tINNER JOIN #DispatchRequest dr ON u.FleetId=dr.fleetId \r\n\t\t\t\t\t\t\t\t\t\t\tAND u.DistanceMeter=dr.DistanceMeter\r\n\t\t\t\t\t\t\t\t\t\t\tAND u.ArrivalDurationTime=dr.ArrivalDurationTime\r\n\t\t\twhere dr.fleetid=dr.shipmentFleetId \r\n\t\t\tAND dr.failureReasons=5\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t--select * from @InsertedFleetPreAssignmentStateIds_Unsuccessful\r\n\r\n\t\t\t--UnSuccsesful Situation\r\n\t\t\tINSERT INTO DP.DispatchRequestFleetPreAssignmentState\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t DispatchRequestId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,FleetPreAssignmentStateId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t--SELECT DISTINCT dr.DispatchRequestId,u.FleetPreAssignmentStateId,u.CreateDate,u.CreateDatePersian\r\n\t\t\t--FROM #DispatchRequest dr \r\n\t\t\t--INNER JOIN @InsertedFleetPreAssignmentStateIds_Unsuccessful u \r\n\t\t\t--\t\t\t\t\t\t\t\t\t\t\t\tON  u.FleetId=dr.fleetId  \r\n\t\t\t--\t\t\t\t\t\t\t\t\t\t\t\tAND u.FailureReasons=dr.failureReasons\r\n\t\t\t--\t\t\t\t\t\t\t\t\t\t\t\tAND u.DistanceMeter=dr.DistanceMeter\r\n\t\t\t--\t\t\t\t\t\t\t\t\t\t\t\tAND u.ArrivalDurationTime=dr.ArrivalDurationTime\r\n\t\t\t--WHERE (dr.fleetid\u003C\u003Edr.shipmentFleetId )\r\n\t\t\t--OR (dr.fleetid=dr.shipmentFleetId AND dr.failureReasons\u003C\u003E5)\r\n\t\t\t--INSERT INTO DP.DispatchRequestFleetPreAssignmentState\r\n\t\t\t--\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t--\t\t\t\t\t\t\t\t\t\t\t\t\t DispatchRequestId\r\n\t\t\t--\t\t\t\t\t\t\t\t\t\t\t\t\t,FleetPreAssignmentStateId\r\n\t\t\t--\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t--\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t--\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tSELECT DISTINCT x.value /*DispatchRequestId*/,u.FleetPreAssignmentStateId,u.CreateDate,u.CreateDatePersian\r\n\t\t\tFROM  @InsertedFleetPreAssignmentStateIds_Unsuccessful u\r\n\t\t\tCROSS APPLY string_split(u.DispatchRequestIds,\u0027,\u0027)x\r\n\r\n\r\n\t\t\t\r\n\r\n\t\t\tDECLARE @ShipmentDestinationPointIds\tTABLE\r\n\t\t\t(\r\n\t\t\t\tShipmentDestinationPointId\t\t\tBIGINT,\r\n\t\t\t\tShipmentId\t\t\t\t\t\t\tBIGINT,\r\n\t\t\t\tShipmentDestinationPointStatusId\tTINYINT,\r\n\t\t\t\tCreateDate\t\t\t\t\t\t\tBIGINT,\r\n\t\t\t\tCreateDatePersian\t\t\t\t\tBIGINT,\r\n\t\t\t\tSequenceNumber\t\t\t\t\t\tSMALLINT\r\n\t\t\t)\r\n\r\n\r\n\t\t\tINSERT INTO DP.ShipmentDestinationPoint\r\n\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t ShipmentId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,OperationTypeId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,Location\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,IsVendorLocation\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,SequenceNumber\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,DisplacementMeter\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,DistanceMeter\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,EstimatedDurationSeconds\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,EstimatedOperationTimeSeconds\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,ShipmentDestinationPointStatusId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,EstimatedArrivalTime\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,EstimatedArrivalTimePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,UpdateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,UpdateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,ModifierUserName\r\n\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tOUTPUT\tINSERTED.Id,\r\n\t\t\t\t\tINSERTED.ShipmentId,\r\n\t\t\t\t\tINSERTED.ShipmentDestinationPointStatusId,\r\n\t\t\t\t\tINSERTED.CreateDate,\r\n\t\t\t\t\tINSERTED.CreateDatePersian ,\r\n\t\t\t\t\tINSERTED.SequenceNumber\r\n\t\t\t\t\tINTO @ShipmentDestinationPointIds\r\n\t\t\tSELECT  TOP 1 WITH TIES\r\n\t\t\t\t\tShipmentId,\r\n\t\t\t\t\tOperationTypeId,\r\n\t\t\t\t\tsdp.Location,\r\n\t\t\t\t\t--(\tSELECT TOP 1 Location\r\n\t\t\t\t\t--\tFROM #ShipmentDestinationPoint sdpi \r\n\t\t\t\t\t--\tWHERE sdpi.FleetId=sdp.FleetId\r\n\t\t\t\t\t--\tAND sdpi.OperationTypeId=sdp.OperationTypeId\r\n\t\t\t\t\t--\tAND sdpi.SequenceNumber=sdp.SequenceNumber\r\n\t\t\t\t\t--) Location,\r\n\t\t\t\t\tIsVendorLocation,\r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tCreateDateShipment,\r\n\t\t\t\t\tCreateDatePersianShipment,\r\n\t\t\t\t\tDisplacementMeter,\r\n\t\t\t\t\tDistanceMeter,\r\n\t\t\t\t\tEstimatedDurationSeconds,\r\n\t\t\t\t\tEstimatedOperationTimeSeconds,\r\n\t\t\t\t\tShipmentDestinationPointStatusId,\r\n\t\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\t\tEstimatedArrivalTimePersian,\r\n\t\t\t\t\tNULL,--UpdateDate,\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tNULL,--UpdateDatePersian,\t\t\t\t\t\t\r\n\t\t\t\t\t\u0027system\u0027 ModifierUserName\r\n\t\t\tFROM #ShipmentDestinationPoint sdp\r\n\t\t\tINNER JOIN @Shipment s ON sdp.shipmentFleetId=s.FleetId \r\n\t\t\tWHERE sdp.operationTypeId=5\r\n\t\t\tORDER BY ROW_NUMBER()OVER(PARTITION BY ShipmentId ORDER BY sdp.dispatchRequestId,sdp.Location)\r\n\t\t\t\r\n\t\t\t\r\n\r\n\t\t\tINSERT INTO DP.ShipmentDestinationPoint\r\n\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t ShipmentId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,OperationTypeId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,Location\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,IsVendorLocation\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,SequenceNumber\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,DisplacementMeter\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,DistanceMeter\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,EstimatedDurationSeconds\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,EstimatedOperationTimeSeconds\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,ShipmentDestinationPointStatusId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,EstimatedArrivalTime\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,EstimatedArrivalTimePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,UpdateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,UpdateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,ModifierUserName\r\n\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tOUTPUT\tINSERTED.Id,\r\n\t\t\t\t\tINSERTED.ShipmentId,\r\n\t\t\t\t\tINSERTED.ShipmentDestinationPointStatusId,\r\n\t\t\t\t\tINSERTED.CreateDate,\r\n\t\t\t\t\tINSERTED.CreateDatePersian ,\r\n\t\t\t\t\tINSERTED.SequenceNumber\r\n\t\t\t\t\tINTO @ShipmentDestinationPointIds\r\n\t\t\tSELECT  DISTINCT\r\n\t\t\t\t\tShipmentId,\r\n\t\t\t\t\tOperationTypeId,\t\r\n\t\t\t\t\t(\tSELECT TOP 1 Location\r\n\t\t\t\t\t\tFROM #ShipmentDestinationPoint sdpi \r\n\t\t\t\t\t\tWHERE sdpi.FleetId=sdp.FleetId\r\n\t\t\t\t\t\tAND sdpi.OperationTypeId=sdp.OperationTypeId\r\n\t\t\t\t\t\tAND sdpi.SequenceNumber=sdp.SequenceNumber\r\n\t\t\t\t\t) Location,\r\n\t\t\t\t\tIsVendorLocation,\r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tCreateDateShipment,\r\n\t\t\t\t\tCreateDatePersianShipment,\r\n\t\t\t\t\tDisplacementMeter,\r\n\t\t\t\t\tDistanceMeter,\r\n\t\t\t\t\tEstimatedDurationSeconds,\r\n\t\t\t\t\tEstimatedOperationTimeSeconds,\r\n\t\t\t\t\tShipmentDestinationPointStatusId,\r\n\t\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\t\tEstimatedArrivalTimePersian,\r\n\t\t\t\t\tNULL,--UpdateDate,\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tNULL,--UpdateDatePersian,\t\t\t\t\t\t\r\n\t\t\t\t\t\u0027system\u0027 ModifierUserName\r\n\t\t\tFROM #ShipmentDestinationPoint sdp\r\n\t\t\tINNER JOIN @Shipment s ON sdp.shipmentFleetId=s.FleetId \r\n\t\t\tWHERE sdp.operationTypeId\u003C\u003E5\r\n\r\n\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tINSERT INTO DP.ShipmentDestinationPointStatusHistory\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tShipmentDestinationPointStatusId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tSELECT\tShipmentDestinationPointStatusId,\t\t-- ShipmentDestinationPointStatusId\r\n\t\t\t\t\tShipmentDestinationPointId,\t\t\t\t--,ShipmentDestinationPointId\r\n\t\t\t\t\tCreateDate,\t\t\t\t\t\t\t\t--,CreateDate\r\n\t\t\t\t\tCreateDatePersian\t\t\t\t\t\t--,CreateDatePersian\r\n\t\t\tFROM @ShipmentDestinationPointIds\r\n\r\n\r\n\r\n\t\t\tINSERT INTO DP.ShipmentDestinationPointDispatchRequest\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t DispatchRequestId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tSELECT\tDISTINCT\r\n\t\t\t\t\tsdp.DispatchRequestId,\r\n\t\t\t\t\tsdpIds.ShipmentDestinationPointId,\r\n\t\t\t\t\tsdpIds.CreateDate,\r\n\t\t\t\t\tsdpIds.CreateDatePersian \r\n\t\t\tfrom @ShipmentDestinationPointIds sdpIds\r\n\t\t\tINNER JOIN @Shipment s ON s.ShipmentId=sdpIds.ShipmentId\r\n\t\t\tINNER JOIN #ShipmentDestinationPoint sdp ON sdp.sequenceNumber=sdpIds.SequenceNumber  AND sdp.shipmentFleetId=s.FleetId\r\n\r\n\r\n\r\n\t\t\tUPDATE DP.DispatchRequest\r\n\t\t\tSET DispatchRequestStatusId=10/*Assigned To Courier*/,\r\n\t\t\t\tUpdateDate=@CreateDate,\r\n\t\t\t\tUpdateDatePersian=@CreateDatePersian,\r\n\t\t\t\tModifierUserName=\u0027system\u0027\r\n\t\t\tWHERE ID IN (\r\n\t\t\t\t\t\tSELECT DISTINCT  dri.dispatchRequestId\r\n\t\t\t\t\t\tFROM #DispatchRequest dri \r\n\t\t\t\t\t\tINNER JOIN @Shipment s\t\t\tON s.FleetId=dri.shipmentFleetId\r\n\t\t\t\t\t\tWHERE dri.shipmentFleetId=dri.FleetId \r\n\t\t\t\t\t\tAND dri.failureReasons=5\r\n\t\t\t\t\t\t)\r\n\t\t\r\n\r\n\r\n\r\n\t\t\tINSERT INTO DP.DispatchRequestStatusHistory\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tDispatchRequestStatusId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t,DispatchRequestId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t,Location\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t,ExceptionDescription\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreatorUserName\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tSELECT DISTINCT \r\n\t\t\t\t\t\t\t10/*Assigned To Courier*/,\r\n\t\t\t\t\t\t\tdr.Id,--DispatchRequestId,\r\n\t\t\t\t\t\t\tNULL,--Location\r\n\t\t\t\t\t\t\tNULL,--ExceptionDescription\r\n\t\t\t\t\t\t\t@CreateDate,\r\n\t\t\t\t\t\t\t@CreateDatePersian,\r\n\t\t\t\t\t\t\t\u0027system\u0027--CreatorUserName\r\n\t\t\tFROM DP.DispatchRequest dr\r\n\t\t\tINNER JOIN   (\r\n\t\t\t\t\t\tSELECT DISTINCT dri.dispatchRequestId\r\n\t\t\t\t\t\tFROM #DispatchRequest dri \r\n\t\t\t\t\t\tINNER JOIN @Shipment s\t\t\tON s.FleetId=dri.shipmentFleetId\r\n\t\t\t\t\t\tWHERE dri.shipmentFleetId=dri.FleetId \r\n\t\t\t\t\t\tAND dri.failureReasons=5\r\n\t\t\t) dri ON dr.Id=dri.dispatchRequestId\r\n\t\t\t\t\t\t\r\n\r\n\t\t\tUPDATE p\r\n\t\t\tSET ParcelStatusId=20/*Courier Assigned*/\r\n\t\t\tFROM CS_OrderManagement.OM.Parcel p\r\n\t\t\tINNER JOIN   (\r\n\t\t\t\t\t\tSELECT DISTINCT dri.dispatchRequestId\r\n\t\t\t\t\t\tFROM #DispatchRequest dri \r\n\t\t\t\t\t\tINNER JOIN @Shipment s\t\t\tON s.FleetId=dri.shipmentFleetId\r\n\t\t\t\t\t\tWHERE dri.shipmentFleetId=dri.FleetId \r\n\t\t\t\t\t\tAND dri.failureReasons=5\r\n\t\t\t) dr ON dr.dispatchRequestId=p.dispatchRequestId\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tINSERT INTO CS_OrderManagement.OM.ParcelStatusHistory\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tParcelStatusId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,ParcelId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,Location\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreatorUserName\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,ExceptionDescription\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tSELECT\t20/*Courier Assigned*/,\r\n\t\t\t\t\tp.Id,\t\t\t\t--ParcelId\r\n\t\t\t\t\tNULL,\t\t\t\t--Location\r\n\t\t\t\t\t\u0027system\u0027,\t\t\t--CreatorUserName\r\n\t\t\t\t\tNULL,\t\t\t\t--ExceptionDescription\r\n\t\t\t\t\t@CreateDate,\t\t--CreateDate\r\n\t\t\t\t\t@CreateDatePersian\t--CreateDatePersian\r\n\t\t\tFROM CS_OrderManagement.OM.Parcel p\r\n\t\t\tWHERE dispatchRequestId IN (\r\n\t\t\t\t\t\tSELECT DISTINCT  dri.dispatchRequestId\r\n\t\t\t\t\t\tFROM #DispatchRequest dri \r\n\t\t\t\t\t\tINNER JOIN @Shipment s\t\t\tON s.FleetId=dri.shipmentFleetId\r\n\t\t\t\t\t\tWHERE dri.shipmentFleetId=dri.FleetId \r\n\t\t\t\t\t\tAND dri.failureReasons=5\r\n\t\t\t)\r\n\r\n\r\n\t\t\tINSERT INTO CS_OrderManagement.OM.CourierInformation\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tParcelId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,FleetId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,DisplacementToPickUpPoint\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,ShipmentId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tSELECT\tp.Id,\t\t\t\t\t\t\r\n\t\t\t\t\ts.FleetId,\t\t\t\t\t\r\n\t\t\t\t\tsdp.DistanceMeter,\t\t\t\r\n\t\t\t\t\t@CreateDate,\r\n\t\t\t\t\t@CreateDatePersian,\r\n\t\t\t\t\ts.ShipmentId\r\n\t\t\tFROM CS_OrderManagement.OM.Parcel p\r\n\t\t\tINNER JOIN (\r\n\t\t\t\t\t\tSELECT DISTINCT  dri.dispatchRequestId\r\n\t\t\t\t\t\tFROM #DispatchRequest dri \r\n\t\t\t\t\t\tINNER JOIN @Shipment s\t\t\tON s.FleetId=dri.shipmentFleetId\r\n\t\t\t\t\t\tWHERE dri.shipmentFleetId=dri.FleetId \r\n\t\t\t\t\t\tAND dri.failureReasons=5\r\n\t\t\t\t\t\t) dr ON dr.dispatchRequestId=p.DispatchRequestId\r\n\t\t\tINNER JOIN #ShipmentDestinationPoint sdp ON p.DispatchRequestId=sdp.dispatchRequestId AND sdp.SequenceNumber=1\r\n\t\t\tINNER JOIN @Shipment s ON sdp.shipmentFleetId=s.FleetId\r\n\r\n\r\n\t\t\tINSERT INTO CS_DriverManagement.DM.FleetStatusHistory (\r\n\t\t\t\t\t\t\t\t\t\t\t\t FleetStatusId\r\n\t\t\t\t\t\t\t\t\t\t\t\t,FleetId\r\n\t\t\t\t\t\t\t\t\t\t\t\t,ExceptionDescription\r\n\t\t\t\t\t\t\t\t\t\t\t\t,CreateDate\r\n\t\t\t\t\t\t\t\t\t\t\t\t,CreateDatePersian\r\n\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\tOUTPUT inserted.FleetId INTO #FleetIds\r\n\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t15/*BUSY*/,\t\t\t\t\t--FleetStatusId\r\n\t\t\t\t\tf.Id,\t\t\t\t\t\t--FleetId VARIABLE\r\n\t\t\t\t\tNULL,\t\t\t\t\t\t--ExceptionDescription\r\n\t\t\t\t\t@CreateDate,\t\t\t\t--CreateDate VARIABLE\r\n\t\t\t\t\t@CreateDatePersian\t\t\t--CreateDatePersian VARIABLE\r\n\r\n\t\t\tFROM @Shipment s \r\n\t\t\tINNER JOIN CS_DriverManagement.DM.Fleet f ON s.FleetId=f.Id\r\n\t\t\t\r\n\r\n\t\t\tUPDATE f\r\n\t\t\tSET\tFleetStatusId=15/*BUSY*/\r\n\t\t\tFROM CS_DriverManagement.DM.Fleet f\r\n\t\t\tINNER JOIN #FleetIds f1 ON f1.ID=f.Id\r\n\r\n\t\t\t\r\n\t\t\tINSERT INTO @Result_DispatchRequestIds\r\n\t\t\tSELECT DISTINCT  dri.dispatchRequestId\r\n\t\t\tFROM #DispatchRequest dri \r\n\t\t\tINNER JOIN @Shipment s\t\t\tON s.FleetId=dri.shipmentFleetId\r\n\t\t\tWHERE dri.shipmentFleetId=dri.FleetId \r\n\t\t\tAND dri.failureReasons=5\r\n\t\t\r\n\t\t\r\n\t\t--ROLLBACK TRANSACTION\r\n\t\tCOMMIT TRANSACTION;\r\n\r\n\r\n\t\tDECLARE @ShipmentIds VARCHAR(1000)=(SELECT STUFF(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT  DISTINCT \u0027,\u0027 \u002B CAST(ShipmentId as varchar(10))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFROM @Shipment\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFOR XML PATH (\u0027\u0027)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),1,1,\u0027\u0027\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\tIF EXISTS(SELECT 1 FROM @Shipment)\tOR EXISTS(SELECT 1 FROM @Result_DispatchRequestIds)\r\n\t\tBEGIN\r\n\t\t\tSET @Result=\r\n\t\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN EXISTS(SELECT 1 FROM @Shipment) THEN @ShipmentIds \r\n\t\t\t\t\tELSE \u0027\u0027 \r\n\t\t\t\tEND ShipmentIds,\r\n\t\t\t\tJSON_QUERY(( \r\n\t\t\t\t\tSELECT DISTINCT OperationStaffId as Id,\r\n\t\t\t\t\t(\t\r\n\t\t\t\t\t\tSELECT string_agg(DispatchRequestId,\u0027,\u0027) \r\n\t\t\t\t\t\tFROM \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT DISTINCT drsi.DispatchRequestId \r\n\t\t\t\t\t\t\tFROM dp.DispatchRequest dri\r\n\t\t\t\t\t\t\tINNER JOIN @Result_DispatchRequestIds drsi\t\tON drsi.DispatchRequestId=dri.Id\r\n\t\t\t\t\t\t\tINNER JOIN dp.PolygonStore psi\t\t\t\t\tON dri.PolygonStoreId=psi.Id\r\n\t\t\t\t\t\t\tINNER JOIN dp.Polygon pi\t\t\t\t\t\tON pi.Id=psi.PolygonId\r\n\t\t\t\t\t\t\tINNER JOIN dp.PolygonOperationStaff posi\t\tON posi.PolygonId=pi.Id\r\n\t\t\t\t\t\t\tWHERE posi.OperationStaffId=pos.OperationStaffId\r\n\t\t\t\t\t\t)x\r\n\t\t\t\t\t)  DispatchRequestIds\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\tFROM dp.DispatchRequest dr\r\n\t\t\t\t\tINNER JOIN @Result_DispatchRequestIds drs\tON drs.DispatchRequestId=dr.Id\r\n\t\t\t\t\tINNER JOIN dp.PolygonStore ps\t\t\t\tON dr.PolygonStoreId=ps.Id\r\n\t\t\t\t\tINNER JOIN dp.Polygon p\t\t\t\t\t\tON p.Id=ps.PolygonId\r\n\t\t\t\t\tINNER JOIN dp.PolygonOperationStaff pos\t\tON pos.PolygonId=p.Id\r\n\t\t\t\t\tGROUP BY OperationStaffId\r\n\t\t\t\t\tFOR JSON PATH\r\n\t\t\t\t\t)) OperationStaffs\r\n\t\t\tFOR JSON PATH,WITHOUT_ARRAY_WRAPPER\r\n\t\t\t)\r\n\t\t\r\n\t\t\t\r\n\t\tEND\r\n\t\tELSE\r\n\t\tSET @Result=NULL\r\n\r\n\tEND TRY\r\n\tBEGIN CATCH\r\n\t\t\r\n\t\tSELECT   \r\n\t\t\t ERROR_NUMBER() AS ErrorNumber  \r\n\t\t\t,ERROR_MESSAGE() AS ErrorMessage;\r\n\t\t\r\n\t\tIF @@tranCount\u003E0\r\n\t\t\tROLLBACK TRANSACTION;\r\n\r\n\t\tSET @Result=NULL;\r\n\t\t\r\n\t\tTHROW;\r\n\tEND CATCH\r\n\t\t\r\n\r\n"},{"Name":"DeleteAllInfo_ByPolygonId","Schema":"dbo","Definition":"\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/06/21\r\n--\tDescription:\tDelete all Info by PolygonId\r\n--\r\n--\t=======================================\r\n\r\n/*\r\nEXEC [dbo].[DeleteAllInfo_ByPolygonId]\r\n\t\t\t\t\t\t\t\t@PolygonIds = \u0027103\u0027\r\n*/\r\nCREATE PROCEDURE [dbo].[DeleteAllInfo_ByPolygonId]\r\n        @PolygonIds NVARCHAR(MAX)\r\nAS\r\n    SET NOCOUNT ON\r\n\r\n    --#################################### Preparation Data ###################################################\r\n\r\n    DECLARE @PolygonId TABLE\r\n\t(\r\n\t\tId\tINT\r\n\t)\r\n\tINSERT INTO @PolygonId\r\n\tSELECT CAST(ISNULL(value,0) AS INT)\r\n\tFROM STRING_SPLIT(@PolygonIds,\u0027,\u0027)\r\n\r\n    select \r\n            dr.id as DispatchRequestId, \r\n            dr.DispatchRequestStatusId,\r\n            PolygonId\r\n    into #AllDispatch\r\n    from dp.DispatchRequest dr\r\n    join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n    INNER JOIN @PolygonId p\tON p.Id=ps.PolygonId\r\n\r\n    select \r\n            ShipmentId,\r\n            ShipmentDestinationPointId,\r\n            a1.DispatchRequestId,\r\n            FleetId\r\n    into #AllInfo\r\n    FROM #AllDispatch a1 \r\n    join dp.ShipmentDestinationPointDispatchRequest s1 on s1.DispatchRequestId = a1.DispatchRequestId\r\n    join dp.ShipmentDestinationPoint s2 on s2.Id = s1.ShipmentDestinationPointId\r\n    join dp.Shipment s on s2.ShipmentId = s.Id\r\n    join dp.Fleet f on s.FleetId = f.Id\r\n\r\n    --#################################### Delete DP Data ###################################################\r\n\r\n    delete s1 from dp.ShipmentDestinationPointStatusHistory s1\r\n    join #AllInfo a on a.ShipmentDestinationPointId = s1.ShipmentDestinationPointId\r\n\r\n    delete s1 from dp.ShipmentDestinationPointDispatchRequest s1\r\n    join #AllInfo a on s1.DispatchRequestId = s1.DispatchRequestId and s1.ShipmentDestinationPointId = a.ShipmentDestinationPointId\r\n\r\n    delete sdp from dp.ShipmentDestinationPoint sdp\r\n    join #AllInfo a on sdp.Id = a.ShipmentDestinationPointId\r\n    delete sdph from dp.ShipmentDestinationPointStatusHistory sdph\r\n    join #AllInfo a on sdph.ShipmentDestinationPointId = a.ShipmentDestinationPointId\r\n    \r\n    delete f1 from dp.DispatchRequestFleetPreAssignmentState f1\r\n    join #AllInfo a on f1.DispatchRequestId = a.DispatchRequestId\r\n\r\n    delete f1 from dp.FleetPreAssignmentState f1\r\n    join #AllInfo a on a.FleetId = f1.FleetId and f1.ShipmentId = a.ShipmentId\r\n\r\n    delete n1 from dp.NavigationServiceCallingRecord n1\r\n    join #AllInfo a on n1.ShipmentId = a.ShipmentId\r\n\r\n    delete s1 from dp.ShipmentStatusHistory s1\r\n    join #AllInfo a on s1.ShipmentId = a.ShipmentId\r\n\r\n    delete s from dp.Shipment s\r\n    join #AllInfo a on s.id = a.ShipmentId\r\n    delete ssh from dp.ShipmentStatusHistory ssh\r\n    join #AllInfo a on ssh.ShipmentId = a.ShipmentId    \r\n\r\n    delete drsh from dp.DispatchRequestStatusHistory drsh\r\n    join #AllInfo a on drsh.DispatchRequestId = a.DispatchRequestId \r\n\r\n    delete dr from dp.DispatchRequest dr\r\n    join #AllInfo a on dr.Id = a.DispatchRequestId\r\n\r\n    delete fsh from dp.FleetStatusHistory fsh\r\n    join #AllInfo a on fsh.FleetId = a.FleetId \r\n\r\n\tINSERT INTO DP.FleetStatusHistory\r\n\t(\r\n\t    FleetStatusId,\r\n\t    FleetId,\r\n\t    ExceptionDescription,\r\n\t    CreateDate,\r\n\t    CreateDatePersian\r\n\t)\r\n\tSELECT \r\n\t\t5,\r\n\t\tai.FleetId,\r\n\t\tNULL,\r\n\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027) \r\n\tFROM #AllInfo AS ai\r\n\r\n\tUPDATE f SET f.FleetStatusId = 5 FROM DP.Fleet F\r\n    JOIN #AllInfo a ON f.id = a.FleetId\r\n\r\n    --#################################### Delete OM Data ###################################################\r\n    \r\n    delete pish from CS_OrderManagement.om.ParcelItemStatusHistory pish\r\n    join CS_OrderManagement.om.ParcelItem pi on pish.ParcelItemId = pi.Id \r\n    join CS_OrderManagement.om.Parcel p on pi.ParcelId = p.Id\r\n    join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId\r\n\r\n    delete pi from CS_OrderManagement.om.ParcelItem pi \r\n    join CS_OrderManagement.om.Parcel p on pi.ParcelId = p.Id\r\n    join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId\r\n\r\n    delete psh from CS_OrderManagement.om.ParcelStatusHistory psh\r\n    join CS_OrderManagement.om.parcel p on psh.ParcelId = p.Id\r\n    join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId \r\n\r\n    delete ci from CS_OrderManagement.om.CourierInformation ci\r\n    join CS_OrderManagement.om.parcel p on ci.ParcelId = p.Id\r\n    join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId \r\n\r\n    delete ci from CS_OrderManagement.om.ParcelValueAdded ci\r\n    join CS_OrderManagement.om.parcel p on ci.ParcelId = p.Id\r\n    join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId \r\n\r\n\t delete p1 from CS_OrderManagement.om.ParcelInvoiceStatusHistory p1\r\n     join CS_OrderManagement.om.ParcelInvoice ci on p1.ParcelInvoiceId = ci.Id\r\n     join CS_OrderManagement.om.parcel p on ci.ParcelId = p.Id\r\n     join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId \r\n\r\n     delete ci from CS_OrderManagement.om.ParcelInvoice ci\r\n     join CS_OrderManagement.om.parcel p on ci.ParcelId = p.Id\r\n     join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId \r\n\r\n    delete p1 from CS_OrderManagement.om.ParcelInvoicePaymentInformation p1\r\n    join CS_OrderManagement.om.ParcelInvoice ci on p1.ParcelInvoiceId = ci.Id\r\n    join CS_OrderManagement.om.parcel p on ci.ParcelId = p.Id\r\n    join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId \r\n\r\n\r\n\r\n    delete p from CS_OrderManagement.om.parcel p \r\n    join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId \r\n\r\n    delete cr from CS_OrderManagement.om.CourierRequest cr\r\n    join CS_OrderManagement.om.parcel p on cr.id = p.CourierRequestId\r\n    join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId \r\n\r\n    delete cr from CS_OrderManagement.om.RequestStoreHistory cr\r\n    join CS_OrderManagement.om.parcel p on cr.CourierRequestId = p.CourierRequestId\r\n    join #AllInfo a on p.DispatchRequestId = a.DispatchRequestId \r\n"},{"Name":"Get_ActiveShipment_By_ShipmentIds","Schema":"dbo","Definition":"\r\n/*\r\n\tDECLARE @Result NVARCHAR(MAX)\r\n\texec [Get_ActiveShipment_By_ShipmentIds] @ShipmentIds=\u0027514645\u0027,@RESULT =@Result OUT \r\n\tSELECT @RESULT\r\n*/\r\nCREATE       PROCEDURE [dbo].[Get_ActiveShipment_By_ShipmentIds]\r\n\t@ShipmentIds\t\t\t\tVARCHAR(1000),\r\n\t@Result\t\t\t\t\t\tNVARCHAR(MAX) OUTPUT\r\nAS\r\n\r\n\tDECLARE @ShipmentId table\r\n\t(\r\n\t\tShipmentId\tINT\r\n\t)\r\n\r\n\tINSERT INTO @ShipmentId\r\n\tSELECT DISTINCT s.ID\r\n\tFROM String_split(@ShipmentIds,\u0027,\u0027) ss\r\n\tINNER JOIN DP.Shipment s (NOLOCK)\r\n\t\tON ss.value = s.ID\r\n\t\t--AND s.UpdateDate IS NULL\r\n\r\nBEGIN\r\n\r\n;WITH CTE_Fleet AS\r\n(\r\n\t\r\n\t\tSELECT DISTINCT\r\n\t\t\ts.FleetId,\r\n\t\t\td.ID DriverId,\r\n\t\t\td.Mobile AS DriverMobile,\r\n\t\t\tss.ShipmentId,\r\n\t\t\tREPLACE(st.Title,\u0027 \u0027,\u0027_\u0027) StoreTitle,\r\n\t\t\ts.UpdateDate\r\n\t\t\t--CASE WHEN dr.DispatchRequestStatusId IN ( 5,30,35,40,46,47,48,49 ) THEN 1 ELSE 0 END NotShowInResult\r\n\t\tFROM @ShipmentId ss\r\n\t\tINNER JOIN DP.Shipment s (NOLOCK)\r\n\t\t\tON ss.ShipmentId = s.ID\r\n\t\t\t--AND s.UpdateDate IS NULL\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK)\r\n\t\t\tON s.FleetId = f.ID\r\n\t\t\tAND f.IsActive=1\r\n\t\tJOIN CS_DriverManagement.DM.Driver AS d (NOLOCK)\r\n\t\t\tON d.Id = f.DriverId\r\n\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\tON s.ID = sdp.ShipmentId\r\n\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\tINNER JOIN DP.DispatchRequest dr (NOLOCK)\r\n\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\tINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\t\t\tON dr.PolygonStoreId = ps.ID\r\n\t\tINNER JOIN DP.Store st (NOLOCK)\r\n\t\t\tON ps.StoreId = st.ID\r\n\r\n\r\n)\r\n\r\nSELECT @Result = \r\n(\r\n\tSELECT \r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tf.FleetId ,\r\n\t\t\t\tf.DriverId,\r\n\t\t\t\tRIGHT(\u00270\u0027\u002BCAST(f.DriverMobile AS NVARCHAR(MAX)) , 11) DriverMobile,\r\n\t\t\t\tf.ShipmentId,\r\n\t\t\t\tf.StoreTitle,\r\n\t\t\t\tf.UpdateDate\r\n\t\t\tFROM CTE_Fleet f\r\n\t\t\tWHERE f.ShipmentId = s.ShipmentId\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t) NoName\r\n\tFROM @ShipmentId s\r\n\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n)\r\n\tSET @Result = REPLACE(@Result,\u0027{\u0022NoName\u0022:\u0022\u0027,\u0027\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027}\u0022}\u0027,\u0027}\u0027)\r\n\t\r\n\tSET @Result = NULLIF(@Result,\u0027[{\u0022NoName\u0022:null}]\u0027)\r\n\tSET @Result = NULLIF(@Result,\u0027[{\u0022NoName\u0022:[]}]\u0027)\r\n\t\r\n\r\nEND\r\n"},{"Name":"Get_ActiveShipment_LiveMap_By_ShimpentId","Schema":"dbo","Definition":"\r\nCREATE PROCEDURE [dbo].[Get_ActiveShipment_LiveMap_By_ShimpentId]\r\n\r\n\t\t@ShipmentId\tBIGINT,\r\n\t\t@Result\t\tNVARCHAR(MAX) OUTPUT\r\n\r\n\r\nAS \r\n\tSET NOCOUNT ON\r\n\r\n --############################################ Pre Calculate Result ##############################################\t\t\r\n\t\tDROP TABLE IF EXISTS\t#Shipment,\r\n\t\t\t\t\t\t\t\t#Fleet,\t\t\r\n\t\t\t\t\t\t\t\t#ShipmentDestinationPoint,\r\n\t\t\t\t\t\t\t\t#Store,\r\n\t\t\t\t\t\t\t\t#DispatchRequest\r\n\r\n\t\tSELECT\t\t\t\t\t\t\r\n\t\t\t\ts.Id AS shipmentId,\r\n\t\t\t\tCASE WHEN cast(s.SuggestedRoute AS NVARCHAR(MAX))=\u0027MULTIPOINT EMPTY\u0027 THEN NULL ELSE s.SuggestedRoute END AS SuggestedRoute ,\r\n\t\t\t\ts.SuggestedRouteJson\r\n\r\n\t\tINTO #Shipment\r\n\t\tFROM DP.Shipment AS s\r\n\t\tWHERE s.Id = @ShipmentId\r\n\r\n\t\tSELECT DISTINCT\r\n\t\t\t\tf.Id AS FleetId,\r\n\t\t\t\tCONCAT(d.FirstName, \u0027 \u0027, d.LastName) AS driverName,\r\n\t\t\t\tCONCAT(\u00270\u0027,d.Mobile) AS driverMobile\r\n\t\t\t\t--ISNULL(d.CustomerId,0) AS driverCustomerId\r\n\t\tINTO #Fleet\r\n\t\tFROM CS_DriverManagement.DM.Fleet AS f \r\n\t\tJOIN CS_DriverManagement.DM.Driver AS d ON d.Id = f.DriverId\r\n\t\tJOIN DP.Shipment AS s ON s.FleetId = f.Id\r\n\t\tWHERE s.Id = @ShipmentId\r\n\r\n\t\tSELECT \r\n\t\t\t\tsdp.Id AS shipmentSedtinationPointId,\r\n\t\t\t\tsdp.SequenceNumber AS sequenceNumber,\r\n\t\t\t\tsdp.Location,\r\n\t\t\t\tsdp.ShipmentDestinationPointStatusId AS shipmentDestinationPointStatusId,\r\n\t\t\t\tsdp.OperationTypeId AS operationTypeId,\r\n\t\t\t\tsdpdr.DispatchRequestId AS dispatchRequestId,\r\n\t\t\t\tFORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027) AS estimatedArrivalTimeStr,\r\n\t\t\t\tsdp.EstimatedOperationTimeSeconds AS estimatedOperationTimeSeconds,\r\n\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds,CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) AS estimatedMetDateTimeStr\r\n\t\tINTO #ShipmentDestinationPoint\r\n\t\tFROM DP.ShipmentDestinationPoint AS sdp\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\tWHERE sdp.ShipmentId = @ShipmentId\r\n\t\tAND sdp.ShipmentDestinationPointStatusId NOT IN (30,35)\r\n\r\n\r\n\t\tSELECT DISTINCT\r\n\t\t\t\ts2.Id AS storeId,\r\n\t\t\t\ts2.Title AS title,\r\n\t\t\t\ts2.VendorCode AS vendorCode\r\n\r\n\t\tINTO #Store\r\n\t\tFROM DP.ShipmentDestinationPoint AS sdp\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\tJOIN DP.DispatchRequest AS dr ON dr.Id = sdpdr.DispatchRequestId\r\n\t\tJOIN DP.PolygonStore AS ps ON dr.PolygonStoreId = ps.Id\r\n\t\tJOIN DP.Store AS s2 ON ps.StoreId = s2.Id\r\n\t\tWHERE sdp.ShipmentId = @ShipmentId\r\n\r\n\t\tSELECT  DISTINCT\r\n\t\t\t\tsdpdr.DispatchRequestId AS dispatchRequestId,\r\n\t\t\t\tdr.CourierRequestTypeId AS courierRequestTypeId,\r\n\t\t\t\tdr.VendorParcelCode AS vendorParcelCode,\r\n\t\t\t\tdr.ParcelReferenceCode AS parcelReferenceCode,\r\n                FORMAT([dr].[DeliveryStartTimePersian],\u0027####/##/## ##:##:##\\.###\u0027) AS deliveryStartTimePersianStr,\r\n                FORMAT([dr].[DeliveryDeadLineTimePersian],\u0027####/##/## ##:##:##\\.###\u0027) AS deliveryDeadLineTimePersianStr,\r\n\t\t\t\tFORMAT(dr.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS createDatePersianStr,\r\n\t\t\t\tFORMAT(dr.UpdateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS updateDatePersianStr,\r\n\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\tdr.IsNightly\r\n\t\tINTO #DispatchRequest\r\n\t\tFROM DP.ShipmentDestinationPoint AS sdp \r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\tJOIN DP.DispatchRequest AS dr ON dr.Id = sdpdr.DispatchRequestId\r\n\t\tWHERE sdp.ShipmentId = @ShipmentId\r\n\r\n\r\n\t\tSELECT \r\n\t\t\t\tdr.dispatchRequestId,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN dr.courierRequestTypeId IN (25,30,35) AND drsh.DispatchRequestStatusId IN (25,30,35)\r\n\t\t\t\t\t\tTHEN drsh.DispatchRequestStatusId\r\n\t\t\t\t\tWHEN dr.courierRequestTypeId NOT IN (25,30,35) \r\n\t\t\t\t\t\tTHEN drsh.DispatchRequestStatusId\r\n\t\t\t\tEND AS DispatchRequestStatusId,\r\n\t\t\t\tdrsh.Location,\r\n\t\t\t\tFORMAT(drsh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)AS CreateDatePersianStr,\r\n\t\t\t\tFORMAT(drsh.CreateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS createDateStr\r\n\r\n\t\tINTO #DispatchRequestStatusHistory\t\t\t\r\n\t\tFROM #DispatchRequest AS dr\r\n\t\tJOIN DP.DispatchRequestStatusHistory AS drsh ON drsh.DispatchRequestId = dr.dispatchRequestId\r\n\r\n\t--############################################ Calculate Result ##############################################\r\n\r\n\t\tDECLARE @shipmentSuggestedRoute NVARCHAR(MAX)\r\n\t\tSELECT @shipmentSuggestedRoute = s.SuggestedRouteJson FROM #Shipment AS s\r\n\r\n\t\tSET @Result=(SELECT (\t\t\r\n\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\ts.shipmentId,\r\n\t\t\t\t\t\t\t\t\t\tISNULL(REPLACE(REPLACE(CAST(s.suggestedRoute AS NVARCHAR(MAX)),\u0027), (\u0027,\u0027,{\u0022Latitude\u0022:\u0027),\u0027 \u0027,\u0027,,,\u0027),\u0027[]\u0027) suggestedRoute,\r\n\t\t\t\t\t\t\t\t\t\t/*s.SuggestedRouteJson*/ \u0027shipmentSuggestedRoute\u0027 AS shipmentSuggestedRoute\r\n\t\t\t\t\t\t\t\tFROM #Shipment AS s\r\n\t\t\t\t\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t\t\t)shipment,\r\n\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\tf.FleetId AS id,\r\n\t\t\t\t\t\t\t\t\t\tf.driverName,\r\n\t\t\t\t\t\t\t\t\t\tf.driverMobile\r\n\t\t\t\t\t\t\t\t\t\t--f.driverCustomerId \r\n\t\t\t\t\t\t\t\tFROM #Fleet AS f\r\n\t\t\t\t\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t\t\t)fleet,\r\n\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\t\t\t\t\tshipmentSedtinationPointId AS id,\r\n                                        sequenceNumber,\r\n                                        ISNULL((SELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tLocation.STY  AS  Latitude,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tLocation.STX  AS Longitude\r\n\t\t\t\t\t\t\t\t\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t\t\t\t\t\t),\u0027\u0027)AS location,\r\n                                        shipmentDestinationPointStatusId,\r\n                                        operationTypeId,\r\n                                        dispatchRequestId,\r\n                                        estimatedArrivalTimeStr,\r\n                                        estimatedOperationTimeSeconds,\r\n                                        estimatedMetDateTimeStr\r\n\t\t\t\t\t\t\t\tFROM #ShipmentDestinationPoint\r\n\t\t\t\t\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t\t\t\t\t\t\t)shipmentDestinationPoints,\r\n\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\ts2.storeId AS id,\r\n                                        s2.title,\r\n                                        s2.vendorCode \r\n\t\t\t\t\t\t\t\tFROM #Store AS s2\r\n\t\t\t\t\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t\t\t)store,\r\n\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\tdr.dispatchRequestId,\r\n                                        dr.courierRequestTypeId,\r\n                                        dr.vendorParcelCode,\r\n                                        dr.parcelReferenceCode,\r\n                                        dr.deliveryStartTimePersianStr,\r\n                                        dr.deliveryDeadLineTimePersianStr,\r\n                                        dr.createDatePersianStr,\r\n                                        dr.updateDatePersianStr,\r\n\t\t\t\t\t\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\t\t\t\t\t\tdr.IsNightly,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tISNULL((SELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdrsh.Location.STY  AS  Latitude,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdrsh.Location.STX  AS  Longitude\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t),\u0027\u0027)AS location,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tdrsh.dispatchRequestStatusId,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tdrs.Title AS dispatchRequestStatusTitle,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcreateDatePersianStr,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcreateDateStr\r\n\t\t\t\t\t\t\t\t\t\t\tFROM #DispatchRequestStatusHistory AS drsh\r\n\t\t\t\t\t\t\t\t\t\t\tJOIN DP.DispatchRequestStatus AS drs ON drs.Id = drsh.DispatchRequestStatusId\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE drsh.dispatchRequestId=dr.dispatchRequestId\r\n\t\t\t\t\t\t\t\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t\t\t\t\t\t\t\t\t\t)dispatchRequestStatusHistory\r\n\t\t\t\t\t\t\t\tFROM #DispatchRequest AS dr\r\n\t\t\t\t\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES \r\n\t\t\t\t\t\t\t)dispatchRequest\r\n\t\t\t\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t)\r\n\t--############################################ Correct Json Result ##############################################\r\n\r\n\t\t\t\tSET @Result=REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(@Result,\u0027\\\u0027,\u0027\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\u0027\u0022MULTIPOINT,,,((\u0027,\u0027[{\u0022Latitude\u0022:\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\u0027,,,\u0027,\u0027,\u0022Longitude\u0022:\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\u0027,{\u0027,\u0027},{\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\u0027\u0022SuggestedRoute\u0022:\u0022[]\u0022\u0027,\u0027\u0022SuggestedRoute\u0022:[]\u0027),\u0027))\u0022,\u0022\u0027,\u0027}],\u0022\u0027)\r\n\r\n\t\t\t\tset @result = Replace(@Result,N\u0027\u0022shipment\u0022:\u0022{\u0027,\u0027\u0022shipment\u0022:{\u0027)\r\n\t\t\t\tset @result = Replace(@Result,N\u0027))\u0022}\u0022,\u0027,\u0027}]},\u0027)\r\n\t\t\t\tset @result = Replace(@Result,N\u0027\u0022fleet\u0022:\u0022{\u0027,\u0027\u0022fleet\u0022:{\u0027)\r\n\t\t\t\tset @result = Replace(@Result,N\u0027}\u0022,\u0027,\u0027},\u0027)\r\n\t\t\t\tset @result = Replace(@Result,N\u0027\u0022shipmentDestinationPoints\u0022:\u0022{\u0027,\u0027\u0022shipmentDestinationPoints\u0022:{\u0027)\r\n\t\t\t\tset @result = Replace(@Result,N\u0027\u0022location\u0022:\u0022{\u0027,\u0027\u0022location\u0022:{\u0027)\r\n\t\t\t\tset @result = Replace(@Result,N\u0027}},\u0027,\u0027},\u0027)\r\n\t\t\t\tset @result = Replace(@Result,N\u0027\u0022store\u0022:\u0022{\u0027,\u0027\u0022store\u0022:{\u0027)\r\n\t\t\t\tset @result = Replace(@Result,N\u0027\u0022dispatchRequest\u0022:\u0022{\u0027,\u0027\u0022dispatchRequest\u0022:{\u0027)\r\n\t\t\t\t--set @result = Replace(@Result,N\u0027}\u0022}\u0027,\u0027}}\u0027)\r\n\t\t\t\tSET @Result = REPLACE( @Result,N\u0027\u0022{\u0022Routes\u0027,\u0027{\u0022Routes\u0027 )\r\n\t\t\t\tSET @Result = REPLACE(@Result,N\u0027}]}]}]}\u0022\u0027,\u0027}]}]}]}\u0027)\r\n\t\t\t\tSET @Result = REPLACE(@Result,N\u0027}\u0022},\u0022fleet\u0022\u0027,\u0027}},\u0022fleet\u0022\u0027)\r\n\t\t\t\tSET @Result=JSON_MODIFY(@Result,\u0027$.shipment.shipmentSuggestedRoute\u0027,@shipmentSuggestedRoute)\r\n\t\t\t\tSET @Result = REPLACE(@Result,\u0027\\\u0022\u0027,\u0027\u0022\u0027)\r\n\t\t\t\tSET @Result = REPLACE(@Result,\u0027\u0022shipmentSuggestedRoute\u0022:\u0022{\u0027,\u0027\u0022shipmentSuggestedRoute\u0022:{\u0027)\r\n\t\t\t\tSET @Result = REPLACE(@Result,\u0027}]}]}\u0022}\u0027,\u0027}]}]}}\u0027)\r\n\t\t\t\tSET @Result = REPLACE(@Result,\u0027\\\\\\\\\u0027,\u0027\\\\\u0027)"},{"Name":"Get_ActiveShipment_Map_By_ShipmentId","Schema":"dbo","Definition":"/*\r\nDECLARE @RESULT NVARCHAR(MAX)=\u0027\u0027\r\nexec Get_ActiveShipment_Map_By_ShipmentId @ShipmentId=656,@RESULT=@RESULT OUTPUT\r\nSELECT @RESULT\r\n*/\r\nCREATE PROCEDURE [dbo].[Get_ActiveShipment_Map_By_ShipmentId]\r\n\r\n\t@ShipmentId\tBIGINT,\r\n\t@Result\t\tNVARCHAR(MAX) OUTPUT\r\nAS\r\n\r\n\tSET @Result=(\r\n\t\tSELECT\ts.ShipmentStatusId,\r\n\t\t\t\t\r\n\t\t\t\tISNULL(REPLACE(REPLACE(CAST(s.suggestedRoute AS NVARCHAR(MAX)),\u0027), (\u0027,\u0027,{\u0022Latitude\u0022:\u0027),\u0027 \u0027,\u0027,,,\u0027),\u0027[]\u0027) SuggestedRoute,\r\n\t\t\t\tJSON_QUERY((\t\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tf.Id,\r\n\t\t\t\t\t\tISNULL(CustomerId,0)\t\t\t\t\tDriverCustomerId,\r\n\t\t\t\t\t\tCONCAT(d.FirstName\t,\u0027 \u0027,d.LastName)\tDriverName,\r\n\t\t\t\t\t\tCONCAT(\u00270\u0027,d.Mobile)\t\t\t\t\tDriverMobile\r\n\t\t\t\t\tFROM CS_DriverManagement.DM.fleet f  (NOLOCK) \r\n\t\t\t\t\tINNER JOIN CS_DriverManagement.DM.Driver d (NOLOCK)  ON f.DriverId=d.Id\r\n\t\t\t\t\tWHERE f.Id=s.fleetId\r\n\t\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t))Fleet,\r\n\t\t\t\tJSON_QUERY((\t\r\n\t\t\t\t\tSELECT  DISTINCT\r\n\t\t\t\t\t\t\tsdp.Id,\r\n\t\t\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\t\t\t\t\tSELECT sdp.Location.STY  AS  Latitude,sdp.Location.STX  AS Longitude\r\n\t\t\t\t\t\t\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t\t\t),\u0027\u0027)Location,\r\n\t\t\t\t\t\t\tShipmentDestinationPointStatusId,\r\n\t\t\t\t\t\t\tOperationTypeId,\r\n\t\t\t\t\t\t\tdr.Id DispatchRequestId ,\r\n\t\t\t\t\t\t\tdr.ParcelReferenceCode\r\n\t\t\t\t\tFROM dp.ShipmentDestinationPoint (NOLOCK) sdp \r\n\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr  (NOLOCK)  ON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t\t\t\tLEFT JOIN dp.DispatchRequest dr  (NOLOCK) ON dr.id=sdpdr.DispatchRequestId AND sdp.OperationTypeId=10\r\n\t\t\t\t\tWHERE sdp.ShipmentId=s.Id\r\n\t\t\t\t\tAND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30/*Aborted*/\r\n\t\t\t\t\tFOR JSON PATH\r\n\t\t\t\t))ShipmentDestinationPoints,\r\n\t\t\t\tJSON_QUERY((\r\n\t\t\t\t\tSELECT DISTINCT store.Id,store.Title,store.vendorCode \r\n\t\t\t\t\tFROM CS_DriverManagement.DM.Fleet f  (NOLOCK) \r\n\t\t\t\t\tinner join CS_DriverManagement.DM.PolygonFleet pf\t (NOLOCK) on pf.FleetId=f.id\r\n\t\t\t\t\tinner join dp.polygon p\t\t\t (NOLOCK) on p.id=pf.PolygonId\r\n\t\t\t\t\tinner join dp.PolygonStore ps\t (NOLOCK) on ps.PolygonId=p.id\r\n\t\t\t\t\tinner join dp.Store \t\t\t (NOLOCK) on store.id=ps.StoreId\r\n\t\t\t\t\tWHERE s.fleetid=f.id\r\n\t\t\t\t\tFOR JSON PATH,WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t))Store\r\n\t\tFROM dp.Shipment s\r\n\t\tWHERE s.Id=@ShipmentId\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t)\r\n\r\n\r\n\tSET @Result=REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(@Result,\u0027\\\u0027,\u0027\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\u0027\u0022MULTIPOINT,,,((\u0027,\u0027[{\u0022Latitude\u0022:\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\u0027,,,\u0027,\u0027,\u0022Longitude\u0022:\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\u0027,{\u0027,\u0027},{\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\u0027\u0022SuggestedRoute\u0022:\u0022[]\u0022\u0027,\u0027\u0022SuggestedRoute\u0022:[]\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\u0027))\u0022,\u0022Fleet\u0022:{\u0027,\u0027}],\u0022Fleet\u0022:{\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\u0027))\u0022,\u0022Fleet\u0022:\u0022\u0027,\u0027}],\u0022Fleet\u0022:\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\u0027}\u0022,\u0022ShipmentDestinationPoints\u0022\u0027,\u0027},\u0022ShipmentDestinationPoints\u0022\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\u0027\u0022Location\u0022:\u0022{\u0022Latitude\u0022\u0027,\u0027\u0022Location\u0022:{\u0022Latitude\u0022\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\u0027}\u0022,\u0022ShipmentDestinationPointStatusId\u0022\u0027,\u0027},\u0022ShipmentDestinationPointStatusId\u0022\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\u0027}},{\u0022Id\u0022:\u0027,\u0027},{\u0022Id\u0022:\u0027)\r\n\r\n\r\n"},{"Name":"Get_ActiveShipments_By_Filter","Schema":"dbo","Definition":"\r\n--- HAMID\r\nCREATE PROC [dbo].[Get_ActiveShipments_By_Filter]\r\n\r\n\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL ,\r\n\t@PolygonIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL,\r\n\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t\t=NULL ,\r\n\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t=NULL ,\r\n\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),---\r\n\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t\t= NULL,\r\n\t@ShipmentCreateDate\t\t\t\t\t\t\tBIGINT = NULL,\r\n\t@ShipmentNumber\t\t\t\t\t\t\t\tBIGINT = NULL,\r\n\t@VendorID\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL,\r\n\t@CourierRequestTypeIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t@OrderCategoryIds\t\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL,\r\n\t@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX) = NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,   \r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0 OUTPUT\r\n--WITH RECOMPILE\r\nAS\r\nSET NOCOUNT ON\r\n--SET STATISTICS TIME ON\r\nBEGIN\r\n\r\n--PRINT \u002700000\u0027\r\n--PRINT SYSDATETIME()\r\n\r\nDECLARE \r\n\t@OperationStaffId_Local\t\t\t\t\t\t\tINT ,\r\n\t@CityIds_Local\t\t\t\t\t\t\t\t\tVARCHAR(200)\t\t= NULL ,\r\n\t@PolygonIds_Local\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@FleetId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@StoreId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@ParcelReferenceCode_Local\t\t\t\t\t\tBIGINT\t\t\t\t= NULL ,\r\n\t@ShipmentStatusIds_Local\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@OperationWarningRangeTime_Local\t\t\t\tVARCHAR(10),\t\t  \r\n\t@MinimumDeliveryTime_Local\t\t\t\t\t\tVARCHAR(10),---\t\t  \r\n\t@VendorParcelCode_Local\t\t\t\t\t\t\tVARCHAR(32)\t\t\t= NULL ,\r\n\t@OrderBy_Local\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL ,\r\n\t@IsASC_Local\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL ,\r\n\t@VendorID_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@CourierRequestTypeIds_Local\t\t\t\t\tVARCHAR(MAX)\t\t= NULL ,\r\n\t@DeliveryServiceProviderIds_Local\t\t\t\tVARCHAR(MAX)\t\t= NULL \r\n\r\n\tSET @OperationStaffId_Local\t\t\t\t = @OperationStaffId\r\n\tSET @CityIds_Local\t\t\t\t\t\t = ISNULL(@CityIds,\u00270\u0027)\r\n\tSET @PolygonIds_Local\t\t\t\t\t = ISNULL(@PolygonIds,\u00270\u0027)\r\n\tSET @FleetId_Local\t\t\t\t\t\t = ISNULL(@FleetId,0)\r\n\tSET @StoreId_Local\t\t\t\t\t\t = ISNULL(@StoreId,0)\r\n\tSET @ParcelReferenceCode_Local\t\t\t = ISNULL(@ParcelReferenceCode,0)\r\n\tSET @ShipmentStatusIds_Local\t\t\t = ISNULL(@ShipmentStatusIds,\u00270\u0027)\r\n\tSET @OperationWarningRangeTime_Local\t = @OperationWarningRangeTime\r\n\tSET @MinimumDeliveryTime_Local\t\t\t = @MinimumDeliveryTime\r\n\tSET @VendorParcelCode_Local\t\t\t\t = ISNULL(@VendorParcelCode,\u00270\u0027)\r\n\tSET @VendorID_Local\t\t\t\t\t\t = ISNULL(@VendorID,0)\r\n\tSET @OrderBy_Local\t\t\t\t\t\t = ISNULL(@OrderBy,\u0027\u0027)\r\n\tSET @IsASC_Local\t\t\t\t\t\t = ISNULL(@IsASC,\u0027\u0027)\r\n\tSET @CourierRequestTypeIds_Local\t\t = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\tSET @DeliveryServiceProviderIds_Local = ISNULL(@DeliveryServiceProviderIds,\u00270\u0027)\r\n\tSET @CourierRequestTypeIds_Local = ISNULL(@CourierRequestTypeIds_Local,\u00270\u0027)\r\n\tSET @OrderCategoryIds = ISNULL(@OrderCategoryIds,\u00270\u0027)\r\n\r\n\tDROP TABLE IF EXISTS #DeliveryServiceProviderId,#CourierRequestTypeID,#OUTPUT\r\n\r\n\tSELECT \r\n\t\tdsp.Id\r\n\tINTO #DeliveryServiceProviderId\r\n\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceProviderIds_Local,\u0027,\u0027) ss\r\n\t\tON dsp.Id = ss.value\r\n\t\tOR @DeliveryServiceProviderIds_Local = \u00270\u0027\r\n\r\n\tSELECT \r\n\t\tcrt.Id\r\n\tINTO #CourierRequestTypeID\r\n\tFROM CS_Public.PUB.CourierRequestType crt (NOLOCK)\r\n\tINNER JOIN string_split(@CourierRequestTypeIds_Local,\u0027,\u0027) ss\r\n\t\tON crt.Id = ss.value\r\n\t\tOR @CourierRequestTypeIds_Local = \u00270\u0027\r\n\r\n\tSELECT\r\n\t\toc.Id\r\n\tINTO #OrderCategoryId\r\n\tFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\tINNER JOIN string_split(@OrderCategoryIds,\u0027,\u0027) ss\r\n\t\tON oc.Id = ss.value\r\n\t\tOR @OrderCategoryIds = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t(\r\n\t\tId\r\n\t)\r\n\r\n\tdeclare @sql1 nvarchar(max),\r\n\t\t\t@sql2 nvarchar(max),\r\n\t\t\t@sql nvarchar(max)\r\n\r\n    DECLARE @StartRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u0027000\u0027\r\n                                            ) as BIGINT)),\r\n            @EndRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002723\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u0027999\u0027\r\n                                            ) as BIGINT))\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\r\n\tSELECT p.Id\r\n\tINTO #PolygonId\r\n\tFROM DP.Polygon p (NOLOCK) \r\n\tINNER JOIN  string_split(@PolygonIds_Local,\u0027,\u0027)ss\r\n\t\tON p.Id = ss.value\r\n\t\tOR @PolygonIds_Local = \u00270\u0027\r\n\tWHERE p.IsActive = 1\r\n\r\n\r\n\r\n\tDROP TABLE IF EXISTS #ShipmentStatusId\r\n\tCREATE TABLE #ShipmentStatusId\t \r\n\t(\r\n\t\tId\tTINYINT \r\n\t)\r\n\tINSERT INTO #ShipmentStatusId\r\n\tSELECT shs.Id\r\n\tFROM DP.ShipmentStatus shs (NOLOCK)\r\n\tINNER JOIN string_split(ISNULL(@ShipmentStatusIds_Local,\u00270\u0027),\u0027,\u0027) ss\r\n\t\tON shs.Id = ss.value\r\n\t\tOR ISNULL(@ShipmentStatusIds_Local,\u00270\u0027) = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#ShipmentStatusId ON #ShipmentStatusId\r\n\t(\r\n\t\tId\r\n\t)\r\n\r\n\tDROP TABLE IF EXISTS #CityID\r\n\tSELECT c.Id INTO #CityID FROM CS_Public.HAF.City c\r\n\tINNER JOIN string_split(ISNULL(@CityIds_Local,\u00270\u0027),\u0027,\u0027) ss\r\n\t\tON c.ID = ss.value\r\n\t\tOR @CityIds_Local = \u00270\u0027\r\n\r\n\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE @Today INT=  CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\r\n\tDECLARE @From BIGINT,@TO BIGINT\r\n\t--SELECT @From = FORMAT(GETDATE()-1,\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027,@TO = FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027235959999\u0027\r\n\tSELECT @From = FORMAT(GETDATE()-1,\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027,@TO = FORMAT(GETDATE()\u002B1,\u0027yyyyMMdd\u0027)\u002B\u0027020000000\u0027\r\n\r\n\tDROP TABLE IF EXISTS \r\n\t\t\t#Result,\r\n\t\t\t#Result1,\r\n\t\t\t#TotalCount,\r\n\t\t\t#AllDispatchRequests,\r\n\t\t\t#UnassignedDispatchRequestCount,\r\n\t\t\t#UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t#AllShipmentDestinationPoint,\r\n\t\t\t#Assigned_DispatchRequestCount,\r\n\t\t\t#DelayedPickupCount,\r\n\t\t\t#DelayedDeliveryCount,\r\n\t\t\t#ReturnedCount\r\n\r\n\tDECLARE \r\n\t\t@Now BIGINT = FORMAT(GETDATE(),\u0027yyyyMMdd\u0027) \u002B \u0027235959999\u0027,\r\n\t\t@Yesterday BIGINT = FORMAT(GETDATE()-1,\u0027yyyyMMdd\u0027) \u002B \u0027000000000\u0027\r\n\r\nSELECT \r\n\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\nFROM\r\n(\r\n\tSELECT \r\n\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6,7) AND ddr.DeliveryStartTime BETWEEN @Yesterday AND @Now THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\tCASE \r\n\t\t\tWHEN \r\n\t\t\t\tIsWaitingForSupport = 1 \r\n\t\t\t\tAND DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\tTHEN ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS NotPickupRequestCount\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\t\r\n\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON DP.ID = pID.Id\r\n\tINNER JOIN #CityID cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE ddr.DeliveryStartTime \u003E= @From AND ddr.DeliveryDeadLineTime \u003C= @TO\r\n\tAND ((ddr.DispatchRequestStatusId in (5,6,7,10,11,15,16,20,25,45,46,50,51)) OR (ddr.CourierRequestTypeId = 25))\r\n\tAND pos.OperationStaffId = @OperationStaffId_Local\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local) OR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local) OR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local) OR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n    \r\n) SQ\r\nOPTION(USE HINT(\u0027DISALLOW_BATCH_MODE\u0027))\r\n\r\n\r\nSELECT \r\n\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount)\r\nFROM\r\n(\r\n\tSELECT \r\n\t\tCASE WHEN sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\tCASE WHEN sdp.OperationTypeId = (10) AND ddr.DispatchRequestStatusId IN (20,25) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\t\r\n\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON DP.ID = pID.Id\r\n\tINNER JOIN #CityID cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id = sdpdr.DispatchRequestId\r\n\t\tAND ddr.Version = sdpdr.Version\r\n\t\tAND sdpdr.CreateDate \u003E= @From\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\t\tAND sdp.CreateDate \u003E= @From\r\n\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id = sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tWHERE pos.OperationStaffId = @OperationStaffId_Local\t\r\n\tAND ddr.DispatchRequestStatusId in (10,11,15,16,20,25)\r\n\tAND ((ps.StoreId=@StoreId_Local) OR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local) OR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local) OR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n    AND ddr.DeliveryStartTime \u003E= @From AND ddr.DeliveryDeadLineTime \u003C= @TO\r\n\tAND ddr.DispatchRequestStatusId in (10,11,15,16,20,25)\r\n) SQ\r\nOPTION(USE HINT(\u0027DISALLOW_BATCH_MODE\u0027))\r\n\r\n\tDECLARE @OperationWarningRangeTime_Second INT=DATEDIFF (SECOND,0,@OperationWarningRangeTime_Local)\r\n\r\n\tSELECT @TotalCount = COUNT(DISTINCT sdp.ShipmentId)\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\t\tAND sdpdr.Version = ddr.Version\r\n\t\tAND sdpdr.CreateDate \u003E= @From\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.CreateDate \u003E= @From\r\n\tINNER JOIN dP.Shipment(NOLOCK) DPSH\r\n\t\tON DPSH.Id=sdp.ShipmentId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON dp.ID = pID.Id\r\n\tINNER JOIN #CityID cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet DMF WITH(NOLOCK)\r\n\t\tON DPSH.FleetId = DMF.Id\r\n\t\t--AND DMF.IsActive = 1\r\n\tLEFT JOIN DP.DispatchRequestAttributeValue drav WITH(NOLOCK)\r\n\t\tON ddr.Id = drav.DispatchRequestId\r\n\t\tAND drav.DispatchRequestAttributeAllowedValueId = 4\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n    --AND DPSH.CreateDate BETWEEN @From AND @TO\r\n\tAND ddr.DeliveryStartTime \u003E= @From AND ddr.DeliveryDeadLineTime \u003C= @TO\r\n\r\n\tAND DPSH.ShipmentStatusId IN ( 5,6,10,15,20,25,30,35,40 )\r\n\r\n\tAND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15,20,25,40,100 ) \r\n\t--AND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35 ) \r\n\tAND sdp.OperationTypeId IN (5,10,15,20,25,30)\r\n\t\r\n\tAND (ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,47,48,49,52,53,54,50,51) OR drav.Id IS NOT NULL )\r\n\tAND ((DPSH.FleetId = @FleetId_Local) OR (ISNULL(@FleetId_Local,0) = 0))\t\r\n\tAND ((s.Id = @StoreId_Local) OR (ISNULL(@StoreId_Local,0) = 0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local) OR (ISNULL(@ParcelReferenceCode_Local,0) = 0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local) OR (ISNULL(@VendorParcelCode_Local,\u00270\u0027) = \u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\r\n--;WITH CTE_ShipmentList AS\r\n--(\r\n\r\n\tSELECT\r\n\t\tsdp.ShipmentId,\r\n\t\tDPSH.ShipmentStatusId,\r\n\t\tDPSH.ShipmentNumber,\r\n\t\tDPSH.CreateDate,\r\n\t\tDPSH.TotalEstimatedDurationSeconds,\r\n\t\tDPSH.TotalDistanceMeter,\r\n\t\tdp.CityId,\r\n\t\tps.PolygonId,\r\n\t\tdp.Title AS PolygonTitle,\r\n\t\tps.StoreId,\r\n\t\ts.Title AS StoreTitle,\r\n\t\ts.Location.STY  AS  StoreLocationLat,\r\n\t\ts.Location.STX  AS\tStoreLocationLong,\r\n\t\t--0 AS PickupStatus,\r\n\t\t--0 AS DeliveryStatus,\r\n\t\t--0 AS OperationStatus,\r\n\t\t--sdp.EstimatedArrivalTime,\r\n\t\t--sdp.EstimatedOperationTimeSeconds,\r\n\t\t-- DATEADD(SECOND,ds.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(ds.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\tCOUNT(DISTINCT VendorParcelCode) DispatchRequestCount,\r\n\t\tCAST(MAX(CASE WHEN drav.Id IS NOT NULL THEN 1 ELSE 0 END) AS BIT) IsReturnToStoreRequired,\r\n\t\tMAX(ddr.DeliveryServiceProviderId) AS DeliveryServiceProviderId,\r\n\t\tDPSH.FleetId,\r\n\t\ts.OrderCategoryId,\r\n\t\tDPSH.FleetShiftId,\r\n\t\tDPSH.TypeOfShipmentId,\r\n\t\tDPSH.ApproveShipmentTime\r\n\tINTO #CTE_ShipmentList\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\t\tAND sdpdr.Version = ddr.Version\r\n\t\tAND sdpdr.CreateDate \u003E= @From\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.CreateDate \u003E= @From\r\n\tINNER JOIN dP.Shipment DPSH WITH(NOLOCK)\r\n\t\tON DPSH.Id=sdp.ShipmentId\r\n\t\t\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON dp.ID = pID.Id\r\n\tINNER JOIN #CityID cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet DMF WITH(NOLOCK)\r\n\t\tON DPSH.FleetId = DMF.Id\r\n\t\t--AND DMF.IsActive = 1\r\n\tLEFT JOIN DP.DispatchRequestAttributeValue drav WITH(NOLOCK)\r\n\t\tON ddr.Id = drav.DispatchRequestId\r\n\t\tAND drav.DispatchRequestAttributeAllowedValueId = 4\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n    --AND DPSH.CreateDate BETWEEN @From AND @TO\r\n\tAND ddr.DeliveryStartTime \u003E= @From AND ddr.DeliveryDeadLineTime \u003C= @TO\r\n\r\n\tAND DPSH.ShipmentStatusId IN ( 5,6,10,15,20,25,30,35,40 )\r\n\r\n\tAND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15,20,25,40,100 ) \r\n\t--AND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35 )\r\n\tAND sdp.OperationTypeId IN (5,10,15,20,25,30)\r\n\t\r\n\tAND (ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,47,48,49,52,53,54,50,51) OR drav.Id IS NOT NULL )\r\n\tAND ((DPSH.FleetId = @FleetId_Local) OR (ISNULL(@FleetId_Local,0) = 0))\t\r\n\tAND ((s.Id = @StoreId_Local) OR (ISNULL(@StoreId_Local,0) = 0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local) OR (ISNULL(@ParcelReferenceCode_Local,0) = 0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local) OR (ISNULL(@VendorParcelCode_Local,\u00270\u0027) = \u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\t\r\n\tGroup By sdp.ShipmentId,\r\n\t\tDPSH.ShipmentStatusId,\r\n\t\tDPSH.ShipmentNumber,\r\n\t\tDPSH.CreateDate,\r\n\t\tDPSH.TotalEstimatedDurationSeconds,\r\n\t\tDPSH.TotalDistanceMeter,\r\n\t\tdp.CityId,\r\n\t\tps.PolygonId,\r\n\t\tdp.Title,\r\n\t\tps.StoreId,\r\n\t\ts.Title,\r\n\t\ts.Location.STY,\r\n\t\ts.Location.STX,\r\n\t\tDPSH.FleetId,\r\n\t\ts.OrderCategoryId,\r\n\t\tDPSH.FleetShiftId,\r\n\t\tDPSH.TypeOfShipmentId,\r\n\t\tDPSH.ApproveShipmentTime\r\n\tORDER BY DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,(DPSH.TotalEstimatedDurationSeconds), CAST(FORMAT((DPSH.CreateDate), \u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME))) ASC\r\n\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\tOPTION(USE HINT(\u0027DISALLOW_BATCH_MODE\u0027))\r\n--)\r\n\r\n;WITH CTE_Pickup AS\r\n(\r\n\tSELECT \r\n\t\tshl.ShipmentId,\r\n\t\tCASE \r\n\t\t\tWHEN GETDATE() \u003C (DATEADD(SECOND,-@OperationWarningRangeTime_Second,DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))))\r\n\t\t\tTHEN 1\r\n\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\tDATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\tTHEN 3\r\n\t\t\tWHEN GETDATE() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\tTHEN 4\r\n\t\tEND Pickup,\r\n\t\t1 AS Delivery\r\n\tFROM #CTE_ShipmentList shl\r\n\tINNER JOIN DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\t\tON shl.ShipmentId = sdp.ShipmentId\r\n\t\tAND sdp.OperationTypeId = 5\r\n\t\tAND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15,20,25 )\r\n\tWHERE shl.ShipmentStatusId IN ( 5,6,10,15,20 )\r\n), CTE_Delivery AS\r\n(\r\n\tSELECT \r\n\t\tshl.ShipmentId,\r\n\t\t2 AS Pickup,\r\n\t\tCASE \r\n\t\t\tWHEN GETDATE() \u003C (DATEADD(SECOND,-@OperationWarningRangeTime_Second,DATEADD(SECOND,(shl.TotalEstimatedDurationSeconds), CAST(FORMAT((shl.CreateDate), \u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME))))\r\n\t\t\tTHEN 1\r\n\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,DATEADD(SECOND,(shl.TotalEstimatedDurationSeconds), CAST(FORMAT((shl.CreateDate), \u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)))\r\n\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\tDATEADD(SECOND,(shl.TotalEstimatedDurationSeconds), CAST(FORMAT((shl.CreateDate), \u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME))\r\n\t\t\tTHEN 3\r\n\t\t\tWHEN GETDATE() \u003E DATEADD(SECOND,(shl.TotalEstimatedDurationSeconds), CAST(FORMAT((shl.CreateDate), \u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME))\r\n\t\t\tTHEN 4\r\n\t\tEND Delivery\r\n\tFROM #CTE_ShipmentList shl\r\n\tWHERE shl.ShipmentStatusId NOT IN ( 5,6,10,15,20 )\r\n)\r\n\tSELECT \r\n\t\tSHL.ShipmentId AS Id,\r\n\t\tSHL.ShipmentStatusId AS StatusId,\r\n\t\tdss.Title AS StatusTitle,\r\n\t\tSHL.ShipmentNumber,\r\n\t\tSHL.TotalEstimatedDurationSeconds,\r\n\t\tSHL.TotalDistanceMeter,\r\n\t\tSHL.CityId,\r\n\t\tSHL.PolygonId,\r\n\t\tSHL.PolygonTitle,\r\n\t\tSHL.StoreId,\r\n\t\tSHL.StoreLocationLat,\r\n\t\tSHL.StoreLocationLong,\r\n\t\tSHL.StoreTitle,\r\n\t\tISNULL(p.Pickup,dl.Pickup) PickupStatus,\r\n\t\tISNULL(p.Delivery,dl.Delivery)  DeliveryStatus,\r\n\t\tCASE WHEN shl.ShipmentStatusId IN ( 5,6,10,15,20 ) THEN ISNULL(p.Pickup,dl.Pickup) ELSE ISNULL(p.Delivery,dl.Delivery) END OperationStatus,\r\n\t\tDATEADD(SECOND,SHL.TotalEstimatedDurationSeconds, CAST(FORMAT(SHL.CreateDate, \u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) EstimatedEndDateTimeStr,\r\n\t\tSHL.DispatchRequestCount,\r\n\t\tSHL.FleetId,\r\n\t\tf.DriverId,\r\n\t\tCONCAT(d.FirstName,\u0027 \u0027,d.LastName) AS DriverName,\r\n\t\tCONCAT(\u00270\u0027,d.Mobile) AS DriverMobile,\r\n\t\tv.VehicleTypeId,\r\n\t\tv.PlateNumber,\r\n\t\tSHL.IsReturnToStoreRequired,\r\n\t\tSHL.DeliveryServiceProviderId,\r\n\t\tSHL.orderCategoryId,\r\n\t\toc.Title AS orderCategoryTitle,\r\n\t\tSHL.FleetShiftId,\r\n\t\tSHL.TypeOfShipmentId,\r\n\t\tSHL.ApproveShipmentTime\t\t\r\n\tFROM #CTE_ShipmentList SHL\r\n\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\tON dss.Id = SHL.ShipmentStatusId\r\n\t\t--AND shl.ShipmentId = 25347715\r\n\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet f WITH(NOLOCK)\r\n\t\tON SHL.FleetId = f.Id\r\n\tINNER JOIN CS_DriverManagement.DM.Driver d WITH(NOLOCK)\r\n\t\tON f.DriverId = d.Id\r\n\tINNER JOIN CS_DriverManagement.DM.vehicle v WITH(NOLOCK)\t\t\r\n\t\tON f.VehicleId = v.Id\r\n\tINNER JOIN CS_UserManagement.UM.OrderCategory oc WITH(NOLOCK)\r\n\t\tON SHL.OrderCategoryId = oc.Id\r\n\r\n\tLEFT JOIN CTE_Pickup p\r\n\t\tON shl.ShipmentId = p.ShipmentId\r\n\tLEFT JOIN CTE_Delivery dl\r\n\t\tON shl.ShipmentId = dl.ShipmentId\r\n\tORDER BY OperationStatus DESC, DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,(shl.TotalEstimatedDurationSeconds), CAST(FORMAT((shl.CreateDate), \u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME))) ASC\r\nOPTION(USE HINT(\u0027DISALLOW_BATCH_MODE\u0027))\r\n\r\n\r\n\t/*\r\n\tSELECT * INTO #Output FROM \r\n\t(\r\n\tSELECT DISTINCT\r\n\t\t\tsdp.ShipmentId\t\t\t\t\t\t\tId,\r\n\t\t\tsdp.ShipmentStatusId\t\t\t\t\tStatusId,\r\n\t\t\tsdp.ShipmentStatusTitle\t\t\t\t\tStatusTitle,\r\n\t\t\tsdp.ShipmentNumber,\r\n\t\t\tsdp.TotalEstimatedDurationSeconds,\r\n\t\t\tsdp.TotalDistanceMeter,\r\n\t\t\tddr.CityId\t\t\t\t\t\t\t\tCityId,\r\n\t\t\tddr.PolygonId\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tddr.polygonTitle\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tddr.StoreId\t\t\t\t\t\t\t\tStoreId,\r\n\t\t\ts.Location.STY  AS  StoreLocationLat,\r\n\t\t\ts.Location.STX  AS\tStoreLocationLong,\r\n\t\t\tddr.StoreTitle\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\t--sdp.ShipmentStatusId,\r\n\t\t\tPickupStatus.PickupStatus,\r\n\t\t\tDeliveryStatus.DeliveryStatus,\r\n\t\t\tISNULL(CASE \r\n\t\t\t\tWHEN sdp.ShipmentStatusId IN (5,6,10,15,20)\tTHEN PickupStatus\r\n\t\t\t\tWHEN sdp.ShipmentStatusId IN (25,30,35,40)\tTHEN DeliveryStatus\r\n\t\t\t\tELSE 0\r\n\t\t\tEND,0) OperationStatus,\r\n\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\tISNULL(tc.DispatchRequestCount,0) DispatchRequestCount, --(SELECT DispatchRequestCount FROM CTE_TotalCount t where shipmentId=t.shipmentId)\tDispatchRequestCount,\r\n\t\t\tdf.Id\t\t\t\t\t\t\t\t\tFleetId,\r\n\t\t\td.Id\t\t\t\t\t\t\t\t\tDriverId,\r\n\t\t\tCONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\tDriverName,\r\n\t\t\tCONCAT(\u00270\u0027,d.Mobile)\t\t\t\t\tDriverMobile,\r\n\t\t\tdv.VehicleTypeId,\r\n\t\t\tdv.PlateNumber,\r\n\t\t\tISNULL(rtsr.IsReturnToStoreRequired,0) IsReturnToStoreRequired,\r\n\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\ts.orderCategoryId,\r\n\t\t\toc.Title AS orderCategoryTitle,\r\n\t\t\tddr.FleetShiftId\r\n\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #CTE_Shipment  ddr\t\t\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tJOIN DP.Store AS s with(nolock) ON s.Id = ddr.StoreId\r\n\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tON s.OrderCategoryId = oc.Id\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sdp.FleetId\t--\tAND df.IsActive=1\r\n\tINNER JOIN CS_DriverManagement.DM.vehicle(NOLOCK) dv\t\t\t\t\t\t\t\t\tON dv.Id=df.VehicleId\r\n\tINNER JOIN CS_DriverManagement.DM.Driver(NOLOCK) AS d\t\t\t\t\t\t\t\t\tON d.id = df.DriverId\r\n\tLEFT JOIN CTE_PickupStatus PickupStatus ON PickupStatus.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_Delivery DeliveryStatus ON DeliveryStatus.ShipmentId=sdp.ShipmentId\r\n\tINNER JOIN CTE_Estimated EstimatedEndDateTimeStr ON EstimatedEndDateTimeStr.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_TotalCount tc ON  sdp.ShipmentId = tc.shipmentId\r\n\tLEFT JOIN CTE_IsReturnToStoreRequired rtsr\r\n\t\tON sdp.ShipmentId = rtsr.ShipmentId\r\n\tWHERE (ddr.DispatchRequestStatusId IN (10/*Assigned To Courier*/,11/*Reassigned*/,15/*Arrived at Pickup point*/,\r\n\t\t\t\t\t\t\t\t\t\t 16/*SecondFleetArrivedAtPickupPoint*/,20/*Picked up*/,25/*Arrived at Delivery Point*/,\r\n\t\t\t\t\t\t\t\t\t\t 45/*Cancel Response Pending*/,46/*Second Cancel Request Pending*/,47,48,49,52,53,54,50/*Cancel Request Rejected*/,\r\n\t\t\t\t\t\t\t\t\t\t 51/*Second Cancel Request Rejected*/)  OR rtsr.IsReturnToStoreRequired IS NOT NULL )\r\n\tAND sdp.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\tAND sdp.OperationTypeId IN (10,15,20,25,30)\r\n\tAND ((df.Id\t\t =@FleetId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\tAND ((ddr.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\r\n\tSET @TotalCount = @@ROWCOUNT\r\n\r\n\tSELECT @TotalCount\r\n\tSELECT COUNT(DISTINCT ShipmentId) FROM #CTE_Shipment\r\n\r\n\tSELECT * FROM #Output\r\n\r\n\tORDER BY \r\n\t\tCASE WHEN @OrderBy_Local IS NOT NULL AND @OrderBy_Local \u003C\u003E \u0027\u0027 AND @OrderBy_Local \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\u002B  @OrderByReplace \r\n\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\tEND,\r\n\t\tOperationStatus DESC,\r\n\t\tEstimatedEndDateTimeStr ASC\r\n\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n--\tOPTION (USE HINT (\u0027FORCE_LEGACY_CARDINALITY_ESTIMATION\u0027));\r\n--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\tSET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n*/\r\nEND\r\n\r\n\r\n"},{"Name":"Get_ActiveShipments_By_Filter_BACKUP","Schema":"dbo","Definition":"\r\nCREATE              PROC [dbo].[Get_ActiveShipments_By_Filter_BACKUP]\r\n\r\n\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL ,\r\n\t@PolygonIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL,\r\n\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t\t=NULL ,\r\n\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t=NULL ,\r\n\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),---\r\n\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t\t= NULL,\r\n\t@ShipmentCreateDate\t\t\t\t\t\t\tBIGINT = NULL,\r\n\t@ShipmentNumber\t\t\t\t\t\t\t\tBIGINT = NULL,\r\n\t@VendorID\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL,\r\n\t@CourierRequestTypeIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t@OrderCategoryIds\t\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL,\r\n\t@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX) = NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,   \r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0 OUTPUT\r\n--WITH RECOMPILE\r\nAS\r\nSET NOCOUNT ON\r\n--SET STATISTICS TIME ON\r\nBEGIN\r\n\r\n--PRINT \u002700000\u0027\r\n--PRINT SYSDATETIME()\r\n\r\nDECLARE \r\n\t@OperationStaffId_Local\t\t\t\t\t\t\tINT ,\r\n\t@CityIds_Local\t\t\t\t\t\t\t\t\tVARCHAR(200)\t\t= NULL ,\r\n\t@PolygonIds_Local\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@FleetId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@StoreId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@ParcelReferenceCode_Local\t\t\t\t\t\tBIGINT\t\t\t\t= NULL ,\r\n\t@ShipmentStatusIds_Local\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@OperationWarningRangeTime_Local\t\t\t\tVARCHAR(10),\t\t  \r\n\t@MinimumDeliveryTime_Local\t\t\t\t\t\tVARCHAR(10),---\t\t  \r\n\t@VendorParcelCode_Local\t\t\t\t\t\t\tVARCHAR(32)\t\t\t= NULL ,\r\n\t@OrderBy_Local\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL ,\r\n\t@IsASC_Local\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL ,\r\n\t@VendorID_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@CourierRequestTypeIds_Local\t\t\t\t\tVARCHAR(MAX)\t\t= NULL ,\r\n\t@DeliveryServiceProviderIds_Local\t\t\t\tVARCHAR(MAX)\t\t= NULL \r\n\r\n\tSET @OperationStaffId_Local\t\t\t\t = @OperationStaffId\r\n\tSET @CityIds_Local\t\t\t\t\t\t = ISNULL(@CityIds,\u00270\u0027)\r\n\tSET @PolygonIds_Local\t\t\t\t\t = ISNULL(@PolygonIds,\u00270\u0027)\r\n\tSET @FleetId_Local\t\t\t\t\t\t = ISNULL(@FleetId,0)\r\n\tSET @StoreId_Local\t\t\t\t\t\t = ISNULL(@StoreId,0)\r\n\tSET @ParcelReferenceCode_Local\t\t\t = ISNULL(@ParcelReferenceCode,0)\r\n\tSET @ShipmentStatusIds_Local\t\t\t = ISNULL(@ShipmentStatusIds,\u00270\u0027)\r\n\tSET @OperationWarningRangeTime_Local\t = @OperationWarningRangeTime\r\n\tSET @MinimumDeliveryTime_Local\t\t\t = @MinimumDeliveryTime\r\n\tSET @VendorParcelCode_Local\t\t\t\t = ISNULL(@VendorParcelCode,\u00270\u0027)\r\n\tSET @VendorID_Local\t\t\t\t\t\t = ISNULL(@VendorID,0)\r\n\tSET @OrderBy_Local\t\t\t\t\t\t = ISNULL(@OrderBy,\u0027\u0027)\r\n\tSET @IsASC_Local\t\t\t\t\t\t = ISNULL(@IsASC,\u0027\u0027)\r\n\tSET @CourierRequestTypeIds_Local\t\t = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\tSET @DeliveryServiceProviderIds_Local = ISNULL(@DeliveryServiceProviderIds,\u00270\u0027)\r\n\tSET @CourierRequestTypeIds_Local = ISNULL(@CourierRequestTypeIds_Local,\u00270\u0027)\r\n\tSET @OrderCategoryIds = ISNULL(@OrderCategoryIds,\u00270\u0027)\r\n\r\n\tDROP TABLE IF EXISTS #DeliveryServiceProviderId,#CourierRequestTypeID,#OUTPUT\r\n\r\n\tSELECT \r\n\t\tdsp.Id\r\n\tINTO #DeliveryServiceProviderId\r\n\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceProviderIds_Local,\u0027,\u0027) ss\r\n\t\tON dsp.Id = ss.value\r\n\t\tOR @DeliveryServiceProviderIds_Local = \u00270\u0027\r\n\r\n\tSELECT \r\n\t\tcrt.Id\r\n\tINTO #CourierRequestTypeID\r\n\tFROM CS_Public.PUB.CourierRequestType crt (NOLOCK)\r\n\tINNER JOIN string_split(@CourierRequestTypeIds_Local,\u0027,\u0027) ss\r\n\t\tON crt.Id = ss.value\r\n\t\tOR @CourierRequestTypeIds_Local = \u00270\u0027\r\n\r\n\tSELECT\r\n\t\toc.Id\r\n\tINTO #OrderCategoryId\r\n\tFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\tINNER JOIN string_split(@OrderCategoryIds,\u0027,\u0027) ss\r\n\t\tON oc.Id = ss.value\r\n\t\tOR @OrderCategoryIds = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t(\r\n\t\tId\r\n\t)\r\n\r\n\tdeclare @sql1 nvarchar(max),\r\n\t\t\t@sql2 nvarchar(max),\r\n\t\t\t@sql nvarchar(max)\r\n\r\n    DECLARE @StartRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u0027000\u0027\r\n                                            ) as BIGINT)),\r\n            @EndRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002723\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u0027999\u0027\r\n                                            ) as BIGINT))\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\r\n\tSELECT p.Id\r\n\tINTO #PolygonId\r\n\tFROM DP.Polygon p (NOLOCK) \r\n\tINNER JOIN  string_split(@PolygonIds_Local,\u0027,\u0027)ss\r\n\t\tON p.Id = ss.value\r\n\t\tOR @PolygonIds_Local = \u00270\u0027\r\n\r\n\tDROP TABLE IF EXISTS #ShipmentStatusId\r\n\tCREATE TABLE #ShipmentStatusId\t \r\n\t(\r\n\t\tId\tTINYINT\r\n\t)\r\n\tINSERT INTO #ShipmentStatusId\r\n\tSELECT shs.Id\r\n\tFROM DP.ShipmentStatus shs (NOLOCK)\r\n\tINNER JOIN string_split(ISNULL(@ShipmentStatusIds_Local,\u00270\u0027),\u0027,\u0027) ss\r\n\t\tON shs.Id = ss.value\r\n\t\tOR ISNULL(@ShipmentStatusIds_Local,\u00270\u0027) = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#ShipmentStatusId ON #ShipmentStatusId\r\n\t(\r\n\t\tId\r\n\t)\r\n\r\n\tDROP TABLE IF EXISTS #CityID\r\n\tSELECT c.Id INTO #CityID FROM CS_Public.HAF.City c\r\n\tINNER JOIN string_split(ISNULL(@CityIds_Local,\u00270\u0027),\u0027,\u0027) ss\r\n\t\tON c.ID = ss.value\r\n\t\tOR @CityIds_Local = \u00270\u0027\r\n\r\n\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE @Today INT=  CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\r\n\tDECLARE @From BIGINT,@TO BIGINT\r\n\t--SELECT @From = FORMAT(GETDATE()-1,\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027,@TO = FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027235959999\u0027\r\n\tSELECT @From = FORMAT(GETDATE()-1,\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027,@TO = FORMAT(GETDATE()\u002B1,\u0027yyyyMMdd\u0027)\u002B\u0027020000000\u0027\r\n\r\n\r\n\tDROP TABLE IF EXISTS \r\n\t\t\t#Result,\r\n\t\t\t#Result1,\r\n\t\t\t#TotalCount,\r\n\t\t\t#AllDispatchRequests,\r\n\t\t\t#UnassignedDispatchRequestCount,\r\n\t\t\t#UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t#AllShipmentDestinationPoint,\r\n\t\t\t#Assigned_DispatchRequestCount,\r\n\t\t\t#DelayedPickupCount,\r\n\t\t\t#DelayedDeliveryCount,\r\n\t\t\t#ReturnedCount\r\n\r\n\tDECLARE @Now int=LEFT(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),8),\r\n\t\t@Yesterday int = LEFT(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),8)\r\n\r\n\t--SET @DelayedDeliveryRequestCount = NULL\r\n\t--SET @DelayedPickupCount = NULL\r\n\t--SET @ReturnedRequestCount = NULL\r\n\t--SET @AssignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedReturnAndReplacementRequestCount = NULL\r\n\t--SET @NotPickupRequestCount = NULL\r\n\r\n\t--EXEC Get_OperationPanel_Count\r\n\t--\t\t@OperationStaffId = @OperationStaffId_Local,\r\n\t--\t\t@CityIds = @CityIds_Local,\r\n\t--\t\t@PolygonIds = @PolygonIds_Local,\r\n\t--\t\t@VendorID = @VendorID_Local,\r\n\t--\t\t@UnassignedDispatchRequestCount\t\t\t\t = @UnassignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t\t@AssignedDispatchRequestCount\t\t\t\t = @AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t\t@ReturnedRequestCount\t\t\t\t\t\t = @ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t\t@DelayedDeliveryCount\t\t\t\t\t\t = @delayedDeliveryRequestCount\t\t\t\t\tOUTPUT,\r\n\t--\t\t@UnassignedReturnAndReplacementRequestCount  = @UnassignedReturnAndReplacementRequestCount\tOUTPUT,\r\n\t--\t\t@NotPickupRequestCount\t\t\t\t\t\t = @NotPickupRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t\t@DelayedPickupCount\t\t\t\t\t\t\t = @DelayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = ISNULL(@UnassignedDispatchRequestCount,0),\t\t\t\r\n\t--\t@AssignedDispatchRequestCount = ISNULL(@AssignedDispatchRequestCount,0),\t\t\t\t\r\n\t--\t@ReturnedRequestCount = ISNULL(@ReturnedRequestCount,0),\t\t\t\t\t\r\n\t--\t@delayedDeliveryRequestCount = ISNULL(@delayedDeliveryRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@UnassignedReturnAndReplacementRequestCount = ISNULL(@UnassignedReturnAndReplacementRequestCount,0),\t\r\n\t--\t@NotPickupRequestCount = ISNULL(@NotPickupRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@DelayedPickupCount = ISNULL(@DelayedPickupCount,0)\t\t\r\n\r\n\t\t; WITH CTE_DR AS\r\n(\r\n\tSELECT \r\n\t\tddr.Id,\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tddr.DeliveryStartTime,--CAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\tddr.CourierRequestTypeId ,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\t\r\n\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON DP.ID = pID.Id\r\n\tINNER JOIN #CityID cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId = @OperationStaffId_Local\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n    AND ddr.DeliveryStartTime \u003E= @From AND ddr.DeliveryDeadLineTime \u003C= @TO\r\n\tAND ddr.DispatchRequestStatusId in (5,6) AND CAST(DeliveryStartTime/1000000000 AS BIGINT)IN(@Now,@Yesterday)\r\n\tUNION ALL\r\n\tSELECT \r\n\t\tddr.Id,\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tddr.DeliveryStartTime,--CAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\tddr.CourierRequestTypeId ,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\t\r\n\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON DP.ID = pID.Id\r\n\tINNER JOIN #CityID cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId = @OperationStaffId_Local\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n    AND ddr.DeliveryStartTime \u003E= @From AND ddr.DeliveryDeadLineTime \u003C= @TO\r\n\tAND (ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70))\r\n\tUNION ALL\r\n\tSELECT \r\n\t\tddr.Id,\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tddr.DeliveryStartTime,--CAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\tddr.CourierRequestTypeId ,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\t\r\n\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON DP.ID = pID.Id\r\n\tINNER JOIN #CityID cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId = @OperationStaffId_Local\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n    AND ddr.DeliveryStartTime \u003E= @From AND ddr.DeliveryDeadLineTime \u003C= @TO\r\n\tAND (ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51))\r\n\tUNION ALL\r\n\tSELECT \r\n\t\tddr.Id,\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tddr.DeliveryStartTime,--CAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\tddr.CourierRequestTypeId ,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\t\r\n\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON DP.ID = pID.Id\r\n\tINNER JOIN #CityID cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId = @OperationStaffId_Local\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n    AND ddr.DeliveryStartTime \u003E= @From AND ddr.DeliveryDeadLineTime \u003C= @TO\r\n\tAND ( (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) )\r\n)\r\nSELECT \r\n\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount),\r\n\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\nFROM\r\n(\r\n\tSELECT \r\n\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND CAST(ddr.DeliveryStartTime/1000000000 AS BIGINT) IN(@Now,@Yesterday) THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\tCASE WHEN sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\tCASE WHEN \r\n\t\t\tsdp.OperationTypeId = (10)  \r\n\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount,\r\n\t\tCASE \r\n\t\t\tWHEN \r\n\t\t\t\tIsWaitingForSupport = 1 \r\n\t\t\t\tAND DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\tTHEN ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS NotPickupRequestCount\r\n\tFROM CTE_DR ddr\r\n\tLEFT JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id = sdpdr.DispatchRequestId\r\n\tLEFT JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tLEFT JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id = sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n) SQ\r\n\r\n\r\n\t--;WITH CTE_DR AS\r\n\t--(\r\n\t--SELECT\t\r\n\t--\tddr.DispatchRequestStatusId,\r\n\t--\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t--\tddr.CourierRequestTypeId ,\r\n\t--\tddr.ParcelReferenceCode,\r\n\t--\tsdp.OperationTypeId,\r\n\t--\tddr.IsWaitingForSupport\r\n\t--FROM DP.DispatchRequest(NOLOCK) ddr\r\n\t--INNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t--INNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t--INNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t--LEFT JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t--\tON ddr.id=sdpdr.DispatchRequestId\r\n\t--LEFT JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t--\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t--\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t--\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\t--LEFT JOIN dP.Shipment(NOLOCK) ds\r\n\t--\tON ds.Id=sdp.ShipmentId\r\n\t--\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\t--INNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t--INNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t--INNER JOIN #DeliveryServiceProviderId dspID\r\n\t--\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\t--INNER JOIN #CourierRequestTypeID crtID\r\n\t--\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t--INNER JOIN #PolygonId pID\r\n\t--\tON DP.ID = pID.Id\r\n\t--INNER JOIN #CityID cID\r\n\t--\tON dp.CityId = cID.Id\r\n\t--WHERE pos.OperationStaffId=@OperationStaffId_Local\t\t\r\n\t--AND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\t--AND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\t--AND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\t--AND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\r\n\t--AND\r\n\t--(\r\n\t--\t(ddr.DispatchRequestStatusId in (5,6) AND CAST(DeliveryStartTime/1000000000 AS BIGINT)IN(@Now,@Yesterday))\r\n\t--\tOR\r\n\t--\t(ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70))\r\n\t--\tOR\r\n\t--\t(ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51))\r\n\t--\tOR\r\n\t--\t( (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) )\r\n\t--\tOR\r\n\t--\t(  sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) )\r\n\t--\tOR\r\n\t--\t( sdp.OperationTypeId = (10) AND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) )\r\n\t--)\r\n\t--)\r\n\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t--\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t--\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t--\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t--\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t--\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount),\r\n\t--\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\t--FROM\r\n\t--(\r\n\t--\tSELECT \r\n\t--\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date IN(@Now,@Yesterday) THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t--\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t--\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t--\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t--\t\tCASE WHEN ddr.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t--\t\tCASE WHEN \r\n\t--\t\t\tddr.OperationTypeId = (10)  \r\n\t--\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t--\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount,\r\n\t--\t\tCASE \r\n\t--\t\t\tWHEN \r\n\t--\t\t\t\tIsWaitingForSupport = 1 \r\n\t--\t\t\t\tAND DispatchRequestStatusId IN ( 15,16 ) \r\n\t--\t\t\tTHEN ParcelReferenceCode\r\n\t--\t\t\tELSE NULL \r\n\t--\t\tEND AS NotPickupRequestCount\r\n\t--\tFROM CTE_DR ddr\r\n\t--) SQ\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t\r\n\t/*\r\n\tRETURN\r\n\t; WITH CTE_AllDispatchRequests AS\r\n\t(\r\n\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t/*LEFT(DeliveryStartTime,8)*/ CAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\t\t--/*LEFT(DeliveryDeadLineTime,8) */CAST(DeliveryDeadLineTime/1000000000 AS BIGINT) DeliveryDeadLineTime,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode\r\n\t--INTO #AllDispatchRequests\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t--INNER JOIN #Polygon p\tON dp.ID = p.Id\r\n\t--INNER JOIN #CityID c\tON dp.cityID = c.CityID\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\tAND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t--option(maxdop 1);\r\n\t--OPTION(RECOMPILE)\r\n\t),CTE_A AS\r\n\t(\r\n\t\tSELECT sdpdr.ShipmentDestinationPointId,DDR.DispatchRequestId\t\r\n\t\tFROM CTE_AllDispatchRequests ddr\r\n\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\t\tON ddr.DispatchRequestId=sdpdr.DispatchRequestId\r\n\t),CTE_B AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tsdp.Id AS ShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\tsdp.OperationTypeId, \r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdpdr.DispatchRequestId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime\r\n\t\tFROM CTE_A sdpdr\r\n\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\t),CTE_Shipment AS\r\n\t(\r\n\r\n\t\tSELECT \r\n\t\t\tsdp.*,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\t--dss.Id\t\tShipmentStatusId,\r\n\t\t\t--dss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId \r\n\t\tFROM CTE_B  sdp\r\n\t\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t--\tON dss.Id=ds.ShipmentStatusId\r\n\t), CTE_AllShipmentDestinationPoint AS\r\n\t(\r\n\t\tSELECT\tds.ShipmentDestinationPointId,\r\n\t\t\tds.ShipmentDestinationPointStatusId,\r\n\t\t\tds.OperationTypeId,\r\n\t\t\tds.DispatchRequestId,\r\n\t\t\tds.ShipmentId,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tds.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter\r\n\t\t\t\r\n\t\t--INTO #AllShipmentDestinationPoint\r\n\t\tFROM CTE_Shipment ds\r\n\t\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t\tWHERE dss.Id NOT IN ( 45,50,55,100 )\r\n\t)\r\n\r\n\tSELECT \r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date=@Now THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\t\tCASE WHEN sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\t\tCASE WHEN \r\n\t\t\t\tsdp.OperationTypeId = (10)  \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount\r\n\t\tFROM CTE_AllDispatchRequests ddr\r\n\t\tLEFT JOIN CTE_AllShipmentDestinationPoint sdp ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t\t--WHERE ddr.DispatchRequestStatusId IN ( 5,6,10,11,15,16,20,25,45,46,50,51)\r\n\t\t--OR (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25)\r\n\t) SQ\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\tRETURN\r\n\t*/\r\n\t/***************************************************/\r\n\tDECLARE @OperationWarningRangeTime_Second INT=DATEDIFF (SECOND,0,@OperationWarningRangeTime)\r\n\r\n\t--SELECT\t\r\n\t--\t\tddr.DispatchRequestStatusId,\r\n\t--\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t--\t\tddr.CourierRequestTypeId ,\r\n\t--\t\tddr.ParcelReferenceCode,\r\n\t--\t\t sdp.OperationTypeId,\r\n\t--\t\tddr.Id DispatchRequestId,\r\n\t--\t\tddr.PolygonStoreId,\r\n\t--\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t--\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t--\t\tps.StoreId,\r\n\t--\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t--\t\tdp.CityId,\r\n\t--\t\tddr.VendorParcelCode,\r\n\t--\t\tsdp.ShipmentId,\r\n\t--\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t--\t\tsdp.EstimatedArrivalTime,\r\n\t--\t\tsdp.ID  AS ShipmentDestinationPointId,\r\n\t--\t\tsdp.ShipmentDestinationPointStatusId ,\r\n\t--\t\tsdp.SequenceNumber,\r\n\t--\t\tddr.DeliveryServiceProviderId,\r\n\t--\t\tddr.VendorId,\r\n\t--\t\tv.BrandName AS VendorBrandName\r\n\t--INTO #CTE_DR\r\n\t--FROM DP.DispatchRequest(NOLOCK) ddr\r\n\t--INNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t--INNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t--INNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t--\tON ddr.id=sdpdr.DispatchRequestId\r\n\t--INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t--\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t--\t--AND sdp.OperationTypeId IN ( 5,10 )\r\n\t--\t--AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\t--INNER JOIN dP.Shipment(NOLOCK) ds\r\n\t--\tON ds.Id=sdp.ShipmentId\r\n\t--\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\t--INNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t--\tON pos.PolygonId = dp.Id \r\n\t--\tAND pos.IsActive = 1\r\n\t--INNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t--\tON ps.StoreId = s.Id\r\n\t--INNER JOIN #DeliveryServiceProviderId dspID\r\n\t--\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\t--INNER JOIN #CourierRequestTypeID crtID\r\n\t--\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t--\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t--\t\tON ddr.VendorId = v.Id\r\n\t--INNER JOIN #PolygonId pID\r\n\t--\tON DP.ID = pID.Id\r\n\t--INNER JOIN #CityID cID\r\n\t--\tON dp.CityId = cID.Id\r\n\t--WHERE pos.OperationStaffId=@OperationStaffId_Local\t\t\r\n\t--AND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\t--AND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\t--AND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\t--AND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t----AND ddr.DeliveryServiceProviderId = @DeliveryServiceProviderId_Local OR ISNULL(@DeliveryServiceProviderId_Local,0) = 0\r\n\t--OPTION(MAXDOP 16,USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\t--CREATE INDEX IX_#CTE_DR ON #CTE_DR\r\n\t--(\r\n\t--\tShipmentId,\r\n\t--\tDispatchRequestId,\r\n\t--\tStoreId,\r\n\t--\t[OperationTypeId],\r\n\t--\t[ShipmentDestinationPointStatusId]\r\n\t--)INCLUDE ([DispatchRequestStatusId],[DeliveryStartTime_Date],[CourierRequestTypeId],[ParcelReferenceCode],[PolygonStoreId],[PolygonId],[PolygonTitle],[StoreTitle],[CityId],[VendorParcelCode],[EstimatedOperationTimeSeconds],[EstimatedArrivalTime],[ShipmentDestinationPointId],[SequenceNumber],[DeliveryServiceProviderId],[VendorId],[VendorBrandName])\r\n\r\n\r\n\t\t--SELECT DISTINCT\r\n\t\t--\tsdp.*,\r\n\t\t--\tds.ShipmentNumber,\r\n\t\t--\tds.TotalEstimatedDurationSeconds,\r\n\t\t--\tds.TotalDistanceMeter,\r\n\t\t--\tds.ShipmentStatusId,\r\n\t\t--\t--dss.Id\t\tShipmentStatusId,\r\n\t\t--\t--dss.Title\tShipmentStatusTitle,\r\n\t\t--\tds.FleetId \r\n\t\t--INTO #CTE_Shipment\r\n\t\t--FROM #CTE_DR  sdp\r\n\t\t--INNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\t--\tON ds.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN #ShipmentStatusId ssid\r\n\t\t--\tON ds.ShipmentStatusId = ssid.Id\r\n\t\t--AND ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\t\t--AND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\t\t--AND sdp.OperationTypeId IN (5,10/*Delivery*/,15,20,25,30)\r\n\r\n\tSELECT\tDISTINCT\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\t\tddr.CourierRequestTypeId ,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t sdp.OperationTypeId,\r\n\t\t\tddr.Id DispatchRequestId,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\tsdp.ID  AS ShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId ,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\tddr.VendorId,\r\n\t\t\tv.BrandName AS VendorBrandName,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\t--dss.Id\t\tShipmentStatusId,\r\n\t\t\t--dss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId ,\r\n\t\t\tds.FleetShiftId\r\n\tINTO #CTE_Shipment\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\t\tAND sdpdr.Version = ddr.Version\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t--AND sdp.OperationTypeId IN ( 5,10 )\r\n\t\t--AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tAND ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\t\tAND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35 ) \r\n\t\tAND sdp.OperationTypeId IN (5,10/*Delivery*/,15,20,25,30)\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\tON ddr.VendorId = v.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON dp.ID = pID.Id\r\n\tINNER JOIN #CityID cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n    AND ddr.DeliveryStartTime \u003E= @From AND ddr.DeliveryDeadLineTime \u003C= @TO\r\n\t--AND ddr.DeliveryServiceProviderId = @DeliveryServiceProviderId_Local OR ISNULL(@DeliveryServiceProviderId_Local,0) = 0\r\n\tOPTION(MAXDOP 16,USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\r\n\t;WITH CTE_AllShipmentDestinationPoint AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tds.ShipmentDestinationPointId,\r\n\t\t\tds.ShipmentDestinationPointStatusId,\r\n\t\t\tds.OperationTypeId,\r\n\t\t\tds.DispatchRequestId,\r\n\t\t\tds.ShipmentId,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tds.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tDATEADD(SECOND,ds.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(ds.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))EstimatedArrivalTime\r\n\t\t--INTO #AllShipmentDestinationPoint\r\n\t\tFROM #CTE_Shipment ds\r\n\t\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t\tWHERE dss.Id NOT IN ( 45,50,55,100 )\r\n\t), CTE_PickupStatus AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdpi.ShipmentId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN ShipmentStatusId = 25 THEN 2\r\n\t\t\t\tWHEN ShipmentStatusId = 30 THEN 4\r\n\t\t\t\tWHEN ShipmentStatusId IN (35,40) \r\n\t\t\t\tTHEN\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN HasDP = 1\r\n\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\tWHEN HasDP = 0 \r\n\t\t\t\t\t\tTHEN 2\r\n\t\t\t\t\tEND\r\n\t\t\t\t\t\t\r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) AND sdpi.SequenceNumber = sdpi.FS THEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\r\n\t\t\tELSE 5 END PickupStatus\t\t\t\t\t\r\n\t\tFROM \r\n\t\t(\r\n\t\t\tSELECT * FROM \r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tShipmentId , \r\n\t\t\t\t\tShipmentStatusId, \r\n\t\t\t\t\tOperationTypeId , \r\n\t\t\t\t\tShipmentDestinationPointStatusId , \r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tFIRST_VALUE(SQ.FS) OVER (PARTITION BY SQ.ShipmentId ORDER BY SQ.FS DESC) FS ,\r\n\t\t\t\t\tFIRST_VALUE(SQ.HasDP) OVER (PARTITION BY SQ.ShipmentId ORDER BY SQ.HasDP DESC) HasDP ,\r\n\t\t\t\t\tEstimatedArrivalTime\r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tDISTINCT CASE WHEN ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) THEN \r\n\t\t\t\t\t\t\tsdpi.SequenceNumber \r\n\t\t\t\t\t\tELSE 0 END FS,\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN ShipmentStatusId IN ( 35,40 ) AND OperationTypeId IN ( 5,20 ) AND ShipmentDestinationPointStatusId = 25 THEN 1 \r\n\t\t\t\t\t\t\tELSE 0 \r\n\t\t\t\t\t\tEND HasDP,\r\n\t\t\t\t\t\t* \r\n\t\t\t\t\tFROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\t\t\t) SQ\r\n\t\t\t) sdpi\r\n\t\t\tWHERE \r\n\t\t\t\tsdpi.ShipmentStatusId = 25\r\n\t\t\t\tOR ShipmentStatusId = 30\r\n\t\t\t\tOR ShipmentStatusId IN (35,40)\r\n\t\t\t\tOR (ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) AND sdpi.SequenceNumber = sdpi.FS)\r\n\t\t) sdpi\r\n\t), CTE_Delivery AS\r\n\t(\r\n\t\t\tSELECT DISTINCT \r\n\t\t\tsdpi.ShipmentId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) THEN 1\r\n\t\t\t\tWHEN ShipmentStatusId=35 THEN 4\r\n\t\t\t\tWHEN ShipmentStatusId IN (25,30,40) AND sdpi.SequenceNumber = sdpi.FS THEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\t\t\tEND DeliveryStatus\r\n\t\t\t\t\r\n\t\tFROM \r\n\t\t(\r\n\t\t\t\r\n\t\t\tSELECT * FROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tShipmentId , \r\n\t\t\t\t\tShipmentStatusId, \r\n\t\t\t\t\tOperationTypeId , \r\n\t\t\t\t\tShipmentDestinationPointStatusId , \r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\t\tFIRST_VALUE(sdpi.FS) OVER (PARTITION BY sdpi.ShipmentId ORDER BY sdpi.FS DESC) FS \r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT CASE WHEN ShipmentStatusId IN (25,30,40) THEN sdpi.SequenceNumber  ELSE 0 END FS, * FROM CTE_AllShipmentDestinationPoint sdpi WHERE sdpi.ShipmentDestinationPointStatusId \u003C\u003E 40\r\n\t\t\t\t) sdpi\r\n\t\t\t) SDPI\r\n\t\t\tWHERE \r\n\t\t\t\tsdpi.ShipmentStatusId IN (5,6,10,15,20)\r\n\t\t\t\tOR ShipmentStatusId=35\r\n\t\t\t\tOR (ShipmentStatusId IN (25,30,40) AND sdpi.SequenceNumber = sdpi.FS)\r\n\t\t\t) sdpi\r\n\t\t--ORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t), CTE_Estimated AS\r\n\t(\r\n\t\r\n\t\tSELECT TOP 1 WITH TIES  sdpi.ShipmentId,sdpi.EstimatedArrivalTime EstimatedEndDateTimeStr\r\n\t\tFROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\tWHERE sdpi.ShipmentDestinationPointStatusId NOT IN (30/*Aborted*/)\r\n\t\t--AND ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\tORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t), CTE_TotalCount AS\r\n\t(\r\n\r\n\t\tSELECT sh.Id shipmentId,\r\n\t\t\tcount(distinct ShipmentDestinationPointId)DispatchRequestCount\t\r\n\t\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\t\t--INNER JOIN CTE_DR ddr ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t\tINNER JOIN dp.Shipment sh\twith(nolock)\t\tON sh.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN dp.PolygonFleet(NOLOCK) dpf\t\t\t\t\t\t\t\tON dpf.PolygonId=ddr.PolygonId  AND dpf.IsActive=1\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sh.FleetId AND df.IsActive=1\r\n\t\tINNER JOIN #ShipmentStatusId ssid\r\n\t\t\tON sh.ShipmentStatusId = ssid.Id\r\n\t\tWHERE sh.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\t\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t\tAND ((df.Id\t\t =@FleetId\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\t\t--AND ((sh.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\t\tGROUP BY sh.Id\r\n\t), CTE_IsReturnToStoreRequired AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tShipmentId,\r\n\t\t\tCAST(IsReturnToStoreRequired AS BIT ) IsReturnToStoreRequired\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tSQ.ShipmentId,\r\n\t\t\t\tFIRST_VALUE(IsReturnToStoreRequired) OVER ( PARTITION BY SQ.ShipmentId ORDER BY IsReturnToStoreRequired DESC ) IsReturnToStoreRequired,\r\n\t\t\t\tFIRST_VALUE(HasDelivery) OVER ( PARTITION BY SQ.ShipmentId ORDER BY HasDelivery DESC) HasDelivery\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tsdp.ShipmentId,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId = 30 AND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35,40 ) AND sdpdr.DispatchRequestId IS NULL THEN 1 ELSE 0 END IsReturnToStoreRequired,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId \u003C\u003E 30 AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ) THEN 1 ELSE 0 END HasDelivery\r\n\t\t\t\tFROM #CTE_Shipment s\r\n\t\t\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\t\tON s.ShipmentId = sdp.ShipmentId\r\n\t\t\t\tLEFT JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\t\t\tWHERE sdp.OperationTypeId = 30\r\n\t\t\t\tOR (sdp.OperationTypeId \u003C\u003E 30 AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ))\r\n\t\t\t) SQ\r\n\t\t) SQ\r\n\t\tWHERE SQ.HasDelivery = 0\r\n\t)\r\n\r\n\tSELECT * INTO #Output FROM \r\n\t(\r\n\tSELECT DISTINCT\r\n\t\t\tsdp.ShipmentId\t\t\t\t\t\t\tId,\r\n\t\t\tsdp.ShipmentStatusId\t\t\t\t\tStatusId,\r\n\t\t\tsdp.ShipmentStatusTitle\t\t\t\t\tStatusTitle,\r\n\t\t\tsdp.ShipmentNumber,\r\n\t\t\tsdp.TotalEstimatedDurationSeconds,\r\n\t\t\tsdp.TotalDistanceMeter,\r\n\t\t\tddr.CityId\t\t\t\t\t\t\t\tCityId,\r\n\t\t\tddr.PolygonId\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tddr.polygonTitle\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tddr.StoreId\t\t\t\t\t\t\t\tStoreId,\r\n\t\t\ts.Location.STY  AS  StoreLocationLat,\r\n\t\t\ts.Location.STX  AS\tStoreLocationLong,\r\n\t\t\tddr.StoreTitle\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\t--sdp.ShipmentStatusId,\r\n\t\t\tPickupStatus.PickupStatus,\r\n\t\t\tDeliveryStatus.DeliveryStatus,\r\n\t\t\tISNULL(CASE \r\n\t\t\t\tWHEN sdp.ShipmentStatusId IN (5,6,10,15,20)\tTHEN PickupStatus\r\n\t\t\t\tWHEN sdp.ShipmentStatusId IN (25,30,35,40)\tTHEN DeliveryStatus\r\n\t\t\t\tELSE 0\r\n\t\t\tEND,0) OperationStatus,\r\n\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\tISNULL(tc.DispatchRequestCount,0) DispatchRequestCount, --(SELECT DispatchRequestCount FROM CTE_TotalCount t where shipmentId=t.shipmentId)\tDispatchRequestCount,\r\n\t\t\tdf.Id\t\t\t\t\t\t\t\t\tFleetId,\r\n\t\t\td.Id\t\t\t\t\t\t\t\t\tDriverId,\r\n\t\t\tCONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\tDriverName,\r\n\t\t\tCONCAT(\u00270\u0027,d.Mobile)\t\t\t\t\tDriverMobile,\r\n\t\t\tdv.VehicleTypeId,\r\n\t\t\tdv.PlateNumber,\r\n\t\t\tISNULL(rtsr.IsReturnToStoreRequired,0) IsReturnToStoreRequired,\r\n\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\ts.orderCategoryId,\r\n\t\t\toc.Title AS orderCategoryTitle,\r\n\t\t\tddr.FleetShiftId\r\n\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #CTE_Shipment  ddr\t\t\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tJOIN DP.Store AS s with(nolock) ON s.Id = ddr.StoreId\r\n\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tON s.OrderCategoryId = oc.Id\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sdp.FleetId\t--\tAND df.IsActive=1\r\n\tINNER JOIN CS_DriverManagement.DM.vehicle(NOLOCK) dv\t\t\t\t\t\t\t\t\tON dv.Id=df.VehicleId\r\n\tINNER JOIN CS_DriverManagement.DM.Driver(NOLOCK) AS d\t\t\t\t\t\t\t\t\tON d.id = df.DriverId\r\n\tLEFT JOIN CTE_PickupStatus PickupStatus ON PickupStatus.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_Delivery DeliveryStatus ON DeliveryStatus.ShipmentId=sdp.ShipmentId\r\n\tINNER JOIN CTE_Estimated EstimatedEndDateTimeStr ON EstimatedEndDateTimeStr.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_TotalCount tc ON  sdp.ShipmentId = tc.shipmentId\r\n\tLEFT JOIN CTE_IsReturnToStoreRequired rtsr\r\n\t\tON sdp.ShipmentId = rtsr.ShipmentId\r\n\tWHERE (ddr.DispatchRequestStatusId IN (10/*Assigned To Courier*/,11/*Reassigned*/,15/*Arrived at Pickup point*/,\r\n\t\t\t\t\t\t\t\t\t\t 16/*SecondFleetArrivedAtPickupPoint*/,20/*Picked up*/,25/*Arrived at Delivery Point*/,\r\n\t\t\t\t\t\t\t\t\t\t 45/*Cancel Response Pending*/,46/*Second Cancel Request Pending*/,47,48,49,52,53,54,50/*Cancel Request Rejected*/,\r\n\t\t\t\t\t\t\t\t\t\t 51/*Second Cancel Request Rejected*/)  OR rtsr.IsReturnToStoreRequired IS NOT NULL )\r\n\tAND sdp.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t--AND((ddr.CityId IN (SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds,\u00270\u0027)=\u00270\u0027))\t\t\r\n\tAND ((df.Id\t\t =@FleetId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\tAND ((ddr.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\t--AND (ddr.PolygonId IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\t--AND ((sdp.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds,\u0027\u0027)=\u0027\u0027))\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027), Recompile)\r\n\t--OPTION(MAXDOP 1)\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t--OPTION(Recompile)\r\n\t\r\n\t) SQ\r\n\r\n\tSET @TotalCount = @@ROWCOUNT\r\n\r\n\r\n\tSELECT * FROM #Output\r\n\r\n\tORDER BY \r\n\t\tCASE WHEN @OrderBy_Local IS NOT NULL AND @OrderBy_Local \u003C\u003E \u0027\u0027 AND @OrderBy_Local \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\u002B  @OrderByReplace \r\n\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\tEND,\r\n\t\tOperationStatus DESC,\r\n\t\tEstimatedEndDateTimeStr ASC\r\n\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n--\tOPTION (USE HINT (\u0027FORCE_LEGACY_CARDINALITY_ESTIMATION\u0027));\r\n--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\tSET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\nEND"},{"Name":"Get_ActiveShipments_By_Filter_Backup20231223","Schema":"dbo","Definition":"\r\n-- Stored Procedure\r\n\r\n/*\r\nDECLARE @DelayedDeliveryRequestCount\t\t\t\tINT=0,\r\n\t\t@DelayedPickupCount\t\t\t\t\t\t\tINT=0,\r\n\t\t@ReturnedRequestCount\t\t\t\t\t\tINT=0,\r\n\t\t@AssignedDispatchRequestCount\t\t\t\tINT=0,\r\n\t\t@UnassignedDispatchRequestCount\t\t\t\tINT=0,\r\n\t\t@UnassignedReturnAndReplacementRequestCount\tINT=0\r\n\r\nEXEC [Get_ActiveShipments_By_Filter] \r\n\t\t@OperationStaffId\t\t\t\t\t\t\t=53,\r\n\t\t@OperationWarningRangeTime\t\t\t\t\t=\u002700:01:00\u0027,\r\n\t\t@MinimumDeliveryTime\t\t\t\t\t\t=\u002700:19:00\u0027,\t\t\t\t\t\t\r\n\r\n\t\t@DelayedDeliveryRequestCount\t\t\t\t=@DelayedDeliveryRequestCount\t\t\t\tOUTPUT,\r\n\t\t@DelayedPickupCount\t\t\t\t\t\t\t=@DelayedPickupCount\t\t\t\t\t\tOUTPUT,\r\n\t\t@ReturnedRequestCount\t\t\t\t\t\t=@ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t\t@AssignedDispatchRequestCount\t\t\t\t=@AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t\t@UnassignedDispatchRequestCount\t\t\t\t=@UnassignedDispatchRequestCount\t\t\tOUTPUT,\r\n\t\t@UnassignedReturnAndReplacementRequestCount=@UnassignedReturnAndReplacementRequestCount OUTPUT\r\n\r\nSELECT \r\n\t\t@DelayedDeliveryRequestCount as DelayedDeliveryRequestCount, \r\n\t\t@DelayedPickupCount as DelayedPickupCount,\r\n\t\t@ReturnedRequestCount as ReturnedRequestCount,\r\n\t\t@AssignedDispatchRequestCount as AssignedDispatchRequestCount,\r\n\t\t@UnassignedDispatchRequestCount as UnassignedDispatchRequestCount,\r\n\t\t@UnassignedReturnAndReplacementRequestCount as UnassignedReturnAndReplacementRequestCount\r\n*/\r\nCREATE            PROC [dbo].[Get_ActiveShipments_By_Filter_Backup20231223]\r\n\r\n\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL ,\r\n\t@PolygonIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL,\r\n\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t\t=NULL ,\r\n\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t=NULL ,\r\n\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),---\r\n\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t\t=NULL,\r\n\t@VendorID\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL,\r\n\t@CourierRequestTypeIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL,\r\n\t@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX) = NULL,\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,   \r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0 OUTPUT\r\n--WITH RECOMPILE\r\nAS\r\nSET NOCOUNT ON\r\n--SET STATISTICS TIME ON\r\n\r\n\r\n--PRINT \u002700000\u0027\r\n--PRINT SYSDATETIME()\r\n\r\nDECLARE \r\n\t@OperationStaffId_Local\t\t\t\t\t\t\tINT ,\r\n\t@CityIds_Local\t\t\t\t\t\t\t\t\tVARCHAR(200)\t\t= NULL ,\r\n\t@PolygonIds_Local\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@FleetId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@StoreId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@ParcelReferenceCode_Local\t\t\t\t\t\tBIGINT\t\t\t\t= NULL ,\r\n\t@ShipmentStatusIds_Local\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@OperationWarningRangeTime_Local\t\t\t\tVARCHAR(10),\t\t  \r\n\t@MinimumDeliveryTime_Local\t\t\t\t\t\tVARCHAR(10),---\t\t  \r\n\t@VendorParcelCode_Local\t\t\t\t\t\t\tVARCHAR(32)\t\t\t= NULL ,\r\n\t@OrderBy_Local\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL ,\r\n\t@IsASC_Local\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL ,\r\n\t@VendorID_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@CourierRequestTypeIds_Local\t\t\t\t\tVARCHAR(MAX)\t\t= NULL\r\n\r\n\tSET @OperationStaffId_Local\t\t\t\t = @OperationStaffId\r\n\tSET @CityIds_Local\t\t\t\t\t\t = @CityIds\r\n\tSET @PolygonIds_Local\t\t\t\t\t = @PolygonIds\r\n\tSET @FleetId_Local\t\t\t\t\t\t = @FleetId\r\n\tSET @StoreId_Local\t\t\t\t\t\t = @StoreId\r\n\tSET @ParcelReferenceCode_Local\t\t\t = @ParcelReferenceCode\r\n\tSET @ShipmentStatusIds_Local\t\t\t = @ShipmentStatusIds\r\n\tSET @OperationWarningRangeTime_Local\t = @OperationWarningRangeTime\r\n\tSET @MinimumDeliveryTime_Local\t\t\t = @MinimumDeliveryTime\r\n\tSET @VendorParcelCode_Local\t\t\t\t = @VendorParcelCode\r\n\tSET @VendorID_Local\t\t\t\t\t\t = @VendorID\r\n\tSET @OrderBy_Local\t\t\t\t\t\t = @OrderBy\r\n\tSET @IsASC_Local\t\t\t\t\t\t = @IsASC\r\n\tSET @CourierRequestTypeIds_Local\t\t = @CourierRequestTypeIds\r\n\r\n\r\n\tSET @DeliveryServiceProviderIds = ISNULL(@DeliveryServiceProviderIds,\u00270\u0027)\r\n\tSET @CourierRequestTypeIds_Local = ISNULL(@CourierRequestTypeIds_Local,\u00270\u0027)\r\n\r\n\tDROP TABLE IF EXISTS #DeliveryServiceProviderId,#CourierRequestTypeID\r\n\r\n\tSELECT \r\n\t\tdsp.Id\r\n\tINTO #DeliveryServiceProviderId\r\n\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceProviderIds,\u0027,\u0027) ss\r\n\t\tON dsp.Id = ss.value\r\n\t\tOR @DeliveryServiceProviderIds = \u00270\u0027\r\n\r\n\tSELECT \r\n\t\tcrt.Id\r\n\tINTO #CourierRequestTypeID\r\n\tFROM CS_Public.PUB.CourierRequestType crt (NOLOCK)\r\n\tINNER JOIN string_split(@CourierRequestTypeIds_Local,\u0027,\u0027) ss\r\n\t\tON crt.Id = ss.value\r\n\t\tOR @CourierRequestTypeIds_Local = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t(\r\n\t\tId\r\n\t)\r\n\r\n\tdeclare @sql1 nvarchar(max),\r\n\t\t\t@sql2 nvarchar(max),\r\n\t\t\t@sql nvarchar(max)\r\n\r\n    DECLARE @StartRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u0027000\u0027\r\n                                            ) as BIGINT)),\r\n            @EndRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002723\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u0027999\u0027\r\n                                            ) as BIGINT))\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\tDECLARE @PolygonId\tTABLE \r\n\t(\r\n\t\tId\tSMALLINT\r\n\t)\r\n\tINSERT INTO @PolygonId\r\n\tSELECT value\r\n\tFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\r\n\r\n\t--DROP TABLE IF EXISTS #Polygon\r\n\t--SELECT p.ID INTO #Polygon \r\n\t--FROM dp.Polygon p\r\n\t--INNER JOIN string_split(ISNULL(@PolygonIds,\u0027\u0027),\u0027,\u0027) ss\r\n\t--\tON p.ID = ss.value\r\n\t--\tOR ISNULL(@PolygonIds,\u0027\u0027) = \u0027\u0027\r\n\r\n\t---\r\n\t--DECLARE @ShipmentStatusId\tTABLE \r\n\t--(\r\n\t--\tId\tTINYINT\r\n\t--)\r\n\t--INSERT INTO @ShipmentStatusId\r\n\t--SELECT value\r\n\t--FROM string_split(@ShipmentStatusIds,\u0027,\u0027)\r\n\tDROP TABLE IF EXISTS #ShipmentStatusId\r\n\tCREATE TABLE #ShipmentStatusId\t \r\n\t(\r\n\t\tId\tTINYINT\r\n\t)\r\n\tINSERT INTO #ShipmentStatusId\r\n\tSELECT shs.Id\r\n\tFROM DP.ShipmentStatus shs (NOLOCK)\r\n\tINNER JOIN string_split(ISNULL(@ShipmentStatusIds_Local,\u00270\u0027),\u0027,\u0027) ss\r\n\t\tON shs.Id = ss.value\r\n\t\tOR ISNULL(@ShipmentStatusIds_Local,\u00270\u0027) = \u00270\u0027\r\n\r\n\t--@CityIds\r\n\tDECLARE @CityId\tTABLE \r\n\t(\r\n\t\tId\tSMALLINT\r\n\t)\r\n\tINSERT INTO @CityId\r\n\tSELECT VALUE\r\n\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\t--DROP TABLE IF EXISTS #CityID\r\n\t--SELECT p.CityId INTO #CityID FROM DP.Polygon p\r\n\t--INNER JOIN string_split(ISNULL(@CityIds,\u00270\u0027),\u0027,\u0027) ss\r\n\t--\tON p.ID = ss.value\r\n\t--\tOR ISNULL(@CityIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\t--deliveryDeadlineTime\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-12,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-12, 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE @Today INT=  CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\tDROP TABLE IF EXISTS \r\n\t\t\t#Result,\r\n\t\t\t#Result1,\r\n\t\t\t#TotalCount,\r\n\t\t\t#AllDispatchRequests,\r\n\t\t\t#UnassignedDispatchRequestCount,\r\n\t\t\t#UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t#AllShipmentDestinationPoint,\r\n\t\t\t#Assigned_DispatchRequestCount,\r\n\t\t\t#DelayedPickupCount,\r\n\t\t\t#DelayedDeliveryCount,\r\n\t\t\t#ReturnedCount\r\n\r\n\tDECLARE @Now int=LEFT(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),8),\r\n\t\t@Yesterday int = LEFT(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),8)\r\n\r\n\t--SET @DelayedDeliveryRequestCount = NULL\r\n\t--SET @DelayedPickupCount = NULL\r\n\t--SET @ReturnedRequestCount = NULL\r\n\t--SET @AssignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedReturnAndReplacementRequestCount = NULL\r\n\t--SET @NotPickupRequestCount = NULL\r\n\r\n\t--EXEC Get_OperationPanel_Count\r\n\t--\t\t@OperationStaffId = @OperationStaffId_Local,\r\n\t--\t\t@CityIds = @CityIds_Local,\r\n\t--\t\t@PolygonIds = @PolygonIds_Local,\r\n\t--\t\t@VendorID = @VendorID_Local,\r\n\t--\t\t@UnassignedDispatchRequestCount\t\t\t\t = @UnassignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t\t@AssignedDispatchRequestCount\t\t\t\t = @AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t\t@ReturnedRequestCount\t\t\t\t\t\t = @ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t\t@DelayedDeliveryCount\t\t\t\t\t\t = @delayedDeliveryRequestCount\t\t\t\t\tOUTPUT,\r\n\t--\t\t@UnassignedReturnAndReplacementRequestCount  = @UnassignedReturnAndReplacementRequestCount\tOUTPUT,\r\n\t--\t\t@NotPickupRequestCount\t\t\t\t\t\t = @NotPickupRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t\t@DelayedPickupCount\t\t\t\t\t\t\t = @DelayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = ISNULL(@UnassignedDispatchRequestCount,0),\t\t\t\r\n\t--\t@AssignedDispatchRequestCount = ISNULL(@AssignedDispatchRequestCount,0),\t\t\t\t\r\n\t--\t@ReturnedRequestCount = ISNULL(@ReturnedRequestCount,0),\t\t\t\t\t\r\n\t--\t@delayedDeliveryRequestCount = ISNULL(@delayedDeliveryRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@UnassignedReturnAndReplacementRequestCount = ISNULL(@UnassignedReturnAndReplacementRequestCount,0),\t\r\n\t--\t@NotPickupRequestCount = ISNULL(@NotPickupRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@DelayedPickupCount = ISNULL(@DelayedPickupCount,0)\t\t\r\n\r\n\t;WITH CTE_DR AS\r\n\t(\r\n\tSELECT\t\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\tddr.CourierRequestTypeId ,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tsdp.OperationTypeId,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tLEFT JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tLEFT JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tLEFT JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\tAND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\r\n\tAND\r\n\t(\r\n\t\t(ddr.DispatchRequestStatusId in (5,6) AND CAST(DeliveryStartTime/1000000000 AS BIGINT)IN(@Now,@Yesterday))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51))\r\n\t\tOR\r\n\t\t( (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) )\r\n\t\tOR\r\n\t\t(  sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) )\r\n\t\tOR\r\n\t\t( sdp.OperationTypeId = (10) AND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) )\r\n\t)\r\n\t)\r\n\r\n\r\n\tSELECT \r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount),\r\n\t\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date IN(@Now,@Yesterday) THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\t\tCASE WHEN ddr.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\t\tCASE WHEN \r\n\t\t\t\tddr.OperationTypeId = (10)  \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t\tIsWaitingForSupport = 1 \r\n\t\t\t\t\tAND DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\t\tTHEN ParcelReferenceCode\r\n\t\t\t\tELSE NULL \r\n\t\t\tEND AS NotPickupRequestCount\r\n\t\tFROM CTE_DR ddr\r\n\t) SQ\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t\r\n\t/*\r\n\tRETURN\r\n\t; WITH CTE_AllDispatchRequests AS\r\n\t(\r\n\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t/*LEFT(DeliveryStartTime,8)*/ CAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\t\t--/*LEFT(DeliveryDeadLineTime,8) */CAST(DeliveryDeadLineTime/1000000000 AS BIGINT) DeliveryDeadLineTime,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode\r\n\t--INTO #AllDispatchRequests\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t--INNER JOIN #Polygon p\tON dp.ID = p.Id\r\n\t--INNER JOIN #CityID c\tON dp.cityID = c.CityID\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\tAND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t--option(maxdop 1);\r\n\t--OPTION(RECOMPILE)\r\n\t),CTE_A AS\r\n\t(\r\n\t\tSELECT sdpdr.ShipmentDestinationPointId,DDR.DispatchRequestId\t\r\n\t\tFROM CTE_AllDispatchRequests ddr\r\n\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\t\tON ddr.DispatchRequestId=sdpdr.DispatchRequestId\r\n\t),CTE_B AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tsdp.Id AS ShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\tsdp.OperationTypeId, \r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdpdr.DispatchRequestId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime\r\n\t\tFROM CTE_A sdpdr\r\n\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\t),CTE_Shipment AS\r\n\t(\r\n\r\n\t\tSELECT \r\n\t\t\tsdp.*,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\t--dss.Id\t\tShipmentStatusId,\r\n\t\t\t--dss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId \r\n\t\tFROM CTE_B  sdp\r\n\t\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t--\tON dss.Id=ds.ShipmentStatusId\r\n\t), CTE_AllShipmentDestinationPoint AS\r\n\t(\r\n\t\tSELECT\tds.ShipmentDestinationPointId,\r\n\t\t\tds.ShipmentDestinationPointStatusId,\r\n\t\t\tds.OperationTypeId,\r\n\t\t\tds.DispatchRequestId,\r\n\t\t\tds.ShipmentId,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tds.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter\r\n\t\t\t\r\n\t\t--INTO #AllShipmentDestinationPoint\r\n\t\tFROM CTE_Shipment ds\r\n\t\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t\tWHERE dss.Id NOT IN ( 45,50,55,100 )\r\n\t)\r\n\r\n\tSELECT \r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date=@Now THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\t\tCASE WHEN sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\t\tCASE WHEN \r\n\t\t\t\tsdp.OperationTypeId = (10)  \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount\r\n\t\tFROM CTE_AllDispatchRequests ddr\r\n\t\tLEFT JOIN CTE_AllShipmentDestinationPoint sdp ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t\t--WHERE ddr.DispatchRequestStatusId IN ( 5,6,10,11,15,16,20,25,45,46,50,51)\r\n\t\t--OR (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25)\r\n\t) SQ\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\tRETURN\r\n\t*/\r\n\t/***************************************************/\r\n\tDECLARE @OperationWarningRangeTime_Second INT=DATEDIFF (SECOND,0,@OperationWarningRangeTime)\r\n\r\n\tSELECT\t\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\t\tddr.CourierRequestTypeId ,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t sdp.OperationTypeId,\r\n\t\t\tddr.Id DispatchRequestId,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\tsdp.ID  AS ShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId ,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\tddr.VendorId,\r\n\t\t\tv.BrandName AS VendorBrandName\r\n\tINTO #CTE_DR\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t--AND sdp.OperationTypeId IN ( 5,10 )\r\n\t\t--AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\tON ddr.VendorId = v.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\tAND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t--AND ddr.DeliveryServiceProviderId = @DeliveryServiceProviderId_Local OR ISNULL(@DeliveryServiceProviderId_Local,0) = 0\r\n\r\n\tCREATE INDEX IX_#CTE_DR ON #CTE_DR\r\n\t(\r\n\t\tShipmentId,\r\n\t\tDispatchRequestId,\r\n\t\tStoreId\r\n\t)\r\n\r\n\t;WITH CTE_Shipment AS\r\n\t(\r\n\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdp.*,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\t--dss.Id\t\tShipmentStatusId,\r\n\t\t\t--dss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId \r\n\t\tFROM #CTE_DR  sdp\r\n\t\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\tINNER JOIN #ShipmentStatusId ssid\r\n\t\t\tON ds.ShipmentStatusId = ssid.Id\r\n\t\tAND ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\t\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\t\tAND sdp.OperationTypeId IN (5,10/*Delivery*/,15,20,25,30)\r\n\t), CTE_AllShipmentDestinationPoint AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tds.ShipmentDestinationPointId,\r\n\t\t\tds.ShipmentDestinationPointStatusId,\r\n\t\t\tds.OperationTypeId,\r\n\t\t\tds.DispatchRequestId,\r\n\t\t\tds.ShipmentId,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tds.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tDATEADD(SECOND,ds.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(ds.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))EstimatedArrivalTime\r\n\t\t--INTO #AllShipmentDestinationPoint\r\n\t\tFROM CTE_Shipment ds\r\n\t\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t\tWHERE dss.Id NOT IN ( 45,50,55,100 )\r\n\t), CTE_PickupStatus AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdpi.ShipmentId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN ShipmentStatusId = 25 THEN 2\r\n\t\t\t\tWHEN ShipmentStatusId = 30 THEN 4\r\n\t\t\t\tWHEN ShipmentStatusId IN (35,40) \r\n\t\t\t\tTHEN\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN HasDP = 1\r\n\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\tWHEN HasDP = 0 \r\n\t\t\t\t\t\tTHEN 2\r\n\t\t\t\t\tEND\r\n\t\t\t\t\t\t\r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) AND sdpi.SequenceNumber = sdpi.FS THEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\r\n\t\t\tELSE 5 END PickupStatus\t\t\t\t\t\r\n\t\tFROM \r\n\t\t(\r\n\t\t\tSELECT * FROM \r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tShipmentId , \r\n\t\t\t\t\tShipmentStatusId, \r\n\t\t\t\t\tOperationTypeId , \r\n\t\t\t\t\tShipmentDestinationPointStatusId , \r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tFIRST_VALUE(SQ.FS) OVER (PARTITION BY SQ.ShipmentId ORDER BY SQ.FS DESC) FS ,\r\n\t\t\t\t\tFIRST_VALUE(SQ.HasDP) OVER (PARTITION BY SQ.ShipmentId ORDER BY SQ.HasDP DESC) HasDP ,\r\n\t\t\t\t\tEstimatedArrivalTime\r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tDISTINCT CASE WHEN ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) THEN \r\n\t\t\t\t\t\t\tsdpi.SequenceNumber \r\n\t\t\t\t\t\tELSE 0 END FS,\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN ShipmentStatusId IN ( 35,40 ) AND OperationTypeId IN ( 5,20 ) AND ShipmentDestinationPointStatusId = 25 THEN 1 \r\n\t\t\t\t\t\t\tELSE 0 \r\n\t\t\t\t\t\tEND HasDP,\r\n\t\t\t\t\t\t* \r\n\t\t\t\t\tFROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\t\t\t) SQ\r\n\t\t\t) sdpi\r\n\t\t\tWHERE \r\n\t\t\t\tsdpi.ShipmentStatusId = 25\r\n\t\t\t\tOR ShipmentStatusId = 30\r\n\t\t\t\tOR ShipmentStatusId IN (35,40)\r\n\t\t\t\tOR (ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) AND sdpi.SequenceNumber = sdpi.FS)\r\n\t\t) sdpi\r\n\t), CTE_Delivery AS\r\n\t(\r\n\t\t\tSELECT DISTINCT \r\n\t\t\tsdpi.ShipmentId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) THEN 1\r\n\t\t\t\tWHEN ShipmentStatusId=35 THEN 4\r\n\t\t\t\tWHEN ShipmentStatusId IN (25,30,40) AND sdpi.SequenceNumber = sdpi.FS THEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\t\t\tEND DeliveryStatus\r\n\t\t\t\t\r\n\t\tFROM \r\n\t\t(\r\n\t\t\t\r\n\t\t\tSELECT * FROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tShipmentId , \r\n\t\t\t\t\tShipmentStatusId, \r\n\t\t\t\t\tOperationTypeId , \r\n\t\t\t\t\tShipmentDestinationPointStatusId , \r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\t\tFIRST_VALUE(sdpi.FS) OVER (PARTITION BY sdpi.ShipmentId ORDER BY sdpi.FS DESC) FS \r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT CASE WHEN ShipmentStatusId IN (25,30,40) THEN sdpi.SequenceNumber  ELSE 0 END FS, * FROM CTE_AllShipmentDestinationPoint sdpi WHERE sdpi.ShipmentDestinationPointStatusId \u003C\u003E 40\r\n\t\t\t\t) sdpi\r\n\t\t\t) SDPI\r\n\t\t\tWHERE \r\n\t\t\t\tsdpi.ShipmentStatusId IN (5,6,10,15,20)\r\n\t\t\t\tOR ShipmentStatusId=35\r\n\t\t\t\tOR (ShipmentStatusId IN (25,30,40) AND sdpi.SequenceNumber = sdpi.FS)\r\n\t\t\t) sdpi\r\n\t\t--ORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t), CTE_Estimated AS\r\n\t(\r\n\t\r\n\t\tSELECT TOP 1 WITH TIES  sdpi.ShipmentId,sdpi.EstimatedArrivalTime EstimatedEndDateTimeStr\r\n\t\tFROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\tWHERE sdpi.ShipmentDestinationPointStatusId NOT IN (30/*Aborted*/)\r\n\t\t--AND ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\tORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t), CTE_TotalCount AS\r\n\t(\r\n\r\n\t\tSELECT sh.Id shipmentId,\r\n\t\t\tcount(distinct ShipmentDestinationPointId)DispatchRequestCount\t\r\n\t\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\t\t--INNER JOIN CTE_DR ddr ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t\tINNER JOIN dp.Shipment sh\twith(nolock)\t\tON sh.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN dp.PolygonFleet(NOLOCK) dpf\t\t\t\t\t\t\t\tON dpf.PolygonId=ddr.PolygonId  AND dpf.IsActive=1\r\n\t\tINNER JOIN dp.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sh.FleetId AND df.IsActive=1\r\n\t\tINNER JOIN #ShipmentStatusId ssid\r\n\t\t\tON sh.ShipmentStatusId = ssid.Id\r\n\t\tWHERE sh.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\t\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t\tAND ((df.Id\t\t =@FleetId\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\t\t--AND ((sh.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\t\tGROUP BY sh.Id\r\n\t), CTE_IsReturnToStoreRequired AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tShipmentId,\r\n\t\t\tCAST(IsReturnToStoreRequired AS BIT ) IsReturnToStoreRequired\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tSQ.ShipmentId,\r\n\t\t\t\tFIRST_VALUE(IsReturnToStoreRequired) OVER ( PARTITION BY SQ.ShipmentId ORDER BY IsReturnToStoreRequired DESC ) IsReturnToStoreRequired,\r\n\t\t\t\tFIRST_VALUE(HasDelivery) OVER ( PARTITION BY SQ.ShipmentId ORDER BY HasDelivery DESC) HasDelivery\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tsdp.ShipmentId,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId = 30 AND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35,40 ) AND sdpdr.DispatchRequestId IS NULL THEN 1 ELSE 0 END IsReturnToStoreRequired,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId \u003C\u003E 30 AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ) THEN 1 ELSE 0 END HasDelivery\r\n\t\t\t\tFROM CTE_Shipment s\r\n\t\t\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\t\tON s.ShipmentId = sdp.ShipmentId\r\n\t\t\t\tLEFT JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\t\t\tWHERE sdp.OperationTypeId = 30\r\n\t\t\t\tOR (sdp.OperationTypeId \u003C\u003E 30 AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ))\r\n\t\t\t) SQ\r\n\t\t) SQ\r\n\t\tWHERE SQ.HasDelivery = 0\r\n\t)\r\n\r\n\tSELECT * FROM \r\n\t(\r\n\tSELECT DISTINCT\r\n\t\t\tsdp.ShipmentId\t\t\t\t\t\t\tId,\r\n\t\t\tsdp.ShipmentStatusId\t\t\t\t\tStatusId,\r\n\t\t\tsdp.ShipmentStatusTitle\t\t\t\t\tStatusTitle,\r\n\t\t\tsdp.ShipmentNumber,\r\n\t\t\tsdp.TotalEstimatedDurationSeconds,\r\n\t\t\tsdp.TotalDistanceMeter,\r\n\t\t\tddr.CityId\t\t\t\t\t\t\t\tCityId,\r\n\t\t\tddr.PolygonId\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tddr.polygonTitle\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tddr.StoreId\t\t\t\t\t\t\t\tStoreId,\r\n\t\t\ts.Location.STY  AS  StoreLocationLat,\r\n\t\t\ts.Location.STX  AS\tStoreLocationLong,\r\n\t\t\tddr.StoreTitle\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\t--sdp.ShipmentStatusId,\r\n\t\t\tPickupStatus.PickupStatus,\r\n\t\t\tDeliveryStatus.DeliveryStatus,\r\n\t\t\tISNULL(CASE \r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20)\tTHEN PickupStatus\r\n\t\t\t\tWHEN ShipmentStatusId IN (25,30,35,40)\tTHEN DeliveryStatus\r\n\t\t\t\tELSE 0\r\n\t\t\tEND,0) OperationStatus,\r\n\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\tISNULL(tc.DispatchRequestCount,0) DispatchRequestCount, --(SELECT DispatchRequestCount FROM CTE_TotalCount t where shipmentId=t.shipmentId)\tDispatchRequestCount,\r\n\t\t\tdf.Id\t\t\t\t\t\t\t\t\tFleetId,\r\n\t\t\td.Id\t\t\t\t\t\t\t\t\tDriverId,\r\n\t\t\tCONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\tDriverName,\r\n\t\t\tCONCAT(\u00270\u0027,d.Mobile)\t\t\t\t\tDriverMobile,\r\n\t\t\tdv.VehicleTypeId,\r\n\t\t\tdv.PlateNumber,\r\n\t\t\tISNULL(rtsr.IsReturnToStoreRequired,0) IsReturnToStoreRequired,\r\n\t\t\tddr.DeliveryServiceProviderId\r\n\r\n\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #CTE_DR ddr\t\t\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tJOIN DP.Store AS s with(nolock) ON s.Id = ddr.StoreId\r\n\tINNER JOIN dp.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sdp.FleetId\t\tAND df.IsActive=1\r\n\tINNER JOIN dp.vehicle(NOLOCK) dv\t\t\t\t\t\t\t\t\tON dv.Id=df.VehicleId\r\n\tINNER JOIN DP.Driver(NOLOCK) AS d\t\t\t\t\t\t\t\t\tON d.id = df.DriverId\r\n\tLEFT JOIN CTE_PickupStatus PickupStatus ON PickupStatus.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_Delivery DeliveryStatus ON DeliveryStatus.ShipmentId=sdp.ShipmentId\r\n\tINNER JOIN CTE_Estimated EstimatedEndDateTimeStr ON EstimatedEndDateTimeStr.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_TotalCount tc ON  sdp.ShipmentId = tc.shipmentId\r\n\tLEFT JOIN CTE_IsReturnToStoreRequired rtsr\r\n\t\tON sdp.ShipmentId = rtsr.ShipmentId\r\n\tWHERE (ddr.DispatchRequestStatusId IN (10/*Assigned To Courier*/,11/*Reassigned*/,15/*Arrived at Pickup point*/,\r\n\t\t\t\t\t\t\t\t\t\t 16/*SecondFleetArrivedAtPickupPoint*/,20/*Picked up*/,25/*Arrived at Delivery Point*/,\r\n\t\t\t\t\t\t\t\t\t\t 45/*Cancel Response Pending*/,46/*Second Cancel Request Pending*/,47,48,49,52,53,54,50/*Cancel Request Rejected*/,\r\n\t\t\t\t\t\t\t\t\t\t 51/*Second Cancel Request Rejected*/)  OR rtsr.IsReturnToStoreRequired IS NOT NULL )\r\n\tAND sdp.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t--AND((ddr.CityId IN (SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds,\u00270\u0027)=\u00270\u0027))\t\t\r\n\tAND ((df.Id\t\t =@FleetId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\tAND ((ddr.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\t--AND (ddr.PolygonId IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\t--AND ((sdp.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds,\u0027\u0027)=\u0027\u0027))\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027), Recompile)\r\n\t--OPTION(MAXDOP 1)\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t--OPTION(Recompile)\r\n\t\r\n\t) SQ\r\n\tORDER BY \r\n\t\tCASE WHEN @OrderBy_Local IS NOT NULL AND @OrderBy_Local \u003C\u003E \u0027\u0027 AND @OrderBy_Local \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\u002B  @OrderByReplace \r\n\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\tEND,\r\n\t\tOperationStatus DESC,\r\n\t\tEstimatedEndDateTimeStr ASC\r\n--\tOPTION (USE HINT (\u0027FORCE_LEGACY_CARDINALITY_ESTIMATION\u0027));\r\nOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\tSET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\n\r\n\r\n\t/*\r\n\tDECLARE @OrderbyValue NVARCHAR(100)\r\n\tSET @sql = \u0027\r\n\tDROP TABLE IF EXISTS #t\r\n\tSELECT\r\n\t\t\t\t\tId,\r\n\t\t\t\t\tStatusId,\r\n\t\t\t\t\tStatusTitle,\r\n\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\tTotalEstimatedDurationSeconds,\r\n\t\t\t\t\tTotalDistanceMeter,\r\n\t\t\t\t\tCityId,\r\n\t\t\t\t\tPolygonId,\r\n\t\t\t\t\tPolygonTitle,\r\n\t\t\t\t\tStoreId,\r\n\t\t\t\t\tStoreLocationLat,\r\n\t\t\t\t\tStoreLocationLong,\r\n\t\t\t\t\tStoreTitle,\r\n\t\t\t\t\tISNULL(PickupStatus,0)\t\tPickupStatus,\r\n\t\t\t\t\tISNULL(DeliveryStatus,1)\tDeliveryStatus,\r\n\t\t\t\t\tOperationStatus,\r\n\t\t\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\t\t\tFleetId,\r\n\t\t\t\t\tDriverId,\r\n\t\t\t\t\tDriverName,\r\n\t\t\t\t\tDriverMobile,\r\n\t\t\t\t\tVehicleTypeId,\r\n\t\t\t\t\tPlateNumber\r\n\t\t\t\tInto #T\r\n\tFROM #Result r\r\n\t \r\n\r\n\t/*SELECT @Result=(\r\n\r\n\t\tSELECT\ttc.TotalCount count,\r\n\r\n\t\tJSON_QUERY((*/\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tId,\r\n\t\t\t\t\tStatusId,\r\n\t\t\t\t\tStatusTitle,\r\n\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\tTotalEstimatedDurationSeconds \tTotalEstimatedDurationSeconds,\r\n\t\t\t\t\tTotalDistanceMeter,\r\n\t\t\t\t\tCityId,\r\n\t\t\t\t\tPolygonId,\r\n\t\t\t\t\tPolygonTitle,\r\n\t\t\t\t\tStoreId,\r\n\t\t\t\t\tStoreLocationLat,\r\n\t\t\t\t\tStoreLocationLong,\r\n\t\t\t\t\tStoreTitle,\r\n\t\t\t\t\tISNULL(PickupStatus,0)\t\t\t\t\t\t\t\t\t\t\t\t\tPickupStatus,\r\n\t\t\t\t\tISNULL(DeliveryStatus,1) \t\t\t\t\t\t\t\t\t\t\t\tDeliveryStatus,\r\n\t\t\t\t\tOperationStatus,\r\n\t\t\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\t\t\t(SELECT DispatchRequestCount FROM #TotalCount t where Id=t.shipmentId)\tDispatchRequestCount,\r\n\t\t\t\t\tFleetId,\r\n\t\t\t\t\tDriverId,\r\n\t\t\t\t\tDriverName,\r\n\t\t\t\t\tDriverMobile,\r\n\t\t\t\t\tVehicleTypeId,\r\n\t\t\t\t\tPlateNumber\r\n\r\n\t\t\t\tFROM #T \r\n\t\t\t\tORDER BY \u0027 \u002B\r\n\t\t\t\t\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\t\t\t\u002B  @OrderByReplace \u002B \u0027 , \u0027\r\n\t\t\t\t\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\u002B \u0027 OperationStatus DESC,\r\n\t\t\t\t\t\tEstimatedEndDateTimeStr ASC\r\n\t\t\t\t\t\t   \r\n\r\n\t\t\t/*\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t\t))Shipments,\r\n\r\n\r\n\t\t--FROM #TotalCount AS tc\r\n\r\n\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n\t)\r\n\r\n\r\n\r\n\tset @Result = REPLACE(@Result,N\u0027\u0027\\\u0027\u0027,\u0027\u0027\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022Fleet\u0022:\u0022{\u0027\u0027,\u0027\u0027\u0022Fleet\u0022:{\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022}\u0022}\u0027\u0027,\u0027\u0027\u0022}}\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027}\u0022}]}\u0027\u0027,\u0027\u0027}}]}\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027}\u0022,\u0022StoreTitle\u0022:\u0027\u0027,\u0027\u0027},\u0022StoreTitle\u0022:\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022StoreLocation\u0022:\u0022{\u0027\u0027,\u0027\u0027\u0022StoreLocation\u0022:{\u0027\u0027)\r\n\r\n\r\n\tDECLARE @TotalCount INT \r\n\tSELECT @TotalCount = tc.TotalCount FROM #TotalCount AS tc\t\r\n\tIF @TotalCount=0 \r\n\tBEGIN \r\n\t\tSET @Result=NULL\r\n\t\tRETURN \r\n\tEND\r\n\t*/\r\n\r\n\t--DECLARE @DelayedDeliveryRequestCount\t\t\t\tINT=0\r\n\t--DECLARE @DelayedPickupCount\t\t\t\t\t\tINT=0\r\n\t--DECLARE @ReturnedRequestCount\t\t\t\t\t\tINT=0\r\n\t--DECLARE @Assigned_DispatchRequestCount\t\t\tINT=0\r\n\t--DECLARE @UnassignedDispatchRequestCount\t\t\tINT=0\r\n\r\n\t--SET  @DelayedDeliveryRequestCount\t\t\t\t\t= (SELECT DelayedDeliveryCount FROM #DelayedDeliveryCount)\t\t\t\t\t\t--DelayedDeliveryCount,\r\n\t--SET  @DelayedPickupCount\t\t\t\t\t\t\t= (SELECT DelayedPickupCount FROM #DelayedPickupCount)\t\t\t\t\t\t\t--DelayedPickupCount,\r\n\t--SET  @ReturnedRequestCount\t\t\t\t\t\t\t= (SELECT ReturnedCount FROM #ReturnedCount)\t\t\t\t\t\t\t\t\t\t--ReturnedCount,\r\n\t--SET  @AssignedDispatchRequestCount\t\t\t\t\t= (SELECT Assigned_DispatchRequestCount FROM #Assigned_DispatchRequestCount)\t\t--Assigned_DispatchRequestCount,\r\n\t--SET  @UnassignedDispatchRequestCount\t\t\t\t= (SELECT UnassignedDispatchRequestCount FROM #UnassignedDispatchRequestCount)\t--UnassignedDispatchRequestCount\r\n\t--SET  @UnassignedReturnAndReplacementRequestCount\t= (select UnassignedReturnAndReplacementRequestCount from #UnassignedReturnAndReplacementRequestCount)\r\n\r\n\t\u0027\r\n\r\n\t--PRINT \u0027YYY\u0027\r\n\t--PRINT SYSDATETIME()\r\n\t-- PRINT @sql\t\r\n\tDECLARE @Param NVARCHAR(4000) =\t\u0027\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t=NULL,\r\n\t\t\t\t\t\t\t\t\t\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10)           ,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t=NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)   =NULL,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t=NULL,\r\n\r\n\t\t\t\t\t\t\t\t\t\t@DelayedDeliveryRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@DelayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@ReturnedRequestCount\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@AssignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\tOUTPUT\r\n\t\t\t\t\t\t\t\t\t\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL @sql,@Param,\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t=@OperationStaffId,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t=@CityIds,\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t=@PolygonIds,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@FleetId\t\t\t\t\t\t\t=@FleetId,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t=@StoreId,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t=@ParcelReferenceCode,\t\t\r\n\t\t\t\t\t\t\t\t\t\t@ShipmentStatusIds\t\t\t\t\t=@ShipmentStatusIds,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t=@OperationWarningRangeTime,\t\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t=@VendorParcelCode,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t=@OrderBy,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t=@IsASC\t,\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\t\t\t@DelayedDeliveryRequestCount\t\t=@DelayedDeliveryRequestCount\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@DelayedPickupCount\t\t\t\t\t=@DelayedPickupCount\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@ReturnedRequestCount\t\t\t\t=@ReturnedRequestCount\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@AssignedDispatchRequestCount\t\t=@AssignedDispatchRequestCount\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedDispatchRequestCount\t\t=@UnassignedDispatchRequestCount\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount=@UnassignedReturnAndReplacementRequestCount output\t\t\t\r\n\r\n*/\r\n\r\n--PRINT \u0027ZZZ\u0027\r\n--PRINT SYSDATETIME()\r\n\r\n\r\n\r\n\r\n"},{"Name":"Get_ActiveShipments_By_Filter_HAMID","Schema":"dbo","Definition":"\r\n-- Stored Procedure\r\n\r\n/*\r\nDECLARE @DelayedDeliveryRequestCount\t\t\t\tINT=0,\r\n\t\t@DelayedPickupCount\t\t\t\t\t\t\tINT=0,\r\n\t\t@ReturnedRequestCount\t\t\t\t\t\tINT=0,\r\n\t\t@AssignedDispatchRequestCount\t\t\t\tINT=0,\r\n\t\t@UnassignedDispatchRequestCount\t\t\t\tINT=0,\r\n\t\t@UnassignedReturnAndReplacementRequestCount\tINT=0\r\n\r\nEXEC [Get_ActiveShipments_By_Filter_HAMID2] \r\n\t\t@OperationStaffId\t\t\t\t\t\t\t=53,\r\n\t\t@OperationWarningRangeTime\t\t\t\t\t=\u002700:01:00\u0027,\r\n\t\t@MinimumDeliveryTime\t\t\t\t\t\t=\u002700:19:00\u0027,\t\t\t\t\t\t\r\n\r\n\t\t@DelayedDeliveryRequestCount\t\t\t\t=@DelayedDeliveryRequestCount\t\t\t\tOUTPUT,\r\n\t\t@DelayedPickupCount\t\t\t\t\t\t\t=@DelayedPickupCount\t\t\t\t\t\tOUTPUT,\r\n\t\t@ReturnedRequestCount\t\t\t\t\t\t=@ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t\t@AssignedDispatchRequestCount\t\t\t\t=@AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t\t@UnassignedDispatchRequestCount\t\t\t\t=@UnassignedDispatchRequestCount\t\t\tOUTPUT,\r\n\t\t@UnassignedReturnAndReplacementRequestCount=@UnassignedReturnAndReplacementRequestCount OUTPUT\r\n\r\nSELECT \r\n\t\t@DelayedDeliveryRequestCount as DelayedDeliveryRequestCount, \r\n\t\t@DelayedPickupCount as DelayedPickupCount,\r\n\t\t@ReturnedRequestCount as ReturnedRequestCount,\r\n\t\t@AssignedDispatchRequestCount as AssignedDispatchRequestCount,\r\n\t\t@UnassignedDispatchRequestCount as UnassignedDispatchRequestCount,\r\n\t\t@UnassignedReturnAndReplacementRequestCount as UnassignedReturnAndReplacementRequestCount\r\n*/\r\nCREATE            PROC [dbo].[Get_ActiveShipments_By_Filter_HAMID]\r\n\r\n\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL ,\r\n\t@PolygonIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL,\r\n\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t\t=NULL ,\r\n\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t=NULL ,\r\n\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),---\r\n\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t\t=NULL,\r\n\t@VendorID\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL,\r\n\t@DeliveryServiceProviderId\t\t\t\t\tTINYINT = NULL,\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,   \r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0 OUTPUT\r\n--WITH RECOMPILE\r\nAS\r\nSET NOCOUNT ON\r\n--SET STATISTICS TIME ON\r\n\r\n\r\n--PRINT \u002700000\u0027\r\n--PRINT SYSDATETIME()\r\n\r\nDECLARE \r\n\t@OperationStaffId_Local\t\t\t\t\t\t\tINT ,\r\n\t@CityIds_Local\t\t\t\t\t\t\t\t\tVARCHAR(200)\t\t= NULL ,\r\n\t@PolygonIds_Local\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@FleetId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@StoreId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@ParcelReferenceCode_Local\t\t\t\t\t\tBIGINT\t\t\t\t= NULL ,\r\n\t@ShipmentStatusIds_Local\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@OperationWarningRangeTime_Local\t\t\t\tVARCHAR(10),\t\t  \r\n\t@MinimumDeliveryTime_Local\t\t\t\t\t\tVARCHAR(10),---\t\t  \r\n\t@VendorParcelCode_Local\t\t\t\t\t\t\tVARCHAR(32)\t\t\t= NULL ,\r\n\t@OrderBy_Local\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL ,\r\n\t@IsASC_Local\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL ,\r\n\t@VendorID_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@DeliveryServiceProviderId_Local\t\t\t\tTINYINT\t\t\t\t= NULL\r\n\r\n\tSET @OperationStaffId_Local\t\t\t\t = @OperationStaffId\r\n\tSET @CityIds_Local\t\t\t\t\t\t = @CityIds\r\n\tSET @PolygonIds_Local\t\t\t\t\t = @PolygonIds\r\n\tSET @FleetId_Local\t\t\t\t\t\t = @FleetId\r\n\tSET @StoreId_Local\t\t\t\t\t\t = @StoreId\r\n\tSET @ParcelReferenceCode_Local\t\t\t = @ParcelReferenceCode\r\n\tSET @ShipmentStatusIds_Local\t\t\t = @ShipmentStatusIds\r\n\tSET @OperationWarningRangeTime_Local\t = @OperationWarningRangeTime\r\n\tSET @MinimumDeliveryTime_Local\t\t\t = @MinimumDeliveryTime\r\n\tSET @VendorParcelCode_Local\t\t\t\t = @VendorParcelCode\r\n\tSET @VendorID_Local\t\t\t\t\t\t = @VendorID\r\n\tSET @OrderBy_Local\t\t\t\t\t\t = @OrderBy\r\n\tSET @IsASC_Local\t\t\t\t\t\t = @IsASC\r\n\tSET @DeliveryServiceProviderId_Local\t = @DeliveryServiceProviderId\r\n\r\n\r\n\r\n\r\n\tdeclare @sql1 nvarchar(max),\r\n\t\t\t@sql2 nvarchar(max),\r\n\t\t\t@sql nvarchar(max)\r\n\r\n    DECLARE @StartRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u0027000\u0027\r\n                                            ) as BIGINT)),\r\n            @EndRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002723\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u0027999\u0027\r\n                                            ) as BIGINT))\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\tDECLARE @PolygonId\tTABLE \r\n\t(\r\n\t\tId\tSMALLINT\r\n\t)\r\n\tINSERT INTO @PolygonId\r\n\tSELECT value\r\n\tFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\r\n\r\n\t--DROP TABLE IF EXISTS #Polygon\r\n\t--SELECT p.ID INTO #Polygon \r\n\t--FROM dp.Polygon p\r\n\t--INNER JOIN string_split(ISNULL(@PolygonIds,\u0027\u0027),\u0027,\u0027) ss\r\n\t--\tON p.ID = ss.value\r\n\t--\tOR ISNULL(@PolygonIds,\u0027\u0027) = \u0027\u0027\r\n\r\n\t---\r\n\t--DECLARE @ShipmentStatusId\tTABLE \r\n\t--(\r\n\t--\tId\tTINYINT\r\n\t--)\r\n\t--INSERT INTO @ShipmentStatusId\r\n\t--SELECT value\r\n\t--FROM string_split(@ShipmentStatusIds,\u0027,\u0027)\r\n\tDROP TABLE IF EXISTS #ShipmentStatusId\r\n\tCREATE TABLE #ShipmentStatusId\t \r\n\t(\r\n\t\tId\tTINYINT\r\n\t)\r\n\tINSERT INTO #ShipmentStatusId\r\n\tSELECT shs.Id\r\n\tFROM DP.ShipmentStatus shs (NOLOCK)\r\n\tINNER JOIN string_split(ISNULL(@ShipmentStatusIds_Local,\u00270\u0027),\u0027,\u0027) ss\r\n\t\tON shs.Id = ss.value\r\n\t\tOR ISNULL(@ShipmentStatusIds_Local,\u00270\u0027) = \u00270\u0027\r\n\r\n\t--@CityIds\r\n\tDECLARE @CityId\tTABLE \r\n\t(\r\n\t\tId\tSMALLINT\r\n\t)\r\n\tINSERT INTO @CityId\r\n\tSELECT VALUE\r\n\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\t--DROP TABLE IF EXISTS #CityID\r\n\t--SELECT p.CityId INTO #CityID FROM DP.Polygon p\r\n\t--INNER JOIN string_split(ISNULL(@CityIds,\u00270\u0027),\u0027,\u0027) ss\r\n\t--\tON p.ID = ss.value\r\n\t--\tOR ISNULL(@CityIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\t--deliveryDeadlineTime\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-12,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-12, 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE @Today INT=  CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\tDROP TABLE IF EXISTS \r\n\t\t\t#Result,\r\n\t\t\t#Result1,\r\n\t\t\t#TotalCount,\r\n\t\t\t#AllDispatchRequests,\r\n\t\t\t#UnassignedDispatchRequestCount,\r\n\t\t\t#UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t#AllShipmentDestinationPoint,\r\n\t\t\t#Assigned_DispatchRequestCount,\r\n\t\t\t#DelayedPickupCount,\r\n\t\t\t#DelayedDeliveryCount,\r\n\t\t\t#ReturnedCount\r\n\r\n\tDECLARE @Now int=LEFT(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),8),\r\n\t\t@Yesterday int = LEFT(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),8)\r\n\r\n\t--SET @DelayedDeliveryRequestCount = NULL\r\n\t--SET @DelayedPickupCount = NULL\r\n\t--SET @ReturnedRequestCount = NULL\r\n\t--SET @AssignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedReturnAndReplacementRequestCount = NULL\r\n\t--SET @NotPickupRequestCount = NULL\r\n\r\n\t--EXEC Get_OperationPanel_Count\r\n\t--\t\t@OperationStaffId = @OperationStaffId_Local,\r\n\t--\t\t@CityIds = @CityIds_Local,\r\n\t--\t\t@PolygonIds = @PolygonIds_Local,\r\n\t--\t\t@VendorID = @VendorID_Local,\r\n\t--\t\t@UnassignedDispatchRequestCount\t\t\t\t = @UnassignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t\t@AssignedDispatchRequestCount\t\t\t\t = @AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t\t@ReturnedRequestCount\t\t\t\t\t\t = @ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t\t@DelayedDeliveryCount\t\t\t\t\t\t = @delayedDeliveryRequestCount\t\t\t\t\tOUTPUT,\r\n\t--\t\t@UnassignedReturnAndReplacementRequestCount  = @UnassignedReturnAndReplacementRequestCount\tOUTPUT,\r\n\t--\t\t@NotPickupRequestCount\t\t\t\t\t\t = @NotPickupRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t\t@DelayedPickupCount\t\t\t\t\t\t\t = @DelayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = ISNULL(@UnassignedDispatchRequestCount,0),\t\t\t\r\n\t--\t@AssignedDispatchRequestCount = ISNULL(@AssignedDispatchRequestCount,0),\t\t\t\t\r\n\t--\t@ReturnedRequestCount = ISNULL(@ReturnedRequestCount,0),\t\t\t\t\t\r\n\t--\t@delayedDeliveryRequestCount = ISNULL(@delayedDeliveryRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@UnassignedReturnAndReplacementRequestCount = ISNULL(@UnassignedReturnAndReplacementRequestCount,0),\t\r\n\t--\t@NotPickupRequestCount = ISNULL(@NotPickupRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@DelayedPickupCount = ISNULL(@DelayedPickupCount,0)\t\t\r\n\r\n\t;WITH CTE_DR AS\r\n\t(\r\n\tSELECT\t\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\tddr.CourierRequestTypeId ,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tsdp.OperationTypeId,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tLEFT JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tLEFT JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tLEFT JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\tAND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\r\n\tAND\r\n\t(\r\n\t\t(ddr.DispatchRequestStatusId in (5,6) AND CAST(DeliveryStartTime/1000000000 AS BIGINT)IN(@Now,@Yesterday))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51))\r\n\t\tOR\r\n\t\t( (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) )\r\n\t\tOR\r\n\t\t(  sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) )\r\n\t\tOR\r\n\t\t( sdp.OperationTypeId = (10) AND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) )\r\n\t)\r\n\t)\r\n\r\n\r\n\tSELECT \r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount),\r\n\t\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date IN(@Now,@Yesterday) THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\t\tCASE WHEN ddr.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\t\tCASE WHEN \r\n\t\t\t\tddr.OperationTypeId = (10)  \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t\tIsWaitingForSupport = 1 \r\n\t\t\t\t\tAND DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\t\tTHEN ParcelReferenceCode\r\n\t\t\t\tELSE NULL \r\n\t\t\tEND AS NotPickupRequestCount\r\n\t\tFROM CTE_DR ddr\r\n\t) SQ\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t\r\n\t/*\r\n\tRETURN\r\n\t; WITH CTE_AllDispatchRequests AS\r\n\t(\r\n\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t/*LEFT(DeliveryStartTime,8)*/ CAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\t\t--/*LEFT(DeliveryDeadLineTime,8) */CAST(DeliveryDeadLineTime/1000000000 AS BIGINT) DeliveryDeadLineTime,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode\r\n\t--INTO #AllDispatchRequests\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t--INNER JOIN #Polygon p\tON dp.ID = p.Id\r\n\t--INNER JOIN #CityID c\tON dp.cityID = c.CityID\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\tAND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t--option(maxdop 1);\r\n\t--OPTION(RECOMPILE)\r\n\t),CTE_A AS\r\n\t(\r\n\t\tSELECT sdpdr.ShipmentDestinationPointId,DDR.DispatchRequestId\t\r\n\t\tFROM CTE_AllDispatchRequests ddr\r\n\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\t\tON ddr.DispatchRequestId=sdpdr.DispatchRequestId\r\n\t),CTE_B AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tsdp.Id AS ShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\tsdp.OperationTypeId, \r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdpdr.DispatchRequestId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime\r\n\t\tFROM CTE_A sdpdr\r\n\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\t),CTE_Shipment AS\r\n\t(\r\n\r\n\t\tSELECT \r\n\t\t\tsdp.*,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\t--dss.Id\t\tShipmentStatusId,\r\n\t\t\t--dss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId \r\n\t\tFROM CTE_B  sdp\r\n\t\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t--\tON dss.Id=ds.ShipmentStatusId\r\n\t), CTE_AllShipmentDestinationPoint AS\r\n\t(\r\n\t\tSELECT\tds.ShipmentDestinationPointId,\r\n\t\t\tds.ShipmentDestinationPointStatusId,\r\n\t\t\tds.OperationTypeId,\r\n\t\t\tds.DispatchRequestId,\r\n\t\t\tds.ShipmentId,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tds.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter\r\n\t\t\t\r\n\t\t--INTO #AllShipmentDestinationPoint\r\n\t\tFROM CTE_Shipment ds\r\n\t\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t\tWHERE dss.Id NOT IN ( 45,50,55,100 )\r\n\t)\r\n\r\n\tSELECT \r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date=@Now THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\t\tCASE WHEN sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\t\tCASE WHEN \r\n\t\t\t\tsdp.OperationTypeId = (10)  \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount\r\n\t\tFROM CTE_AllDispatchRequests ddr\r\n\t\tLEFT JOIN CTE_AllShipmentDestinationPoint sdp ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t\t--WHERE ddr.DispatchRequestStatusId IN ( 5,6,10,11,15,16,20,25,45,46,50,51)\r\n\t\t--OR (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25)\r\n\t) SQ\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\tRETURN\r\n\t*/\r\n\t/***************************************************/\r\n\tDECLARE @OperationWarningRangeTime_Second INT=DATEDIFF (SECOND,0,@OperationWarningRangeTime)\r\n\r\n\tSELECT\t\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\t\tddr.CourierRequestTypeId ,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t sdp.OperationTypeId,\r\n\t\t\tddr.Id DispatchRequestId,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\tsdp.ID  AS ShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId ,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tddr.DeliveryServiceProviderId\r\n\tINTO #CTE_DR\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t--AND sdp.OperationTypeId IN ( 5,10 )\r\n\t\t--AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\tAND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\tAND ddr.DeliveryServiceProviderId = @DeliveryServiceProviderId_Local OR ISNULL(@DeliveryServiceProviderId_Local,0) = 0\r\n\r\n\tCREATE INDEX IX_#CTE_DR ON #CTE_DR\r\n\t(\r\n\t\tShipmentId,\r\n\t\tDispatchRequestId,\r\n\t\tStoreId\r\n\t)\r\n\r\n\t;WITH CTE_Shipment AS\r\n\t(\r\n\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdp.*,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\t--dss.Id\t\tShipmentStatusId,\r\n\t\t\t--dss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId \r\n\t\tFROM #CTE_DR  sdp\r\n\t\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\tINNER JOIN #ShipmentStatusId ssid\r\n\t\t\tON ds.ShipmentStatusId = ssid.Id\r\n\t\tAND ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\t\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\t\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t), CTE_AllShipmentDestinationPoint AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tds.ShipmentDestinationPointId,\r\n\t\t\tds.ShipmentDestinationPointStatusId,\r\n\t\t\tds.OperationTypeId,\r\n\t\t\tds.DispatchRequestId,\r\n\t\t\tds.ShipmentId,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tds.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tDATEADD(SECOND,ds.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(ds.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))EstimatedArrivalTime\r\n\t\t--INTO #AllShipmentDestinationPoint\r\n\t\tFROM CTE_Shipment ds\r\n\t\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t\tWHERE dss.Id NOT IN ( 45,50,55,100 )\r\n\t), CTE_PickupStatus AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdpi.ShipmentId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN ShipmentStatusId = 25 THEN 2\r\n\t\t\t\tWHEN ShipmentStatusId = 30 THEN 4\r\n\t\t\t\tWHEN ShipmentStatusId IN (35,40) \r\n\t\t\t\tTHEN\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN HasDP = 1\r\n\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\tWHEN HasDP = 0 \r\n\t\t\t\t\t\tTHEN 2\r\n\t\t\t\t\tEND\r\n\t\t\t\t\t\t\r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) AND sdpi.SequenceNumber = sdpi.FS THEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\r\n\t\t\tELSE 5 END PickupStatus\t\t\t\t\t\r\n\t\tFROM \r\n\t\t(\r\n\t\t\tSELECT * FROM \r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tShipmentId , \r\n\t\t\t\t\tShipmentStatusId, \r\n\t\t\t\t\tOperationTypeId , \r\n\t\t\t\t\tShipmentDestinationPointStatusId , \r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tFIRST_VALUE(SQ.FS) OVER (PARTITION BY SQ.ShipmentId ORDER BY SQ.FS DESC) FS ,\r\n\t\t\t\t\tFIRST_VALUE(SQ.HasDP) OVER (PARTITION BY SQ.ShipmentId ORDER BY SQ.HasDP DESC) HasDP ,\r\n\t\t\t\t\tEstimatedArrivalTime\r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tDISTINCT CASE WHEN ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) THEN \r\n\t\t\t\t\t\t\tsdpi.SequenceNumber \r\n\t\t\t\t\t\tELSE 0 END FS,\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN ShipmentStatusId IN ( 35,40 ) AND OperationTypeId IN ( 5,20 ) AND ShipmentDestinationPointStatusId = 25 THEN 1 \r\n\t\t\t\t\t\t\tELSE 0 \r\n\t\t\t\t\t\tEND HasDP,\r\n\t\t\t\t\t\t* \r\n\t\t\t\t\tFROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\t\t\t) SQ\r\n\t\t\t) sdpi\r\n\t\t\tWHERE \r\n\t\t\t\tsdpi.ShipmentStatusId = 25\r\n\t\t\t\tOR ShipmentStatusId = 30\r\n\t\t\t\tOR ShipmentStatusId IN (35,40)\r\n\t\t\t\tOR (ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) AND sdpi.SequenceNumber = sdpi.FS)\r\n\t\t) sdpi\r\n\t), CTE_Delivery AS\r\n\t(\r\n\t\t\tSELECT DISTINCT \r\n\t\t\tsdpi.ShipmentId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) THEN 1\r\n\t\t\t\tWHEN ShipmentStatusId=35 THEN 4\r\n\t\t\t\tWHEN ShipmentStatusId IN (25,30,40) AND sdpi.SequenceNumber = sdpi.FS THEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\t\t\tEND DeliveryStatus\r\n\t\t\t\t\r\n\t\tFROM \r\n\t\t(\r\n\t\t\t\r\n\t\t\tSELECT * FROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tShipmentId , \r\n\t\t\t\t\tShipmentStatusId, \r\n\t\t\t\t\tOperationTypeId , \r\n\t\t\t\t\tShipmentDestinationPointStatusId , \r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\t\tFIRST_VALUE(sdpi.FS) OVER (PARTITION BY sdpi.ShipmentId ORDER BY sdpi.FS DESC) FS \r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT CASE WHEN ShipmentStatusId IN (25,30,40) THEN sdpi.SequenceNumber  ELSE 0 END FS, * FROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\t\t\t) sdpi\r\n\t\t\t) SDPI\r\n\t\t\tWHERE \r\n\t\t\t\tsdpi.ShipmentStatusId IN (5,6,10,15,20)\r\n\t\t\t\tOR ShipmentStatusId=35\r\n\t\t\t\tOR (ShipmentStatusId IN (25,30,40) AND sdpi.SequenceNumber = sdpi.FS)\r\n\t\t\t) sdpi\r\n\t\t--ORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t), CTE_Estimated AS\r\n\t(\r\n\t\r\n\t\tSELECT TOP 1 WITH TIES  sdpi.ShipmentId,sdpi.EstimatedArrivalTime EstimatedEndDateTimeStr\r\n\t\tFROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\tWHERE sdpi.ShipmentDestinationPointStatusId NOT IN (30/*Aborted*/)\r\n\t\t--AND ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\tORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t), CTE_TotalCount AS\r\n\t(\r\n\r\n\t\tSELECT sh.Id shipmentId,\r\n\t\t\tcount(distinct ShipmentDestinationPointId)DispatchRequestCount\t\r\n\t\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\t\t--INNER JOIN CTE_DR ddr ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t\tINNER JOIN dp.Shipment sh\twith(nolock)\t\tON sh.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN dp.PolygonFleet(NOLOCK) dpf\t\t\t\t\t\t\t\tON dpf.PolygonId=ddr.PolygonId  AND dpf.IsActive=1\r\n\t\tINNER JOIN dp.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sh.FleetId AND df.IsActive=1\r\n\t\tINNER JOIN #ShipmentStatusId ssid\r\n\t\t\tON sh.ShipmentStatusId = ssid.Id\r\n\t\tWHERE sh.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\t\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t\tAND ((df.Id\t\t =@FleetId\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\t\t--AND ((sh.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\t\tGROUP BY sh.Id\r\n\t), CTE_IsReturnToStoreRequired AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tShipmentId,\r\n\t\t\tCAST(IsReturnToStoreRequired AS BIT ) IsReturnToStoreRequired\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tSQ.ShipmentId,\r\n\t\t\t\tFIRST_VALUE(IsReturnToStoreRequired) OVER ( PARTITION BY SQ.ShipmentId ORDER BY IsReturnToStoreRequired DESC ) IsReturnToStoreRequired,\r\n\t\t\t\tFIRST_VALUE(HasDelivery) OVER ( PARTITION BY SQ.ShipmentId ORDER BY HasDelivery DESC) HasDelivery\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tsdp.ShipmentId,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId = 30 AND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35,40 ) AND sdpdr.DispatchRequestId IS NULL THEN 1 ELSE 0 END IsReturnToStoreRequired,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId \u003C\u003E 30 AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ) THEN 1 ELSE 0 END HasDelivery\r\n\t\t\t\tFROM CTE_Shipment s\r\n\t\t\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\t\tON s.ShipmentId = sdp.ShipmentId\r\n\t\t\t\tLEFT JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\t\t\tWHERE sdp.OperationTypeId = 30\r\n\t\t\t\tOR (sdp.OperationTypeId \u003C\u003E 30 AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ))\r\n\t\t\t) SQ\r\n\t\t) SQ\r\n\t\tWHERE SQ.HasDelivery = 0\r\n\t)\r\n\r\n\tSELECT * FROM \r\n\t(\r\n\tSELECT DISTINCT\r\n\t\t\tsdp.ShipmentId\t\t\t\t\t\t\tId,\r\n\t\t\tsdp.ShipmentStatusId\t\t\t\t\tStatusId,\r\n\t\t\tsdp.ShipmentStatusTitle\t\t\t\t\tStatusTitle,\r\n\t\t\tsdp.ShipmentNumber,\r\n\t\t\tsdp.TotalEstimatedDurationSeconds,\r\n\t\t\tsdp.TotalDistanceMeter,\r\n\t\t\tddr.CityId\t\t\t\t\t\t\t\tCityId,\r\n\t\t\tddr.PolygonId\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tddr.polygonTitle\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tddr.StoreId\t\t\t\t\t\t\t\tStoreId,\r\n\t\t\ts.Location.STY  AS  StoreLocationLat,\r\n\t\t\ts.Location.STX  AS\tStoreLocationLong,\r\n\t\t\tddr.StoreTitle\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\t--sdp.ShipmentStatusId,\r\n\t\t\tPickupStatus.PickupStatus,\r\n\t\t\tDeliveryStatus.DeliveryStatus,\r\n\t\t\tISNULL(CASE \r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20)\tTHEN PickupStatus\r\n\t\t\t\tWHEN ShipmentStatusId IN (25,30,35,40)\tTHEN DeliveryStatus\r\n\t\t\t\tELSE 0\r\n\t\t\tEND,0) OperationStatus,\r\n\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\tISNULL(tc.DispatchRequestCount,0) DispatchRequestCount, --(SELECT DispatchRequestCount FROM CTE_TotalCount t where shipmentId=t.shipmentId)\tDispatchRequestCount,\r\n\t\t\tdf.Id\t\t\t\t\t\t\t\t\tFleetId,\r\n\t\t\td.Id\t\t\t\t\t\t\t\t\tDriverId,\r\n\t\t\tCONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\tDriverName,\r\n\t\t\tCONCAT(\u00270\u0027,d.Mobile)\t\t\t\t\tDriverMobile,\r\n\t\t\tdv.VehicleTypeId,\r\n\t\t\tdv.PlateNumber,\r\n\t\t\tISNULL(rtsr.IsReturnToStoreRequired,0) IsReturnToStoreRequired,\r\n\t\t\tddr.DeliveryServiceProviderId\r\n\r\n\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #CTE_DR ddr\t\t\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tJOIN DP.Store AS s with(nolock) ON s.Id = ddr.StoreId\r\n\tINNER JOIN dp.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sdp.FleetId\t\tAND df.IsActive=1\r\n\tINNER JOIN dp.vehicle(NOLOCK) dv\t\t\t\t\t\t\t\t\tON dv.Id=df.VehicleId\r\n\tINNER JOIN DP.Driver(NOLOCK) AS d\t\t\t\t\t\t\t\t\tON d.id = df.DriverId\r\n\tLEFT JOIN CTE_PickupStatus PickupStatus ON PickupStatus.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_Delivery DeliveryStatus ON DeliveryStatus.ShipmentId=sdp.ShipmentId\r\n\tINNER JOIN CTE_Estimated EstimatedEndDateTimeStr ON EstimatedEndDateTimeStr.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_TotalCount tc ON  sdp.ShipmentId = tc.shipmentId\r\n\tLEFT JOIN CTE_IsReturnToStoreRequired rtsr\r\n\t\tON sdp.ShipmentId = rtsr.ShipmentId\r\n\tWHERE (ddr.DispatchRequestStatusId IN (10/*Assigned To Courier*/,11/*Reassigned*/,15/*Arrived at Pickup point*/,\r\n\t\t\t\t\t\t\t\t\t\t 16/*SecondFleetArrivedAtPickupPoint*/,20/*Picked up*/,25/*Arrived at Delivery Point*/,\r\n\t\t\t\t\t\t\t\t\t\t 45/*Cancel Response Pending*/,46/*Second Cancel Request Pending*/,47,48,49,52,53,54,50/*Cancel Request Rejected*/,\r\n\t\t\t\t\t\t\t\t\t\t 51/*Second Cancel Request Rejected*/)  OR rtsr.IsReturnToStoreRequired IS NOT NULL )\r\n\tAND sdp.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t--AND((ddr.CityId IN (SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds,\u00270\u0027)=\u00270\u0027))\t\t\r\n\tAND ((df.Id\t\t =@FleetId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\tAND ((ddr.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\t--AND (ddr.PolygonId IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\t--AND ((sdp.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds,\u0027\u0027)=\u0027\u0027))\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027), Recompile)\r\n\t--OPTION(MAXDOP 1)\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t--OPTION(Recompile)\r\n\t\r\n\t) SQ\r\n\tORDER BY \r\n\t\tCASE WHEN @OrderBy_Local IS NOT NULL AND @OrderBy_Local \u003C\u003E \u0027\u0027 AND @OrderBy_Local \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\u002B  @OrderByReplace \r\n\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\tEND,\r\n\t\tOperationStatus DESC,\r\n\t\tEstimatedEndDateTimeStr ASC\r\n--\tOPTION (USE HINT (\u0027FORCE_LEGACY_CARDINALITY_ESTIMATION\u0027));\r\nOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\tSET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\n\r\n\r\n\t/*\r\n\tDECLARE @OrderbyValue NVARCHAR(100)\r\n\tSET @sql = \u0027\r\n\tDROP TABLE IF EXISTS #t\r\n\tSELECT\r\n\t\t\t\t\tId,\r\n\t\t\t\t\tStatusId,\r\n\t\t\t\t\tStatusTitle,\r\n\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\tTotalEstimatedDurationSeconds,\r\n\t\t\t\t\tTotalDistanceMeter,\r\n\t\t\t\t\tCityId,\r\n\t\t\t\t\tPolygonId,\r\n\t\t\t\t\tPolygonTitle,\r\n\t\t\t\t\tStoreId,\r\n\t\t\t\t\tStoreLocationLat,\r\n\t\t\t\t\tStoreLocationLong,\r\n\t\t\t\t\tStoreTitle,\r\n\t\t\t\t\tISNULL(PickupStatus,0)\t\tPickupStatus,\r\n\t\t\t\t\tISNULL(DeliveryStatus,1)\tDeliveryStatus,\r\n\t\t\t\t\tOperationStatus,\r\n\t\t\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\t\t\tFleetId,\r\n\t\t\t\t\tDriverId,\r\n\t\t\t\t\tDriverName,\r\n\t\t\t\t\tDriverMobile,\r\n\t\t\t\t\tVehicleTypeId,\r\n\t\t\t\t\tPlateNumber\r\n\t\t\t\tInto #T\r\n\tFROM #Result r\r\n\t \r\n\r\n\t/*SELECT @Result=(\r\n\r\n\t\tSELECT\ttc.TotalCount count,\r\n\r\n\t\tJSON_QUERY((*/\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tId,\r\n\t\t\t\t\tStatusId,\r\n\t\t\t\t\tStatusTitle,\r\n\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\tTotalEstimatedDurationSeconds \tTotalEstimatedDurationSeconds,\r\n\t\t\t\t\tTotalDistanceMeter,\r\n\t\t\t\t\tCityId,\r\n\t\t\t\t\tPolygonId,\r\n\t\t\t\t\tPolygonTitle,\r\n\t\t\t\t\tStoreId,\r\n\t\t\t\t\tStoreLocationLat,\r\n\t\t\t\t\tStoreLocationLong,\r\n\t\t\t\t\tStoreTitle,\r\n\t\t\t\t\tISNULL(PickupStatus,0)\t\t\t\t\t\t\t\t\t\t\t\t\tPickupStatus,\r\n\t\t\t\t\tISNULL(DeliveryStatus,1) \t\t\t\t\t\t\t\t\t\t\t\tDeliveryStatus,\r\n\t\t\t\t\tOperationStatus,\r\n\t\t\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\t\t\t(SELECT DispatchRequestCount FROM #TotalCount t where Id=t.shipmentId)\tDispatchRequestCount,\r\n\t\t\t\t\tFleetId,\r\n\t\t\t\t\tDriverId,\r\n\t\t\t\t\tDriverName,\r\n\t\t\t\t\tDriverMobile,\r\n\t\t\t\t\tVehicleTypeId,\r\n\t\t\t\t\tPlateNumber\r\n\r\n\t\t\t\tFROM #T \r\n\t\t\t\tORDER BY \u0027 \u002B\r\n\t\t\t\t\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\t\t\t\u002B  @OrderByReplace \u002B \u0027 , \u0027\r\n\t\t\t\t\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\u002B \u0027 OperationStatus DESC,\r\n\t\t\t\t\t\tEstimatedEndDateTimeStr ASC\r\n\t\t\t\t\t\t   \r\n\r\n\t\t\t/*\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t\t))Shipments,\r\n\r\n\r\n\t\t--FROM #TotalCount AS tc\r\n\r\n\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n\t)\r\n\r\n\r\n\r\n\tset @Result = REPLACE(@Result,N\u0027\u0027\\\u0027\u0027,\u0027\u0027\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022Fleet\u0022:\u0022{\u0027\u0027,\u0027\u0027\u0022Fleet\u0022:{\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022}\u0022}\u0027\u0027,\u0027\u0027\u0022}}\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027}\u0022}]}\u0027\u0027,\u0027\u0027}}]}\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027}\u0022,\u0022StoreTitle\u0022:\u0027\u0027,\u0027\u0027},\u0022StoreTitle\u0022:\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022StoreLocation\u0022:\u0022{\u0027\u0027,\u0027\u0027\u0022StoreLocation\u0022:{\u0027\u0027)\r\n\r\n\r\n\tDECLARE @TotalCount INT \r\n\tSELECT @TotalCount = tc.TotalCount FROM #TotalCount AS tc\t\r\n\tIF @TotalCount=0 \r\n\tBEGIN \r\n\t\tSET @Result=NULL\r\n\t\tRETURN \r\n\tEND\r\n\t*/\r\n\r\n\t--DECLARE @DelayedDeliveryRequestCount\t\t\t\tINT=0\r\n\t--DECLARE @DelayedPickupCount\t\t\t\t\t\tINT=0\r\n\t--DECLARE @ReturnedRequestCount\t\t\t\t\t\tINT=0\r\n\t--DECLARE @Assigned_DispatchRequestCount\t\t\tINT=0\r\n\t--DECLARE @UnassignedDispatchRequestCount\t\t\tINT=0\r\n\r\n\t--SET  @DelayedDeliveryRequestCount\t\t\t\t\t= (SELECT DelayedDeliveryCount FROM #DelayedDeliveryCount)\t\t\t\t\t\t--DelayedDeliveryCount,\r\n\t--SET  @DelayedPickupCount\t\t\t\t\t\t\t= (SELECT DelayedPickupCount FROM #DelayedPickupCount)\t\t\t\t\t\t\t--DelayedPickupCount,\r\n\t--SET  @ReturnedRequestCount\t\t\t\t\t\t\t= (SELECT ReturnedCount FROM #ReturnedCount)\t\t\t\t\t\t\t\t\t\t--ReturnedCount,\r\n\t--SET  @AssignedDispatchRequestCount\t\t\t\t\t= (SELECT Assigned_DispatchRequestCount FROM #Assigned_DispatchRequestCount)\t\t--Assigned_DispatchRequestCount,\r\n\t--SET  @UnassignedDispatchRequestCount\t\t\t\t= (SELECT UnassignedDispatchRequestCount FROM #UnassignedDispatchRequestCount)\t--UnassignedDispatchRequestCount\r\n\t--SET  @UnassignedReturnAndReplacementRequestCount\t= (select UnassignedReturnAndReplacementRequestCount from #UnassignedReturnAndReplacementRequestCount)\r\n\r\n\t\u0027\r\n\r\n\t--PRINT \u0027YYY\u0027\r\n\t--PRINT SYSDATETIME()\r\n\t-- PRINT @sql\t\r\n\tDECLARE @Param NVARCHAR(4000) =\t\u0027\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t=NULL,\r\n\t\t\t\t\t\t\t\t\t\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10)           ,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t=NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)   =NULL,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t=NULL,\r\n\r\n\t\t\t\t\t\t\t\t\t\t@DelayedDeliveryRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@DelayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@ReturnedRequestCount\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@AssignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\tOUTPUT\r\n\t\t\t\t\t\t\t\t\t\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL @sql,@Param,\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t=@OperationStaffId,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t=@CityIds,\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t=@PolygonIds,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@FleetId\t\t\t\t\t\t\t=@FleetId,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t=@StoreId,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t=@ParcelReferenceCode,\t\t\r\n\t\t\t\t\t\t\t\t\t\t@ShipmentStatusIds\t\t\t\t\t=@ShipmentStatusIds,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t=@OperationWarningRangeTime,\t\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t=@VendorParcelCode,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t=@OrderBy,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t=@IsASC\t,\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\t\t\t@DelayedDeliveryRequestCount\t\t=@DelayedDeliveryRequestCount\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@DelayedPickupCount\t\t\t\t\t=@DelayedPickupCount\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@ReturnedRequestCount\t\t\t\t=@ReturnedRequestCount\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@AssignedDispatchRequestCount\t\t=@AssignedDispatchRequestCount\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedDispatchRequestCount\t\t=@UnassignedDispatchRequestCount\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount=@UnassignedReturnAndReplacementRequestCount output\t\t\t\r\n\r\n*/\r\n\r\n--PRINT \u0027ZZZ\u0027\r\n--PRINT SYSDATETIME()\r\n\r\n\r\n\r\n\r\n"},{"Name":"Get_ActiveShipments_By_Filter_Old","Schema":"dbo","Definition":"\r\n-- Stored Procedure\r\n\r\n/*\r\nDECLARE @DelayedDeliveryRequestCount\t\t\t\tINT=0,\r\n\t\t@DelayedPickupCount\t\t\t\t\t\t\tINT=0,\r\n\t\t@ReturnedRequestCount\t\t\t\t\t\tINT=0,\r\n\t\t@AssignedDispatchRequestCount\t\t\t\tINT=0,\r\n\t\t@UnassignedDispatchRequestCount\t\t\t\tINT=0,\r\n\t\t@UnassignedReturnAndReplacementRequestCount\tINT=0\r\n\r\nEXEC [Get_ActiveShipments_By_Filter] \r\n\t\t@OperationStaffId\t\t\t\t\t\t\t=53,\r\n\t\t@OperationWarningRangeTime\t\t\t\t\t=\u002700:01:00\u0027,\r\n\t\t@MinimumDeliveryTime\t\t\t\t\t\t=\u002700:19:00\u0027,\t\t\t\t\t\t\r\n\r\n\t\t@DelayedDeliveryRequestCount\t\t\t\t=@DelayedDeliveryRequestCount\t\t\t\tOUTPUT,\r\n\t\t@DelayedPickupCount\t\t\t\t\t\t\t=@DelayedPickupCount\t\t\t\t\t\tOUTPUT,\r\n\t\t@ReturnedRequestCount\t\t\t\t\t\t=@ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t\t@AssignedDispatchRequestCount\t\t\t\t=@AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t\t@UnassignedDispatchRequestCount\t\t\t\t=@UnassignedDispatchRequestCount\t\t\tOUTPUT,\r\n\t\t@UnassignedReturnAndReplacementRequestCount=@UnassignedReturnAndReplacementRequestCount OUTPUT\r\n\r\nSELECT \r\n\t\t@DelayedDeliveryRequestCount as DelayedDeliveryRequestCount, \r\n\t\t@DelayedPickupCount as DelayedPickupCount,\r\n\t\t@ReturnedRequestCount as ReturnedRequestCount,\r\n\t\t@AssignedDispatchRequestCount as AssignedDispatchRequestCount,\r\n\t\t@UnassignedDispatchRequestCount as UnassignedDispatchRequestCount,\r\n\t\t@UnassignedReturnAndReplacementRequestCount as UnassignedReturnAndReplacementRequestCount\r\n*/\r\nCREATE      PROC [dbo].[Get_ActiveShipments_By_Filter]\r\n\r\n\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t\t=NULL ,\r\n\t@PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t=NULL,\r\n\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t\t=NULL ,\r\n\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t=NULL ,\r\n\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),---\r\n\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t\t=NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL,\r\n\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT OUTPUT,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT OUTPUT,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT OUTPUT,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT OUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t\t\t    \r\n\t@UnassignedReturnAndReplacementRequestCount INT OUTPUT\r\n\r\nAS\r\n\r\nSET NOCOUNT ON\r\n--SET STATISTICS TIME ON\r\n\r\n\r\n--PRINT \u002700000\u0027\r\n--PRINT SYSDATETIME()\r\n\r\n\tdeclare @sql1 nvarchar(max),\r\n\t\t\t@sql2 nvarchar(max),\r\n\t\t\t@sql nvarchar(max)\r\n\r\n    DECLARE @StartRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u0027000\u0027\r\n                                            ) as BIGINT)),\r\n            @EndRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002723\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u0027999\u0027\r\n                                            ) as BIGINT))\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\tDECLARE @PolygonId\tTABLE \r\n\t(\r\n\t\tId\tSMALLINT\r\n\t)\r\n\tINSERT INTO @PolygonId\r\n\tSELECT value\r\n\tFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\r\n\r\n\t---\r\n\tDECLARE @ShipmentStatusId\tTABLE \r\n\t(\r\n\t\tId\tTINYINT\r\n\t)\r\n\tINSERT INTO @ShipmentStatusId\r\n\tSELECT value\r\n\tFROM string_split(@ShipmentStatusIds,\u0027,\u0027)\r\n\r\n\r\n\t--@CityIds\r\n\tDECLARE @CityId\tTABLE \r\n\t(\r\n\t\tId\tSMALLINT\r\n\t)\r\n\tINSERT INTO @CityId\r\n\tSELECT VALUE\r\n\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\r\n\r\n\t--deliveryDeadlineTime\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-4,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-4, 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE @Today INT=  CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\tDROP TABLE IF EXISTS \r\n\t\t\t#Result,\r\n\t\t\t#Result1,\r\n\t\t\t#TotalCount,\r\n\t\t\t#AllDispatchRequests,\r\n\t\t\t#UnassignedDispatchRequestCount,\r\n\t\t\t#UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t#AllShipmentDestinationPoint,\r\n\t\t\t#Assigned_DispatchRequestCount,\r\n\t\t\t#DelayedPickupCount,\r\n\t\t\t#DelayedDeliveryCount,\r\n\t\t\t#ReturnedCount\r\n\t/**************************************************AllDispatchRequests*/\r\n\t--PRINT \u0027AAA\u0027\r\n\tCREATE TABLE #AllDispatchRequests \r\n\t(\r\n\t\tDispatchRequestId BIGINT NULL,\r\n\t\tParcelReferenceCode BIGINT NULL,\r\n\t\tDispatchRequestStatusId TINYINT NULL,\r\n\t\tCourierRequestTypeId TINYINT NULL,\r\n\t\tDeliveryStartTime_Date BIGINT NULL,\r\n\t\tDeliveryDeadLineTime BIGINT NULL,\r\n\t\tPolygonStoreId INT NULL,\r\n\t\tPolygonId SMALLINT NULL,\r\n\t\tPolygonTitle NVARCHAR(100),\r\n\t\tStoreId INT NULL,\r\n\t\tStoreTitle NVARCHAR(100),\r\n\t\tCityId SMALLINT NULL,\r\n\t\tVendorParcelCode NVARCHAR(MAX)\r\n\t)\r\n\t--SELECT @OperationStaffId,@ToDate\r\n\tINSERT INTO #AllDispatchRequests\r\n\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t/*LEFT(DeliveryStartTime,8)*/ CAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date\r\n\t\t\t,/*LEFT(DeliveryDeadLineTime,8) */CAST(DeliveryDeadLineTime/1000000000 AS BIGINT) DeliveryDeadLineTime,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode\r\n\t--INTO #AllDispatchRequests\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t/*AND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\t*/\r\n\t--option(maxdop 1);\r\n\tOPTION(RECOMPILE)\r\n\r\n\r\n\t\r\n\t\t--(5,6) \r\n\t --(26,30,35,40,45,50,60,65,70)\r\n\t --(10,11,15,16,20,25,45,46,50,51)\r\n\t \r\n\t --in (45,46) and CourierRequestTypeId in (5,10,15)\r\n\r\n\t --not in (30,35,100) and CourierRequestTypeId = 25\r\n\t --(10,11,15,16)\r\n\r\n\t-- \tPRINT \u0027A-1\u0027\r\n\t--PRINT SYSDATETIME()\r\n\r\n\t--17,80,100\r\n\r\n\t--CREATE NONCLUSTERED INDEX IX_0\r\n\t--ON [dbo].#AllDispatchRequests ([DispatchRequestId])\r\n\t----INCLUDE ([ParcelReferenceCode],[DeliveryStartTime_Date],[DispatchRequestId])\r\n\t--\tPRINT \u0027A-2\u0027\r\n\t--PRINT SYSDATETIME()\r\n\t--CREATE NONCLUSTERED INDEX IX_1\r\n\t--ON [dbo].#AllDispatchRequests ([DispatchRequestStatusId],[CourierRequestTypeId],[DeliveryStartTime_Date],[DispatchRequestId])\r\n\t--INCLUDE ([ParcelReferenceCode])\r\n\r\n\t--\tPRINT \u0027A-3\u0027\r\n\t--PRINT SYSDATETIME()\r\n\r\n\r\n\t--SELECT sdpdr.ShipmentDestinationPointId,DDR.DispatchRequestId\t\r\n\t--\tFROM #AllDispatchRequests(NOLOCK) ddr\r\n\t--\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t--\t\tON ddr.DispatchRequestId=sdpdr.DispatchRequestId\r\n\r\n\r\n\r\n\t--PRINT \u0027BBB\u0027\r\n\t--PRINT SYSDATETIME()\r\n\t--RETURN\r\n\t\r\n\tCREATE TABLE #AllShipmentDestinationPoint\r\n\t(\r\n\t\tShipmentDestinationPointId INT NULL,\r\n\t\tShipmentDestinationPointStatusId TINYINT NULL,\r\n\t\tOperationTypeId TINYINT NULL,\r\n\t\tDispatchRequestId BIGINT NULL,\r\n\t\tShipmentId BIGINT NULL,\r\n\t\tShipmentStatusId TINYINT NULL,\r\n\t\tShipmentStatusTitle NVARCHAR(MAX) NULL,\r\n\t\tFleetId INT NULL,\r\n\t\tSequenceNumber TINYINT NULL,\r\n\t\tShipmentNumber BIGINT NULL,\r\n\t\tTotalEstimatedDurationSeconds INT NULL,\r\n\t\tTotalDistanceMeter INT NULL,\r\n\t\tEstimatedArrivalTime DATETIME NULL\r\n\t)\r\n\r\n\t--PRINT \u0027B-1\u0027\r\n\t--PRINT SYSDATETIME()\r\n\t--CREATE NONCLUSTERED INDEX XI_0\r\n\t--ON [dbo].[#AllShipmentDestinationPoint] ([DispatchRequestId],[ShipmentId],[ShipmentDestinationPointStatusId],[ShipmentDestinationPointId],[OperationTypeId])\r\n\r\n\t; WITH CTE_A AS\r\n\t(\r\n\t\tSELECT sdpdr.ShipmentDestinationPointId,DDR.DispatchRequestId\t\r\n\t\tFROM #AllDispatchRequests(NOLOCK) ddr\r\n\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\t\tON ddr.DispatchRequestId=sdpdr.DispatchRequestId\r\n\t),CTE_B AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tsdp.Id AS ShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\tsdp.OperationTypeId, \r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdpdr.DispatchRequestId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime\r\n\t\tFROM CTE_A sdpdr\r\n\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t),CTE_Shipment AS\r\n\t(\r\n\r\n\t\tSELECT \r\n\t\t\tsdp.*,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\t--dss.Id\t\tShipmentStatusId,\r\n\t\t\t--dss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId \r\n\t\tFROM CTE_B  sdp\r\n\t\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t--\tON dss.Id=ds.ShipmentStatusId\r\n\t)\r\n\tINSERT INTO #AllShipmentDestinationPoint\r\n\tSELECT\tds.ShipmentDestinationPointId,\r\n\t\tds.ShipmentDestinationPointStatusId,\r\n\t\tds.OperationTypeId,\r\n\t\tds.DispatchRequestId,\r\n\t\tds.ShipmentId,\r\n\t\tds.ShipmentStatusId,\r\n\t\tdss.Title\tShipmentStatusTitle,\r\n\t\tds.FleetId,\r\n\t\tds.SequenceNumber,\r\n\t\tds.ShipmentNumber,\r\n\t\tds.TotalEstimatedDurationSeconds,\r\n\t\tds.TotalDistanceMeter,\r\n\t\tDATEADD(SECOND,ds.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(ds.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))EstimatedArrivalTime\r\n\t--INTO #AllShipmentDestinationPoint\r\n\tFROM CTE_Shipment ds\r\n\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\tON dss.Id=ds.ShipmentStatusId\r\n\tWHERE dss.Id NOT IN ( 45,50,55,100 )\r\n\t--*/\r\nOPTION ( RECOMPILE )\r\n\r\n\t--PRINT \u0027B-2\u0027\r\n\t--PRINT SYSDATETIME()\r\n\t--DROP TABLE IF EXISTS #AllShipmentDestinationPoint1\r\n\r\n\t--PRINT \u0027CCC\u0027\r\n\t--PRINT SYSDATETIME()\r\n\t--RETURN\r\n\t\r\n/*\r\n\t/**************************************************AllShipmentDestinationPoint*/\r\n\tSELECT\tsdp.Id\t\tShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\tsdp.OperationTypeId,\r\n\t\t\tddr.DispatchRequestId,\r\n\t\t\tds.Id\t\tShipmentId,\r\n\t\t\tdss.Id\t\tShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tDATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))EstimatedArrivalTime\r\n\tINTO #AllShipmentDestinationPoint\r\n\tFROM dP.Shipment(NOLOCK) ds\r\n\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON ds.Id=sdp.ShipmentId\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\tINNER JOIN #AllDispatchRequests(NOLOCK) ddr\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdpdr.DispatchRequestId\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027),KEEPFIXED PLAN)\r\n\t--OPTION (KEEPFIXED PLAN);\r\n\t*/\r\n\t--CREATE NONCLUSTERED INDEX IX_2\r\n\t--ON [dbo].#AllShipmentDestinationPoint ([ShipmentDestinationPointStatusId],[OperationTypeId])\r\n\t--INCLUDE ([ShipmentDestinationPointId],[DispatchRequestId],[ShipmentId]);\r\n\r\n\r\n\tDECLARE @Now int=LEFT(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),8)\r\n\t/* @DelayedDeliveryRequestCount\t\t\t\t\t\r\n\t @DelayedPickupCount\t\t\t\t\t\t\t\r\n\t @ReturnedRequestCount\t\t\t\t\t\t\r\n\t @AssignedDispatchRequestCount\t\t\t\t\r\n\t @UnassignedDispatchRequestCount\t\t\t\t\r\n\t @UnassignedReturnAndReplacementRequestCount\t\r\n\t */\r\n\t DROP TABLE IF EXISTS #Counts\r\n\t CREATE TABLE #Counts\r\n\t (\r\n\t\tUnassignedDispatchRequestCount INT NULL,\r\n\t\tUnassignedReturnAndReplacementRequestCount INT,\r\n\t\tAssigned_DispatchRequestCount INT,\r\n\t\tReturnedCount INT,\r\n\t\tDelayedPickupCount INT,\r\n\t\tDelayedDeliveryCount INT\r\n\t)\r\n\r\n\tINSERT INTO #Counts \r\n\t(\r\n\t\tUnassignedDispatchRequestCount,\r\n\t\tUnassignedReturnAndReplacementRequestCount,\r\n\t\tAssigned_DispatchRequestCount,\r\n\t\tReturnedCount,\r\n\t\tDelayedPickupCount,\r\n\t\tDelayedDeliveryCount\r\n\t)\r\n\tSELECT \r\n\t\tCOUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t\tCOUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t\tCOUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t\tCOUNT(DISTINCT ReturnedCount),\r\n\t\tCOUNT(DISTINCT DelayedPickupCount),\r\n\t\tCOUNT(DISTINCT DelayedDeliveryCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date=@Now THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\t\tCASE WHEN sdp.OperationTypeId = 5 AND GETDATE()\u003EEstimatedArrivalTime AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\t\tCASE WHEN \r\n\t\t\t\tsdp.OperationTypeId = (10)  \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\t\t\tAND EstimatedArrivalTime \u003C= getdate() \r\n\t\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount\r\n\t\tFROM #AllDispatchRequests ddr\r\n\t\tLEFT JOIN #AllShipmentDestinationPoint sdp ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t\tWHERE ddr.DispatchRequestStatusId IN ( 5,6,10,11,15,16,20,25,45,46,50,51)\r\n\t\tOR (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25)\r\n\t) SQ\r\n\r\n\tSET @DelayedDeliveryRequestCount = NULL\r\n\tSET @DelayedPickupCount = NULL\r\n\tSET @ReturnedRequestCount = NULL\r\n\tSET @AssignedDispatchRequestCount = NULL\r\n\tSET @UnassignedDispatchRequestCount = NULL\r\n\tSET @UnassignedReturnAndReplacementRequestCount = NULL\r\n\r\n\r\n\tSELECT @DelayedDeliveryRequestCount\t\t\t\t\t= DelayedDeliveryCount,\t\t\t\t\t\t--DelayedDeliveryCount,\r\n\t\t@DelayedPickupCount\t\t\t\t\t\t\t= DelayedPickupCount,\t\t\t\t\t\t\t--DelayedPickupCount,\r\n\t\t@ReturnedRequestCount\t\t\t\t\t\t\t= ReturnedCount,\t\t\t\t\t\t\t\t\t\t--ReturnedCount,\r\n\t\t@AssignedDispatchRequestCount\t\t\t\t\t= Assigned_DispatchRequestCount,\t\t--Assigned_DispatchRequestCount,\r\n\t\t@UnassignedDispatchRequestCount\t\t\t\t= UnassignedDispatchRequestCount,\t--UnassignedDispatchRequestCount\r\n\t\t@UnassignedReturnAndReplacementRequestCount\t= UnassignedReturnAndReplacementRequestCount \r\n\tFROM #Counts\r\n\t--\tPRINT \u0027C-0\u0027\r\n\t--PRINT SYSDATETIME()\r\n\t/***************************************************/\r\n\t/*\r\n\tSELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tUnassignedDispatchRequestCount\r\n\tINTO #UnassignedDispatchRequestCount\r\n\tFROM #AllDispatchRequests ddr\r\n\tWHERE ddr.DispatchRequestStatusId in (5,6) \r\n\tAND DeliveryStartTime_Date=@Now\r\n\t--OPTION (KEEPFIXED PLAN);\r\n\tPRINT \u0027C-1\u0027\r\n\tPRINT SYSDATETIME()\r\n\t/***************************************************/\r\n\tSELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tUnassignedReturnAndReplacementRequestCount\r\n\tINTO #UnassignedReturnAndReplacementRequestCount\r\n\tFROM #AllDispatchRequests ddr\r\n\tWHERE ddr.DispatchRequestStatusId in (5) \r\n\tAND CourierRequestTypeId in (26,30,35,40,45,50,60,65,70)\r\n\t--OPTION (KEEPFIXED PLAN);\r\n\tPRINT \u0027C-2\u0027\r\n\tPRINT SYSDATETIME()\r\n\t\r\n\t/***************************************************/\r\n\tSELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tAssigned_DispatchRequestCount\r\n\tINTO #Assigned_DispatchRequestCount\r\n\tFROM #AllDispatchRequests ddr\r\n\tWHERE ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51)\r\n\t--AND DeliveryStartTime_Date\u003E=@todate\r\n\t--OPTION (KEEPFIXED PLAN);\r\n\tPRINT \u0027C-3\u0027\r\n\tPRINT SYSDATETIME()\r\n\t\r\n\t/***************************************************/\r\n\tSELECT COUNT (DISTINCT dr.ParcelReferenceCode) ReturnedCount\r\n\tINTO #ReturnedCount\r\n\t\t FROM #AllDispatchRequests dr\r\n        join dp.DispatchRequestStatus drs on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n        join dp.Polygon p1 on ps.PolygonId = p1.Id\r\n        --INNER JOIN @PolygonId p2\tON p1.Id = p2.Id\r\n        JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        join dp.Store s on ps.StoreId = s.Id\r\n\r\n        where (\r\n                (DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n                OR\r\n                (DispatchRequestStatusId in (45,46) and CourierRequestTypeId in (5,10,15)))\r\n--AND dr.DeliveryDeadLineTime \u003E=@todate)\r\n\r\n\r\n\tPRINT \u0027c-4\u0027\r\n\tPRINT SYSDATETIME()\r\n\t--SELECT COUNT(DISTINCT sdp.ShipmentDestinationPointId)\tReturnedCount\r\n\t--INTO #ReturnedCount\r\n\t--FROM #AllShipmentDestinationPoint sdp\r\n\t--WHERE sdp.OperationTypeId=15/*Return*/\r\n\t--AND ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t--OPTION (KEEPFIXED PLAN);\r\n\t/***************************************************/\r\n\r\n\tSELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\t\t\tDelayedPickupCount\r\n\tINTO #DelayedPickupCount\r\n\tFROM #AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #AllDispatchRequests ddr ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tWHERE ddr.DispatchRequestStatusId in (10,11,15,16)\r\n\t--AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30\r\n\tAND sdp.OperationTypeId = 5\r\n\tAND GETDATE()\u003EEstimatedArrivalTime\r\n\t--OPTION (KEEPFIXED PLAN);\r\n\tPRINT \u0027c-5\u0027\r\n\tPRINT SYSDATETIME()\r\n\t/***************************************************/\r\n\tSELECT COUNT(dISTINCT dr.ParcelReferenceCode)\tDelayedDeliveryCount\r\n\tINTO #DelayedDeliveryCount\r\n    FROM #AllDispatchRequests dr\r\n\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr with(nolock) ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\tJOIN DP.ShipmentDestinationPoint AS sdp with(nolock) ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\tWHERE sdp.OperationTypeId IN (10) \r\n\t--AND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\r\n\tAND dr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\t--OPTION (KEEPFIXED PLAN);\r\n\t/***************************************************/\r\n\t*/\r\n\t--PRINT \u0027DDD\u0027\r\n\t--PRINT SYSDATETIME()\r\n\tSELECT sh.Id shipmentId,\r\n\t\tcount(distinct shipmentdestinationpointid)DispatchRequestCount\t\r\n\t\t\t--count(sdp.ShipmentDestinationPointStatusId)DispatchRequestCount\r\n\t--AND sdp.OperationTypeId=10/*Delivery*/ THEN 1 ELSE 0 END )\tDispatchRequestsum\r\n\r\n\tINTO #TotalCount\r\n\tFROM #AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #AllDispatchRequests ddr ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tINNER JOIN dp.Shipment sh\twith(nolock)\t\tON sh.Id=sdp.ShipmentId\r\n\tINNER JOIN dp.PolygonFleet(NOLOCK) dpf\t\t\t\t\t\t\t\tON dpf.PolygonId=ddr.PolygonId  AND dpf.IsActive=1\r\n\tINNER JOIN dp.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sh.FleetId AND df.IsActive=1\r\n\tWHERE sh.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\tAND sdp.OperationTypeId IN (10/*Delivery*/,20,25)\r\n\tAND ((df.Id\t\t =@FleetId\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId,0)=0))\t\r\n\tAND ((sh.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds,\u0027\u0027)=\u0027\u0027))\r\n\tGROUP BY sh.Id\r\n\t--OPTION (KEEPFIXED PLAN);\r\n\t/****************************************************/\r\n\t--SELECT SUM(DispatchRequestCount)AS Assigned_DispatchRequestCount\r\n\t--INTO #Assigned_DispatchRequestCount\r\n\t--FROM #TotalCount\r\n\t\r\n\t/***************************************************/\r\n\tDECLARE @OperationWarningRangeTime_Second INT=DATEDIFF (SECOND,0,@OperationWarningRangeTime)\r\n\r\n--PRINT \u0027XXX\u0027\r\n--PRINT SYSDATETIME()\r\n\t\tDROP TABLE IF EXISTS #PICKUP\r\n\t\tSELECT TOP 1 WITH TIES \r\n\t\t\t\tsdpi.ShipmentId,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN ShipmentStatusId IN (5,10,15,20) THEN\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\t\tTHEN 3\r\n\t\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\tEND\r\n\t\t\t\t\tWHEN ShipmentStatusId=25 THEN 2\r\n\t\t\t\t\tWHEN ShipmentStatusId=30 THEN 4\r\n\t\t\t\t\tWHEN ShipmentStatusId NOT IN (5,10,15,20,25,30) AND EXISTS (SELECT 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFROM #AllShipmentDestinationPoint sdi\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--dp.ShipmentDestinationPoint(NOLOCK) sdi\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointStatusHistory(NOLOCK) sdpsi \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tON sdpsi.ShipmentDestinationPointId=sdi.ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE sdi.ShipmentDestinationPointId=sdpi.ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND OperationTypeId=5\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND sdpsi.ShipmentDestinationPointStatusId=25\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t) THEN 4\r\n\t\t\t\tELSE 2\r\n\t\t\t\tEND AS PickupStatus\r\n\t\t\tINTO #PICKUP\r\n\t\t\tFROM #AllShipmentDestinationPoint sdpi\r\n\t\t\tWHERE sdpi.OperationTypeId=5\r\n\t\t\tAND sdpi.ShipmentDestinationPointStatusId\u003C\u003E30\r\n\t\t\tAND ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\t\tORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n--PRINT \u0027x2\u0027\r\n--PRINT SYSDATETIME()\r\n\t\t\t\tDROP TABLE IF EXISTS #Delivery\r\n\tSELECT TOP 1 WITH TIES \r\n\t\tsdpi.ShipmentId,\r\n\t\tCASE \r\n\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) THEN 1\r\n\t\t\tWHEN ShipmentStatusId=35 THEN 4\r\n\t\t\tWHEN ShipmentStatusId IN (25,30,40) THEN\r\n\t\t\t\tCASE WHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN \r\n\t\t\t\t\t\t\t\t\t(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\t\t\tWHEN ShipmentStatusId NOT IN (25,30)\r\n\t\t\t\tAND EXISTS (\r\n\t\t\t\t\t\t\t\tSELECT 1\r\n\t\t\t\t\t\t\t\tFROM #AllShipmentDestinationPoint sdi\r\n\t\t\t\t\t\t\t\t--dp.ShipmentDestinationPoint(NOLOCK) sdi\r\n\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointStatusHistory sdpsi \r\n\t\t\t\t\t\t\t\t\t\t\t\tON sdpsi.ShipmentDestinationPointId=sdi.ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\tWHERE sdi.ShipmentDestinationPointId=sdpi.ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\tAND OperationTypeId IN (10/*Delivery*/,15/*Return*/)\r\n\t\t\t\t\t\t\t\tAND sdpsi.ShipmentDestinationPointStatusId=25\r\n\t\t\t\t\t\t\t)\r\n\t\t\tTHEN 4\r\n\t\t\tELSE 2\r\n\t\t\tEND AS DeliveryStatus\r\n\tINTO #Delivery\r\n\tFROM #AllShipmentDestinationPoint sdpi\r\n\tWHERE sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/)\r\n\tAND sdpi.ShipmentDestinationPointStatusId NOT IN (20/*Met*/,30/*Aborted*/)\r\n\tAND ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\tORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n--PRINT \u0027x3\u0027\r\n--PRINT SYSDATETIME()\r\n\t\r\n\tDROP TABLE IF EXISTS #Estimated\r\n\tSELECT TOP 1 WITH TIES  sdpi.ShipmentId,sdpi.EstimatedArrivalTime EstimatedEndDateTimeStr\r\n\tINTO #Estimated\r\n\tFROM #AllShipmentDestinationPoint sdpi\r\n\tWHERE sdpi.ShipmentDestinationPointStatusId NOT IN (30/*Aborted*/)\r\n\tAND ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\tORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t\r\n\r\n\t--PRINT \u0027GGG\u0027\r\n\t--PRINT SYSDATETIME()\r\n\tSELECT DISTINCT\r\n\t\t\tsdp.ShipmentId\t\t\t\t\t\t\tId,\r\n\t\t\tsdp.ShipmentStatusId\t\t\t\t\tStatusId,\r\n\t\t\tsdp.ShipmentStatusTitle\t\t\t\t\tStatusTitle,\r\n\t\t\tsdp.ShipmentNumber,\r\n\t\t\tsdp.TotalEstimatedDurationSeconds,\r\n\t\t\tsdp.TotalDistanceMeter,\r\n\t\t\tddr.CityId\t\t\t\t\t\t\t\tCityId,\r\n\t\t\tddr.PolygonId\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tddr.polygonTitle\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tddr.StoreId\t\t\t\t\t\t\t\tStoreId,\r\n\t\t\tddr.StoreTitle\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\tsdp.ShipmentStatusId,\r\n\t\t\tPickupStatus.PickupStatus,\r\n\t\t\tDeliveryStatus.DeliveryStatus,\r\n\t\t\tEstimatedEndDateTimeStr.EstimatedEndDateTimeStr,\r\n\r\n\t\t\tdf.Id\t\t\t\t\t\t\t\t\tFleetId,\r\n\t\t\td.Id\t\t\t\t\t\t\t\t\tDriverId,\r\n\t\t\tCONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\tDriverName,\r\n\t\t\tCONCAT(\u00270\u0027,d.Mobile)\t\t\t\t\tDriverMobile,\r\n\t\t\tdv.VehicleTypeId,\r\n\t\t\tdv.PlateNumber\r\n\tINTO #Result1\r\n\tFROM #AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #AllDispatchRequests ddr\t\t\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tINNER JOIN dp.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sdp.FleetId\t\tAND df.IsActive=1\r\n\tINNER JOIN dp.vehicle(NOLOCK) dv\t\t\t\t\t\t\t\t\tON dv.Id=df.VehicleId\r\n\tINNER JOIN DP.Driver(NOLOCK) AS d\t\t\t\t\t\t\t\t\tON d.id = df.DriverId\r\n\tLEFT JOIN #PICKUP PickupStatus ON PickupStatus.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN #Delivery DeliveryStatus ON DeliveryStatus.ShipmentId=sdp.ShipmentId\r\n\tINNER JOIN #Estimated EstimatedEndDateTimeStr ON EstimatedEndDateTimeStr.ShipmentId=sdp.ShipmentId\r\n\t\r\n\tWHERE ddr.DispatchRequestStatusId IN (10/*Assigned To Courier*/,11/*Reassigned*/,15/*Arrived at Pickup point*/,\r\n\t\t\t\t\t\t\t\t\t\t 16/*SecondFleetArrivedAtPickupPoint*/,20/*Picked up*/,25/*Arrived at Delivery Point*/,\r\n\t\t\t\t\t\t\t\t\t\t 45/*Cancel Response Pending*/,46/*Second Cancel Request Pending*/,50/*Cancel Request Rejected*/,\r\n\t\t\t\t\t\t\t\t\t\t 51/*Second Cancel Request Rejected*/)\r\n\tAND sdp.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\r\n\tAND((ddr.CityId IN (SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds,\u00270\u0027)=\u00270\u0027))\t\t\r\n\tAND ((df.Id\t\t =@FleetId\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId,0)=0))\t\r\n\tAND ((ddr.StoreId=@StoreId\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode=\u0027\u0027)\r\n\tAND (ddr.PolygonId IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\tAND ((sdp.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds,\u0027\u0027)=\u0027\u0027))\r\n\t/**/OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027), Recompile)\r\n\t/**/\r\n--PRINT \u0027WWW\u0027\r\n--PRINT SYSDATETIME()\r\n\t\r\n\r\n\r\n\tSELECT\t\tr.Id,\r\n\t\t\t\tr.StatusId,\r\n\t\t\t\tr.StatusTitle,\r\n\t\t\t\tr.ShipmentNumber,\r\n\t\t\t\tr.TotalEstimatedDurationSeconds,\r\n\t\t\t\tr.TotalDistanceMeter,\r\n\t\t\t\tr.CityId,\r\n\t\t\t\tr.PolygonId,\r\n\t\t\t\tr.PolygonTitle,\r\n\t\t\t\tr.StoreId,\r\n\t\t\t\ts.Location.STY  AS  StoreLocationLat,\r\n\t\t\t\ts.Location.STX  AS\tStoreLocationLong,\r\n\t\t\t\tr.StoreTitle,\r\n\t\t\t\tr.ShipmentStatusId,\r\n\t\t\t\tr.PickupStatus,\r\n\t\t\t\tr.DeliveryStatus,\r\n\t\t\t\tr.EstimatedEndDateTimeStr,\r\n\t\t\t\tr.FleetId,\r\n\t\t\t\tr.DriverId,\r\n\t\t\t\tr.DriverName,\r\n\t\t\t\tr.DriverMobile,\r\n\t\t\t\tr.VehicleTypeId,\r\n\t\t\t\tr.PlateNumber,\r\n\t\t\t\tISNULL(CASE \r\n\t\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20)\tTHEN PickupStatus\r\n\t\t\t\t\tWHEN ShipmentStatusId IN (25,30,35,40)\tTHEN DeliveryStatus\r\n\t\t\t\t\tELSE 0\r\n\t\t\t\tEND,0) OperationStatus\r\n\tINTO #Result\r\n\tFROM #Result1 r\r\n\tJOIN DP.Store AS s ON s.Id = r.StoreId\r\n\t--OPTION (KEEPFIXED PLAN);\r\n\r\n\r\n\r\n\tDECLARE @OrderbyValue NVARCHAR(100)\r\n\tSET @sql = \u0027\r\n\tDROP TABLE IF EXISTS #t\r\n\tSELECT\r\n\t\t\t\t\tId,\r\n\t\t\t\t\tStatusId,\r\n\t\t\t\t\tStatusTitle,\r\n\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\tTotalEstimatedDurationSeconds,\r\n\t\t\t\t\tTotalDistanceMeter,\r\n\t\t\t\t\tCityId,\r\n\t\t\t\t\tPolygonId,\r\n\t\t\t\t\tPolygonTitle,\r\n\t\t\t\t\tStoreId,\r\n\t\t\t\t\tStoreLocationLat,\r\n\t\t\t\t\tStoreLocationLong,\r\n\t\t\t\t\tStoreTitle,\r\n\t\t\t\t\tISNULL(PickupStatus,0)\t\tPickupStatus,\r\n\t\t\t\t\tISNULL(DeliveryStatus,1)\tDeliveryStatus,\r\n\t\t\t\t\tOperationStatus,\r\n\t\t\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\t\t\tFleetId,\r\n\t\t\t\t\tDriverId,\r\n\t\t\t\t\tDriverName,\r\n\t\t\t\t\tDriverMobile,\r\n\t\t\t\t\tVehicleTypeId,\r\n\t\t\t\t\tPlateNumber\r\n\t\t\t\tInto #T\r\n\tFROM #Result r\r\n\t \r\n\r\n\t/*SELECT @Result=(\r\n\r\n\t\tSELECT\ttc.TotalCount count,\r\n\r\n\t\tJSON_QUERY((*/\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tId,\r\n\t\t\t\t\tStatusId,\r\n\t\t\t\t\tStatusTitle,\r\n\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\tTotalEstimatedDurationSeconds \tTotalEstimatedDurationSeconds,\r\n\t\t\t\t\tTotalDistanceMeter,\r\n\t\t\t\t\tCityId,\r\n\t\t\t\t\tPolygonId,\r\n\t\t\t\t\tPolygonTitle,\r\n\t\t\t\t\tStoreId,\r\n\t\t\t\t\tStoreLocationLat,\r\n\t\t\t\t\tStoreLocationLong,\r\n\t\t\t\t\tStoreTitle,\r\n\t\t\t\t\tISNULL(PickupStatus,0)\t\t\t\t\t\t\t\t\t\t\t\t\tPickupStatus,\r\n\t\t\t\t\tISNULL(DeliveryStatus,1) \t\t\t\t\t\t\t\t\t\t\t\tDeliveryStatus,\r\n\t\t\t\t\tOperationStatus,\r\n\t\t\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\t\t\t(SELECT DispatchRequestCount FROM #TotalCount t where Id=t.shipmentId)\tDispatchRequestCount,\r\n\t\t\t\t\tFleetId,\r\n\t\t\t\t\tDriverId,\r\n\t\t\t\t\tDriverName,\r\n\t\t\t\t\tDriverMobile,\r\n\t\t\t\t\tVehicleTypeId,\r\n\t\t\t\t\tPlateNumber\r\n\r\n\t\t\t\tFROM #T \r\n\t\t\t\tORDER BY \u0027 \u002B\r\n\t\t\t\t\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\t\t\t\u002B  @OrderByReplace \u002B \u0027 , \u0027\r\n\t\t\t\t\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\u002B \u0027 OperationStatus DESC,\r\n\t\t\t\t\t\tEstimatedEndDateTimeStr ASC\r\n\t\t\t\t\t\t   \r\n\r\n\t\t\t/*\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t\t))Shipments,\r\n\r\n\r\n\t\t--FROM #TotalCount AS tc\r\n\r\n\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n\t)\r\n\r\n\r\n\r\n\tset @Result = REPLACE(@Result,N\u0027\u0027\\\u0027\u0027,\u0027\u0027\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022Fleet\u0022:\u0022{\u0027\u0027,\u0027\u0027\u0022Fleet\u0022:{\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022}\u0022}\u0027\u0027,\u0027\u0027\u0022}}\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027}\u0022}]}\u0027\u0027,\u0027\u0027}}]}\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027}\u0022,\u0022StoreTitle\u0022:\u0027\u0027,\u0027\u0027},\u0022StoreTitle\u0022:\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022StoreLocation\u0022:\u0022{\u0027\u0027,\u0027\u0027\u0022StoreLocation\u0022:{\u0027\u0027)\r\n\r\n\r\n\tDECLARE @TotalCount INT \r\n\tSELECT @TotalCount = tc.TotalCount FROM #TotalCount AS tc\t\r\n\tIF @TotalCount=0 \r\n\tBEGIN \r\n\t\tSET @Result=NULL\r\n\t\tRETURN \r\n\tEND\r\n\t*/\r\n\r\n\t--DECLARE @DelayedDeliveryRequestCount\t\t\t\tINT=0\r\n\t--DECLARE @DelayedPickupCount\t\t\t\t\t\tINT=0\r\n\t--DECLARE @ReturnedRequestCount\t\t\t\t\t\tINT=0\r\n\t--DECLARE @Assigned_DispatchRequestCount\t\t\tINT=0\r\n\t--DECLARE @UnassignedDispatchRequestCount\t\t\tINT=0\r\n\r\n\t--SET  @DelayedDeliveryRequestCount\t\t\t\t\t= (SELECT DelayedDeliveryCount FROM #DelayedDeliveryCount)\t\t\t\t\t\t--DelayedDeliveryCount,\r\n\t--SET  @DelayedPickupCount\t\t\t\t\t\t\t= (SELECT DelayedPickupCount FROM #DelayedPickupCount)\t\t\t\t\t\t\t--DelayedPickupCount,\r\n\t--SET  @ReturnedRequestCount\t\t\t\t\t\t\t= (SELECT ReturnedCount FROM #ReturnedCount)\t\t\t\t\t\t\t\t\t\t--ReturnedCount,\r\n\t--SET  @AssignedDispatchRequestCount\t\t\t\t\t= (SELECT Assigned_DispatchRequestCount FROM #Assigned_DispatchRequestCount)\t\t--Assigned_DispatchRequestCount,\r\n\t--SET  @UnassignedDispatchRequestCount\t\t\t\t= (SELECT UnassignedDispatchRequestCount FROM #UnassignedDispatchRequestCount)\t--UnassignedDispatchRequestCount\r\n\t--SET  @UnassignedReturnAndReplacementRequestCount\t= (select UnassignedReturnAndReplacementRequestCount from #UnassignedReturnAndReplacementRequestCount)\r\n\r\n\t\u0027\r\n\r\n\t--PRINT \u0027YYY\u0027\r\n\t--PRINT SYSDATETIME()\r\n\t-- PRINT @sql\t\r\n\tDECLARE @Param NVARCHAR(4000) =\t\u0027\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t=NULL,\r\n\t\t\t\t\t\t\t\t\t\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10)           ,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t=NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)   =NULL,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t=NULL,\r\n\r\n\t\t\t\t\t\t\t\t\t\t@DelayedDeliveryRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@DelayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@ReturnedRequestCount\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@AssignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\tOUTPUT\r\n\t\t\t\t\t\t\t\t\t\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL @sql,@Param,\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t=@OperationStaffId,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t=@CityIds,\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t=@PolygonIds,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@FleetId\t\t\t\t\t\t\t=@FleetId,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t=@StoreId,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t=@ParcelReferenceCode,\t\t\r\n\t\t\t\t\t\t\t\t\t\t@ShipmentStatusIds\t\t\t\t\t=@ShipmentStatusIds,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t=@OperationWarningRangeTime,\t\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t=@VendorParcelCode,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t=@OrderBy,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t=@IsASC\t,\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\t\t\t@DelayedDeliveryRequestCount\t\t=@DelayedDeliveryRequestCount\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@DelayedPickupCount\t\t\t\t\t=@DelayedPickupCount\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@ReturnedRequestCount\t\t\t\t=@ReturnedRequestCount\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@AssignedDispatchRequestCount\t\t=@AssignedDispatchRequestCount\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedDispatchRequestCount\t\t=@UnassignedDispatchRequestCount\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount=@UnassignedReturnAndReplacementRequestCount output\t\t\t\r\n\r\n\r\n\r\n--PRINT \u0027ZZZ\u0027\r\n--PRINT SYSDATETIME()\r\n\r\n\r\n\r\n\r\n"},{"Name":"Get_ActiveShipments_By_Filter_Pricing","Schema":"dbo","Definition":"\r\n/*\r\nDECLARE\r\n\t@TotalCount\t\t\t\t\t\t\t\t\tINT = 0 ,\r\n\t@Result\t\t\t\t\t\t\t\t\t\tNVARCHAR(max) = NULL\r\n\r\n\r\n\tEXEC Get_ActiveShipments_By_Filter_Pricing\r\n\t\t\t--@OperationStaffId = 40,\r\n\t\t\t@FleetId=4760,\r\n\t\t\t@OperationWarningRangeTime = \u002700:00\u0027,\r\n\t\t\t@MinimumDeliveryTime = \u002701:00\u0027,\r\n\t\t\t@TotalCount\t\t\t\t\t\t\t\t\t = @TotalCount\t\t\t\t\t\t\t\t\tOUTPUT,\r\n\t\t\t@Result\t\t\t\t\t\t\t\t\t\t = @Result\t\t\t\t\t\t\t\t\t\tOUTPUT\r\n\r\n\tSELECT \r\n\t\t@TotalCount,\r\n\t\t@Result\r\n*/\r\nCREATE              PROC [dbo].[Get_ActiveShipments_By_Filter_Pricing]\r\n@ProvinceId\t\t\t\t\t\t\t\t\tTinyint\t\t\t\t= null,\r\n@CityId\t\t\t\t\t\t\t\t\t\tsmallint\t\t\t= null,\r\n--@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n@PolygonIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL,\r\n@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL,\r\n@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t\t= NULL,\r\n@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL,\r\n@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10)\t\t\t= \u002700:00\u0027,\r\n@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10)\t\t\t= \u002701:00\u0027,\r\n@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t\t= NULL,\r\n@ShipmentCreateDate\t\t\t\t\t\t\tBIGINT\t\t\t\t= NULL,\r\n@ShipmentNumber\t\t\t\t\t\t\t\tBIGINT\t\t\t\t= NULL,\r\n@VendorID\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL,\r\n@CourierRequestTypeIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL,\r\n@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL,\r\n@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= 0,\r\n@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= 10,\r\n@Result\t\t\t\t\t\t\t\t\t\tNVARCHAR(max) OUTPUT\r\n/*\r\n\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL ,\r\n\t@PolygonIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL,\r\n\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t\t=NULL ,\r\n\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t=NULL ,\r\n\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10) = \u002700:00\u0027,\r\n\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10) = \u002701:00\u0027,\r\n\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t\t= NULL,\r\n\t@ShipmentCreateDate\t\t\t\t\t\t\tBIGINT = NULL,\r\n\t@ShipmentNumber\t\t\t\t\t\t\t\tBIGINT = NULL,\r\n\t@VendorID\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL,\r\n\t@CourierRequestTypeIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL,\r\n\t@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX) = NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= 0,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= 10,--=10,\t\r\n\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t--@DelayedDeliveryRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t--@DelayedPickupCount\t\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t--@ReturnedRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t--@AssignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t--@UnassignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,   \r\n\t--@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t--@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0 OUTPUT,\r\n\t@Result\t\t\t\t\t\t\t\t\t\tNVARCHAR(max) OUTPUT\r\n*/\r\n--WITH RECOMPILE\r\nAS\r\nSET NOCOUNT ON\r\n\r\n\r\nDECLARE\r\n\t@TotalCount\t\t\t\t\t\t\t\t\t\tINT,\r\n\t--@OperationStaffId_Local\t\t\t\t\t\t\tINT ,\r\n\t--@CityIds_Local\t\t\t\t\t\t\t\t\tVARCHAR(200)\t\t= NULL ,\r\n\t@PolygonIds_Local\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@FleetId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@StoreId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@ParcelReferenceCode_Local\t\t\t\t\t\tBIGINT\t\t\t\t= NULL ,\r\n\t@ShipmentStatusIds_Local\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@OperationWarningRangeTime_Local\t\t\t\tVARCHAR(10),\t\t  \r\n\t@MinimumDeliveryTime_Local\t\t\t\t\t\tVARCHAR(10),---\t\t  \r\n\t@VendorParcelCode_Local\t\t\t\t\t\t\tVARCHAR(32)\t\t\t= NULL ,\r\n\t@OrderBy_Local\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL ,\r\n\t@IsASC_Local\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL ,\r\n\t@VendorID_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@CourierRequestTypeIds_Local\t\t\t\t\tVARCHAR(MAX)\t\t= NULL\r\n\r\n\t--SET @OperationStaffId_Local\t\t\t\t = @OperationStaffId\r\n\t--SET @CityIds_Local\t\t\t\t\t\t = @CityIds\r\n\tSET @PolygonIds_Local\t\t\t\t\t = @PolygonIds\r\n\tSET @FleetId_Local\t\t\t\t\t\t = @FleetId\r\n\tSET @StoreId_Local\t\t\t\t\t\t = @StoreId\r\n\tSET @ParcelReferenceCode_Local\t\t\t = @ParcelReferenceCode\r\n\tSET @ShipmentStatusIds_Local\t\t\t = @ShipmentStatusIds\r\n\tSET @OperationWarningRangeTime_Local\t = @OperationWarningRangeTime\r\n\tSET @MinimumDeliveryTime_Local\t\t\t = @MinimumDeliveryTime\r\n\tSET @VendorParcelCode_Local\t\t\t\t = @VendorParcelCode\r\n\tSET @VendorID_Local\t\t\t\t\t\t = @VendorID\r\n\tSET @OrderBy_Local\t\t\t\t\t\t = @OrderBy\r\n\tSET @IsASC_Local\t\t\t\t\t\t = @IsASC\r\n\tSET @CourierRequestTypeIds_Local\t\t = @CourierRequestTypeIds\r\n\r\n\r\n\tSET @DeliveryServiceProviderIds = ISNULL(@DeliveryServiceProviderIds,\u00270\u0027)\r\n\tSET @CourierRequestTypeIds_Local = ISNULL(@CourierRequestTypeIds_Local,\u00270\u0027)\r\n\r\n\tDROP TABLE IF EXISTS #DeliveryServiceProviderId,#CourierRequestTypeID,#OUTPUT\r\n\r\n\tSELECT \r\n\t\tdsp.Id\r\n\tINTO #DeliveryServiceProviderId\r\n\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceProviderIds,\u0027,\u0027) ss\r\n\t\tON dsp.Id = ss.value\r\n\t\tOR @DeliveryServiceProviderIds = \u00270\u0027\r\n\r\n\tSELECT \r\n\t\tcrt.Id\r\n\tINTO #CourierRequestTypeID\r\n\tFROM CS_Public.PUB.CourierRequestType crt (NOLOCK)\r\n\tINNER JOIN string_split(@CourierRequestTypeIds_Local,\u0027,\u0027) ss\r\n\t\tON crt.Id = ss.value\r\n\t\tOR @CourierRequestTypeIds_Local = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t(\r\n\t\tId\r\n\t)\r\n\r\n\tdeclare @sql1 nvarchar(max),\r\n\t\t\t@sql2 nvarchar(max),\r\n\t\t\t@sql nvarchar(max)\r\n\r\n    DECLARE @StartRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u0027000\u0027\r\n                                            ) as BIGINT)),\r\n            @EndRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002723\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u0027999\u0027\r\n                                            ) as BIGINT))\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\tDECLARE @PolygonId\tTABLE \r\n\t(\r\n\t\tId\tSMALLINT\r\n\t)\r\n\tINSERT INTO @PolygonId\r\n\tSELECT value\r\n\tFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\r\n\tDROP TABLE IF EXISTS #ShipmentStatusId\r\n\tCREATE TABLE #ShipmentStatusId\t \r\n\t(\r\n\t\tId\tTINYINT\r\n\t)\r\n\tINSERT INTO #ShipmentStatusId\r\n\tSELECT shs.Id\r\n\tFROM DP.ShipmentStatus shs (NOLOCK)\r\n\tINNER JOIN string_split(ISNULL(@ShipmentStatusIds_Local,\u00270\u0027),\u0027,\u0027) ss\r\n\t\tON shs.Id = ss.value\r\n\t\tOR ISNULL(@ShipmentStatusIds_Local,\u00270\u0027) = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#ShipmentStatusId ON #ShipmentStatusId\r\n\t(\r\n\t\tId\r\n\t)\r\n\r\n\t--@CityIds\r\n\t/*\r\n\tDECLARE @CityId\tTABLE \r\n\t(\r\n\t\tId\tSMALLINT\r\n\t)\r\n\tINSERT INTO @CityId\r\n\tSELECT VALUE\r\n\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\t*/\r\n\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-12,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-12, 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE @Today INT=  CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\tDROP TABLE IF EXISTS \r\n\t\t\t#Result,\r\n\t\t\t#Result1,\r\n\t\t\t#TotalCount,\r\n\t\t\t#AllDispatchRequests,\r\n\t\t\t#UnassignedDispatchRequestCount,\r\n\t\t\t#UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t#AllShipmentDestinationPoint,\r\n\t\t\t#Assigned_DispatchRequestCount,\r\n\t\t\t#DelayedPickupCount,\r\n\t\t\t#DelayedDeliveryCount,\r\n\t\t\t#ReturnedCount\r\n\r\n\tDECLARE @Now int=LEFT(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),8),\r\n\t\t@Yesterday int = LEFT(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),8)\r\n\r\n\r\n\t--;WITH CTE_DR AS\r\n\t--(\r\n\t--SELECT\t\r\n\t--\tddr.DispatchRequestStatusId,\r\n\t--\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t--\tddr.CourierRequestTypeId ,\r\n\t--\tddr.ParcelReferenceCode,\r\n\t--\tsdp.OperationTypeId,\r\n\t--\tddr.IsWaitingForSupport\r\n\t--FROM DP.DispatchRequest(NOLOCK) ddr\r\n\t--INNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t--INNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t--INNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t--LEFT JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t--\tON ddr.id=sdpdr.DispatchRequestId\r\n\t--LEFT JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t--\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t--\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t--\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\t--LEFT JOIN dP.Shipment(NOLOCK) ds\r\n\t--\tON ds.Id=sdp.ShipmentId\r\n\t--\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\t--INNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t--INNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t--INNER JOIN #DeliveryServiceProviderId dspID\r\n\t--\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\t--INNER JOIN #CourierRequestTypeID crtID\r\n\t--\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t--WHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\t--AND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\t--AND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\t--AND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\t--AND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\t--AND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\t--AND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\r\n\t--AND\r\n\t--(\r\n\t--\t(ddr.DispatchRequestStatusId in (5,6) AND CAST(DeliveryStartTime/1000000000 AS BIGINT)IN(@Now,@Yesterday))\r\n\t--\tOR\r\n\t--\t(ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70))\r\n\t--\tOR\r\n\t--\t(ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51))\r\n\t--\tOR\r\n\t--\t( (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) )\r\n\t--\tOR\r\n\t--\t(  sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) )\r\n\t--\tOR\r\n\t--\t( sdp.OperationTypeId = (10) AND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) )\r\n\t--)\r\n\t--)\r\n\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t--\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t--\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t--\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t--\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t--\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount),\r\n\t--\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\t--FROM\r\n\t--(\r\n\t--\tSELECT \r\n\t--\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date IN(@Now,@Yesterday) THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t--\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t--\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t--\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t--\t\tCASE WHEN ddr.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t--\t\tCASE WHEN \r\n\t--\t\t\tddr.OperationTypeId = (10)  \r\n\t--\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t--\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount,\r\n\t--\t\tCASE \r\n\t--\t\t\tWHEN \r\n\t--\t\t\t\tIsWaitingForSupport = 1 \r\n\t--\t\t\t\tAND DispatchRequestStatusId IN ( 15,16 ) \r\n\t--\t\t\tTHEN ParcelReferenceCode\r\n\t--\t\t\tELSE NULL \r\n\t--\t\tEND AS NotPickupRequestCount\r\n\t--\tFROM CTE_DR ddr\r\n\t--) SQ\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\t/***************************************************/\r\n\tDECLARE @OperationWarningRangeTime_Second INT=DATEDIFF (SECOND,0,@OperationWarningRangeTime)\r\n\r\n\tSELECT\t\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\t\tddr.CourierRequestTypeId ,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t sdp.OperationTypeId,\r\n\t\t\tddr.Id DispatchRequestId,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\tsdp.ID  AS ShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId ,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\tddr.VendorId,\r\n\t\t\tv.BrandName AS VendorBrandName\r\n\tINTO #CTE_DR\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN CS_Public.Haf.City AS c (NOLOCK) ON dp.CityId = c.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t--AND sdp.OperationTypeId IN ( 5,10 )\r\n\t\t--AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\tON ddr.VendorId = v.Id\r\n\tWHERE\r\n\t--pos.OperationStaffId=@OperationStaffId_Local\r\n\t--AND\r\n\t--((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\t(@CityId is null Or dp.CityId = @CityId)\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\tAND (ds.ShipmentNumber = @ShipmentNumber OR ISNULL(@ShipmentNumber,0) = 0)\r\n\tAND (dp.CityId = @CityId OR ISNULL(@CityId , 0) = 0)\r\n\tAND (c.ProvinceId = @ProvinceId OR ISNULL(@ProvinceId,0) = 0)\r\n\tAND (ds.CreateDate = @ShipmentCreateDate OR ISNULL(@ShipmentCreateDate,0)=0)\r\n\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0)=0)\r\n\t--AND ddr.DeliveryServiceProviderId = @DeliveryServiceProviderId_Local OR ISNULL(@DeliveryServiceProviderId_Local,0) = 0\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\tCREATE INDEX IX_#CTE_DR ON #CTE_DR\r\n\t(\r\n\t\tShipmentId,\r\n\t\tDispatchRequestId,\r\n\t\tStoreId,\r\n\t\t[OperationTypeId],\r\n\t\t[ShipmentDestinationPointStatusId]\r\n\t)INCLUDE ([DispatchRequestStatusId],[DeliveryStartTime_Date],[CourierRequestTypeId],[ParcelReferenceCode],[PolygonStoreId],[PolygonId],[PolygonTitle],[StoreTitle],[CityId],[VendorParcelCode],[EstimatedOperationTimeSeconds],[EstimatedArrivalTime],[ShipmentDestinationPointId],[SequenceNumber],[DeliveryServiceProviderId],[VendorId],[VendorBrandName])\r\n\r\n\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdp.*,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\t--dss.Id\t\tShipmentStatusId,\r\n\t\t\t--dss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId \r\n\t\tINTO #CTE_Shipment\r\n\t\tFROM #CTE_DR  sdp\r\n\t\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\tINNER JOIN #ShipmentStatusId ssid\r\n\t\t\tON ds.ShipmentStatusId = ssid.Id\r\n\t\tAND ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\t\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\t\tAND sdp.OperationTypeId IN (5,10/*Delivery*/,15,20,25,30)\r\n\r\n\r\n\r\n\r\n\t;WITH CTE_AllShipmentDestinationPoint AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tds.ShipmentDestinationPointId,\r\n\t\t\tds.ShipmentDestinationPointStatusId,\r\n\t\t\tds.OperationTypeId,\r\n\t\t\tds.DispatchRequestId,\r\n\t\t\tds.ShipmentId,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tds.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tDATEADD(SECOND,ds.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(ds.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))EstimatedArrivalTime\r\n\t\t--INTO #AllShipmentDestinationPoint\r\n\t\tFROM #CTE_Shipment ds\r\n\t\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t\tWHERE dss.Id NOT IN ( 45,50,55,100 )\r\n\t), CTE_PickupStatus AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdpi.ShipmentId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN ShipmentStatusId = 25 THEN 2\r\n\t\t\t\tWHEN ShipmentStatusId = 30 THEN 4\r\n\t\t\t\tWHEN ShipmentStatusId IN (35,40) \r\n\t\t\t\tTHEN\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN HasDP = 1\r\n\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\tWHEN HasDP = 0 \r\n\t\t\t\t\t\tTHEN 2\r\n\t\t\t\t\tEND\r\n\t\t\t\t\t\t\r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) AND sdpi.SequenceNumber = sdpi.FS THEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\r\n\t\t\tELSE 5 END PickupStatus\t\t\t\t\t\r\n\t\tFROM \r\n\t\t(\r\n\t\t\tSELECT * FROM \r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tShipmentId , \r\n\t\t\t\t\tShipmentStatusId, \r\n\t\t\t\t\tOperationTypeId , \r\n\t\t\t\t\tShipmentDestinationPointStatusId , \r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tFIRST_VALUE(SQ.FS) OVER (PARTITION BY SQ.ShipmentId ORDER BY SQ.FS DESC) FS ,\r\n\t\t\t\t\tFIRST_VALUE(SQ.HasDP) OVER (PARTITION BY SQ.ShipmentId ORDER BY SQ.HasDP DESC) HasDP ,\r\n\t\t\t\t\tEstimatedArrivalTime\r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tDISTINCT CASE WHEN ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) THEN \r\n\t\t\t\t\t\t\tsdpi.SequenceNumber \r\n\t\t\t\t\t\tELSE 0 END FS,\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN ShipmentStatusId IN ( 35,40 ) AND OperationTypeId IN ( 5,20 ) AND ShipmentDestinationPointStatusId = 25 THEN 1 \r\n\t\t\t\t\t\t\tELSE 0 \r\n\t\t\t\t\t\tEND HasDP,\r\n\t\t\t\t\t\t* \r\n\t\t\t\t\tFROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\t\t\t) SQ\r\n\t\t\t) sdpi\r\n\t\t\tWHERE \r\n\t\t\t\tsdpi.ShipmentStatusId = 25\r\n\t\t\t\tOR ShipmentStatusId = 30\r\n\t\t\t\tOR ShipmentStatusId IN (35,40)\r\n\t\t\t\tOR (ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) AND sdpi.SequenceNumber = sdpi.FS)\r\n\t\t) sdpi\r\n\t), CTE_Delivery AS\r\n\t(\r\n\t\t\tSELECT DISTINCT \r\n\t\t\tsdpi.ShipmentId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) THEN 1\r\n\t\t\t\tWHEN ShipmentStatusId=35 THEN 4\r\n\t\t\t\tWHEN ShipmentStatusId IN (25,30,40) AND sdpi.SequenceNumber = sdpi.FS THEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\t\t\tEND DeliveryStatus\r\n\t\t\t\t\r\n\t\tFROM \r\n\t\t(\r\n\t\t\t\r\n\t\t\tSELECT * FROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tShipmentId , \r\n\t\t\t\t\tShipmentStatusId, \r\n\t\t\t\t\tOperationTypeId , \r\n\t\t\t\t\tShipmentDestinationPointStatusId , \r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\t\tFIRST_VALUE(sdpi.FS) OVER (PARTITION BY sdpi.ShipmentId ORDER BY sdpi.FS DESC) FS \r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT CASE WHEN ShipmentStatusId IN (25,30,40) THEN sdpi.SequenceNumber  ELSE 0 END FS, * FROM CTE_AllShipmentDestinationPoint sdpi WHERE sdpi.ShipmentDestinationPointStatusId \u003C\u003E 40\r\n\t\t\t\t) sdpi\r\n\t\t\t) SDPI\r\n\t\t\tWHERE \r\n\t\t\t\tsdpi.ShipmentStatusId IN (5,6,10,15,20)\r\n\t\t\t\tOR ShipmentStatusId=35\r\n\t\t\t\tOR (ShipmentStatusId IN (25,30,40) AND sdpi.SequenceNumber = sdpi.FS)\r\n\t\t\t) sdpi\r\n\t\t--ORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t), CTE_Estimated AS\r\n\t(\r\n\t\r\n\t\tSELECT TOP 1 WITH TIES  sdpi.ShipmentId,sdpi.EstimatedArrivalTime EstimatedEndDateTimeStr\r\n\t\tFROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\tWHERE sdpi.ShipmentDestinationPointStatusId NOT IN (30/*Aborted*/)\r\n\t\t--AND ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\tORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t), CTE_TotalCount AS\r\n\t(\r\n\r\n\t\tSELECT sh.Id shipmentId,\r\n\t\t\tcount(distinct ShipmentDestinationPointId)DispatchRequestCount\t\r\n\t\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\t\t--INNER JOIN CTE_DR ddr ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t\tINNER JOIN dp.Shipment sh\twith(nolock)\t\tON sh.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN dp.PolygonFleet(NOLOCK) dpf\t\t\t\t\t\t\t\tON dpf.PolygonId=ddr.PolygonId  AND dpf.IsActive=1\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sh.FleetId AND df.IsActive=1\r\n\t\tINNER JOIN #ShipmentStatusId ssid\r\n\t\t\tON sh.ShipmentStatusId = ssid.Id\r\n\t\tWHERE sh.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\t\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t\tAND ((df.Id\t\t =@FleetId\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\t\t--AND ((sh.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\t\tGROUP BY sh.Id\r\n\t), CTE_IsReturnToStoreRequired AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tShipmentId,\r\n\t\t\tCAST(IsReturnToStoreRequired AS BIT ) IsReturnToStoreRequired\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tSQ.ShipmentId,\r\n\t\t\t\tFIRST_VALUE(IsReturnToStoreRequired) OVER ( PARTITION BY SQ.ShipmentId ORDER BY IsReturnToStoreRequired DESC ) IsReturnToStoreRequired,\r\n\t\t\t\tFIRST_VALUE(HasDelivery) OVER ( PARTITION BY SQ.ShipmentId ORDER BY HasDelivery DESC) HasDelivery\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tsdp.ShipmentId,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId = 30 AND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35,40 ) AND sdpdr.DispatchRequestId IS NULL THEN 1 ELSE 0 END IsReturnToStoreRequired,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId \u003C\u003E 30 AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ) THEN 1 ELSE 0 END HasDelivery\r\n\t\t\t\tFROM #CTE_Shipment s\r\n\t\t\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\t\tON s.ShipmentId = sdp.ShipmentId\r\n\t\t\t\tLEFT JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\t\t\tWHERE sdp.OperationTypeId = 30\r\n\t\t\t\tOR (sdp.OperationTypeId \u003C\u003E 30 AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ))\r\n\t\t\t) SQ\r\n\t\t) SQ\r\n\t\tWHERE SQ.HasDelivery = 0\r\n\t)\r\n\r\n\tSELECT * INTO #Output FROM \r\n\t(\r\n\tSELECT DISTINCT\r\n\t\t\tsdp.ShipmentId\t\t\t\t\t\t\tId,\r\n\t\t\tsdp.ShipmentStatusId\t\t\t\t\tStatusId,\r\n\t\t\tsdp.ShipmentStatusTitle\t\t\t\t\tStatusTitle,\r\n\t\t\tsdp.ShipmentNumber,\r\n\t\t\tsdp.TotalEstimatedDurationSeconds,\r\n\t\t\tsdp.TotalDistanceMeter,\r\n\t\t\tddr.CityId\t\t\t\t\t\t\t\tCityId,\r\n\t\t\tddr.PolygonId\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tddr.polygonTitle\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tddr.StoreId\t\t\t\t\t\t\t\tStoreId,\r\n\t\t\ts.Location.STY  AS  StoreLocationLat,\r\n\t\t\ts.Location.STX  AS\tStoreLocationLong,\r\n\t\t\tddr.StoreTitle\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\t--sdp.ShipmentStatusId,\r\n\t\t\tPickupStatus.PickupStatus,\r\n\t\t\tDeliveryStatus.DeliveryStatus,\r\n\t\t\tISNULL(CASE \r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20)\tTHEN PickupStatus\r\n\t\t\t\tWHEN ShipmentStatusId IN (25,30,35,40)\tTHEN DeliveryStatus\r\n\t\t\t\tELSE 0\r\n\t\t\tEND,0) OperationStatus,\r\n\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\tISNULL(tc.DispatchRequestCount,0) DispatchRequestCount, --(SELECT DispatchRequestCount FROM CTE_TotalCount t where shipmentId=t.shipmentId)\tDispatchRequestCount,\r\n\t\t\tdf.Id\t\t\t\t\t\t\t\t\tFleetId,\r\n\t\t\td.Id\t\t\t\t\t\t\t\t\tDriverId,\r\n\t\t\tCONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\tDriverName,\r\n\t\t\tCONCAT(\u00270\u0027,d.Mobile)\t\t\t\t\tDriverMobile,\r\n\t\t\tdv.VehicleTypeId,\r\n\t\t\tdv.PlateNumber,\r\n\t\t\tISNULL(rtsr.IsReturnToStoreRequired,0) IsReturnToStoreRequired,\r\n\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\tc.Name AS cityTitle,\r\n\t\t\tp.Name AS provinceTitle,\r\n\t\t\tc.ProvinceId\r\n\r\n\t\r\n\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #CTE_DR ddr\t\t\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tJOIN DP.Store AS s with(nolock) ON s.Id = ddr.StoreId\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sdp.FleetId\t\tAND df.IsActive=1\r\n\tINNER JOIN CS_DriverManagement.DM.vehicle(NOLOCK) dv\t\t\t\t\t\t\t\t\tON dv.Id=df.VehicleId\r\n\tINNER JOIN CS_DriverManagement.DM.Driver(NOLOCK) AS d\t\t\t\t\t\t\t\t\tON d.id = df.DriverId\r\n\tINNER JOIN CS_Public.Haf.City AS c ON ddr.CityId = c.Id\r\n\tINNER JOIN CS_Public.Haf.Province AS p ON c.ProvinceId = p.Id\r\n\tLEFT JOIN CTE_PickupStatus PickupStatus ON PickupStatus.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_Delivery DeliveryStatus ON DeliveryStatus.ShipmentId=sdp.ShipmentId\r\n\tINNER JOIN CTE_Estimated EstimatedEndDateTimeStr ON EstimatedEndDateTimeStr.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_TotalCount tc ON  sdp.ShipmentId = tc.shipmentId\r\n\tLEFT JOIN CTE_IsReturnToStoreRequired rtsr\r\n\t\tON sdp.ShipmentId = rtsr.ShipmentId\r\n\tWHERE (ddr.DispatchRequestStatusId IN (10/*Assigned To Courier*/,11/*Reassigned*/,15/*Arrived at Pickup point*/,\r\n\t\t\t\t\t\t\t\t\t\t 16/*SecondFleetArrivedAtPickupPoint*/,20/*Picked up*/,25/*Arrived at Delivery Point*/,\r\n\t\t\t\t\t\t\t\t\t\t 45/*Cancel Response Pending*/,46/*Second Cancel Request Pending*/,47,48,49,52,53,54,50/*Cancel Request Rejected*/,\r\n\t\t\t\t\t\t\t\t\t\t 51/*Second Cancel Request Rejected*/)  OR rtsr.IsReturnToStoreRequired IS NOT NULL )\r\n\tAND sdp.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t--AND((ddr.CityId IN (SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds,\u00270\u0027)=\u00270\u0027))\t\t\r\n\tAND ((df.Id\t\t =@FleetId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\tAND ((ddr.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\t--AND (sdp.ShipmentNumber = @ShipmentNumber OR ISNULL(@ShipmentNumber,0) = 0)\r\n\t--AND (ddr.PolygonId IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\t--AND ((sdp.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds,\u0027\u0027)=\u0027\u0027))\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027), Recompile)\r\n\t--OPTION(MAXDOP 1)\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t--OPTION(Recompile)\r\n\t\r\n\t) SQ\r\n\r\n\tSET @TotalCount = @@ROWCOUNT\r\n\r\n\r\n\r\n\r\n\t--SET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\n\t--SET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\t--SET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\t--SET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\t--SET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\t--SET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\t--SET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\n/*\r\n\tSELECT @Result=(\r\n\r\n\t\tSELECT\t*\r\n\t\tFROM #Output\r\n\t\t\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n\t)\r\n*/\r\n\tSELECT @Result\t= \r\n\t(\r\n\t\tSELECT tb.id,\r\n               tb.statusId,\r\n               tb.statusTitle,\r\n               tb.shipmentNumber,\r\n               tb.totalEstimatedDurationSeconds,\r\n               tb.totalDistanceMeter,\r\n               tb.cityId,\r\n               tb.polygonId,\r\n               tb.polygonTitle,\r\n               tb.storeId,\r\n               tb.storeLocationLat,\r\n               tb.storeLocationLong\t,\r\n               tb.storeTitle,\r\n               tb.pickupStatus,\r\n               tb.deliveryStatus,\r\n               tb.operationStatus,\r\n               tb.estimatedEndDateTimeStr,\r\n               tb.dispatchRequestCount,\r\n               tb.fleetId,\r\n               tb.driverId,\r\n               tb.driverName,\r\n               tb.driverMobile,\r\n               tb.vehicleTypeId,\r\n               tb.plateNumber,\r\n               tb.isReturnToStoreRequired,\r\n               tb.deliveryServiceProviderId,\r\n\t\t\t   tb.cityTitle,\r\n\t\t\t   tb.provinceTitle,\r\n\t\t\t   tb.provinceId\r\n\t\tFROM #Output tb\t\t\r\n\t\tORDER BY tb.Id DESC\r\n\t\tOFFSET (@pageIndex * @pageSize) ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\t\tFOR JSON PATH ,ROOT(\u0027result\u0027)\r\n\t)\r\n\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.totalCount\u0027,@TotalCount)\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.pageSize\u0027,@PageSize  )\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.pageIndex\u0027,@PageIndex )\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.totalPages\u0027,(@TotalCount \u002B @PageSize - 1) / @PageSize)\r\n"},{"Name":"Get_ActiveShipments_By_Filter_WithPaging","Schema":"dbo","Definition":"\r\nCREATE                PROC [dbo].[Get_ActiveShipments_By_Filter_WithPaging]\r\n\r\n\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL ,\r\n\t@PolygonIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t\t=NULL,\r\n\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t=NULL ,\r\n\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t\t=NULL ,\r\n\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t=NULL ,\r\n\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),---\r\n\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t\t=NULL,\r\n\t@VendorID\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL,\r\n\t@CourierRequestTypeIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL,\r\n\t@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX) = NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,   \r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0 OUTPUT\r\n--WITH RECOMPILE\r\nAS\r\nSET NOCOUNT ON\r\n--SET STATISTICS TIME ON\r\n\r\n\r\n--PRINT \u002700000\u0027\r\n--PRINT SYSDATETIME()\r\n\r\nDECLARE \r\n\t@OperationStaffId_Local\t\t\t\t\t\t\tINT ,\r\n\t@CityIds_Local\t\t\t\t\t\t\t\t\tVARCHAR(200)\t\t= NULL ,\r\n\t@PolygonIds_Local\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@FleetId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@StoreId_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@ParcelReferenceCode_Local\t\t\t\t\t\tBIGINT\t\t\t\t= NULL ,\r\n\t@ShipmentStatusIds_Local\t\t\t\t\t\tNVARCHAR(MAX)\t\t= NULL ,\r\n\t@OperationWarningRangeTime_Local\t\t\t\tVARCHAR(10),\t\t  \r\n\t@MinimumDeliveryTime_Local\t\t\t\t\t\tVARCHAR(10),---\t\t  \r\n\t@VendorParcelCode_Local\t\t\t\t\t\t\tVARCHAR(32)\t\t\t= NULL ,\r\n\t@OrderBy_Local\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL ,\r\n\t@IsASC_Local\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL ,\r\n\t@VendorID_Local\t\t\t\t\t\t\t\t\tINT\t\t\t\t\t= NULL ,\r\n\t@CourierRequestTypeIds_Local\t\t\t\t\tVARCHAR(MAX)\t\t= NULL\r\n\r\n\tSET @OperationStaffId_Local\t\t\t\t = @OperationStaffId\r\n\tSET @CityIds_Local\t\t\t\t\t\t = @CityIds\r\n\tSET @PolygonIds_Local\t\t\t\t\t = @PolygonIds\r\n\tSET @FleetId_Local\t\t\t\t\t\t = @FleetId\r\n\tSET @StoreId_Local\t\t\t\t\t\t = @StoreId\r\n\tSET @ParcelReferenceCode_Local\t\t\t = @ParcelReferenceCode\r\n\tSET @ShipmentStatusIds_Local\t\t\t = @ShipmentStatusIds\r\n\tSET @OperationWarningRangeTime_Local\t = @OperationWarningRangeTime\r\n\tSET @MinimumDeliveryTime_Local\t\t\t = @MinimumDeliveryTime\r\n\tSET @VendorParcelCode_Local\t\t\t\t = @VendorParcelCode\r\n\tSET @VendorID_Local\t\t\t\t\t\t = @VendorID\r\n\tSET @OrderBy_Local\t\t\t\t\t\t = @OrderBy\r\n\tSET @IsASC_Local\t\t\t\t\t\t = @IsASC\r\n\tSET @CourierRequestTypeIds_Local\t\t = @CourierRequestTypeIds\r\n\r\n\r\n\tSET @DeliveryServiceProviderIds = ISNULL(@DeliveryServiceProviderIds,\u00270\u0027)\r\n\tSET @CourierRequestTypeIds_Local = ISNULL(@CourierRequestTypeIds_Local,\u00270\u0027)\r\n\r\n\tDROP TABLE IF EXISTS #DeliveryServiceProviderId,#CourierRequestTypeID,#OUTPUT\r\n\r\n\tSELECT \r\n\t\tdsp.Id\r\n\tINTO #DeliveryServiceProviderId\r\n\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceProviderIds,\u0027,\u0027) ss\r\n\t\tON dsp.Id = ss.value\r\n\t\tOR @DeliveryServiceProviderIds = \u00270\u0027\r\n\r\n\tSELECT \r\n\t\tcrt.Id\r\n\tINTO #CourierRequestTypeID\r\n\tFROM CS_Public.PUB.CourierRequestType crt (NOLOCK)\r\n\tINNER JOIN string_split(@CourierRequestTypeIds_Local,\u0027,\u0027) ss\r\n\t\tON crt.Id = ss.value\r\n\t\tOR @CourierRequestTypeIds_Local = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t(\r\n\t\tId\r\n\t)\r\n\r\n\tdeclare @sql1 nvarchar(max),\r\n\t\t\t@sql2 nvarchar(max),\r\n\t\t\t@sql nvarchar(max)\r\n\r\n    DECLARE @StartRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u002700\u0027\r\n                                            ,\u0027000\u0027\r\n                                            ) as BIGINT)),\r\n            @EndRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n                                            ,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n                                            ,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n                                            ,\u002723\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u002759\u0027\r\n                                            ,\u0027999\u0027\r\n                                            ) as BIGINT))\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\tDECLARE @PolygonId\tTABLE \r\n\t(\r\n\t\tId\tSMALLINT\r\n\t)\r\n\tINSERT INTO @PolygonId\r\n\tSELECT value\r\n\tFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\r\n\r\n\t--DROP TABLE IF EXISTS #Polygon\r\n\t--SELECT p.ID INTO #Polygon \r\n\t--FROM dp.Polygon p\r\n\t--INNER JOIN string_split(ISNULL(@PolygonIds,\u0027\u0027),\u0027,\u0027) ss\r\n\t--\tON p.ID = ss.value\r\n\t--\tOR ISNULL(@PolygonIds,\u0027\u0027) = \u0027\u0027\r\n\r\n\t---\r\n\t--DECLARE @ShipmentStatusId\tTABLE \r\n\t--(\r\n\t--\tId\tTINYINT\r\n\t--)\r\n\t--INSERT INTO @ShipmentStatusId\r\n\t--SELECT value\r\n\t--FROM string_split(@ShipmentStatusIds,\u0027,\u0027)\r\n\tDROP TABLE IF EXISTS #ShipmentStatusId\r\n\tCREATE TABLE #ShipmentStatusId\t \r\n\t(\r\n\t\tId\tTINYINT\r\n\t)\r\n\tINSERT INTO #ShipmentStatusId\r\n\tSELECT shs.Id\r\n\tFROM DP.ShipmentStatus shs (NOLOCK)\r\n\tINNER JOIN string_split(ISNULL(@ShipmentStatusIds_Local,\u00270\u0027),\u0027,\u0027) ss\r\n\t\tON shs.Id = ss.value\r\n\t\tOR ISNULL(@ShipmentStatusIds_Local,\u00270\u0027) = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#ShipmentStatusId ON #ShipmentStatusId\r\n\t(\r\n\t\tId\r\n\t)\r\n\r\n\t--@CityIds\r\n\tDECLARE @CityId\tTABLE \r\n\t(\r\n\t\tId\tSMALLINT\r\n\t)\r\n\tINSERT INTO @CityId\r\n\tSELECT VALUE\r\n\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\t--DROP TABLE IF EXISTS #CityID\r\n\t--SELECT p.CityId INTO #CityID FROM DP.Polygon p\r\n\t--INNER JOIN string_split(ISNULL(@CityIds,\u00270\u0027),\u0027,\u0027) ss\r\n\t--\tON p.ID = ss.value\r\n\t--\tOR ISNULL(@CityIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\t--deliveryDeadlineTime\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-12,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-12, 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE @Today INT=  CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\tDROP TABLE IF EXISTS \r\n\t\t\t#Result,\r\n\t\t\t#Result1,\r\n\t\t\t#TotalCount,\r\n\t\t\t#AllDispatchRequests,\r\n\t\t\t#UnassignedDispatchRequestCount,\r\n\t\t\t#UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t#AllShipmentDestinationPoint,\r\n\t\t\t#Assigned_DispatchRequestCount,\r\n\t\t\t#DelayedPickupCount,\r\n\t\t\t#DelayedDeliveryCount,\r\n\t\t\t#ReturnedCount\r\n\r\n\tDECLARE @Now int=LEFT(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),8),\r\n\t\t@Yesterday int = LEFT(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),8)\r\n\r\n\t--SET @DelayedDeliveryRequestCount = NULL\r\n\t--SET @DelayedPickupCount = NULL\r\n\t--SET @ReturnedRequestCount = NULL\r\n\t--SET @AssignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedReturnAndReplacementRequestCount = NULL\r\n\t--SET @NotPickupRequestCount = NULL\r\n\r\n\t--EXEC Get_OperationPanel_Count\r\n\t--\t\t@OperationStaffId = @OperationStaffId_Local,\r\n\t--\t\t@CityIds = @CityIds_Local,\r\n\t--\t\t@PolygonIds = @PolygonIds_Local,\r\n\t--\t\t@VendorID = @VendorID_Local,\r\n\t--\t\t@UnassignedDispatchRequestCount\t\t\t\t = @UnassignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t\t@AssignedDispatchRequestCount\t\t\t\t = @AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t\t@ReturnedRequestCount\t\t\t\t\t\t = @ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t\t@DelayedDeliveryCount\t\t\t\t\t\t = @delayedDeliveryRequestCount\t\t\t\t\tOUTPUT,\r\n\t--\t\t@UnassignedReturnAndReplacementRequestCount  = @UnassignedReturnAndReplacementRequestCount\tOUTPUT,\r\n\t--\t\t@NotPickupRequestCount\t\t\t\t\t\t = @NotPickupRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t\t@DelayedPickupCount\t\t\t\t\t\t\t = @DelayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = ISNULL(@UnassignedDispatchRequestCount,0),\t\t\t\r\n\t--\t@AssignedDispatchRequestCount = ISNULL(@AssignedDispatchRequestCount,0),\t\t\t\t\r\n\t--\t@ReturnedRequestCount = ISNULL(@ReturnedRequestCount,0),\t\t\t\t\t\r\n\t--\t@delayedDeliveryRequestCount = ISNULL(@delayedDeliveryRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@UnassignedReturnAndReplacementRequestCount = ISNULL(@UnassignedReturnAndReplacementRequestCount,0),\t\r\n\t--\t@NotPickupRequestCount = ISNULL(@NotPickupRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@DelayedPickupCount = ISNULL(@DelayedPickupCount,0)\t\t\r\n\r\n\t;WITH CTE_DR AS\r\n\t(\r\n\tSELECT\t\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\tddr.CourierRequestTypeId ,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tsdp.OperationTypeId,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tLEFT JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tLEFT JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tLEFT JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\tAND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\r\n\tAND\r\n\t(\r\n\t\t(ddr.DispatchRequestStatusId in (5,6) AND CAST(DeliveryStartTime/1000000000 AS BIGINT)IN(@Now,@Yesterday))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51))\r\n\t\tOR\r\n\t\t( (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) )\r\n\t\tOR\r\n\t\t(  sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) )\r\n\t\tOR\r\n\t\t( sdp.OperationTypeId = (10) AND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) )\r\n\t)\r\n\t)\r\n\r\n\r\n\tSELECT \r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount),\r\n\t\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date IN(@Now,@Yesterday) THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\t\tCASE WHEN ddr.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\t\tCASE WHEN \r\n\t\t\t\tddr.OperationTypeId = (10)  \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t\tIsWaitingForSupport = 1 \r\n\t\t\t\t\tAND DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\t\tTHEN ParcelReferenceCode\r\n\t\t\t\tELSE NULL \r\n\t\t\tEND AS NotPickupRequestCount\r\n\t\tFROM CTE_DR ddr\r\n\t) SQ\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t\r\n\t/*\r\n\tRETURN\r\n\t; WITH CTE_AllDispatchRequests AS\r\n\t(\r\n\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t/*LEFT(DeliveryStartTime,8)*/ CAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\t\t--/*LEFT(DeliveryDeadLineTime,8) */CAST(DeliveryDeadLineTime/1000000000 AS BIGINT) DeliveryDeadLineTime,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode\r\n\t--INTO #AllDispatchRequests\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t--INNER JOIN #Polygon p\tON dp.ID = p.Id\r\n\t--INNER JOIN #CityID c\tON dp.cityID = c.CityID\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\tAND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t--option(maxdop 1);\r\n\t--OPTION(RECOMPILE)\r\n\t),CTE_A AS\r\n\t(\r\n\t\tSELECT sdpdr.ShipmentDestinationPointId,DDR.DispatchRequestId\t\r\n\t\tFROM CTE_AllDispatchRequests ddr\r\n\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\t\tON ddr.DispatchRequestId=sdpdr.DispatchRequestId\r\n\t),CTE_B AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tsdp.Id AS ShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\tsdp.OperationTypeId, \r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdpdr.DispatchRequestId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime\r\n\t\tFROM CTE_A sdpdr\r\n\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\t),CTE_Shipment AS\r\n\t(\r\n\r\n\t\tSELECT \r\n\t\t\tsdp.*,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\t--dss.Id\t\tShipmentStatusId,\r\n\t\t\t--dss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId \r\n\t\tFROM CTE_B  sdp\r\n\t\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t--\tON dss.Id=ds.ShipmentStatusId\r\n\t), CTE_AllShipmentDestinationPoint AS\r\n\t(\r\n\t\tSELECT\tds.ShipmentDestinationPointId,\r\n\t\t\tds.ShipmentDestinationPointStatusId,\r\n\t\t\tds.OperationTypeId,\r\n\t\t\tds.DispatchRequestId,\r\n\t\t\tds.ShipmentId,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tds.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter\r\n\t\t\t\r\n\t\t--INTO #AllShipmentDestinationPoint\r\n\t\tFROM CTE_Shipment ds\r\n\t\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t\tWHERE dss.Id NOT IN ( 45,50,55,100 )\r\n\t)\r\n\r\n\tSELECT \r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date=@Now THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\t\tCASE WHEN sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\t\tCASE WHEN \r\n\t\t\t\tsdp.OperationTypeId = (10)  \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount\r\n\t\tFROM CTE_AllDispatchRequests ddr\r\n\t\tLEFT JOIN CTE_AllShipmentDestinationPoint sdp ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t\t--WHERE ddr.DispatchRequestStatusId IN ( 5,6,10,11,15,16,20,25,45,46,50,51)\r\n\t\t--OR (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25)\r\n\t) SQ\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\tRETURN\r\n\t*/\r\n\t/***************************************************/\r\n\tDECLARE @OperationWarningRangeTime_Second INT=DATEDIFF (SECOND,0,@OperationWarningRangeTime)\r\n\r\n\tSELECT\t\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\t\tddr.CourierRequestTypeId ,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t sdp.OperationTypeId,\r\n\t\t\tddr.Id DispatchRequestId,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\tsdp.ID  AS ShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId ,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\tddr.VendorId,\r\n\t\t\tv.BrandName AS VendorBrandName\r\n\tINTO #CTE_DR\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t--AND sdp.OperationTypeId IN ( 5,10 )\r\n\t\t--AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #CourierRequestTypeID crtID\r\n\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\tON ddr.VendorId = v.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId_Local\r\n\tAND((dp.CityId IN(SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds_Local,\u00270\u0027)=\u00270\u0027))\t\t\t\r\n\tAND ((ps.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID_Local OR ISNULL(@VendorID_Local,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t--AND ddr.DeliveryServiceProviderId = @DeliveryServiceProviderId_Local OR ISNULL(@DeliveryServiceProviderId_Local,0) = 0\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\tCREATE INDEX IX_#CTE_DR ON #CTE_DR\r\n\t(\r\n\t\tShipmentId,\r\n\t\tDispatchRequestId,\r\n\t\tStoreId,\r\n\t\t[OperationTypeId],\r\n\t\t[ShipmentDestinationPointStatusId]\r\n\t)INCLUDE ([DispatchRequestStatusId],[DeliveryStartTime_Date],[CourierRequestTypeId],[ParcelReferenceCode],[PolygonStoreId],[PolygonId],[PolygonTitle],[StoreTitle],[CityId],[VendorParcelCode],[EstimatedOperationTimeSeconds],[EstimatedArrivalTime],[ShipmentDestinationPointId],[SequenceNumber],[DeliveryServiceProviderId],[VendorId],[VendorBrandName])\r\n\r\n\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdp.*,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\t--dss.Id\t\tShipmentStatusId,\r\n\t\t\t--dss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId \r\n\t\tINTO #CTE_Shipment\r\n\t\tFROM #CTE_DR  sdp\r\n\t\tINNER JOIN dP.Shipment(NOLOCK) ds\r\n\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\tINNER JOIN #ShipmentStatusId ssid\r\n\t\t\tON ds.ShipmentStatusId = ssid.Id\r\n\t\tAND ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\t\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\t\tAND sdp.OperationTypeId IN (5,10/*Delivery*/,15,20,25,30)\r\n\r\n\r\n\r\n\r\n\t;WITH CTE_AllShipmentDestinationPoint AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tds.ShipmentDestinationPointId,\r\n\t\t\tds.ShipmentDestinationPointStatusId,\r\n\t\t\tds.OperationTypeId,\r\n\t\t\tds.DispatchRequestId,\r\n\t\t\tds.ShipmentId,\r\n\t\t\tds.ShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tds.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tDATEADD(SECOND,ds.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(ds.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))EstimatedArrivalTime\r\n\t\t--INTO #AllShipmentDestinationPoint\r\n\t\tFROM #CTE_Shipment ds\r\n\t\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\t\r\n\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t\tWHERE dss.Id NOT IN ( 45,50,55,100 )\r\n\t), CTE_PickupStatus AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdpi.ShipmentId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN ShipmentStatusId = 25 THEN 2\r\n\t\t\t\tWHEN ShipmentStatusId = 30 THEN 4\r\n\t\t\t\tWHEN ShipmentStatusId IN (35,40) \r\n\t\t\t\tTHEN\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN HasDP = 1\r\n\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\tWHEN HasDP = 0 \r\n\t\t\t\t\t\tTHEN 2\r\n\t\t\t\t\tEND\r\n\t\t\t\t\t\t\r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) AND sdpi.SequenceNumber = sdpi.FS THEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\r\n\t\t\tELSE 5 END PickupStatus\t\t\t\t\t\r\n\t\tFROM \r\n\t\t(\r\n\t\t\tSELECT * FROM \r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tShipmentId , \r\n\t\t\t\t\tShipmentStatusId, \r\n\t\t\t\t\tOperationTypeId , \r\n\t\t\t\t\tShipmentDestinationPointStatusId , \r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tFIRST_VALUE(SQ.FS) OVER (PARTITION BY SQ.ShipmentId ORDER BY SQ.FS DESC) FS ,\r\n\t\t\t\t\tFIRST_VALUE(SQ.HasDP) OVER (PARTITION BY SQ.ShipmentId ORDER BY SQ.HasDP DESC) HasDP ,\r\n\t\t\t\t\tEstimatedArrivalTime\r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tDISTINCT CASE WHEN ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) THEN \r\n\t\t\t\t\t\t\tsdpi.SequenceNumber \r\n\t\t\t\t\t\tELSE 0 END FS,\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN ShipmentStatusId IN ( 35,40 ) AND OperationTypeId IN ( 5,20 ) AND ShipmentDestinationPointStatusId = 25 THEN 1 \r\n\t\t\t\t\t\t\tELSE 0 \r\n\t\t\t\t\t\tEND HasDP,\r\n\t\t\t\t\t\t* \r\n\t\t\t\t\tFROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\t\t\t) SQ\r\n\t\t\t) sdpi\r\n\t\t\tWHERE \r\n\t\t\t\tsdpi.ShipmentStatusId = 25\r\n\t\t\t\tOR ShipmentStatusId = 30\r\n\t\t\t\tOR ShipmentStatusId IN (35,40)\r\n\t\t\t\tOR (ShipmentStatusId IN (5,6,10,15,20) AND sdpi.OperationTypeId IN(25,20,5) AND sdpi.ShipmentDestinationPointStatusId IN (5,10,15) AND sdpi.SequenceNumber = sdpi.FS)\r\n\t\t) sdpi\r\n\t), CTE_Delivery AS\r\n\t(\r\n\t\t\tSELECT DISTINCT \r\n\t\t\tsdpi.ShipmentId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20) THEN 1\r\n\t\t\t\tWHEN ShipmentStatusId=35 THEN 4\r\n\t\t\t\tWHEN ShipmentStatusId IN (25,30,40) AND sdpi.SequenceNumber = sdpi.FS THEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN GETDATE()\u003C(DATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime))\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tWHEN GETDATE() BETWEEN\tDATEADD(SECOND,-@OperationWarningRangeTime_Second,sdpi.EstimatedArrivalTime)\r\n\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\tsdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 3\r\n\t\t\t\t\tWHEN GETDATE()\u003Esdpi.EstimatedArrivalTime\r\n\t\t\t\t\tTHEN 4\r\n\t\t\t\tEND\r\n\t\t\tEND DeliveryStatus\r\n\t\t\t\t\r\n\t\tFROM \r\n\t\t(\r\n\t\t\t\r\n\t\t\tSELECT * FROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tShipmentId , \r\n\t\t\t\t\tShipmentStatusId, \r\n\t\t\t\t\tOperationTypeId , \r\n\t\t\t\t\tShipmentDestinationPointStatusId , \r\n\t\t\t\t\tSequenceNumber,\r\n\t\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\t\tFIRST_VALUE(sdpi.FS) OVER (PARTITION BY sdpi.ShipmentId ORDER BY sdpi.FS DESC) FS \r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT CASE WHEN ShipmentStatusId IN (25,30,40) THEN sdpi.SequenceNumber  ELSE 0 END FS, * FROM CTE_AllShipmentDestinationPoint sdpi WHERE sdpi.ShipmentDestinationPointStatusId \u003C\u003E 40\r\n\t\t\t\t) sdpi\r\n\t\t\t) SDPI\r\n\t\t\tWHERE \r\n\t\t\t\tsdpi.ShipmentStatusId IN (5,6,10,15,20)\r\n\t\t\t\tOR ShipmentStatusId=35\r\n\t\t\t\tOR (ShipmentStatusId IN (25,30,40) AND sdpi.SequenceNumber = sdpi.FS)\r\n\t\t\t) sdpi\r\n\t\t--ORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t), CTE_Estimated AS\r\n\t(\r\n\t\r\n\t\tSELECT TOP 1 WITH TIES  sdpi.ShipmentId,sdpi.EstimatedArrivalTime EstimatedEndDateTimeStr\r\n\t\tFROM CTE_AllShipmentDestinationPoint sdpi\r\n\t\tWHERE sdpi.ShipmentDestinationPointStatusId NOT IN (30/*Aborted*/)\r\n\t\t--AND ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\tORDER BY ROW_NUMBER() OVER(PARTITION BY sdpi.ShipmentId ORDER BY sdpi.SequenceNumber DESC)\r\n\t), CTE_TotalCount AS\r\n\t(\r\n\r\n\t\tSELECT sh.Id shipmentId,\r\n\t\t\tcount(distinct ShipmentDestinationPointId)DispatchRequestCount\t\r\n\t\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\t\t--INNER JOIN CTE_DR ddr ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t\tINNER JOIN dp.Shipment sh\twith(nolock)\t\tON sh.Id=sdp.ShipmentId\r\n\t\t--INNER JOIN dp.PolygonFleet(NOLOCK) dpf\t\t\t\t\t\t\t\tON dpf.PolygonId=ddr.PolygonId  AND dpf.IsActive=1\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sh.FleetId AND df.IsActive=1\r\n\t\tINNER JOIN #ShipmentStatusId ssid\r\n\t\t\tON sh.ShipmentStatusId = ssid.Id\r\n\t\tWHERE sh.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\t\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t\tAND ((df.Id\t\t =@FleetId\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\t\t--AND ((sh.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds_Local,\u0027\u0027)=\u0027\u0027))\r\n\t\tGROUP BY sh.Id\r\n\t), CTE_IsReturnToStoreRequired AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tShipmentId,\r\n\t\t\tCAST(IsReturnToStoreRequired AS BIT ) IsReturnToStoreRequired\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tSQ.ShipmentId,\r\n\t\t\t\tFIRST_VALUE(IsReturnToStoreRequired) OVER ( PARTITION BY SQ.ShipmentId ORDER BY IsReturnToStoreRequired DESC ) IsReturnToStoreRequired,\r\n\t\t\t\tFIRST_VALUE(HasDelivery) OVER ( PARTITION BY SQ.ShipmentId ORDER BY HasDelivery DESC) HasDelivery\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tsdp.ShipmentId,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId = 30 AND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35,40 ) AND sdpdr.DispatchRequestId IS NULL THEN 1 ELSE 0 END IsReturnToStoreRequired,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId \u003C\u003E 30 AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ) THEN 1 ELSE 0 END HasDelivery\r\n\t\t\t\tFROM #CTE_Shipment s\r\n\t\t\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\t\tON s.ShipmentId = sdp.ShipmentId\r\n\t\t\t\tLEFT JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\t\t\tWHERE sdp.OperationTypeId = 30\r\n\t\t\t\tOR (sdp.OperationTypeId \u003C\u003E 30 AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ))\r\n\t\t\t) SQ\r\n\t\t) SQ\r\n\t\tWHERE SQ.HasDelivery = 0\r\n\t)\r\n\r\n\tSELECT * INTO #Output FROM \r\n\t(\r\n\tSELECT DISTINCT\r\n\t\t\tsdp.ShipmentId\t\t\t\t\t\t\tId,\r\n\t\t\tsdp.ShipmentStatusId\t\t\t\t\tStatusId,\r\n\t\t\tsdp.ShipmentStatusTitle\t\t\t\t\tStatusTitle,\r\n\t\t\tsdp.ShipmentNumber,\r\n\t\t\tsdp.TotalEstimatedDurationSeconds,\r\n\t\t\tsdp.TotalDistanceMeter,\r\n\t\t\tddr.CityId\t\t\t\t\t\t\t\tCityId,\r\n\t\t\tddr.PolygonId\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tddr.polygonTitle\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tddr.StoreId\t\t\t\t\t\t\t\tStoreId,\r\n\t\t\ts.Location.STY  AS  StoreLocationLat,\r\n\t\t\ts.Location.STX  AS\tStoreLocationLong,\r\n\t\t\tddr.StoreTitle\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\t--sdp.ShipmentStatusId,\r\n\t\t\tPickupStatus.PickupStatus,\r\n\t\t\tDeliveryStatus.DeliveryStatus,\r\n\t\t\tISNULL(CASE \r\n\t\t\t\tWHEN ShipmentStatusId IN (5,6,10,15,20)\tTHEN PickupStatus\r\n\t\t\t\tWHEN ShipmentStatusId IN (25,30,35,40)\tTHEN DeliveryStatus\r\n\t\t\t\tELSE 0\r\n\t\t\tEND,0) OperationStatus,\r\n\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\tISNULL(tc.DispatchRequestCount,0) DispatchRequestCount, --(SELECT DispatchRequestCount FROM CTE_TotalCount t where shipmentId=t.shipmentId)\tDispatchRequestCount,\r\n\t\t\tdf.Id\t\t\t\t\t\t\t\t\tFleetId,\r\n\t\t\td.Id\t\t\t\t\t\t\t\t\tDriverId,\r\n\t\t\tCONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\tDriverName,\r\n\t\t\tCONCAT(\u00270\u0027,d.Mobile)\t\t\t\t\tDriverMobile,\r\n\t\t\tdv.VehicleTypeId,\r\n\t\t\tdv.PlateNumber,\r\n\t\t\tISNULL(rtsr.IsReturnToStoreRequired,0) IsReturnToStoreRequired,\r\n\t\t\tddr.DeliveryServiceProviderId\r\n\t\r\n\tFROM CTE_AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #CTE_DR ddr\t\t\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tJOIN DP.Store AS s with(nolock) ON s.Id = ddr.StoreId\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=sdp.FleetId\t\tAND df.IsActive=1\r\n\tINNER JOIN CS_DriverManagement.DM.vehicle(NOLOCK) dv\t\t\t\t\t\t\t\t\tON dv.Id=df.VehicleId\r\n\tINNER JOIN CS_DriverManagement.DM.Driver(NOLOCK) AS d\t\t\t\t\t\t\t\t\tON d.id = df.DriverId\r\n\tLEFT JOIN CTE_PickupStatus PickupStatus ON PickupStatus.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_Delivery DeliveryStatus ON DeliveryStatus.ShipmentId=sdp.ShipmentId\r\n\tINNER JOIN CTE_Estimated EstimatedEndDateTimeStr ON EstimatedEndDateTimeStr.ShipmentId=sdp.ShipmentId\r\n\tLEFT JOIN CTE_TotalCount tc ON  sdp.ShipmentId = tc.shipmentId\r\n\tLEFT JOIN CTE_IsReturnToStoreRequired rtsr\r\n\t\tON sdp.ShipmentId = rtsr.ShipmentId\r\n\tWHERE (ddr.DispatchRequestStatusId IN (10/*Assigned To Courier*/,11/*Reassigned*/,15/*Arrived at Pickup point*/,\r\n\t\t\t\t\t\t\t\t\t\t 16/*SecondFleetArrivedAtPickupPoint*/,20/*Picked up*/,25/*Arrived at Delivery Point*/,\r\n\t\t\t\t\t\t\t\t\t\t 45/*Cancel Response Pending*/,46/*Second Cancel Request Pending*/,47,48,49,52,53,54,50/*Cancel Request Rejected*/,\r\n\t\t\t\t\t\t\t\t\t\t 51/*Second Cancel Request Rejected*/)  OR rtsr.IsReturnToStoreRequired IS NOT NULL )\r\n\tAND sdp.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\tAND sdp.ShipmentDestinationPointStatusId\u003C\u003E35 \r\n\tAND sdp.OperationTypeId IN (10/*Delivery*/,15,20,25,30)\r\n\t--AND((ddr.CityId IN (SELECT Id FROM @CityId)\t\t\t)\t\t\t\tOR (ISNULL(@CityIds,\u00270\u0027)=\u00270\u0027))\t\t\r\n\tAND ((df.Id\t\t =@FleetId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@FleetId_Local,0)=0))\t\r\n\tAND ((ddr.StoreId=@StoreId_Local\t\t\t\t\t\t\t)\t\t\t\tOR (ISNULL(@StoreId_Local,0)=0))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode_Local\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode_Local,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode_Local\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode_Local,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode_Local=\u0027\u0027)\r\n\t--AND (ddr.PolygonId IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\t--AND ((sdp.ShipmentStatusId In (SELECT Id FROM @ShipmentStatusId))\tOR (ISNULL(@ShipmentStatusIds,\u0027\u0027)=\u0027\u0027))\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027), Recompile)\r\n\t--OPTION(MAXDOP 1)\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t--OPTION(Recompile)\r\n\t\r\n\t) SQ\r\n\r\n\tSET @TotalCount = @@ROWCOUNT\r\n\r\n\r\n\tSELECT * FROM #Output\r\n\r\n\tORDER BY \r\n\t\tCASE WHEN @OrderBy_Local IS NOT NULL AND @OrderBy_Local \u003C\u003E \u0027\u0027 AND @OrderBy_Local \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\u002B  @OrderByReplace \r\n\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\tEND,\r\n\t\tOperationStatus DESC,\r\n\t\tEstimatedEndDateTimeStr ASC\r\n\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n--\tOPTION (USE HINT (\u0027FORCE_LEGACY_CARDINALITY_ESTIMATION\u0027));\r\n--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\tSET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\n\r\n\r\n\t/*\r\n\tDECLARE @OrderbyValue NVARCHAR(100)\r\n\tSET @sql = \u0027\r\n\tDROP TABLE IF EXISTS #t\r\n\tSELECT\r\n\t\t\t\t\tId,\r\n\t\t\t\t\tStatusId,\r\n\t\t\t\t\tStatusTitle,\r\n\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\tTotalEstimatedDurationSeconds,\r\n\t\t\t\t\tTotalDistanceMeter,\r\n\t\t\t\t\tCityId,\r\n\t\t\t\t\tPolygonId,\r\n\t\t\t\t\tPolygonTitle,\r\n\t\t\t\t\tStoreId,\r\n\t\t\t\t\tStoreLocationLat,\r\n\t\t\t\t\tStoreLocationLong,\r\n\t\t\t\t\tStoreTitle,\r\n\t\t\t\t\tISNULL(PickupStatus,0)\t\tPickupStatus,\r\n\t\t\t\t\tISNULL(DeliveryStatus,1)\tDeliveryStatus,\r\n\t\t\t\t\tOperationStatus,\r\n\t\t\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\t\t\tFleetId,\r\n\t\t\t\t\tDriverId,\r\n\t\t\t\t\tDriverName,\r\n\t\t\t\t\tDriverMobile,\r\n\t\t\t\t\tVehicleTypeId,\r\n\t\t\t\t\tPlateNumber\r\n\t\t\t\tInto #T\r\n\tFROM #Result r\r\n\t \r\n\r\n\t/*SELECT @Result=(\r\n\r\n\t\tSELECT\ttc.TotalCount count,\r\n\r\n\t\tJSON_QUERY((*/\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tId,\r\n\t\t\t\t\tStatusId,\r\n\t\t\t\t\tStatusTitle,\r\n\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\tTotalEstimatedDurationSeconds \tTotalEstimatedDurationSeconds,\r\n\t\t\t\t\tTotalDistanceMeter,\r\n\t\t\t\t\tCityId,\r\n\t\t\t\t\tPolygonId,\r\n\t\t\t\t\tPolygonTitle,\r\n\t\t\t\t\tStoreId,\r\n\t\t\t\t\tStoreLocationLat,\r\n\t\t\t\t\tStoreLocationLong,\r\n\t\t\t\t\tStoreTitle,\r\n\t\t\t\t\tISNULL(PickupStatus,0)\t\t\t\t\t\t\t\t\t\t\t\t\tPickupStatus,\r\n\t\t\t\t\tISNULL(DeliveryStatus,1) \t\t\t\t\t\t\t\t\t\t\t\tDeliveryStatus,\r\n\t\t\t\t\tOperationStatus,\r\n\t\t\t\t\tEstimatedEndDateTimeStr,\r\n\t\t\t\t\t(SELECT DispatchRequestCount FROM #TotalCount t where Id=t.shipmentId)\tDispatchRequestCount,\r\n\t\t\t\t\tFleetId,\r\n\t\t\t\t\tDriverId,\r\n\t\t\t\t\tDriverName,\r\n\t\t\t\t\tDriverMobile,\r\n\t\t\t\t\tVehicleTypeId,\r\n\t\t\t\t\tPlateNumber\r\n\r\n\t\t\t\tFROM #T \r\n\t\t\t\tORDER BY \u0027 \u002B\r\n\t\t\t\t\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\t\t\t\u002B  @OrderByReplace \u002B \u0027 , \u0027\r\n\t\t\t\t\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\u002B \u0027 OperationStatus DESC,\r\n\t\t\t\t\t\tEstimatedEndDateTimeStr ASC\r\n\t\t\t\t\t\t   \r\n\r\n\t\t\t/*\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t\t))Shipments,\r\n\r\n\r\n\t\t--FROM #TotalCount AS tc\r\n\r\n\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n\t)\r\n\r\n\r\n\r\n\tset @Result = REPLACE(@Result,N\u0027\u0027\\\u0027\u0027,\u0027\u0027\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022Fleet\u0022:\u0022{\u0027\u0027,\u0027\u0027\u0022Fleet\u0022:{\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022}\u0022}\u0027\u0027,\u0027\u0027\u0022}}\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027}\u0022}]}\u0027\u0027,\u0027\u0027}}]}\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027}\u0022,\u0022StoreTitle\u0022:\u0027\u0027,\u0027\u0027},\u0022StoreTitle\u0022:\u0027\u0027)\r\n\tset @result = Replace(@Result,N\u0027\u0027\u0022StoreLocation\u0022:\u0022{\u0027\u0027,\u0027\u0027\u0022StoreLocation\u0022:{\u0027\u0027)\r\n\r\n\r\n\tDECLARE @TotalCount INT \r\n\tSELECT @TotalCount = tc.TotalCount FROM #TotalCount AS tc\t\r\n\tIF @TotalCount=0 \r\n\tBEGIN \r\n\t\tSET @Result=NULL\r\n\t\tRETURN \r\n\tEND\r\n\t*/\r\n\r\n\t--DECLARE @DelayedDeliveryRequestCount\t\t\t\tINT=0\r\n\t--DECLARE @DelayedPickupCount\t\t\t\t\t\tINT=0\r\n\t--DECLARE @ReturnedRequestCount\t\t\t\t\t\tINT=0\r\n\t--DECLARE @Assigned_DispatchRequestCount\t\t\tINT=0\r\n\t--DECLARE @UnassignedDispatchRequestCount\t\t\tINT=0\r\n\r\n\t--SET  @DelayedDeliveryRequestCount\t\t\t\t\t= (SELECT DelayedDeliveryCount FROM #DelayedDeliveryCount)\t\t\t\t\t\t--DelayedDeliveryCount,\r\n\t--SET  @DelayedPickupCount\t\t\t\t\t\t\t= (SELECT DelayedPickupCount FROM #DelayedPickupCount)\t\t\t\t\t\t\t--DelayedPickupCount,\r\n\t--SET  @ReturnedRequestCount\t\t\t\t\t\t\t= (SELECT ReturnedCount FROM #ReturnedCount)\t\t\t\t\t\t\t\t\t\t--ReturnedCount,\r\n\t--SET  @AssignedDispatchRequestCount\t\t\t\t\t= (SELECT Assigned_DispatchRequestCount FROM #Assigned_DispatchRequestCount)\t\t--Assigned_DispatchRequestCount,\r\n\t--SET  @UnassignedDispatchRequestCount\t\t\t\t= (SELECT UnassignedDispatchRequestCount FROM #UnassignedDispatchRequestCount)\t--UnassignedDispatchRequestCount\r\n\t--SET  @UnassignedReturnAndReplacementRequestCount\t= (select UnassignedReturnAndReplacementRequestCount from #UnassignedReturnAndReplacementRequestCount)\r\n\r\n\t\u0027\r\n\r\n\t--PRINT \u0027YYY\u0027\r\n\t--PRINT SYSDATETIME()\r\n\t-- PRINT @sql\t\r\n\tDECLARE @Param NVARCHAR(4000) =\t\u0027\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\tINT\t\t\t\t\t  ,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t=NULL,\r\n\t\t\t\t\t\t\t\t\t\t@FleetId\t\t\t\t\t\t\t\t\tINT\t\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@ShipmentStatusIds\t\t\t\t\t\t\tNVARCHAR(MAX)\t=NULL ,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10)           ,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t=NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)   =NULL,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t=NULL,\r\n\r\n\t\t\t\t\t\t\t\t\t\t@DelayedDeliveryRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@DelayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@ReturnedRequestCount\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@AssignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\tOUTPUT\r\n\t\t\t\t\t\t\t\t\t\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL @sql,@Param,\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t=@OperationStaffId,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t=@CityIds,\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t=@PolygonIds,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@FleetId\t\t\t\t\t\t\t=@FleetId,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t=@StoreId,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t=@ParcelReferenceCode,\t\t\r\n\t\t\t\t\t\t\t\t\t\t@ShipmentStatusIds\t\t\t\t\t=@ShipmentStatusIds,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t=@OperationWarningRangeTime,\t\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t=@VendorParcelCode,\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t=@OrderBy,\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t=@IsASC\t,\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\t\t\t@DelayedDeliveryRequestCount\t\t=@DelayedDeliveryRequestCount\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@DelayedPickupCount\t\t\t\t\t=@DelayedPickupCount\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@ReturnedRequestCount\t\t\t\t=@ReturnedRequestCount\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@AssignedDispatchRequestCount\t\t=@AssignedDispatchRequestCount\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedDispatchRequestCount\t\t=@UnassignedDispatchRequestCount\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount=@UnassignedReturnAndReplacementRequestCount output\t\t\t\r\n\r\n*/\r\n\r\n--PRINT \u0027ZZZ\u0027\r\n--PRINT SYSDATETIME()\r\n\r\n\r\n\r\n"},{"Name":"Get_ActiveShipments_By_ShipmentId","Schema":"dbo","Definition":"\r\n/*\r\n\tDECLARE @Result NVARCHAR(MAX)\r\n\texec [Get_ActiveShipment_By_ShipmentIds] @ShipmentIds=\u0027514645\u0027,@RESULT =@Result OUT \r\n\tSELECT @RESULT\r\n*/\r\nCREATE         PROCEDURE [dbo].[Get_ActiveShipments_By_ShipmentId]\r\n\t@ShipmentId\t\t\t\tBIGINT,\r\n\t@Result\t\t\t\t\tNVARCHAR(MAX) OUTPUT\r\nAS\r\n\r\n\r\n\r\nBEGIN\r\n\r\nDECLARE @FleetId INT\r\n\r\nSELECT  \r\n\t@FleetId = s.FleetId\r\nFROM DP.Shipment s WITH(NOLOCK)\r\nWHERE s.ID = @ShipmentId\r\n\r\n\r\n\r\n;WITH CTE_Fleet AS\r\n(\r\n\t\r\n\t\tSELECT DISTINCT\r\n\t\t\ts.FleetId,\r\n\t\t\td.ID DriverId,\r\n\t\t\td.Mobile AS DriverMobile,\r\n\t\t\ts.Id ShipmentId,\r\n\t\t\tREPLACE(st.Title,\u0027 \u0027,\u0027_\u0027) StoreTitle,\r\n\t\t\ts.UpdateDate\r\n\t\t\t--CASE WHEN dr.DispatchRequestStatusId IN ( 5,30,35,40,46,47,48,49 ) THEN 1 ELSE 0 END NotShowInResult\r\n\t\tFROM DP.Shipment s (NOLOCK)\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK)\r\n\t\t\tON s.FleetId = f.ID\r\n\t\t\tAND f.IsActive=1\r\n\t\tJOIN CS_DriverManagement.DM.Driver AS d (NOLOCK)\r\n\t\t\tON d.Id = f.DriverId\r\n\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\tON s.ID = sdp.ShipmentId\r\n\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\tINNER JOIN DP.DispatchRequest dr (NOLOCK)\r\n\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\tINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\t\t\tON dr.PolygonStoreId = ps.ID\r\n\t\tINNER JOIN DP.Store st (NOLOCK)\r\n\t\t\tON ps.StoreId = st.ID\r\n\t\tWHERE s.FleetId = @FleetId\r\n\t\tAND s.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\t\tAND s.CreateDate \u003E= CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT)\r\n)\r\n\r\nSELECT @Result = \r\n(\r\n\tSELECT \r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tf.FleetId ,\r\n\t\t\t\tf.DriverId,\r\n\t\t\t\tRIGHT(\u00270\u0027\u002BCAST(f.DriverMobile AS NVARCHAR(MAX)) , 11) DriverMobile,\r\n\t\t\t\tf.ShipmentId,\r\n\t\t\t\tf.StoreTitle,\r\n\t\t\t\tf.UpdateDate\r\n\t\t\tFROM CTE_Fleet f\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t) NoName\r\n\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n)\r\n\tSET @Result = REPLACE(@Result,\u0027{\u0022NoName\u0022:\u0022\u0027,\u0027\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027}\u0022}\u0027,\u0027}\u0027)\r\n\t\r\n\tSET @Result = NULLIF(@Result,\u0027[{\u0022NoName\u0022:null}]\u0027)\r\n\tSET @Result = NULLIF(@Result,\u0027[{\u0022NoName\u0022:[]}]\u0027)\r\n\t\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Fleets_DeliveryChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE   PROCEDURE [dbo].[Get_Dashboard_Fleets_DeliveryChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t\t @polygonId int ,  \r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t \t @countOfQueue INT OUTPUT,\r\n\t\t @countOfInProgress INT OUTPUT,\r\n\t\t @totalCount INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\nDROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\nSELECT \r\n\tcrt.Id\r\nINTO #CourierRequestType\r\nFROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\nINNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\tON crt.Id = ss.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\n\r\n\r\n\tDECLARE \r\n\r\n\r\n\r\n\t@EndRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n\t\t\t\t\t\t\t\t,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n\t\t\t\t\t\t\t\t,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n\t\t\t\t\t\t\t\t,\u0027235959999\u0027\r\n\t\t\t\t\t\t\t\t) as BIGINT)),\r\n\t\t\t\r\n\r\n        @ShiftDate\t DATE=CAST(GETDATE() AS DATE),\r\n\t\t@ShiftTime\t TIME=CAST(getdate() AS TIME)\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\n\r\nSELECT \r\n\t@totalCount = isnull(SUM(1),0) \r\nFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\nINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\tON dr.PolygonStoreId=ps.Id\t\r\nINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\tON ps.polygonid=po.id AND PO.ID=@polygonId\r\nINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\tON po.CityID = c.ID\r\nINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\tON c.ProvinceID = prvnc.ID\r\nWHERE dr.DeliveryServiceProviderId = 1\r\nAND DispatchRequestStatusId IN ( 30,35 , 17,40 )\r\nAND dr.DispatchRequestStatusId IN (30,35) \r\nAND dr.CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) \r\nAND dr.DeliveryStartTime BETWEEN @TotalFrom AND @EndRangeTime\r\nOPTION(RECOMPILE)\r\n\r\nSELECT\r\n    @title=N\u0027\u0633\u0641\u0627\u0631\u0634\u0627\u062A\u0027,\r\n\t@countOfQueue = 0,\r\n\t@countOfInProgress = isnull(COUNT( SHDP.Id ),0)\r\n--\tCASE WHEN SHDP.ShipmentDestinationPointStatusId IN (20,25) AND DR.DispatchRequestStatusId IN (30,35) THEN SHDP.Id ELSE NULL END AS Delivered\r\nFROM [CS_DriverManagement].[DM].[Fleet] AS AFI WITH(NOLOCK) \r\nINNER JOIN [CS_Dispatcher].[DP].[Shipment]  AS SH WITH(NOLOCK)\r\n\tON SH.FleetId=AFI.id \r\n\tAND SH.CreateDate \u003E= @TotalFrom\r\nINNER JOIN [CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\r\n\tON AFI.ID=SFM.FleetId AND SFM.IsActive=1 AND SFM.IsAssigned=1\r\nINNER JOIN [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK) \r\n\tON SFM.ShiftDateId=SD.Id AND SD.[Date]=@ShiftDate\r\nINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)\r\n\tON SD.ShiftId=S.Id AND [PolygonId]=@polygonId\r\nINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)\r\n\tON S.TimeSlotId=TS.ID AND @ShiftTime BETWEEN [From] AND [To]\r\nINNER JOIN [CS_Dispatcher].[DP].[ShipmentDestinationPoint]  AS SHDP WITH(NOLOCK)\r\n\tON SH.Id=SHDP.ShipmentId \r\nINNER JOIN [CS_Dispatcher].[DP].[ShipmentDestinationPointDispatchRequest]  AS SHDPD WITH(NOLOCK)\r\n\tON SHDP.Id=SHDPD.ShipmentDestinationPointId \r\nINNER JOIN [CS_Dispatcher].[DP].[DispatchRequest]  AS DR WITH(NOLOCK)\r\n\tON SHDPD.DispatchRequestId=DR.ID \r\n\tAND dr.Version = SHDPD.Version\r\nWHERE SHDP.OperationTypeId IN (10) \r\nand dr.DeliveryServiceProviderId=1\r\nAND  DeliveryStartTime \u003E = @TotalFrom And DeliveryDeadLineTime \u003C= @EndRangeTime \r\nAND SHDP.ShipmentDestinationPointStatusId IN (5,10,15)\r\nAND @ShiftTime BETWEEN [From] AND [To] \r\n\r\nOPTION(RECOMPILE)\r\n\r\n\r\n\r\n\r\n \r\nSELECT  \r\n    SQ.BarIndex  as labels,\r\n    COUNT(SQ.Id) AS dataValues\r\nFROM  \r\n(  \r\n\tSELECT NULL Id, @Bar1 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar2 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar3 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar4 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar5 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar6 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar7 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar8 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar9 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar10 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar11 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, @Bar12 BarIndex\r\n\tUNION ALL  \r\n    SELECT  \r\n\t\tdr.Id,  \r\n\t\tCASE  \r\n\t\t\tWHEN dr.UpdateDate \u003C @Bar1_BIGINT THEN @Bar1  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar1_BIGINT AND @Bar2_BIGINT THEN @Bar2  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar2_BIGINT AND @Bar3_BIGINT THEN @Bar3  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar3_BIGINT AND @Bar4_BIGINT THEN @Bar4  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar4_BIGINT AND @Bar5_BIGINT THEN @Bar5  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar5_BIGINT AND @Bar6_BIGINT THEN @Bar6  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar6_BIGINT AND @Bar7_BIGINT THEN @Bar7  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar7_BIGINT AND @Bar8_BIGINT THEN @Bar8  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar8_BIGINT AND @Bar9_BIGINT THEN @Bar9  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar9_BIGINT AND @Bar10_BIGINT THEN @Bar10  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar10_BIGINT AND @Bar11_BIGINT THEN @Bar11  \r\n\t\t\tWHEN dr.UpdateDate BETWEEN @Bar11_BIGINT AND @Bar12_BIGINT THEN @Bar12  \r\n\t\t\tELSE @Bar12  \r\n\t\tEND AS BarIndex\r\n\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\t--INNER JOIN #CourierRequestType crt\r\n\t--\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\tON dr.PolygonStoreId=ps.Id\t\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\tON ps.polygonid=po.id AND PO.ID=@polygonId\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\t\tON po.CityID = c.ID\r\n\tINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\t\tON c.ProvinceID = prvnc.ID\r\n\tWHERE dr.DeliveryStartTime between @TotalFrom AND @EndRangeTime\r\n\tAND dr.DeliveryServiceProviderId = 1\r\n\tAND DispatchRequestStatusId IN (30,35)\r\n\tAND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70)\r\n\r\n) SQ   \r\nGroup BY BarIndex  \r\nORDER BY BarIndex \r\nOPTION(RECOMPILE)\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Fleets_ETAChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Fleets_ETAChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t\t @polygonId int ,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t\t @countOfDelayed INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\nDROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\nSELECT \r\n\tcrt.Id\r\nINTO #CourierRequestType\r\nFROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\nINNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\tON crt.Id = ss.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n        @ShiftDate\t DATE=CAST(GETDATE() AS DATE),\r\n\t\t@ShiftTime\t TIME=CAST(getdate() AS TIME),\r\n\t\t@EndRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n\t\t\t\t\t\t\t\t,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n\t\t\t\t\t\t\t\t,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n\t\t\t\t\t\t\t\t,\u0027235959999\u0027\r\n\t\t\t\t\t\t\t\t) as BIGINT))\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\n\r\nSELECT\r\n\r\n    @title=N\u0027\u0628\u0631\u0645\u0628\u0646\u0627\u06CC ETA\u0027,\r\n\t@countOfDelivered=ISNULL(MAX(Delivered),0),\r\n\t@countOfDelayed=ISNULL(MAX(Delayed),0)\r\n\r\n\r\n\t\t--SUM(CASE WHEN ShipmentDestinationPointStatusId=20\tTHEN 1 ELSE 0 END) Delivered,\r\n  --  \tSUM(CASE WHEN ShipmentDestinationPointStatusId=25 \tTHEN 1 ELSE 0 END) Delayed\r\n\r\nFROM\r\n(\r\n\tSELECT\r\n\r\n\t   \tSUM(CASE WHEN ShipmentDestinationPointStatusId=20\tTHEN 1 ELSE 0 END) Delivered,\r\n    \tSUM(CASE WHEN ShipmentDestinationPointStatusId=25 \tTHEN 1 ELSE 0 END) Delayed\r\n\r\n\t\t--SH.Id,\r\n\t\t--CASE WHEN ShipmentDestinationPointStatusId IN (25 )  THEN SH.Id ELSE NULL END AS Delayed,\r\n\t\t--CASE WHEN  ShipmentDestinationPointStatusId IN (20 ) THEN SH.Id ELSE NULL END AS Delivered\r\n\t\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t \r\n\t\t\tON dr.Id = sdpdr.DispatchRequestId\r\n\t\t\tAND dr.Version = sdpdr.Version\r\n\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint(NOLOCK) sdp\t \t \t \t \t \t \r\n\t\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tINNER JOIN CS_Dispatcher.DP.Shipment(NOLOCK) sh\t \t \t \t \t \t \t \t \t \t \r\n\t\t\tON sh.Id=sdp.ShipmentId\r\n\t\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\t\tON dr.PolygonStoreId=ps.Id\t\r\n\t\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\t\tON ps.polygonid=po.id\tAND po.id=@polygonId\r\n\t\tWHERE dr.DeliveryStartTime BETWEEN @TotalFrom AND @EndRangeTime\r\n\t\tAND sdp.OperationTypeId IN (10)\r\n\t\tAND ShipmentDestinationPointStatusId IN (20,25)\r\n\t\tAND dr.DeliveryServiceProviderId=1\r\n\t\tAND DispatchRequestStatusId NOT IN (40,17,80)\r\n) SQ\r\nOPTION(RECOMPILE)\r\n\r\n \r\n        SELECT  \r\n            SQ.BarIndex  as labels,\r\n            COUNT(SQ.Id) AS dataValues\r\n        FROM  \r\n          (  \r\n\t\t\tSELECT NULL Id, @Bar1 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar2 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar3 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar4 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar5 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar6 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar7 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar8 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar9 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar10 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar11 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar12 BarIndex\r\n\t\t\tUNION ALL \r\n            SELECT  \r\n                dr.Id,  \r\n                CASE  \r\n                    WHEN dr.UpdateDate \u003C @Bar1_BIGINT THEN @Bar1  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar1_BIGINT AND @Bar2_BIGINT THEN @Bar2  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar2_BIGINT AND @Bar3_BIGINT THEN @Bar3  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar3_BIGINT AND @Bar4_BIGINT THEN @Bar4  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar4_BIGINT AND @Bar5_BIGINT THEN @Bar5  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar5_BIGINT AND @Bar6_BIGINT THEN @Bar6  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar6_BIGINT AND @Bar7_BIGINT THEN @Bar7  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar7_BIGINT AND @Bar8_BIGINT THEN @Bar8  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar8_BIGINT AND @Bar9_BIGINT THEN @Bar9  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar9_BIGINT AND @Bar10_BIGINT THEN @Bar10  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar10_BIGINT AND @Bar11_BIGINT THEN @Bar11  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar11_BIGINT AND @Bar12_BIGINT THEN @Bar12  \r\n                    ELSE @Bar12  \r\n                END AS BarIndex\r\n\t\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t \r\n\t\t\tON dr.Id = sdpdr.DispatchRequestId\r\n\t\t\tAND dr.Version = sdpdr.Version\r\n\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint(NOLOCK) sdp\t \t \t \t \t \t \r\n\t\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tINNER JOIN CS_Dispatcher.DP.Shipment(NOLOCK) sh\t \t \t \t \t \t \t \t \t \t \r\n\t\t\tON sh.Id=sdp.ShipmentId\r\n\t\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\t\tON dr.PolygonStoreId=ps.Id\t\r\n\t\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\t\tON ps.polygonid=po.id\tAND po.id=@polygonId\r\n\t\tWHERE dr.DeliveryStartTime BETWEEN @TotalFrom AND @EndRangeTime\r\n\t\tAND sdp.OperationTypeId IN (10)\r\n\t\tAND ShipmentDestinationPointStatusId IN (20)\r\n\t\tAND dr.DeliveryServiceProviderId=1\r\n\t\tAND DispatchRequestStatusId NOT IN (40,17,80)\r\n        ) SQ \r\n        Group BY BarIndex  \r\n        ORDER BY BarIndex \r\n\tOPTION(RECOMPILE)\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Fleets_SLAChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Fleets_SLAChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t\t @polygonId int ,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t \t @countOfDelayed INT OUTPUT,\r\n\t\t @countOfHyperDelaye INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\n\r\n\t DECLARE @MeanDeliveryTimeMinutes SMALLINT\r\n\t SELECT @MeanDeliveryTimeMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.MeanDeliveryTimeMinutes\u0027\r\n\r\n\t DECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t \t \t @ScheduledHyperDelayThresholdMinutes SMALLINT\r\n\t SELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\n\t SELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\nDROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\nSELECT \r\n\tcrt.Id\r\nINTO #CourierRequestType\r\nFROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\nINNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\tON crt.Id = ss.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@ShiftDate\t DATE=CAST(GETDATE() AS DATE),\r\n\t\t@ShiftTime\t TIME=CAST(getdate() AS TIME),\r\n\t\t@EndRangeTime BIGINT = (select CAST(concat(year(getdate())\r\n\t\t\t\t\t\t\t\t,Right(\u00270\u0027\u002BCast(month(getdate()) as varchar(2)),2)\r\n\t\t\t\t\t\t\t\t,Right(\u00270\u0027\u002BCast(day(getdate()) as varchar(2)),2)\r\n\t\t\t\t\t\t\t\t,\u0027235959999\u0027\r\n\t\t\t\t\t\t\t\t) as BIGINT))\r\n\r\n\r\n\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\n\r\nSELECT\r\n    @title=N\u0027\u0628\u0631\u0645\u0628\u0646\u0627\u06CC SLA\u0027,\r\n\t@countOfDelivered=ISNULL(MAX(Delivered),0),\r\n\t@countOfDelayed=ISNULL(MAX(Delayed),0),\r\n\t@countOfHyperDelaye=ISNULL(MAX(HyperDelaye),0)\r\n\t\r\n\r\nFROM\r\n\r\n\r\n\r\n(\r\n\tSELECT\t \r\n\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId = 35 AND dr.DeliveryStartTime BETWEEN @TotalFrom AND @EndRangeTime \r\n\t\t\tAND \r\n\t\t\t(\r\n\t\t\t\t(dr.CourierRequestTypeId IN ( 5,26,40,55,60 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @OndemandHyperDelayThresholdMinutes) \r\n\t\t\t\tOR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @ScheduledHyperDelayThresholdMinutes)\r\n\t\t\t) THEN 1 ELSE 0 END) AS HyperDelaye,\r\n\t\t SUM(CASE WHEN dr.DispatchRequestStatusId=30 AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70)  THEN 1 ELSE 0 END) Delivered\r\n\t\t,SUM(CASE WHEN dr.DispatchRequestStatusId=35 AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND DeliveryStartTime BETWEEN @TotalFrom AND @EndRangeTime THEN 1 ELSE 0 END) Delayed  \r\n\t\t--0 CountOfInprogressRequestInPolygon\r\n\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\t--INNER JOIN #CourierRequestType crt\r\n\t--\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\tON dr.PolygonStoreId=ps.Id\t\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\tON ps.polygonid=po.id AND PO.ID=@polygonId\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\t\tON po.CityID = c.ID\r\n\tINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\t\tON c.ProvinceID = prvnc.ID\r\n\tWHERE  DeliveryStartTime BETWEEN @TotalFrom AND @EndRangeTime\r\n\tAND dr.DeliveryServiceProviderId = 1\r\n\tAND DispatchRequestStatusId IN ( 30,35)\r\n) SQ\r\nOPTION(RECOMPILE)\r\n\r\n \r\n        SELECT  \r\n            SQ.BarIndex  AS labels,\r\n            COUNT(SQ.Id) AS dataValues\r\n        FROM  \r\n        ( \r\n\t\t\tSELECT NULL Id, @Bar1 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar2 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar3 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar4 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar5 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar6 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar7 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar8 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar9 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar10 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar11 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar12 BarIndex\r\n\t\t\tUNION ALL  \r\n            SELECT  \r\n               DR.Id,  \r\n                CASE  \r\n                    WHEN dr.UpdateDate \u003C @Bar1_BIGINT THEN @Bar1  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar1_BIGINT AND @Bar2_BIGINT THEN @Bar2  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar2_BIGINT AND @Bar3_BIGINT THEN @Bar3  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar3_BIGINT AND @Bar4_BIGINT THEN @Bar4  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar4_BIGINT AND @Bar5_BIGINT THEN @Bar5  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar5_BIGINT AND @Bar6_BIGINT THEN @Bar6  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar6_BIGINT AND @Bar7_BIGINT THEN @Bar7  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar7_BIGINT AND @Bar8_BIGINT THEN @Bar8  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar8_BIGINT AND @Bar9_BIGINT THEN @Bar9  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar9_BIGINT AND @Bar10_BIGINT THEN @Bar10  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar10_BIGINT AND @Bar11_BIGINT THEN @Bar11  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar11_BIGINT AND @Bar12_BIGINT THEN @Bar12  \r\n                    ELSE @Bar12  \r\n                END AS BarIndex\r\n\t\t\t\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\t\t\t\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\t\t\t\tON dr.PolygonStoreId=ps.Id\t\r\n\t\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\t\t\t\tON ps.polygonid=po.id AND PO.ID=@polygonId\r\n\t\t\t\tINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\t\t\t\t\tON po.CityID = c.ID\r\n\t\t\t\tINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\t\t\t\t\tON c.ProvinceID = prvnc.ID\r\n\t\t\t\tWHERE  DeliveryStartTime BETWEEN @TotalFrom AND @EndRangeTime\r\n\t\t\t\tAND dr.DeliveryServiceProviderId = 1\r\n\t\t\t\tAND DispatchRequestStatusId IN ( 30)\r\n                AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70)\r\n\r\n        ) SQ  \r\n        Group BY BarIndex  \r\n        ORDER BY BarIndex \r\n\tOPTION(RECOMPILE)\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Metropolis","Schema":"dbo","Definition":"\r\n\r\nCREATE           PROCEDURE [dbo].[Get_Dashboard_Metropolis] \r\n--declare\r\n\t \t @PolygonIds\t \t \t NVARCHAR(MAX),\r\n\t \t @StartRangeTime\t \t BIGINT,\r\n\t \t @EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType   TinyInt ,--NVARCHAR(MAX),\r\n\t \t @OrderBy\t \t \t NVARCHAR(200) = NULL,\r\n\t \t @IsASC\t \t \t \t BIT = NULL,\r\n\t \t @Result\t \t \t \t NVARCHAR(MAX) OUTPUT\r\nAS\r\nSET NOCOUNT ON\r\n\r\n\r\n\r\n\r\nDECLARE @EndRangeTime_5DaysAgo BIGINT\r\nSELECT @EndRangeTime_5DaysAgo = REPLACE(REPLACE(REPLACE(REPLACE(CONVERT( NVARCHAR, DATEADD(DAY,-5, CAST(CONVERT(varchar, FORMAT(@EndRangeTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) , 121 ),\u0027-\u0027,\u0027\u0027),\u0027:\u0027,\u0027\u0027),\u0027.\u0027,\u0027\u0027),\u0027 \u0027,\u0027\u0027)\r\n\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n\t declare @sql1\t nvarchar(max),\r\n\t \t \t @sql2\t nvarchar(max),\r\n\t \t \t @sql\t nvarchar(max)\r\n\t DECLARE @OrderByReplace NVARCHAR(200),\r\n\t \t \t @ScheduledStartTime DateTime,\r\n\t \t \t @TodayWithScheduledStartTime BIGINT\r\n\r\n\t SELECT @ScheduledStartTime = Value FROM CS_Public.HAF.Setting WHERE name = \u0027DispatchRequestSchedulerSetting.ScheduledStartTime\u0027\r\n\t SET @ScheduledStartTime = GETDATE() \u002B ISNULL(@ScheduledStartTime,\u002700:00:00\u0027)\r\n\t SELECT @TodayWithScheduledStartTime = FORMAT(@ScheduledStartTime,\u0027yyyyMMddHHmmss\u0027)\u002B\u0027999\u0027\r\n\r\n\t --SELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\r\n\t DROP TABLE IF EXISTS #Provinces\r\n\t DROP TABLE IF EXISTS #AllDispatcheRequests\r\n\t DROP TABLE IF EXISTS #shipment\r\n\t DROP TABLE IF EXISTS #ContinuesDelayed\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoint\r\n\t DROP TABLE IF EXISTS #CTE_SUM\r\n\t DROP TABLE IF EXISTS #CTE_DispatchRequest\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoints\r\n\t DROP TABLE IF EXISTS #CTE_CountOfEta\r\n\t DROP TABLE IF EXISTS #Store\r\n\r\n\r\n\t DECLARE @Today BIGINT=(SELECT CONVERT(char(8), GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027) )\r\n\t DECLARE @LastMonth BIGINT=(SELECT CONVERT(char(8),DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)-30,112)\u002BREPLACE(CONVERT(char(12),DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)-30, 114),\u0027:\u0027,\u0027\u0027) )\r\n\r\n\r\n\t IF (@StartRangeTime IS NULL ) \r\n\t OR (@EndRangeTime IS NULL )\r\n\t OR dbo.FN_DateDiff(@StartRangeTime,@EndRangeTime)\u003E31\r\n\t BEGIN\r\n\t \t SET @Result=-1 \r\n\t \t RETURN\r\n\t END\r\n\r\n\t--------------------------------------------- Insert Store Id\r\n\t\r\n\t \r\n\t DROP TABLE IF EXISTS #Polygon\r\n\t CREATE TABLE #Polygon\r\n\t (\r\n\t\tPolygonId SMALLINT\r\n\t )\r\n\r\n\t IF ISNULL(@PolygonIds,\u00270\u0027) = \u00270\u0027\r\n\t\t BEGIN\r\n\t\t\t\r\n\t\t\tINSERT INTO #Polygon ( PolygonId )\r\n\t\t\tSELECT \r\n\t \t\t\tp.ID PolygonId\r\n\t\t\tFROM CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\r\n\t\t END\r\n\t ELSE\r\n\t\t BEGIN\r\n\r\n\t\t\tINSERT INTO #Polygon ( PolygonId )\r\n\t\t\tSELECT \r\n\t \t\t\tp.ID PolygonId\r\n\t\t\tFROM CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\t\tINNER JOIN STRING_SPLIT(@PolygonIds,\u0027,\u0027) ss\r\n\t \t\t\tON p.Id = ss.value\r\n\r\n\t\t END\r\n\r\n\r\n\t DECLARE @MeanDeliveryTimeMinutes SMALLINT\r\n\t SELECT @MeanDeliveryTimeMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.MeanDeliveryTimeMinutes\u0027\r\n\t DECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t @ScheduledHyperDelayThresholdMinutes SMALLINT\r\n\t SELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\n\t SELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n\t SELECT \r\n\t \t ff.CityId,\r\n\t \t SUM(ff.EstimatedOrder) AS EstimatedOrderInNextHour,\r\n\t \t SUM(ff.EstimatedBiker) AS EstimatedAvailableFleetsInNextHour,\r\n\t \t /*SUM(ff.Mo2b)*/ CASE WHEN SUM(EstimatedBiker) = 0 AND SUM(@MeanDeliveryTimeMinutes  * EstimatedOrder) = 0 THEN 0 WHEN SUM(EstimatedBiker) = 0 AND SUM(@MeanDeliveryTimeMinutes  * EstimatedOrder) \u003E 0 THEN 100 ELSE SUM(@MeanDeliveryTimeMinutes  * EstimatedOrder)/SUM(EstimatedBiker) END  AS Mo2b,\r\n\t \t SUM(ff.BikerShortage) AS DriverShortageMinutes\r\n\t INTO #ForecastFleet\r\n\t FROM CS_Dispatcher.DP.ForecastFleet ff (NOLOCK)\r\n\t INNER JOIN #Polygon p\r\n\t \t ON ff.PolygonId = p.PolygonId\r\n\t \t --AND @DeliveryServiceProviderId = 1\r\n\t Group By\r\n\t \t ff.CityId\r\n\r\n\t SELECT \r\n\t \t crt.Id\r\n\t INTO #CourierRequestType\r\n\t FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n\t INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\t \t ON crt.Id = ss.value\r\n\t \t OR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\nSELECT \r\n\tc.ProvinceId,\r\n\tp.CityId,\r\n\tSUM(CASE WHEN DispatchRequestStatusId IN (5,6,7) AND dr.CourierRequestTypeId \u003C\u003E 51 THEN 1 ELSE 0 END) AS CountOfUnassignedRequest,\r\n\tSUM(CASE WHEN DispatchRequestStatusId IN (10,15,20,25,45,50,11,16,46,51 , 47,48,49,52,53,54) THEN 1 ELSE 0 END) AS CountOfInprogressRequest,\r\n\tSUM(CASE WHEN DispatchRequestStatusId IN (30,35)AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 Else 0 END) CountOfDelivered,\r\n\tSUM(CASE WHEN dr.DispatchRequestStatusId=30 AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfSlaOnTimeDelivery,\r\n\tSUM(CASE WHEN dr.DispatchRequestStatusId=35 AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfSlaDelayedDelivery,\r\n\tSUM(CASE WHEN DispatchRequestStatusId IN (30,35) AND CourierRequestTypeId IN (25,26,30,35) AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfReturnedDelivery,\r\n\tSUM(CASE WHEN DispatchRequestStatusId IN (17,40) AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfCanceledRequest,\r\n\tSUM(CASE WHEN dr.DispatchRequestStatusId = 35 AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime AND ((dr.CourierRequestTypeId IN ( 5,26,40,55,60 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @OndemandHyperDelayThresholdMinutes) OR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @ScheduledHyperDelayThresholdMinutes)) THEN 1 ELSE 0 END) AS CountOfSlaHyperDelayedDelivery\r\nINTO #AllDispatches\r\nFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\nINNER JOIN #CourierRequestType crt\r\n\tON dr.CourierRequestTypeId = crt.ID\r\nINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\tON dr.PolygonStoreId = ps.ID\r\nINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\tON ps.PolygonId = p.ID\r\nINNER JOIN #Polygon pp\r\n\tON p.ID = pp.PolygonId\r\nINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\tON p.CityId = c.ID AND C.IsMetropolis=1 \r\n--INNER JOIN #Store s (NOLOCK)\r\n--\tON s.VId = ps.StoreId\r\nWHERE dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\nAND DispatchRequestStatusId IN (30,35,17,40,5,6,7,10,15,20,25,45,50,11,16,46,51 , 47,48,49,52,53,54)\r\nAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\r\nAND\r\n(\r\n        @CustomerFilterType = 0\r\n        OR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n        OR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n        OR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n        OR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n)\r\nGroup By \r\n\tc.ProvinceId,\r\n\tp.CityId\r\nOPTION(RECOMPILE)\r\n\r\n\r\nSELECT \r\n\t c.ProvinceId , \r\n\t p.CityId,\r\n\t COUNT(CASE WHEN SQ.Type = 1 THEN Type ELSE NULL END ) CountOfTryingToAssign,\r\n\t COUNT(CASE WHEN SQ.Type = 2 THEN Type ELSE NULL END ) CountOfNormalSlaPickupQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 3 THEN Type ELSE NULL END ) CountOfDelayedSlaPickupQueue,\r\n\r\n\t COUNT(CASE WHEN SQ.Type = 4 THEN Type ELSE NULL END ) CountOfNormalSlaDeliveryQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 5 THEN Type ELSE NULL END ) CountOfDelayedSlaDeliveryQueue,\r\n\r\n\t COUNT(CASE WHEN SQ.Type = 6 THEN Type ELSE NULL END ) CountOfNormalEtaPickupQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 7 THEN Type ELSE NULL END ) CountOfDelayedEtaPickupQueue\r\nINTO #SlaCounts\r\nFROM\r\n(\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 1 Type \r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID AND C.IsMetropolis=1\r\n\tINNER JOIN CS_OrderManagement.OM.Parcel parcel (NOLOCK)\r\n\t\tON dr.ParcelReferenceCode = parcel.ParcelReferenceCode\r\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\tON parcel.CourierRequestId = cr.Id\r\n\t\tAND cr.ConfirmationDate IS NOT NULL\r\n  --INNER JOIN #Store S (NOLOCK)\r\n\t -- ON s.VId = ps.StoreId\r\n\tWHERE dr.CourierRequestTypeId \u003C\u003E 51\r\n\tAND dr.DispatchRequestStatusId IN ( 5,6,7 )\r\n    AND dr.DeliveryStartTime \u003E= @StartRangeTime AND dr.DeliveryStartTime \u003C= @TodayWithScheduledStartTime\r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\r\n\tAND\r\n(\r\n        @CustomerFilterType = 0\r\n        OR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n        OR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n        OR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n        OR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n)\r\n\r\n\tUNION ALL\r\n\tSELECT \r\n\t \tdr.ID ,\r\n\t\tdr.PolygonStoreId, \r\n\t\tCASE \r\n\t\t\tWHEN dr.DeliveryDeadLineTime \u003E @Today THEN 2 \r\n\t\t\tWHEN dr.DeliveryDeadLineTime \u003C= @Today THEN 3 \r\n\t\t\tELSE NULL \r\n\t\tEND Type\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN #CourierRequestType crt\r\n\t \tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \tON ps.PolygonId = p.ID\r\n\tINNER JOIN #Polygon pp\r\n\t \tON p.ID = pp.PolygonId\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \tON p.CityId = c.ID AND C.IsMetropolis=1\r\n  --INNER JOIN #Store S (NOLOCK)\r\n\t -- ON s.VId = ps.StoreId\r\n\tWHERE dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\tAND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\r\n\tAND\r\n    (\r\n        @CustomerFilterType = 0\r\n        OR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n        OR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n        OR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n        OR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n    )\r\n\tUNION ALL\r\n\tSELECT \r\n\t \tdr.ID ,\r\n\t\tdr.PolygonStoreId, \r\n\t\tCASE \r\n\t\t\tWHEN dr.DeliveryDeadLineTime \u003E @Today THEN 4 \r\n\t\t\tWHEN dr.DeliveryDeadLineTime \u003C= @Today THEN 5\r\n\t\t\tELSE NULL \r\n\t\tEND Type\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN #CourierRequestType crt\r\n\t \tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \tON ps.PolygonId = p.ID\r\n\tINNER JOIN #Polygon pp\r\n\t \tON p.ID = pp.PolygonId\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \tON p.CityId = c.ID AND C.IsMetropolis=1\r\n  --INNER JOIN #Store S (NOLOCK)\r\n\t -- ON s.VId = ps.StoreId\r\n\tWHERE dr.DispatchRequestStatusId IN ( 20,25,45,50,46,47,48,49,51,52,53,54 )\r\n\tAND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\r\n\t\tAND\r\n(\r\n        @CustomerFilterType = 0\r\n        OR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n        OR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n        OR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n        OR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n)\r\n\r\n\tUNION ALL\r\n\r\n\r\n\tSELECT \r\n\t \tSQ.ID,\r\n\t \tSQ.PolygonStoreId,\r\n\t \tSQ.Type\r\n\tFROM\r\n\t(\r\n\t \tSELECT DISTINCT\r\n\t \t \tSQ.ID,\r\n\t \t \tSQ.PolygonStoreId,\r\n\t \t \tSQ.Type\r\n\t \tFROM\r\n\t \t(\r\n\t \t \t \tSELECT \r\n\t \t \t \t \tdr.Id,\r\n\t \t \t \t \tdr.PolygonStoreId,\r\n\t \t \t \t \tCASE WHEN DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003E= GETDATE() THEN 6 ELSE 7 END [Type],\r\n\t \t \t \t \tROW_NUMBER() OVER ( PARTITION BY Dr.ID ORDER BY sdp.ShipmentID DESC , sdp.ID DESC ) RowNum\r\n\t \t \t \tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t \t \t \tINNER JOIN #CourierRequestType crt\r\n\t \t \t \t \tON dr.CourierRequestTypeId = crt.ID\r\n\t \t \t \tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t \t \t \tON dr.PolygonStoreId = ps.ID\r\n\t \t \t \tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t \t \t \tON ps.PolygonId = p.ID\r\n\t \t \t \tINNER JOIN #Polygon pp\r\n\t \t \t \t \tON p.ID = pp.PolygonId\r\n\t \t \t \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t \t \t \tON p.CityId = c.ID AND C.IsMetropolis=1\r\n\t\t\t\t--INNER JOIN #Store S (NOLOCK)\r\n\t\t\t\t--\tON s.VId = ps.StoreId\r\n\t \t \t \tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t \t \t \t \tON dr.Id = sdpdr.DispatchRequestId\r\n\t \t \t \tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t \t \t \t \tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t \t \t \tWHERE dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\t \t \t \tAND dr.DeliveryStartTime \u003E= @StartRangeTime AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t \t \t \tAND ( sdp.OperationTypeId IN ( 5,20 ) OR ( dr.CourierRequestTypeId = 51 AND sdp.OperationTypeId = 25 ))\r\n\t \t \t \tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\t\t\t\tAND\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t\t\t\t)\r\n\r\n\t \t) SQ\r\n\t \tWHERE SQ.RowNum = 1\r\n\t) SQ\r\n) SQ\r\nINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t ON SQ.PolygonStoreId = ps.ID\r\nINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t ON ps.PolygonId = p.ID\r\nINNER JOIN #Polygon pp\r\n\t ON p.ID = pp.PolygonId\r\nINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t ON p.CityId = c.ID AND C.IsMetropolis=1\r\n--INNER JOIN #Store S (NOLOCK)\r\n--\tON s.VId = ps.StoreId\r\nGroup By \r\n\t c.ProvinceId,\r\n\t p.CityId\r\n\r\n\tSELECT\t \r\n\t\tProvinceId,\r\n\t \tSUM(CASE WHEN ShipmentDestinationPointStatusId=20 THEN 1 ELSE 0 END) CountOfEtaOntimeDelivery,\r\n\t \tSUM(CASE WHEN ShipmentDestinationPointStatusId=25 THEN 1 ELSE 0 END) CountOfEtaDelayedDelivery,\r\n\t\t1 AS AveETA\r\n\tINTO #CTE_CountOfEta\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN #CourierRequestType crt\r\n\t \tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \tON ps.PolygonId = p.ID\r\n\tINNER JOIN #Polygon pp\r\n\t \tON p.ID = pp.PolygonId\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \tON p.CityId = c.ID AND C.IsMetropolis=1\r\n  --INNER JOIN #Store S (NOLOCK)\r\n\t -- ON s.VId = ps.StoreId\r\n\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t \tON dr.Id = sdpdr.DispatchRequestID\r\n\t\tAND dr.Version = sdpdr.Version\r\n\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t \tON sdp.ID = sdpdr.ShipmentDestinationPointID\r\n\tINNER JOIN CS_Dispatcher.DP.Shipment sh (NOLOCK)\r\n\t \tON sh.ID=sdp.ShipmentId\r\n\tWHERE dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\tAND dr.DispatchRequestStatusId IN ( 30,35 ) \r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0) \r\n\tAND sdp.OperationTypeId = 10\r\n\tAND sdp.ShipmentDestinationPointStatusId IN ( 20,25 )\r\n    AND\r\n\t\t(\r\n\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t)\r\n\r\n\r\n\r\n\tGroup By c.ProvinceId\r\n\tOPTION(RECOMPILE)\r\n\r\n\t SELECT\t \r\n\t \t DISTINCT\r\n\t \t dr.ProvinceId,\r\n\t \t dr.CityId , \r\n\t \t SUM(CountOfDelivered) CountOfDelivered,\r\n\t \t SUM(CountOfSlaOntimeDelivery) CountOfSlaOntimeDelivery,\r\n\t \t SUM(CountOfSlaDelayedDelivery)\tCountOfSlaDelayedDelivery,\r\n\t \t SUM(CountOfReturnedDelivery) CountOfReturnedDelivery,\r\n\t \t SUM(CountOfCanceledRequest) CountOfCanceledRequest,\r\n\t \t SUM(CountOfUnassignedRequest) CountOfUnassignedRequest,\r\n\t \t SUM(CountOfInprogressRequest) CountOfInprogressRequest,\r\n\t \t MAX(coe.CountOfEtaOntimeDelivery) CountOfEtaOntimeDelivery,\r\n\t \t MAX(coe.CountOfEtaDelayedDelivery) CountOfEtaDelayedDelivery,\r\n\t \t MAX(coe.AveEta) AveEta,\r\n\t \t SUM(CountOfSlaHyperDelayedDelivery) CountOfSlaHyperDelayedDelivery\r\n\t INTO #CTE_DispatchRequest\t \r\n\t FROM #AllDispatches dr\r\n\t INNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\t\tON dr.CityId = c.Id AND C.IsMetropolis=1 AND C.Id!=1166\r\n\t LEFT JOIN #CTE_CountOfEta coe\r\n\t \t ON dr.ProvinceId = coe.ProvinceId\r\n\t GROUP BY dr.ProvinceId , dr.CityId \r\n\r\n----------------------------------------------\r\n\tDECLARE @ShiftTime\t TIME=CAST(getdate() AS TIME),\r\n\t \t \t@ShiftDate\t DATE=CAST(GETDATE() AS DATE)\r\n\r\n\r\n\t\t SELECT \r\n\t \t\t\tProvinceId, \r\n\t\t\t\tCityId,\r\n\t \t\t\tISNULL(COUNT(DISTINCT CASE WHEN FleetStatusId = 10 THEN fleetid ELSE NULL END),0) countOfOfflineFleetInPolygon,\r\n\t\t\t\tISNULL(COUNT(DISTINCT CASE WHEN ((FleetStatusId=60 AND ReasonFleetChangeStateId IN (56,59,60,61,51))) THEN fleetid ELSE NULL END),0) countOfBanFleetInPolygon,\r\n\t\t\t\tISNULL\r\n\t\t\t\t(\r\n\t\t\t\t\tCOUNT\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tDISTINCT\r\n\t\t\t\t\t\t\tCASE\r\n\t\t\t\t\t\t\t\tWHEN\r\n\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t(FleetStatusId=5 AND ReasonFleetChangeStateId NOT IN (62))\r\n\t\t\t\t\t\t\t\t\tOR (FleetStatusId=15 AND ReasonFleetChangeStateId IN (50,54,58,62,51))\r\n\t\t\t    \t\t\t\t\tOR(FleetStatusId=60 AND ReasonFleetChangeStateId IN (54,58))\r\n\t\t\t\t\t\t\t\t) THEN FleetId ELSE NULL END\r\n\t\t\t\t\t)\r\n\t\t\t\t,0) countOfOnlineFleetInPolygon\r\n\t INTO #CountOfFleetInPolygon\r\n\tFROM  CS_DriverManagement.DM.ShiftFleetMap AS sfm2 WITH(NOLOCK)\r\n\tINNER JOIN CS_DriverManagement.DM.ShiftDate AS sd2 WITH(NOLOCK)\r\n\t\tON sd2.Id = sfm2.ShiftDateId\r\n\tINNER JOIN CS_DriverManagement.DM.Shift AS s2 WITH(NOLOCK)\r\n\t\tON s2.Id = sd2.ShiftId\r\n\tINNER JOIN #Polygon p \r\n\t\tON p.PolygonId = s2.PolygonId\r\n\tINNER JOIN CS_DriverManagement.DM.TimeSlot AS ts2 WITH(NOLOCK)\r\n\t\tON ts2.Id = s2.TimeSlotId\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet f WITH(NOLOCK)\r\n\t\tON sfm2.fleetid=f.id \r\n\t\tAND f.IsActive=1 \r\n\t\tAND sfm2.IsActive=1 \r\n\t\tAND (f.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\r\n\t \tON s2.PolygonId = pl.ID\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \tON pl.CityId = c.ID AND C.IsMetropolis=1\r\n\tWHERE sd2.Date = @ShiftDate AND @ShiftTime BETWEEN [ts2].[From] AND [ts2].[To]\r\n\tAND sd2.IsActive = 1\r\n\tAND s2.Status = 1\r\n\tAND sfm2.IsDeleted = 0\r\n\tAnd sfm2.IsAssigned = 1\r\n\tAND sfm2.IsActive = 1\r\n\tGROUP BY c.ProvinceId , pl.CityId\r\n\r\n\r\n\r\n\t;WITH CTE_Final AS(\r\n\t\t\tSELECT \r\n\t\t\t\tcount(SFM.IsAssigned) AS IsAssigned\r\n\t\t\t   ,EstimateCapacity\r\n\t\t\t   ,pr.id as ProvinceId\r\n\t\t\t   ,C.ID as CityId\r\n\t\t\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\t\t\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK) ON pl.CityId = c.ID AND C.IsMetropolis=1\r\n\t\t\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\t\t\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\t\t\tWHERE  sd.Date = @ShiftDate AND @ShiftTime BETWEEN [ts].[From] AND [ts].[To]\r\n\t\t  group by EstimateCapacity\r\n\t\t   ,pr.id \r\n\t\t   ,pl.id\r\n\t\t   ,C.ID)\r\n,CTE_DRCounts AS(\r\n            SELECT \r\n\t\t\t\tcount(SFM.IsAssigned) AS NEXTIsAssigned\r\n\t\t\t   ,EstimateCapacity AS NEXTIstimateCapacity\r\n\t\t\t   ,pr.id as ProvinceId\r\n\t\t\t   ,C.ID as CityId\r\n\t\t\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\t\t\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK) ON pl.CityId = c.ID AND C.IsMetropolis=1\r\n\t\t\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\t\t\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\t\t\tWHERE sd.Date = @ShiftDate AND  [ts].[From] in (SELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ts.[To]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN CS_Public.Haf.City cC (NOLOCK) ON pl.CityId = cC.ID AND C.IsMetropolis=1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE  sd.Date = @ShiftDate AND @ShiftTime BETWEEN [ts].[From] AND [ts].[To] AND CC.ProvinceId=C.ProvinceId AND CC.Id=C.Id )\r\n\r\n\r\n\r\n\r\n\t\t    --where sd.Date = @ShiftDate AND  [ts].[From] in (SELECT TOP  1 [From]\r\n\t\t    --                                              FROM  CS_DriverManagement.DM.TimeSlot (NOLOCK)\r\n\t\t\t\t\t\t--\t\t\t\t\t\t\t      where [From]\u003E@ShiftTime )\r\n\t\t  group by EstimateCapacity\r\n\t\t   ,pr.id \r\n\t\t   ,pl.id\r\n\t\t   ,C.ID)\r\n\r\nSELECT \r\n         F.ProvinceId,\r\n\t\t F.CityId,\r\n         CASE WHEN SUM(F.EstimateCapacity) = 0 THEN 0 ELSE CAST(ROUND((SUM(F.IsAssigned) * 100.0) / SUM(F.EstimateCapacity), 0) AS INT) END AS Capacity,\r\n\t\t CASE WHEN SUM(D.NEXTIstimateCapacity) = 0 THEN 0 ELSE CAST(ROUND((SUM(D.NEXTIsAssigned) * 100.0) / SUM(D.NEXTIstimateCapacity), 0) AS INT) END AS NCapacity\r\nINTO #Capacity\r\nFROM  CTE_Final F\r\nLEFT JOIN CTE_DRCounts D ON F.ProvinceId=D.ProvinceId\r\ngroup by F.ProvinceId,F.CityId\r\n\r\n\r\n----------------------------------------------\r\n\r\n\r\n\r\nDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027 SELECT @Result =\r\n\t (\r\n\t \t SELECT \r\n\t \t \t SUM(CountOfDelivered)\t \t \t \t \t \t \t \t \t \t \t totalCountOfDelivered,\r\n\t \t \t SUM(CountOfEtaOntimeDelivery)\t \t \t \t \t \t \t \t \t totalCountOfEtaOnTimeDelivery,\r\n\t \t \t SUM(CountOfEtaDelayedDelivery)\t \t \t \t \t \t \t \t \t totalCountOfEtaDelayedDelivery,\r\n\t \t \t SUM(CountOfSlaOntimeDelivery)\t \t \t \t \t \t \t \t \t totalCountOfSlaOnTimeDelivery,\r\n\t \t \t SUM(CountOfSlaDelayedDelivery)\t \t \t \t \t \t \t \t \t totalCountOfSlaDelayedDelivery,\r\n\r\n\t \t \t SUM(CountOfSlaDelayedDelivery) - SUM(CountOfSlaHyperDelayedDelivery) AS totalCountOfSlaNormalDelayedDelivery,\r\n\r\n\r\n\r\n\t\t\t CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfEtaOntimeDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT)) *100 END AS  totalPercentageCountOfEtaOnTimeDelivery,\r\n\t\t\t CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfEtaDelayedDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT)) *100 END AS totalPercentageCountOfEtaDelayedDelivery,\r\n\r\n\t\t\t SUM(ISNULL(CountOfInprogressRequest,0)) totalDisposal,\r\n\r\n\t \t \t SUM(CountOfSlaHyperDelayedDelivery) AS totalCountOfSlaHyperDelayedDelivery,\r\n\t \t \t CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaOntimeDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END AS totalPercentageOfSlaOnTimeDelivery,\r\n\t \t \t CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE 100 - (CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaOntimeDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END) - (CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END) END AS totalPercentageOfSlaNormalDelayedDelivery,\r\n\t \t \t CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END AS totalPercentageOfSlaHyperDelayedDelivery,\r\n\r\n\t \t \t SUM(CountOfReturnedDelivery)\t \t \t \t \t \t \t \t \t totalCountOfReturnedDelivery,\r\n\t \t \t SUM(CountOfCanceledRequest)\t \t \t \t \t \t \t \t \t totalCountOfCanceledRequest,\r\n\t \t \t SUM(CountOfUnassignedRequest)\t \t \t \t \t \t \t \t \t totalCountOfUnassignedRequest,\r\n\r\n\t \t \t SUM(ISNULL(sc.CountOfTryingToAssign,0)) totalCountOfTryingToAssign,\r\n\t \t \t SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)) totalCountOfNormalSlaPickupQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfDelayedSlaPickupQueue,0)) totalCountOfDelayedSlaPickupQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) totalCountOfPickupQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)) totalCountOfNormalSlaDeliveryQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) totalCountOfDelayedSlaDeliveryQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) totalCountOfDeliveryQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfNormalEtaPickupQueue,0)) totalCountOfNormalEtaPickupQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfDelayedEtaPickupQueue,0)) totalCountOfDelayedEtaPickupQueue,\r\n\t \t \t SUM(CountOfInprogressRequest) totalCountOfInprogressRequest,\r\n\t \t \t 0 totalCountOfUnsettledRequest,\r\n\t \t \t 1 totalContinuousDelayed,\r\n\t\t\t \u0027\u002700:00:00\u0027\u0027 totalAverageDeliveryTimeEta,\r\n\t\t\t \u0027\u002700:00:00\u0027\u0027 totalAverageDeliveryTimeSla,\r\n\t\t\t \u0027\u002700:00:00\u0027\u0027 totalAverageWatingForAssignment,\r\n\t\t\t \u0027\u002700:00:00\u0027\u0027 totalAverageEta,\r\n\t \t \t ( SELECT SUM(countOfOfflineFleetInPolygon) FROM #CountOfFleetInPolygon cofip )\t totalCountOfOfflineFleet,\r\n\t \t \t ( SELECT SUM(countOfOnlineFleetInPolygon) FROM #CountOfFleetInPolygon cofip )\t totalCountOfOnlineFleet,\r\n\t\t\t ( SELECT SUM(countOfBanFleetInPolygon) FROM #CountOfFleetInPolygon cofip )\t totalCountOfBanFleet,\r\n\t \t \t \u0027\u002BCAST(@MeanDeliveryTimeMinutes AS VARCHAR(MAX))\u002B\u0027 AS MeanDeliveryTimeMinutes,\r\n\t \t \t (\r\n\t \t \t \t SELECT\r\n\t \t \t \t \t a.cityId,\r\n\t \t \t \t \t city.Name cityTitle,\r\n\t \t \t \t \t a.provinceId,\r\n\t\t\t\t\t ISNULL(NC.Capacity,0) as percentageCapacity,\r\n\t\t\t\t\t ISNULL(Nc.NCapacity,0) as nextPercentageCapacity,\r\n\t \t \t \t \t prv.Name provinceTitle\r\n\t\t\t\t\t ,ISNULL((CountOfDelivered),0) countOfDelivered,\r\n\t \t \t \t \t ISNULL((CountOfEtaOntimeDelivery),0) countOfEtaOnTimeDelivery,\r\n\t \t \t \t \t ISNULL((CountOfEtaDelayedDelivery),0) countOfEtaDelayedDelivery,\r\n\t \t \t \t \t CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfEtaDelayedDelivery/CAST(CountOfDelivered AS FLOAT))*100 END AS percentageOfEtaDelayedDelivery,\r\n\t\t\t\t\t CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfEtaOntimeDelivery/CAST(CountOfDelivered AS FLOAT)) *100 END AS percentageOfEtaOnTimeDelivery,\r\n\t \t \t \t \t ISNULL((CountOfSlaOntimeDelivery),0)  countOfSlaOnTimeDelivery,\r\n\t \t \t \t \t ISNULL((CountOfSlaDelayedDelivery),0) countOfSlaDelayedDelivery,\r\n\t \t \t \t \t ISNULL(CountOfSlaHyperDelayedDelivery,0) AS countOfSlaHyperDelayedDelivery,\r\n\t \t \t \t \t CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfSlaOntimeDelivery/CAST(CountOfDelivered AS FLOAT))*100 END AS percentageOfSlaOnTimeDelivery,\r\n\t \t \t \t \t CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE 100 - (CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfSlaOntimeDelivery/CAST(CountOfDelivered AS FLOAT))*100 END) - (CASE WHEN CountOfDelivered = 0 THEN 0 ELSE (CountOfSlaHyperDelayedDelivery/CAST(CountOfDelivered AS FLOAT))*100 END) END AS percentageOfSlaDelayedDelivery,  --percentageOfSlaNormalDelayedDelivery,\r\n\t \t \t \t \t CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfSlaHyperDelayedDelivery/CAST(CountOfDelivered AS FLOAT))*100 END AS percentageOfSlaHyperDelayedDelivery,\r\n\t \t \t \t \t ISNULL((CountOfReturnedDelivery),0) countOfReturnedDelivery,\r\n\t \t \t \t \t ISNULL((CountOfCanceledRequest),0) countOfCanceledRequest,\r\n\t \t \t \t \t ISNULL((CountOfUnassignedRequest),0) countOfUnassignedRequest,\r\n\t \t \t \t \t ISNULL(sc.CountOfTryingToAssign,0) countOfTryingToAssign,\r\n\t \t \t \t \t CASE WHEN ISNULL(CountOfUnassignedRequest,0) = 0 THEN 0 ELSE (ISNULL(sc.CountOfTryingToAssign,0)/CAST(CountOfUnassignedRequest AS FLOAT))*100 END AS percentageOfTryingToAssign,\r\n\t \t \t \t \t ISNULL(sc.CountOfNormalSlaPickupQueue,0) countOfNormalSlaPickupQueue,\r\n\t \t \t \t \t ISNULL(sc.CountOfDelayedSlaPickupQueue,0) countOfDelayedSlaPickupQueue,\r\n\t \t \t \t \t ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0) countOfPickupQueue,\r\n\t \t \t \t \t ISNULL(sc.CountOfNormalSlaDeliveryQueue,0) countOfNormalSlaDeliveryQueue,\r\n\t \t \t \t \t ISNULL(sc.CountOfDelayedSlaDeliveryQueue,0) countOfDelayedSlaDeliveryQueue,\r\n\t \t \t \t \t CASE WHEN ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0) = 0 THEN 0 ELSE ((ISNULL(sc.CountOfDelayedEtaPickupQueue,0))/CAST(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)AS FLOAT))*100 END AS percentageOfDelayedEtaPickupQueue ,\r\n\t \t \t \t \t ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0) countOfDeliveryQueue,\r\n\t \t \t \t \t ISNULL(sc.CountOfNormalEtaPickupQueue,0) countOfNormalEtaPickupQueue,\r\n\t \t \t \t \t ISNULL(sc.CountOfDelayedEtaPickupQueue,0) countOfDelayedEtaPickupQueue,\r\n\t \t \t \t \t CASE WHEN ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0) = 0 THEN 0 ELSE (ISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)/CAST(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0) AS FLOAT))*100 END AS percentageOfDelayedSlaDeliveryQueue,\r\n\t \t \t \t \t ISNULL((CountOfInprogressRequest),0) countOfInprogressRequest,\r\n\t \t \t \t \t 0 countOfUnsettledRequest,\r\n\t \t \t \t \t 1 continuousDelayed,\r\n\t \t \t \t \t \u0027\u002700:00:00\u0027\u0027 averageDeliveryTimeEta,\r\n\t \t \t \t \t \u0027\u002700:00:00\u0027\u0027 averageDeliveryTimeSla,\r\n\t \t \t \t \t \u0027\u002700:00:00\u0027\u0027 averageWaitingForAssignment,\r\n\t \t \t \t \t \u0027\u002700:00:00\u0027\u0027 averageEta,\r\n\t \t \t \t \t ISNULL(cofip.countOfOfflineFleetInPolygon,0) countOfOfflineFleet,\r\n\t \t \t \t \t ISNULL(cofip.countOfOnlineFleetInPolygon,0) countOfOnlineFleet,\r\n\t\t\t\t\t ISNULL(cofip.countOfBanFleetInPolygon,0) countOfBanFleet,\r\n\t \t \t \t \t ISNULL(\u0027\u002BCAST(@MeanDeliveryTimeMinutes AS VARCHAR(MAX))\u002B\u0027,0) AS meanDeliveryTimeMinutes,\r\n\t \t \t \t \t ISNULL(ff.EstimatedOrderInNextHour,0) AS estimatedOrderInNextHour,\r\n\t \t \t \t \t ISNULL(ff.EstimatedAvailableFleetsInNextHour,0) AS estimatedAvailableFleetsInNextHour,\r\n\t \t \t \t \t ISNULL(ff.Mo2b,0) AS mo2b,\r\n\t \t \t \t \t ISNULL(ff.DriverShortageMinutes,0) AS driverShortageMinutes\r\n\t \t \t \t FROM  #CTE_DispatchRequest a\r\n\t\t\t\t INNER JOIN CS_Public.HAF.City city (NOLOCK)\r\n\t\t\t\t\tON a.CityId = city.Id AND city.IsMetropolis=1\r\n\t\t\t\tINNER JOIN CS_Public.HAF.Province prv (NOLOCK)\r\n\t\t\t\t\tON a.ProvinceId = prv.Id\r\n\t \t \t \t LEFT JOIN #CountOfFleetInPolygon cofip\r\n\t \t \t \t \t ON a.ProvinceId = cofip.ProvinceId\r\n\t \t \t \t \t AND a.CityID = cofip.CityId\r\n\t \t \t \t LEFT JOIN #SlaCounts sc\r\n\t \t \t \t \t ON a.ProvinceId = sc.ProvinceId\r\n\t \t \t \t \t AND a.CityID = sc.CityId\r\n\t \t \t \t LEFT JOIN #ForecastFleet ff\r\n\t \t \t \t \t ON a.CityId = ff.CityId\r\n                 LEFT JOIN #Capacity NC\r\n\t \t \t \t \t ON a.ProvinceId = NC.ProvinceId\r\n\t \t \t \t \t AND a.CityID = NC.CityId\r\n\r\n\t\t\t\t\t ORDER BY \u0027\u002BCASE WHEN @OrderBy IS NULL OR @OrderBy = \u0027\u0027 THEN \u0027 city.DisplayOrder \u0027 ELSE @OrderBy END \u002B CASE WHEN ISNULL(@IsASC,0) = 0 THEN \u0027 ASC \u0027 ELSE \u0027 DESC \u0027 END\u002B\r\n\t\t\t\t\u0027FOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t \t \t ) provinceRequestList \r\n\t\t\t \r\n\t \t FROM  \r\n\t\t #CTE_DispatchRequest a\r\n\t \t LEFT JOIN #SlaCounts sc\r\n\t \t \t ON a.ProvinceId = sc.ProvinceId\r\n\t\t\t AND a.CityID = sc.CityId \r\n\t \t LEFT JOIN #CountOfFleetInPolygon cofip\r\n\t \t \t ON a.ProvinceId = cofip.ProvinceId\r\n\t\t\t AND a.CityID = cofip.CityId\r\n\t \t FOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n\t )\r\n\t OPTION(MAXDOP 16,USE HINT(\u0027\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027\u0027))\r\n\t SET @Result=REPLACE(@Result,\u0027\u0027\u0022provinceRequestList\u0022:null\u0027\u0027,\u0027\u0027\u0022provinceRequestList\u0022:[]\u0027\u0027)\u0027\r\n\r\n\t --SELECT @STR\r\n\r\n\t DECLARE @Param NVARCHAR(4000) =\t\u0027 @Result NVARCHAR(MAX) OUTPUT\u0027\r\n\t EXECUTE sys.sp_executeSQL @STR,@Param,@Result = @Result OUTPUT\r\n\r\n\t \r\n"},{"Name":"Get_Dashboard_Metropolis_DeliveryChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Metropolis_DeliveryChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t \t @countOfQueue INT OUTPUT,\r\n\t\t @countOfInProgress INT OUTPUT,\r\n\t\t @totalCount INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@End BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027235900000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\nDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027\r\nSELECT\r\n\t@countOfQueue_DQE=ISNULL(COUNT([Queue]),0),\r\n\t@countOfInProgress_DQE=ISNULL(COUNT(InProgress),0),\r\n\t@totalCount_DQE=ISNULL(COUNT(Delivered),0) \r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN (5,6,7)  THEN DR.Id ELSE NULL END AS [Queue],\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN (10,15,20,25,45,50,11,16,46,51,47,48,49,52,53,54) THEN DR.Id ELSE NULL END AS InProgress,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 30,35 ) AND  CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) THEN DR.Id ELSE NULL END AS Delivered\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n\t\tAND c.IsMetropolis = 1\r\n\tWHERE dr.DeliveryStartTime BETWEEN   \u0027\u002BCAST(@TotalFrom AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@End AS VARCHAR(MAX))\u002B\u0027\r\n\tAND [DispatchRequestStatusId] IN (30,35,17,40,5,6,7,10,15,20,25,45,50,11,16,46,51 , 47,48,49,52,53,54)\u0027\r\n\t\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\t\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\t\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\t\tIF @CustomerFilterType \u003E 0\r\n\t\tBEGIN\r\n\t\t\tIF @CustomerFilterType = 1\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\t\tIF @CustomerFilterType = 2\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\t\tIF @CustomerFilterType = 3\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\t\tIF @CustomerFilterType = 4\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\t\tEND\r\n\r\nSET @STR \u002B= \r\n\u0027 ) SQ\r\n\r\n\r\nSELECT  \r\n\r\n    CAST( SQ.BarIndex AS DATETIME)  as labels,\r\n    COUNT(SQ.Id) AS dataValues\r\n FROM  \r\n(  \r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n    SELECT  \r\n        dr.Id,  \r\n        CASE  \r\n            WHEN dr.UpdateDate \u003C \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar12_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027\r\n            ELSE \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027  \r\n        END AS BarIndex\r\n            FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)  \r\n            INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)  \r\n                ON dr.PolygonStoreId = ps.ID  \r\n            INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)  \r\n                ON ps.PolygonId = p.ID  \r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\t\t\tON pos.PolygonId = P.Id\r\n\t\t\t\tAND pos.IsActive = 1 \r\n            INNER JOIN CS_Public.Haf.City c (NOLOCK)  \r\n                ON p.CityId = c.ID  \r\n\t\t\t\tAND c.IsMetropolis = 1\r\n            WHERE dr.UpdateDate BETWEEN  \u0027\u002BCAST(@From AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B\u0027  \r\n            AND dr.[DispatchRequestStatusId] IN (30,35)  \u0027\r\n    IF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @CustomerFilterType \u003E 0\r\n\tBEGIN\r\n\t\tIF @CustomerFilterType = 1\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\tIF @CustomerFilterType = 2\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\tIF @CustomerFilterType = 3\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\tIF @CustomerFilterType = 4\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\tEND\r\n\r\nSET @STR \u002B=\r\n\u0027 ) SQ  \r\nGroup BY BarIndex  \r\nORDER BY BarIndex\u0027\r\n\r\nDECLARE @Param NVARCHAR(MAX) = \u0027\u0027\r\nSET @Param = \u0027 @countOfQueue_DQE INT OUTPUT,@countOfInProgress_DQE INT OUTPUT,@totalCount_DQE INT OUTPUT\u0027\r\n\r\nEXECUTE sys.sp_executeSQL \r\n\t@STR,@Param, \r\n\t@countOfQueue_DQE = @countOfQueue OUTPUT,\r\n\t@countOfInProgress_DQE = @countOfInProgress OUTPUT,\r\n\t@totalCount_DQE = @totalCount OUTPUT\r\n\r\nSET @title=N\u0027\u0633\u0641\u0627\u0631\u0634\u0627\u062A\u0027\r\n\r\nEND\r\n\r\n"},{"Name":"Get_Dashboard_Metropolis_ETAChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Metropolis_ETAChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t\t @countOfDelayed INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n--DROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\n--SELECT \r\n--\tcrt.Id\r\n--INTO #CourierRequestType\r\n--FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n--INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n--\tON crt.Id = ss.value\r\n--\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT);\r\n\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\n\r\nDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027\r\nSELECT\r\n\r\n\t@countOfDelivered_DQE=ISNULL(COUNT(Delivered),0),\r\n\t@countOfDelayed_DQE=ISNULL(COUNT(Delayed),0)\r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\r\n\t\tCASE WHEN ShipmentDestinationPointStatusId IN (20 ) THEN DR.Id ELSE NULL END AS Delivered,\r\n\t\tCASE WHEN ShipmentDestinationPointStatusId IN (25 ) THEN DR.Id ELSE NULL END AS Delayed\r\n\r\n\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t--INNER JOIN #CourierRequestType crt\r\n\t--\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n\t\tAND c.IsMetropolis = 1\r\n    INNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\tON dr.ID = sdpdr.DispatchRequestId\r\n\tAND dr.Version = sdpdr.Version\r\n    INNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\tWHERE dr.DeliveryStartTime  BETWEEN \u0027 \u002BCAST(@TotalFrom AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027\r\n\tAND dr.DispatchRequestStatusId IN ( 30,35 ) \r\n\tAND sdp.OperationTypeId = 10\r\n\tAND sdp.ShipmentDestinationPointStatusId IN ( 20,25 )\u0027\r\n\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @CustomerFilterType \u003E 0\r\n\tBEGIN\r\n\t\tIF @CustomerFilterType = 1\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\tIF @CustomerFilterType = 2\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\tIF @CustomerFilterType = 3\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\tIF @CustomerFilterType = 4\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\tEND\r\nSET @STR \u002B= \r\n\u0027 ) SQ\r\n \r\nSELECT  \r\n\r\n  CAST( SQ.BarIndex AS DATETIME)  as labels,\r\n    COUNT(SQ.Id) AS dataValues\r\n FROM  \r\n(  \r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n    SELECT  \r\n        dr.Id,  \r\n        CASE  \r\n            WHEN dr.UpdateDate \u003C \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar12_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027\r\n            ELSE \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027  \r\n        END AS BarIndex\r\n            FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK) \r\n\t\t\t--INNER JOIN #CourierRequestType crt\r\n\t\t --       ON dr.CourierRequestTypeId = crt.ID\r\n            INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)  \r\n                ON dr.PolygonStoreId = ps.ID  \r\n            INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)  \r\n                ON ps.PolygonId = p.ID  \r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\t\t\tON pos.PolygonId = P.Id\r\n\t\t\t\tAND pos.IsActive = 1 \r\n  \t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\t\t\tON p.CityId = c.ID\r\n\t\t\t\tAND c.IsMetropolis = 1\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\t\t\t\tON dr.ID = sdpdr.DispatchRequestId\r\n\t\t\tAND dr.Version = sdpdr.Version\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\t\t\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\t\tWHERE dr.UpdateDate BETWEEN    \u0027 \u002BCAST(@From AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027 \r\n\t\t\tAND dr.DispatchRequestStatusId IN ( 30 ) \r\n\t\t\tAND DR.CourierRequestTypeId IN (5,15)\r\n\t\t\tAND sdp.OperationTypeId = 10\r\n\t\t\tAND sdp.ShipmentDestinationPointStatusId IN ( 20 )\u0027\r\n\t\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\t\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\t\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\t\tIF @CustomerFilterType \u003E 0\r\n\t\tBEGIN\r\n\t\t\tIF @CustomerFilterType = 1\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\t\tIF @CustomerFilterType = 2\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\t\tIF @CustomerFilterType = 3\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\t\tIF @CustomerFilterType = 4\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\t\t\tEND\r\n\t\tSET @STR \u002B=\r\n\t\t\u0027 ) SQ  \r\n\t\tGroup BY BarIndex  \r\n\t\tORDER BY BarIndex\u0027\r\n\r\n\t\tDECLARE @Param NVARCHAR(MAX) = \u0027\u0027\r\n\t\tSET @Param = \u0027 @countOfDelivered_DQE INT OUTPUT,@countOfDelayed_DQE INT OUTPUT\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL \r\n\t\t\t@STR,@Param, \r\n\t\t\t@countOfDelivered_DQE = @countOfDelivered OUTPUT,\r\n\t\t\t@countOfDelayed_DQE = @countOfDelayed OUTPUT\r\n\r\n\t\tSET @title=N\u0027\u0628\u0631\u0645\u0628\u0646\u0627\u06CC ETA\u0027\r\n\t\tEND"},{"Name":"Get_Dashboard_Metropolis_SLAChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Metropolis_SLAChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t \t @countOfDelayed INT OUTPUT,\r\n\t\t @countOfHyperDelaye INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\n\r\n\t DECLARE @MeanDeliveryTimeMinutes SMALLINT\r\n\t SELECT @MeanDeliveryTimeMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.MeanDeliveryTimeMinutes\u0027\r\n\r\n\t DECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t \t \t @ScheduledHyperDelayThresholdMinutes SMALLINT\r\n\t SELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\n\t SELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n--DROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\n--SELECT \r\n--\tcrt.Id\r\n--INTO #CourierRequestType\r\n--FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n--INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n--\tON crt.Id = ss.value\r\n--\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\n\r\nDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027\r\nSELECT\r\n\r\n\t@countOfDelivered_DQE=ISNULL(COUNT(Delivered),0),\r\n\t@countOfDelayed_DQE=ISNULL(COUNT(Delayed),0),\r\n\t@countOfHyperDelaye_DQE=ISNULL(COUNT(HyperDelaye),0)\r\n\t\r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 30 ) THEN DR.Id ELSE NULL END AS Delivered,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 35 ) THEN DR.Id ELSE NULL END AS Delayed,\r\n\t\tCASE WHEN [DispatchRequestStatusId] = 35  AND ((dr.CourierRequestTypeId IN ( 5,26,40,55,60 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME)) \u003E \u0027 \u002B CAST(@OndemandHyperDelayThresholdMinutes AS VARCHAR(MAX))\u002B\u0027) OR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME)) \u003E \u0027 \u002BCAST( @ScheduledHyperDelayThresholdMinutes  AS VARCHAR(MAX))\u002B\u0027)) THEN DR.Id ELSE NULL END AS HyperDelaye\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t--INNER JOIN #CourierRequestType crt\r\n\t--\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n\t\tAND c.IsMetropolis = 1\r\n\tWHERE dr.DeliveryStartTime BETWEEN  \u0027 \u002B CAST(@TotalFrom AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX)) \u002B \u0027 \r\n\tAND [DispatchRequestStatusId] IN (30,35)\r\n\tAND  CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70)\u0027\r\n\r\n\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @CustomerFilterType \u003E 0\r\n\tBEGIN\r\n\t\tIF @CustomerFilterType = 1\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\tIF @CustomerFilterType = 2\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\tIF @CustomerFilterType = 3\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\tIF @CustomerFilterType = 4\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\tEND\r\nSET @STR \u002B= \r\n\u0027 ) SQ\r\n\r\n\r\n \r\n\tSELECT  \r\n\r\n\t  CAST( SQ.BarIndex AS DATETIME)  as labels,\r\n\t\tCOUNT(SQ.Id) AS dataValues\r\n\t FROM  \r\n\t(  \r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\t\tUNION ALL\r\n\t\tSELECT  \r\n\t\t\tdr.Id,  \r\n\t\t\tCASE  \r\n\t\t\t\tWHEN dr.UpdateDate \u003C \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tWHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar12_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027\r\n\t\t\t\tELSE \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027  \r\n\t\t\tEND AS BarIndex\r\n\t\t\t\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t\t\t\t--INNER JOIN #CourierRequestType crt\r\n\t\t\t\t--\tON dr.CourierRequestTypeId = crt.ID\r\n\t\t\t\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)  \r\n\t\t\t\t\tON dr.PolygonStoreId = ps.ID  \r\n\t\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)  \r\n\t\t\t\t\tON ps.PolygonId = p.ID  \r\n\t\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\t\t\t\tON pos.PolygonId = P.Id\r\n\t\t\t\t\tAND pos.IsActive = 1 \r\n\t\t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK)  \r\n\t\t\t\t\tON p.CityId = c.ID  \r\n\t\t\t\t\tAND c.IsMetropolis = 1\r\n\t\t\t\tWHERE dr.UpdateDate BETWEEN \u0027 \u002BCAST(@From AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027 \r\n\t\t\t\tAND dr.[DispatchRequestStatusId] IN (30)  \r\n\t\t\t\tAND DR.CourierRequestTypeId IN (5,15)\u0027\r\n\t\t\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\t\t\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\t\t\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\t\t\tIF @CustomerFilterType \u003E 0\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @CustomerFilterType = 1\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 2\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 3\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 4\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\t\t\tEND\r\nSET @STR \u002B=\r\n\u0027 ) SQ  \r\nGroup BY BarIndex  \r\nORDER BY BarIndex\u0027\r\n\r\nDECLARE @Param NVARCHAR(MAX) = \u0027\u0027\r\nSET @Param = \u0027 @countOfDelivered_DQE INT OUTPUT,@countOfDelayed_DQE INT OUTPUT,@countOfHyperDelaye_DQE INT OUTPUT\u0027\r\n\r\nEXECUTE sys.sp_executeSQL \r\n\t@STR,@Param, \r\n\t@countOfDelivered_DQE = @countOfDelivered OUTPUT,\r\n\t@countOfDelayed_DQE = @countOfDelayed OUTPUT ,\r\n\t@countOfHyperDelaye_DQE = @countOfHyperDelaye OUTPUT\r\n\r\n  SET  @title=N\u0027\u0628\u0631\u0645\u0628\u0646\u0627\u06CC SLA\u0027\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Polygon","Schema":"dbo","Definition":"\r\n\r\nCREATE  PROCEDURE [dbo].[Get_Dashboard_Polygon]\r\n--declare\r\n\t \t @PolygonIds\t \t \t NVARCHAR(MAX),\r\n\t \t @StartRangeTime\t \t BIGINT,\r\n\t \t @EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType  TinyInt,-- NVARCHAR(MAX),\r\n\t \t @OrderBy\t \t \t NVARCHAR(200) = NULL,\r\n\t \t @IsASC\t \t \t \t BIT = NULL,\r\n\t \t @Result\t \t \t \t NVARCHAR(MAX) OUTPUT\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\n\r\n\r\nDECLARE @EndRangeTime_5DaysAgo BIGINT\r\nSELECT @EndRangeTime_5DaysAgo = REPLACE(REPLACE(REPLACE(REPLACE(CONVERT( NVARCHAR, DATEADD(DAY,-2, CAST(CONVERT(varchar, FORMAT(@EndRangeTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) , 121 ),\u0027-\u0027,\u0027\u0027),\u0027:\u0027,\u0027\u0027),\u0027.\u0027,\u0027\u0027),\u0027 \u0027,\u0027\u0027)\r\n\r\nDECLARE @Today BIGINT=(SELECT CONVERT(char(8), GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027) )\r\n\r\n--select  @PolygonIds\t \t \t =\u00274,5,10,13,14,16,18,20,22,23,24,25,26,29,30,31,32,33,34,35,36,37,38,39,41,43,45,46,47,48,49,50,51,54,55,56,57,58,59,60,61,62,63,69\u0027,\r\n--\t \t @StartRangeTime\t \t =20220629000000000,\r\n--\t \t @EndRangeTime\t \t =20220629235999999\r\n\r\n\t declare @sql1 nvarchar(max) = \u0027\u0027,\r\n\t \t \t @sql2 nvarchar(max) = \u0027\u0027,\r\n\t \t \t @sql nvarchar(max) = \u0027\u0027\r\n\r\n\t DECLARE @OrderByReplace NVARCHAR(200),\r\n\t \t \t @ScheduledStartTime DateTime,\r\n\t \t \t @TodayWithScheduledStartTime BIGINT\r\n\r\n\t SELECT @ScheduledStartTime = Value FROM CS_Public.HAF.Setting (NOLOCK) WHERE name = \u0027DispatchRequestSchedulerSetting.ScheduledStartTime\u0027\r\n\t SET @ScheduledStartTime = GETDATE() \u002B ISNULL(@ScheduledStartTime,\u002700:00:00\u0027)\r\n\t SELECT @TodayWithScheduledStartTime = FORMAT(@ScheduledStartTime,\u0027yyyyMMddHHmmss\u0027)\u002B\u0027999\u0027\r\n\r\n\t --SELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\t IF @OrderByReplace IS NULL OR @OrderByReplace = \u0027\u0027\r\n\t\tIF @IsAsc = 1\r\n\t\t\tSET @OrderByReplace = \u0027Mo2b\u0027\r\n\t\tELSE\r\n\t\t\tSET @OrderByReplace = \u0027Mo2b DESC\u0027\r\n\tELSE\r\n\t\tIF @IsAsc = 1\r\n\t\t\tSET @OrderByReplace = @OrderByReplace \u002B \u0027 ASC\u0027\r\n\t\tELSE\r\n\t\t\tSET @OrderByReplace = @OrderByReplace \u002B \u0027 DESC\u0027\r\n\r\n\t DROP TABLE IF EXISTS #Polygon\r\n\t DROP TABLE IF EXISTS #AllDispatches\r\n\t DROP TABLE IF EXISTS #shipment\r\n\t DROP TABLE IF EXISTS #ContinuesDelayed\r\n\t DROP TABLE IF EXISTS #CTE_CountOfEta\r\n\t DROP TABLE IF EXISTS #CTE_DispatchRequest\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoints\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoint\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoint3\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoint_Total\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoint_Inpolygon\r\n\t DROP TABLE IF EXISTS #CountOfFleetInPolygon\r\n\t DROP TABLE IF EXISTS #Store\r\n\r\n\t IF (@StartRangeTime IS NULL ) \r\n\t OR (@EndRangeTime IS NULL )\r\n\t OR dbo.FN_DateDiff(@StartRangeTime,@EndRangeTime)\u003E31\r\n\t BEGIN\r\n\t \t SET @Result=-1 \r\n\t \t RETURN\r\n\t END\r\n\r\n\r\n\r\n\t CREATE TABLE #PolygonId \r\n\t (\r\n\t \t Id\t SMALLINT\r\n\t )\r\n\r\n\t IF ISNULL(@PolygonIds,\u00270\u0027) = \u00270\u0027\r\n\t\t BEGIN\r\n\t\t\t\r\n\t\t\tINSERT INTO #PolygonId (Id )\r\n\t\t\tSELECT \r\n\t \t\t\tp.ID PolygonId\r\n\t\t\tFROM CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\t\tWHERE P.IsActive=1\r\n\r\n\t\t END\r\n\t ELSE\r\n\t\t BEGIN\r\n\r\n\t\t\tINSERT INTO #PolygonId ( Id )\r\n\t\t\tSELECT \r\n\t \t\t\tp.ID PolygonId\r\n\t\t\tFROM CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\t\tINNER JOIN STRING_SPLIT(@PolygonIds,\u0027,\u0027) ss\r\n\t \t\t\tON p.Id = ss.value\r\n            WHERE P.IsActive=1\r\n\r\n\t\t END\r\n\r\n\r\n\t SELECT \r\n\t \t ff.PolygonId,\r\n\t \t SUM(ff.EstimatedOrder) AS EstimatedOrderInNextHour,\r\n\t \t SUM(ff.EstimatedBiker) AS EstimatedAvailableFleetsInNextHour,\r\n\t \t SUM(ff.Mo2b) AS Mo2b,\r\n\t \t SUM(ff.BikerShortage) AS DriverShortageMinutes\r\n\t INTO #ForecastFleet\r\n\t FROM CS_Dispatcher.DP.ForecastFleet ff (NOLOCK)\r\n\t INNER JOIN #PolygonId p\r\n\t \t ON ff.PolygonId = p.Id\r\n\t \t --AND @DeliveryServiceProviderId = 1\r\n\t Group By\r\n\t \t ff.PolygonId\r\n\r\n\t DECLARE @MeanDeliveryTimeMinutes SMALLINT\r\n\t SELECT @MeanDeliveryTimeMinutes = Value FROM CS_Public.Haf.Setting (NOLOCK) WHERE Name = \u0027DispatchRequestSettings.MeanDeliveryTimeMinutes\u0027\r\n\r\n\t DECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t \t \t  @ScheduledHyperDelayThresholdMinutes SMALLINT\r\n\t SELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\n\t SELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n\t SET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n\t SELECT \r\n\t \t crt.Id\r\n\t INTO #CourierRequestType\r\n\t FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n\t INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\t \t ON crt.Id = ss.value\r\n\t \t OR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\t DECLARE @ShiftTime\t TIME=CAST(getdate() AS TIME),\r\n\t \t \t @ShiftDate\t DATE=CAST(GETDATE() AS DATE)\r\n\t DECLARE @WeedDayId\t TINYINT=(SELECT DATEPART(dw,GETDATE())-1)\r\n\r\n\r\n\t SELECT\t DISTINCT\r\n\t \t \t prvnc.id as ProvinceId,\r\n\t \t \t prvnc.Name\t ProvinceTitle,\r\n\t \t \t c.name as CityName,\r\n\t \t \t p.Id\t \t \t PolygonId,\r\n\t \t \t --CASE WHEN po.CityId = 306 THEN po.PersianTitle ELSE po.title END\t \t polygonTitle,\r\n\t\t\t CASE WHEN po.PersianTitle is not null THEN po.PersianTitle ELSE po.title END\t \t polygonTitle,\r\n\t \t \t c.id\t \t RegionKey\r\nINTO #Polygon\r\nfrom CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \r\nINNER JOIN CS_Dispatcher.DP.Polygon po (NOLOCK)\r\n\t  ON po.Id=ps.PolygonId\r\nINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \t \t \r\n      ON p.Id=po.id\r\nINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\t  ON po.CityID = c.ID\r\nINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)\r\n\t  ON c.ProvinceID = prvnc.ID\r\nINNER JOIN CS_Dispatcher.DP.Store s (NOLOCK)\r\n\t  ON ps.StoreId = s.ID\r\n\r\n\r\nWHERE \r\n\r\n        @CustomerFilterType = 0\r\n        OR (@CustomerFilterType = 1 AND S.VendorId NOT IN (37,726,41))\r\n        OR (@CustomerFilterType = 2 AND S.VendorId IN (37))\r\n        OR (@CustomerFilterType = 3 AND S.VendorId IN (726))\r\n        OR (@CustomerFilterType = 4 AND S.VendorId IN (41))\r\n\r\n/*---------------------------------------------------------------------*/\r\n\r\nSELECT \r\n\tId\r\nINTO #DeliveryServiceProvider\r\nFROM CS_Dispatcher.DP.DeliveryServiceProvider (NOLOCK)\r\nWHERE ID = @DeliveryServiceProviderId\r\nOR ISNULL(@DeliveryServiceProviderId,0) = 0\r\n\r\n\r\nSELECT \r\n\tPolygonId,\r\n\t \tISNULL(COUNT(DISTINCT CASE WHEN FleetStatusId = 10 THEN fleetid ELSE NULL END),0) countOfOfflineFleetInPolygon,\r\n\t\tISNULL(COUNT(DISTINCT CASE WHEN ((FleetStatusId=60 AND ReasonFleetChangeStateId IN (56,59,60,61,51))) THEN fleetid ELSE NULL END),0) countOfBanFleetInPolygon,\r\n\t\tISNULL\r\n\t\t(\r\n\t\t\tCOUNT\r\n\t\t\t(\r\n\t\t\t\tDISTINCT\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\t\tWHEN\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t(FleetStatusId=5 AND ReasonFleetChangeStateId NOT IN (62))\r\n\t\t                    OR (FleetStatusId=15 AND ReasonFleetChangeStateId IN (50,54,58,62,51))\r\n\t\t\t    \t\t\tOR(FleetStatusId=60 AND ReasonFleetChangeStateId IN (50,54,58))\r\n\t\t\t\t\t\t) THEN FleetId ELSE NULL END\r\n\t\t\t)\r\n\t\t,0) countOfOnlineFleetInPolygon\r\nINTO #CountOfFleetInPolygon\r\nfrom\r\n(\r\n\tSELECT \r\n\t\t\t f.id\t\t\t\t\t\t\tFleetId \r\n\t\t\t,f.FleetStatusId\r\n\t\t\t,s2.Polygonid PolygonId\r\n\t\t\t,f.ReasonFleetChangeStateId\r\n\t FROM  CS_DriverManagement.DM.ShiftFleetMap AS sfm2 \t(NOLOCK) \r\n\t INNER JOIN CS_DriverManagement.DM.ShiftDate AS sd2 ON sd2.Id = sfm2.ShiftDateId\r\n\t INNER JOIN CS_DriverManagement.DM.Shift AS s2 ON s2.Id = sd2.ShiftId\r\n\t INNER JOIN CS_DriverManagement.DM.TimeSlot AS ts2 ON ts2.Id = s2.TimeSlotId\r\n\t INNER JOIN CS_DriverManagement.DM.Fleet f\t \t(NOLOCK) ON sfm2.fleetid=f.id AND f.IsActive=1 AND sfm2.IsActive=1 \r\n \t\tINNER JOIN #DeliveryServiceProvider DSP\r\n\t\t\tON f.DeliveryServiceProviderId = dsp.Id\r\n\tINNER JOIN #Polygon p ON p.PolygonId=s2.PolygonId\r\n\tWHERE sd2.Date = @ShiftDate AND @ShiftTime BETWEEN [ts2].[From] AND [ts2].[To]\r\n\tAND sd2.IsActive = 1\r\n\tAND s2.Status = 1\r\n\tAND sfm2.IsDeleted = 0\r\n\tAnd sfm2.IsAssigned = 1\r\n\tAND sfm2.IsActive = 1\r\n) T\r\n GROUP BY polygonid\r\n\r\n\r\n\r\n\r\n\t;WITH CTE_Final AS(\r\n\t\t\tSELECT \r\n\t\t\t\tcount(SFM.IsAssigned) AS IsAssigned\r\n\t\t\t   ,EstimateCapacity\r\n\t\t\t   ,p.PolygonId\r\n\t\t\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\t\t\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK) ON pl.CityId = c.ID\r\n\t\t\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\t\t\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\t\t\tWHERE  sd.Date = @ShiftDate AND @ShiftTime BETWEEN [ts].[From] AND [ts].[To]\r\n\t\t  group by EstimateCapacity\r\n\t\t   ,p.PolygonId)\r\n,CTE_DRCounts AS(\r\n            SELECT \r\n\t\t\t\tcount(SFM.IsAssigned) AS NEXTIsAssigned\r\n\t\t\t   ,EstimateCapacity AS NEXTIstimateCapacity\r\n\t\t\t   ,p.PolygonId\r\n\t\t\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\t\t\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK) ON pl.CityId = c.ID\r\n\t\t\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\t\t\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\t\t    where sd.Date = @ShiftDate AND  [ts].[From] in (   SELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ts.[To]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon pll (NOLOCK)\tON s.PolygonId = pll.ID\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN CS_Public.Haf.City cC (NOLOCK) ON pl.CityId = cC.ID\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE  sd.Date = @ShiftDate AND @ShiftTime BETWEEN [ts].[From] AND [ts].[To] AND CC.ProvinceId=C.ProvinceId and pl.Id=pll.id)\r\n\r\n\r\n\r\n\t\t  group by EstimateCapacity\r\n\t\t   ,p.PolygonId)\r\n\r\nSELECT \r\n         F.PolygonId,\r\n         CASE WHEN SUM(F.EstimateCapacity) = 0 THEN 0 ELSE CAST(ROUND((SUM(F.IsAssigned) * 100.0) / SUM(F.EstimateCapacity), 0) AS INT) END AS Capacity,\r\n\t\t CASE WHEN SUM(D.NEXTIstimateCapacity) = 0 THEN 0 ELSE CAST(ROUND((SUM(D.NEXTIsAssigned) * 100.0) / SUM(D.NEXTIstimateCapacity), 0) AS INT) END AS NCapacity\r\nINTO #Capacity\r\nFROM  CTE_Final F\r\nLEFT JOIN CTE_DRCounts D ON F.PolygonId=D.PolygonId\r\ngroup by  F.PolygonId\r\n\r\n\r\n\r\nSELECT \r\n\t ps.PolygonId,\r\n\t COUNT(CASE WHEN SQ.Type = 1 THEN Type ELSE NULL END ) CountOfTryingToAssign,\r\n\t COUNT(CASE WHEN SQ.Type = 2 THEN Type ELSE NULL END ) CountOfNormalSlaPickupQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 3 THEN Type ELSE NULL END ) CountOfDelayedSlaPickupQueue,\r\n\r\n\t COUNT(CASE WHEN SQ.Type = 4 THEN Type ELSE NULL END ) CountOfNormalSlaDeliveryQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 5 THEN Type ELSE NULL END ) CountOfDelayedSlaDeliveryQueue,\r\n\r\n\t COUNT(CASE WHEN SQ.Type = 6 THEN Type ELSE NULL END ) CountOfNormalEtaPickupQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 7 THEN Type ELSE NULL END ) CountOfDelayedEtaPickupQueue\r\n\r\nINTO #SlaCounts\r\nFROM\r\n(\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 1 Type \r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\t\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\t \t --AND c.IsMetropolis = 1\r\n\tINNER JOIN CS_OrderManagement.OM.Parcel parcel (NOLOCK)\r\n\t\tON dr.ParcelReferenceCode = parcel.ParcelReferenceCode\r\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\tON parcel.CourierRequestId = cr.Id\r\n\t\tAND cr.ConfirmationDate IS NOT NULL\r\n\t WHERE dr.CourierRequestTypeId \u003C\u003E 51\r\n\t AND dr.DispatchRequestStatusId IN ( 5,6,7 )\r\n\t AND dr.DeliveryStartTime \u003E= @StartRangeTime AND dr.DeliveryStartTime \u003C= @TodayWithScheduledStartTime\r\n\t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\r\n\t AND\r\n\t\t(\r\n\t\t\t@CustomerFilterType = 0\r\n\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t)\r\n\r\n\t UNION ALL\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 2 Type\r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\t\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\t \t --AND c.IsMetropolis = 1\r\n\t WHERE dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\t AND dr.DeliveryStartTime \u003E= @EndRangeTime_5DaysAgo AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t AND dr.DeliveryDeadLineTime \u003E @Today\r\n\t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\r\n\t AND\r\n\t\t(\r\n\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t)\r\n\r\n\t UNION ALL\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 3 Type\r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\t\t\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\t \t --AND c.IsMetropolis = 1\r\n\t WHERE dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\t AND dr.DeliveryStartTime \u003E= @EndRangeTime_5DaysAgo AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t AND dr.DeliveryDeadLineTime \u003C= @Today\r\n\t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\r\n\t AND\r\n\t\t(\r\n\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t)\r\n\r\n\t UNION ALL\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 4 Type\r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\t\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\t \t --AND c.IsMetropolis = 1\r\n\t WHERE dr.DispatchRequestStatusId IN ( 20,25,45,50,46,47,48,49,51,52,53,54 )\r\n\t AND dr.DeliveryStartTime \u003E= @EndRangeTime_5DaysAgo AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t AND dr.DeliveryDeadLineTime \u003E @Today\r\n\t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\r\n\t AND\r\n\t\t(\r\n\t\t\t@CustomerFilterType = 0\r\n\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t)\r\n\r\n\t UNION ALL\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 5 Type\r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\t\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\t \t --AND c.IsMetropolis = 1\r\n\t WHERE dr.DispatchRequestStatusId IN ( 20,25,45,50,46,47,48,49,51,52,53,54 )\r\n\t AND dr.DeliveryStartTime \u003E= @EndRangeTime_5DaysAgo AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t AND dr.DeliveryDeadLineTime \u003C= @Today\r\n\t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n \t AND\r\n\t\t(\r\n\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t)\r\n\r\n\t UNION ALL\r\n\r\n\t SELECT \r\n\t \t SQ.ID,\r\n\t \t SQ.PolygonStoreId,\r\n\t \t SQ.Type\r\n\t FROM\r\n\t (\r\n\t \t SELECT DISTINCT\r\n\t \t \t SQ.ID,\r\n\t \t \t SQ.PolygonStoreId,\r\n\t \t \t SQ.Type\r\n\t \t FROM\r\n\t \t (\r\n\t \t \t \t SELECT \r\n\t \t \t \t \t dr.Id,\r\n\t \t \t \t \t dr.PolygonStoreId,\r\n\t \t \t \t \t CASE WHEN DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003E= GETDATE() THEN 6 ELSE 7 END [Type],\r\n\t \t \t \t \t ROW_NUMBER() OVER ( PARTITION BY Dr.ID ORDER BY sdp.ShipmentID DESC , sdp.ID DESC ) RowNum\r\n\t \t \t \t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t \t \t \t INNER JOIN #CourierRequestType crt\r\n\t \t \t \t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t \t \t \t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t \t \t \t ON dr.PolygonStoreId = ps.ID\t\t\r\n\t \t \t \t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t \t \t \t ON ps.PolygonId = p.ID\r\n\t \t \t \t INNER JOIN #Polygon pp\r\n\t \t \t \t \t ON p.ID = pp.PolygonId\r\n\t \t \t \t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t \t \t \t ON p.CityId = c.ID\r\n\t \t \t \t \t --AND c.IsMetropolis = 1\r\n\t \t \t \t INNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t \t \t \t \t ON dr.Id = sdpdr.DispatchRequestId\r\n\t \t \t \t INNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t \t \t \t \t ON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t \t \t \t WHERE dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\t \t \t \t AND dr.DeliveryStartTime \u003E= @EndRangeTime_5DaysAgo AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t \t \t \t AND ( sdp.OperationTypeId IN ( 5,20 ) OR ( dr.CourierRequestTypeId = 51 AND sdp.OperationTypeId = 25 ))\r\n\t \t \t \t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\t\t\t\t AND\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t\t\t\t)\r\n\t \t ) SQ\r\n\t \t WHERE SQ.RowNum = 1\r\n\t ) SQ\r\n) SQ\r\nINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t ON SQ.PolygonStoreId = ps.ID\r\nINNER JOIN #Polygon pp\r\n\t ON ps.PolygonId = pp.PolygonId\r\n\r\nGroup By \r\n\t ps.PolygonId\r\n\r\n\r\n\r\n\r\nSELECT \r\n\tc.ProvinceID,\r\n\tps.PolygonId,\r\n\r\n\tSUM(CASE WHEN ShipmentDestinationPointStatusId=20/*Met*/ \r\n\t \tAND OperationTypeId IN (10/*Delivery*/)\t \t \t \t \r\n\t \tAND DispatchRequestStatusId NOT IN (40/*Cancel*/,17/*Not Picked Up*/,80/*Not Delivered*/)\r\n\t \tTHEN 1 ELSE 0 END) CountOfEtaOntimeDelivery,\r\n\r\n\tSUM(CASE WHEN ShipmentDestinationPointStatusId=25/*Met With Delay*/ \r\n\t \tAND OperationTypeId IN (10/*Delivery*/)\r\n\t \tAND DispatchRequestStatusId NOT IN (40/*Cancel*/,17/*Not Picked Up*/,80/*Not Delivered*/)\r\n\t \tTHEN 1 ELSE 0 END) CountOfEtaDelayedDelivery,\r\n\tCASE WHEN SUM(EstimatedDurationSeconds\u002BEstimatedOperationTimeSeconds) = 0 THEN 0 ELSE\r\n\tROUND(SUM(CASE WHEN ShipmentDestinationPointStatusId=25 THEN DATEDIFF(SECOND,DATEADD(SECOND,EstimatedOperationTimeSeconds,CAST(CONVERT(varchar, FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)),CAST(CONVERT(varchar, FORMAT(DR.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) ELSE 0 END)*1.0/\r\n\tSUM(EstimatedDurationSeconds\u002BEstimatedOperationTimeSeconds)*1.0*100,2) END ContinuesDelayed\r\nINTO #ETA\r\nFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\nINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t \r\n\tON dr.Id = sdpdr.DispatchRequestId\r\n\tAND dr.Version = sdpdr.Version\r\nINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint(NOLOCK) sdp\t \t \t \t \t \t \r\n\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\nINNER JOIN CS_Dispatcher.DP.Shipment(NOLOCK) sh\t \t \t \t \t \t \t \t \t \t \r\n\tON sh.Id=sdp.ShipmentId\r\nINNER JOIN #CourierRequestType crt\r\n\tON dr.CourierRequestTypeId = crt.ID\r\nINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\tON dr.PolygonStoreId=ps.Id\t\r\nINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\tON ps.polygonid=po.id\t \r\nINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \r\n\tON p.Id=po.id\r\nINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\tON po.CityID = c.ID\r\nINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\tON c.ProvinceID = prvnc.ID\r\nWHERE dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\nAND sdp.OperationTypeId IN (10,15)\r\nAND ShipmentDestinationPointStatusId IN (20,25)\r\nAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\nAND\r\n\t(\r\n\t\t\t@CustomerFilterType = 0\r\n\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t)\r\n\r\nGroup By\r\n\tc.ProvinceID,\r\n\tps.PolygonId\r\nOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n;WITH CTE_AveETA AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tc.ProvinceID,\r\n\t\tps.PolygonId,\r\n\t\tsh.ID ShipmentId,\r\n\t\tISNULL(sh.TotalEstimatedDurationSeconds,0) TotalEstimatedDurationSeconds\r\n\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t \r\n\t\tON dr.Id = sdpdr.DispatchRequestId\r\n\t\tAND dr.Version = sdpdr.Version\r\n\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint(NOLOCK) sdp\t \t \t \t \t \t \r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\tINNER JOIN CS_Dispatcher.DP.Shipment(NOLOCK) sh\t \t \t \t \t \t \t \t \t \t \r\n\t\tON sh.Id=sdp.ShipmentId\r\n\tINNER JOIN #CourierRequestType crt\r\n\t\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\tON dr.PolygonStoreId=ps.Id\t\t\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\tON ps.polygonid=po.id\t \r\n\tINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \r\n\t\tON p.Id=po.id\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\t\tON po.CityID = c.ID\r\n\tINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\t\tON c.ProvinceID = prvnc.ID\r\n\tWHERE dr.DeliveryStartTime between @StartRangeTime AND @EndRangeTime\r\n\tAND sdp.OperationTypeId IN (10,15)\r\n\tAND sh.ShipmentStatusId = 45\r\n    AND\r\n\t\t(\r\n\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t)\r\n)\r\nSELECT \r\n\tProvinceID,\r\n\tPolygonId,\r\n\t1 AveEta\r\nINTO #AveETA\r\nFROM CTE_AveETA\r\nGroup By\r\n\tProvinceID,\r\n\tPolygonId\r\nOPTION(RECOMPILE,USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\nSELECT \r\n\tSQ.ProvinceId,\r\n\tSQ.PolygonId,\r\n\tSUM(CountOfSlaHyperDelayedDelivery) CountOfSlaHyperDelayedDelivery,\r\n\tSUM(CountOfUnassignedRequestInPolygon) CountOfUnassignedRequestInPolygon,\r\n\tSUM(CountOfDeliveredInPolygon) CountOfDeliveredInPolygon,\r\n\tSUM(CountOfSlaOntimeDeliveryInPolygon) CountOfSlaOntimeDeliveryInPolygon,\r\n\tSUM(CountOfSlaDelayedDeliveryInPolygon) CountOfSlaDelayedDeliveryInPolygon,\r\n\tSUM(CountOfReturnedDeliveryInPolygon) CountOfReturnedDeliveryInPolygon,\r\n\tSUM(CountOfCanceledRequestInPolygon) CountOfCanceledRequestInPolygon,\r\n\tSUM(CountOfInprogressRequestInPolygon) CountOfInprogressRequestInPolygon\r\n\t \t ,(SELECT CountOfEtaOntimeDelivery\t FROM #ETA\t cte\t WHERE cte.ProvinceId=ProvinceId AND cte.polygonId=SQ.polygonId)\t \t CountOfEtaOntimeDeliveryInPolygon\r\n\t \t ,(SELECT CountOfEtaDelayedDelivery\t FROM #ETA\t cte\t WHERE cte.ProvinceId=ProvinceId AND cte.polygonId=SQ.polygonId)\t \t CountOfEtaDelayedDeliveryInPolygon\r\nINTO #CTE_DispatchRequest\r\nFROM\r\n(\r\n\tSELECT\t \r\n\t\tprvnc.ID\t     ProvinceId,\r\n\t\tp.Id\t \t \t PolygonId,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId = 35 AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime \r\n\t\t\tAND \r\n\t\t\t(\r\n\t\t\t\t(dr.CourierRequestTypeId IN ( 5,26,40,55,60 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @OndemandHyperDelayThresholdMinutes) \r\n\t\t\t\tOR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @ScheduledHyperDelayThresholdMinutes)\r\n\t\t\t) THEN 1 ELSE 0 END) AS CountOfSlaHyperDelayedDelivery,\r\n\t\t0 CountOfUnassignedRequestInPolygon\r\n\t\t,SUM(CASE WHEN DispatchRequestStatusId IN (30,35) AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\t THEN 1 Else 0 END) CountOfDeliveredInPolygon\r\n\t\t,SUM(CASE WHEN dr.DispatchRequestStatusId=30 AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\t \t \t \t \t \t \t \t THEN 1 ELSE 0 END) CountOfSlaOntimeDeliveryInPolygon \r\n\t\t,SUM(CASE WHEN dr.DispatchRequestStatusId=35 AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\t \t \t \t \t \t THEN 1 ELSE 0 END) CountOfSlaDelayedDeliveryInPolygon  \r\n\t\t,SUM(CASE WHEN DispatchRequestStatusId IN (30,35) AND CourierRequestTypeId IN (25,26,26,30,35) AND DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfReturnedDeliveryInPolygon \r\n\t\t,SUM(CASE WHEN dr.DispatchRequestStatusId in (17,40) AND DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfCanceledRequestInPolygon ,\r\n\t\t0 CountOfInprogressRequestInPolygon\r\n\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\tINNER JOIN #CourierRequestType crt\r\n\t\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\tON dr.PolygonStoreId=ps.Id\t\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\tON ps.polygonid=po.id\t \r\n\tINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \r\n\t\tON p.Id=po.id\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\t\tON po.CityID = c.ID\r\n\tINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\t\tON c.ProvinceID = prvnc.ID\r\n\tWHERE dr.DeliveryStartTime between @StartRangeTime AND @EndRangeTime\r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\tAND DispatchRequestStatusId IN ( 30,35 , 17,40 )\r\n\tAND\r\n\t\t(\r\n\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t)\r\n\r\n\tGroup By \r\n\t\tprvnc.Id,\r\n\t\tp.Id\t\r\n\tUNION ALL\r\n\tSELECT\t \r\n\t\tprvnc.ID\t     ProvinceId,\r\n\t\tp.Id\t \t \t PolygonId,\r\n\t\t0 CountOfSlaHyperDelayedDelivery,\r\n\t\tSUM(case when DispatchRequestStatusId in (5,6,7)/*Submitted*/AND( DeliveryStartTime \u003E= @StartRangeTime And DeliveryDeadLineTime  \u003C= @EndRangeTime AND dr.CourierRequestTypeId \u003C\u003E 51 ) THEN 1 ELSE 0 END )\t CountOfUnassignedRequestInPolygon,\r\n\t\t0 CountOfDeliveredInPolygon,\r\n\t\t0 CountOfSlaOntimeDeliveryInPolygon,\r\n\t\t0 CountOfSlaDelayedDeliveryInPolygon,\r\n\t\t0 CountOfReturnedDeliveryInPolygon,\r\n\t\t0 CountOfCanceledRequestInPolygon,\r\n\t\tSUM(CASE WHEN DispatchRequestStatusId IN (10,15,20,25,45,50,11,16,46,51,47,48,49,52,53,54) AND ( DeliveryStartTime \u003E = @EndRangeTime_5DaysAgo And DeliveryDeadlinetime \u003C= @EndRangeTime ) THEN 1 ELSE 0 END) CountOfInprogressRequestInPolygon\r\n\r\n\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\tINNER JOIN #CourierRequestType crt\r\n\t\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\tON dr.PolygonStoreId=ps.Id\t\t\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\tON ps.polygonid=po.id\t \r\n\tINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \r\n\t\tON p.Id=po.id\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\t\tON po.CityID = c.ID\r\n\tINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\t\tON c.ProvinceID = prvnc.ID\r\n\tWHERE dr.DeliveryStartTime \u003E = @EndRangeTime_5DaysAgo And DeliveryDeadlinetime \u003C= @EndRangeTime\r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\tAND DispatchRequestStatusId IN ( 5,6,7 ,10,15,20,25,45,50,11,16,46,51,47,48,49,52,53,54 ) \r\n    AND\r\n\t\t(\r\n\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t)\r\n\r\n\tGroup By \r\n\t\tprvnc.Id,\r\n\t\tp.Id\t\r\n) SQ\r\nGroup BY SQ.ProvinceId, SQ.PolygonId\r\nOPTION(RECOMPILE,USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\r\n----------------------------------------------------------------------------------------------------------\r\n\r\n\t SET @sql \u002B=\r\n\t \u0027 SET @Result=\r\n\t (\r\n\t \t SELECT DISTINCT\r\n\t \t \t \t provinceId,\r\n\t \t \t \t provinceTitle,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfDeliveredInPolygon)\t \t \t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfDelivered,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfEtaOntimeDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfEtaOnTimeDelivery,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfEtaDelayedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfEtaDelayedDelivery,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfSlaOntimeDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfSlaOnTimeDelivery,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfSlaDelayedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfSlaDelayedDelivery,\r\n\r\n\r\n\t\t\t\t ISNULL((SELECT SUM(CountOfInprogressRequestInPolygon)\t FROM #CTE_DispatchRequest dr ),0) \u002B (ISNULL((SELECT SUM(CountOfReturnedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)) totalDisposal,\r\n\r\n\t\t\t\t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(CountOfEtaOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri ),0) AS totalPercentageCountOfEtaOnTimeDelivery,\t\t\t\t \r\n\t\t\t\t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(CountOfEtaDelayedDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri ),0) AS totalPercentageCountOfEtaDelayedDelivery,\r\n\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfSlaDelayedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0) - ISNULL((SELECT SUM(CountOfSlaHyperDelayedDelivery) FROM #CTE_DispatchRequest dri ),0) AS totalCountOfSlaNormalDelayedDelivery,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfSlaHyperDelayedDelivery) FROM #CTE_DispatchRequest dri ),0) AS totalCountOfSlaHyperDelayedDelivery,\r\n\t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(countOfSLAOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri ),0) AS totalPercentageOfSlaOnTimeDelivery,\r\n\t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE 100 - ((SUM(countOfSlaOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon) AS FLOAT))*100) - ((SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100) END FROM #CTE_DispatchRequest dri ),0) AS totalPercentageOfSlaNormalDelayedDelivery,\r\n\t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri ),0) AS totalPercentageOfSlaHyperDelayedDelivery,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfReturnedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfReturnedDelivery,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfCanceledRequestInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t     totalCountOfCanceledRequest,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfUnassignedRequestInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfUnassignedRequest,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfTryingToAssign) FROM #SlaCounts ),0) totalCountOfTryingToAssign,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfNormalSlaPickupQueue) FROM #SlaCounts ),0) totalCountOfNormalSlaPickupQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfDelayedSlaPickupQueue) FROM #SlaCounts ),0) totalCountOfDelayedSlaPickupQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) FROM #SlaCounts sc),0) totalCountOfPickupQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfNormalSlaDeliveryQueue) FROM #SlaCounts ),0) totalCountOfNormalSlaDeliveryQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfDelayedSlaDeliveryQueue) FROM #SlaCounts ),0) totalCountOfDelayedSlaDeliveryQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) FROM #SlaCounts sc ),0) totalCountOfDeliveryQueue,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfNormalEtaPickupQueue) FROM #SlaCounts ),0) totalCountOfNormalEtaPickupQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfDelayedEtaPickupQueue) FROM #SlaCounts ),0) totalCountOfDelayedEtaPickupQueue,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfInprogressRequestInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t totalCountOfInprogressRequest,\r\n\t \t \t \t 0/*(SELECT SUM(CountOfUnsettledRequestInPolygon)FROM #CTE_DispatchRequest dr )*/\t \t         totalCountOfUnsettledRequest,\r\n\t \t \t \t isnull((SELECT SUM(ContinuesDelayed)\t \t \t FROM #ETA)\t ,0)\t \t \t \t                 totalContinuousDelayed,\r\n\t \t \t \t ISNULL((SELECT SUM(countOfOfflineFleetInPolygon)\t \t FROM #CountOfFleetInPolygon dr ),0)\t totalCountOfOfflineFleet,\r\n\t \t \t \t ISNULL((SELECT SUM(countOfOnlineFleetInPolygon)\t \t FROM #CountOfFleetInPolygon dr ),0)\t totalCountOfOnlineFleet,\r\n\t\t\t\t ISNULL((SELECT SUM(countOfBanFleetInPolygon)\t \t FROM #CountOfFleetInPolygon dr ),0)\t     totalCountOfBanFleet,\r\n\t \t \t \t ISNULL(\u0027\u002BCAST(@MeanDeliveryTimeMinutes AS VARCHAR(MAX))\u002B\u0027,0) AS MeanDeliveryTimeMinutes,\r\n\t \t \t \t (\t \r\n\t \t \t \t SELECT * FROM\r\n\t \t \t \t (SELECT \r\n\t \t \t \t \t \t DISTINCT\r\n\t \t \t \t \t \t Pi.polygonId,\r\n\t \t \t \t \t \t pi.polygonTitle,\r\n\t \t \t \t \t \t pi.RegionKey cityId,\r\n\r\n\t\t\t\t\t\t ISNULL((SELECT Capacity FROM #Capacity dri WHERE dri.PolygonId=pi.PolygonId),0)\t percentageCapacity,\r\n\t \t \t \t \t \t ISNULL((SELECT NCapacity FROM #Capacity dri WHERE dri.PolygonId=pi.PolygonId),0)\t nextPercentageCapacity,\t \t \t \t \t \t   \r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfDeliveredInPolygon)\t \t \t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfDelivered,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfSlaOntimeDeliveryInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfSlaOnTimeDelivery\t   ,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfSlaDelayedDeliveryInPolygon) FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfSlaDelayedDelivery\t   ,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfDeliveredInPolygon)\t \t \t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfDeliveredInPolygon,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfEtaOntimeDeliveryInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfEtaOnTimeDelivery\t   ,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfEtaDelayedDeliveryInPolygon) FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfEtaDelayedDelivery\t   ,\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(countOfEtaDelayedDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfEtaDelayedDelivery,\r\n\t\t\t\t\t\t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(countOfEtaOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfEtaOnTimeDelivery,\r\n\r\n\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfSlaHyperDelayedDelivery) FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS countOfSlaHyperDelayedDelivery,\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(countOfSLAOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfSlaOnTimeDelivery,\r\n\t \t \t \t \t \t --ISNULL((100 - (SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(countOfSLAOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon) AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId) - (SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId)),0) AS percentageOfSlaNormalDelayedDelivery,\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE 100 - ((SUM(countOfSlaOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon) AS FLOAT))*100) - ((SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100) END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfSlaDelayedDelivery,\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfSlaHyperDelayedDelivery,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfReturnedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId)\t ,0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfReturnedDelivery\t   ,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfCanceledRequestInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId)\t ,0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfCanceledRequest\t \t   ,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfUnassignedRequestInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId)\t ,0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfUnassignedRequest\t   ,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfTryingToAssign) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) countOfTryingToAssignment,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfUnassignedRequestInPolygon) = 0 THEN 0 ELSE (((SELECT SUM(CountOfTryingToAssign) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId))/CAST(SUM(countOfUnassignedRequestInPolygon) AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfTryingToAssign,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfNormalSlaPickupQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId ),0) countOfNormalSlaPickupQueue,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfDelayedSlaPickupQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId ),0) countOfDelayedSlaPickupQueue,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId ),0) countOfPickupQueue,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfNormalSlaDeliveryQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId ),0) countOfNormalSlaDeliveryQueue,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfDelayedSlaDeliveryQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId ),0) countOfDelayedSlaDeliveryQueue,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) = 0 THEN 0 ELSE (SUM(CountOfDelayedSlaDeliveryQueue)/CAST(SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) AS FLOAT))*100 END FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) AS percentageOfDelayedSlaDeliveryQueue,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) countOfDeliveryQueue,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfNormalEtaPickupQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) countOfNormalEtaPickupQueue,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfDelayedEtaPickupQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) countOfDelayedEtaPickupQueue,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) = 0 THEN 0 ELSE (SUM(CountOfDelayedEtaPickupQueue)/CAST(SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) AS FLOAT))*100 END FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) AS percentageOfDelayedEtaPickupQueue,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfInprogressRequestInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfInprogressRequest\t   ,\r\n\r\n\t \t \t \t \t \t 0/*(SELECT SUM(countOfUnsettledRequestInPolygon)FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId)*/\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfUnsettledRequest\t   ,\r\n\t \t \t \t \t \t isnull((SELECT SUM(ContinuesDelayed)\t \t \t FROM #ETA\t   dri WHERE dri.PolygonId=pi.PolygonId)\t ,0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t continuousDelayed\t   ,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT countOfOfflineFleetInPolygon\t \t \t FROM #CountOfFleetInPolygon dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfOfflineFleet,\r\n\t \t \t \t \t \t ISNULL((SELECT countOfOnlineFleetInPolygon\t \t \t FROM #CountOfFleetInPolygon dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t     \t countOfOnlineFleet, \t \t \t \t \t \t \t \t \t \t \t   \r\n\t\t\t             ISNULL((SELECT countOfBanFleetInPolygon\t \t \t FROM #CountOfFleetInPolygon dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t     \t countOfBanFleet,\t \t \t \t \t   \r\n\r\n\t \t \t \t \t \t ISNULL(\u0027\u002BCAST(@MeanDeliveryTimeMinutes AS VARCHAR(MAX))\u002B\u0027,0) AS meanDeliveryTimeMinutes,\r\n\t \t \t \t \t \t ISNULL(ff.EstimatedOrderInNextHour,0) AS estimatedOrderInNextHour,\r\n\t \t \t \t \t \t ISNULL(ff.EstimatedAvailableFleetsInNextHour,0) AS estimatedAvailableFleetsInNextHour,\r\n\t \t \t \t \t \t ISNULL(ff.Mo2b,0) AS mo2b,\r\n\t \t \t \t \t \t ISNULL(ff.DriverShortageMinutes,0) AS driverShortageMinutes\r\n\t \t \t \t \t FROM #Polygon pi \r\n\t \t \t \t \t LEFT JOIN #ForecastFleet ff\r\n\t \t \t \t \t \t ON pi.PolygonId = ff.PolygonId\r\n\t \t \t \t \t )SQ\r\n\t \t \t \t \t order by \u0027 \u002B @OrderByReplace \u002B \r\n\r\n\t \t \u0027 FOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t \t \t \t ) polygonRequestList \r\n\t \t FROM #Polygon p\r\n\t \t GROUP BY p.ProvinceId,p.ProvinceTitle \r\n\t \t FOR JSON PATH ,WITHOUT_ARRAY_WRAPPER, INCLUDE_NULL_VALUES\r\n\t )\r\n\t SET @Result=REPLACE(@Result,\u0027\u0027\u0022polygonRequestList\u0022:null\u0027\u0027,\u0027\u0027\u0022polygonRequestList\u0022:[]\u0027\u0027)\u0027\r\n\r\n\tDECLARE @Param NVARCHAR(4000) = \u0027 @Result NVARCHAR(MAX) OUTPUT\u0027\r\n\r\n\tEXECUTE sys.sp_executeSQL @sql,@Param,@Result = @Result OUTPUT\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Polygon_DeliveryChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Polygon_DeliveryChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t\t @provinceId int ,  \r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t \t @countOfQueue INT OUTPUT,\r\n\t\t @countOfInProgress INT OUTPUT,\r\n\t\t @totalCount INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n--DROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\n--SELECT \r\n--\tcrt.Id\r\n--INTO #CourierRequestType\r\n--FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n--INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n--\tON crt.Id = ss.value\r\n--\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@End BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027235900000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\nDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027 \r\nSELECT\r\n\t@countOfQueue_DQE=ISNULL(COUNT([Queue]),0),\r\n\t@countOfInProgress_DQE=ISNULL(COUNT(InProgress),0),\r\n\t@totalCount_DQE=ISNULL(COUNT(Delivered),0) \r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 5,7 ) THEN DR.Id ELSE NULL END AS [Queue],\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 10,15,20,25 ) THEN DR.Id ELSE NULL END AS InProgress,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 30,35 ) AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) THEN DR.Id ELSE NULL END AS Delivered\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t--INNER JOIN #CourierRequestType crt\r\n\t--\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n\t\tAND c.ProvinceId =  \u0027\u002BCAST(@provinceId AS VARCHAR(MAX))\u002B\u0027 \r\n\tWHERE dr.DeliveryStartTime BETWEEN \u0027\u002BCAST(@TotalFrom AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@End AS VARCHAR(MAX))\u002B\u0027\r\n\tAND [DispatchRequestStatusId] IN (5,7,10,15,20,25,30,35)\u0027\r\n\r\n\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @CustomerFilterType \u003E 0\r\n\tBEGIN\r\n\t\tIF @CustomerFilterType = 1\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\tIF @CustomerFilterType = 2\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\tIF @CustomerFilterType = 3\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\tIF @CustomerFilterType = 4\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\tEND\r\n\r\nSET @STR \u002B= \r\n\u0027 ) SQ\r\n\r\nSELECT  \r\n\r\n  CAST( SQ.BarIndex AS DATETIME)  as labels,\r\n  --  SQ.BarIndex  as labels,\r\n    COUNT(SQ.Id) AS dataValues\r\n FROM  \r\n(  \r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n    SELECT  \r\n        dr.Id,  \r\n        CASE  \r\n            WHEN dr.UpdateDate \u003C \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar12_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027\r\n            ELSE \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027  \r\n        END AS BarIndex\r\n\t\t\t\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t\t\t\t--INNER JOIN #CourierRequestType crt\r\n\t\t\t\t--\tON dr.CourierRequestTypeId = crt.ID\r\n\t\t\t\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\t\t\t\tON dr.PolygonStoreId = ps.ID\r\n\t\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\t\t\t\tON ps.PolygonId = p.ID\r\n\t\t\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\t\t\t\tON pos.PolygonId = dp.Id \r\n\t\t\t\t\tAND pos.IsActive = 1\r\n  \t\t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\t\t\t\tON p.CityId = c.ID\r\n\t\t\t\t\tAND c.ProvinceId = \u0027\u002BCAST(@provinceId AS VARCHAR(MAX))\u002B\u0027 \r\n\t\t\t\tWHERE dr.DeliveryStartTime BETWEEN   \u0027\u002BCAST( @TotalFrom AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B\u0027  \r\n\t\t\t\tAND [DispatchRequestStatusId] IN (30,35)\r\n\t\t\t\tAND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70)\u0027\r\n\r\n\t\t\t\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\t\t\t\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\t\t\t\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\t\t\t\tIF @CustomerFilterType \u003E 0\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tIF @CustomerFilterType = 1\r\n\t\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\t\t\t\tIF @CustomerFilterType = 2\r\n\t\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\t\t\t\tIF @CustomerFilterType = 3\r\n\t\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\t\t\t\tIF @CustomerFilterType = 4\r\n\t\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\t\t\t\tEND\r\n\r\n\t\t\tSET @STR \u002B=\r\n\t\t\t\u0027 ) SQ  \r\n\t\t\tGroup BY BarIndex  \r\n\t\t\tORDER BY BarIndex\u0027\r\n\r\n\t\t\tDECLARE @Param NVARCHAR(MAX) = \u0027\u0027\r\n\t\t\tSET @Param = \u0027 @countOfQueue_DQE INT OUTPUT,@countOfInProgress_DQE INT OUTPUT,@totalCount_DQE INT OUTPUT\u0027\r\n\r\nEXECUTE sys.sp_executeSQL \r\n\t@STR,@Param, \r\n\t@countOfQueue_DQE = @countOfQueue OUTPUT,\r\n\t@countOfInProgress_DQE = @countOfInProgress OUTPUT,\r\n\t@totalCount_DQE = @totalCount OUTPUT\r\n\r\nSET @title=N\u0027\u0633\u0641\u0627\u0631\u0634\u0627\u062A\u0027\r\n\r\nEND\r\n\r\n"},{"Name":"Get_Dashboard_Polygon_ETAChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Polygon_ETAChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t\t @provinceId int ,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t\t @countOfDelayed INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n--DROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\n--SELECT \r\n--\tcrt.Id\r\n--INTO #CourierRequestType\r\n--FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n--INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n--\tON crt.Id = ss.value\r\n--\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT);\r\n\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\nDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027\r\nSELECT\r\n\r\n\t@countOfDelivered_DQE=ISNULL(COUNT(Delivered),0),\r\n\t@countOfDelayed_DQE=ISNULL(COUNT(Delayed),0)\r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN ShipmentDestinationPointStatusId IN (25 ) AND [DispatchRequestStatusId]  NOT IN (40,17,80) THEN DR.Id ELSE NULL END AS Delayed,\r\n\t\tCASE WHEN ShipmentDestinationPointStatusId IN (20 ) AND [DispatchRequestStatusId]  NOT IN (40,17,80) THEN DR.Id ELSE NULL END AS Delivered\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t--INNER JOIN #CourierRequestType crt\r\n\t--\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n\t\tAND c.ProvinceId =\u0027 \u002BCAST(@provinceId AS VARCHAR(MAX))\u002B \u0027        \r\n    INNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\tON dr.ID = sdpdr.DispatchRequestId\r\n\tAND dr.Version = sdpdr.Version\r\n    INNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\tWHERE dr.DeliveryStartTime BETWEEN  \u0027 \u002BCAST(@TotalFrom AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027 \r\n\tAND dr.DispatchRequestStatusId IN ( 30,35 ) \r\n\tAND sdp.OperationTypeId  IN (10,15)\r\n\tAND sdp.ShipmentDestinationPointStatusId IN ( 20,25 ) \u0027\r\n\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @CustomerFilterType \u003E 0\r\n\tBEGIN\r\n\t\tIF @CustomerFilterType = 1\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\tIF @CustomerFilterType = 2\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\tIF @CustomerFilterType = 3\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\tIF @CustomerFilterType = 4\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\tEND\r\nSET @STR \u002B= \r\n\u0027 ) SQ\r\nSELECT  \r\n\r\n    CAST( SQ.BarIndex AS DATETIME)  as labels,\r\n    COUNT(SQ.Id) AS dataValues\r\n FROM  \r\n(  \r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n    SELECT  \r\n        dr.Id,  \r\n        CASE  \r\n            WHEN dr.UpdateDate \u003C \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar12_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027\r\n            ELSE \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027  \r\n        END AS BarIndex\r\n            FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)  \r\n\t\t\t--INNER JOIN #CourierRequestType crt\r\n\t\t\t--\tON dr.CourierRequestTypeId = crt.ID\r\n            INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)  \r\n                ON dr.PolygonStoreId = ps.ID  \r\n            INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)  \r\n                ON ps.PolygonId = p.ID  \r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\t\t\tON pos.PolygonId = P.Id\r\n\t\t\t\tAND pos.IsActive = 1 \r\n  \t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\t\t\tON p.CityId = c.ID\r\n\t\t\t\tAND c.ProvinceId =\u0027 \u002BCAST(@provinceId AS VARCHAR(MAX))\u002B \u0027  \r\n\t\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\t\t\t\tON dr.ID = sdpdr.DispatchRequestId\r\n\t\t\tAND dr.Version = sdpdr.Version\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\t\t\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\t\tWHERE dr.UpdateDate BETWEEN    \u0027 \u002BCAST(@From AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027 \r\n\t\t\tAND dr.DispatchRequestStatusId IN ( 30 ) \r\n\t\t\tAND DR.CourierRequestTypeId IN (5,15)\r\n\t\t\tAND sdp.OperationTypeId = 10\r\n\t\t\tAND sdp.ShipmentDestinationPointStatusId IN ( 20 )\u0027\r\n\t\t\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\t\t\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\t\t\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\t\t\tIF @CustomerFilterType \u003E 0\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @CustomerFilterType = 1\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 2\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 3\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 4\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\t\t\tEND\r\n\t\tSET @STR \u002B=\r\n\t\t\u0027 ) SQ  \r\n\t\tGroup BY BarIndex  \r\n\t\tORDER BY BarIndex\u0027\r\n\r\n\t\tDECLARE @Param NVARCHAR(MAX) = \u0027\u0027\r\n\t\tSET @Param = \u0027 @countOfDelivered_DQE INT OUTPUT,@countOfDelayed_DQE INT OUTPUT\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL \r\n\t\t\t@STR,@Param, \r\n\t\t\t@countOfDelivered_DQE = @countOfDelivered OUTPUT,\r\n\t\t\t@countOfDelayed_DQE = @countOfDelayed OUTPUT\r\n\r\n\t\tSET @title=N\u0027\u0628\u0631\u0645\u0628\u0646\u0627\u06CC ETA\u0027\r\n\t\tEND"},{"Name":"Get_Dashboard_Polygon_N","Schema":"dbo","Definition":"\r\n\r\nCREATE  PROCEDURE [dbo].[Get_Dashboard_Polygon_N]\r\n--declare\r\n\t \t @PolygonIds\t \t \t NVARCHAR(MAX),\r\n\t \t @StartRangeTime\t \t BIGINT,\r\n\t \t @EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType  TinyInt,-- NVARCHAR(MAX),\r\n\t \t @OrderBy\t \t \t NVARCHAR(200) = NULL,\r\n\t \t @IsASC\t \t \t \t BIT = NULL,\r\n\t \t @Result\t \t \t \t NVARCHAR(MAX) OUTPUT\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\n\r\n\r\nDECLARE @EndRangeTime_5DaysAgo BIGINT\r\nSELECT @EndRangeTime_5DaysAgo = REPLACE(REPLACE(REPLACE(REPLACE(CONVERT( NVARCHAR, DATEADD(DAY,-5, CAST(CONVERT(varchar, FORMAT(@EndRangeTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) , 121 ),\u0027-\u0027,\u0027\u0027),\u0027:\u0027,\u0027\u0027),\u0027.\u0027,\u0027\u0027),\u0027 \u0027,\u0027\u0027)\r\n\r\nDECLARE @Today BIGINT=(SELECT CONVERT(char(8), GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027) )\r\n\r\n--select  @PolygonIds\t \t \t =\u00274,5,10,13,14,16,18,20,22,23,24,25,26,29,30,31,32,33,34,35,36,37,38,39,41,43,45,46,47,48,49,50,51,54,55,56,57,58,59,60,61,62,63,69\u0027,\r\n--\t \t @StartRangeTime\t \t =20220629000000000,\r\n--\t \t @EndRangeTime\t \t =20220629235999999\r\n\r\n\t declare @sql1 nvarchar(max) = \u0027\u0027,\r\n\t \t \t @sql2 nvarchar(max) = \u0027\u0027,\r\n\t \t \t @sql nvarchar(max) = \u0027\u0027\r\n\r\n\t DECLARE @OrderByReplace NVARCHAR(200),\r\n\t \t \t @ScheduledStartTime DateTime,\r\n\t \t \t @TodayWithScheduledStartTime BIGINT\r\n\r\n\t SELECT @ScheduledStartTime = Value FROM CS_Public.HAF.Setting (NOLOCK) WHERE name = \u0027DispatchRequestSchedulerSetting.ScheduledStartTime\u0027\r\n\t SET @ScheduledStartTime = GETDATE() \u002B ISNULL(@ScheduledStartTime,\u002700:00:00\u0027)\r\n\t SELECT @TodayWithScheduledStartTime = FORMAT(@ScheduledStartTime,\u0027yyyyMMddHHmmss\u0027)\u002B\u0027999\u0027\r\n\r\n\t --SELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\t IF @OrderByReplace IS NULL OR @OrderByReplace = \u0027\u0027\r\n\t\tIF @IsAsc = 1\r\n\t\t\tSET @OrderByReplace = \u0027Mo2b\u0027\r\n\t\tELSE\r\n\t\t\tSET @OrderByReplace = \u0027Mo2b DESC\u0027\r\n\tELSE\r\n\t\tIF @IsAsc = 1\r\n\t\t\tSET @OrderByReplace = @OrderByReplace \u002B \u0027 ASC\u0027\r\n\t\tELSE\r\n\t\t\tSET @OrderByReplace = @OrderByReplace \u002B \u0027 DESC\u0027\r\n\r\n\t DROP TABLE IF EXISTS #Polygon\r\n\t DROP TABLE IF EXISTS #AllDispatches\r\n\t DROP TABLE IF EXISTS #shipment\r\n\t DROP TABLE IF EXISTS #ContinuesDelayed\r\n\t DROP TABLE IF EXISTS #CTE_CountOfEta\r\n\t DROP TABLE IF EXISTS #CTE_DispatchRequest\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoints\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoint\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoint3\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoint_Total\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoint_Inpolygon\r\n\t DROP TABLE IF EXISTS #CountOfFleetInPolygon\r\n\t DROP TABLE IF EXISTS #Store\r\n\r\n\t IF (@StartRangeTime IS NULL ) \r\n\t OR (@EndRangeTime IS NULL )\r\n\t OR dbo.FN_DateDiff(@StartRangeTime,@EndRangeTime)\u003E31\r\n\t BEGIN\r\n\t \t SET @Result=-1 \r\n\t \t RETURN\r\n\t END\r\n\r\n\r\n\r\n\t CREATE TABLE #PolygonId \r\n\t (\r\n\t \t Id\t SMALLINT\r\n\t )\r\n\r\n\t IF ISNULL(@PolygonIds,\u00270\u0027) = \u00270\u0027\r\n\t\t BEGIN\r\n\t\t\t\r\n\t\t\tINSERT INTO #PolygonId (Id )\r\n\t\t\tSELECT \r\n\t \t\t\tp.ID PolygonId\r\n\t\t\tFROM CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\t\tWHERE P.IsActive=1\r\n\r\n\t\t END\r\n\t ELSE\r\n\t\t BEGIN\r\n\r\n\t\t\tINSERT INTO #PolygonId ( Id )\r\n\t\t\tSELECT \r\n\t \t\t\tp.ID PolygonId\r\n\t\t\tFROM CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\t\tINNER JOIN STRING_SPLIT(@PolygonIds,\u0027,\u0027) ss\r\n\t \t\t\tON p.Id = ss.value\r\n            WHERE P.IsActive=1\r\n\r\n\t\t END\r\n\r\n--------------------------------------------- Insert Store Id\r\n\t\t\t CREATE TABLE #Store\r\n\t (\r\n\t \t VId\t INT\r\n\t )\r\n\r\n\t if @CustomerFilterType=2\r\n\t begin\r\n\t  INSERT INTO #Store (VId)\r\n\t  SELECT DISTINCT ID\r\n\t  FROM [CS_Dispatcher].[DP].[Store] \r\n\t  where VendorId=37 and IsActive=1\r\n\t end\r\n\r\n\t if @CustomerFilterType=3\r\n\t begin\r\n\t  INSERT INTO #Store (VId)\r\n\t  SELECT DISTINCT ID\r\n\t  FROM [CS_Dispatcher].[DP].[Store] \r\n\t  where VendorId=726 and IsActive=1\r\n\t end\r\n\r\n\tif @CustomerFilterType=4\r\n\t begin\r\n\t  INSERT INTO #Store (VId)\r\n\t  SELECT DISTINCT ID\r\n\t  FROM [CS_Dispatcher].[DP].[Store] \r\n\t  where VendorId=41 and IsActive=1\r\n\t end\r\n\r\n \tif @CustomerFilterType=1\r\n\t begin\r\n\t  INSERT INTO #Store (VId)\r\n\t  SELECT DISTINCT ID\r\n\t  FROM [CS_Dispatcher].[DP].[Store] \r\n\t  where VendorId not in (37,726,41) and IsActive=1\r\n\t end\r\n\r\n\t  \tif @CustomerFilterType=0\r\n\t begin\r\n\t  INSERT INTO #Store (VId)\r\n\t  SELECT DISTINCT ID\r\n\t  FROM [CS_Dispatcher].[DP].[Store] \r\n\t  where  IsActive=1\r\n\t end\r\n\r\n     \r\n\t---------------------------------------------\r\n\r\n\r\n\r\n\r\n\t SELECT \r\n\t \t ff.PolygonId,\r\n\t \t SUM(ff.EstimatedOrder) AS EstimatedOrderInNextHour,\r\n\t \t SUM(ff.EstimatedBiker) AS EstimatedAvailableFleetsInNextHour,\r\n\t \t SUM(ff.Mo2b) AS Mo2b,\r\n\t \t SUM(ff.BikerShortage) AS DriverShortageMinutes\r\n\t INTO #ForecastFleet\r\n\t FROM CS_Dispatcher.DP.ForecastFleet ff (NOLOCK)\r\n\t INNER JOIN #PolygonId p\r\n\t \t ON ff.PolygonId = p.Id\r\n\t \t --AND @DeliveryServiceProviderId = 1\r\n\t Group By\r\n\t \t ff.PolygonId\r\n\r\n\t DECLARE @MeanDeliveryTimeMinutes SMALLINT\r\n\t SELECT @MeanDeliveryTimeMinutes = Value FROM CS_Public.Haf.Setting (NOLOCK) WHERE Name = \u0027DispatchRequestSettings.MeanDeliveryTimeMinutes\u0027\r\n\r\n\t DECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t \t \t  @ScheduledHyperDelayThresholdMinutes SMALLINT\r\n\t SELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\n\t SELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n\t SET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n\t SELECT \r\n\t \t crt.Id\r\n\t INTO #CourierRequestType\r\n\t FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n\t INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\t \t ON crt.Id = ss.value\r\n\t \t OR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\t DECLARE @ShiftTime\t TIME=CAST(getdate() AS TIME),\r\n\t \t \t @ShiftDate\t DATE=CAST(GETDATE() AS DATE)\r\n\t DECLARE @WeedDayId\t TINYINT=(SELECT DATEPART(dw,GETDATE())-1)\r\n\r\n\r\n\t SELECT\t DISTINCT\r\n\t \t \t prvnc.id as ProvinceId,\r\n\t \t \t prvnc.Name\t ProvinceTitle,\r\n\t \t \t c.name as CityName,\r\n\t \t \t p.Id\t \t \t PolygonId,\r\n\t \t \t CASE WHEN po.CityId = 306 THEN po.PersianTitle ELSE po.title END\t \t polygonTitle,\r\n\t \t \t c.id\t \t RegionKey\r\nINTO #Polygon\r\nfrom CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \r\nINNER JOIN CS_Dispatcher.DP.Polygon po (NOLOCK)\r\n\t  ON po.Id=ps.PolygonId\r\nINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \t \t \r\n     ON p.Id=po.id\r\nINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\t  ON po.CityID = c.ID\r\nINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)\r\n\t  ON c.ProvinceID = prvnc.ID\r\n--INNER JOIN CS_Dispatcher.DP.Store s (NOLOCK)\r\n--\t  ON ps.StoreId = s.ID\r\nINNER JOIN #Store s (NOLOCK)\r\n\t  ON ps.StoreId = s.VID\r\n/*---------------------------------------------------------------------*/\r\n\r\nSELECT \r\n\tId\r\nINTO #DeliveryServiceProvider\r\nFROM CS_Dispatcher.DP.DeliveryServiceProvider (NOLOCK)\r\nWHERE ID = @DeliveryServiceProviderId\r\nOR ISNULL(@DeliveryServiceProviderId,0) = 0\r\n\r\n\r\nSELECT \r\n\tPolygonId,\r\n\t \tISNULL(COUNT(DISTINCT CASE WHEN FleetStatusId = 10 THEN fleetid ELSE NULL END),0) countOfOfflineFleetInPolygon,\r\n\t\tISNULL(COUNT(DISTINCT CASE WHEN ((FleetStatusId=60 AND ReasonFleetChangeStateId IN (56,59,60,61,51))) THEN fleetid ELSE NULL END),0) countOfBanFleetInPolygon,\r\n\t\tISNULL\r\n\t\t(\r\n\t\t\tCOUNT\r\n\t\t\t(\r\n\t\t\t\tDISTINCT\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\t\tWHEN\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t(FleetStatusId=5 AND ReasonFleetChangeStateId NOT IN (62))\r\n\t\t                    OR (FleetStatusId=15 AND ReasonFleetChangeStateId IN (50,54,58,62,51))\r\n\t\t\t    \t\t\tOR(FleetStatusId=60 AND ReasonFleetChangeStateId IN (50,54,58))\r\n\t\t\t\t\t\t) THEN FleetId ELSE NULL END\r\n\t\t\t)\r\n\t\t,0) countOfOnlineFleetInPolygon\r\nINTO #CountOfFleetInPolygon\r\nfrom\r\n(\r\n\tSELECT \r\n\t\t\t f.id\t\t\t\t\t\t\tFleetId \r\n\t\t\t,f.FleetStatusId\r\n\t\t\t,s2.Polygonid PolygonId\r\n\t\t\t,f.ReasonFleetChangeStateId\r\n\t FROM  CS_DriverManagement.DM.ShiftFleetMap AS sfm2 \t(NOLOCK) \r\n\t INNER JOIN CS_DriverManagement.DM.ShiftDate AS sd2 ON sd2.Id = sfm2.ShiftDateId\r\n\t INNER JOIN CS_DriverManagement.DM.Shift AS s2 ON s2.Id = sd2.ShiftId\r\n\t INNER JOIN CS_DriverManagement.DM.TimeSlot AS ts2 ON ts2.Id = s2.TimeSlotId\r\n\t INNER JOIN CS_DriverManagement.DM.Fleet f\t \t(NOLOCK) ON sfm2.fleetid=f.id AND f.IsActive=1 AND sfm2.IsActive=1 \r\n \t\tINNER JOIN #DeliveryServiceProvider DSP\r\n\t\t\tON f.DeliveryServiceProviderId = dsp.Id\r\n\tINNER JOIN #Polygon p ON p.PolygonId=s2.PolygonId\r\n\tWHERE sd2.Date = @ShiftDate AND @ShiftTime BETWEEN [ts2].[From] AND [ts2].[To]\r\n\tAND sd2.IsActive = 1\r\n\tAND s2.Status = 1\r\n\tAND sfm2.IsDeleted = 0\r\n\tAnd sfm2.IsAssigned = 1\r\n\tAND sfm2.IsActive = 1\r\n) T\r\n GROUP BY polygonid\r\n\r\n\r\n\r\n\r\n\t;WITH CTE_Final AS(\r\n\t\t\tSELECT \r\n\t\t\t\tcount(SFM.IsAssigned) AS IsAssigned\r\n\t\t\t   ,EstimateCapacity\r\n\t\t\t   ,p.PolygonId\r\n\t\t\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\t\t\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK) ON pl.CityId = c.ID\r\n\t\t\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\t\t\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\t\t\tWHERE  sd.Date = @ShiftDate AND @ShiftTime BETWEEN [ts].[From] AND [ts].[To]\r\n\t\t  group by EstimateCapacity\r\n\t\t   ,p.PolygonId)\r\n,CTE_DRCounts AS(\r\n            SELECT \r\n\t\t\t\tcount(SFM.IsAssigned) AS NEXTIsAssigned\r\n\t\t\t   ,EstimateCapacity AS NEXTIstimateCapacity\r\n\t\t\t   ,p.PolygonId\r\n\t\t\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\t\t\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\t\t\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK) ON pl.CityId = c.ID\r\n\t\t\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\t\t\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\t\t    where sd.Date = @ShiftDate AND  [ts].[From] in (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttop 1 [From]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\twhere sd.Date = @ShiftDate AND S.Status=1 AND  [From]\u003E@ShiftTime )\r\n\t\t  group by EstimateCapacity\r\n\t\t   ,p.PolygonId)\r\n\r\nSELECT \r\n         F.PolygonId,\r\n         CASE WHEN SUM(F.EstimateCapacity) = 0 THEN 0 ELSE CAST(ROUND((SUM(F.IsAssigned) * 100.0) / SUM(F.EstimateCapacity), 0) AS INT) END AS Capacity,\r\n\t\t CASE WHEN SUM(D.NEXTIstimateCapacity) = 0 THEN 0 ELSE CAST(ROUND((SUM(D.NEXTIsAssigned) * 100.0) / SUM(D.NEXTIstimateCapacity), 0) AS INT) END AS NCapacity\r\nINTO #Capacity\r\nFROM  CTE_Final F\r\nLEFT JOIN CTE_DRCounts D ON F.PolygonId=D.PolygonId\r\ngroup by  F.PolygonId\r\n\r\n\r\n\r\nSELECT \r\n\t ps.PolygonId,\r\n\t COUNT(CASE WHEN SQ.Type = 1 THEN Type ELSE NULL END ) CountOfTryingToAssign,\r\n\t COUNT(CASE WHEN SQ.Type = 2 THEN Type ELSE NULL END ) CountOfNormalSlaPickupQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 3 THEN Type ELSE NULL END ) CountOfDelayedSlaPickupQueue,\r\n\r\n\t COUNT(CASE WHEN SQ.Type = 4 THEN Type ELSE NULL END ) CountOfNormalSlaDeliveryQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 5 THEN Type ELSE NULL END ) CountOfDelayedSlaDeliveryQueue,\r\n\r\n\t COUNT(CASE WHEN SQ.Type = 6 THEN Type ELSE NULL END ) CountOfNormalEtaPickupQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 7 THEN Type ELSE NULL END ) CountOfDelayedEtaPickupQueue\r\n\r\nINTO #SlaCounts\r\nFROM\r\n(\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 1 Type \r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\r\n\t INNER JOIN #Store s (NOLOCK)\r\n\t \t \t ON ps.StoreId = s.VID\t\t\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\t \t --AND c.IsMetropolis = 1\r\n\tINNER JOIN CS_OrderManagement.OM.Parcel parcel (NOLOCK)\r\n\t\tON dr.ParcelReferenceCode = parcel.ParcelReferenceCode\r\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\tON parcel.CourierRequestId = cr.Id\r\n\t\tAND cr.ConfirmationDate IS NOT NULL\r\n\t WHERE dr.CourierRequestTypeId \u003C\u003E 51\r\n\t AND dr.DispatchRequestStatusId IN ( 5,6,7 )\r\n\t AND dr.DeliveryStartTime \u003E= @StartRangeTime AND dr.DeliveryStartTime \u003C= @TodayWithScheduledStartTime\r\n\t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\t UNION ALL\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 2 Type\r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\r\n\t INNER JOIN #Store s (NOLOCK)\r\n\t \t \t ON ps.StoreId = s.VID\t\t\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\t \t --AND c.IsMetropolis = 1\r\n\t WHERE dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\t AND dr.DeliveryStartTime \u003E= @EndRangeTime_5DaysAgo AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t AND dr.DeliveryDeadLineTime \u003E @Today\r\n\t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\t UNION ALL\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 3 Type\r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\r\n     INNER JOIN #Store s (NOLOCK)\r\n\t \t \t ON ps.StoreId = s.VID\t\t\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\t \t --AND c.IsMetropolis = 1\r\n\t WHERE dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\t AND dr.DeliveryStartTime \u003E= @EndRangeTime_5DaysAgo AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t AND dr.DeliveryDeadLineTime \u003C= @Today\r\n\t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\t UNION ALL\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 4 Type\r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\r\n\t INNER JOIN #Store s (NOLOCK)\r\n\t \t \t ON ps.StoreId = s.VID\t\t\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\t \t --AND c.IsMetropolis = 1\r\n\t WHERE dr.DispatchRequestStatusId IN ( 20,25,45,50,46,47,48,49,51,52,53,54 )\r\n\t AND dr.DeliveryStartTime \u003E= @EndRangeTime_5DaysAgo AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t AND dr.DeliveryDeadLineTime \u003E @Today\r\n\t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\t UNION ALL\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 5 Type\r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\r\n\t INNER JOIN #Store s (NOLOCK)\r\n\t \t \t ON ps.StoreId = s.VID\t\t\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\t \t --AND c.IsMetropolis = 1\r\n\t WHERE dr.DispatchRequestStatusId IN ( 20,25,45,50,46,47,48,49,51,52,53,54 )\r\n\t AND dr.DeliveryStartTime \u003E= @EndRangeTime_5DaysAgo AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t AND dr.DeliveryDeadLineTime \u003C= @Today\r\n\t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\t UNION ALL\r\n\r\n\t SELECT \r\n\t \t SQ.ID,\r\n\t \t SQ.PolygonStoreId,\r\n\t \t SQ.Type\r\n\t FROM\r\n\t (\r\n\t \t SELECT DISTINCT\r\n\t \t \t SQ.ID,\r\n\t \t \t SQ.PolygonStoreId,\r\n\t \t \t SQ.Type\r\n\t \t FROM\r\n\t \t (\r\n\t \t \t \t SELECT \r\n\t \t \t \t \t dr.Id,\r\n\t \t \t \t \t dr.PolygonStoreId,\r\n\t \t \t \t \t CASE WHEN DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003E= GETDATE() THEN 6 ELSE 7 END [Type],\r\n\t \t \t \t \t ROW_NUMBER() OVER ( PARTITION BY Dr.ID ORDER BY sdp.ShipmentID DESC , sdp.ID DESC ) RowNum\r\n\t \t \t \t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t \t \t \t INNER JOIN #CourierRequestType crt\r\n\t \t \t \t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t \t \t \t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t \t \t \t ON dr.PolygonStoreId = ps.ID\r\n\t \t          INNER JOIN #Store s (NOLOCK)\r\n\t \t         \t ON ps.StoreId = s.VID\t\t\r\n\t \t \t \t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t \t \t \t ON ps.PolygonId = p.ID\r\n\t \t \t \t INNER JOIN #Polygon pp\r\n\t \t \t \t \t ON p.ID = pp.PolygonId\r\n\t \t \t \t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t \t \t \t ON p.CityId = c.ID\r\n\t \t \t \t \t --AND c.IsMetropolis = 1\r\n\t \t \t \t INNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t \t \t \t \t ON dr.Id = sdpdr.DispatchRequestId\r\n\t \t \t \t INNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t \t \t \t \t ON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t \t \t \t WHERE dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\t \t \t \t AND dr.DeliveryStartTime \u003E= @EndRangeTime_5DaysAgo AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t \t \t \t AND ( sdp.OperationTypeId IN ( 5,20 ) OR ( dr.CourierRequestTypeId = 51 AND sdp.OperationTypeId = 25 ))\r\n\t \t \t \t AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\t \t ) SQ\r\n\t \t WHERE SQ.RowNum = 1\r\n\t ) SQ\r\n) SQ\r\nINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t ON SQ.PolygonStoreId = ps.ID\r\nINNER JOIN #Polygon pp\r\n\t ON ps.PolygonId = pp.PolygonId\r\n\r\nGroup By \r\n\t ps.PolygonId\r\n\r\n\r\n\r\n\r\nSELECT \r\n\tc.ProvinceID,\r\n\tps.PolygonId,\r\n\r\n\tSUM(CASE WHEN ShipmentDestinationPointStatusId=20/*Met*/ \r\n\t \tAND OperationTypeId IN (10/*Delivery*/)\t \t \t \t \r\n\t \tAND DispatchRequestStatusId NOT IN (40/*Cancel*/,17/*Not Picked Up*/,80/*Not Delivered*/)\r\n\t \tTHEN 1 ELSE 0 END) CountOfEtaOntimeDelivery,\r\n\r\n\tSUM(CASE WHEN ShipmentDestinationPointStatusId=25/*Met With Delay*/ \r\n\t \tAND OperationTypeId IN (10/*Delivery*/)\r\n\t \tAND DispatchRequestStatusId NOT IN (40/*Cancel*/,17/*Not Picked Up*/,80/*Not Delivered*/)\r\n\t \tTHEN 1 ELSE 0 END) CountOfEtaDelayedDelivery,\r\n\tCASE WHEN SUM(EstimatedDurationSeconds\u002BEstimatedOperationTimeSeconds) = 0 THEN 0 ELSE\r\n\tROUND(SUM(CASE WHEN ShipmentDestinationPointStatusId=25 THEN DATEDIFF(SECOND,DATEADD(SECOND,EstimatedOperationTimeSeconds,CAST(CONVERT(varchar, FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)),CAST(CONVERT(varchar, FORMAT(DR.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) ELSE 0 END)*1.0/\r\n\tSUM(EstimatedDurationSeconds\u002BEstimatedOperationTimeSeconds)*1.0*100,2) END ContinuesDelayed\r\nINTO #ETA\r\nFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\nINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t \r\n\tON dr.Id = sdpdr.DispatchRequestId\r\n\tAND dr.Version = sdpdr.Version\r\nINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint(NOLOCK) sdp\t \t \t \t \t \t \r\n\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\nINNER JOIN CS_Dispatcher.DP.Shipment(NOLOCK) sh\t \t \t \t \t \t \t \t \t \t \r\n\tON sh.Id=sdp.ShipmentId\r\nINNER JOIN #CourierRequestType crt\r\n\tON dr.CourierRequestTypeId = crt.ID\r\nINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\tON dr.PolygonStoreId=ps.Id\r\nINNER JOIN #Store s (NOLOCK)\r\n\tON ps.StoreId = s.VID\t\t\r\nINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\tON ps.polygonid=po.id\t \r\nINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \r\n\tON p.Id=po.id\r\nINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\tON po.CityID = c.ID\r\nINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\tON c.ProvinceID = prvnc.ID\r\nWHERE dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\nAND sdp.OperationTypeId IN (10,15)\r\nAND ShipmentDestinationPointStatusId IN (20,25)\r\n\r\nGroup By\r\n\tc.ProvinceID,\r\n\tps.PolygonId\r\nOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n;WITH CTE_AveETA AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tc.ProvinceID,\r\n\t\tps.PolygonId,\r\n\t\tsh.ID ShipmentId,\r\n\t\tISNULL(sh.TotalEstimatedDurationSeconds,0) TotalEstimatedDurationSeconds\r\n\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t \r\n\t\tON dr.Id = sdpdr.DispatchRequestId\r\n\t\tAND dr.Version = sdpdr.Version\r\n\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint(NOLOCK) sdp\t \t \t \t \t \t \r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\tINNER JOIN CS_Dispatcher.DP.Shipment(NOLOCK) sh\t \t \t \t \t \t \t \t \t \t \r\n\t\tON sh.Id=sdp.ShipmentId\r\n\tINNER JOIN #CourierRequestType crt\r\n\t\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\tON dr.PolygonStoreId=ps.Id\r\n\tINNER JOIN #Store s (NOLOCK)\r\n\t \t \t ON ps.StoreId = s.VID\t\t\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\tON ps.polygonid=po.id\t \r\n\tINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \r\n\t\tON p.Id=po.id\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\t\tON po.CityID = c.ID\r\n\tINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\t\tON c.ProvinceID = prvnc.ID\r\n\tWHERE dr.DeliveryStartTime between @StartRangeTime AND @EndRangeTime\r\n\tAND sdp.OperationTypeId IN (10,15)\r\n\tAND sh.ShipmentStatusId = 45\r\n)\r\nSELECT \r\n\tProvinceID,\r\n\tPolygonId,\r\n\t1 AveEta\r\nINTO #AveETA\r\nFROM CTE_AveETA\r\nGroup By\r\n\tProvinceID,\r\n\tPolygonId\r\nOPTION(RECOMPILE,USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\nSELECT \r\n\tSQ.ProvinceId,\r\n\tSQ.PolygonId,\r\n\tSUM(CountOfSlaHyperDelayedDelivery) CountOfSlaHyperDelayedDelivery,\r\n\tSUM(CountOfUnassignedRequestInPolygon) CountOfUnassignedRequestInPolygon,\r\n\tSUM(CountOfDeliveredInPolygon) CountOfDeliveredInPolygon,\r\n\tSUM(CountOfSlaOntimeDeliveryInPolygon) CountOfSlaOntimeDeliveryInPolygon,\r\n\tSUM(CountOfSlaDelayedDeliveryInPolygon) CountOfSlaDelayedDeliveryInPolygon,\r\n\tSUM(CountOfReturnedDeliveryInPolygon) CountOfReturnedDeliveryInPolygon,\r\n\tSUM(CountOfCanceledRequestInPolygon) CountOfCanceledRequestInPolygon,\r\n\tSUM(CountOfInprogressRequestInPolygon) CountOfInprogressRequestInPolygon\r\n\t \t ,(SELECT CountOfEtaOntimeDelivery\t FROM #ETA\t cte\t WHERE cte.ProvinceId=ProvinceId AND cte.polygonId=SQ.polygonId)\t \t CountOfEtaOntimeDeliveryInPolygon\r\n\t \t ,(SELECT CountOfEtaDelayedDelivery\t FROM #ETA\t cte\t WHERE cte.ProvinceId=ProvinceId AND cte.polygonId=SQ.polygonId)\t \t CountOfEtaDelayedDeliveryInPolygon\r\nINTO #CTE_DispatchRequest\r\nFROM\r\n(\r\n\tSELECT\t \r\n\t\tprvnc.ID\t     ProvinceId,\r\n\t\tp.Id\t \t \t PolygonId,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId = 35 AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime \r\n\t\t\tAND \r\n\t\t\t(\r\n\t\t\t\t(dr.CourierRequestTypeId IN ( 5,26,40,55,60 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @OndemandHyperDelayThresholdMinutes) \r\n\t\t\t\tOR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @ScheduledHyperDelayThresholdMinutes)\r\n\t\t\t) THEN 1 ELSE 0 END) AS CountOfSlaHyperDelayedDelivery,\r\n\t\t0 CountOfUnassignedRequestInPolygon\r\n\t\t,SUM(CASE WHEN DispatchRequestStatusId IN (30,35) AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\t THEN 1 Else 0 END) CountOfDeliveredInPolygon\r\n\t\t,SUM(CASE WHEN dr.DispatchRequestStatusId=30 AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\t \t \t \t \t \t \t \t THEN 1 ELSE 0 END) CountOfSlaOntimeDeliveryInPolygon \r\n\t\t,SUM(CASE WHEN dr.DispatchRequestStatusId=35 AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\t \t \t \t \t \t THEN 1 ELSE 0 END) CountOfSlaDelayedDeliveryInPolygon  \r\n\t\t,SUM(CASE WHEN DispatchRequestStatusId IN (30,35) AND CourierRequestTypeId IN (25,26,26,30,35) AND DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfReturnedDeliveryInPolygon \r\n\t\t,SUM(CASE WHEN dr.DispatchRequestStatusId in (17,40) AND DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfCanceledRequestInPolygon ,\r\n\t\t0 CountOfInprogressRequestInPolygon\r\n\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\tINNER JOIN #CourierRequestType crt\r\n\t\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\tON dr.PolygonStoreId=ps.Id\r\n\tINNER JOIN #Store s (NOLOCK)\r\n\t \t ON ps.StoreId = s.VID\t\t\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\tON ps.polygonid=po.id\t \r\n\tINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \r\n\t\tON p.Id=po.id\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\t\tON po.CityID = c.ID\r\n\tINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\t\tON c.ProvinceID = prvnc.ID\r\n\tWHERE dr.DeliveryStartTime between @StartRangeTime AND @EndRangeTime\r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\tAND DispatchRequestStatusId IN ( 30,35 , 17,40 )\r\n\tGroup By \r\n\t\tprvnc.Id,\r\n\t\tp.Id\t\r\n\tUNION ALL\r\n\tSELECT\t \r\n\t\tprvnc.ID\t     ProvinceId,\r\n\t\tp.Id\t \t \t PolygonId,\r\n\t\t0 CountOfSlaHyperDelayedDelivery,\r\n\t\tSUM(case when DispatchRequestStatusId in (5,6,7)/*Submitted*/AND( DeliveryStartTime \u003E= @StartRangeTime And DeliveryDeadLineTime  \u003C= @EndRangeTime AND dr.CourierRequestTypeId \u003C\u003E 51 ) THEN 1 ELSE 0 END )\t CountOfUnassignedRequestInPolygon,\r\n\t\t0 CountOfDeliveredInPolygon,\r\n\t\t0 CountOfSlaOntimeDeliveryInPolygon,\r\n\t\t0 CountOfSlaDelayedDeliveryInPolygon,\r\n\t\t0 CountOfReturnedDeliveryInPolygon,\r\n\t\t0 CountOfCanceledRequestInPolygon,\r\n\t\tSUM(CASE WHEN DispatchRequestStatusId IN (10,15,20,25,45,50,11,16,46,51,47,48,49,52,53,54) AND ( DeliveryStartTime \u003E = @EndRangeTime_5DaysAgo And DeliveryDeadlinetime \u003C= @EndRangeTime ) THEN 1 ELSE 0 END) CountOfInprogressRequestInPolygon\r\n\r\n\tFROM  CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n\tINNER JOIN #CourierRequestType crt\r\n\t\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n\t\tON dr.PolygonStoreId=ps.Id\r\n\tINNER JOIN #Store s (NOLOCK)\r\n\t\t ON ps.StoreId = s.VID\t\t\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n\t\tON ps.polygonid=po.id\t \r\n\tINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \r\n\t\tON p.Id=po.id\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n\t\tON po.CityID = c.ID\r\n\tINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n\t\tON c.ProvinceID = prvnc.ID\r\n\tWHERE dr.DeliveryStartTime \u003E = @EndRangeTime_5DaysAgo And DeliveryDeadlinetime \u003C= @EndRangeTime\r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\tAND DispatchRequestStatusId IN ( 5,6,7 ,10,15,20,25,45,50,11,16,46,51,47,48,49,52,53,54 ) \r\n\tGroup By \r\n\t\tprvnc.Id,\r\n\t\tp.Id\t\r\n) SQ\r\nGroup BY SQ.ProvinceId, SQ.PolygonId\r\nOPTION(RECOMPILE,USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\r\n----------------------------------------------------------------------------------------------------------\r\n--;WITH CTE_ShipmentDestPoints AS\r\n--(\r\n--\t SELECT\t \r\n--\t \t \t ProvinceId,\r\n--\t \t \t PolygonId,\r\n--\t\t\t dr.Id,\r\n--\t \t\tCAST(CONVERT(varchar, FORMAT( MAX(CASE WHEN CourierRequestTypeId IN (5/*On Demand Delivery*/,25/*On Demand Return*/) THEN \r\n--\t \t \t \t CASE WHEN drsh.DispatchRequestStatusId =5/*Submitted*/ THEN drsh.CreateDate END\r\n--\t \t \t END),\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME) SubmitTime_OnDemand,\r\n--\t \t \t CAST(CONVERT(varchar, FORMAT(MAX(CASE WHEN CourierRequestTypeId IN (5/*On Demand Delivery*/,25/*On Demand Return*/) THEN \r\n--\t \t \t \t CASE WHEN drsh.DispatchRequestStatusId=10/*Assigned To Courier*/ THEN drsh.CreateDate END \r\n--\t \t \t END),\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME) AssignTime_OnDemand,\r\n--\t \t \t CAST(CONVERT(varchar, FORMAT(MAX(CASE WHEN CourierRequestTypeId IN (5/*On Demand Delivery*/,25/*On Demand Return*/) THEN \r\n--\t \t \t \t CASE WHEN drsh.DispatchRequestStatusId IN (30/*Delivered*/,35/*DeliveredWithDelay*/) THEN drsh.CreateDate END\r\n--\t \t \t END),\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME) DeliveryTime_OnDemand,\r\n--\t \t \t CAST(CONVERT(varchar, FORMAT(MAX(CASE WHEN CourierRequestTypeId IN (10/*Scheduled Signle Delivery*/,15/*Scheduled Multiple Delivery*/,30/*Scheduled Single Return*/,35/*Scheduled Multiple Return*/) THEN\r\n--\t \t \t \t drsh.CreateDate\r\n--\t \t \t END),\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME) SubmitTime_Scheduled,\r\n--\t \t \tCAST(CONVERT(varchar, FORMAT( MAX(CASE WHEN CourierRequestTypeId IN (10/*Scheduled Signle Delivery*/,15/*Scheduled Multiple Delivery*/,30/*Scheduled Single Return*/,35/*Scheduled Multiple Return*/) THEN\r\n--\t \t \t \t CASE WHEN drsh.DispatchRequestStatusId=10 THEN drsh.CreateDate END \r\n--\t \t \t END),\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME) AssignTime_Scheduled,\r\n--\t \t \t CAST(CONVERT(varchar, FORMAT(MAX(CASE WHEN CourierRequestTypeId IN (10/*Scheduled Signle Delivery*/,15/*Scheduled Multiple Delivery*/,30/*Scheduled Single Return*/,35/*Scheduled Multiple Return*/) THEN\r\n--\t \t \t \t CASE WHEN drsh.DispatchRequestStatusId IN (30/*Delivered*/,35/*DeliveredWithDelay*/) THEN drsh.CreateDate END\r\n--\t \t \t END),\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME) DeliveryTime_Scheduled\r\n\r\n--\t FROM CS_Dispatcher.DP.DispatchRequest(NOLOCK) dr\r\n--\tINNER JOIN #CourierRequestType crt\r\n--\t\tON dr.CourierRequestTypeId = crt.ID\r\n--\tINNER JOIN CS_Dispatcher.dp.PolygonStore(NOLOCK) ps\t \t \t \t \r\n--\t\tON dr.PolygonStoreId=ps.Id\r\n--\tINNER JOIN #Store s (NOLOCK)\r\n--\t\t ON ps.StoreId = s.VID\t\t\r\n--\tINNER JOIN CS_Dispatcher.DP.Polygon(NOLOCK) po\t \t \t \t \t \r\n--\t\tON ps.polygonid=po.id\t \r\n--\tINNER JOIN #PolygonId p\t \t \t \t \t \t \t \t \t \t \t \r\n--\t\tON p.Id=po.id\r\n--\tINNER JOIN CS_Public.HAF.City c (NOLOCK)                        \r\n--\t\tON po.CityID = c.ID\r\n--\tINNER JOIN CS_Public.HAF.Province prvnc (NOLOCK)                \r\n--\t\tON c.ProvinceID = prvnc.ID\r\n--\t INNER JOIN CS_Dispatcher.dp.DispatchRequestStatusHistory drsh(NOLOCK)  \r\n--\t\tON drsh.DispatchRequestId=dr.Id\r\n--\tWHERE dr.DeliveryStartTime between @StartRangeTime AND @EndRangeTime\r\n--\tAND dr.DispatchRequestStatusId IN (30/*Delivered*/,35/*DeliveredWithDelay*/)\r\n--\tAND drsh.DispatchRequestStatusId IN ( 5,10,30,35 )\r\n--\tAND CourierRequestTypeId IN ( 5,25,10,15,30,35 )\r\n--     AND drsh.[Version] = 0\r\n\r\n--\t Group By ProvinceId,\r\n--\t \t \t PolygonId,\r\n--\t\t\t dr.Id\r\n--)\r\n--\tSELECT\t ProvinceId,\r\n--\t \t \tPolygonId,\r\n--\t \t \tCASE WHEN ISNULL(DATEDIFF(SECOND,AssignTime_OnDemand,DeliveryTime_OnDemand),0) \u003C 0 THEN 0 ELSE ISNULL(DATEDIFF(SECOND,AssignTime_OnDemand,DeliveryTime_OnDemand),0) END\t ETA_OnDemand,\r\n--\t \t \tCASE WHEN ISNULL(DATEDIFF(SECOND,AssignTime_Scheduled,DeliveryTime_Scheduled),0) \u003C 0 THEN 0 ELSE ISNULL(DATEDIFF(SECOND,AssignTime_Scheduled,DeliveryTime_Scheduled),0) END\t ETA_Scheduled, --AverageDeliveryTimeEtaInPolygon,\r\n--\t \t \tCASE WHEN ISNULL(DATEDIFF(SECOND,SubmitTime_OnDemand,DeliveryTime_OnDemand),0) \u003C 0 THEN 0 ELSE ISNULL(DATEDIFF(SECOND,SubmitTime_OnDemand,DeliveryTime_OnDemand),0) END\t SLA_OnDemand,\r\n--\t \t \tCASE WHEN ISNULL(DATEDIFF(SECOND,SubmitTime_Scheduled,DeliveryTime_Scheduled),0) \u003C 0 THEN 0 ELSE ISNULL(DATEDIFF(SECOND,SubmitTime_Scheduled,DeliveryTime_Scheduled),0) END\t SLA_Scheduled,\r\n--\t \t \tCASE WHEN ISNULL(DATEDIFF(SECOND,SubmitTime_OnDemand,AssignTime_OnDemand),0) \u003C 0 THEN 0 ELSE ISNULL(DATEDIFF(SECOND,SubmitTime_OnDemand,AssignTime_OnDemand),0) END\t \t WatingForAssignment_OnDemand,\r\n--\t \t \tCASE WHEN ISNULL(DATEDIFF(SECOND,SubmitTime_Scheduled,AssignTime_Scheduled),0) \u003C 0 THEN 0 ELSE ISNULL(DATEDIFF(SECOND,SubmitTime_Scheduled,AssignTime_Scheduled),0) END\t WatingForAssignment_Scheduled,\r\n--\t \t \tNullIF((SELECT CountOfDeliveredInPolygon FROM #CTE_DispatchRequest dr WHERE dr.ProvinceId=cte.ProvinceId AND dr.PolygonId=cte.PolygonId),0) CountOfDeliveredInPolygon\r\n--\tINTO #CTE_ShipmentDestPoint3\r\n--\tFROM CTE_ShipmentDestPoints cte\r\n--OPTION(RECOMPILE,USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n---------------------------------------------------------\r\n--\t SELECT  ProvinceId,\r\n--\t \t \t PolygonId,\r\n--\t \t \t CASE WHEN SUM(CountOfDeliveredInPolygon) = 0 THEN 0 ELSE SUM(ROUND(((ETA_OnDemand\u002BETA_Scheduled)/CountOfDeliveredInPolygon),0))\t END\t \t \t \t \t \t \t AverageDeliveryTimeEtaInPolygon,\r\n--\t \t \t CASE WHEN SUM(CountOfDeliveredInPolygon) = 0 THEN 0 ELSE SUM(ROUND(((SLA_OnDemand\u002BSLA_Scheduled)/CountOfDeliveredInPolygon),0))\t END\t \t \t \t \t \t \t \t AverageDeliveryTimeSlaInPolygon,\r\n--\t \t \t CASE WHEN SUM(CountOfDeliveredInPolygon) = 0 THEN 0 ELSE SUM(ROUND(((WatingForAssignment_OnDemand\u002BWatingForAssignment_Scheduled)/CountOfDeliveredInPolygon),0))\t END AverageWatingForAssignment\r\n--\t INTO #CTE_ShipmentDestPoint_InPolygon\r\n--\t FROM #CTE_ShipmentDestPoint3\r\n--\t GROUP  BY ProvinceId,PolygonId\r\n----------------------------------------------------------------------------\r\n\r\n--\t SELECT  ProvinceId,\r\n--\t \t \t CASE WHEN SUM(CountOfDeliveredTotal) = 0 THEN 0 ELSE SUM(ROUND(((ETA_OnDemand\u002BETA_Scheduled)/CountOfDeliveredTotal),0))\t END\t \t \t \t \t \t \t \t \t AverageDeliveryTimeEtaTotal,\r\n--\t \t \t CASE WHEN SUM(CountOfDeliveredTotal) = 0 THEN 0 ELSE SUM(ROUND(((SLA_OnDemand\u002BSLA_Scheduled)/CountOfDeliveredTotal),0))\t END\t \t \t \t \t \t \t \t \t AverageDeliveryTimeSlaTotal,\r\n--\t \t \t CASE WHEN SUM(CountOfDeliveredTotal) = 0 THEN 0 ELSE SUM(ROUND(((WatingForAssignment_OnDemand\u002BWatingForAssignment_Scheduled)/CountOfDeliveredTotal),0))\t END\t AverageWatingForAssignmentTotal\r\n--\t INTO #CTE_ShipmentDestPoint_Total\r\n--\t FROM \r\n--\t (\r\n--\t \t SELECT\t \r\n--\t \t \t \t *,\r\n--\t \t \t \t (SELECT CAST(SUM(CountOfDeliveredInPolygon) AS BIGINT)  FROM #CTE_DispatchRequest dr)CountOfDeliveredTotal\r\n\r\n--\t \t FROM #CTE_ShipmentDestPoint3\r\n--\t ) Point\r\n--\t WHERE CountOfDeliveredTotal \u003E 0\r\n--\t GROUP  BY ProvinceId\r\n\r\n\t SET @sql \u002B=\r\n\t \u0027 SET @Result=\r\n\t (\r\n\t \t SELECT DISTINCT\r\n\t \t \t \t provinceId,\r\n\t \t \t \t provinceTitle,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfDeliveredInPolygon)\t \t \t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfDelivered,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfEtaOntimeDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfEtaOnTimeDelivery,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfEtaDelayedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfEtaDelayedDelivery,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfSlaOntimeDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfSlaOntimeDelivery,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfSlaDelayedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfSlaDelayedDelivery,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfSlaDelayedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0) - ISNULL((SELECT SUM(CountOfSlaHyperDelayedDelivery) FROM #CTE_DispatchRequest dri ),0) AS totalCountOfSlaNormalDelayedDelivery,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfSlaHyperDelayedDelivery) FROM #CTE_DispatchRequest dri ),0) AS totalCountOfSlaHyperDelayedDelivery,\r\n\t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(countOfSLAOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri ),0) AS totalPercentageOfSlaOnTimeDelivery,\r\n\t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE 100 - ((SUM(countOfSlaOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon) AS FLOAT))*100) - ((SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100) END FROM #CTE_DispatchRequest dri ),0) AS totalPercentageOfSlaNormalDelayedDelivery,\r\n\t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri ),0) AS totalPercentageOfSlaHyperDelayedDelivery,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfReturnedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfReturnedDelivery,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfCanceledRequestInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t     totalCountOfCanceledRequest,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfUnassignedRequestInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t \t totalCountOfUnassignedRequest,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfTryingToAssign) FROM #SlaCounts ),0) totalCountOfTryingToAssign,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfNormalSlaPickupQueue) FROM #SlaCounts ),0) totalCountOfNormalSlaPickupQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfDelayedSlaPickupQueue) FROM #SlaCounts ),0) totalCountOfDelayedSlaPickupQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) FROM #SlaCounts sc),0) totalCountOfPickupQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfNormalSlaDeliveryQueue) FROM #SlaCounts ),0) totalCountOfNormalSlaDeliveryQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfDelayedSlaDeliveryQueue) FROM #SlaCounts ),0) totalCountOfDelayedSlaDeliveryQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) FROM #SlaCounts sc ),0) totalCountOfDeliveryQueue,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfNormalEtaPickupQueue) FROM #SlaCounts ),0) totalCountOfNormalEtaPickupQueue,\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfDelayedEtaPickupQueue) FROM #SlaCounts ),0) totalCountOfDelayedEtaPickupQueue,\r\n\r\n\t \t \t \t ISNULL((SELECT SUM(CountOfInprogressRequestInPolygon)\t FROM #CTE_DispatchRequest dr ),0)\t \t totalCountOfInprogressRequest,\r\n\t \t \t \t 0/*(SELECT SUM(CountOfUnsettledRequestInPolygon)FROM #CTE_DispatchRequest dr )*/\t \t         totalCountOfUnsettledRequest,\r\n\t \t \t \t isnull((SELECT SUM(ContinuesDelayed)\t \t \t FROM #ETA)\t ,0)\t \t \t \t                 totalContinuousDelayed,\r\n\t \t \t \t ISNULL((SELECT SUM(countOfOfflineFleetInPolygon)\t \t FROM #CountOfFleetInPolygon dr ),0)\t totalCountOfOfflineFleet,\r\n\t \t \t \t ISNULL((SELECT SUM(countOfOnlineFleetInPolygon)\t \t FROM #CountOfFleetInPolygon dr ),0)\t totalCountOfOnlineFleet,\r\n\t\t\t\t ISNULL((SELECT SUM(countOfBanFleetInPolygon)\t \t FROM #CountOfFleetInPolygon dr ),0)\t     totalCountOfBanFleet,\r\n\t \t \t \t ISNULL(\u0027\u002BCAST(@MeanDeliveryTimeMinutes AS VARCHAR(MAX))\u002B\u0027,0) AS MeanDeliveryTimeMinutes,\r\n\t \t \t \t (\t \r\n\t \t \t \t SELECT * FROM\r\n\t \t \t \t (SELECT \r\n\t \t \t \t \t \t DISTINCT\r\n\t \t \t \t \t \t Pi.polygonId,\r\n\t \t \t \t \t \t pi.polygonTitle,\r\n\t \t \t \t \t \t pi.RegionKey cityId,\r\n\r\n\t\t\t\t\t\t ISNULL((SELECT Capacity FROM #Capacity dri WHERE dri.PolygonId=pi.PolygonId),0)\t percentageCapacity,\r\n\t \t \t \t \t \t ISNULL((SELECT NCapacity FROM #Capacity dri WHERE dri.PolygonId=pi.PolygonId),0)\t nextPercentageCapacity,\t \t \t \t \t \t   \r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfDeliveredInPolygon)\t \t \t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfDelivered,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfSlaOntimeDeliveryInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfSlaOnTimeDelivery\t   ,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfSlaDelayedDeliveryInPolygon) FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfSlaDelayedDelivery\t   ,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfDeliveredInPolygon)\t \t \t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfDeliveredInPolygon,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfEtaOntimeDeliveryInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfEtaOnTimeDelivery\t   ,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfEtaDelayedDeliveryInPolygon) FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfEtaDelayedDelivery\t   ,\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(countOfEtaDelayedDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfEtaDelayedDelivery,\r\n\t\t\t\t\t\t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(countOfEtaOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfEtaOnTimeDelivery,\r\n\r\n\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfSlaHyperDelayedDelivery) FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS countOfSlaHyperDelayedDelivery,\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(countOfSLAOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfSlaOnTimeDelivery,\r\n\t \t \t \t \t \t --ISNULL((100 - (SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(countOfSLAOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon) AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId) - (SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId)),0) AS percentageOfSlaNormalDelayedDelivery,\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE 100 - ((SUM(countOfSlaOntimeDeliveryInPolygon)/CAST(SUM(countOfDeliveredInPolygon) AS FLOAT))*100) - ((SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100) END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfSlaDelayedDelivery,\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfDeliveredInPolygon) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(countOfDeliveredInPolygon)AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfSlaHyperDelayedDelivery,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfReturnedDeliveryInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId)\t ,0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfReturnedDelivery\t   ,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfCanceledRequestInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId)\t ,0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfCanceledRequest\t \t   ,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfUnassignedRequestInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId)\t ,0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfUnassignedRequest\t   ,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfTryingToAssign) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) countOfTryingToAssignment,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(countOfUnassignedRequestInPolygon) = 0 THEN 0 ELSE (((SELECT SUM(CountOfTryingToAssign) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId))/CAST(SUM(countOfUnassignedRequestInPolygon) AS FLOAT))*100 END FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0) AS percentageOfTryingToAssign,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfNormalSlaPickupQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId ),0) countOfNormalSlaPickupQueue,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfDelayedSlaPickupQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId ),0) countOfDelayedSlaPickupQueue,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId ),0) countOfPickupQueue,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfNormalSlaDeliveryQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId ),0) countOfNormalSlaDeliveryQueue,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfDelayedSlaDeliveryQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId ),0) countOfDelayedSlaDeliveryQueue,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) = 0 THEN 0 ELSE (SUM(CountOfDelayedSlaDeliveryQueue)/CAST(SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) AS FLOAT))*100 END FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) AS percentageOfDelayedSlaDeliveryQueue,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) countOfDeliveryQueue,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfNormalEtaPickupQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) countOfNormalEtaPickupQueue,\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(CountOfDelayedEtaPickupQueue) FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) countOfDelayedEtaPickupQueue,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT CASE WHEN SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) = 0 THEN 0 ELSE (SUM(CountOfDelayedEtaPickupQueue)/CAST(SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) AS FLOAT))*100 END FROM #SlaCounts sc WHERE sc.PolygonId=pi.PolygonId),0) AS percentageOfDelayedEtaPickupQueue,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT SUM(countOfInprogressRequestInPolygon)\t FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfInprogressRequest\t   ,\r\n\r\n\t \t \t \t \t \t 0/*(SELECT SUM(countOfUnsettledRequestInPolygon)FROM #CTE_DispatchRequest dri WHERE dri.PolygonId=pi.PolygonId)*/\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfUnsettledRequest\t   ,\r\n\t \t \t \t \t \t isnull((SELECT SUM(ContinuesDelayed)\t \t \t FROM #ETA\t   dri WHERE dri.PolygonId=pi.PolygonId)\t ,0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t continuousDelayed\t   ,\r\n\r\n\t \t \t \t \t \t ISNULL((SELECT countOfOfflineFleetInPolygon\t \t \t FROM #CountOfFleetInPolygon dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t \t countOfOfflineFleet,\r\n\t \t \t \t \t \t ISNULL((SELECT countOfOnlineFleetInPolygon\t \t \t FROM #CountOfFleetInPolygon dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t     \t countOfOnlineFleet, \t \t \t \t \t \t \t \t \t \t \t   \r\n\t\t\t             ISNULL((SELECT countOfBanFleetInPolygon\t \t \t FROM #CountOfFleetInPolygon dri WHERE dri.PolygonId=pi.PolygonId),0)\t \t \t \t \t \t \t \t \t \t \t \t \t \t \t     \t countOfBanFleet,\t \t \t \t \t   \r\n\r\n\t \t \t \t \t \t ISNULL(\u0027\u002BCAST(@MeanDeliveryTimeMinutes AS VARCHAR(MAX))\u002B\u0027,0) AS meanDeliveryTimeMinutes,\r\n\t \t \t \t \t \t ISNULL(ff.EstimatedOrderInNextHour,0) AS estimatedOrderInNextHour,\r\n\t \t \t \t \t \t ISNULL(ff.EstimatedAvailableFleetsInNextHour,0) AS estimatedAvailableFleetsInNextHour,\r\n\t \t \t \t \t \t ISNULL(ff.Mo2b,0) AS mo2b,\r\n\t \t \t \t \t \t ISNULL(ff.DriverShortageMinutes,0) AS driverShortageMinutes\r\n\t \t \t \t \t FROM #Polygon pi \r\n\t \t \t \t \t LEFT JOIN #ForecastFleet ff\r\n\t \t \t \t \t \t ON pi.PolygonId = ff.PolygonId\r\n\t \t \t \t \t )SQ\r\n\t \t \t \t \t order by \u0027 \u002B @OrderByReplace \u002B \r\n\r\n\t \t \u0027 FOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t \t \t \t ) polygonRequestList \r\n\t \t FROM #Polygon p\r\n\t \t GROUP BY p.ProvinceId,p.ProvinceTitle \r\n\t \t FOR JSON PATH ,WITHOUT_ARRAY_WRAPPER, INCLUDE_NULL_VALUES\r\n\t )\r\n\t SET @Result=REPLACE(@Result,\u0027\u0027\u0022polygonRequestList\u0022:null\u0027\u0027,\u0027\u0027\u0022polygonRequestList\u0022:[]\u0027\u0027)\u0027\r\n\r\n\tDECLARE @Param NVARCHAR(4000) = \u0027 @Result NVARCHAR(MAX) OUTPUT\u0027\r\n\r\n\tEXECUTE sys.sp_executeSQL @sql,@Param,@Result = @Result OUTPUT\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Polygon_SLAChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Polygon_SLAChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t\t @provinceId int ,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t \t @countOfDelayed INT OUTPUT,\r\n\t\t @countOfHyperDelaye INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\n\r\n\t DECLARE @MeanDeliveryTimeMinutes SMALLINT\r\n\t SELECT @MeanDeliveryTimeMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.MeanDeliveryTimeMinutes\u0027\r\n\r\n\t DECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t \t \t @ScheduledHyperDelayThresholdMinutes SMALLINT\r\n\t SELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\n\t SELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n--DROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\n--SELECT \r\n--\tcrt.Id\r\n--INTO #CourierRequestType\r\n--FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n--INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n--\tON crt.Id = ss.value\r\n--\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\nDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027\r\nSELECT\r\n\r\n\t@countOfDelivered_DQE=ISNULL(COUNT(Delivered),0),\r\n\t@countOfDelayed_DQE=ISNULL(COUNT(Delayed),0),\r\n\t@countOfHyperDelaye_DQE=ISNULL(COUNT(HyperDelaye),0)\r\n\t\r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 30 ) THEN DR.Id ELSE NULL END AS Delivered,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 35 ) THEN DR.Id ELSE NULL END AS Delayed,\r\n\t\tCASE WHEN [DispatchRequestStatusId] = 35  AND ((dr.CourierRequestTypeId IN ( 5,26,40,55,60 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME)) \u003E \u0027 \u002B CAST( @OndemandHyperDelayThresholdMinutes AS VARCHAR(MAX)) \u002B \u0027 ) OR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME)) \u003E \u0027 \u002B CAST( @ScheduledHyperDelayThresholdMinutes AS VARCHAR(MAX)) \u002B \u0027)) THEN DR.Id ELSE NULL END AS HyperDelaye\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t--INNER JOIN #CourierRequestType crt\r\n\t--\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n\t\tAND c.ProvinceId = \u0027 \u002B CAST(@provinceId AS VARCHAR(MAX)) \u002B\u0027 \r\n\tWHERE dr.DeliveryStartTime BETWEEN   \u0027 \u002BCAST(@TotalFrom AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027  \r\n\tAND [DispatchRequestStatusId] IN (30,35)\u0027\r\n\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @CustomerFilterType \u003E 0\r\n\tBEGIN\r\n\t\tIF @CustomerFilterType = 1\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\tIF @CustomerFilterType = 2\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\tIF @CustomerFilterType = 3\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\tIF @CustomerFilterType = 4\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\tEND\r\nSET @STR \u002B= \r\n\r\n\u0027 ) SQ\r\n  \r\nSELECT  \r\n\r\n    CAST( SQ.BarIndex AS DATETIME)  as labels,\r\n    COUNT(SQ.Id) AS dataValues\r\n FROM  \r\n(  \r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n    SELECT  \r\n        dr.Id,  \r\n        CASE  \r\n            WHEN dr.UpdateDate \u003C \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar12_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027\r\n            ELSE \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027  \r\n        END AS BarIndex\r\n            FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK) \r\n\t\t\t--INNER JOIN #CourierRequestType crt\r\n\t\t\t--\tON dr.CourierRequestTypeId = crt.ID\r\n            INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)  \r\n                ON dr.PolygonStoreId = ps.ID  \r\n            INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)  \r\n                ON ps.PolygonId = p.ID  \r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\t\t\tON pos.PolygonId = P.Id\r\n\t\t\t\tAND pos.IsActive = 1 \r\n            INNER JOIN CS_Public.Haf.City c (NOLOCK)  \r\n                ON p.CityId = c.ID  \r\n\t\t\t\tAND c.ProvinceId = \u0027 \u002B CAST(@provinceId AS VARCHAR(MAX)) \u002B\u0027 \r\n            WHERE dr.UpdateDate BETWEEN  \u0027 \u002BCAST (@From AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027   \r\n            AND dr.[DispatchRequestStatusId] IN (30)  \r\n\t\t\tAND DR.CourierRequestTypeId IN (5,15)\u0027\r\n\t\t\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\t\t\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\t\t\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\t\t\tIF @CustomerFilterType \u003E 0\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @CustomerFilterType = 1\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 2\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 3\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 4\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\t\t\tEND\r\n\r\n\t\tSET @STR \u002B=\r\n\t\t\u0027 ) SQ  \r\n\t\tGroup BY BarIndex  \r\n\t\tORDER BY BarIndex\u0027\r\n\r\n\t\tDECLARE @Param NVARCHAR(MAX) = \u0027\u0027\r\n\t\tSET @Param = \u0027 @countOfDelivered_DQE INT OUTPUT,@countOfDelayed_DQE INT OUTPUT,@countOfHyperDelaye_DQE INT OUTPUT\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL \r\n\t\t\t@STR,@Param, \r\n\t\t\t@countOfDelivered_DQE = @countOfDelivered OUTPUT,\r\n\t\t\t@countOfDelayed_DQE = @countOfDelayed OUTPUT ,\r\n\t\t\t@countOfHyperDelaye_DQE = @countOfHyperDelaye OUTPUT\r\n\r\n\t\t  SET  @title=N\u0027\u0628\u0631\u0645\u0628\u0646\u0627\u06CC SLA\u0027\r\n\r\n\t\tEND\r\n"},{"Name":"Get_Dashboard_Province","Schema":"dbo","Definition":"\r\n\r\n\r\n-- NEW\r\nCREATE      PROCEDURE [dbo].[Get_Dashboard_Province] \r\n--declare\r\n\t \t @PolygonIds\t \t \t NVARCHAR(MAX),\r\n\t \t @StartRangeTime\t \t BIGINT,\r\n\t \t @EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = 1,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),\r\n\t \t @OrderBy\t \t \t \t NVARCHAR(200) = NULL,\r\n\t \t @IsASC\t \t \t \t BIT = NULL,\r\n\t \t @Result\t \t \t \t NVARCHAR(MAX) OUTPUT\r\nAS\r\nSET NOCOUNT ON\r\n\r\nDECLARE @EndRangeTime_5DaysAgo BIGINT\r\nSELECT @EndRangeTime_5DaysAgo = REPLACE(REPLACE(REPLACE(REPLACE(CONVERT( NVARCHAR, DATEADD(DAY,-5, CAST(CONVERT(varchar, FORMAT(@EndRangeTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) , 121 ),\u0027-\u0027,\u0027\u0027),\u0027:\u0027,\u0027\u0027),\u0027.\u0027,\u0027\u0027),\u0027 \u0027,\u0027\u0027)\r\n\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n\t declare @sql1\t nvarchar(max),\r\n\t \t \t @sql2\t nvarchar(max),\r\n\t \t \t @sql\t nvarchar(max)\r\n\t DECLARE @OrderByReplace NVARCHAR(200),\r\n\t \t \t @ScheduledStartTime DateTime,\r\n\t \t \t @TodayWithScheduledStartTime BIGINT\r\n\r\n\t SELECT @ScheduledStartTime = Value FROM CS_Public.HAF.Setting WHERE name = \u0027DispatchRequestSchedulerSetting.ScheduledStartTime\u0027\r\n\t SET @ScheduledStartTime = GETDATE() \u002B ISNULL(@ScheduledStartTime,\u002700:00:00\u0027)\r\n\t SELECT @TodayWithScheduledStartTime = FORMAT(@ScheduledStartTime,\u0027yyyyMMddHHmmss\u0027)\u002B\u0027999\u0027\r\n\r\n\r\n\t SELECT @OrderByReplace =  CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\r\n\t DROP TABLE IF EXISTS #Provinces\r\n\t DROP TABLE IF EXISTS #AllDispatches\r\n\t DROP TABLE IF EXISTS #shipment\r\n\t DROP TABLE IF EXISTS #ContinuesDelayed\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoint\r\n\t DROP TABLE IF EXISTS #CTE_SUM\r\n\t DROP TABLE IF EXISTS #CTE_DispatchRequest\r\n\t DROP TABLE IF EXISTS #CTE_ShipmentDestPoints\r\n\t DROP TABLE IF EXISTS #CTE_CountOfEta\r\n\t DROP TABLE IF EXISTS #ForecastFleet\r\n\r\n\t DECLARE @Today BIGINT=(SELECT CONVERT(char(8), GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027) )\r\n\t DECLARE @LastMonth BIGINT=(SELECT CONVERT(char(8),DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)-30,112)\u002BREPLACE(CONVERT(char(12),DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)-30, 114),\u0027:\u0027,\u0027\u0027) )\r\n\r\n\r\n\t IF (@StartRangeTime IS NULL ) \r\n\t OR (@EndRangeTime IS NULL )\r\n\t OR dbo.FN_DateDiff(@StartRangeTime,@EndRangeTime)\u003E31\r\n\t BEGIN\r\n\t \t SET @Result=-1 \r\n\t \t RETURN\r\n\t END\r\n\r\n\r\n\t DROP TABLE IF EXISTS #Polygon\r\n\t CREATE TABLE #Polygon\r\n\t (\r\n\t\tPolygonId SMALLINT\r\n\t )\r\n\r\n\t IF ISNULL(@PolygonIds,\u00270\u0027) = \u00270\u0027\r\n\t\t BEGIN\r\n\t\t\t\r\n\t\t\tINSERT INTO #Polygon ( PolygonId )\r\n\t\t\tSELECT \r\n\t \t\t\tp.ID PolygonId\r\n\t\t\tFROM CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\r\n\t\t END\r\n\t ELSE\r\n\t\t BEGIN\r\n\r\n\t\t\tINSERT INTO #Polygon ( PolygonId )\r\n\t\t\tSELECT \r\n\t \t\t\tp.ID PolygonId\r\n\t\t\tFROM CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\t\tINNER JOIN STRING_SPLIT(@PolygonIds,\u0027,\u0027) ss\r\n\t \t\t\tON p.Id = ss.value\r\n\r\n\t\t END\r\n\r\n\r\n\t DECLARE @MeanDeliveryTimeMinutes SMALLINT\r\n\t SELECT @MeanDeliveryTimeMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.MeanDeliveryTimeMinutes\u0027\r\n\r\n\t DECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t \t \t @ScheduledHyperDelayThresholdMinutes SMALLINT\r\n\t SELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\n\t SELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n\t SELECT \r\n\t \t ff.ProvinceId,\r\n\t \t SUM(ff.EstimatedOrder) AS EstimatedOrderInNextHour,\r\n\t \t SUM(ff.EstimatedBiker) AS EstimatedAvailableFleetsInNextHour,\r\n\t \t /*SUM(ff.Mo2b)*/ CASE WHEN SUM(EstimatedBiker) = 0 AND SUM(@MeanDeliveryTimeMinutes * EstimatedOrder) = 0 THEN 0 WHEN SUM(EstimatedBiker) = 0 AND SUM(@MeanDeliveryTimeMinutes * EstimatedOrder) \u003E 0 THEN 100 ELSE SUM(@MeanDeliveryTimeMinutes * EstimatedOrder)/SUM(EstimatedBiker) END AS Mo2b,\r\n\t \t SUM(ff.BikerShortage) AS DriverShortageMinutes\r\n\t INTO #ForecastFleet\r\n\t FROM CS_Dispatcher.DP.ForecastFleet ff (NOLOCK)\r\n\t INNER JOIN #Polygon p\r\n\t \t ON ff.PolygonId = p.PolygonId\r\n\t Group By\r\n\t \t ff.ProvinceId\r\n\r\n\t SELECT \r\n\t \t crt.Id\r\n\t INTO #CourierRequestType\r\n\t FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n\t INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\t \t ON crt.Id = ss.value\r\n\t \t OR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\r\n\r\nSELECT \r\n\tc.ProvinceId,\r\n\tSUM(CASE WHEN DispatchRequestStatusId IN (5,6,7) AND dr.CourierRequestTypeId \u003C\u003E 51 THEN 1 ELSE 0 END) AS CountOfUnassignedRequest,\r\n\tSUM(CASE WHEN DispatchRequestStatusId IN (10,15,20,25,45,50,11,16,46,51 , 47,48,49,52,53,54) THEN 1 ELSE 0 END) AS CountOfInprogressRequest,\r\n\tSUM(CASE WHEN DispatchRequestStatusId IN (30,35)AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 Else 0 END) CountOfDelivered,\r\n\tSUM(CASE WHEN dr.DispatchRequestStatusId=30 AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfSlaOntimeDelivery,\r\n\tSUM(CASE WHEN dr.DispatchRequestStatusId=35 AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfSlaDelayedDelivery,\r\n\tSUM(CASE WHEN DispatchRequestStatusId IN (30,35) AND CourierRequestTypeId IN (25,26,30,35) AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfReturnedDelivery,\r\n\tSUM(CASE WHEN DispatchRequestStatusId IN (17,40) AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime THEN 1 ELSE 0 END) CountOfCanceledRequest,\r\n\tSUM(CASE WHEN dr.DispatchRequestStatusId = 35 AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime AND ((dr.CourierRequestTypeId IN ( 5,26,40,55,60 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @OndemandHyperDelayThresholdMinutes) OR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @ScheduledHyperDelayThresholdMinutes)) THEN 1 ELSE 0 END) AS CountOfSlaHyperDelayedDelivery\r\nINTO #AllDispatches\r\nFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\nINNER JOIN #CourierRequestType crt\r\n\tON dr.CourierRequestTypeId = crt.ID\r\nINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\tON dr.PolygonStoreId = ps.ID\r\nINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\tON ps.PolygonId = p.ID\r\nINNER JOIN #Polygon pp\r\n\tON p.ID = pp.PolygonId\r\nINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\tON p.CityId = c.ID\r\nWHERE dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\nAND DispatchRequestStatusId IN (30,35,17,40,5,6,7,10,15,20,25,45,50,11,16,46,51 , 47,48,49,52,53,54)\r\nAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\nAND \r\n(\r\n\t@CustomerFilterType = 0\r\n\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n)\r\nGroup By c.ProvinceId\r\nOPTION(RECOMPILE)\r\n\r\n\r\nSELECT \r\n\t c.ProvinceId , \r\n\t COUNT(CASE WHEN SQ.Type = 1 THEN Type ELSE NULL END ) CountOfTryingToAssign,\r\n\t COUNT(CASE WHEN SQ.Type = 2 THEN Type ELSE NULL END ) CountOfNormalSlaPickupQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 3 THEN Type ELSE NULL END ) CountOfDelayedSlaPickupQueue,\r\n\r\n\t COUNT(CASE WHEN SQ.Type = 4 THEN Type ELSE NULL END ) CountOfNormalSlaDeliveryQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 5 THEN Type ELSE NULL END ) CountOfDelayedSlaDeliveryQueue,\r\n\r\n\t COUNT(CASE WHEN SQ.Type = 6 THEN Type ELSE NULL END ) CountOfNormalEtaPickupQueue,\r\n\t COUNT(CASE WHEN SQ.Type = 7 THEN Type ELSE NULL END ) CountOfDelayedEtaPickupQueue\r\nINTO #SlaCounts\r\nFROM\r\n(\r\n\t SELECT \r\n\t \t dr.ID ,dr.PolygonStoreId, 1 Type \r\n\t FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t INNER JOIN #CourierRequestType crt\r\n\t \t ON dr.CourierRequestTypeId = crt.ID\r\n\t INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t ON dr.PolygonStoreId = ps.ID\r\n\t INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t ON ps.PolygonId = p.ID\r\n\t INNER JOIN #Polygon pp\r\n\t \t ON p.ID = pp.PolygonId\r\n\t INNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t ON p.CityId = c.ID\r\n\tINNER JOIN CS_OrderManagement.OM.Parcel parcel (NOLOCK)\r\n\t\tON dr.ParcelReferenceCode = parcel.ParcelReferenceCode\r\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\tON parcel.CourierRequestId = cr.Id\r\n\t\tAND cr.ConfirmationDate IS NOT NULL\r\n\tWHERE dr.CourierRequestTypeId \u003C\u003E 51\r\n\tAND dr.DispatchRequestStatusId IN ( 5,6,7 )\r\n\tAND dr.DeliveryStartTime \u003E= @StartRangeTime AND dr.DeliveryStartTime \u003C= @TodayWithScheduledStartTime\r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\tAND \r\n\t(\r\n\t\t@CustomerFilterType = 0\r\n\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t)\r\n\tUNION ALL\r\n\tSELECT \r\n\t \tdr.ID ,\r\n\t\tdr.PolygonStoreId, \r\n\t\tCASE \r\n\t\t\tWHEN dr.DeliveryDeadLineTime \u003E @Today THEN 2 \r\n\t\t\tWHEN dr.DeliveryDeadLineTime \u003C= @Today THEN 3 \r\n\t\t\tELSE NULL \r\n\t\tEND Type\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN #CourierRequestType crt\r\n\t \tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \tON ps.PolygonId = p.ID\r\n\tINNER JOIN #Polygon pp\r\n\t \tON p.ID = pp.PolygonId\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \tON p.CityId = c.ID\r\n\tWHERE dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\tAND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\tAND \r\n\t(\r\n\t\t@CustomerFilterType = 0\r\n\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t)\r\n\tUNION ALL\r\n\tSELECT \r\n\t \tdr.ID ,\r\n\t\tdr.PolygonStoreId, \r\n\t\tCASE \r\n\t\t\tWHEN dr.DeliveryDeadLineTime \u003E @Today THEN 4 \r\n\t\t\tWHEN dr.DeliveryDeadLineTime \u003C= @Today THEN 5\r\n\t\t\tELSE NULL \r\n\t\tEND Type\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN #CourierRequestType crt\r\n\t \tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \tON ps.PolygonId = p.ID\r\n\tINNER JOIN #Polygon pp\r\n\t \tON p.ID = pp.PolygonId\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \tON p.CityId = c.ID\r\n\tWHERE dr.DispatchRequestStatusId IN ( 20,25,45,50,46,47,48,49,51,52,53,54 )\r\n\tAND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\tAND \r\n\t(\r\n\t\t@CustomerFilterType = 0\r\n\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t)\r\n\tUNION ALL\r\n\r\n\tSELECT \r\n\t \tSQ.ID,\r\n\t \tSQ.PolygonStoreId,\r\n\t \tSQ.Type\r\n\tFROM\r\n\t(\r\n\t \tSELECT DISTINCT\r\n\t \t \tSQ.ID,\r\n\t \t \tSQ.PolygonStoreId,\r\n\t \t \tSQ.Type\r\n\t \tFROM\r\n\t \t(\r\n\t \t \t \tSELECT \r\n\t \t \t \t \tdr.Id,\r\n\t \t \t \t \tdr.PolygonStoreId,\r\n\t \t \t \t \tCASE WHEN DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003E= GETDATE() THEN 6 ELSE 7 END [Type],\r\n\t \t \t \t \tROW_NUMBER() OVER ( PARTITION BY Dr.ID ORDER BY sdp.ShipmentID DESC , sdp.ID DESC ) RowNum\r\n\t \t \t \tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t \t \t \tINNER JOIN #CourierRequestType crt\r\n\t \t \t \t \tON dr.CourierRequestTypeId = crt.ID\r\n\t \t \t \tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \t \t \t \tON dr.PolygonStoreId = ps.ID\r\n\t \t \t \tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \t \t \t \tON ps.PolygonId = p.ID\r\n\t \t \t \tINNER JOIN #Polygon pp\r\n\t \t \t \t \tON p.ID = pp.PolygonId\r\n\t \t \t \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \t \t \t \tON p.CityId = c.ID\r\n\t \t \t \tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t \t \t \t \tON dr.Id = sdpdr.DispatchRequestId\r\n\t \t \t \tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t \t \t \t \tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t \t \t \tWHERE dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\t \t \t \tAND dr.DeliveryStartTime \u003E= @StartRangeTime AND dr.DeliveryDeadLineTime \u003C= @EndRangeTime\r\n\t \t \t \tAND ( sdp.OperationTypeId IN ( 5,20 ) OR ( dr.CourierRequestTypeId = 51 AND sdp.OperationTypeId = 25 ))\r\n\t \t \t \tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\t\t\t\tAND \r\n\t\t\t\t(\r\n\t\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t\t\t)\r\n\t \t) SQ\r\n\t \tWHERE SQ.RowNum = 1\r\n\t) SQ\r\n) SQ\r\nINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t ON SQ.PolygonStoreId = ps.ID\r\nINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t ON ps.PolygonId = p.ID\r\nINNER JOIN #Polygon pp\r\n\t ON p.ID = pp.PolygonId\r\nINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t ON p.CityId = c.ID\r\nGroup By \r\n\t c.ProvinceId\r\nOPTION(RECOMPILE)\r\n\r\n\tSELECT\t \r\n\t\tProvinceId,\r\n\t \tSUM(CASE WHEN ShipmentDestinationPointStatusId=20 THEN 1 ELSE 0 END) CountOfEtaOntimeDelivery,\r\n\t \tSUM(CASE WHEN ShipmentDestinationPointStatusId=25 THEN 1 ELSE 0 END) CountOfEtaDelayedDelivery,\r\n\t\t1 AS AveETA\r\n\tINTO #CTE_CountOfEta\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN #CourierRequestType crt\r\n\t \tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t \tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t \tON ps.PolygonId = p.ID\r\n\tINNER JOIN #Polygon pp\r\n\t \tON p.ID = pp.PolygonId\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \tON p.CityId = c.ID\r\n\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t \tON dr.Id = sdpdr.DispatchRequestID\r\n\t\tAND dr.Version = sdpdr.Version\r\n\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t \tON sdp.ID = sdpdr.ShipmentDestinationPointID\r\n\tINNER JOIN CS_Dispatcher.DP.Shipment sh (NOLOCK)\r\n\t \tON sh.ID=sdp.ShipmentId\r\n\tWHERE dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\tAND dr.DispatchRequestStatusId IN ( 30,35 ) \r\n\tAND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0) \r\n\tAND sdp.OperationTypeId = 10\r\n\tAND sdp.ShipmentDestinationPointStatusId IN ( 20,25 )\r\n    AND \r\n\t(\r\n\t\t@CustomerFilterType = 0\r\n        OR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n        OR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n        OR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n        OR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t)\r\n\tGroup By c.ProvinceId\r\n\tOPTION(RECOMPILE)\r\n\r\n\t SELECT\t \r\n\t \t DISTINCT\r\n\t \t dr.ProvinceId,\r\n\t \t SUM(CountOfDelivered) CountOfDelivered,\r\n\t \t SUM(CountOfSlaOntimeDelivery)\t \t \t \t \t CountOfSlaOntimeDelivery,\r\n\t \t SUM(CountOfSlaDelayedDelivery)\t \t \t \t \t CountOfSlaDelayedDelivery,\r\n\t \t SUM(CountOfReturnedDelivery) CountOfReturnedDelivery,\r\n\t \t SUM(CountOfCanceledRequest) CountOfCanceledRequest,\r\n\t \t SUM(CountOfUnassignedRequest) CountOfUnassignedRequest,\r\n\t \t SUM(CountOfInprogressRequest) CountOfInprogressRequest,\r\n\t \t MAX(coe.CountOfEtaOntimeDelivery) CountOfEtaOntimeDelivery,\r\n\t \t MAX(coe.CountOfEtaDelayedDelivery) CountOfEtaDelayedDelivery,\r\n\t \t MAX(coe.AveEta) AveEta,\r\n\t \t SUM(CountOfSlaHyperDelayedDelivery) CountOfSlaHyperDelayedDelivery\r\n\r\n\t INTO #CTE_DispatchRequest\t \r\n\t FROM #AllDispatches dr\r\n\t LEFT JOIN #CTE_CountOfEta coe\r\n\t \t ON dr.ProvinceId = coe.ProvinceId\r\n\t GROUP BY dr.ProvinceId\r\n\r\n\r\n\tDECLARE @ShiftTime\t TIME=CAST(getdate() AS TIME),\r\n\t \t \t@ShiftDate\t DATE=CAST(GETDATE() AS DATE)\r\n\r\n\r\n\r\n\tSELECT \r\n\t \tProvinceId,\r\n\t \tISNULL(COUNT(DISTINCT CASE WHEN FleetStatusId = 10 THEN fleetid ELSE NULL END),0) countOfOfflineFleetInPolygon,\r\n\t\tISNULL(COUNT(DISTINCT CASE WHEN ((FleetStatusId=60 AND ReasonFleetChangeStateId IN (56,59,60,61,51))) THEN fleetid ELSE NULL END),0) countOfBanFleetInPolygon,\r\n\t\tISNULL\r\n\t\t(\r\n\t\t\tCOUNT\r\n\t\t\t(\r\n\t\t\t\tDISTINCT\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\t\tWHEN\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t(FleetStatusId=5 AND ReasonFleetChangeStateId NOT IN (62))\r\n\t\t                    OR (FleetStatusId=15 AND ReasonFleetChangeStateId IN (50,54,58,62,51))\r\n\t\t\t    \t\t\tOR(FleetStatusId=60 AND ReasonFleetChangeStateId IN (50,54,58))\r\n\t\t\t\t\t\t) THEN FleetId ELSE NULL END\r\n\t\t\t)\r\n\t\t,0) countOfOnlineFleetInPolygon\r\n\tINTO #CountOfFleetInPolygon\t \t \t \t \t \t \t \t \t \r\n\tFROM CS_DriverManagement.DM.TimeSlot AS ts (NOLOCK)\r\n\tINNER JOIN CS_DriverManagement.DM.Shift AS s (NOLOCK) \r\n\t\tON ts.Id = s.TimeSlotId \r\n\tINNER JOIN CS_DriverManagement.DM.ShiftDate AS sd (NOLOCK) \r\n\t\tON s.Id = sd.ShiftId \r\n\tINNER JOIN CS_DriverManagement.DM.ShiftFleetMap AS sfm (NOLOCK) \r\n\t\tON sd.Id = sfm.ShiftDateId \r\n\tINNER JOIN CS_DriverManagement.DM.Fleet f\t \t (NOLOCK)\t \t \t \t \t \t \t \t \r\n\t\tON f.id=sfm.fleetid \r\n\t\tAND f.IsActive=1 \r\n\t\tAND (f.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n\tinner join CS_DriverManagement.DM.fleetstatus fss (NOLOCK)              \r\n\t\ton f.fleetstatusid=fss.id\r\n\tINNER JOIN #Polygon p\t \t \t \t \t \t \t \t \t \t \t \t \t \r\n\t\tON s.PolygonId=p.PolygonId\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\r\n\t \tON s.PolygonId = pl.ID\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t \tON pl.CityId = c.ID\r\n\tWHERE sd.IsActive = 1\r\n\tAND s.Status = 1\r\n\tAND sfm.IsDeleted = 0\r\n\tAND sfm.IsAssigned = 1\r\n\tAND sfm.IsActive = 1\r\n\tAND sd.Date = @ShiftDate AND @ShiftTime BETWEEN [ts].[From] AND [ts].[To]\r\n\tGROUP BY ProvinceId\r\n\tOPTION(RECOMPILE)\r\n\t----------------------------------\r\n\r\nSELECT \r\n\tSQ.ProvinceId,\r\n\tCASE WHEN SUM(SQ.EstimateCapacity) = 0 THEN 0 ELSE CAST(ROUND((SUM(SQ.IsAssigned) * 100.0) / SUM(SQ.EstimateCapacity), 0) AS INT) END AS Capacity\r\nINTO #Capacity\r\nFROM\r\n(\r\n\tSELECT \r\n\t\tCOUNT(SFM.IsAssigned) AS IsAssigned\r\n\t\t,EstimateCapacity\r\n\t\t,pr.id as ProvinceId\r\n\tFROM [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK) ON pl.CityId = c.ID\r\n\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\tLEFT JOIN [CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\tWHERE sd.Date = @ShiftDate AND @ShiftTime BETWEEN [ts].[From] AND [ts].[To]\r\n\tGROUP BY \r\n\t\tEstimateCapacity,\r\n\t\tpr.id,\r\n\t\tpl.id\r\n) SQ\r\nGroup By SQ.ProvinceId\r\n\r\nSELECT \r\n\tSQ.ProvinceId,\r\n\tCASE WHEN SUM(SQ.NEXTIstimateCapacity) = 0 THEN 0 ELSE CAST(ROUND((SUM(SQ.NEXTIsAssigned) * 100.0) / SUM(SQ.NEXTIstimateCapacity), 0) AS INT) END AS NCapacity\r\nINTO #NCapacity\r\nFROM\r\n(\r\n   SELECT \r\n\t\tcount(SFM.IsAssigned) AS NEXTIsAssigned\r\n\t\t,EstimateCapacity AS NEXTIstimateCapacity\r\n\t\t,pr.id as ProvinceId\r\n\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK) ON pl.CityId = c.ID\r\n\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\tWHERE sd.Date = @ShiftDate \r\n\tAND [ts].[From] IN \r\n\t(\r\n\t\tSELECT \r\n\t\t\tts.[To]\r\n\t\tFROM    [CS_DriverManagement].[DM].[ShiftDate] AS SD WITH(NOLOCK)\r\n\t\tINNER JOIN [CS_DriverManagement].[DM].[Shift] AS S WITH(NOLOCK)   ON SD.ShiftId=S.Id --AND [PolygonId]=@PolygonId\r\n\t\tINNER JOIN [CS_DriverManagement].[DM].TimeSlot AS TS WITH(NOLOCK)  ON S.TimeSlotId=TS.ID --AND @ShiftTime BETWEEN [From] AND [To]\r\n\t\tINNER JOIN #Polygon p  ON s.PolygonId=p.PolygonId\r\n\t\tINNER JOIN CS_Dispatcher.DP.Polygon pl (NOLOCK)\tON s.PolygonId = pl.ID\r\n\t\tINNER JOIN CS_Public.Haf.City cC (NOLOCK) ON pl.CityId = cC.ID\r\n\t\tINNER JOIN [CS_Public].[Haf].[Province] pr  with(nolock) ON c.ProvinceId=pr.Id\r\n\t\tLEFT JOIN[CS_DriverManagement].[DM].[ShiftFleetMap] AS SFM WITH(NOLOCK)\tON SFM.ShiftDateId=SD.Id AND SFM.IsAssigned=1 and sfm.IsDeleted = 0 \r\n\t\tWHERE  sd.Date = @ShiftDate AND @ShiftTime BETWEEN [ts].[From] AND [ts].[To] AND CC.ProvinceId=C.ProvinceId \r\n\t)\r\n\tGroup By \r\n\t\tEstimateCapacity\r\n\t\t,pr.id \r\n\t\t,pl.id\r\n) SQ\r\nGroup By SQ.ProvinceId\r\n\r\n\r\n\r\n\t SET @Result =\r\n\t (\r\n\t \t SELECT \r\n\t \t \t SUM(CountOfDelivered)\t \t \t \t \t \t \t \t \t \t \t totalCountOfDelivered,\r\n\t \t \t SUM(CountOfEtaOntimeDelivery)\t \t \t \t \t \t \t \t \t totalCountOfEtaOnTimeDelivery,\r\n\t \t \t SUM(CountOfEtaDelayedDelivery)\t \t \t \t \t \t \t \t \t totalCountOfEtaDelayedDelivery,\r\n\t \t \t SUM(CountOfSlaOntimeDelivery)\t \t \t \t \t \t \t \t \t totalCountOfSlaOnTimeDelivery,\r\n\t \t \t SUM(CountOfSlaDelayedDelivery)\t \t \t \t \t \t \t \t \t totalCountOfSlaDelayedDelivery,\r\n\r\n\t \t \t SUM(CountOfSlaDelayedDelivery) - SUM(CountOfSlaHyperDelayedDelivery) AS totalCountOfSlaNormalDelayedDelivery,\r\n\r\n\r\n\t\t\t CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfEtaOntimeDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT)) *100 END AS  totalPercentageCountOfEtaOnTimeDelivery,\r\n\t\t\t CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfEtaDelayedDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT)) *100 END AS totalPercentageCountOfEtaDelayedDelivery,\r\n\r\n\t \t \t SUM(CountOfSlaHyperDelayedDelivery) AS totalCountOfSlaHyperDelayedDelivery,\r\n\t \t \t CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaOntimeDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT)) *100 END AS totalPercentageOfSlaOnTimeDelivery,\r\n\t \t \t CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE 100 - (CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaOntimeDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END) - (CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END) END AS totalPercentageOfSlaNormalDelayedDelivery,\r\n\t \t \t CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END AS totalPercentageOfSlaHyperDelayedDelivery,\r\n\r\n\t \t \t SUM(CountOfReturnedDelivery) totalCountOfReturnedDelivery,\r\n\t \t \t SUM(CountOfCanceledRequest) totalCountOfCanceledRequest,\r\n\t \t \t SUM(CountOfUnassignedRequest)  totalCountOfUnassignedRequest,\r\n\r\n\r\n\t\t\t SUM(ISNULL(CountOfInprogressRequest,0)) totalDisposal, --\u002B SUM(ISNULL(CountOfReturnedDelivery,0)) \r\n\r\n\t \t \t SUM(ISNULL(sc.CountOfTryingToAssign,0)) totalCountOfTryingToAssign,\r\n\t \t \t SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)) totalCountOfNormalSlaPickupQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfDelayedSlaPickupQueue,0)) totalCountOfDelayedSlaPickupQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) totalCountOfPickupQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)) totalCountOfNormalSlaDeliveryQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) totalCountOfDelayedSlaDeliveryQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)) totalCountOfDeliveryQueue,\r\n\r\n\t \t \t SUM(ISNULL(sc.CountOfNormalEtaPickupQueue,0)) totalCountOfNormalEtaPickupQueue,\r\n\t \t \t SUM(ISNULL(sc.CountOfDelayedEtaPickupQueue,0)) totalCountOfDelayedEtaPickupQueue,\r\n\r\n\t \t \t SUM(CountOfInprogressRequest)\t \t \t \t \t \t \t \t \t totalCountOfInprogressRequest,\r\n\t \t \t 0 totalCountOfUnsettledRequest ,\r\n\t \t \t 1 totalContinuousDelayed,\r\n\t \t \t \u002700:00:00\u0027 totalAverageDeliveryTimeEta,\r\n\t \t \t \u002700:00:00\u0027 totalAverageDeliveryTimeSla,\r\n\t \t \t \u002700:00:00\u0027 totalAverageWaitingForAssignment,\r\n\t \t \t \u002700:00:00\u0027\ttotalAverageEta,\r\n\t \t \t SUM(countOfOfflineFleetInPolygon) totalCountOfOfflineFleet,\r\n\t \t \t SUM(countOfOnlineFleetInPolygon) totalCountOfOnlineFleet,\r\n\t\t\t SUM(countOfBanFleetInPolygon) totalCountOfBanFleet ,\r\n\t \t \t ISNULL(@MeanDeliveryTimeMinutes,0) AS meanDeliveryTimeMinutes,\r\n\r\n\t \t \t (\r\n\t \t \t \t SELECT\r\n\t \t \t \t \t a.provinceId,\r\n\t \t \t \t \t p.Name provinceTitle,\r\n\t\t\t\t\t --ISNULL(cofip.Capacity,0) as percentageCapacity,\r\n\t\t\t\t\t ISNULL(C.Capacity,0) as percentageCapacity,\r\n\t\t\t\t\t --ISNULL(Nc.Capacity,0) as nextPercentageCapacity,\r\n\t\t\t\t\t ISNULL(Nc.NCapacity,0) as nextPercentageCapacity,\r\n\t\t\t\t\t ISNULL((CountOfDelivered),0)\t \t \t \t \t \t \t \t \t \t \t countOfDelivered,\r\n\t \t \t \t \t ISNULL((CountOfEtaOntimeDelivery),0)\t \t \t \t \t \t \t \t \t countOfEtaOnTimeDelivery,\r\n\t \t \t \t \t ISNULL((CountOfEtaDelayedDelivery),0)\t \t \t \t \t \t \t \t \t countOfEtaDelayedDelivery,\r\n\t \t \t \t \t CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfEtaDelayedDelivery/CAST(CountOfDelivered AS FLOAT))*100 END AS percentageOfEtaDelayedDelivery,\r\n\t\t\t\t\t CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfEtaOntimeDelivery/CAST(CountOfDelivered AS FLOAT)) *100 END AS percentageOfEtaOnTimeDelivery,\r\n\t \t \t \t \t ISNULL((CountOfSlaOntimeDelivery),0)\t \t \t \t \t \t \t \t \t countOfSlaOnTimeDelivery,\r\n\t \t \t \t \t ISNULL((CountOfSlaDelayedDelivery),0)\t \t \t \t \t \t \t \t \t countOfSlaDelayedDelivery,\r\n\r\n\t \t \t \t \t ISNULL(CountOfSlaHyperDelayedDelivery,0) AS countOfSlaHyperDelayedDelivery,\r\n\t \t \t \t \t CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfSlaOntimeDelivery/CAST(CountOfDelivered AS FLOAT)) *100 END AS percentageOfSlaOnTimeDelivery,\r\n\t \t \t \t \t CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE 100 - (CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfSlaOntimeDelivery/CAST(CountOfDelivered AS FLOAT))*100 END) - (CASE WHEN CountOfDelivered = 0 THEN 0 ELSE (CountOfSlaHyperDelayedDelivery/CAST(CountOfDelivered AS FLOAT))*100 END) END AS percentageOfSlaDelayedDelivery,\r\n\t \t \t \t \t CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfSlaHyperDelayedDelivery/CAST(CountOfDelivered AS FLOAT))*100 END AS percentageOfSlaHyperDelayedDelivery,\r\n\r\n\t \t \t \t \t ISNULL(CountOfReturnedDelivery,0)\t \t \t \t \t \t \t \t \t countOfReturnedDelivery,\r\n\t \t \t \t \t ISNULL(CountOfCanceledRequest,0)\t \t \t \t \t \t \t \t \t countOfCanceledRequest,\r\n\t \t \t \t \t ISNULL(CountOfUnassignedRequest,0)\t \t \t \t \t \t \t \t \t countOfUnassignedRequest,\r\n\r\n\t \t \t \t \t ISNULL(sc.CountOfTryingToAssign,0) countOfTryingToAssign,\r\n\r\n\t \t \t \t \t CASE WHEN ISNULL(CountOfUnassignedRequest,0) = 0 THEN 0 ELSE (ISNULL(sc.CountOfTryingToAssign,0)/CAST(CountOfUnassignedRequest AS FLOAT))*100 END AS  percentageOfTryingToAssign,\r\n\r\n\t \t \t \t \t ISNULL(sc.CountOfNormalSlaPickupQueue,0) countOfNormalSlaPickupQueue,\r\n\t \t \t \t \t ISNULL(sc.CountOfDelayedSlaPickupQueue,0) countOfDelayedSlaPickupQueue,\r\n\t \t \t \t \t ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0) countOfPickupQueue,\r\n\t \t \t \t \t ISNULL(sc.CountOfNormalSlaDeliveryQueue,0) countOfNormalSlaDeliveryQueue,\r\n\t \t \t \t \t ISNULL(sc.CountOfDelayedSlaDeliveryQueue,0) countOfDelayedSlaDeliveryQueue,\r\n\r\n\t \t \t \t \t CASE WHEN (ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)) = 0 THEN 0 ELSE ((ISNULL(sc.CountOfDelayedEtaPickupQueue,0))/CAST(ISNULL(sc.CountOfNormalSlaPickupQueue,0)\u002BISNULL(sc.CountOfDelayedSlaPickupQueue,0)AS FLOAT))*100 END AS percentageOfDelayedEtaPickupQueue,\r\n\r\n\t \t \t \t \t (ISNULL(sc.CountOfNormalEtaPickupQueue,0)) countOfNormalEtaPickupQueue,\r\n\t \t \t \t \t (ISNULL(sc.CountOfDelayedEtaPickupQueue,0)) countOfDelayedEtaPickupQueue,\r\n\r\n\t \t \t \t \t CASE WHEN ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0) = 0 THEN 0 ELSE (ISNULL(sc.CountOfDelayedSlaDeliveryQueue,0)/CAST(ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0) AS FLOAT))*100 END AS percentageOfDelayedSlaDeliveryQueue,\r\n\t \t \t \t \t \t \t \t \t \t \r\n\t \t \t \t \t ISNULL(sc.CountOfNormalSlaDeliveryQueue,0)\u002BISNULL(sc.CountOfDelayedSlaDeliveryQueue,0) countOfDeliveryQueue,\r\n\t \t \t \t \t ISNULL(CountOfInprogressRequest,0) countOfInprogressRequest,\r\n\t \t \t \t \t 0 countOfUnsettledRequest,\r\n\t \t \t \t \t 1 continuousDelayed,\r\n\t \t \t \t \t \u002700:00:00\u0027 averageDeliveryTimeEta,\r\n\t \t \t \t \t \u002700:00:00\u0027 averageDeliveryTimeSla,\r\n\t \t \t \t \t \u002700:00:00\u0027 averageWaitingForAssignment,\r\n\t \t \t \t \t \u002700:00:00\u0027\taverageEta,\r\n\t \t \t \t \t ISNULL(cofip.countOfOfflineFleetInPolygon,0) countOfOfflineFleet,\r\n\t \t \t \t \t ISNULL(cofip.countOfOnlineFleetInPolygon,0) countOfOnlineFleet,\r\n\t\t\t\t\t ISNULL(cofip.countOfBanFleetInPolygon,0) countOfBanFleet,\r\n\t \t \t \t \t ISNULL(@MeanDeliveryTimeMinutes,0) AS meanDeliveryTimeMinutes,\r\n\t \t \t \t \t ISNULL(ff.EstimatedOrderInNextHour,0) AS estimatedOrderInNextHour,\r\n\t \t \t \t \t ISNULL(ff.EstimatedAvailableFleetsInNextHour,0) AS estimatedAvailableFleetsInNextHour,\r\n\t \t \t \t \t ISNULL(ff.Mo2b,0) AS mo2b,\r\n\t \t \t \t \t ISNULL(ff.DriverShortageMinutes,0) AS driverShortageMinutes\r\n\t \t \t \t FROM #CTE_DispatchRequest a\r\n\t\t\t\t INNER JOIN CS_Public.Haf.Province p WITH(NOLOCK)\r\n\t\t\t\t\tON a.ProvinceId = p.Id\r\n\t \t \t \t LEFT JOIN #CountOfFleetInPolygon cofip\r\n\t \t \t \t \t ON a.ProvinceId = cofip.ProvinceId\r\n\t \t \t \t LEFT JOIN #SlaCounts sc\r\n\t \t \t \t \t ON a.ProvinceId = sc.ProvinceId\r\n\t \t \t \t LEFT JOIN #ForecastFleet ff\r\n\t \t \t \t \t ON a.ProvinceId = ff.ProvinceId\r\n                 --LEFT JOIN #NextCapacity NC\r\n\t\t\t\t LEFT JOIN #Capacity C\t\t\t\t \r\n\t\t\t\t\t ON a.ProvinceId = C.ProvinceId\r\n\t\t\t\tLEFT JOIN #NCapacity NC\r\n\t\t\t\t\tON a.ProvinceId = NC.ProvinceId\r\n\t \t \t \t ORDER BY\r\n\t \t \t \t \t CASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027\r\n\t \t \t \t \t \t THEN \r\n\t \t \t \t \t \t \t \t @OrderByReplace \r\n\r\n\t \t \t \t \t \t ELSE CAST(a.ProvinceId AS NVARCHAR(MAX))\r\n\t \t \t \t \t END\r\n\t \t \t \t FOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t \t \t ) provinceRequestList \r\n\t \t FROM #CTE_DispatchRequest a\r\n\t \t LEFT JOIN #SlaCounts sc\r\n\t \t \t ON a.ProvinceId = sc.ProvinceId\r\n\t \t LEFT JOIN #CountOfFleetInPolygon cofip\r\n\t \t \t ON a.ProvinceId = cofip.ProvinceId\r\n\t \t FOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n\t )\r\n\t SET @Result=REPLACE(@Result,\u0027\u0022provinceRequestList\u0022:null\u0027,\u0027\u0022provinceRequestList\u0022:[]\u0027)\r\n"},{"Name":"Get_Dashboard_Province_DeliveryChart","Schema":"dbo","Definition":"-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE   PROCEDURE [dbo].[Get_Dashboard_Province_DeliveryChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = 1,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t \t @countOfQueue INT OUTPUT,\r\n\t\t @countOfInProgress INT OUTPUT,\r\n\t\t @totalCount INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n--DROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\n--SELECT \r\n--\tcrt.Id\r\n--INTO #CourierRequestType\r\n--FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n--INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n--\tON crt.Id = ss.value\r\n--\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@End BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027235900000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\nDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027 SELECT\r\n\t@countOfQueue_DQE = ISNULL(COUNT([Queue]),0),\r\n\t@countOfInProgress_DQE = ISNULL(COUNT(InProgress),0),\r\n\t@totalCount_DQE = ISNULL(COUNT(Delivered),0)\r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN (5,6,7 ) AND dr.CourierRequestTypeId \u003C\u003E 51 THEN DR.Id ELSE NULL END AS [Queue],\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 10,15,20,25 ) THEN DR.Id ELSE NULL END AS InProgress,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 30,35 ) AND CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70) THEN DR.Id ELSE NULL END AS Delivered\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t--INNER JOIN #CourierRequestType crt\r\n\t--ON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t--\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n\tWHERE dr.DeliveryStartTime BETWEEN \u0027\u002BCAST(@TotalFrom AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@End AS VARCHAR(MAX))\u002B\u0027\r\n\tAND [DispatchRequestStatusId] IN (5,6,7,10,15,20,25,30,35)\u0027\r\n\r\n\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @CustomerFilterType \u003E 0\r\n\tBEGIN\r\n\t\tIF @CustomerFilterType = 1\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\tIF @CustomerFilterType = 2\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\tIF @CustomerFilterType = 3\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\tIF @CustomerFilterType = 4\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\tEND\r\n\r\nSET @STR \u002B= \r\n\u0027 ) SQ\r\n \r\nSELECT  \r\n\r\n  CAST( SQ.BarIndex AS DATETIME)  as labels,\r\n  --  SQ.BarIndex  as labels,\r\n    COUNT(SQ.Id) AS dataValues\r\n FROM  \r\n(  \r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n    SELECT  \r\n        dr.Id,  \r\n        CASE  \r\n            WHEN dr.UpdateDate \u003C \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar12_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027\r\n            ELSE \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027  \r\n        END AS BarIndex\r\n    FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)  \r\n\t--INNER JOIN #CourierRequestType crt\r\n\t--\tON dr.CourierRequestTypeId = crt.ID\r\n    INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)  \r\n        ON dr.PolygonStoreId = ps.ID  \r\n    INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)  \r\n        ON ps.PolygonId = p.ID  \r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = P.Id\r\n\t\tAND pos.IsActive = 1 \r\n    INNER JOIN CS_Public.Haf.City c (NOLOCK)  \r\n        ON p.CityId = c.ID  \r\n\tWHERE dr.UpdateDate BETWEEN \u0027\u002BCAST(@From AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B\u0027\r\n\tAND [DispatchRequestStatusId] IN (30,35)\r\n\tAND DR.CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70)\u0027\r\n\r\n\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @CustomerFilterType \u003E 0\r\n\tBEGIN\r\n\t\tIF @CustomerFilterType = 1\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\tIF @CustomerFilterType = 2\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\tIF @CustomerFilterType = 3\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\tIF @CustomerFilterType = 4\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\tEND\r\n\r\nSET @STR \u002B=\r\n\u0027 ) SQ  \r\nGroup BY BarIndex  \r\nORDER BY BarIndex\u0027\r\n\r\nDECLARE @Param NVARCHAR(MAX) = \u0027\u0027\r\nSET @Param = \u0027 @countOfQueue_DQE INT OUTPUT,@countOfInProgress_DQE INT OUTPUT,@totalCount_DQE INT OUTPUT\u0027\r\n\r\nEXECUTE sys.sp_executeSQL \r\n\t@STR,@Param, \r\n\t@countOfQueue_DQE = @countOfQueue OUTPUT,\r\n\t@countOfInProgress_DQE = @countOfInProgress OUTPUT,\r\n\t@totalCount_DQE = @totalCount OUTPUT\r\n\r\nSET @title=N\u0027\u0633\u0641\u0627\u0631\u0634\u0627\u062A\u0027\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Province_DeliveryChart_N","Schema":"dbo","Definition":"\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Province_DeliveryChart_N]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = 1,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t \t @countOfQueue INT OUTPUT,\r\n\t\t @countOfInProgress INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\nDROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\nSELECT \r\n\tcrt.Id\r\nINTO #CourierRequestType\r\nFROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\nINNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\tON crt.Id = ss.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\n\r\nSELECT\r\n    @title=N\u0027\u0633\u0641\u0627\u0631\u0634\u0627\u062A\u0027,\r\n\t@countOfQueue=ISNULL(COUNT([Queue]),0),\r\n\t@countOfInProgress=ISNULL(COUNT(InProgress),0),\r\n\t@countOfDelivered=ISNULL(COUNT(Delivered),0) \r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 5,7 ) THEN DR.Id ELSE NULL END AS [Queue],\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 10,15,20,25 ) THEN DR.Id ELSE NULL END AS InProgress,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 30,35 ) THEN DR.Id ELSE NULL END AS Delivered\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN #CourierRequestType crt\r\n\t\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n\tWHERE dr.DeliveryStartTime BETWEEN @TotalFrom AND @To\r\n\tAND [DispatchRequestStatusId] IN (5,7,10,15,20,25,30,35)\r\n\tAND pos.OperationStaffId = @OperationStaffId\r\n\tAND\r\n\t(\r\n\t\t@CustomerFilterType = 0\r\n\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t)\r\n) SQ\r\nOPTION(RECOMPILE)\r\n\r\n \r\n        SELECT  \r\n            SQ.BarIndex  as labels,\r\n            COUNT(SQ.Id) AS dataValues\r\n        FROM  \r\n        (  \r\n            SELECT  \r\n                dr.Id,  \r\n                CASE  \r\n                    WHEN dr.UpdateDate \u003C @Bar1_BIGINT THEN @Bar1  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar1_BIGINT AND @Bar2_BIGINT THEN @Bar2  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar2_BIGINT AND @Bar3_BIGINT THEN @Bar3  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar3_BIGINT AND @Bar4_BIGINT THEN @Bar4  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar4_BIGINT AND @Bar5_BIGINT THEN @Bar5  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar5_BIGINT AND @Bar6_BIGINT THEN @Bar6  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar6_BIGINT AND @Bar7_BIGINT THEN @Bar7  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar7_BIGINT AND @Bar8_BIGINT THEN @Bar8  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar8_BIGINT AND @Bar9_BIGINT THEN @Bar9  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar9_BIGINT AND @Bar10_BIGINT THEN @Bar10  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar10_BIGINT AND @Bar11_BIGINT THEN @Bar11  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar11_BIGINT AND @Bar12_BIGINT THEN @Bar12  \r\n                    ELSE @Bar12  \r\n                END AS BarIndex\r\n            FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)  \r\n            INNER JOIN #CourierRequestType crt  \r\n                ON dr.CourierRequestTypeId = crt.ID  \r\n            INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)  \r\n                ON dr.PolygonStoreId = ps.ID  \r\n            INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)  \r\n                ON ps.PolygonId = p.ID  \r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\t\t\tON pos.PolygonId = P.Id\r\n\t\t\t\tAND pos.IsActive = 1 \r\n            INNER JOIN CS_Public.Haf.City c (NOLOCK)  \r\n                ON p.CityId = c.ID  \r\n            WHERE dr.UpdateDate BETWEEN @From AND @To  \r\n            AND dr.[DispatchRequestStatusId] IN (30,35)  \r\n\t\t\tAND pos.OperationStaffId = @OperationStaffId\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t\t)\r\n        ) SQ  \r\n        Group BY BarIndex  \r\n        ORDER BY BarIndex \r\n\tOPTION(RECOMPILE)\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Province_DeliveryChart_old","Schema":"dbo","Definition":"\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCreate PROCEDURE [dbo].[Get_Dashboard_Province_DeliveryChart_old]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = 1,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),\r\n\t \t @Result\t \t \t \t NVARCHAR(MAX) OUTPUT\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\nDROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\nSELECT \r\n\tcrt.Id\r\nINTO #CourierRequestType\r\nFROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\nINNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\tON crt.Id = ss.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\nDECLARE \r\n\t@Queue INT,\r\n\t@InProgress INT,\r\n\t@Delivered INT\r\n\r\nSELECT\r\n\t@Queue=COUNT([Queue]),\r\n\t@InProgress=COUNT(InProgress),\r\n\t@Delivered=COUNT(Delivered) \r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 5,7 ) THEN DR.Id ELSE NULL END AS [Queue],\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 10,15,20,25 ) THEN DR.Id ELSE NULL END AS InProgress,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 30,35 ) THEN DR.Id ELSE NULL END AS Delivered\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN #CourierRequestType crt\r\n\t\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n\tWHERE dr.DeliveryStartTime BETWEEN @From AND @To\r\n\tAND [DispatchRequestStatusId] IN (5,7,10,15,20,25,30,35)\r\n\tAND pos.OperationStaffId = @OperationStaffId\r\n\tAND\r\n\t(\r\n\t\t@CustomerFilterType = 0\r\n\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t)\r\n) SQ\r\nOPTION(RECOMPILE)\r\n\r\nselect @Result=(  \r\nSELECT   \r\n    N\u0027\u0633\u0641\u0627\u0631\u0634\u0627\u062A\u0027 as title,\r\n    @Queue AS countOfQueue, \r\n    @InProgress AS countOfInProgress, \r\n    @Delivered AS countOfDelivered, \r\n    (  \r\n        SELECT  \r\n            SQ.BarIndex  as dataValues,\r\n            COUNT(SQ.Id) AS labels\r\n        FROM  \r\n        (  \r\n            SELECT  \r\n                dr.Id,  \r\n                CASE  \r\n                    WHEN dr.DeliveryStartTime \u003C @Bar1_BIGINT THEN @Bar1  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar1_BIGINT AND @Bar2_BIGINT THEN @Bar2  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar2_BIGINT AND @Bar3_BIGINT THEN @Bar3  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar3_BIGINT AND @Bar4_BIGINT THEN @Bar4  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar4_BIGINT AND @Bar5_BIGINT THEN @Bar5  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar5_BIGINT AND @Bar6_BIGINT THEN @Bar6  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar6_BIGINT AND @Bar7_BIGINT THEN @Bar7  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar7_BIGINT AND @Bar8_BIGINT THEN @Bar8  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar8_BIGINT AND @Bar9_BIGINT THEN @Bar9  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar9_BIGINT AND @Bar10_BIGINT THEN @Bar10  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar10_BIGINT AND @Bar11_BIGINT THEN @Bar11  \r\n                    WHEN dr.DeliveryStartTime BETWEEN @Bar11_BIGINT AND @Bar12_BIGINT THEN @Bar12  \r\n                    ELSE @Bar12  \r\n                END AS BarIndex\r\n            FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)  \r\n            INNER JOIN #CourierRequestType crt  \r\n                ON dr.CourierRequestTypeId = crt.ID  \r\n            INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)  \r\n                ON dr.PolygonStoreId = ps.ID  \r\n            INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)  \r\n                ON ps.PolygonId = p.ID  \r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\t\t\tON pos.PolygonId = P.Id\r\n\t\t\t\tAND pos.IsActive = 1 \r\n            INNER JOIN CS_Public.Haf.City c (NOLOCK)  \r\n                ON p.CityId = c.ID  \r\n            WHERE dr.DeliveryStartTime BETWEEN @From AND @To  \r\n            AND dr.[DispatchRequestStatusId] IN (30,35)  \r\n\t\t\tAND pos.OperationStaffId = @OperationStaffId\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t@CustomerFilterType = 0\r\n\t\t\t\tOR (@CustomerFilterType = 1 AND dr.VendorId NOT IN (37,726,41))\r\n\t\t\t\tOR (@CustomerFilterType = 2 AND dr.VendorId IN (37))\r\n\t\t\t\tOR (@CustomerFilterType = 3 AND dr.VendorId IN (726))\r\n\t\t\t\tOR (@CustomerFilterType = 4 AND dr.VendorId IN (41))\r\n\t\t\t)\r\n        ) SQ  \r\n        Group BY BarIndex  \r\n        ORDER BY BarIndex  \r\n        FOR JSON PATH  \r\n    ) AS resultData   \r\n    FOR JSON PATH, WITHOUT_ARRAY_WRAPPER)  \r\n\tOPTION(RECOMPILE)\r\n\r\nset @Result=replace(@Result,\u0027\\\u0027,\u0027\u0027)\r\nset @Result=replace(@Result,\u0027\u0022{\u0027,\u0027{\u0027)\r\nset @Result=replace(@Result,\u0027}\u0022\u0027,\u0027}\u0027)\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Province_ETAChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Province_ETAChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt =1,\r\n\t\t @CustomerFilterType TinyInt ,\r\n\t\t @countOfDelayed INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n\r\n--DROP TABLE IF EXISTS #CourierRequestType\r\n\r\n\t\r\n--SELECT \r\n--\tcrt.Id\r\n--INTO #CourierRequestType\r\n--FROM CS_Public.[PUB].[CourierRequestType] crt (NOLOCK)\r\n--INNER JOIN STRING_SPLIT(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n--\tON crt.Id = ss.value\r\n--\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027;\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT)\r\n\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\nDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027\r\nSELECT\r\n\r\n\t@countOfDelivered_DQE=ISNULL(COUNT(Delivered),0),\r\n\t@countOfDelayed_DQE=ISNULL(COUNT(Delayed),0)\r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN ShipmentDestinationPointStatusId IN (20 ) THEN DR.Id ELSE NULL END AS Delivered,\r\n\t\tCASE WHEN ShipmentDestinationPointStatusId IN (25 ) THEN DR.Id ELSE NULL END AS Delayed\r\n\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t--INNER JOIN #CourierRequestType crt\r\n\t--\tON dr.CourierRequestTypeId = crt.ID\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n    INNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\tON dr.ID = sdpdr.DispatchRequestId\r\n\tAND dr.Version = sdpdr.Version\r\n    INNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\tWHERE dr.DeliveryStartTime BETWEEN \u0027 \u002BCAST(@TotalFrom AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027\r\n\tAND dr.DispatchRequestStatusId IN ( 30,35 ) \r\n\tAND sdp.OperationTypeId = 10\r\n\tAND sdp.ShipmentDestinationPointStatusId IN ( 20,25 )\u0027\r\n\t\r\n\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @CustomerFilterType \u003E 0\r\n\tBEGIN\r\n\t\tIF @CustomerFilterType = 1\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\tIF @CustomerFilterType = 2\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\tIF @CustomerFilterType = 3\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\tIF @CustomerFilterType = 4\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\tEND\r\nSET @STR \u002B= \r\n\u0027 ) SQ\r\n\r\n\r\n \r\nSELECT  \r\n\r\n  CAST( SQ.BarIndex AS DATETIME)  as labels,\r\n    COUNT(SQ.Id) AS dataValues\r\n FROM  \r\n(  \r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n    SELECT  \r\n        dr.Id,  \r\n        CASE  \r\n            WHEN dr.UpdateDate \u003C \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar12_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027\r\n            ELSE \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027  \r\n        END AS BarIndex\r\n            FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)  \r\n\t\t\t--INNER JOIN #CourierRequestType crt\r\n\t  --    \t    ON dr.CourierRequestTypeId = crt.ID\r\n            INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)  \r\n                ON dr.PolygonStoreId = ps.ID  \r\n            INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)  \r\n                ON ps.PolygonId = p.ID  \r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\t\t\tON pos.PolygonId = P.Id\r\n\t\t\t\tAND pos.IsActive = 1 \r\n  \t\t\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\t\t\tON p.CityId = c.ID\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\t\t\t\tON dr.ID = sdpdr.DispatchRequestId\r\n\t\t\tAND dr.Version = sdpdr.Version\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\t\t\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\t\tWHERE dr.UpdateDate BETWEEN    \u0027 \u002BCAST(@From AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027 \r\n\t\t\tAND dr.DispatchRequestStatusId IN ( 30 ) \r\n\t\t\tAND sdp.OperationTypeId = 10\r\n\t\t\tAND sdp.ShipmentDestinationPointStatusId IN ( 20 )\u0027\r\n\r\n\t\t\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\t\t\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\t\t\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\t\t\tIF @CustomerFilterType \u003E 0\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @CustomerFilterType = 1\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 2\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 3\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 4\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\t\t\tEND\r\nSET @STR \u002B=\r\n\u0027 ) SQ  \r\nGroup BY BarIndex  \r\nORDER BY BarIndex\u0027\r\n\r\nDECLARE @Param NVARCHAR(MAX) = \u0027\u0027\r\nSET @Param = \u0027 @countOfDelivered_DQE INT OUTPUT,@countOfDelayed_DQE INT OUTPUT\u0027\r\n\r\nEXECUTE sys.sp_executeSQL \r\n\t@STR,@Param, \r\n\t@countOfDelivered_DQE = @countOfDelivered OUTPUT,\r\n\t@countOfDelayed_DQE = @countOfDelayed OUTPUT\r\n\r\nSET @title=N\u0027\u0628\u0631\u0645\u0628\u0646\u0627\u06CC ETA\u0027\r\nEND"},{"Name":"Get_Dashboard_Province_SLAChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Province_SLAChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = 1,\r\n\t\t @CustomerFilterType TinyInt ,\r\n\t \t @countOfDelayed INT OUTPUT,\r\n\t\t @countOfHyperDelaye INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\n\r\n\t DECLARE @MeanDeliveryTimeMinutes SMALLINT\r\n\t SELECT @MeanDeliveryTimeMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.MeanDeliveryTimeMinutes\u0027\r\n\r\n\t DECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t \t \t @ScheduledHyperDelayThresholdMinutes SMALLINT\r\n\t SELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\n\t SELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\n\r\nDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027\r\nSELECT\r\n\r\n\t@countOfDelivered_DQE=ISNULL(COUNT(Delivered),0),\r\n\t@countOfDelayed_DQE=ISNULL(COUNT(Delayed),0),\r\n\t@countOfHyperDelaye_DQE=ISNULL(COUNT(HyperDelaye),0)\r\n\t\r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 30 )  THEN DR.Id ELSE NULL END AS Delivered,\r\n\t\tCASE WHEN [DispatchRequestStatusId] IN ( 35 )  THEN DR.Id ELSE NULL END AS Delayed,\r\n\t\tCASE WHEN [DispatchRequestStatusId] = 35  AND ((dr.CourierRequestTypeId IN ( 5,26,40,55,60 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME)) \u003E\u0027 \u002B CAST(@OndemandHyperDelayThresholdMinutes AS VARCHAR(MAX))\u002B\u0027 ) OR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) AS DATETIME)) \u003E \u0027 \u002BCAST( @ScheduledHyperDelayThresholdMinutes  AS VARCHAR(MAX))\u002B\u0027)) THEN DR.Id ELSE NULL END AS HyperDelaye\r\n\tFROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\t\r\n\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = dp.Id \r\n\t\tAND pos.IsActive = 1\r\n  \tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.ID\r\n\tWHERE dr.DeliveryStartTime BETWEEN  \u0027 \u002BCAST(@TotalFrom AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027 \r\n\tAND [DispatchRequestStatusId] IN (30,35)\r\n\tAND  CourierRequestTypeId IN (5,10,15,26,30,35,40,45,50,55,60,65,70)\u0027\r\n\t\r\n\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @CustomerFilterType \u003E 0\r\n\tBEGIN\r\n\t\tIF @CustomerFilterType = 1\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\tIF @CustomerFilterType = 2\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\tIF @CustomerFilterType = 3\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\tIF @CustomerFilterType = 4\r\n\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\tEND\r\nSET @STR \u002B= \r\n\u0027 ) SQ\r\n\r\n\r\n \r\nSELECT  \r\n\r\n  CAST( SQ.BarIndex AS DATETIME)  as labels,\r\n    COUNT(SQ.Id) AS dataValues\r\n FROM  \r\n(  \r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n\tSELECT NULL Id, \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027 BarIndex\r\n\tUNION ALL\r\n    SELECT  \r\n        dr.Id,  \r\n        CASE  \r\n            WHEN dr.UpdateDate \u003C \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar1,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar1_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar2,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar2_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar3,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar3_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar4,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar4_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar5,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar5_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar6,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar6_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar7,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar7_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar8,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar8_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar9,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar9_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar10,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar10_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar11,121)\u002B\u0027\u0027\u0027\r\n            WHEN dr.UpdateDate BETWEEN \u0027\u002BCAST(@Bar11_BIGINT AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@Bar12_BIGINT AS VARCHAR(MAX))\u002B\u0027 THEN \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027\r\n            ELSE \u0027\u0027\u0027\u002BCONVERT(VARCHAR(MAX),@Bar12,121)\u002B\u0027\u0027\u0027  \r\n        END AS BarIndex\r\n            FROM CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)   \r\n            INNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)  \r\n                ON dr.PolygonStoreId = ps.ID  \r\n            INNER JOIN CS_Dispatcher.DP.Polygon p (NOLOCK)  \r\n                ON ps.PolygonId = p.ID  \r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\t\t\tON pos.PolygonId = P.Id\r\n\t\t\t\tAND pos.IsActive = 1 \r\n            INNER JOIN CS_Public.Haf.City c (NOLOCK)  \r\n                ON p.CityId = c.ID  \r\n            WHERE dr.UpdateDate BETWEEN    \u0027 \u002BCAST(@From AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@To AS VARCHAR(MAX))\u002B \u0027 \r\n            AND dr.[DispatchRequestStatusId] IN (30)  \r\n\t\t\tAND DR.CourierRequestTypeId IN (5,10,15)\u0027\r\n\r\n\t\t\tIF @CourierRequestTypeIds IS NOT NULL AND @CourierRequestTypeIds \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B @CourierRequestTypeIds \u002B\u0027)\u0027\r\n\r\n\t\t\tIF @DeliveryServiceProviderId IS NOT NULL AND @DeliveryServiceProviderId \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND dr.DeliveryServiceProviderId = \u0027\u002BCAST(@DeliveryServiceProviderId AS VARCHAR(MAX))\r\n\t\r\n\t\t\tIF @OperationStaffId IS NOT NULL AND @OperationStaffId \u003C\u003E 0\r\n\t\t\t\tSET @STR \u002B= \u0027 AND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\t\t\tIF @CustomerFilterType \u003E 0\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @CustomerFilterType = 1\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId NOT IN (37,726,41)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 2\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (37)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 3\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (726)\u0027\r\n\t\t\t\tIF @CustomerFilterType = 4\r\n\t\t\t\t\tSET @STR \u002B= \u0027 AND dr.VendorId IN (41)\u0027\r\n\t\t\tEND\r\nSET @STR \u002B=\r\n\u0027 ) SQ  \r\nGroup BY BarIndex  \r\nORDER BY BarIndex\u0027\r\n\r\nDECLARE @Param NVARCHAR(MAX) = \u0027\u0027\r\nSET @Param = \u0027 @countOfDelivered_DQE INT OUTPUT,@countOfDelayed_DQE INT OUTPUT,@countOfHyperDelaye_DQE INT OUTPUT\u0027\r\n\r\nEXECUTE sys.sp_executeSQL \r\n\t@STR,@Param, \r\n\t@countOfDelivered_DQE = @countOfDelivered OUTPUT,\r\n\t@countOfDelayed_DQE = @countOfDelayed OUTPUT ,\r\n\t@countOfHyperDelaye_DQE = @countOfHyperDelaye OUTPUT\r\n\r\n  SET  @title=N\u0027\u0628\u0631\u0645\u0628\u0646\u0627\u06CC SLA\u0027\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Store_DeliveryChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Store_DeliveryChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t\t @polygonId int ,  \r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t \t @countOfQueue INT OUTPUT,\r\n\t\t @countOfInProgress INT OUTPUT,\r\n\t\t @totalCount INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\nDROP TABLE IF EXISTS #CourierRequestTypeId\r\n\r\n\t\r\nSELECT crt.Id \r\n\tINTO #CourierRequestTypeId\r\nFROM CS_Public.PUB.CourierRequestType crt WITH(NOLOCK)\r\nINNER JOIN string_split(@CourierRequestTypeIds , \u0027,\u0027 ) ss\r\n\tON crt.Id = ss.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@End BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027235900000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\n\r\nSELECT\r\n    @title=N\u0027\u0633\u0641\u0627\u0631\u0634\u0627\u062A\u0027,\r\n\t@countOfQueue=ISNULL(COUNT([Queue]),0),\r\n\t@countOfInProgress=ISNULL(COUNT(InProgress),0),\r\n\t@totalCount=ISNULL(COUNT(Delivered),0) \r\nFROM\r\n(\r\n\tSELECT\r\n\t\tdr.Id,\r\n\t\tCASE WHEN dr.DispatchRequestStatusId IN ( 5,7 )   THEN DR.Id ELSE NULL END AS [Queue],\r\n\t\tCASE WHEN dr.DispatchRequestStatusId IN ( 10,15,20,25 ) THEN DR.Id ELSE NULL END AS InProgress,\r\n\t\tCASE WHEN dr.DispatchRequestStatusId IN ( 30,35 ) AND dr.CourierRequestTypeId IN ( 5,10,15 ) THEN DR.Id ELSE NULL END AS Delivered\r\n\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\t\tAND ps.IsActive = 1\r\n\tINNER JOIN Dp.Store s WITH(NOLOCK)\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN CS_UserManagement.UM.Vendor v WITH(NOLOCK)\r\n\t\tON s.VendorId = v.Id\r\n\tINNER JOIN CS_Public.HAF.City c WITH(NOLOCK)\r\n\t\tON s.CityId = c.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\tON ps.StoreId = stbi.StoreId\r\n\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\tLEFT JOIN DP.DispatchRequest drR WITH(NOLOCK)\r\n\t\tON dr.VendorId = drR.VendorId\r\n\t\tAND dr.VendorParcelCode = drR.VendorParcelCode\r\n\t\tAND drR.CourierRequestTypeId = 25\r\n\tWHERE ps.PolygonId = @PolygonId\r\n\tAND dr.DeliveryStartTime BETWEEN  @TotalFrom AND @End \r\n\tAND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n) SQ\r\nOPTION(RECOMPILE)\r\n\r\n \r\n        SELECT  \r\n            SQ.BarIndex  as labels,\r\n            COUNT(SQ.Id) AS dataValues\r\n        FROM  \r\n        (  \r\n\t\t\tSELECT NULL Id, @Bar1 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar2 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar3 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar4 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar5 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar6 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar7 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar8 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar9 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar10 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar11 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar12 BarIndex\r\n\t\t\tUNION ALL\r\n            SELECT  \r\n                dr.Id,  \r\n                CASE  \r\n                    WHEN dr.UpdateDate \u003C @Bar1_BIGINT THEN @Bar1  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar1_BIGINT AND @Bar2_BIGINT THEN @Bar2  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar2_BIGINT AND @Bar3_BIGINT THEN @Bar3  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar3_BIGINT AND @Bar4_BIGINT THEN @Bar4  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar4_BIGINT AND @Bar5_BIGINT THEN @Bar5  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar5_BIGINT AND @Bar6_BIGINT THEN @Bar6  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar6_BIGINT AND @Bar7_BIGINT THEN @Bar7  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar7_BIGINT AND @Bar8_BIGINT THEN @Bar8  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar8_BIGINT AND @Bar9_BIGINT THEN @Bar9  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar9_BIGINT AND @Bar10_BIGINT THEN @Bar10  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar10_BIGINT AND @Bar11_BIGINT THEN @Bar11  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar11_BIGINT AND @Bar12_BIGINT THEN @Bar12  \r\n                    ELSE @Bar12  \r\n\t\t\t\t\t\tEND AS BarIndex\r\n\t\t\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\t\t\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\t\t\tON dr.PolygonStoreId = ps.Id\r\n\t\t\t\tAND ps.IsActive = 1\r\n\t\t\tINNER JOIN Dp.Store s WITH(NOLOCK)\r\n\t\t\t\tON ps.StoreId = s.Id\r\n\t\t\tINNER JOIN CS_UserManagement.UM.Vendor v WITH(NOLOCK)\r\n\t\t\t\tON s.VendorId = v.Id\r\n\t\t\tINNER JOIN CS_Public.HAF.City c WITH(NOLOCK)\r\n\t\t\t\tON s.CityId = c.Id\r\n\t\t\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\t\t\tON ps.StoreId = stbi.StoreId\r\n\t\t\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\t\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\t\t\tLEFT JOIN DP.DispatchRequest drR WITH(NOLOCK)\r\n\t\t\t\tON dr.VendorId = drR.VendorId\r\n\t\t\t\tAND dr.VendorParcelCode = drR.VendorParcelCode\r\n\t\t\tWHERE ps.PolygonId = @PolygonId\r\n\t\t\t\tAND dr.UpdateDate BETWEEN  @From AND @To \r\n\t\t\t\tAND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n\t\t\t\tAND dr.DispatchRequestStatusId IN (30,35)\r\n\t\t\t\tAND DR.CourierRequestTypeId IN (5,15,10)\r\n        ) SQ  \r\n        Group BY BarIndex  \r\n        ORDER BY BarIndex \r\n\tOPTION(RECOMPILE)\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Store_ETAChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Store_ETAChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t\t @polygonId int ,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t\t @countOfDelayed INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\nDROP TABLE IF EXISTS #CourierRequestTypeId\r\n\r\n\t\r\nSELECT crt.Id \r\n\tINTO #CourierRequestTypeId\r\nFROM CS_Public.PUB.CourierRequestType crt WITH(NOLOCK)\r\nINNER JOIN string_split(@CourierRequestTypeIds , \u0027,\u0027 ) ss\r\n\tON crt.Id = ss.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@End BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027235900000\u0027 AS BIGINT);\r\n\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\n\r\nSELECT\r\n\r\n    @title=N\u0027\u0628\u0631\u0645\u0628\u0646\u0627\u06CC ETA\u0027,\r\n\t@countOfDelivered=ISNULL(COUNT(Delivered),0),\r\n\t@countOfDelayed=ISNULL(COUNT(Delayed),0)\r\nFROM\r\n(\r\n\tSELECT\r\n\t\tDR.Id,\r\n\t\tCASE WHEN ShipmentDestinationPointStatusId=25  THEN DR.Id ELSE NULL END AS Delayed,\r\n\t\tCASE WHEN ShipmentDestinationPointStatusId=20 THEN DR.Id ELSE NULL END AS Delivered\r\n\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\t\tAND ps.IsActive = 1\r\n\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\t\tON dr.Id = sdpdr.DispatchRequestId\r\n\t\tAND dr.Version = sdpdr.Version\r\n\tINNER JOIN DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\t--AND sdp.OperationTypeId = 5\r\n\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\tWHERE ps.PolygonId = @PolygonId\r\n\t\tAND dr.DeliveryStartTime BETWEEN  @TotalFrom AND @End \r\n\t\tAND dr.DispatchRequestStatusId IN ( 30,35 ) \r\n\t    AND sdp.OperationTypeId = 10\r\n\t    AND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n\r\n\r\n) SQ\r\nOPTION(RECOMPILE)\r\n\r\n \r\n        SELECT  \r\n            SQ.BarIndex  as labels,\r\n            COUNT(SQ.Id) AS dataValues\r\n        FROM  \r\n        (  \r\n\t\t\tSELECT NULL Id, @Bar1 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar2 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar3 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar4 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar5 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar6 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar7 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar8 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar9 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar10 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar11 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar12 BarIndex\r\n\t\t\tUNION ALL\r\n            SELECT  \r\n                dr.Id,  \r\n                CASE  \r\n                    WHEN dr.UpdateDate \u003C @Bar1_BIGINT THEN @Bar1  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar1_BIGINT AND @Bar2_BIGINT THEN @Bar2  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar2_BIGINT AND @Bar3_BIGINT THEN @Bar3  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar3_BIGINT AND @Bar4_BIGINT THEN @Bar4  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar4_BIGINT AND @Bar5_BIGINT THEN @Bar5  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar5_BIGINT AND @Bar6_BIGINT THEN @Bar6  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar6_BIGINT AND @Bar7_BIGINT THEN @Bar7  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar7_BIGINT AND @Bar8_BIGINT THEN @Bar8  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar8_BIGINT AND @Bar9_BIGINT THEN @Bar9  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar9_BIGINT AND @Bar10_BIGINT THEN @Bar10  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar10_BIGINT AND @Bar11_BIGINT THEN @Bar11  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar11_BIGINT AND @Bar12_BIGINT THEN @Bar12  \r\n                    ELSE @Bar12  \r\n                END AS BarIndex\r\n\t\t\t\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\t\t\t\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\t\t\t\tON dr.PolygonStoreId = ps.Id\r\n\t\t\t\t\tAND ps.IsActive = 1\r\n\t\t\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\t\t\t\t\tON dr.Id = sdpdr.DispatchRequestId\r\n\t\t\t\t\tAND dr.Version = sdpdr.Version\r\n\t\t\t\tINNER JOIN DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\t\t\t\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\t\t\t\t--AND sdp.OperationTypeId = 5\r\n\t\t\t\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\t\t\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\t\t\t\tWHERE ps.PolygonId = @PolygonId\r\n\t\t\t      AND ShipmentDestinationPointStatusId=20\r\n\t\t\t\t  \t\tAND dr.DispatchRequestStatusId IN ( 30 ) \r\n\t                    AND sdp.OperationTypeId = 10\r\n\t\t          AND dr.UpdateDate BETWEEN  @TotalFrom AND @To \r\n\t\t          AND (dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0)\r\n        ) SQ  \r\n        Group BY BarIndex  \r\n        ORDER BY BarIndex \r\n\tOPTION(RECOMPILE)\r\n\r\nEND\r\n"},{"Name":"Get_Dashboard_Store_SLAChart","Schema":"dbo","Definition":"\r\n\r\n\r\n-- =============================================\r\n-- Author:\t\t\u003CAuthor,,Name\u003E\r\n-- Create date: \u003CCreate Date,,\u003E\r\n-- Description:\t\u003CDescription,,\u003E\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Get_Dashboard_Store_SLAChart]\r\n\r\n\t \t @OperationStaffId\t \t \t int,\r\n\t \t --@StartRangeTime\t \t BIGINT,\r\n\t \t --@EndRangeTime\t \t BIGINT,\r\n\t\t @polygonId int ,\r\n\t \t @CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t \t @DeliveryServiceProviderId\t TinyInt = NULL,\r\n\t\t @CustomerFilterType TinyInt ,-- NVARCHAR(MAX),,\r\n\t \t @countOfDelayed INT OUTPUT,\r\n\t\t @countOfHyperDelaye INT OUTPUT,\r\n\t\t @countOfDelivered INT OUTPUT,\r\n\t\t @title NVARCHAR(20) OUTPUT\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\n\r\n\t DECLARE @MeanDeliveryTimeMinutes SMALLINT\r\n\t SELECT @MeanDeliveryTimeMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.MeanDeliveryTimeMinutes\u0027\r\n\r\n\t DECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t \t \t @ScheduledHyperDelayThresholdMinutes SMALLINT\r\n\t SELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\n\t SELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n\r\nSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\r\nDROP TABLE IF EXISTS #CourierRequestTypeId\r\n\r\n\t\r\nSELECT crt.Id \r\n\tINTO #CourierRequestTypeId\r\nFROM CS_Public.PUB.CourierRequestType crt WITH(NOLOCK)\r\nINNER JOIN string_split(@CourierRequestTypeIds , \u0027,\u0027 ) ss\r\n\tON crt.Id = ss.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\r\n\r\nDECLARE\r\n\t@Start DATE,\r\n\t@Start_Full DATETIME,\r\n\t@Now DATETIME,\r\n\t@Interval INT;\r\n\r\nDECLARE @From BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027073000000\u0027 AS BIGINT),\r\n\t\t@To BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMddHHmm\u0027)\u002B\u002700000\u0027 AS BIGINT),\r\n\t\t@TotalFrom BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 AS BIGINT),\r\n\t\t@End BIGINT = CAST(FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027235900000\u0027 AS BIGINT);\r\n\r\nSELECT @Now = GETDATE();\r\nSELECT @Start_Full = CAST(CONVERT(VARCHAR(MAX),@Now,23) \u002B \u0027 07:30:00.000\u0027 AS DATETIME);\r\nSELECT @Interval = CEILING( DATEDIFF(MINUTE,@Start_Full,@Now) / 11.0 );\r\n\r\nDECLARE @Bar1 DATETIME,\r\n\t\t@Bar2 DATETIME,\r\n\t\t@Bar3 DATETIME,\r\n\t\t@Bar4 DATETIME,\r\n\t\t@Bar5 DATETIME,\r\n\t\t@Bar6 DATETIME,\r\n\t\t@Bar7 DATETIME,\r\n\t\t@Bar8 DATETIME,\r\n\t\t@Bar9 DATETIME,\r\n\t\t@Bar10 DATETIME,\r\n\t\t@Bar11 DATETIME,\r\n\t\t@Bar12 DATETIME;\r\n\r\nDECLARE @Bar1_BIGINT BIGINT,\r\n\t\t@Bar2_BIGINT BIGINT,\r\n\t\t@Bar3_BIGINT BIGINT,\r\n\t\t@Bar4_BIGINT BIGINT,\r\n\t\t@Bar5_BIGINT BIGINT,\r\n\t\t@Bar6_BIGINT BIGINT,\r\n\t\t@Bar7_BIGINT BIGINT,\r\n\t\t@Bar8_BIGINT BIGINT,\r\n\t\t@Bar9_BIGINT BIGINT,\r\n\t\t@Bar10_BIGINT BIGINT,\r\n\t\t@Bar11_BIGINT BIGINT,\r\n\t\t@Bar12_BIGINT BIGINT;\r\n\r\nSELECT\t@Bar1 = @Start_Full,\r\n\t\t@Bar2 = DATEADD(MINUTE,@Interval,@Bar1),\r\n\t\t@Bar3 = DATEADD(MINUTE,@Interval,@Bar2),\r\n\t\t@Bar4 = DATEADD(MINUTE,@Interval,@Bar3),\r\n\t\t@Bar5 = DATEADD(MINUTE,@Interval,@Bar4),\r\n\t\t@Bar6 = DATEADD(MINUTE,@Interval,@Bar5),\r\n\t\t@Bar7 = DATEADD(MINUTE,@Interval,@Bar6),\r\n\t\t@Bar8 = DATEADD(MINUTE,@Interval,@Bar7),\r\n\t\t@Bar9 = DATEADD(MINUTE,@Interval,@Bar8),\r\n\t\t@Bar10 = DATEADD(MINUTE,@Interval,@Bar9),\r\n\t\t@Bar11 = DATEADD(MINUTE,@Interval,@Bar10),\r\n\t\t@Bar12 = DATEADD(MINUTE,@Interval,@Bar11);\r\n\r\nSELECT\r\n\t@Bar1_BIGINT = FORMAT(@Bar1,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar2_BIGINT = FORMAT(@Bar2,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar3_BIGINT = FORMAT(@Bar3,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar4_BIGINT = FORMAT(@Bar4,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar5_BIGINT = FORMAT(@Bar5,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar6_BIGINT = FORMAT(@Bar6,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar7_BIGINT = FORMAT(@Bar7,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar8_BIGINT = FORMAT(@Bar8,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar9_BIGINT = FORMAT(@Bar9,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar10_BIGINT = FORMAT(@Bar10,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar11_BIGINT = FORMAT(@Bar11,\u0027yyyyMMddHHmmssfff\u0027),\r\n\t@Bar12_BIGINT = FORMAT(@Bar12,\u0027yyyyMMddHHmmssfff\u0027);\r\n\r\n\r\n\r\nSELECT\r\n    @title=N\u0027\u0628\u0631\u0645\u0628\u0646\u0627\u06CC SLA\u0027,\r\n\t@countOfDelivered=ISNULL(COUNT(Delivered),0),\r\n\t@countOfDelayed=ISNULL(COUNT(Delayed),0),\r\n\t@countOfHyperDelaye=ISNULL(COUNT(HyperDelaye),0)\r\n\t\r\nFROM\r\n(\r\n\tSELECT\r\n\t\t DR.Id,\r\n\t\tCASE WHEN dr.[DispatchRequestStatusId] IN ( 30 ) THEN DR.Id ELSE NULL END AS Delivered,\r\n\t\tCASE WHEN dr.[DispatchRequestStatusId] IN ( 35 ) THEN DR.Id ELSE NULL END AS Delayed,\r\n\t\tCASE WHEN dr.[DispatchRequestStatusId] = 35  AND ((dr.CourierRequestTypeId IN ( 5,26,40,55,60  ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @OndemandHyperDelayThresholdMinutes) OR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70  ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @ScheduledHyperDelayThresholdMinutes)) THEN DR.Id ELSE NULL END AS HyperDelaye\r\n\t\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\t\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\t\tON dr.PolygonStoreId = ps.Id\r\n\t\t\tAND ps.IsActive = 1\r\n\t\tINNER JOIN Dp.Store s WITH(NOLOCK)\r\n\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor v WITH(NOLOCK)\r\n\t\t\tON s.VendorId = v.Id\r\n\t\tINNER JOIN CS_Public.HAF.City c WITH(NOLOCK)\r\n\t\t\tON s.CityId = c.Id\r\n\t\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\t\tON ps.StoreId = stbi.StoreId\r\n\t\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\t\tLEFT JOIN DP.DispatchRequest drR WITH(NOLOCK)\r\n\t\t\tON dr.VendorId = drR.VendorId\r\n\t\t\tAND dr.VendorParcelCode = drR.VendorParcelCode\r\n\t\t\tAND drR.CourierRequestTypeId = 25\r\n\t\tWHERE ps.PolygonId = @PolygonId\r\n\t    AND dr.DeliveryStartTime BETWEEN  @TotalFrom AND @End \r\n\t\tAND dr.CourierRequestTypeId IN ( 5,10,15 )\r\n\t    AND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n) SQ\r\nOPTION(RECOMPILE)\r\n\r\n \r\n        SELECT  \r\n            SQ.BarIndex  AS labels,\r\n            COUNT(SQ.Id) AS dataValues\r\n        FROM  \r\n        (  \t\r\n\t\t\tSELECT NULL Id, @Bar1 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar2 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar3 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar4 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar5 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar6 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar7 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar8 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar9 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar10 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar11 BarIndex\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT NULL Id, @Bar12 BarIndex\r\n\t\t\tUNION ALL\r\n            SELECT  \r\n                dr.Id,  \r\n                CASE  \r\n                    WHEN dr.UpdateDate \u003C @Bar1_BIGINT THEN @Bar1  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar1_BIGINT AND @Bar2_BIGINT THEN @Bar2  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar2_BIGINT AND @Bar3_BIGINT THEN @Bar3  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar3_BIGINT AND @Bar4_BIGINT THEN @Bar4  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar4_BIGINT AND @Bar5_BIGINT THEN @Bar5  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar5_BIGINT AND @Bar6_BIGINT THEN @Bar6  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar6_BIGINT AND @Bar7_BIGINT THEN @Bar7  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar7_BIGINT AND @Bar8_BIGINT THEN @Bar8  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar8_BIGINT AND @Bar9_BIGINT THEN @Bar9  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar9_BIGINT AND @Bar10_BIGINT THEN @Bar10  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar10_BIGINT AND @Bar11_BIGINT THEN @Bar11  \r\n                    WHEN dr.UpdateDate BETWEEN @Bar11_BIGINT AND @Bar12_BIGINT THEN @Bar12  \r\n                    ELSE @Bar12  \r\n                END AS BarIndex\r\n\t\t\t\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\t\t\t\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\t\t\t\tON dr.PolygonStoreId = ps.Id\r\n\t\t\t\t\tAND ps.IsActive = 1\r\n\t\t\t\tINNER JOIN Dp.Store s WITH(NOLOCK)\r\n\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\t\t\tINNER JOIN CS_UserManagement.UM.Vendor v WITH(NOLOCK)\r\n\t\t\t\t\tON s.VendorId = v.Id\r\n\t\t\t\tINNER JOIN CS_Public.HAF.City c WITH(NOLOCK)\r\n\t\t\t\t\tON s.CityId = c.Id\r\n\t\t\t\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\t\t\t\tON ps.StoreId = stbi.StoreId\r\n\t\t\t\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\t\t\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\t\t\t\tLEFT JOIN DP.DispatchRequest drR WITH(NOLOCK)\r\n\t\t\t\t\tON dr.VendorId = drR.VendorId\r\n\t\t\t\t\tAND dr.VendorParcelCode = drR.VendorParcelCode\r\n\t\t\t\t\tAND drR.CourierRequestTypeId = 25\r\n\t\t\t\tWHERE ps.PolygonId = @PolygonId\r\n\t\t\t\tAND  DR.[DispatchRequestStatusId] IN (30)\r\n\t\t\t\tAND dr.UpdateDate BETWEEN  @From AND @To \r\n\t\t\t\tAND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n        ) SQ  \r\n        Group BY BarIndex  \r\n        ORDER BY BarIndex \r\n\tOPTION(RECOMPILE)\r\n\r\nEND\r\n"},{"Name":"Get_DelayedDelivery_By_Filter","Schema":"dbo","Definition":"--############################################################################################################################################################################################################\r\n-- Stored Procedure\r\n\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/07/26\r\n--\tDescription:\tGet Returned List By Filter\r\n--\r\n--\t=======================================\r\n\r\n/*\r\n    DECLARE\t@return_value int,\r\n\t\t\t@UnassignedDispatchRequestCount int,\r\n\t\t\t@AssignedDispatchRequestCount int,\r\n\t\t\t@ReturnedRequestCount int,\r\n\t\t\t@DelayedPickupCount int,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount int,\r\n\t\t\t@TotalCount\tINT\r\n\r\n\tEXEC\t@return_value = [dbo].[Get_DelayedDelivery_By_Filter]\r\n\t\t\t@OrderBy = \u0027CreateDatePersianStr\u0027,\r\n\t\t\t@IsAsc = 0,\r\n\t\t\t@UnassignedDispatchRequestCount = @UnassignedDispatchRequestCount OUTPUT,\r\n\t\t\t@AssignedDispatchRequestCount = @AssignedDispatchRequestCount OUTPUT,\r\n\t\t\t@ReturnedRequestCount = @ReturnedRequestCount OUTPUT,\r\n\t\t\t@DelayedPickupCount = @DelayedPickupCount OUTPUT,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount = @UnassignedReturnAndReplacementRequestCount OUTPUT,\r\n\t\t\t@TotalCount = @TotalCount OUTPUT,\r\n\t\t\t@PageIndex = 0,\r\n\t\t\t@PageSize = 100,\r\n\t\t\t@OperationStaffId = 100\r\n\r\n\tSELECT\t@UnassignedDispatchRequestCount as N\u0027@UnassignedDispatchRequestCount\u0027,\r\n\t\t\t@AssignedDispatchRequestCount as N\u0027@AssignedDispatchRequestCount\u0027,\r\n\t\t\t@ReturnedRequestCount as N\u0027@ReturnedRequestCount\u0027,\r\n\t\t\t@DelayedPickupCount as N\u0027@DelayedPickupCount\u0027,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount as N\u0027@UnassignedReturnAndReplacementRequestCount\u0027,\r\n\t\t\t@TotalCount AS N\u0027@TotalCount\u0027\r\n*/\r\nCREATE  PROCEDURE [dbo].[Get_DelayedDelivery_By_Filter]\r\n\t    --@ProvinceId\tSMALLINT = NULL,\r\n\t\t@CityIds VARCHAR(MAX) = NULL,\r\n\t\t@PolygonIds VARCHAR(MAX) = NULL,\r\n\t\t@StoreIds VARCHAR(MAX) = NULL,\r\n\t\t@ParcelReferenceCode BIGINT = NULL,\r\n\t\t@CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n\t\t@StartDeliveryTime BIGINT = NULL,\r\n\t\t@EndDeliveryTime BIGINT = NULL,\r\n\t\t@VendorParcelCode VARCHAR(32) = NULL,\r\n\t\t@VendorId\t\tINT = NULL,\r\n\t\t@WarningToOperationOnDispatchRequestTimeMinutes SMALLINT = NULL,\t\t\r\n\t\t@FleetId INT = NULL,\r\n\t\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t\t@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX)\t= NULL,\r\n\t\t@OrderCategoryIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t\t@DispatchRequestStatusCategoryIds\t\tVARCHAR(MAX)\t\t= NULL,\r\n        @OrderBy NVARCHAR(200) = NULL,\r\n        @IsAsc BIT = NULL,\r\n\t\t@UnassignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@AssignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@ReturnedRequestCount INT = 0 OUTPUT,\r\n\t\t@DelayedPickupCount INT = 0 OUTPUT,\r\n\t\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t\t@NotPickUpRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t\t@OperationStaffId\t\t\t\t\t\tINT \r\nAS \r\n\tSET NOCOUNT ON\r\n    --############################################ Preparation Data ##################################\r\n\r\nDECLARE\r\n\t\t@CityIds_Local VARCHAR(MAX) = NULL,\r\n\t\t@PolygonIds_Local VARCHAR(MAX) = NULL,\r\n\t\t@StoreIds_Local VARCHAR(MAX) = NULL,\r\n\t\t@ParcelReferenceCode_Local BIGINT = NULL,\r\n\t\t@CourierRequestTypeIds_Local NVARCHAR(MAX) = NULL,\r\n\t\t@StartDeliveryTime_Local BIGINT = NULL,\r\n\t\t@EndDeliveryTime_Local BIGINT = NULL,\r\n\t\t@VendorParcelCode_Local VARCHAR(32) = NULL,\r\n\t\t@VendorId_Local\t\tINT = NULL,\r\n\t\t@WarningToOperationOnDispatchRequestTimeMinutes_Local SMALLINT = NULL,\t\t\r\n\t\t@FleetId_Local INT = NULL,\r\n\t\t@IsExclusiveDelivery_Local\t\t\t\t\t\tBIT = NULL,\r\n\t\t@IsNightly_Local\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t\t@DeliveryServiceProviderIds_Local\t\t\t\t\tVARCHAR(MAX)\t= NULL,\r\n        @OrderBy_Local NVARCHAR(200) = NULL,\r\n        @IsAsc_Local BIT = NULL,\r\n\t\t@OperationStaffId_Local\tINT,\r\n\t\t@OrderCategoryIds_Local\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL\r\n\r\n\tSET @IsExclusiveDelivery_Local = NULL\r\n\tSET @IsNightly_Local = NULL\r\n        drop table if EXISTS    #DispatchRequest,\r\n                                #Shipment,\r\n                                #Fleet,\r\n\t\t\t\t\t\t\t\t#FinalResult,\r\n\t\t\t\t\t\t\t\t#AllDispatchRequests\r\n        SELECT\r\n\t\t\t@CityIds_Local                                =ISNULL(@CityIds,\u00270\u0027),\r\n            @PolygonIds_Local\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),\r\n            @StoreIds_Local\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n            @ParcelReferenceCode_Local\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n            @CourierRequestTypeIds_Local                  =ISNULL(@CourierRequestTypeIds,\u00270\u0027),\r\n            @StartDeliveryTime_Local                      =ISNULL(@StartDeliveryTime,0),\r\n            @EndDeliveryTime_Local                        =ISNULL(@EndDeliveryTime,0),\r\n            @VendorParcelCode_Local\t\t\t\t\t    =ISNULL(@VendorParcelCode,\u00270\u0027),\r\n\t\t\t@fleetid_Local                                =ISNULL(@fleetid,0),\r\n\t\t\t@VendorID_Local                               =ISNULL(@VendorID,0),\r\n\t\t\t@WarningToOperationOnDispatchRequestTimeMinutes_Local = ISNULL(@WarningToOperationOnDispatchRequestTimeMinutes,0),\r\n\t\t\t@DeliveryServiceProviderIds_Local\t\t\t\t=ISNULL(@DeliveryServiceProviderIds,\u00270\u0027),\r\n\t\t\t@OrderBy_Local\t\t\t\t\t\t\t\t\t=ISNULL(@OrderBy,\u0027\u0027),\r\n\t\t\t@IsAsc_Local\t\t\t\t\t\t\t\t\t=ISNULL(@IsAsc,\u00270\u0027),\r\n\t\t\t@OperationStaffId_Local = @OperationStaffId,\r\n\t\t\t@OrderCategoryIds_Local = ISNULL(@OrderCategoryIds,\u00270\u0027),\r\n\t\t\t@DispatchRequestStatusCategoryIds = ISNULL(@DispatchRequestStatusCategoryIds,\u00270\u0027)\r\n\r\n\t\tIF @OrderBy_Local = \u0027DeliveryDeadLineTimeStr\u0027\r\n\t\t\tSET @OrderBy_Local = \u0027DeliveryDeadLineTimePersianStr\u0027\r\n\r\n\t\tIF @OrderBy_Local = \u0027CreateDateStr\u0027\r\n\t\t\tSET @OrderBy_Local = \u0027CreateDatePersianStr\u0027\r\n\r\n\t\tIF @OrderBy_Local = \u0027DeliveryStartTimeStr\u0027\r\n\t\t\tSET @OrderBy_Local = \u0027DeliveryStartTimePersianStr\u0027\r\n\r\n\t\tSELECT \r\n\t\t\tdsp.Id\r\n\t\tINTO #DeliveryServiceProviderId\r\n\t\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\t\tINNER JOIN string_split(@DeliveryServiceProviderIds_Local,\u0027,\u0027) ss\r\n\t\t\tON dsp.Id = ss.value\r\n\t\t\tOR @DeliveryServiceProviderIds_Local = \u00270\u0027\r\n\r\n\t\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t\t(\r\n\t\t\tId\r\n\t\t)\r\n\r\n\t\tDECLARE @CityId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CityId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CityIds_Local,\u0027,\u0027)\r\n\r\n        DECLARE @PolygonId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @PolygonId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@PolygonIds_Local,\u0027,\u0027)\r\n\r\n        DECLARE @StoreId TABLE\r\n\t\t(\r\n\t\t\tId INT\r\n\t\t)\r\n\t\tINSERT INTO @StoreId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS INT)\r\n\t\tFROM string_split(@StoreIds_Local,\u0027,\u0027)\r\n\r\n\t\tDECLARE @CourierRequestTypeId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CourierRequestTypeId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CourierRequestTypeIds_Local,\u0027,\u0027)\r\n\r\n\t\tSELECT\r\n\t\t\toc.Id\r\n\t\tINTO #OrderCategoryId\r\n\t\tFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tINNER JOIN string_split(@OrderCategoryIds_Local,\u0027,\u0027) ss\r\n\t\t\tON oc.Id = ss.value\r\n\t\t\tOR @OrderCategoryIds_Local = \u00270\u0027\r\n\r\n\t\tSELECT\r\n\t\t\tdrsc.Id\r\n\t\tINTO #DispatchRequestStatusCategoryId\r\n\t\tFROM DP.DispatchRequestStatusCategory drsc (NOLOCK)\r\n\t\tINNER JOIN string_split(@DispatchRequestStatusCategoryIds,\u0027,\u0027) ss\r\n\t\t\tON drsc.Id = ss.value\r\n\t\t\tOR @DispatchRequestStatusCategoryIds = \u00270\u0027\r\n\r\n\t\tDECLARE @Today INT,@Yesterday int\r\n\t\tSELECT @Today = CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\t\tselect @Yesterday = CAST(SUBSTRING(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT)\r\n\r\n\t\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\r\n\t\t/*\r\n\t\tDROP TABLE IF EXISTS #AllDispatchRequests\r\n\t\tCREATE TABLE #AllDispatchRequests\r\n\t\t(\r\n\t\t\tDispatchRequestId BIGINT NOT NULL,\r\n\t\t\tParcelReferenceCode BIGINT NOT NULL,\r\n\t\t\tDispatchRequestStatusId TINYINT NOT NULL,\r\n\t\t\tDispatchRequestStatusTitle NVARCHAR(128) NOT NULL,\r\n\t\t\tCourierRequestTypeId TINYINT NOT NULL,\r\n\t\t\tDeliveryStartTime BIGINT NOT NULL,\r\n\t\t\t--DeliveryStartTime_Date BIGINT NOT NULL,\r\n\t\t\tPolygonStoreId INT NOT NULL,\r\n\t\t\tPolygonId SMALLINT NOT NULL,\r\n\t\t\tPolygonTitle NVARCHAR(128) NOT NULL,\r\n\t\t\tStoreId INT NOT NULL,\r\n\t\t\tStoreTitle NVARCHAR(64) NOT NULL,\r\n\t\t\tStoreLocation Geometry,\r\n\t\t\tClientLocation Geometry,\r\n\t\t\tCityId SMALLINT NOT NULL,\r\n\t\t\tVendorParcelCode VARCHAR(32) NOT NULL,\r\n\t\t\tDeliveryDeadLineTime BIGINT NOT NULL,\r\n\t\t\tDeliveryStartTimePersian BIGINT NOT NULL, \r\n\t\t\tDeliveryDeadLineTimePersian BIGINT NOT NULL,\r\n\t\t\tClientAddress NVARCHAR(512) NULL,\r\n\t\t\tAssignmentTryCount INT NULL,\r\n\t\t\tCreateDate BIGINT NOT NULL,\r\n            CreateDatePersian BIGINT NOT NULL,\r\n            VendorId INT NOT NULL\r\n\t\t)\r\n\t\tINSERT INTO #AllDispatchRequests\r\n\t\t(\r\n\t\t\tDispatchRequestId ,\r\n\t\t\tParcelReferenceCode ,\r\n\t\t\tDispatchRequestStatusId ,\r\n\t\t\tDispatchRequestStatusTitle ,\r\n\t\t\tCourierRequestTypeId ,\r\n\t\t\tDeliveryStartTime ,\r\n\t\t\t--DeliveryStartTime_Date BIGINT NOT NULL,\r\n\t\t\tPolygonStoreId ,\r\n\t\t\tPolygonId ,\r\n\t\t\tPolygonTitle ,\r\n\t\t\tStoreId ,\r\n\t\t\tStoreTitle ,\r\n\t\t\tStoreLocation,\r\n\t\t\tClientLocation,\r\n\t\t\tCityId ,\r\n\t\t\tVendorParcelCode ,\r\n\t\t\tDeliveryDeadLineTime ,\r\n\t\t\tDeliveryStartTimePersian ,\r\n\t\t\tDeliveryDeadLineTimePersian ,\r\n\t\t\tClientAddress ,\r\n\t\t\tAssignmentTryCount ,\r\n\t\t\tCreateDate ,\r\n            CreateDatePersian ,\r\n            VendorId \r\n\t\t)\r\n\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\tdrs.title\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\tddr.DeliveryStartTime,\r\n\t\t\t\t--LEFT(DeliveryStartTime,8)\tDeliveryStartTime_Date,\r\n\t\t\t\tddr.PolygonStoreId,\r\n\t\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\t\tps.StoreId,\r\n\t\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\r\n\t\t\t\ts.Location\t\t\t\t\tStoreLocation,\r\n\t\t\t\tddr.ClientLocation\t\t\tClientLocation,\r\n\r\n\t\t\t\tdp.CityId,\r\n\t\t\t\tddr.VendorParcelCode,\r\n\r\n\t\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\t\tddr.DeliveryStartTimePersian, \r\n\t\t\t\tddr.DeliveryDeadLineTimePersian,\r\n\t\t\t\tddr.ClientAddress,\r\n\t\t\t\tddr.AssignmentTryCount,\r\n\t\t\t\tddr.CreateDate,\r\n                ddr.CreateDatePersian,\r\n                s.VendorId\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\tAND (dp.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\t\tOPTION(RECOMPILE)\r\n\r\n\t\tCREATE NONCLUSTERED INDEX IX_#AllDispatchRequests\r\n\t\tON #AllDispatchRequests ([DispatchRequestStatusId],DeliveryStartTime)\r\n\t\tINCLUDE ([ParcelReferenceCode],[CourierRequestTypeId],[PolygonStoreId],[DeliveryDeadLineTime])\r\n\t\t*/\r\n\t--SET @NotPickupRequestCount = NULL\r\n\t--SET @DelayedPickupCount = NULL\r\n\t--SET @ReturnedRequestCount = NULL\r\n\t--SET @AssignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedReturnAndReplacementRequestCount = NULL\r\n\r\n\t--EXEC Get_OperationPanel_Count\r\n\t--\t@OperationStaffId = @OperationStaffId,\r\n\t--\t@CityIds = @CityIds,\r\n\t--\t@PolygonIds = @PolygonIds,\r\n\t--\t@VendorID = @VendorID,\r\n\t--\t@UnassignedDispatchRequestCount\t\t\t\t = @UnassignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t@AssignedDispatchRequestCount\t\t\t\t = @AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t@ReturnedRequestCount\t\t\t\t\t\t = @ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t@UnassignedReturnAndReplacementRequestCount  = @UnassignedReturnAndReplacementRequestCount\tOUTPUT,\r\n\t--\t@NotPickupRequestCount\t\t\t\t\t\t = @NotPickupRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t@DelayedPickupCount\t\t\t\t\t\t\t = @DelayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = ISNULL(@UnassignedDispatchRequestCount,0),\t\t\t\r\n\t--\t@AssignedDispatchRequestCount = ISNULL(@AssignedDispatchRequestCount,0),\t\t\t\t\r\n\t--\t@ReturnedRequestCount = ISNULL(@ReturnedRequestCount,0),\t\t\t\t\t\t\t\t\t\t\r\n\t--\t@UnassignedReturnAndReplacementRequestCount = ISNULL(@UnassignedReturnAndReplacementRequestCount,0),\t\r\n\t--\t@NotPickupRequestCount = ISNULL(@NotPickupRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@DelayedPickupCount = ISNULL(@DelayedPickupCount,0)\t\t\r\n\t\t; WITH CTE_DR AS \r\n\t\t(\r\n\t\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\t\tddr.DeliveryStartTime,\r\n\t\t\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\t\t\tddr.IsWaitingForSupport\r\n\t\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\t\t\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\t\t\tON ps.StoreId = s.Id\r\n\t\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\t\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\t\tAND (dp.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds_Local=\u00270\u0027)\r\n\t\t\tand (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds_Local=\u00270\u0027)\r\n\t\t\tAND (pos.OperationStaffId = @OperationStaffId_Local)\r\n\t\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery_Local OR @IsExclusiveDelivery_Local IS NULL )\r\n\t\t\tAND ( ddr.IsNightly = @IsNightly_Local OR @IsNightly_Local IS NULL )\r\n\t\t\tAND ( ddr.VendorId = @VendorId_Local OR @VendorId_Local = 0)\r\n\t\t\t\r\n\t\t)\r\n\t\tSELECT \r\n\t\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT SQ.UnassignedDispatchRequestCount),\r\n\t\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT SQ.AssignedDispatchRequestCount),\r\n\t\t\t@ReturnedRequestCount = COUNT(DISTINCT SQ.ReturnedRequestCount),\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT SQ.UnassignedReturnAndReplacementRequestCount),\r\n\t\t\t@DelayedPickupCount = COUNT(DISTINCT SQ.DelayedPickupCount),\r\n\t\t\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (5,6,7)  AND LEFT(DeliveryStartTime,8) IN(@Today,@Yesterday) --= @Today\r\n\t\t\t\t\tTHEN dr.DispatchRequestId \r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS UnassignedDispatchRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS AssignedDispatchRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t(DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n\t\t\t\t\t\t\tOR\r\n\t\t\t\t\t\t\t(DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\n\t\t\t\t\t\t\tAND dr.DeliveryDeadLineTime \u003E=@ToDate) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS ReturnedRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN \r\n\t\t\t\t\t\tdr.DispatchRequestStatusId = 5\r\n\t\t\t\t\t\tAND dr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70)\r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t\r\n\t\t\t\tNULL AS DelayedPickupCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN \r\n\t\t\t\t\t\tdr.IsWaitingForSupport = 1 \r\n\t\t\t\t\t\tAND dr.DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS NotPickupRequestCount\r\n\t\t\t\r\n\t\t\tFROM CTE_DR dr\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT\r\n\t\t\tNULL AS UnassignedDispatchRequestCount,\r\n\t\t\tNULL AS AssignedDispatchRequestCount,\r\n\t\t\tNULL AS ReturnedRequestCount,\r\n\t\t\tNULL AS UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE \r\n\t\t\t\t\tWHEN sdp.ID IS NOT NULL \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS DelayedPickupCount,\r\n\t\t\tNULL AS NotPickupRequestCount\r\n\t\t\tFROM CTE_DR dr\r\n\t\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId AND dr.DispatchRequestStatusId in (10,11,15,16)\r\n\t\t\tINNER JOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId AND sdp.OperationTypeId = 5 AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= getdate() \r\n\t\t) SQ\r\n\t\tOPTION(RECOMPILE)--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t\t\r\n\r\n\t\t/*\r\n\t\tCREATE NONCLUSTERED INDEX IX_#AllDispatchRequests\r\n\t\tON #AllDispatchRequests ([DispatchRequestStatusId],DeliveryStartTime)\r\n\t\tINCLUDE ([ParcelReferenceCode],[CourierRequestTypeId],[PolygonStoreId],[DeliveryDeadLineTime])\r\n\t\t----------------------------------------------------\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (5,6)\r\n\t\t\t  AND LEFT(DeliveryStartTime,8) = @Today\r\n----------------------------------------------------------------------------------------\r\n\t\tSELECT \r\n\t\t\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54)\r\n\t\t\t  --AND dr.DeliveryStartTime_Date = @Today\r\n/********************************************************/\r\n\t\tSELECT @ReturnedRequestCount=COUNT( dr.ParcelReferenceCode)\r\n\tFROM #AllDispatchRequests dr\r\n        join dp.DispatchRequestStatus drs (NOLOCK)  on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps (NOLOCK)  on dr.PolygonStoreId = ps.Id\r\n        join dp.Polygon p1 (NOLOCK)  on ps.PolygonId = p1.Id\r\n        --INNER JOIN @PolygonId p2\tON p1.Id = p2.Id\r\n        --JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        join dp.Store s (NOLOCK)  on ps.StoreId = s.Id\r\n\r\n        where (\r\n                (DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n                OR\r\n                (DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\nAND dr.DeliveryDeadLineTime \u003E=@ToDate)\r\n/*********************************************************/\r\n/*\r\n\t\tSELECT\r\n\t\t\t\t@ReturnedRequestCount = COUNT(dr.DispatchRequestId)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE ((sdp.OperationTypeId in (15))/*Return*/ or (OperationTypeId = 10 and DispatchRequestStatusId in (45,46)))\r\n\t\tAND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t\t--AND getdate() \u003E DATEADD(SECOND,sdp.EstimatedDurationSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\t*/\r\n\t/*****************************************************************************/\r\n\t\tSELECT\r\n\t\t\t\t@DelayedPickupCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE dr.DispatchRequestStatusId in (10,11,15,16)\r\n\t--\tAND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30\r\n\r\n\t\tAND sdp.OperationTypeId = 5\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\t\t/*********************************UnassignedReturnAndReplacementRequestCount**********************************************************/\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId = 5\r\n\t\tAND dr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70)\r\n\t\t*/\r\n    --############################################ Pre Calculate Result ##############################################\r\n      \r\n-----------------------------------------------------------------------\r\n\r\n\t\t; WITH CTE_DR AS\r\n\t\t\r\n\t\t(\r\n\t\t\tSELECT\tddr.Id ,\r\n\t\t\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\t\t\tdrs.title\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\t\t\tddr.DeliveryStartTime,\r\n\t\t\t\t\t\t--LEFT(DeliveryStartTime,8)\tDeliveryStartTime_Date,\r\n\t\t\t\t\t\tddr.PolygonStoreId,\r\n\t\t\t\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\t\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\t\t\t\tps.StoreId,\r\n\t\t\t\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\r\n\t\t\t\t\t\ts.Location\t\t\t\t\tStoreLocation,\r\n\t\t\t\t\t\tddr.ClientLocation\t\t\tClientLocation,\r\n\r\n\t\t\t\t\t\tdp.CityId,\r\n\t\t\t\t\t\tddr.VendorParcelCode,\r\n\r\n\t\t\t\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\t\t\t\tddr.DeliveryStartTimePersian, \r\n\t\t\t\t\t\tddr.DeliveryDeadLineTimePersian,\r\n\t\t\t\t\t\tddr.ClientAddress,\r\n\t\t\t\t\t\tddr.AssignmentTryCount,\r\n\t\t\t\t\t\tddr.CreateDate,\r\n\t\t\t\t\t\tddr.CreateDatePersian,\r\n\t\t\t\t\t\tddr.VendorId,\r\n\t\t\t\t\t\tddr.IsExclusiveDelivery,\r\n\t\t\t\t\t\tddr.IsNightly,\r\n\t\t\t\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\t\t\t\ts.orderCategoryId,\r\n\t\t\t\t\t\toc.Title AS orderCategoryTitle,\r\n\t\t\t\t\t\tddr.Version\r\n\t\t\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\t\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\t\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\t\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\t\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\t\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\t\t\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\t\t\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\t\t\t\tON s.OrderCategoryId = oc.Id\r\n\t\t\t\tINNER JOIN #DispatchRequestStatusCategoryId drsc\r\n\t\t\t\t\tON drs.DispatchRequestStatusCategoryId = drsc.Id\r\n\t\t\t\t where DispatchRequestStatusId in (20,25)\r\n\t\t\t\tand ((ddr.DeliveryStartTime BETWEEN @StartDeliveryTime_Local and @EndDeliveryTime_Local or ddr.DeliveryDeadLineTime BETWEEN @StartDeliveryTime_Local and @EndDeliveryTime_Local) or @StartDeliveryTime_Local = 0 or @EndDeliveryTime_Local = 0)\r\n\t\t\t\tand ((ps.StoreId IN (Select Id from @StoreId)) OR (@StoreIds_Local=\u00270\u0027))\r\n\t\t\t\tand (ps.PolygonId IN (SELECT Id FROM @PolygonId) OR @PolygonIds_Local=\u00270\u0027)\r\n\t\t\t\tand ((ddr.CourierRequestTypeId in (Select Id from @CourierRequestTypeId)) OR (@CourierRequestTypeIds_Local = \u00270\u0027))\r\n\t\t\t\tand (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds_Local=\u00270\u0027)\r\n\t\t\t\tand (ddr.ParcelReferenceCode = @ParcelReferenceCode_Local OR @ParcelReferenceCode_Local = 0)\r\n\t\t\t\tand (ddr.VendorParcelCode = @VendorParcelCode_Local or @VendorParcelCode_Local = \u00270\u0027)\r\n\t\t\t\tAND (pos.OperationStaffId = @OperationStaffId_Local)\r\n\t\t\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery_Local OR @IsExclusiveDelivery_Local IS NULL )\r\n\t\t\t\tAND ( ddr.IsNightly = @IsNightly_Local OR @IsNightly_Local IS NULL )\r\n\t\t\t\tAND ( ddr.VendorId = @VendorId_Local OR @VendorId_Local = 0)\r\n\t\t),CTE_Shipment AS \r\n\t\t(\r\n\t\t\tSELECT * FROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\t\t\ts.Id,\r\n\t\t\t\t\t\t\ts.ShipmentStatusId as StatusId,\r\n\t\t\t\t\t\t\tss.Title as StatusTitle,\r\n\t\t\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\t\t\ts.FleetId,\r\n\t\t\t\t\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\t\t\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\t\t\t\t\tdr.Id as DispatchRequestId,\r\n\t\t\t\t\t\t\tDATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) AS ETA,\r\n\t\t\t\t\t\t\t\t(SELECT\r\n                    \r\n\t\t\t\t\t\t\tDATEDIFF(second,(DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))),GETDATE())                                           \r\n\t\t\t\t\t\t\t\t\t\t\t\t)\t\t\t\t\r\n\t\t\t\t\t\t\t as FleetDelayTime,\r\n\t\t\t\t\t\t\t ROW_NUMBER() over (partition by dr.id order by dr.id,sdp.id desc) RowNum\r\n\t\t\t\tFROM CTE_DR dr\r\n\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest s3 (NOLOCK)  on dr.id = s3.DispatchRequestId\r\n\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)   on sdp.id = s3.ShipmentDestinationPointId and OperationTypeId IN(10)\r\n\t\t\t\t\tINNER join dp.Shipment s (NOLOCK)  on s.id = sdp.ShipmentId\r\n\t\t\t\t\tINNER join dp.ShipmentStatus ss (NOLOCK)  on s.ShipmentStatusId = ss.Id      \r\n\t\t\t) SQ\r\n\t\t\tWHERE SQ.RowNum = 1\r\n\t\t),CTE_Fleet AS\r\n\t\t(\r\n\r\n\t\tselect \r\n                    f.Id,\r\n                    DriverId,\r\n                    FirstName \u002B \u0027 \u0027 \u002B LastName as DriverName,\r\n                    \u00270\u0027\u002BCAST(d.Mobile AS VARCHAR(20))  as DriverMobile,\r\n                    v.VehicleTypeId,\r\n                    v.PlateNumber,\r\n                    s.Id as ShipmentId,\r\n                    s.DispatchRequestId\r\n\r\n\r\n        from CTE_Shipment s\r\n        join CS_DriverManagement.DM.Fleet f (NOLOCK)  on s.FleetId = f.Id\r\n        join CS_DriverManagement.DM.Driver d (NOLOCK)  on f.DriverId = d.Id\r\n        join CS_DriverManagement.DM.Vehicle v (NOLOCK)  on f.VehicleId = v.Id\r\n\t\tWHERE ((f.Id=@FleetId_Local)OR(@FleetId_Local=0))\r\n\t\t),CTE_DSPRM AS\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tdsprm.DispatchRequestId,\r\n\t\t\t\t\tdsprm.DeliveryServiceProviderOrderId\r\n\t\t\t\tFROM DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\t\t\t\tINNER JOIN CTE_DR dr\r\n\t\t\t\t\tON dsprm.DispatchRequestId = dr.Id\r\n\t\t\t\tWHERE dsprm.IsActive = 1\r\n\t\t\t)\r\n    --############################################ Calculate Result ##############################################\r\n        select Distinct\r\n                    dr.Id DispatchRequestId,\r\n                    dr.DispatchRequestStatusId,\r\n                    drs.Title as DispatchRequestStatusTitle,\r\n                    dr.ParcelReferenceCode,\r\n                    dr.CourierRequestTypeId,\r\n                    dr.CityId,\r\n                    dr.PolygonId,\r\n                    dr.PolygonTitle,\r\n                    dr.StoreId,\r\n                    dr.StoreLocation.STY StoreLocationLatitude,\r\n\t\t\t\t\tdr.StoreLocation.STX StoreLocationLongitude,\r\n                    [dr].[StoreTitle],\r\n                    [dr].[DeliveryStartTime],\r\n                    [dr].[DeliveryStartTimePersian],\r\n                    [dr].[DeliveryDeadLineTime],\r\n                    [dr].[DeliveryDeadLineTimePersian],\r\n                    [dr].[ClientAddress],\r\n                    dr.ClientLocation.STY [ClientLocationLatitude],\r\n\t\t\t\t\tdr.ClientLocation.STX ClientLocationLongitude,\r\n                    [dr].AssignmentTryCount [FleetPreAssignmentStateCount],\r\n                    s.[FleetDelayTime],\r\n                    [dr].[VendorParcelCode],\r\n                    dr.CreateDate,\r\n                    [dr].[CreateDatePersian],\r\n                    VendorId,\r\n\r\n                    [s].[Id] as ShipmentId,\r\n                    [s].[StatusId] as ShipmentStatusId,\r\n                    [s].[StatusTitle] as ShipmentStatusTitle,\r\n                    [s].[ShipmentNumber],\r\n\r\n                    [f].[Id] FleetId,\r\n                    [f].[DriverId],\r\n                    [f].[DriverName],\r\n                    [f].[DriverMobile],\r\n                    [f].[VehicleTypeId],\r\n                    [f].[PlateNumber],\r\n\t\t\t\t\tEstimatedOperationTimeSeconds,\r\n\t\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\t\t\tdsprm.DeliveryServiceProviderOrderId,\r\n\t\t\t\t\tdr.orderCategoryId,\r\n\t\t\t\t\tdr.orderCategoryTitle,\r\n\t\t\t\t\tdr.Version,\r\n\t\t\t\t\ts.ETA\r\n\r\n        INTO #FinalResult\r\n\t\tFROM CTE_DR dr\r\n         JOIN CTE_Shipment s on dr.Id = s.DispatchRequestId\r\n         JOIN CTE_Fleet f on s.DispatchRequestId = f.DispatchRequestId and s.Id = f.ShipmentId\r\n\t\t INNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON dr.DispatchRequestStatusId = drs.Id\r\n\t\t LEFT JOIN CTE_DSPRM dsprm\r\n\t\t\tON dr.Id = dsprm.DispatchRequestId\r\n        where FleetDelayTime \u003E 0\r\n\t\tOPTION(RECOMPILE)\r\n\t\tSET @TotalCount = @@ROWCOUNT\r\n\r\n\t\tSELECT \r\n\t\t\tDispatchRequestId\t\t\t\t,\r\n\t\t\tDispatchRequestStatusId\t\t\t,\r\n\t\t\tDispatchRequestStatusTitle\t\t,\r\n\t\t\tParcelReferenceCode\t\t\t\t,\r\n\t\t\tCourierRequestTypeId\t\t\t,\r\n\t\t\tCityId\t\t\t\t\t\t\t,\r\n\t\t\tPolygonId\t\t\t\t\t\t,\r\n\t\t\tPolygonTitle\t\t\t\t\t,\r\n\t\t\tStoreId\t\t\t\t\t\t\t,\r\n            StoreLocationLatitude,\r\n            StoreLocationLongitude,\r\n\t\t\tStoreTitle\t\t\t\t\t\t,\r\n            FORMAT([DeliveryStartTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryStartTimeStr,\r\n            FORMAT([DeliveryStartTimePersian],\u0027####/##/## ##:##:##\\.###\u0027)DeliveryStartTimePersianStr,\r\n            FORMAT([DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryDeadLineTimeStr,\r\n            FORMAT([DeliveryDeadLineTimePersian],\u0027####/##/## ##:##:##\\.###\u0027) DeliveryDeadLineTimePersianStr,\r\n\t\t\tClientAddress\t\t\t\t\t,\r\n            [ClientLocationLatitude],\r\n            ClientLocationLongitude,\r\n\t\t\tFleetPreAssignmentStateCount\t,\r\n\t\t\tFleetDelayTime\t\t\t\t\t,\r\n\t\t\tVendorParcelCode\t\t\t\t,\r\n\t\t\tCreateDate\t\t\t\t\t\t,\r\n\t\t\tFORMAT([CreateDatePersian],\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersianStr,\r\n\t\t\tVendorId\t\t\t\t\t\t,\r\n\t\t\tShipmentId\t\t\t\t\t\t,\r\n\t\t\tShipmentStatusId\t\t\t\t,\r\n\t\t\tShipmentStatusTitle\t\t\t\t,\r\n\t\t\tShipmentNumber\t\t\t\t\t,\r\n\t\t\tFleetId\t\t\t\t\t\t\t,\r\n\t\t\tDriverId\t\t\t\t\t\t,\r\n\t\t\tDriverName\t\t\t\t\t\t,\r\n\t\t\tDriverMobile\t\t\t\t\t,\r\n\t\t\tVehicleTypeId\t\t\t\t\t,\r\n\t\t\tPlateNumber\t\t\t\t\t\t,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t\tGETDATE() BETWEEN\r\n\t\t\t\t\tDATEADD(MINUTE,-1*@WarningToOperationOnDispatchRequestTimeMinutes_Local,CAST(CONVERT(varchar, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\tAND\r\n\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds\u002B@WarningToOperationOnDispatchRequestTimeMinutes_Local*60,CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\tTHEN 1\r\n\t\t\t\tWHEN GETDATE()\u003EDATEADD(MINUTE,@WarningToOperationOnDispatchRequestTimeMinutes_Local,CAST(CONVERT(varchar, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\tTHEN 2\r\n\t\t\t\tELSE 0\r\n\t\t\tEND DeliveryStatus,\r\n\t\t\tIsExclusiveDelivery,\r\n\t\t\tIsNightly,\r\n\t\t\tDeliveryServiceProviderId,\r\n\t\t\tDeliveryServiceProviderOrderId,\r\n\t\t\tfr.orderCategoryId,\r\n\t\t\tfr.orderCategoryTitle,\r\n\t\t\tFORMAT(fr.ETA,\u0027yyyy/MM/dd HH:mm:ss\u0027,\u0027fa\u0027) ETA,\r\n\t\t\tfr.Version,\r\n\t\t\tdrsh.TimeIntervalChangeStatus\r\n\r\n\t\tFROM #FinalResult AS fr\r\n\t\tOUTER APPLY \r\n\t\t(\r\n\t\t\tSELECT TOP 1 WITH TIES\r\n\t\t\t\tDATEDIFF(SECOND,CAST(CONVERT(varchar, FORMAT(drsh.CreateDate,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME),GETDATE()) TimeIntervalChangeStatus\r\n\t\t\tFROM DP.DispatchRequestStatusHistory drsh WITH(NOLOCK)\r\n\t\t\tWHERE drsh.DispatchRequestId = fr.DispatchRequestId\r\n\t\t\tORDER BY ROW_NUMBER() OVER ( ORDER BY CreateDate DESC , ID DESC )\r\n\t\t) DRSH\r\n        ORDER BY \r\n\t\tCASE WHEN @OrderBy_Local IS NULL OR @OrderBy_Local = \u0027\u0027\r\n\t\t\tTHEN drsh.TimeIntervalChangeStatus \r\n\t\tEND DESC,\r\n\t\tCASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027timeIntervalChangeStatus\u0027 AND @IsAsc_Local = 1 THEN TimeIntervalChangeStatus\r\n        End ASC,\r\n        CASE\r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027timeIntervalChangeStatus\u0027 AND @IsAsc_Local = 0 THEN TimeIntervalChangeStatus\r\n        End DESC,\r\n\t\tCASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027DeliveryDeadLineTimePersianStr\u0027 AND @IsAsc_Local = 1 THEN [DeliveryDeadLineTimePersian]\r\n        End ASC,\r\n        CASE\r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027DeliveryDeadLineTimePersianStr\u0027 AND @IsAsc_Local = 0 THEN [DeliveryDeadLineTimePersian]\r\n        End DESC,\r\n\t\tCASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027CreateDatePersianStr\u0027 AND @IsAsc_Local = 1 THEN [CreateDatePersian]\r\n        End ASC,\r\n        CASE\r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027CreateDatePersianStr\u0027 AND @IsAsc_Local = 0 THEN [CreateDatePersian]\r\n        End DESC,\r\n\t\tCASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027FleetDelayTime\u0027 AND @IsAsc_Local = 1 THEN FleetDelayTime\r\n\t\tEnd ASC,\r\n\t\tCASE\r\n\t\t\tWHEN (@OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027FleetDelayTime\u0027 AND @IsAsc_Local = 0) THEN FleetDelayTime\r\n\t\tEnd DESC,\r\n        CASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027ETA\u0027 AND @IsAsc_Local = 1 THEN ETA\r\n        End ASC,\r\n        CASE\r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027ETA\u0027 AND @IsAsc_Local = 0 THEN ETA\r\n        End DESC,\r\n\t\tCASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027DeliveryStartTimePersianStr\u0027 AND @IsAsc_Local = 1 THEN DeliveryStartTimePersian\r\n        End ASC,\r\n        CASE\r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027DeliveryStartTimePersianStr\u0027 AND @IsAsc_Local = 0 THEN DeliveryStartTimePersian\r\n        End DESC,\r\n\t\tCASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027TimeIntervalChangeStatus\u0027 AND @IsAsc_Local = 1 THEN TimeIntervalChangeStatus\r\n        End ASC,\r\n        CASE\r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027TimeIntervalChangeStatus\u0027 AND @IsAsc_Local = 0 THEN TimeIntervalChangeStatus\r\n        End DESC/*,\r\n\t\tCASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027FleetDelayTime\u0027 AND @IsAsc_Local = 1 THEN FleetDelayTime\r\n\t\tEnd ASC,\r\n\t\tCASE\r\n\t\t\tWHEN (@OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027FleetDelayTime\u0027 AND @IsAsc_Local = 0) OR (@OrderBy_Local IS NULL OR @OrderBy_Local = \u00270\u0027) THEN FleetDelayTime\r\n\t\tEnd DESC*/\r\n\t\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\r\n\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n"},{"Name":"Get_DelayedDelivery_By_Filter_BACKUP","Schema":"dbo","Definition":"--############################################################################################################################################################################################################\r\n-- Stored Procedure\r\n\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/07/26\r\n--\tDescription:\tGet Returned List By Filter\r\n--\r\n--\t=======================================\r\n\r\n/*\r\n    DECLARE\t@return_value int,\r\n\t\t\t@UnassignedDispatchRequestCount int,\r\n\t\t\t@AssignedDispatchRequestCount int,\r\n\t\t\t@ReturnedRequestCount int,\r\n\t\t\t@DelayedPickupCount int,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount int,\r\n\t\t\t@TotalCount\tINT\r\n\r\n\tEXEC\t@return_value = [dbo].[Get_DelayedDelivery_By_Filter]\r\n\t\t\t@OrderBy = \u0027CreateDatePersianStr\u0027,\r\n\t\t\t@IsAsc = 0,\r\n\t\t\t@UnassignedDispatchRequestCount = @UnassignedDispatchRequestCount OUTPUT,\r\n\t\t\t@AssignedDispatchRequestCount = @AssignedDispatchRequestCount OUTPUT,\r\n\t\t\t@ReturnedRequestCount = @ReturnedRequestCount OUTPUT,\r\n\t\t\t@DelayedPickupCount = @DelayedPickupCount OUTPUT,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount = @UnassignedReturnAndReplacementRequestCount OUTPUT,\r\n\t\t\t@TotalCount = @TotalCount OUTPUT,\r\n\t\t\t@PageIndex = 0,\r\n\t\t\t@PageSize = 100,\r\n\t\t\t@OperationStaffId = 100\r\n\r\n\tSELECT\t@UnassignedDispatchRequestCount as N\u0027@UnassignedDispatchRequestCount\u0027,\r\n\t\t\t@AssignedDispatchRequestCount as N\u0027@AssignedDispatchRequestCount\u0027,\r\n\t\t\t@ReturnedRequestCount as N\u0027@ReturnedRequestCount\u0027,\r\n\t\t\t@DelayedPickupCount as N\u0027@DelayedPickupCount\u0027,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount as N\u0027@UnassignedReturnAndReplacementRequestCount\u0027,\r\n\t\t\t@TotalCount AS N\u0027@TotalCount\u0027\r\n*/\r\nCREATE  PROCEDURE [dbo].[Get_DelayedDelivery_By_Filter_BACKUP]\r\n\t    --@ProvinceId\tSMALLINT = NULL,\r\n\t\t@CityIds VARCHAR(MAX) = NULL,\r\n\t\t@PolygonIds VARCHAR(MAX) = NULL,\r\n\t\t@StoreIds VARCHAR(MAX) = NULL,\r\n\t\t@ParcelReferenceCode BIGINT = NULL,\r\n\t\t@CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n\t\t@StartDeliveryTime BIGINT = NULL,\r\n\t\t@EndDeliveryTime BIGINT = NULL,\r\n\t\t@VendorParcelCode VARCHAR(32) = NULL,\r\n\t\t@VendorId\t\tINT = NULL,\r\n\t\t@WarningToOperationOnDispatchRequestTimeMinutes SMALLINT = NULL,\t\t\r\n\t\t@FleetId INT = NULL,\r\n\t\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t\t@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX)\t= NULL,\r\n\t\t@OrderCategoryIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n        @OrderBy NVARCHAR(200) = NULL,\r\n        @IsAsc BIT = NULL,\r\n\t\t@UnassignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@AssignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@ReturnedRequestCount INT = 0 OUTPUT,\r\n\t\t@DelayedPickupCount INT = 0 OUTPUT,\r\n\t\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t\t@NotPickUpRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t\t@OperationStaffId\t\t\t\t\t\tINT \r\nAS \r\n\tSET NOCOUNT ON\r\n    --############################################ Preparation Data ##################################\r\n\r\nDECLARE\r\n\t\t@CityIds_Local VARCHAR(MAX) = NULL,\r\n\t\t@PolygonIds_Local VARCHAR(MAX) = NULL,\r\n\t\t@StoreIds_Local VARCHAR(MAX) = NULL,\r\n\t\t@ParcelReferenceCode_Local BIGINT = NULL,\r\n\t\t@CourierRequestTypeIds_Local NVARCHAR(MAX) = NULL,\r\n\t\t@StartDeliveryTime_Local BIGINT = NULL,\r\n\t\t@EndDeliveryTime_Local BIGINT = NULL,\r\n\t\t@VendorParcelCode_Local VARCHAR(32) = NULL,\r\n\t\t@VendorId_Local\t\tINT = NULL,\r\n\t\t@WarningToOperationOnDispatchRequestTimeMinutes_Local SMALLINT = NULL,\t\t\r\n\t\t@FleetId_Local INT = NULL,\r\n\t\t@IsExclusiveDelivery_Local\t\t\t\t\t\tBIT = NULL,\r\n\t\t@IsNightly_Local\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t\t@DeliveryServiceProviderIds_Local\t\t\t\t\tVARCHAR(MAX)\t= NULL,\r\n        @OrderBy_Local NVARCHAR(200) = NULL,\r\n        @IsAsc_Local BIT = NULL,\r\n\t\t@OperationStaffId_Local\tINT,\r\n\t\t@OrderCategoryIds_Local\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL\r\n\t\t\r\n\tSET @IsExclusiveDelivery_Local = NULL\r\n\tSET @IsNightly_Local = NULL\r\n        drop table if EXISTS    #DispatchRequest,\r\n                                #Shipment,\r\n                                #Fleet,\r\n\t\t\t\t\t\t\t\t#FinalResult,\r\n\t\t\t\t\t\t\t\t#AllDispatchRequests\r\n        SELECT\r\n\t\t\t@CityIds_Local                                =ISNULL(@CityIds,\u00270\u0027),\r\n            @PolygonIds_Local\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),\r\n            @StoreIds_Local\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n            @ParcelReferenceCode_Local\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n            @CourierRequestTypeIds_Local                  =ISNULL(@CourierRequestTypeIds,\u00270\u0027),\r\n            @StartDeliveryTime_Local                      =ISNULL(@StartDeliveryTime,0),\r\n            @EndDeliveryTime_Local                        =ISNULL(@EndDeliveryTime,0),\r\n            @VendorParcelCode_Local\t\t\t\t\t    =ISNULL(@VendorParcelCode,\u00270\u0027),\r\n\t\t\t@fleetid_Local                                =ISNULL(@fleetid,0),\r\n\t\t\t@VendorID_Local                               =ISNULL(@VendorID,0),\r\n\t\t\t@WarningToOperationOnDispatchRequestTimeMinutes_Local = ISNULL(@WarningToOperationOnDispatchRequestTimeMinutes,0),\r\n\t\t\t@DeliveryServiceProviderIds_Local\t\t\t\t=ISNULL(@DeliveryServiceProviderIds,\u00270\u0027),\r\n\t\t\t@OrderBy_Local\t\t\t\t\t\t\t\t\t=ISNULL(@OrderBy,\u00270\u0027),\r\n\t\t\t@IsAsc_Local\t\t\t\t\t\t\t\t\t=ISNULL(@IsAsc,\u00270\u0027),\r\n\t\t\t@OperationStaffId_Local = @OperationStaffId,\r\n\t\t\t@OrderCategoryIds_Local = ISNULL(@OrderCategoryIds,\u00270\u0027)\r\n\r\n\t\tSELECT \r\n\t\t\tdsp.Id\r\n\t\tINTO #DeliveryServiceProviderId\r\n\t\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\t\tINNER JOIN string_split(@DeliveryServiceProviderIds_Local,\u0027,\u0027) ss\r\n\t\t\tON dsp.Id = ss.value\r\n\t\t\tOR @DeliveryServiceProviderIds_Local = \u00270\u0027\r\n\r\n\t\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t\t(\r\n\t\t\tId\r\n\t\t)\r\n\r\n\t\tDECLARE @CityId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CityId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CityIds_Local,\u0027,\u0027)\r\n\r\n        DECLARE @PolygonId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @PolygonId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@PolygonIds_Local,\u0027,\u0027)\r\n\r\n        DECLARE @StoreId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @StoreId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@StoreIds_Local,\u0027,\u0027)\r\n\r\n\t\tDECLARE @CourierRequestTypeId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CourierRequestTypeId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CourierRequestTypeIds_Local,\u0027,\u0027)\r\n\r\n\t\tSELECT\r\n\t\t\toc.Id\r\n\t\tINTO #OrderCategoryId\r\n\t\tFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tINNER JOIN string_split(@OrderCategoryIds_Local,\u0027,\u0027) ss\r\n\t\t\tON oc.Id = ss.value\r\n\t\t\tOR @OrderCategoryIds_Local = \u00270\u0027\r\n\r\n\t\tDECLARE @Today INT,@Yesterday int\r\n\t\tSELECT @Today = CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\t\tselect @Yesterday = CAST(SUBSTRING(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT)\r\n\r\n\t\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\r\n\t\t/*\r\n\t\tDROP TABLE IF EXISTS #AllDispatchRequests\r\n\t\tCREATE TABLE #AllDispatchRequests\r\n\t\t(\r\n\t\t\tDispatchRequestId BIGINT NOT NULL,\r\n\t\t\tParcelReferenceCode BIGINT NOT NULL,\r\n\t\t\tDispatchRequestStatusId TINYINT NOT NULL,\r\n\t\t\tDispatchRequestStatusTitle NVARCHAR(128) NOT NULL,\r\n\t\t\tCourierRequestTypeId TINYINT NOT NULL,\r\n\t\t\tDeliveryStartTime BIGINT NOT NULL,\r\n\t\t\t--DeliveryStartTime_Date BIGINT NOT NULL,\r\n\t\t\tPolygonStoreId INT NOT NULL,\r\n\t\t\tPolygonId SMALLINT NOT NULL,\r\n\t\t\tPolygonTitle NVARCHAR(128) NOT NULL,\r\n\t\t\tStoreId INT NOT NULL,\r\n\t\t\tStoreTitle NVARCHAR(64) NOT NULL,\r\n\t\t\tStoreLocation Geometry,\r\n\t\t\tClientLocation Geometry,\r\n\t\t\tCityId SMALLINT NOT NULL,\r\n\t\t\tVendorParcelCode VARCHAR(32) NOT NULL,\r\n\t\t\tDeliveryDeadLineTime BIGINT NOT NULL,\r\n\t\t\tDeliveryStartTimePersian BIGINT NOT NULL, \r\n\t\t\tDeliveryDeadLineTimePersian BIGINT NOT NULL,\r\n\t\t\tClientAddress NVARCHAR(512) NULL,\r\n\t\t\tAssignmentTryCount INT NULL,\r\n\t\t\tCreateDate BIGINT NOT NULL,\r\n            CreateDatePersian BIGINT NOT NULL,\r\n            VendorId INT NOT NULL\r\n\t\t)\r\n\t\tINSERT INTO #AllDispatchRequests\r\n\t\t(\r\n\t\t\tDispatchRequestId ,\r\n\t\t\tParcelReferenceCode ,\r\n\t\t\tDispatchRequestStatusId ,\r\n\t\t\tDispatchRequestStatusTitle ,\r\n\t\t\tCourierRequestTypeId ,\r\n\t\t\tDeliveryStartTime ,\r\n\t\t\t--DeliveryStartTime_Date BIGINT NOT NULL,\r\n\t\t\tPolygonStoreId ,\r\n\t\t\tPolygonId ,\r\n\t\t\tPolygonTitle ,\r\n\t\t\tStoreId ,\r\n\t\t\tStoreTitle ,\r\n\t\t\tStoreLocation,\r\n\t\t\tClientLocation,\r\n\t\t\tCityId ,\r\n\t\t\tVendorParcelCode ,\r\n\t\t\tDeliveryDeadLineTime ,\r\n\t\t\tDeliveryStartTimePersian ,\r\n\t\t\tDeliveryDeadLineTimePersian ,\r\n\t\t\tClientAddress ,\r\n\t\t\tAssignmentTryCount ,\r\n\t\t\tCreateDate ,\r\n            CreateDatePersian ,\r\n            VendorId \r\n\t\t)\r\n\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\tdrs.title\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\tddr.DeliveryStartTime,\r\n\t\t\t\t--LEFT(DeliveryStartTime,8)\tDeliveryStartTime_Date,\r\n\t\t\t\tddr.PolygonStoreId,\r\n\t\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\t\tps.StoreId,\r\n\t\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\r\n\t\t\t\ts.Location\t\t\t\t\tStoreLocation,\r\n\t\t\t\tddr.ClientLocation\t\t\tClientLocation,\r\n\r\n\t\t\t\tdp.CityId,\r\n\t\t\t\tddr.VendorParcelCode,\r\n\r\n\t\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\t\tddr.DeliveryStartTimePersian, \r\n\t\t\t\tddr.DeliveryDeadLineTimePersian,\r\n\t\t\t\tddr.ClientAddress,\r\n\t\t\t\tddr.AssignmentTryCount,\r\n\t\t\t\tddr.CreateDate,\r\n                ddr.CreateDatePersian,\r\n                s.VendorId\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\tAND (dp.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\t\tOPTION(RECOMPILE)\r\n\r\n\t\tCREATE NONCLUSTERED INDEX IX_#AllDispatchRequests\r\n\t\tON #AllDispatchRequests ([DispatchRequestStatusId],DeliveryStartTime)\r\n\t\tINCLUDE ([ParcelReferenceCode],[CourierRequestTypeId],[PolygonStoreId],[DeliveryDeadLineTime])\r\n\t\t*/\r\n\t--SET @NotPickupRequestCount = NULL\r\n\t--SET @DelayedPickupCount = NULL\r\n\t--SET @ReturnedRequestCount = NULL\r\n\t--SET @AssignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedReturnAndReplacementRequestCount = NULL\r\n\r\n\t--EXEC Get_OperationPanel_Count\r\n\t--\t@OperationStaffId = @OperationStaffId,\r\n\t--\t@CityIds = @CityIds,\r\n\t--\t@PolygonIds = @PolygonIds,\r\n\t--\t@VendorID = @VendorID,\r\n\t--\t@UnassignedDispatchRequestCount\t\t\t\t = @UnassignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t@AssignedDispatchRequestCount\t\t\t\t = @AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t@ReturnedRequestCount\t\t\t\t\t\t = @ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t@UnassignedReturnAndReplacementRequestCount  = @UnassignedReturnAndReplacementRequestCount\tOUTPUT,\r\n\t--\t@NotPickupRequestCount\t\t\t\t\t\t = @NotPickupRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t@DelayedPickupCount\t\t\t\t\t\t\t = @DelayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = ISNULL(@UnassignedDispatchRequestCount,0),\t\t\t\r\n\t--\t@AssignedDispatchRequestCount = ISNULL(@AssignedDispatchRequestCount,0),\t\t\t\t\r\n\t--\t@ReturnedRequestCount = ISNULL(@ReturnedRequestCount,0),\t\t\t\t\t\t\t\t\t\t\r\n\t--\t@UnassignedReturnAndReplacementRequestCount = ISNULL(@UnassignedReturnAndReplacementRequestCount,0),\t\r\n\t--\t@NotPickupRequestCount = ISNULL(@NotPickupRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@DelayedPickupCount = ISNULL(@DelayedPickupCount,0)\t\t\r\n\t\t; WITH CTE_DR AS \r\n\t\t(\r\n\t\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\t\tddr.DeliveryStartTime,\r\n\t\t\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\t\t\tddr.IsWaitingForSupport\r\n\t\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\t\t\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\t\t\tON ps.StoreId = s.Id\r\n\t\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\t\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\t\tAND (dp.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds_Local=\u00270\u0027)\r\n\t\t\tand (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds_Local=\u00270\u0027)\r\n\t\t\tAND (pos.OperationStaffId = @OperationStaffId_Local)\r\n\t\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery_Local OR @IsExclusiveDelivery_Local IS NULL )\r\n\t\t\tAND ( ddr.IsNightly = @IsNightly_Local OR @IsNightly_Local IS NULL )\r\n\t\t\tAND ( ddr.VendorId = @VendorId_Local OR @VendorId_Local = 0)\r\n\t\t\t\r\n\t\t)\r\n\t\tSELECT \r\n\t\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT SQ.UnassignedDispatchRequestCount),\r\n\t\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT SQ.AssignedDispatchRequestCount),\r\n\t\t\t@ReturnedRequestCount = COUNT(DISTINCT SQ.ReturnedRequestCount),\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT SQ.UnassignedReturnAndReplacementRequestCount),\r\n\t\t\t@DelayedPickupCount = COUNT(DISTINCT SQ.DelayedPickupCount),\r\n\t\t\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (5,6,7)  AND LEFT(DeliveryStartTime,8) IN(@Today,@Yesterday) --= @Today\r\n\t\t\t\t\tTHEN dr.DispatchRequestId \r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS UnassignedDispatchRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS AssignedDispatchRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t(DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n\t\t\t\t\t\t\tOR\r\n\t\t\t\t\t\t\t(DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\n\t\t\t\t\t\t\tAND dr.DeliveryDeadLineTime \u003E=@ToDate) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS ReturnedRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN \r\n\t\t\t\t\t\tdr.DispatchRequestStatusId = 5\r\n\t\t\t\t\t\tAND dr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70)\r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t\r\n\t\t\t\tNULL AS DelayedPickupCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN \r\n\t\t\t\t\t\tdr.IsWaitingForSupport = 1 \r\n\t\t\t\t\t\tAND dr.DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS NotPickupRequestCount\r\n\t\t\t\r\n\t\t\tFROM CTE_DR dr\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT\r\n\t\t\tNULL AS UnassignedDispatchRequestCount,\r\n\t\t\tNULL AS AssignedDispatchRequestCount,\r\n\t\t\tNULL AS ReturnedRequestCount,\r\n\t\t\tNULL AS UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE \r\n\t\t\t\t\tWHEN sdp.ID IS NOT NULL \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS DelayedPickupCount,\r\n\t\t\tNULL AS NotPickupRequestCount\r\n\t\t\tFROM CTE_DR dr\r\n\t\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId AND dr.DispatchRequestStatusId in (10,11,15,16)\r\n\t\t\tINNER JOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId AND sdp.OperationTypeId = 5 AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= getdate() \r\n\t\t) SQ\r\n\t\tOPTION(RECOMPILE)--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t\t\r\n\r\n\t\t/*\r\n\t\tCREATE NONCLUSTERED INDEX IX_#AllDispatchRequests\r\n\t\tON #AllDispatchRequests ([DispatchRequestStatusId],DeliveryStartTime)\r\n\t\tINCLUDE ([ParcelReferenceCode],[CourierRequestTypeId],[PolygonStoreId],[DeliveryDeadLineTime])\r\n\t\t----------------------------------------------------\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (5,6)\r\n\t\t\t  AND LEFT(DeliveryStartTime,8) = @Today\r\n----------------------------------------------------------------------------------------\r\n\t\tSELECT \r\n\t\t\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54)\r\n\t\t\t  --AND dr.DeliveryStartTime_Date = @Today\r\n/********************************************************/\r\n\t\tSELECT @ReturnedRequestCount=COUNT( dr.ParcelReferenceCode)\r\n\tFROM #AllDispatchRequests dr\r\n        join dp.DispatchRequestStatus drs (NOLOCK)  on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps (NOLOCK)  on dr.PolygonStoreId = ps.Id\r\n        join dp.Polygon p1 (NOLOCK)  on ps.PolygonId = p1.Id\r\n        --INNER JOIN @PolygonId p2\tON p1.Id = p2.Id\r\n        --JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        join dp.Store s (NOLOCK)  on ps.StoreId = s.Id\r\n\r\n        where (\r\n                (DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n                OR\r\n                (DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\nAND dr.DeliveryDeadLineTime \u003E=@ToDate)\r\n/*********************************************************/\r\n/*\r\n\t\tSELECT\r\n\t\t\t\t@ReturnedRequestCount = COUNT(dr.DispatchRequestId)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE ((sdp.OperationTypeId in (15))/*Return*/ or (OperationTypeId = 10 and DispatchRequestStatusId in (45,46)))\r\n\t\tAND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t\t--AND getdate() \u003E DATEADD(SECOND,sdp.EstimatedDurationSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\t*/\r\n\t/*****************************************************************************/\r\n\t\tSELECT\r\n\t\t\t\t@DelayedPickupCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE dr.DispatchRequestStatusId in (10,11,15,16)\r\n\t--\tAND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30\r\n\r\n\t\tAND sdp.OperationTypeId = 5\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\t\t/*********************************UnassignedReturnAndReplacementRequestCount**********************************************************/\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId = 5\r\n\t\tAND dr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70)\r\n\t\t*/\r\n    --############################################ Pre Calculate Result ##############################################\r\n      \r\n-----------------------------------------------------------------------\r\n\r\n\t\t; WITH CTE_DR AS\r\n\t\t\r\n\t\t(\r\n\t\t\tSELECT\tddr.Id ,\r\n\t\t\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\t\t\tdrs.title\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\t\t\tddr.DeliveryStartTime,\r\n\t\t\t\t\t\t--LEFT(DeliveryStartTime,8)\tDeliveryStartTime_Date,\r\n\t\t\t\t\t\tddr.PolygonStoreId,\r\n\t\t\t\t\t\tdp.Id\t\t\t\t\t\tPolygonId,\r\n\t\t\t\t\t\tdp.Title\t\t\t\t\tPolygonTitle,\r\n\t\t\t\t\t\tps.StoreId,\r\n\t\t\t\t\t\ts.title\t\t\t\t\t\tStoreTitle,\r\n\r\n\t\t\t\t\t\ts.Location\t\t\t\t\tStoreLocation,\r\n\t\t\t\t\t\tddr.ClientLocation\t\t\tClientLocation,\r\n\r\n\t\t\t\t\t\tdp.CityId,\r\n\t\t\t\t\t\tddr.VendorParcelCode,\r\n\r\n\t\t\t\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\t\t\t\tddr.DeliveryStartTimePersian, \r\n\t\t\t\t\t\tddr.DeliveryDeadLineTimePersian,\r\n\t\t\t\t\t\tddr.ClientAddress,\r\n\t\t\t\t\t\tddr.AssignmentTryCount,\r\n\t\t\t\t\t\tddr.CreateDate,\r\n\t\t\t\t\t\tddr.CreateDatePersian,\r\n\t\t\t\t\t\tddr.VendorId,\r\n\t\t\t\t\t\tddr.IsExclusiveDelivery,\r\n\t\t\t\t\t\tddr.IsNightly,\r\n\t\t\t\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\t\t\t\ts.orderCategoryId,\r\n\t\t\t\t\t\toc.Title AS orderCategoryTitle,\r\n\t\t\t\t\t\tddr.Version\r\n\t\t\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\t\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\t\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\t\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\t\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\t\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\t\t\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\t\t\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\t\t\t\tON s.OrderCategoryId = oc.Id\r\n\t\t\t\t where DispatchRequestStatusId in (20,25)\r\n\t\t\t\tand ((ddr.DeliveryStartTime BETWEEN @StartDeliveryTime_Local and @EndDeliveryTime_Local or ddr.DeliveryDeadLineTime BETWEEN @StartDeliveryTime_Local and @EndDeliveryTime_Local) or @StartDeliveryTime_Local = 0 or @EndDeliveryTime_Local = 0)\r\n\t\t\t\tand ((ps.StoreId IN (Select Id from @StoreId)) OR (@StoreIds_Local=\u00270\u0027))\r\n\t\t\t\tand (ps.PolygonId IN (SELECT Id FROM @PolygonId) OR @PolygonIds_Local=\u00270\u0027)\r\n\t\t\t\tand ((ddr.CourierRequestTypeId in (Select Id from @CourierRequestTypeId)) OR (@CourierRequestTypeIds_Local = \u00270\u0027))\r\n\t\t\t\tand (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds_Local=\u00270\u0027)\r\n\t\t\t\tand (ddr.ParcelReferenceCode = @ParcelReferenceCode_Local OR @ParcelReferenceCode_Local = 0)\r\n\t\t\t\tand (ddr.VendorParcelCode = @VendorParcelCode_Local or @VendorParcelCode_Local = \u00270\u0027)\r\n\t\t\t\tAND (pos.OperationStaffId = @OperationStaffId_Local)\r\n\t\t\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery_Local OR @IsExclusiveDelivery_Local IS NULL )\r\n\t\t\t\tAND ( ddr.IsNightly = @IsNightly_Local OR @IsNightly_Local IS NULL )\r\n\t\t\t\tAND ( ddr.VendorId = @VendorId_Local OR @VendorId_Local = 0)\r\n\t\t),CTE_Shipment AS \r\n\t\t(\r\n\t\t\tSELECT * FROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\t\t\ts.Id,\r\n\t\t\t\t\t\t\ts.ShipmentStatusId as StatusId,\r\n\t\t\t\t\t\t\tss.Title as StatusTitle,\r\n\t\t\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\t\t\ts.FleetId,\r\n\t\t\t\t\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\t\t\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\t\t\t\t\tdr.Id as DispatchRequestId,\r\n\t\t\t\t\t\t\tDATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) AS ETA,\r\n\t\t\t\t\t\t\t\t(SELECT\r\n                    \r\n\t\t\t\t\t\t\tDATEDIFF(second,(DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))),GETDATE())                                           \r\n\t\t\t\t\t\t\t\t\t\t\t\t)\t\t\t\t\r\n\t\t\t\t\t\t\t as FleetDelayTime,\r\n\t\t\t\t\t\t\t ROW_NUMBER() over (partition by dr.id order by dr.id,sdp.id desc) RowNum\r\n\t\t\t\tFROM CTE_DR dr\r\n\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest s3 (NOLOCK)  on dr.id = s3.DispatchRequestId\r\n\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)   on sdp.id = s3.ShipmentDestinationPointId and OperationTypeId IN(10)\r\n\t\t\t\t\tINNER join dp.Shipment s (NOLOCK)  on s.id = sdp.ShipmentId\r\n\t\t\t\t\tINNER join dp.ShipmentStatus ss (NOLOCK)  on s.ShipmentStatusId = ss.Id      \r\n\t\t\t) SQ\r\n\t\t\tWHERE SQ.RowNum = 1\r\n\t\t),CTE_Fleet AS\r\n\t\t(\r\n\r\n\t\tselect \r\n                    f.Id,\r\n                    DriverId,\r\n                    FirstName \u002B \u0027 \u0027 \u002B LastName as DriverName,\r\n                    \u00270\u0027\u002BCAST(d.Mobile AS VARCHAR(20))  as DriverMobile,\r\n                    v.VehicleTypeId,\r\n                    v.PlateNumber,\r\n                    s.Id as ShipmentId,\r\n                    s.DispatchRequestId\r\n\r\n\r\n        from CTE_Shipment s\r\n        join CS_DriverManagement.DM.Fleet f (NOLOCK)  on s.FleetId = f.Id\r\n        join CS_DriverManagement.DM.Driver d (NOLOCK)  on f.DriverId = d.Id\r\n        join CS_DriverManagement.DM.Vehicle v (NOLOCK)  on f.VehicleId = v.Id\r\n\t\tWHERE ((f.Id=@FleetId_Local)OR(@FleetId_Local=0))\r\n\t\t),CTE_DSPRM AS\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tdsprm.DispatchRequestId,\r\n\t\t\t\t\tdsprm.DeliveryServiceProviderOrderId\r\n\t\t\t\tFROM DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\t\t\t\tINNER JOIN CTE_DR dr\r\n\t\t\t\t\tON dsprm.DispatchRequestId = dr.Id\r\n\t\t\t\tWHERE dsprm.IsActive = 1\r\n\t\t\t)\r\n    --############################################ Calculate Result ##############################################\r\n        select Distinct\r\n                    dr.Id DispatchRequestId,\r\n                    dr.DispatchRequestStatusId,\r\n                    drs.Title as DispatchRequestStatusTitle,\r\n                    dr.ParcelReferenceCode,\r\n                    dr.CourierRequestTypeId,\r\n                    dr.CityId,\r\n                    dr.PolygonId,\r\n                    dr.PolygonTitle,\r\n                    dr.StoreId,\r\n                    dr.StoreLocation.STY StoreLocationLatitude,\r\n\t\t\t\t\tdr.StoreLocation.STX StoreLocationLongitude,\r\n                    [dr].[StoreTitle],\r\n                    [dr].[DeliveryStartTime],\r\n                    [dr].[DeliveryStartTimePersian],\r\n                    [dr].[DeliveryDeadLineTime],\r\n                    [dr].[DeliveryDeadLineTimePersian],\r\n                    [dr].[ClientAddress],\r\n                    dr.ClientLocation.STY [ClientLocationLatitude],\r\n\t\t\t\t\tdr.ClientLocation.STX ClientLocationLongitude,\r\n                    [dr].AssignmentTryCount [FleetPreAssignmentStateCount],\r\n                    s.[FleetDelayTime],\r\n                    [dr].[VendorParcelCode],\r\n                    dr.CreateDate,\r\n                    [dr].[CreateDatePersian],\r\n                    VendorId,\r\n\r\n                    [s].[Id] as ShipmentId,\r\n                    [s].[StatusId] as ShipmentStatusId,\r\n                    [s].[StatusTitle] as ShipmentStatusTitle,\r\n                    [s].[ShipmentNumber],\r\n\r\n                    [f].[Id] FleetId,\r\n                    [f].[DriverId],\r\n                    [f].[DriverName],\r\n                    [f].[DriverMobile],\r\n                    [f].[VehicleTypeId],\r\n                    [f].[PlateNumber],\r\n\t\t\t\t\tEstimatedOperationTimeSeconds,\r\n\t\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\t\t\tdsprm.DeliveryServiceProviderOrderId,\r\n\t\t\t\t\tdr.orderCategoryId,\r\n\t\t\t\t\tdr.orderCategoryTitle,\r\n\t\t\t\t\tdr.Version,\r\n\t\t\t\t\ts.ETA\r\n\r\n        INTO #FinalResult\r\n\t\tFROM CTE_DR dr\r\n         JOIN CTE_Shipment s on dr.Id = s.DispatchRequestId\r\n         JOIN CTE_Fleet f on s.DispatchRequestId = f.DispatchRequestId and s.Id = f.ShipmentId\r\n\t\t INNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON dr.DispatchRequestStatusId = drs.Id\r\n\t\t LEFT JOIN CTE_DSPRM dsprm\r\n\t\t\tON dr.Id = dsprm.DispatchRequestId\r\n        where FleetDelayTime \u003E 0\r\n\t\tOPTION(RECOMPILE)\r\n\t\tSET @TotalCount = @@ROWCOUNT\r\n\r\n\t\tSELECT \r\n\t\t\tDispatchRequestId\t\t\t\t,\r\n\t\t\tDispatchRequestStatusId\t\t\t,\r\n\t\t\tDispatchRequestStatusTitle\t\t,\r\n\t\t\tParcelReferenceCode\t\t\t\t,\r\n\t\t\tCourierRequestTypeId\t\t\t,\r\n\t\t\tCityId\t\t\t\t\t\t\t,\r\n\t\t\tPolygonId\t\t\t\t\t\t,\r\n\t\t\tPolygonTitle\t\t\t\t\t,\r\n\t\t\tStoreId\t\t\t\t\t\t\t,\r\n            StoreLocationLatitude,\r\n            StoreLocationLongitude,\r\n\t\t\tStoreTitle\t\t\t\t\t\t,\r\n            FORMAT([DeliveryStartTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryStartTimeStr,\r\n            FORMAT([DeliveryStartTimePersian],\u0027####/##/## ##:##:##\\.###\u0027)DeliveryStartTimePersianStr,\r\n            FORMAT([DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryDeadLineTimeStr,\r\n            FORMAT([DeliveryDeadLineTimePersian],\u0027####/##/## ##:##:##\\.###\u0027) DeliveryDeadLineTimePersianStr,\r\n\t\t\tClientAddress\t\t\t\t\t,\r\n            [ClientLocationLatitude],\r\n            ClientLocationLongitude,\r\n\t\t\tFleetPreAssignmentStateCount\t,\r\n\t\t\tFleetDelayTime\t\t\t\t\t,\r\n\t\t\tVendorParcelCode\t\t\t\t,\r\n\t\t\tCreateDate\t\t\t\t\t\t,\r\n\t\t\tFORMAT([CreateDatePersian],\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersianStr,\r\n\t\t\tVendorId\t\t\t\t\t\t,\r\n\t\t\tShipmentId\t\t\t\t\t\t,\r\n\t\t\tShipmentStatusId\t\t\t\t,\r\n\t\t\tShipmentStatusTitle\t\t\t\t,\r\n\t\t\tShipmentNumber\t\t\t\t\t,\r\n\t\t\tFleetId\t\t\t\t\t\t\t,\r\n\t\t\tDriverId\t\t\t\t\t\t,\r\n\t\t\tDriverName\t\t\t\t\t\t,\r\n\t\t\tDriverMobile\t\t\t\t\t,\r\n\t\t\tVehicleTypeId\t\t\t\t\t,\r\n\t\t\tPlateNumber\t\t\t\t\t\t,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t\tGETDATE() BETWEEN\r\n\t\t\t\t\tDATEADD(MINUTE,-1*@WarningToOperationOnDispatchRequestTimeMinutes_Local,CAST(CONVERT(varchar, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\tAND\r\n\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds\u002B@WarningToOperationOnDispatchRequestTimeMinutes_Local*60,CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\tTHEN 1\r\n\t\t\t\tWHEN GETDATE()\u003EDATEADD(MINUTE,@WarningToOperationOnDispatchRequestTimeMinutes_Local,CAST(CONVERT(varchar, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\tTHEN 2\r\n\t\t\t\tELSE 0\r\n\t\t\tEND DeliveryStatus,\r\n\t\t\tIsExclusiveDelivery,\r\n\t\t\tIsNightly,\r\n\t\t\tDeliveryServiceProviderId,\r\n\t\t\tDeliveryServiceProviderOrderId,\r\n\t\t\tfr.orderCategoryId,\r\n\t\t\tfr.orderCategoryTitle,\r\n\t\t\tFORMAT(fr.ETA,\u0027yyyy/MM/dd HH:mm:ss\u0027,\u0027fa\u0027) ETA,\r\n\t\t\tfr.Version,\r\n\t\t\tdrsh.TimeIntervalChangeStatus\r\n\r\n\t\tFROM #FinalResult AS fr\r\n\t\tOUTER APPLY \r\n\t\t(\r\n\t\t\tSELECT TOP 1 WITH TIES\r\n\t\t\t\tDATEDIFF(MINUTE,CAST(CONVERT(varchar, FORMAT(drsh.CreateDate,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME),GETDATE()) TimeIntervalChangeStatus\r\n\t\t\tFROM DP.DispatchRequestStatusHistory drsh WITH(NOLOCK)\r\n\t\t\tWHERE drsh.DispatchRequestId = fr.DispatchRequestId\r\n\t\t\tORDER BY ROW_NUMBER() OVER ( ORDER BY CreateDate DESC , ID DESC )\r\n\t\t) DRSH\r\n        ORDER BY \r\n        CASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027ETA\u0027 AND @IsAsc_Local = 1 THEN ETA\r\n        End ASC,\r\n        CASE\r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027ETA\u0027 AND @IsAsc_Local = 0 THEN ETA\r\n        End DESC,\r\n\t\tCASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027DeliveryStartTime\u0027 AND @IsAsc_Local = 1 THEN DeliveryStartTime\r\n        End ASC,\r\n        CASE\r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027DeliveryStartTime\u0027 AND @IsAsc_Local = 0 THEN DeliveryStartTime\r\n        End DESC/*,\r\n\t\tCASE \r\n\t\t\tWHEN @OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027FleetDelayTime\u0027 AND @IsAsc_Local = 1 THEN FleetDelayTime\r\n\t\tEnd ASC,\r\n\t\tCASE\r\n\t\t\tWHEN (@OrderBy_Local \u003C\u003E \u00270\u0027 AND @OrderBy_Local = \u0027FleetDelayTime\u0027 AND @IsAsc_Local = 0) OR (@OrderBy_Local IS NULL OR @OrderBy_Local = \u00270\u0027) THEN FleetDelayTime\r\n\t\tEnd DESC*/\r\n\t\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\r\n\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n"},{"Name":"Get_DelayedPickedUp_By_Filter","Schema":"dbo","Definition":"--#################################################################################################################################\r\n-- Stored Procedure\r\n\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/07/26\r\n--\tDescription:\tGet Returned List By Filter\r\n--\r\n--\t=======================================\r\n\r\n/*\r\n\tDECLARE\t@return_value int,\r\n\t\t\t@UnassignedDispatchRequestCount int,\r\n\t\t\t@AssignedDispatchRequestCount int,\r\n\t\t\t@ReturnedRequestCount int,\r\n\t\t\t@DelayedDeliveryCount int,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount int,\r\n\t\t\t@TotalCount\tINT\r\n\r\n\tEXEC\t@return_value = [dbo].[Get_DelayedPickedUp_By_Filter]\r\n\t\t\t@CityIds=NULL, @WarningToOperationOnDispatchRequestTimeMinutes=0, @OperationStaffId=42, @ParcelReferenceCode=NULL, @StartDeliveryTime=NULL, @EndDeliveryTime=NULL, @VendorParcelCode=NULL, @VendorId=NULL, @FleetId=NULL, @OrderBy=\u0027timeIntervalChangeStatus\u0027, @IsAsc=N\u0027False\u0027, @IsExclusiveDelivery=N\u0027False\u0027, @IsNightly=N\u0027False\u0027, @pageSize=10, @pageIndex=0\r\n\r\n\t\t\t@UnassignedDispatchRequestCount = @UnassignedDispatchRequestCount OUTPUT,\r\n\t\t\t@AssignedDispatchRequestCount = @AssignedDispatchRequestCount OUTPUT,\r\n\t\t\t@ReturnedRequestCount = @ReturnedRequestCount OUTPUT,\r\n\t\t\t@DelayedDeliveryCount = @DelayedDeliveryCount OUTPUT,\r\n\t\t\r\n\t@UnassignedReturnAndReplacementRequestCount = @UnassignedReturnAndReplacementRequestCount OUTPUT,\r\n\t\t\t@TotalCount = @TotalCount OUTPUT,\r\n\t\t\t@PageIndex = 0,\r\n\t\t\t@PageSize = 100,\r\n\t\t\t@OperationStaffId = 42--\r\n\t\t\t                       ,@FleetId=4171\r\n\r\n\tSELECT\t@UnassignedDispatchRequestCount AS N\u0027@UnassignedDispatchRequestCount\u0027,\r\n\t\t\t@AssignedDispatchRequestCount AS N\u0027@AssignedDispatchRequestCount\u0027,\r\n\t\t\t@ReturnedRequestCount AS N\u0027@ReturnedRequestCount\u0027,\r\n\t\t\t@DelayedDeliveryCount AS N\u0027@DelayedDeliveryCount\u0027,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount AS N\u0027@UnassignedReturnAndReplacementRequestCount\u0027,\r\n\t\t\t@TotalCount AS N\u0027@TotalCount\u0027\r\n*/\r\nCREATE      PROCEDURE [dbo].[Get_DelayedPickedUp_By_Filter]\r\n\t    --@ProvinceId\tSMALLINT = NULL,\r\n\t\t@CityIds VARCHAR(MAX) = NULL,\r\n        @PolygonIds VARCHAR(MAX) = NULL,\r\n        @StoreIds VARCHAR(MAX) = NULL,\r\n        @ParcelReferenceCode BIGINT = NULL,\r\n        @CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n        @StartDeliveryTime BIGINT = NULL,\r\n        @EndDeliveryTime BIGINT = NULL,\r\n        @VendorParcelCode VARCHAR(32) = NULL,\t\r\n\t\t@VendorId\t\tINT = NULL,\r\n\t\t@WarningToOperationOnDispatchRequestTimeMinutes SMALLINT = NULL,\t\t\r\n\t\t@FleetId INT = NULL,\r\n\t\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t\t@OrderCategoryIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t\t@DispatchRequestStatusCategoryIds\t\tVARCHAR(MAX)\t\t= NULL,\r\n        @OrderBy NVARCHAR(200) = NULL,\r\n        @IsAsc BIT = NULL,\r\n\t\t@UnassignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@AssignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@ReturnedRequestCount INT = 0 OUTPUT,\r\n\t\t@DelayedDeliveryCount INT = 0 OUTPUT,\r\n\t\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t\t@NotPickUpRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t\t@OperationStaffId\t\t\t\t\t\t\tINT,\r\n\t\t@DeliveryServiceProviderIds\t \t \t \t\tVARCHAR(MAX)\t = NULL\r\n\r\n\r\nAS \r\n\tSET NOCOUNT ON;\r\n\r\n\tIF @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027\r\n\tBEGIN\r\n\t\tSET @OrderBy = REPLACE(@OrderBy,\u0027deliveryStartTimeStr\u0027,\u0027deliveryStartTime\u0027)\r\n\t\tSET @OrderBy = REPLACE(@OrderBy,\u0027DeliveryStartTimePersianStr\u0027,\u0027DeliveryStartTimePersian\u0027)\r\n\t\tSET @OrderBy = REPLACE(@OrderBy,\u0027DeliveryDeadLineTimeStr\u0027,\u0027DeliveryDeadLineTime\u0027)\r\n\t\tSET @OrderBy = REPLACE(@OrderBy,\u0027DeliveryDeadLineTimePersianStr\u0027,\u0027DeliveryDeadLineTimePersian\u0027)\r\n\t\tSET @OrderBy = REPLACE(@OrderBy,\u0027CreateDateStr\u0027,\u0027CreateDate\u0027)\r\n\t\tSET @OrderBy = REPLACE(@OrderBy,\u0027CreateDatePersianStr\u0027,\u0027CreateDatePersian\u0027)\r\n\t\tSET @OrderBy = REPLACE(@OrderBy,\u0027FleetDelayTime\u0027,\u0027FleetDelayTime\u0027)\r\n\tEND\r\n\tELSE\r\n\tBEGIN\r\n\t\tSET @OrderBy = \u0027TimeIntervalChangeStatus DESC\u0027\r\n\tEND\r\n    --############################################ Preparation Data ##################################\r\n\tSET @IsExclusiveDelivery = NULL\r\n\tSET @IsNightly = NULL\r\n        drop table if EXISTS    #DispatchRequest,\r\n                                #Shipment,\r\n                                #Fleet,\r\n\t\t\t\t\t\t\t\t#FinalResult,\r\n\t\t\t\t\t\t\t\t#AllDispatchRequests\r\n        SELECT\r\n\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\t\t=ISNULL(@CityIds,\u00270\u0027),\r\n                @PolygonIds\t\t\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),\r\n                @StoreIds\t\t\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n                @ParcelReferenceCode\t\t\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n                @CourierRequestTypeIds\t\t\t\t\t\t\t=ISNULL(@CourierRequestTypeIds,0),\r\n                @StartDeliveryTime\t\t\t\t\t\t\t\t=ISNULL(@StartDeliveryTime,0),\r\n                @EndDeliveryTime\t\t\t\t\t\t\t\t=ISNULL(@EndDeliveryTime,0),\r\n                @VendorParcelCode\t\t\t\t\t\t\t\t=ISNULL(@VendorParcelCode,\u00270\u0027),\r\n\t\t\t\t@WarningToOperationOnDispatchRequestTimeMinutes =ISNULL(@WarningToOperationOnDispatchRequestTimeMinutes,0),\r\n\t\t\t\t@FleetId\t\t\t\t\t\t\t\t\t\t=ISNULL(@FleetId,0),\r\n                @IsAsc\t\t\t\t\t\t\t\t\t\t\t=ISNULL(@IsAsc,1),\r\n\t\t\t\t@VendorID\t\t\t\t\t\t\t\t\t\t=ISNULL(@VendorID,0),\r\n\t\t\t\t@DeliveryServiceProviderIds\t\t\t\t\t\t=ISNULL(@DeliveryServiceProviderIds,\u00270\u0027),\r\n\t\t\t\t@OrderCategoryIds = ISNULL(@OrderCategoryIds,\u00270\u0027),\r\n\t\t\t\t@DispatchRequestStatusCategoryIds = ISNULL(@DispatchRequestStatusCategoryIds,\u00270\u0027)\r\n\r\n\t\tSELECT \r\n\t\t\tdsp.Id\r\n\t\tINTO #DeliveryServiceProviderId\r\n\t\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\t\tINNER JOIN string_split(@DeliveryServiceProviderIds,\u0027,\u0027) ss\r\n\t\t\tON dsp.Id = ss.value\r\n\t\t\tOR @DeliveryServiceProviderIds = \u00270\u0027\r\n\r\n\t\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t\t(\r\n\t\t\tId\r\n\t\t)\r\n\r\n\t\tDECLARE @CityId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CityId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\r\n  --      DECLARE @PolygonId TABLE\r\n\t\t--(\r\n\t\t--\tId SMALLINT\r\n\t\t--);\r\n\t\t--INSERT INTO @PolygonId\r\n\t\tSELECT \r\n\t\t\tp.Id\r\n\t\tINTO #PolygonId\r\n\t\tFROM DP.Polygon p WITH(NOLOCK)\r\n\t\tINNER JOIN string_split(@PolygonIds,\u0027,\u0027) ss\r\n\t\t\tON p.Id = ss.value\r\n\t\t\tOR @PolygonIds = \u00270\u0027;\r\n\r\n  --      DECLARE @StoreId TABLE\r\n\t\t--(\r\n\t\t--\tId SMALLINT\r\n\t\t--);\r\n\t\t--INSERT INTO @StoreId\r\n\t\tCREATE TABLE #StoreId \r\n\t\t(\r\n\t\t\tId INT\r\n\t\t)\r\n\r\n\t\tIF @StoreIds = \u00270\u0027\r\n\t\t\tBEGIN\r\n\t\t\t\tINSERT INTO #StoreId ( ID )\r\n\t\t\t\tSELECT \r\n\t\t\t\t\ts.Id\r\n\t\t\t\tFROM DP.Store s WITH(NOLOCK);\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tBEGIN\r\n\t\t\t\tINSERT INTO #StoreId ( ID )\r\n\t\t\t\tSELECT \r\n\t\t\t\t\ts.Id\r\n\t\t\t\tFROM DP.Store s WITH(NOLOCK)\r\n\t\t\t\tINNER JOIN string_split(@StoreIds,\u0027,\u0027) ss\r\n\t\t\t\t\tON s.Id = ss.value;\r\n\t\t\tEND\r\n\r\n\t\tDECLARE @CourierRequestTypeId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t);\r\n\t\tINSERT INTO @CourierRequestTypeId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CourierRequestTypeIds,\u0027,\u0027);\r\n\r\n\t\tSELECT\r\n\t\t\toc.Id\r\n\t\tINTO #OrderCategoryId\r\n\t\tFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tINNER JOIN string_split(@OrderCategoryIds,\u0027,\u0027) ss\r\n\t\t\tON oc.Id = ss.value\r\n\t\t\tOR @OrderCategoryIds = \u00270\u0027\r\n\r\n\tDECLARE @Today BIGINT,@Yesterday BIGINT\r\n\tSET @Today = FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027235959999\u0027\r\n\tSET @Yesterday = FORMAT(GETDATE()-1,\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027\r\n\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\r\nSELECT \r\n\t@UnassignedDispatchRequestCount = COUNT(DISTINCT SQ.UnassignedDispatchRequestCount),\r\n\t@AssignedDispatchRequestCount = COUNT(DISTINCT SQ.AssignedDispatchRequestCount),\r\n\t@ReturnedRequestCount = COUNT(DISTINCT SQ.ReturnedRequestCount),\r\n\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT SQ.UnassignedReturnAndReplacementRequestCount),\r\n\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\nFROM\r\n(\r\n\tSELECT \r\n\t\tCASE \r\n\t\t\tWHEN ddr.DispatchRequestStatusId IN (5,6,7)  AND DeliveryStartTime BETWEEN @Yesterday AND @Today \r\n\t\t\tTHEN ddr.ParcelReferenceCode \r\n\t\t\tELSE NULL \r\n\t\tEND AS UnassignedDispatchRequestCount,\r\n\t\tCASE \r\n\t\t\tWHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54) \r\n\t\t\tTHEN ddr.ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS AssignedDispatchRequestCount,\r\n\t\tCASE \r\n\t\t\tWHEN \r\n\t\t\t\t(\r\n\t\t\t\t\t(DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n\t\t\t\t\tOR\r\n\t\t\t\t\t(DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\n\t\t\t\t\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\t\t\t) \r\n\t\t\tTHEN ddr.ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS ReturnedRequestCount,\r\n\t\tCASE \r\n\t\t\tWHEN \r\n\t\t\t\tddr.DispatchRequestStatusId = 5\r\n\t\t\t\tAND ddr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70)\r\n\t\t\tTHEN ddr.ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS UnassignedReturnAndReplacementRequestCount,\r\n\t\tCASE \r\n\t\t\tWHEN \r\n\t\t\t\tddr.IsWaitingForSupport = 1 \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\tTHEN ddr.ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS NotPickupRequestCount\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tINNER JOIN #PolygonId PID\r\n\t\tON dp.ID = pID.Id\r\n\tWHERE ddr.DeliveryStartTime \u003E=@ToDate\r\n\tand (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\tAND (ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\tAND (ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\tAND (ddr.VendorId = @VendorID OR @VendorID = 0)\r\n\tAND (ddr.DispatchRequestStatusId IN (5,6,7,10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54) OR DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25 )\r\n) SQ\r\n\r\nSELECT\r\n\t@DelayedDeliveryCount = COUNT(DISTINCT SQ.DelayedDeliveryCount)\r\nFROM\r\n(\r\n\tSELECT\r\n\t\tCASE \r\n\t\t\tWHEN sdp.ID IS NOT NULL \r\n\t\t\tTHEN ddr.ParcelReferenceCode\r\n\t\t\tELSE NULL\r\n\t\tEND AS DelayedDeliveryCount\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tINNER JOIN #PolygonId PID\r\n\t\tON dp.ID = pID.Id\t\t\r\n\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  \r\n\t\tON sdpdr.DispatchRequestId = ddr.Id \r\n\t\tAND ddr.DispatchRequestStatusId in (20,25)\r\n\tINNER JOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  \r\n\t\tON sdp.Id = sdpdr.ShipmentDestinationPointId \r\n\t\tAND sdp.OperationTypeId = 10 \r\n\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= getdate() \r\n\tWHERE ddr.DeliveryStartTime \u003E=@ToDate\r\n\tand (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\tAND (ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\tAND (ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\tAND (ddr.VendorId = @VendorID OR @VendorID = 0)\r\n) SQ\r\n\t\r\n\t\r\n\tDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\n-- COUNT\r\nBEGIN\r\n\r\n\tSET @STR \u002B=\r\n\t\u0027 SELECT @TotalCount = COUNT(dr.Id)\r\n    FROM dp.DispatchRequest dr (NOLOCK)\r\n    INNER JOIN dp.DispatchRequestStatus drs (NOLOCK) \r\n\t\tON dr.DispatchRequestStatusId = drs.Id\r\n    INNER JOIN dp.PolygonStore ps (NOLOCK) \r\n\t\tON dr.PolygonStoreId = ps.Id\r\n    INNER JOIN dp.Polygon p1 (NOLOCK) \r\n\t\tON ps.PolygonId = p1.Id\r\n    INNER JOIN dp.Store s (NOLOCK) \r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = p1.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON dr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tON s.OrderCategoryId = oc.Id\u0027\r\n\r\n\tIF @StoreIds \u003C\u003E \u00270\u0027\r\n\tSET @STR \u002B=\r\n\t\t\u0027 INNER JOIN #StoreId sID\r\n\t\tON s.ID = sID.Id\u0027\r\n\r\n\tSET @STR \u002B=\r\n\t\u0027 WHERE DispatchRequestStatusId IN (10,11,15,16)\r\n\tAND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @OrderBy IS NULL OR @OrderBy = \u0027\u0027 OR @OrderBy NOT LIKE \u0027%ETA%\u0027\r\n\tSET @STR \u002B=\r\n\t\u0027 AND EXISTS \r\n\t( \r\n\t\tSELECT 1 FROM DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)  \r\n\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\tON sdp.id = sdpdr.ShipmentDestinationPointId\r\n\t\t\tAND OperationTypeId IN (5)\r\n\t\tINNER JOIN DP.Shipment s WITH(NOLOCK)\r\n\t\t\tON sdp.ShipmentID = s.Id\u0027 \u002B CASE WHEN @FleetID \u003C\u003E 0 THEN \u0027 AND s.FleetID = \u0027 \u002B CAST(@FleetId AS VARCHAR(MAX)) ELSE \u0027\u0027 END \u002B\r\n\t\t\u0027 WHERE dr.ID = sdpdr.DispatchRequestId\r\n\t\tAND dr.Version = sdpdr.Version\r\n\t\tAND DATEDIFF(second,(DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME))),GETDATE()) \u003E 0\r\n\t)\u0027\r\n\r\n\tIF @ParcelReferenceCode \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.ParcelReferenceCode =\u0027\u002BCAST(@ParcelReferenceCode AS VARCHAR(MAX))\r\n\tIF @VendorParcelCode \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.VendorParcelCode =\u0027\u0027\u0027\u002BCAST(@VendorParcelCode AS VARCHAR(MAX))\u002B\u0027\u0027\u0027\u0027\r\n\tIF @VendorId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.VendorId =\u0027\u002BCAST(@VendorId AS VARCHAR(MAX))\r\n\r\n\tIF @IsExclusiveDelivery IS NOT NULL\r\n\t\tSET @STR \u002B= \u0027 AND dr.IsExclusiveDelivery =\u0027\u002BCAST(@IsExclusiveDelivery AS VARCHAR(MAX))\r\n\tIF @IsNightly IS NOT NULL\r\n\t\tSET @STR \u002B= \u0027 AND dr.IsNightly =\u0027\u002BCAST(@IsNightly AS VARCHAR(MAX))\r\n\r\n\tIF @StartDeliveryTime \u003C\u003E 0 AND @EndDeliveryTime \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND (dr.DeliveryStartTime BETWEEN \u0027\u002BCAST(@StartDeliveryTime AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@EndDeliveryTime AS VARCHAR(MAX))\u002B\u0027 OR dr.DeliveryDeadLineTime BETWEEN \u0027\u002BCAST(@StartDeliveryTime AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@EndDeliveryTime AS VARCHAR(MAX))\u002B\u0027)\u0027\r\n\t--IF @StoreIds \u003C\u003E \u00270\u0027\r\n\t--\tSET @STR \u002B= \u0027 AND s.Id IN ( @StoreIds )\u0027\r\n\tIF @PolygonIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND p1.Id IN (\u0027\u002B@PolygonIds\u002B\u0027)\u0027\r\n\tIF @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B@CourierRequestTypeIds\u002B\u0027)\u0027\r\n\tIF @CityIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND p1.CityId IN (\u0027\u002B@CityIds\u002B\u0027)\u0027\r\n\tIF @DispatchRequestStatusCategoryIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND drs.DispatchRequestStatusCategoryId IN (\u0027\u002B@DispatchRequestStatusCategoryIds\u002B\u0027)\u0027\r\n\r\nEND\r\n\r\nBEGIN\r\n\r\n\tSET @STR \u002B=\r\n\t\u0027 SELECT\r\n\t\tdr.Id DispatchRequestId,\r\n        dr.DispatchRequestStatusId,\r\n        drs.Title AS DispatchRequestStatusTitle,\r\n        dr.ParcelReferenceCode,\r\n        dr.CourierRequestTypeId,\r\n        p1.CityId,\r\n        ps.PolygonId,\r\n        p1.Title AS PolygonTitle,\r\n        StoreId,\r\n        s.[Location].STY  AS  StoreLocationLatitude,\r\n        s.[Location].STX  AS  StoreLocationLongitude,\r\n        s.Title AS StoreTitle,\r\n        dr.DeliveryStartTime,\r\n        dr.DeliveryStartTimePersian,\r\n        dr.DeliveryDeadLineTime,\r\n        dr.DeliveryDeadLineTimePersian,\r\n        dr.ClientAddress,\r\n        dr.ClientLocation.STY  AS  ClientLocationLatitude,\r\n        dr.ClientLocation.STX  AS  ClientLocationLongitude,\r\n        ISNULL(dr.AssignmentTryCount,0) AS FleetPreAssignmentStateCount,\r\n        dr.VendorParcelCode,\r\n        dr.CreateDate,\r\n        dr.CreateDatePersian,\r\n        dr.VendorId,\r\n\t\tdr.IsExclusiveDelivery,\r\n\t\tdr.IsNightly,\r\n\t\tdr.DeliveryServiceProviderId,\r\n\t\ts.OrderCategoryId,\r\n\t\toc.Title AS OrderCategoryTitle,\r\n\t\tdr.Version\u0027\u002B CASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy LIKE \u0027%ETA%\u0027 THEN \u0027,ETA\u0027 ELSE \u0027\u0027 END\u002B\u0027\r\n\tINTO #Output\r\n    FROM dp.DispatchRequest dr (NOLOCK)\r\n    INNER JOIN dp.DispatchRequestStatus drs (NOLOCK) \r\n\t\tON dr.DispatchRequestStatusId = drs.Id\r\n    INNER JOIN dp.PolygonStore ps (NOLOCK) \r\n\t\tON dr.PolygonStoreId = ps.Id\r\n    INNER JOIN dp.Polygon p1 (NOLOCK) \r\n\t\tON ps.PolygonId = p1.Id\r\n    INNER JOIN dp.Store s (NOLOCK) \r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = p1.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON dr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tON s.OrderCategoryId = oc.Id\u0027\r\n\r\n\tIF @StoreIds \u003C\u003E \u00270\u0027\r\n\tSET @STR \u002B=\r\n\t\t\u0027 INNER JOIN #StoreId sID\r\n\t\tON s.ID = sID.Id\u0027\r\n\tIF @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy LIKE \u0027%ETA%\u0027\r\n\t\tSET @STR \u002B=\r\n\t\t\u0027 CROSS APPLY\r\n\t\t( \r\n\t\t\tSELECT \r\n\t\t\t\tDATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME)) AS ETA\r\n\t\t\tFROM DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)  \r\n\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\tON sdp.id = sdpdr.ShipmentDestinationPointId\r\n\t\t\t\tAND OperationTypeId IN (5)\r\n\t\t\tINNER JOIN DP.Shipment s WITH(NOLOCK)\r\n\t\t\t\tON sdp.ShipmentID = s.Id\u0027 \u002B CASE WHEN @FleetID \u003C\u003E 0 THEN \u0027 AND s.FleetID = \u0027 \u002B CAST(@FleetId AS VARCHAR(MAX)) ELSE \u0027\u0027 END \u002B\r\n\t\t\t\u0027 WHERE dr.ID = sdpdr.DispatchRequestId\r\n\t\t\tAND dr.Version = sdpdr.Version\r\n\t\t\tAND DATEDIFF(second,(DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME))),GETDATE()) \u003E 0\r\n\t\t) ETA\u0027\r\n\r\n\tIF @OrderBy IS NULL OR @OrderBy LIKE \u0027%TimeIntervalChangeStatus%\u0027\r\n\tSET @STR \u002B=\r\n\t\u0027 OUTER APPLY \r\n\t(\r\n\t\tSELECT TOP 1 WITH TIES\r\n\t\t\tDATEDIFF(SECOND,CAST(CONVERT(varchar, FORMAT(drsh.CreateDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME),GETDATE()) TimeIntervalChangeStatus\r\n\t\tFROM DP.DispatchRequestStatusHistory drsh WITH(NOLOCK)\r\n\t\tWHERE drsh.DispatchRequestId = dr.Id\r\n\t\tORDER BY ROW_NUMBER() OVER ( ORDER BY drsh.CreateDate DESC , drsh.ID DESC )\r\n\t) DRSH\u0027\r\n\r\n\tSET @STR \u002B=\r\n\t\u0027 WHERE DispatchRequestStatusId IN (10,11,15,16)\r\n\tAND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @OrderBy IS NULL OR @OrderBy = \u0027\u0027 OR @OrderBy NOT LIKE \u0027%ETA%\u0027\r\n\tSET @STR \u002B=\r\n\t\u0027 AND EXISTS \r\n\t( \r\n\t\tSELECT 1 FROM DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)  \r\n\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\tON sdp.id = sdpdr.ShipmentDestinationPointId\r\n\t\t\tAND OperationTypeId IN (5)\r\n\t\tINNER JOIN DP.Shipment s WITH(NOLOCK)\r\n\t\t\tON sdp.ShipmentID = s.Id\u0027 \u002B CASE WHEN @FleetID \u003C\u003E 0 THEN \u0027 AND s.FleetID = \u0027 \u002B CAST(@FleetId AS VARCHAR(MAX)) ELSE \u0027\u0027 END \u002B\r\n\t\t\u0027 WHERE dr.ID = sdpdr.DispatchRequestId\r\n\t\tAND dr.Version = sdpdr.Version\r\n\t\tAND DATEDIFF(second,(DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME))),GETDATE()) \u003E 0\r\n\t)\u0027\r\n\r\n\tIF @ParcelReferenceCode \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.ParcelReferenceCode =\u0027\u002BCAST(@ParcelReferenceCode AS VARCHAR(MAX))\r\n\tIF @VendorParcelCode \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.VendorParcelCode =\u0027\u0027\u0027\u002BCAST(@VendorParcelCode AS VARCHAR(MAX))\u002B\u0027\u0027\u0027\u0027\r\n\tIF @VendorId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND dr.VendorId =\u0027\u002BCAST(@VendorId AS VARCHAR(MAX))\r\n\r\n\tIF @IsExclusiveDelivery IS NOT NULL\r\n\t\tSET @STR \u002B= \u0027 AND dr.IsExclusiveDelivery =\u0027\u002BCAST(@IsExclusiveDelivery AS VARCHAR(MAX))\r\n\tIF @IsNightly IS NOT NULL\r\n\t\tSET @STR \u002B= \u0027 AND dr.IsNightly =\u0027\u002BCAST(@IsNightly AS VARCHAR(MAX))\r\n\r\n\tIF @StartDeliveryTime \u003C\u003E 0 AND @EndDeliveryTime \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND (dr.DeliveryStartTime BETWEEN \u0027\u002BCAST(@StartDeliveryTime AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@EndDeliveryTime AS VARCHAR(MAX))\u002B\u0027 OR dr.DeliveryDeadLineTime BETWEEN \u0027\u002BCAST(@StartDeliveryTime AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@EndDeliveryTime AS VARCHAR(MAX))\u002B\u0027)\u0027\r\n\t--IF @StoreIds \u003C\u003E \u00270\u0027\r\n\t--\tSET @STR \u002B= \u0027 AND s.Id IN (\u0027\u002B@StoreIds\u002B\u0027)\u0027\r\n\tIF @PolygonIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND p1.Id IN (\u0027\u002B@PolygonIds\u002B\u0027)\u0027\r\n\tIF @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B@CourierRequestTypeIds\u002B\u0027)\u0027\r\n\tIF @CityIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND p1.CityId IN (\u0027\u002B@CityIds\u002B\u0027)\u0027\r\n\tIF @DispatchRequestStatusCategoryIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND drs.DispatchRequestStatusCategoryId IN (\u0027\u002B@DispatchRequestStatusCategoryIds\u002B\u0027)\u0027\r\n\r\n\tSET @STR \u002B=\r\n\t\u0027 ORDER BY \u0027\u002BCASE WHEN @OrderBy IS NULL OR @OrderBy = \u0027\u0027 THEN \u0027 drsh.TimeIntervalChangeStatus DESC\u0027 ELSE @OrderBy \u002B CASE WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 ELSE \u0027\u0027 END END \u002B\u0027\r\n\tOFFSET \u0027\u002BCAST(@pageIndex * @pageSize AS VARCHAR(MAX)) \u002B\u0027 ROWS FETCH NEXT \u0027\u002BCAST(@pageSize AS VARCHAR(MAX)) \u002B\u0027 ROWS ONLY\u0027\r\n\r\nEND\r\n\r\nSET @STR \u002B=\r\n\u0027 ;WITH  CTE_Shipment AS \r\n(\r\n\tSELECT * FROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\ts.Id ShipmentId,\r\n\t\t\ts.ShipmentStatusId,\r\n\t\t\tss.Title AS ShipmentStatusTitle,\r\n\t\t\tShipmentNumber,\r\n\t\t\ts.FleetId,\r\n\t\t\tf.DriverId,\r\n\t\t\td.FirstName \u002B \u0027\u0027 \u0027\u0027 \u002B d.LastName AS DriverName,\r\n\t\t\t\u0027\u00270\u0027\u0027\u002BCAST(d.Mobile AS VARCHAR(20)) AS DriverMobile,\r\n\t\t\tv.VehicleTypeId,\r\n\t\t\tv.PlateNumber,\r\n\t\t\tdr.DispatchRequestId AS DispatchRequestId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime,\u0027\u002B\r\n\t\t\t CASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy LIKE \u0027%ETA%\u0027 THEN \u0027\u0027 ELSE \u0027 DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME)) AS ETA,\u0027 END \u002B\r\n\t\t\t\u0027 DATEDIFF(second,(DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME))),GETDATE()) AS FleetDelayTime,\r\n\t\t\tROW_NUMBER() over (partition by dr.DispatchRequestId order by dr.DispatchRequestId,sdp.Id desc) RowNum\r\n\t\tfrom #OUTPUT dr\r\n\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest s3 (NOLOCK)  \r\n\t\t\tON dr.DispatchRequestId = s3.DispatchRequestId\r\n\t\t\tAND dr.Version = s3.Version\r\n\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)   \r\n\t\t\tON sdp.id = s3.ShipmentDestinationPointId \r\n\t\t\tAND OperationTypeId IN (5)\r\n\t\tINNER JOIN dp.Shipment s (NOLOCK)  \r\n\t\t\tON s.id = sdp.ShipmentId\r\n\t\tINNER JOIN dp.ShipmentStatus ss (NOLOCK)  \r\n\t\t\tON s.ShipmentStatusId = ss.Id\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK) \r\n\t\t\tON s.FleetId = f.Id\r\n\t\tINNER JOIN CS_DriverManagement.DM.Driver d (NOLOCK) \r\n\t\t\tON f.DriverId = d.Id\r\n\t\tINNER JOIN CS_DriverManagement.DM.Vehicle v (NOLOCK) \r\n\t\t\tON f.VehicleId = v.Id\r\n\t) SQ\r\n\tWHERE SQ.RowNum = 1\r\n\r\n),CTE_DSPRM AS\r\n(\r\n\tSELECT \r\n\t\tdsprm.DispatchRequestId,\r\n\t\tdsprm.DeliveryServiceProviderOrderId\r\n\tFROM DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\tINNER JOIN #OUTPUT dr\r\n\t\tON dsprm.DispatchRequestId = dr.DispatchRequestId\r\n\tWHERE dsprm.IsActive = 1\r\n)\r\nSELECT O.DispatchRequestId,\r\n       O.DispatchRequestStatusId,\r\n       O.DispatchRequestStatusTitle,\r\n       O.ParcelReferenceCode,\r\n       O.CourierRequestTypeId,\r\n       O.CityId,\r\n       O.PolygonId,\r\n       O.PolygonTitle,\r\n       O.StoreId,\r\n       O.StoreLocationLatitude,\r\n       O.StoreLocationLongitude,\r\n       O.StoreTitle,\r\n       FORMAT(O.DeliveryStartTime, \u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) DeliveryStartTimeStr,\r\n       FORMAT(O.DeliveryStartTimePersian, \u0027\u0027####/##/## ##:##:##\\.###\u0027\u0027) DeliveryStartTimePersianStr,\r\n       FORMAT(O.DeliveryDeadLineTime, \u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) DeliveryDeadLineTimeStr,\r\n       FORMAT(O.DeliveryDeadLineTimePersian, \u0027\u0027####/##/## ##:##:##\\.###\u0027\u0027) DeliveryDeadLineTimePersianStr,\r\n       O.ClientAddress,\r\n       O.ClientLocationLatitude,\r\n       O.ClientLocationLongitude,\r\n       O.FleetPreAssignmentStateCount,\r\n       FleetDelayTime,\r\n       O.VendorParcelCode,\r\n       O.CreateDate,\r\n       FORMAT(O.CreateDatePersian, \u0027\u0027####/##/## ##:##:##\\.###\u0027\u0027) CreateDatePersianStr,\r\n       O.VendorId,\r\n       s.ShipmentId,\r\n       s.ShipmentStatusId,\r\n       s.ShipmentStatusTitle,\r\n       s.ShipmentNumber,\r\n       s.FleetId,\r\n       s.DriverId,\r\n       s.DriverName,\r\n       s.DriverMobile,\r\n       s.VehicleTypeId,\r\n       s.PlateNumber,\r\n       CASE\r\n           WHEN GETDATE() BETWEEN DATEADD(MINUTE, -1*\u0027\u002BCAST(@WarningToOperationOnDispatchRequestTimeMinutes AS VARCHAR(MAX))\u002B\u0027, CAST(CONVERT(varchar, FORMAT(O.DeliveryDeadLineTime, \u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027), 120) AS DATETIME)) AND DATEADD(SECOND, EstimatedOperationTimeSeconds\u002B\u0027\u002BCAST(@WarningToOperationOnDispatchRequestTimeMinutes AS VARCHAR(MAX))\u002B\u0027*60, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime, \u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027), 120) AS DATETIME)) THEN 1\r\n           WHEN GETDATE()\u003EDATEADD(MINUTE, \u0027\u002BCAST(@WarningToOperationOnDispatchRequestTimeMinutes AS VARCHAR(MAX))\u002B\u0027, CAST(CONVERT(varchar, FORMAT(O.DeliveryDeadLineTime, \u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027), 120) AS DATETIME)) THEN 2\r\n           ELSE 0\r\n       END PickupStatus,\r\n       O.IsExclusiveDelivery,\r\n       O.IsNightly,\r\n       O.DeliveryServiceProviderId,\r\n       DeliveryServiceProviderOrderId,\r\n       O.orderCategoryId,\r\n       O.orderCategoryTitle,\r\n       FORMAT(ETA, \u0027\u0027yyyy/MM/dd HH:mm:ss\u0027\u0027, \u0027\u0027fa\u0027\u0027) ETA,\r\n       O.Version,\r\n       drsh.TimeIntervalChangeStatus\r\nFROM #OUTPUT o \r\nLEFT JOIN CTE_Shipment s \r\n\tON o.DispatchRequestId = s.DispatchRequestId\r\nLEFT JOIN CTE_DSPRM dsprm\r\n\tON o.DispatchRequestId = dsprm.DispatchRequestId\r\nOUTER APPLY \r\n(\r\n\tSELECT TOP 1 WITH TIES\r\n\t\tDATEDIFF(second,CAST(CONVERT(varchar, FORMAT(drsh.CreateDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME),GETDATE()) TimeIntervalChangeStatus\r\n\tFROM DP.DispatchRequestStatusHistory drsh WITH(NOLOCK)\r\n\tWHERE drsh.DispatchRequestId = o.DispatchRequestId\r\n\tORDER BY ROW_NUMBER() OVER ( ORDER BY drsh.CreateDate DESC , drsh.ID DESC )\r\n) DRSH\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027 ORDER BY \u0027\u002BCASE WHEN @OrderBy IS NULL OR @OrderBy = \u0027\u0027 THEN \u0027 TimeIntervalChangeStatus DESC\u0027 ELSE @OrderBy \u002B CASE WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 ELSE \u0027\u0027 END END \r\n\r\n\tDECLARE @Param NVARCHAR(MAX) = \u0027 @TotalCount INT OUTPUT , @StoreIds VARCHAR(MAX) = NULL\u0027\r\n\tEXEC sys.sp_executesql @STR,@Param , @StoreIds = @StoreIds , @TotalCount = @TotalCount OUTPUT\r\n\r\n\tSET @DelayedDeliveryCount\t\t\t\t\t\t = ISNULL(@DelayedDeliveryCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\n\r\n\r\n"},{"Name":"Get_DelayedPickedUp_By_Filter_BACKUP","Schema":"dbo","Definition":"--#################################################################################################################################\r\n-- Stored Procedure\r\n\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/07/26\r\n--\tDescription:\tGet Returned List By Filter\r\n--\r\n--\t=======================================\r\n\r\n/*\r\n\tDECLARE\t@return_value int,\r\n\t\t\t@UnassignedDispatchRequestCount int,\r\n\t\t\t@AssignedDispatchRequestCount int,\r\n\t\t\t@ReturnedRequestCount int,\r\n\t\t\t@DelayedDeliveryCount int,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount int,\r\n\t\t\t@TotalCount\tINT\r\n\r\n\tEXEC\t@return_value = [dbo].[Get_DelayedPickedUp_By_Filter]\r\n\t\t\t@OrderBy = \u0027DeliveryDeadLineTimeStr\u0027,\r\n\t\t\t@IsAsc = 1,\r\n\t\t\t@UnassignedDispatchRequestCount = @UnassignedDispatchRequestCount OUTPUT,\r\n\t\t\t@AssignedDispatchRequestCount = @AssignedDispatchRequestCount OUTPUT,\r\n\t\t\t@ReturnedRequestCount = @ReturnedRequestCount OUTPUT,\r\n\t\t\t@DelayedDeliveryCount = @DelayedDeliveryCount OUTPUT,\r\n\t\t\r\n\t@UnassignedReturnAndReplacementRequestCount = @UnassignedReturnAndReplacementRequestCount OUTPUT,\r\n\t\t\t@TotalCount = @TotalCount OUTPUT,\r\n\t\t\t@PageIndex = 0,\r\n\t\t\t@PageSize = 100,\r\n\t\t\t@OperationStaffId = 42--\r\n\t\t\t                       ,@FleetId=4171\r\n\r\n\tSELECT\t@UnassignedDispatchRequestCount as N\u0027@UnassignedDispatchRequestCount\u0027,\r\n\t\t\t@AssignedDispatchRequestCount as N\u0027@AssignedDispatchRequestCount\u0027,\r\n\t\t\t@ReturnedRequestCount as N\u0027@ReturnedRequestCount\u0027,\r\n\t\t\t@DelayedDeliveryCount as N\u0027@DelayedDeliveryCount\u0027,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount as N\u0027@UnassignedReturnAndReplacementRequestCount\u0027,\r\n\t\t\t@TotalCount AS N\u0027@TotalCount\u0027\r\n*/\r\nCREATE      PROCEDURE [dbo].[Get_DelayedPickedUp_By_Filter_BACKUP]\r\n\t    --@ProvinceId\tSMALLINT = NULL,\r\n\t\t@CityIds NVARCHAR(MAX) = NULL,\r\n        @PolygonIds NVARCHAR(MAX) = NULL,\r\n        @StoreIds NVARCHAR(MAX) = NULL,\r\n        @ParcelReferenceCode BIGINT = NULL,\r\n        @CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n        @StartDeliveryTime BIGINT = NULL,\r\n        @EndDeliveryTime BIGINT = NULL,\r\n        @VendorParcelCode VARCHAR(32) = NULL,\t\r\n\t\t@WarningToOperationOnDispatchRequestTimeMinutes SMALLINT = NULL,\t\t\r\n\t\t@FleetId INT = NULL,\r\n\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n        @OrderBy NVARCHAR(200) = NULL,\r\n        @IsAsc BIT = NULL,\r\n\t\t@UnassignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@AssignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@ReturnedRequestCount INT = 0 OUTPUT,\r\n\t\t@DelayedDeliveryCount INT = 0 OUTPUT,\r\n\t\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t\t@OperationStaffId\t\t\t\t\t\tINT\r\n\r\n\r\nAS \r\n\tSET NOCOUNT ON;\r\n    --############################################ Preparation Data ##################################\r\n\r\n        drop table if EXISTS    #DispatchRequest,\r\n                                #Shipment,\r\n                                #Fleet,\r\n\t\t\t\t\t\t\t\t#FinalResult,\r\n\t\t\t\t\t\t\t\t#AllDispatchRequests\r\n        SELECT\r\n\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\t\t=ISNULL(@CityIds,\u00270\u0027),\r\n                @PolygonIds\t\t\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),\r\n                @StoreIds\t\t\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n                @ParcelReferenceCode\t\t\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n                @CourierRequestTypeIds\t\t\t\t\t\t\t=ISNULL(@CourierRequestTypeIds,0),\r\n                @StartDeliveryTime\t\t\t\t\t\t\t\t=ISNULL(@StartDeliveryTime,0),\r\n                @EndDeliveryTime\t\t\t\t\t\t\t\t=ISNULL(@EndDeliveryTime,0),\r\n                @VendorParcelCode\t\t\t\t\t\t\t\t=ISNULL(@VendorParcelCode,\u00270\u0027),\r\n\t\t\t\t@WarningToOperationOnDispatchRequestTimeMinutes =ISNULL(@WarningToOperationOnDispatchRequestTimeMinutes,0),\r\n\t\t\t\t@FleetId\t\t\t\t\t\t\t\t\t\t=ISNULL(@FleetId,0),\r\n\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\t\t=ISNULL(@OrderBy,\u00270\u0027),\r\n                @IsAsc\t\t\t\t\t\t\t\t\t\t\t=ISNULL(@IsAsc,0)\r\n\r\n\r\n\t\tDECLARE @CityId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CityId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\r\n        DECLARE @PolygonId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t);\r\n\t\tINSERT INTO @PolygonId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@PolygonIds,\u0027,\u0027);\r\n\r\n        DECLARE @StoreId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t);\r\n\t\tINSERT INTO @StoreId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@StoreIds,\u0027,\u0027);\r\n\r\n\t\tDECLARE @CourierRequestTypeId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t);\r\n\t\tINSERT INTO @CourierRequestTypeId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CourierRequestTypeIds,\u0027,\u0027);\r\n\r\n\r\n\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\r\n--------------------------------------------------------------------------------------------------------------\r\n\r\n\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\tLEFT(DeliveryStartTime,8) DeliveryStartTime_Date,\r\n\t\t\t\tddr.PolygonStoreId,\r\n\t\t\t\tdp.Id PolygonId,\r\n\t\t\t\tdp.Title PolygonTitle,\r\n\t\t\t\tps.StoreId,\r\n\t\t\t\ts.title\tStoreTitle,\r\n\t\t\t\tdp.CityId,\r\n\t\t\t\tddr.VendorParcelCode\r\n\t\t\t\t,ddr.DeliveryDeadLineTime\r\n\t\tINTO #AllDispatchRequests\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\tAND (dp.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\tAND ( ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\r\n\t\tDECLARE @Today INT\r\n\t\tSELECT @Today = CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n--------------------------------------------------------------------------------------------------------------\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (5,6)\r\n\t\tAND dr.DeliveryStartTime_Date = @Today\r\n-------------------------------------------------------------------------------------------------------------\r\n\t\tSELECT \r\n\t\t\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54)\r\n\t\t--AND dr.DeliveryStartTime_Date = @Today\r\n/************************************************************/\r\n\tSELECT @ReturnedRequestCount=COUNT( dr.ParcelReferenceCode)\r\n\tFROM #AllDispatchRequests dr\r\n        join dp.DispatchRequestStatus drs on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n        join dp.Polygon p1 on ps.PolygonId = p1.Id\r\n        --INNER JOIN @PolygonId p2\tON p1.Id = p2.Id\r\n        --JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        join dp.Store s on ps.StoreId = s.Id\r\n\r\n        where (\r\n                (DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n                OR\r\n                (DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\nAND dr.DeliveryDeadLineTime \u003E=@ToDate)\r\n\t\r\n/********************************************************/\r\n\t\t--SELECT\r\n\t\t--\t\t@ReturnedRequestCount = COUNT(dr.DispatchRequestId)\r\n  --      FROM #AllDispatchRequests dr\r\n\t\t--JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\t--JOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\t--WHERE ((sdp.OperationTypeId in (15))/*Return*/ or (OperationTypeId = 10 and DispatchRequestStatusId in (45,46)))\r\n\t\t--AND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t\t--AND getdate() \u003E DATEADD(SECOND,sdp.EstimatedDurationSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\r\n\t\tSELECT\r\n\t\t\t\t@DelayedDeliveryCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE sdp.OperationTypeId IN (10) \r\n\t\t--AND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t\tAND dr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\r\n/********************************UnassignedReturnAndReplacementRequestCount**************************************************/\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId = 5\r\n\t\tAND dr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70)\r\n\r\n\r\n    --############################################ Pre Calculate Result ##############################################\r\n        SELECT \r\n                    [dr].[Id],\r\n                    [dr].[DispatchRequestStatusId],\r\n                    drs.Title as StatusTitle,\r\n                    [dr].[ParcelReferenceCode],\r\n                    dr.CourierRequestTypeId,\r\n                    p1.CityId,\r\n                    ps.PolygonId,\r\n                    p1.Title as PolygonTitle,\r\n                    StoreId,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT s.[Location].STY  AS  StoreLocationLatitude\r\n\t\t\t\t\t)StoreLocationLatitude,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT s.[Location].STX  AS  StoreLocationLongitude\r\n\t\t\t\t\t)StoreLocationLongitude,\r\n                    s.Title as StoreTitle,\r\n                    dr.DeliveryStartTime,\r\n                    dr.DeliveryStartTimePersian,\r\n                    dr.DeliveryDeadLineTime,\r\n                    dr.DeliveryDeadLineTimePersian,\r\n                    dr.ClientAddress,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT dr.ClientLocation.STY  AS  ClientLocationLatitude\r\n\t\t\t\t\t)ClientLocationLatitude,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT dr.ClientLocation.STX  AS  ClientLocationLongitude\r\n\t\t\t\t\t)ClientLocationLongitude,\r\n                    (ISNULL(dr.AssignmentTryCount,0)--Select [dbo].[GetFleetPreAssignmentStateCount] (dr.Id)) \r\n                                          )as FleetPreAssignmentStateCount,\r\n                    dr.VendorParcelCode,\r\n                    dr.CreateDate,\r\n                    dr.CreateDatePersian,\r\n                    s.VendorId,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly\t\r\n\r\n        into #DispatchRequest\r\n        FROM dp.DispatchRequest dr\r\n        join dp.DispatchRequestStatus drs on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n\r\n        join dp.Polygon p1 on ps.PolygonId = p1.Id\r\n        join dp.Store s on ps.StoreId = s.Id\r\n\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        where DispatchRequestStatusId in (10,11,15,16)\r\n        and ((dr.DeliveryStartTime BETWEEN @StartDeliveryTime and @EndDeliveryTime or dr.DeliveryDeadLineTime BETWEEN @StartDeliveryTime and @EndDeliveryTime) or @StartDeliveryTime = 0 or @EndDeliveryTime = 0)\r\n        and ((s.Id IN (Select Id from @StoreId)) OR (@StoreIds=\u00270\u0027))\r\n        and (p1.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and ((dr.CourierRequestTypeId in (Select Id from @CourierRequestTypeId)) OR (@CourierRequestTypeIds = \u00270\u0027))\r\n        and (p1.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n        and (dr.ParcelReferenceCode = @ParcelReferenceCode OR @ParcelReferenceCode = 0)\r\n        and (dr.VendorParcelCode = @VendorParcelCode or @VendorParcelCode = \u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\tAND ( dr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\tAND ( dr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n---------------------------------------------------------------------------------------------------------------\r\n\r\n        select DISTINCT\r\n                    s.Id,\r\n                    s.ShipmentStatusId as StatusId,\r\n                    ss.Title as StatusTitle,\r\n                    ShipmentNumber,\r\n                    s.FleetId,\r\n                    dr.Id as DispatchRequestId,\r\n\t\t\t\t\ts2.EstimatedOperationTimeSeconds,\r\n\t\t\t\t\ts2.EstimatedArrivalTime,\r\n                    (SELECT\r\n                    \r\n             DATEDIFF(second,(DATEADD(SECOND,s2.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(s2.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))),GETDATE())                                           \r\n                                        )\t\t\t\t\r\n\t\t\t\t\t as FleetDelayTime\r\n        into #Shipment\r\n        from #DispatchRequest dr\r\n        join (\r\n                select \r\n                        top 1 with ties s3.DispatchRequestId, sdp.id \r\n                from #DispatchRequest dr \r\n                join dp.ShipmentDestinationPointDispatchRequest s3 on dr.id = s3.DispatchRequestId\r\n                join dp.ShipmentDestinationPoint sdp  on sdp.id = s3.ShipmentDestinationPointId and OperationTypeId = 5\r\n                order by ROW_NUMBER() over (partition by dr.id order by dr.id,sdp.id desc)\r\n            )sdp on sdp.DispatchRequestId = dr.id \r\n        join dp.ShipmentDestinationPoint s2 on sdp.id = s2.Id \r\n        join dp.Shipment s on s.id = s2.ShipmentId\r\n        join dp.ShipmentStatus ss on s.ShipmentStatusId = ss.Id;\r\n-----------------------------------------------------------------------------------\r\n        select distinct\r\n                    f.Id,\r\n                    DriverId,\r\n                    FirstName \u002B \u0027 \u0027 \u002B LastName as DriverName,\r\n                    d.Mobile as DriverMobile,\r\n                    v.VehicleTypeId,\r\n                    v.PlateNumber,\r\n                    s.Id as ShipmentId,\r\n                    s.DispatchRequestId\r\n\r\n        into #Fleet\r\n        from #Shipment s\r\n        join dp.Fleet f on s.FleetId = f.Id\r\n        join dp.Driver d on f.DriverId = d.Id\r\n        join dp.Vehicle v on f.VehicleId = v.Id\r\n\t\tWHERE ((f.Id=@FleetId)OR(@FleetId=0))\r\n\r\n    --############################################ Calculate Result ##############################################\r\n        select distinct\r\n                    [dr].[Id] DispatchRequestId,\r\n                    [dr].[DispatchRequestStatusId],\r\n                    [dr].[StatusTitle] as DispatchRequestStatusTitle,\r\n                    [dr].[ParcelReferenceCode],\r\n                    [dr].[CourierRequestTypeId],\r\n                    [dr].[CityId],\r\n                    [dr].[PolygonId],\r\n                    [dr].[PolygonTitle],\r\n                    [dr].[StoreId],\r\n                    [dr].[StoreLocationLatitude],\r\n                    dr.StoreLocationLongitude,\r\n                    [dr].[StoreTitle],\r\n                    FORMAT([dr].[DeliveryStartTime],\u0027####-##-## ##:##:##\\.###\u0027)\t\t\t\tDeliveryStartTimeStr,\r\n                    FORMAT([dr].[DeliveryStartTimePersian],\u0027####-##-## ##:##:##\\.###\u0027)\t\tDeliveryStartTimePersianStr,\r\n                    FORMAT([dr].[DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027)\t\t\tDeliveryDeadLineTimeStr,\r\n                    FORMAT([dr].[DeliveryDeadLineTimePersian],\u0027####-##-## ##:##:##\\.###\u0027)\tDeliveryDeadLineTimePersianStr,\r\n                    [dr].[ClientAddress],\r\n                    [dr].[ClientLocationLatitude],\r\n                    dr.ClientLocationLongitude,\r\n                    [dr].[FleetPreAssignmentStateCount],\r\n                    s.[FleetDelayTime],\r\n                    [dr].[VendorParcelCode],\r\n                    dr.CreateDate,\r\n                    FORMAT([dr].[CreateDatePersian],\u0027####-##-## ##:##:##\\.###\u0027)\t\t\t\tCreateDatePersianStr,\r\n                    VendorId,\r\n\r\n                    [s].[Id] as ShipmentId,\r\n                    [s].[StatusId] as ShipmentStatusId,\r\n                    [s].[StatusTitle] as ShipmentStatusTitle,\r\n                    [s].[ShipmentNumber],\r\n\r\n                    [f].[Id] FleetId,\r\n                    [f].[DriverId],\r\n                    [f].[DriverName],\r\n                    [f].[DriverMobile],\r\n                    [f].[VehicleTypeId],\r\n                    [f].[PlateNumber],\r\n\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tGETDATE() BETWEEN\r\n\t\t\t\t\t\t\tDATEADD(MINUTE,-1*@WarningToOperationOnDispatchRequestTimeMinutes,CAST(CONVERT(varchar, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds\u002B@WarningToOperationOnDispatchRequestTimeMinutes*60,CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\tWHEN GETDATE()\u003EDATEADD(MINUTE,@WarningToOperationOnDispatchRequestTimeMinutes,CAST(CONVERT(varchar, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\tTHEN 2\r\n\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\tEND PickupStatus,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly\r\n\t\tINTO #FinalResult\r\n        from #DispatchRequest dr\r\n        left join #Shipment s on dr.Id = s.DispatchRequestId\r\n        left join #Fleet f on s.DispatchRequestId = f.DispatchRequestId and s.Id = f.ShipmentId\r\n\r\n        where FleetDelayTime \u003E 0;\r\n\r\n\t\tSET @TotalCount = @@ROWCOUNT\r\n--------------------------------------------------------------------------------------\r\n\r\n\t\tselect * \r\n        from #FinalResult\r\n        ORDER by\t\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027DeliveryDeadLineTimeStr\u0027 AND @IsAsc = 1 THEN DeliveryDeadLineTimeStr\r\n\t\t\t\t\tEnd ASC,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027DeliveryDeadLineTimeStr\u0027 AND @IsAsc = 0 THEN DeliveryDeadLineTimeStr\r\n\t\t\t\t\tEnd DESC,\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027CreateDatePersianStr\u0027 AND @IsAsc = 1 THEN CreateDatePersianStr\r\n\t\t\t\t\tEnd ASC,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027CreateDatePersianStr\u0027 AND @IsAsc = 0 THEN CreateDatePersianStr\r\n\t\t\t\t\tEnd DESC,\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027FleetDelayTime\u0027 AND @IsAsc = 1 THEN FleetDelayTime\r\n\t\t\t\t\tEnd ASC,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\tWHEN (@OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027FleetDelayTime\u0027 AND @IsAsc = 0) OR (@OrderBy IS NULL OR @OrderBy = \u00270\u0027) THEN FleetDelayTime\r\n\t\t\t\t\tEnd DESC\r\n\t\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\r\n"},{"Name":"Get_DelayedPickedUp_By_Filter_HAMID","Schema":"dbo","Definition":"--#################################################################################################################################\r\n-- Stored Procedure\r\n\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/07/26\r\n--\tDescription:\tGet Returned List By Filter\r\n--\r\n--\t=======================================\r\n\r\n/*\r\n\tDECLARE\t@return_value int,\r\n\t\t\t@UnassignedDispatchRequestCount int,\r\n\t\t\t@AssignedDispatchRequestCount int,\r\n\t\t\t@ReturnedRequestCount int,\r\n\t\t\t@DelayedDeliveryCount int,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount int,\r\n\t\t\t@TotalCount\tINT\r\n\r\n\tEXEC\t@return_value = [dbo].[Get_DelayedPickedUp_By_Filter]\r\n\t\t\t@OrderBy = \u0027DeliveryDeadLineTimeStr\u0027,\r\n\t\t\t@IsAsc = 1,\r\n\t\t\t@UnassignedDispatchRequestCount = @UnassignedDispatchRequestCount OUTPUT,\r\n\t\t\t@AssignedDispatchRequestCount = @AssignedDispatchRequestCount OUTPUT,\r\n\t\t\t@ReturnedRequestCount = @ReturnedRequestCount OUTPUT,\r\n\t\t\t@DelayedDeliveryCount = @DelayedDeliveryCount OUTPUT,\r\n\t\t\r\n\t@UnassignedReturnAndReplacementRequestCount = @UnassignedReturnAndReplacementRequestCount OUTPUT,\r\n\t\t\t@TotalCount = @TotalCount OUTPUT,\r\n\t\t\t@PageIndex = 0,\r\n\t\t\t@PageSize = 100,\r\n\t\t\t@OperationStaffId = 42--\r\n\t\t\t                       ,@FleetId=4171\r\n\r\n\tSELECT\t@UnassignedDispatchRequestCount AS N\u0027@UnassignedDispatchRequestCount\u0027,\r\n\t\t\t@AssignedDispatchRequestCount AS N\u0027@AssignedDispatchRequestCount\u0027,\r\n\t\t\t@ReturnedRequestCount AS N\u0027@ReturnedRequestCount\u0027,\r\n\t\t\t@DelayedDeliveryCount AS N\u0027@DelayedDeliveryCount\u0027,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount AS N\u0027@UnassignedReturnAndReplacementRequestCount\u0027,\r\n\t\t\t@TotalCount AS N\u0027@TotalCount\u0027\r\n*/\r\nCREATE      PROCEDURE [dbo].[Get_DelayedPickedUp_By_Filter_HAMID]\r\n\t    --@ProvinceId\tSMALLINT = NULL,\r\n\t\t@CityIds VARCHAR(MAX) = NULL,\r\n        @PolygonIds VARCHAR(MAX) = NULL,\r\n        @StoreIds VARCHAR(MAX) = NULL,\r\n        @ParcelReferenceCode BIGINT = NULL,\r\n        @CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n        @StartDeliveryTime BIGINT = NULL,\r\n        @EndDeliveryTime BIGINT = NULL,\r\n        @VendorParcelCode VARCHAR(32) = NULL,\t\r\n\t\t@VendorId\t\tINT = NULL,\r\n\t\t@WarningToOperationOnDispatchRequestTimeMinutes SMALLINT = NULL,\t\t\r\n\t\t@FleetId INT = NULL,\r\n\t\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t\t@OrderCategoryIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n        @OrderBy NVARCHAR(200) = NULL,\r\n        @IsAsc BIT = NULL,\r\n\t\t@UnassignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@AssignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@ReturnedRequestCount INT = 0 OUTPUT,\r\n\t\t@DelayedDeliveryCount INT = 0 OUTPUT,\r\n\t\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t\t@NotPickUpRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t\t@OperationStaffId\t\t\t\t\t\t\tINT,\r\n\t\t@DeliveryServiceProviderIds\t \t \t \t\tVARCHAR(MAX)\t = NULL\r\n\r\n\r\nAS \r\n\tSET NOCOUNT ON;\r\n    --############################################ Preparation Data ##################################\r\n\tSET @IsExclusiveDelivery = NULL\r\n\tSET @IsNightly = NULL\r\n        drop table if EXISTS    #DispatchRequest,\r\n                                #Shipment,\r\n                                #Fleet,\r\n\t\t\t\t\t\t\t\t#FinalResult,\r\n\t\t\t\t\t\t\t\t#AllDispatchRequests\r\n        SELECT\r\n\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\t\t=ISNULL(@CityIds,\u00270\u0027),\r\n                @PolygonIds\t\t\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),\r\n                @StoreIds\t\t\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n                @ParcelReferenceCode\t\t\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n                @CourierRequestTypeIds\t\t\t\t\t\t\t=ISNULL(@CourierRequestTypeIds,0),\r\n                @StartDeliveryTime\t\t\t\t\t\t\t\t=ISNULL(@StartDeliveryTime,0),\r\n                @EndDeliveryTime\t\t\t\t\t\t\t\t=ISNULL(@EndDeliveryTime,0),\r\n                @VendorParcelCode\t\t\t\t\t\t\t\t=ISNULL(@VendorParcelCode,\u00270\u0027),\r\n\t\t\t\t@WarningToOperationOnDispatchRequestTimeMinutes =ISNULL(@WarningToOperationOnDispatchRequestTimeMinutes,0),\r\n\t\t\t\t@FleetId\t\t\t\t\t\t\t\t\t\t=ISNULL(@FleetId,0),\r\n                @IsAsc\t\t\t\t\t\t\t\t\t\t\t=ISNULL(@IsAsc,1),\r\n\t\t\t\t@VendorID\t\t\t\t\t\t\t\t\t\t=ISNULL(@VendorID,0),\r\n\t\t\t\t@DeliveryServiceProviderIds\t\t\t\t\t\t=ISNULL(@DeliveryServiceProviderIds,\u00270\u0027),\r\n\t\t\t\t@OrderCategoryIds = ISNULL(@OrderCategoryIds,\u00270\u0027)\r\n\r\n\t\tSELECT \r\n\t\t\tdsp.Id\r\n\t\tINTO #DeliveryServiceProviderId\r\n\t\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\t\tINNER JOIN string_split(@DeliveryServiceProviderIds,\u0027,\u0027) ss\r\n\t\t\tON dsp.Id = ss.value\r\n\t\t\tOR @DeliveryServiceProviderIds = \u00270\u0027\r\n\r\n\t\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t\t(\r\n\t\t\tId\r\n\t\t)\r\n\r\n\t\tDECLARE @CityId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CityId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\r\n  --      DECLARE @PolygonId TABLE\r\n\t\t--(\r\n\t\t--\tId SMALLINT\r\n\t\t--);\r\n\t\t--INSERT INTO @PolygonId\r\n\t\tSELECT \r\n\t\t\tp.Id\r\n\t\tINTO #PolygonId\r\n\t\tFROM DP.Polygon p WITH(NOLOCK)\r\n\t\tINNER JOIN string_split(@PolygonIds,\u0027,\u0027) ss\r\n\t\t\tON p.Id = ss.value\r\n\t\t\tOR @PolygonIds = \u00270\u0027;\r\n\r\n  --      DECLARE @StoreId TABLE\r\n\t\t--(\r\n\t\t--\tId SMALLINT\r\n\t\t--);\r\n\t\t--INSERT INTO @StoreId\r\n\t\tSELECT \r\n\t\t\ts.Id\r\n\t\tINTO #StoreId\r\n\t\tFROM DP.Store s WITH(NOLOCK)\r\n\t\tINNER JOIN string_split(@StoreIds,\u0027,\u0027) ss\r\n\t\t\tON s.Id = ss.value\r\n\t\t\tOR @StoreIds = \u00270\u0027;\r\n\r\n\t\tDECLARE @CourierRequestTypeId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t);\r\n\t\tINSERT INTO @CourierRequestTypeId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CourierRequestTypeIds,\u0027,\u0027);\r\n\r\n\t\tSELECT\r\n\t\t\toc.Id\r\n\t\tINTO #OrderCategoryId\r\n\t\tFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tINNER JOIN string_split(@OrderCategoryIds,\u0027,\u0027) ss\r\n\t\t\tON oc.Id = ss.value\r\n\t\t\tOR @OrderCategoryIds = \u00270\u0027\r\n\r\n\tDECLARE @Today INT,@Yesterday int\r\n\tSELECT @Today = CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\tselect @Yesterday = CAST(SUBSTRING(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT)\r\n\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\r\n\t; WITH CTE_DR AS \r\n\t(\r\n\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\tddr.DeliveryStartTime,\r\n\t\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\t\tddr.IsWaitingForSupport\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\tINNER JOIN #PolygonId PID\r\n\t\t\tON dp.ID = pID.Id\r\n\t\tWHERE ddr.DeliveryStartTime \u003E=@ToDate\r\n\t\tand (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\t\tAND (ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\tAND (ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\t\tAND (ddr.VendorId = @VendorID OR @VendorID = 0)\r\n\t)\r\n\tSELECT \r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT SQ.UnassignedDispatchRequestCount),\r\n\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT SQ.AssignedDispatchRequestCount),\r\n\t\t@ReturnedRequestCount = COUNT(DISTINCT SQ.ReturnedRequestCount),\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT SQ.UnassignedReturnAndReplacementRequestCount),\r\n\t\t@DelayedDeliveryCount = COUNT(DISTINCT SQ.DelayedDeliveryCount),\r\n\t\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE \r\n\t\t\t\tWHEN dr.DispatchRequestStatusId IN (5,6,7)  AND LEFT(DeliveryStartTime,8) IN(@Today,@Yesterday) --= @Today\r\n\t\t\t\tTHEN dr.DispatchRequestId \r\n\t\t\t\tELSE NULL \r\n\t\t\tEND AS UnassignedDispatchRequestCount,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54) \r\n\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\tELSE NULL \r\n\t\t\tEND AS AssignedDispatchRequestCount,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\t(DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n\t\t\t\t\t\tOR\r\n\t\t\t\t\t\t(DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\n\t\t\t\t\t\tAND dr.DeliveryDeadLineTime \u003E=@ToDate) \r\n\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\tELSE NULL \r\n\t\t\tEND AS ReturnedRequestCount,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t\tdr.DispatchRequestStatusId = 5\r\n\t\t\t\t\tAND dr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70)\r\n\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\tELSE NULL \r\n\t\t\tEND AS UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t\r\n\t\t\tNULL AS DelayedDeliveryCount,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t\tdr.IsWaitingForSupport = 1 \r\n\t\t\t\t\tAND dr.DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\tELSE NULL \r\n\t\t\tEND AS NotPickupRequestCount\r\n\t\t\t\r\n\t\tFROM CTE_DR dr\r\n\t\tUNION ALL\r\n\t\tSELECT\r\n\t\tNULL AS UnassignedDispatchRequestCount,\r\n\t\tNULL AS AssignedDispatchRequestCount,\r\n\t\tNULL AS ReturnedRequestCount,\r\n\t\tNULL AS UnassignedReturnAndReplacementRequestCount,\r\n\t\tCASE \r\n\t\t\t\tWHEN sdp.ID IS NOT NULL \r\n\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND AS DelayedDeliveryCount,\r\n\t\tNULL AS NotPickupRequestCount\r\n\t\tFROM CTE_DR dr\r\n\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId AND dr.DispatchRequestStatusId in (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\t\tINNER JOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId AND sdp.OperationTypeId = 10 AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= getdate() \r\n\t) SQ\r\n\t\t\r\n\r\n\t\r\n\tDECLARE @STR NVARCHAR(MAX) = \u0027\u0027\r\n\r\n\r\n\tSET @STR \u002B=\r\n\t\u0027 SELECT\r\n\t\tdr.Id DispatchRequestId,\r\n        dr.DispatchRequestStatusId,\r\n        drs.Title AS DispatchRequestStatusTitle,\r\n        dr.ParcelReferenceCode,\r\n        dr.CourierRequestTypeId,\r\n        p1.CityId,\r\n        ps.PolygonId,\r\n        p1.Title AS PolygonTitle,\r\n        StoreId,\r\n        s.[Location].STY  AS  StoreLocationLatitude,\r\n        s.[Location].STX  AS  StoreLocationLongitude,\r\n        s.Title AS StoreTitle,\r\n        dr.DeliveryStartTime,\r\n        dr.DeliveryStartTimePersian,\r\n        dr.DeliveryDeadLineTime,\r\n        dr.DeliveryDeadLineTimePersian,\r\n        dr.ClientAddress,\r\n        dr.ClientLocation.STY  AS  ClientLocationLatitude,\r\n        dr.ClientLocation.STX  AS  ClientLocationLongitude,\r\n        ISNULL(dr.AssignmentTryCount,0) AS FleetPreAssignmentStateCount,\r\n        dr.VendorParcelCode,\r\n        dr.CreateDate,\r\n        dr.CreateDatePersian,\r\n        dr.VendorId,\r\n\t\tdr.IsExclusiveDelivery,\r\n\t\tdr.IsNightly,\r\n\t\tdr.DeliveryServiceProviderId,\r\n\t\ts.OrderCategoryId,\r\n\t\toc.Title AS OrderCategoryTitle,\r\n\t\tdr.Version\u0027\u002B CASE WHEN @OrderBy = \u0027ETA\u0027 THEN \u0027,ETA\u0027 ELSE \u0027\u0027 END\u002B\u0027\r\n\tINTO #Output\r\n    FROM dp.DispatchRequest dr (NOLOCK)\r\n    INNER JOIN dp.DispatchRequestStatus drs (NOLOCK) \r\n\t\tON dr.DispatchRequestStatusId = drs.Id\r\n    INNER JOIN dp.PolygonStore ps (NOLOCK) \r\n\t\tON dr.PolygonStoreId = ps.Id\r\n    INNER JOIN dp.Polygon p1 (NOLOCK) \r\n\t\tON ps.PolygonId = p1.Id\r\n    INNER JOIN dp.Store s (NOLOCK) \r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\t\r\n\t\tON pos.PolygonId = p1.Id \r\n\t\tAND pos.IsActive = 1\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON dr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tON s.OrderCategoryId = oc.Id\u0027\r\n\r\n\tIF @OrderBy = \u0027ETA\u0027\r\n\t\tSET @STR \u002B=\r\n\t\t\u0027 CROSS APPLY\r\n\t\t( \r\n\t\t\tSELECT \r\n\t\t\t\tDATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME)) AS ETA\r\n\t\t\tFROM DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)  \r\n\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\tON sdp.id = sdpdr.ShipmentDestinationPointId\r\n\t\t\t\tAND OperationTypeId IN (5)\r\n\t\t\tINNER JOIN DP.Shipment s WITH(NOLOCK)\r\n\t\t\t\tON sdp.ShipmentID = s.Id\u0027 \u002B CASE WHEN @FleetID \u003C\u003E 0 THEN \u0027 s.FleetID = \u0027 \u002B CAST(@FleetId AS VARCHAR(MAX)) ELSE \u0027\u0027 END \u002B\r\n\t\t\t\u0027 WHERE dr.ID = sdpdr.DispatchRequestId\r\n\t\t\tAND dr.Version = sdpdr.Version\r\n\t\t\tAND DATEDIFF(second,(DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME))),GETDATE()) \u003E 0\r\n\t\t) ETA\u0027\r\n\r\n\tSET @STR \u002B=\r\n\t\u0027 WHERE DispatchRequestStatusId IN (10,11,15,16)\r\n\tAND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @OrderBy \u003C\u003E \u0027ETA\u0027 OR @OrderBy IS NULL\r\n\tSET @STR \u002B=\r\n\t\u0027 AND EXISTS \r\n\t( \r\n\t\tSELECT 1 FROM DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)  \r\n\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\tON sdp.id = sdpdr.ShipmentDestinationPointId\r\n\t\t\tAND OperationTypeId IN (5)\r\n\t\tINNER JOIN DP.Shipment s WITH(NOLOCK)\r\n\t\t\tON sdp.ShipmentID = s.Id\u0027 \u002B CASE WHEN @FleetID \u003C\u003E 0 THEN \u0027 s.FleetID = \u0027 \u002B CAST(@FleetId AS VARCHAR(MAX)) ELSE \u0027\u0027 END \u002B\r\n\t\t\u0027 WHERE dr.ID = sdpdr.DispatchRequestId\r\n\t\tAND dr.Version = sdpdr.Version\r\n\t\tAND DATEDIFF(second,(DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME))),GETDATE()) \u003E 0\r\n\t)\u0027\r\n\r\n\tIF @ParcelReferenceCode \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 dr.ParcelReferenceCode =\u0027\u002BCAST(@ParcelReferenceCode AS VARCHAR(MAX))\r\n\tIF @VendorParcelCode \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 dr.VendorParcelCode =\u0027\u0027\u0027\u002BCAST(@VendorParcelCode AS VARCHAR(MAX))\u002B\u0027\u0027\u0027\u0027\r\n\tIF @VendorId \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 dr.VendorId =\u0027\u002BCAST(@VendorId AS VARCHAR(MAX))\r\n\r\n\tIF @IsExclusiveDelivery IS NOT NULL\r\n\t\tSET @STR \u002B= \u0027 dr.IsExclusiveDelivery =\u0027\u002BCAST(@IsExclusiveDelivery AS VARCHAR(MAX))\r\n\tIF @IsNightly IS NOT NULL\r\n\t\tSET @STR \u002B= \u0027 dr.IsNightly =\u0027\u002BCAST(@IsNightly AS VARCHAR(MAX))\r\n\r\n\tIF @StartDeliveryTime \u003C\u003E 0 AND @EndDeliveryTime \u003C\u003E 0\r\n\t\tSET @STR \u002B= \u0027 AND (dr.DeliveryStartTime BETWEEN \u0027\u002BCAST(@StartDeliveryTime AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@EndDeliveryTime AS VARCHAR(MAX))\u002B\u0027 OR dr.DeliveryDeadLineTime BETWEEN \u0027\u002BCAST(@StartDeliveryTime AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@EndDeliveryTime AS VARCHAR(MAX))\u002B\u0027)\u0027\r\n\tIF @StoreIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND s.Id IN (\u0027\u002B@StoreIds\u002B\u0027)\u0027\r\n\tIF @PolygonIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND p1.Id IN (\u0027\u002B@PolygonIds\u002B\u0027)\u0027\r\n\tIF @CourierRequestTypeIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 AND dr.CourierRequestTypeId IN (\u0027\u002B@CourierRequestTypeIds\u002B\u0027)\u0027\r\n\tIF @CityIds \u003C\u003E \u00270\u0027\r\n\t\tSET @STR \u002B= \u0027 p1.CityId IN (\u0027\u002B@CityIds\u002B\u0027)\u0027\r\n\r\nSET @STR \u002B=\r\n\u0027 SET @TotalCount = @@ROWCOUNT\r\n\r\n;WITH CTE_OUTPUT AS\r\n(\r\n\tSELECT * FROM #Output\r\n\tORDER BY \u0027\u002BCASE WHEN @OrderBy IS NULL THEN \u0027 DeliveryStartTime\u0027 ELSE @OrderBy \u002B CASE WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 ELSE \u0027\u0027 END END \u002B \u0027\r\n\tOFFSET \u0027\u002BCAST(@pageIndex * @pageSize AS VARCHAR(MAX)) \u002B\u0027 ROWS FETCH NEXT \u0027\u002BCAST(@pageSize AS VARCHAR(MAX)) \u002B\u0027 ROWS ONLY\r\n),CTE_Shipment AS \r\n(\r\n\tSELECT * FROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\ts.Id ShipmentId,\r\n\t\t\ts.ShipmentStatusId,\r\n\t\t\tss.Title AS ShipmentStatusTitle,\r\n\t\t\tShipmentNumber,\r\n\t\t\ts.FleetId,\r\n\t\t\tf.DriverId,\r\n\t\t\td.FirstName \u002B \u0027\u0027 \u0027\u0027 \u002B d.LastName AS DriverName,\r\n\t\t\t\u0027\u00270\u0027\u0027\u002BCAST(d.Mobile AS VARCHAR(20)) AS DriverMobile,\r\n\t\t\tv.VehicleTypeId,\r\n\t\t\tv.PlateNumber,\r\n\t\t\tdr.DispatchRequestId AS DispatchRequestId,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\tDATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME)) AS ETA,\r\n\t\t\tDATEDIFF(second,(DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME))),GETDATE()) AS FleetDelayTime,\r\n\t\t\tROW_NUMBER() over (partition by dr.DispatchRequestId order by dr.DispatchRequestId,sdp.Id desc) RowNum\r\n\t\tfrom CTE_OUTPUT dr\r\n\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest s3 (NOLOCK)  \r\n\t\t\tON dr.DispatchRequestId = s3.DispatchRequestId\r\n\t\t\tAND dr.Version = s3.Version\r\n\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)   \r\n\t\t\tON sdp.id = s3.ShipmentDestinationPointId \r\n\t\t\tAND OperationTypeId IN (5)\r\n\t\tINNER JOIN dp.Shipment s (NOLOCK)  \r\n\t\t\tON s.id = sdp.ShipmentId\r\n\t\tINNER JOIN dp.ShipmentStatus ss (NOLOCK)  \r\n\t\t\tON s.ShipmentStatusId = ss.Id\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK) \r\n\t\t\tON s.FleetId = f.Id\r\n\t\tINNER JOIN CS_DriverManagement.DM.Driver d (NOLOCK) \r\n\t\t\tON f.DriverId = d.Id\r\n\t\tINNER JOIN CS_DriverManagement.DM.Vehicle v (NOLOCK) \r\n\t\t\tON f.VehicleId = v.Id\r\n\t) SQ\r\n\tWHERE SQ.RowNum = 1\r\n\r\n),CTE_DSPRM AS\r\n(\r\n\tSELECT \r\n\t\tdsprm.DispatchRequestId,\r\n\t\tdsprm.DeliveryServiceProviderOrderId\r\n\tFROM DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\tINNER JOIN CTE_OUTPUT dr\r\n\t\tON dsprm.DispatchRequestId = dr.DispatchRequestId\r\n\tWHERE dsprm.IsActive = 1\r\n)\r\nSELECT O.DispatchRequestId,\r\n       O.DispatchRequestStatusId,\r\n       O.DispatchRequestStatusTitle,\r\n       O.ParcelReferenceCode,\r\n       O.CourierRequestTypeId,\r\n       O.CityId,\r\n       O.PolygonId,\r\n       O.PolygonTitle,\r\n       O.StoreId,\r\n       O.StoreLocationLatitude,\r\n       O.StoreLocationLongitude,\r\n       O.StoreTitle,\r\n       FORMAT(O.DeliveryStartTime, \u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) DeliveryStartTimeStr,\r\n       FORMAT(O.DeliveryStartTimePersian, \u0027\u0027####/##/## ##:##:##\\.###\u0027\u0027) DeliveryStartTimePersianStr,\r\n       FORMAT(O.DeliveryDeadLineTime, \u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) DeliveryDeadLineTimeStr,\r\n       FORMAT(O.DeliveryDeadLineTimePersian, \u0027\u0027####/##/## ##:##:##\\.###\u0027\u0027) DeliveryDeadLineTimePersianStr,\r\n       O.ClientAddress,\r\n       O.ClientLocationLatitude,\r\n       O.ClientLocationLongitude,\r\n       O.FleetPreAssignmentStateCount,\r\n       FleetDelayTime,\r\n       O.VendorParcelCode,\r\n       O.CreateDate,\r\n       FORMAT(O.CreateDatePersian, \u0027\u0027####/##/## ##:##:##\\.###\u0027\u0027) CreateDatePersianStr,\r\n       O.VendorId,\r\n       s.ShipmentId,\r\n       s.ShipmentStatusId,\r\n       s.ShipmentStatusTitle,\r\n       s.ShipmentNumber,\r\n       s.FleetId,\r\n       s.DriverId,\r\n       s.DriverName,\r\n       s.DriverMobile,\r\n       s.VehicleTypeId,\r\n       s.PlateNumber,\r\n       CASE\r\n           WHEN GETDATE() BETWEEN DATEADD(MINUTE, -1*\u0027\u002BCAST(@WarningToOperationOnDispatchRequestTimeMinutes AS VARCHAR(MAX))\u002B\u0027, CAST(CONVERT(varchar, FORMAT(O.DeliveryDeadLineTime, \u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027), 120) AS DATETIME)) AND DATEADD(SECOND, EstimatedOperationTimeSeconds\u002B\u0027\u002BCAST(@WarningToOperationOnDispatchRequestTimeMinutes AS VARCHAR(MAX))\u002B\u0027*60, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime, \u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027), 120) AS DATETIME)) THEN 1\r\n           WHEN GETDATE()\u003EDATEADD(MINUTE, \u0027\u002BCAST(@WarningToOperationOnDispatchRequestTimeMinutes AS VARCHAR(MAX))\u002B\u0027, CAST(CONVERT(varchar, FORMAT(O.DeliveryDeadLineTime, \u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027), 120) AS DATETIME)) THEN 2\r\n           ELSE 0\r\n       END PickupStatus,\r\n       O.IsExclusiveDelivery,\r\n       O.IsNightly,\r\n       O.DeliveryServiceProviderId,\r\n       DeliveryServiceProviderOrderId,\r\n       O.orderCategoryId,\r\n       O.orderCategoryTitle,\r\n       FORMAT(ETA, \u0027\u0027yyyy/MM/dd HH:mm:ss\u0027\u0027, \u0027\u0027fa\u0027\u0027) ETA,\r\n       O.Version,\r\n       drsh.TimeIntervalChangeStatus\r\nFROM CTE_OUTPUT o \r\nLEFT JOIN CTE_Shipment s \r\n\tON o.DispatchRequestId = s.DispatchRequestId\r\nLEFT JOIN CTE_DSPRM dsprm\r\n\tON o.DispatchRequestId = dsprm.DispatchRequestId\r\nOUTER APPLY \r\n(\r\n\tSELECT TOP 1 WITH TIES\r\n\t\tDATEDIFF(MINUTE,CAST(CONVERT(varchar, FORMAT(drsh.CreateDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027),120) AS DATETIME),GETDATE()) TimeIntervalChangeStatus\r\n\tFROM DP.DispatchRequestStatusHistory drsh WITH(NOLOCK)\r\n\tWHERE drsh.DispatchRequestId = o.DispatchRequestId\r\n\tORDER BY ROW_NUMBER() OVER ( ORDER BY drsh.CreateDate DESC , drsh.ID DESC )\r\n) DRSH\r\nORDER BY \u0027\u002BCASE WHEN @OrderBy IS NULL THEN \u0027 DeliveryStartTime\u0027 ELSE @OrderBy \u002B CASE WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 ELSE \u0027\u0027 END END \r\n\r\n\r\n\r\n\r\n\r\n\t--SELECT @STR\r\n\tDECLARE @Param NVARCHAR(MAX) = \u0027 @TotalCount INT OUTPUT\u0027\r\n\tEXEC sys.sp_executesql @STR,@Param , @TotalCount = @TotalCount OUTPUT\r\n\t/*\r\n\tRETURN\r\n\r\n\r\n\t; WITH CTE_DR AS\r\n\t(\r\n        SELECT \r\n                    [dr].[Id],\r\n                    [dr].[DispatchRequestStatusId],\r\n                    drs.Title AS StatusTitle,\r\n                    [dr].[ParcelReferenceCode],\r\n                    dr.CourierRequestTypeId,\r\n                    p1.CityId,\r\n                    ps.PolygonId,\r\n                    p1.Title AS PolygonTitle,\r\n                    StoreId,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT s.[Location].STY  AS  StoreLocationLatitude\r\n\t\t\t\t\t)StoreLocationLatitude,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT s.[Location].STX  AS  StoreLocationLongitude\r\n\t\t\t\t\t)StoreLocationLongitude,\r\n                    s.Title AS StoreTitle,\r\n                    dr.DeliveryStartTime,\r\n                    dr.DeliveryStartTimePersian,\r\n                    dr.DeliveryDeadLineTime,\r\n                    dr.DeliveryDeadLineTimePersian,\r\n                    dr.ClientAddress,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT dr.ClientLocation.STY  AS  ClientLocationLatitude\r\n\t\t\t\t\t)ClientLocationLatitude,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT dr.ClientLocation.STX  AS  ClientLocationLongitude\r\n\t\t\t\t\t)ClientLocationLongitude,\r\n                    (ISNULL(dr.AssignmentTryCount,0)--Select [dbo].[GetFleetPreAssignmentStateCount] (dr.Id)) \r\n                                          )AS FleetPreAssignmentStateCount,\r\n                    dr.VendorParcelCode,\r\n                    dr.CreateDate,\r\n                    dr.CreateDatePersian,\r\n                    dr.VendorId,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\t\t\ts.OrderCategoryId,\r\n\t\t\t\t\toc.Title AS OrderCategoryTitle,\r\n\t\t\t\t\tdr.Version\r\n        FROM dp.DispatchRequest dr (NOLOCK)\r\n        JOIN dp.DispatchRequestStatus drs (NOLOCK) ON dr.DispatchRequestStatusId = drs.Id\r\n        JOIN dp.PolygonStore ps (NOLOCK) ON dr.PolygonStoreId = ps.Id\r\n\r\n        JOIN dp.Polygon p1 (NOLOCK) ON ps.PolygonId = p1.Id\r\n        JOIN dp.Store s (NOLOCK) ON ps.StoreId = s.Id\r\n\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\tON dr.DeliveryServiceProviderId = dspID.Id\r\n\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\t\tON s.OrderCategoryId = oc.Id\r\n\t\tINNER JOIN #StoreId SID\r\n\t\t\tON s.ID = SID.Id\r\n\t\tINNER JOIN #PolygonId PID\r\n\t\t\tON p1.ID = pID.Id\r\n\t where DispatchRequestStatusId in (10,11,15,16)\r\n        and ((dr.DeliveryStartTime BETWEEN @StartDeliveryTime and @EndDeliveryTime or dr.DeliveryDeadLineTime BETWEEN @StartDeliveryTime and @EndDeliveryTime) or @StartDeliveryTime = 0 or @EndDeliveryTime = 0)\r\n        --and ((s.Id IN (Select Id from @StoreId)) OR (@StoreIds=\u00270\u0027))\r\n        --and (p1.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and ((dr.CourierRequestTypeId in (Select Id from @CourierRequestTypeId)) OR (@CourierRequestTypeIds = \u00270\u0027))\r\n        and (p1.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n        and (dr.ParcelReferenceCode = @ParcelReferenceCode OR @ParcelReferenceCode = 0)\r\n        and (dr.VendorParcelCode = @VendorParcelCode or @VendorParcelCode = \u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\t\tAND ( dr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\tAND ( dr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\t\tAND ( dr.VendorId = @VendorID OR @VendorID = 0)\r\n\t), CTE_Shipment AS \r\n\t(\r\n\r\n\t\t\tSELECT * FROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\ts.Id,\r\n                    s.ShipmentStatusId AS StatusId,\r\n                    ss.Title AS StatusTitle,\r\n                    ShipmentNumber,\r\n                    s.FleetId,\r\n                    dr.Id AS DispatchRequestId,\r\n\t\t\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\t\t\tDATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) AS ETA,\r\n                    (SELECT\r\n                    \r\n\t\t\t\t\t\tDATEDIFF(second,(DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))),GETDATE())                                           \r\n                                        )\t\t\t\t\r\n\t\t\t\t\t AS FleetDelayTime,\r\n\t\t\t\t\tROW_NUMBER() over (partition by dr.id order by dr.id,sdp.id desc) RowNum\r\n\t\t\t\tfrom CTE_DR dr\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest s3 (NOLOCK)  ON dr.id = s3.DispatchRequestId\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)   ON sdp.id = s3.ShipmentDestinationPointId and OperationTypeId IN(5)\r\n\t\t\t\tINNER JOIN dp.Shipment s (NOLOCK)  ON s.id = sdp.ShipmentId\r\n\t\t\t\tINNER JOIN dp.ShipmentStatus ss (NOLOCK)  ON s.ShipmentStatusId = ss.Id\r\n\t\t\t) SQ\r\n\t\t\tWHERE SQ.RowNum = 1\r\n\r\n\t),CTE_Fleet AS \r\n\t(\r\n-----------------------------------------------------------------------------------\r\n        select distinct\r\n                    f.Id,\r\n                    DriverId,\r\n                    FirstName \u002B \u0027 \u0027 \u002B LastName AS DriverName,\r\n                    \u00270\u0027\u002BCAST(d.Mobile AS VARCHAR(20)) AS DriverMobile,\r\n                    v.VehicleTypeId,\r\n                    v.PlateNumber,\r\n                    s.Id AS ShipmentId,\r\n                    s.DispatchRequestId\r\n        from CTE_Shipment s\r\n        JOIN CS_DriverManagement.DM.Fleet f (NOLOCK) ON s.FleetId = f.Id\r\n        JOIN CS_DriverManagement.DM.Driver d (NOLOCK) ON f.DriverId = d.Id\r\n        JOIN CS_DriverManagement.DM.Vehicle v (NOLOCK) ON f.VehicleId = v.Id\r\n\t\tWHERE ((f.Id=@FleetId)OR(@FleetId=0))\r\n\t),CTE_DSPRM AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tdsprm.DispatchRequestId,\r\n\t\t\tdsprm.DeliveryServiceProviderOrderId\r\n\t\tFROM DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\t\tINNER JOIN CTE_DR dr\r\n\t\t\tON dsprm.DispatchRequestId = dr.Id\r\n\t\tWHERE dsprm.IsActive = 1\r\n\t)\r\n    --############################################ Calculate Result ##############################################\r\n        select \r\n                    [dr].[Id] DispatchRequestId,\r\n                    [dr].[DispatchRequestStatusId],\r\n                    [dr].[StatusTitle] AS DispatchRequestStatusTitle,\r\n                    [dr].[ParcelReferenceCode],\r\n                    [dr].[CourierRequestTypeId],\r\n                    [dr].[CityId],\r\n                    [dr].[PolygonId],\r\n                    [dr].[PolygonTitle],\r\n                    [dr].[StoreId],\r\n                    [dr].[StoreLocationLatitude],\r\n                    dr.StoreLocationLongitude,\r\n                    [dr].[StoreTitle],\r\n                    [dr].[DeliveryStartTime],\r\n                    [dr].[DeliveryStartTimePersian],\r\n                    [dr].[DeliveryDeadLineTime],\r\n                    [dr].[DeliveryDeadLineTimePersian],\r\n                    [dr].[ClientAddress],\r\n                    [dr].[ClientLocationLatitude],\r\n                    dr.ClientLocationLongitude,\r\n                    [dr].[FleetPreAssignmentStateCount],\r\n                    s.[FleetDelayTime],\r\n                    [dr].[VendorParcelCode],\r\n                    dr.CreateDate,\r\n                    [dr].[CreateDatePersian],\r\n                    VendorId,\r\n\r\n                    [s].[Id] AS ShipmentId,\r\n                    [s].[StatusId] AS ShipmentStatusId,\r\n                    [s].[StatusTitle] AS ShipmentStatusTitle,\r\n                    [s].[ShipmentNumber],\r\n\r\n                    [f].[Id] FleetId,\r\n                    [f].[DriverId],\r\n                    [f].[DriverName],\r\n                    [f].[DriverMobile],\r\n                    [f].[VehicleTypeId],\r\n                    [f].[PlateNumber],\r\n\r\n\t\t\t\t\tEstimatedOperationTimeSeconds,\r\n\t\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\t\tIsExclusiveDelivery,\r\n\t\t\t\t\tIsNightly,\r\n\t\t\t\t\tDeliveryServiceProviderId,\r\n\t\t\t\t\tdsprm.DeliveryServiceProviderOrderId,\r\n\t\t\t\t\tdr.orderCategoryId,\r\n\t\t\t\t\tdr.orderCategoryTitle,\r\n\t\t\t\t\tdr.Version,\r\n\t\t\t\t\ts.ETA\r\n\t\tINTO #FinalResult\r\n        from CTE_DR dr\r\n        left JOIN CTE_Shipment s ON dr.Id = s.DispatchRequestId\r\n        left JOIN CTE_Fleet f  ON s.DispatchRequestId = f.DispatchRequestId and s.Id = f.ShipmentId\r\n\t\tLEFT JOIN CTE_DSPRM dsprm\r\n\t\t\tON dr.Id = dsprm.DispatchRequestId\r\n        where FleetDelayTime \u003E 0\r\n\t\tOPTION(RECOMPILE)\r\n\t\tSET @TotalCount = @@ROWCOUNT\r\n--------------------------------------------------------------------------------------\r\n\r\n\t\tselect \r\n\t\t\tDispatchRequestId\t\t\t\t,\r\n\t\t\tDispatchRequestStatusId\t\t\t,\r\n\t\t\tDispatchRequestStatusTitle\t\t,\r\n\t\t\tParcelReferenceCode\t\t\t\t,\r\n\t\t\tCourierRequestTypeId\t\t\t,\r\n\t\t\tCityId\t\t\t\t\t\t\t,\r\n\t\t\tPolygonId\t\t\t\t\t\t,\r\n\t\t\tPolygonTitle\t\t\t\t\t,\r\n\t\t\tStoreId\t\t\t\t\t\t\t,\r\n\t\t\tStoreLocationLatitude\t\t\t,\r\n\t\t\tStoreLocationLongitude\t\t\t,\r\n\t\t\tStoreTitle\t\t\t\t\t\t,\r\n            FORMAT([DeliveryStartTime],\u0027####-##-## ##:##:##\\.###\u0027)\t\t\t\tDeliveryStartTimeStr,\r\n            FORMAT([DeliveryStartTimePersian],\u0027####/##/## ##:##:##\\.###\u0027)\t\tDeliveryStartTimePersianStr,\r\n            FORMAT([DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027)\t\t\tDeliveryDeadLineTimeStr,\r\n            FORMAT([DeliveryDeadLineTimePersian],\u0027####/##/## ##:##:##\\.###\u0027)\tDeliveryDeadLineTimePersianStr,\r\n\t\t\tClientAddress\t\t\t\t\t,\r\n\t\t\tClientLocationLatitude\t\t\t,\r\n\t\t\tClientLocationLongitude\t\t\t,\r\n\t\t\tFleetPreAssignmentStateCount\t,\r\n\t\t\tFleetDelayTime\t\t\t\t\t,\r\n\t\t\tVendorParcelCode\t\t\t\t,\r\n\t\t\tCreateDate\t\t\t\t\t\t,\r\n\t\t\tFORMAT([CreateDatePersian],\u0027####/##/## ##:##:##\\.###\u0027)\t\t\t\tCreateDatePersianStr,\r\n\t\t\tVendorId\t\t\t\t\t\t,\r\n\t\t\tShipmentId\t\t\t\t\t\t,\r\n\t\t\tShipmentStatusId\t\t\t\t,\r\n\t\t\tShipmentStatusTitle\t\t\t\t,\r\n\t\t\tShipmentNumber\t\t\t\t\t,\r\n\t\t\tFleetId\t\t\t\t\t\t\t,\r\n\t\t\tDriverId\t\t\t\t\t\t,\r\n\t\t\tDriverName\t\t\t\t\t\t,\r\n\t\t\tDriverMobile\t\t\t\t\t,\r\n\t\t\tVehicleTypeId\t\t\t\t\t,\r\n\t\t\tPlateNumber\t\t\t\t\t\t,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t\tGETDATE() BETWEEN\r\n\t\t\t\t\tDATEADD(MINUTE,-1*@WarningToOperationOnDispatchRequestTimeMinutes,CAST(CONVERT(varchar, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\tAND\r\n\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds\u002B@WarningToOperationOnDispatchRequestTimeMinutes*60,CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\tTHEN 1\r\n\t\t\t\tWHEN GETDATE()\u003EDATEADD(MINUTE,@WarningToOperationOnDispatchRequestTimeMinutes,CAST(CONVERT(varchar, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\tTHEN 2\r\n\t\t\t\tELSE 0\r\n\t\t\tEND PickupStatus,\r\n\t\t\tIsExclusiveDelivery,\r\n\t\t\tIsNightly,\r\n\t\t\tDeliveryServiceProviderId,\r\n\t\t\tDeliveryServiceProviderOrderId,\r\n\t\t\torderCategoryId,\r\n\t\t\torderCategoryTitle,\r\n\t\t\tFORMAT(fr.ETA,\u0027yyyy/MM/dd HH:mm:ss\u0027,\u0027fa\u0027) ETA,\r\n\t\t\tfr.Version,\r\n\t\t\tdrsh.TimeIntervalChangeStatus\r\n        from #FinalResult fr\r\n\t\tOUTER APPLY \r\n\t\t(\r\n\t\t\tSELECT TOP 1 WITH TIES\r\n\t\t\t\tDATEDIFF(MINUTE,CAST(CONVERT(varchar, FORMAT(drsh.CreateDate,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME),GETDATE()) TimeIntervalChangeStatus\r\n\t\t\tFROM DP.DispatchRequestStatusHistory drsh WITH(NOLOCK)\r\n\t\t\tWHERE drsh.DispatchRequestId = fr.DispatchRequestId\r\n\t\t\tORDER BY ROW_NUMBER() OVER ( ORDER BY CreateDate DESC , ID DESC )\r\n\t\t) DRSH\r\n        ORDER by\t\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027ETA\u0027 AND @IsAsc = 1 THEN ETA\r\n\t\t\t\t\tEnd ASC,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027ETA\u0027 AND @IsAsc = 0 THEN ETA\r\n\t\t\t\t\tEnd DESC,\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027DeliveryStartTime\u0027 AND @IsAsc = 1 THEN DeliveryStartTime\r\n\t\t\t\t\tEnd ASC,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027DeliveryStartTime\u0027 AND @IsAsc = 0 THEN DeliveryStartTime\r\n\t\t\t\t\tEnd DESC/*,\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027FleetDelayTime\u0027 AND @IsAsc = 1 THEN FleetDelayTime\r\n\t\t\t\t\tEnd ASC,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\tWHEN (@OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027FleetDelayTime\u0027 AND @IsAsc = 0) OR (@OrderBy IS NULL OR @OrderBy = \u00270\u0027) THEN FleetDelayTime\r\n\t\t\t\t\tEnd DESC*/\r\n\t\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\r\n\r\n\t\t*/\r\n\tSET @DelayedDeliveryCount\t\t\t\t\t\t = ISNULL(@DelayedDeliveryCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\n\r\n\r\n"},{"Name":"Get_Dispatch_Count","Schema":"dbo","Definition":"\r\nCREATE PROCEDURE [dbo].[Get_Dispatch_Count]\r\nas\r\nBEGIN\r\n SET NOCOUNT ON \r\n\tDROP TABLE IF EXISTS #GetStateCount\t \r\n\r\nselect   \r\n   [dbo].[GetFleetPreAssignmentStateCount](d.Id)as countassign,d.id,d.dispatchrequeststatusid \r\n  into #GetStateCount\r\n  from [CS_Dispatcher].[DP].[DispatchRequest] d   WITH(NOLOCK)\r\nwhere d.dispatchrequeststatusid in (10,11,15,16,17,20,25,45,46,50,51,65,70,47,48,49,52,53,54) and d.AssignmentTryCount is null\r\n\r\n\r\n\r\nupdate   dr  set dr.AssignmentTryCount=gsc.countassign \r\n from [DP].[DispatchRequest] dr  WITH(NOLOCK) inner join  #GetStateCount gsc\r\non dr.[Id]=gsc.id\r\n\r\n\r\n--and \r\n--select  [dbo].[GetFleetPreAssignmentStateCount](dr.DispatchRequestId)\r\n\r\nEND\r\n\r\n"},{"Name":"Get_DispatchRequest_3PLProneReverse","Schema":"dbo","Definition":"\r\n\r\nCREATE  PROC [dbo].[Get_DispatchRequest_3PLProneReverse]\r\n\r\nAS\r\nRETURN\r\nDECLARE @Config SMALLINT = (SELECT [Value] FROM CS_Public.HAF.Setting WHERE Name = \u0027Provider3plConfig.AssignTresholdForReturnToZap\u0027)\r\n\r\nDECLARE @Last2Days BIGINT = FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027\r\n\r\n--SELECT \r\n--\tdsprm.DispatchRequestId,\r\n--\tdsprm.DeliveryServiceProviderId,\r\n--\tdsprm.DeliveryServiceProviderOrderId,\r\n--\tdr.ParcelReferenceCode\r\n--FROM DP.DispatchRequest dr (NOLOCK)\r\n--INNER JOIN DP.DeliveryServiceProviderRequestMapper dsprm(NOLOCK)\r\n--\tON dr.ID = dsprm.DispatchRequestId\r\n--\tAND dsprm.IsActive = 1\r\n--\tAND dsprm.CreateDate \u003E 0\r\n--\tAND dr.DispatchRequestStatusId IN ( 5,7 )\r\n--\tAND dsprm.CreateDate \u003E= @Last2Days\r\n--\tAND dsprm.DeliveryServiceProviderId \u003C\u003E 1\r\n--INNER JOIN DP.PolygonStore ps (NOLOCK)\r\n--\tON dr.PolygonStoreId = ps.Id\r\n--INNER JOIN DP.StoreAvailableServiceProvider sasp (NOLOCK)\r\n--\tON ps.StoreId = sasp.StoreId\r\n--\tAND sasp.DeliveryServiceProviderId = 1\r\n--INNER JOIN CS_OrderManagement.OM.Parcel pcl (NOLOCK)\r\n--\tON dr.ParcelReferenceCode = pcl.ParcelReferenceCode\r\n--INNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n--\tON pcl.CourierRequestId = cr.Id\r\n--INNER JOIN DP.StoreTechnicalBasicInformation stbi (NOLOCK)\r\n--\tON ps.StoreId = stbi.StoreId\r\n--WHERE DATEDIFF(MINUTE,FORMAT(dsprm.CreateDate,\u0027####/##/## ##:##:##\\.###\u0027),GETDATE()) \u003E stbi.TimeThresholdForReverseToZap\r\n--AND cr.DistanceToClientMeter \u003C= stbi.DistanceThresholdToChangeServiceProvider\r\n\r\n\r\n\r\n\r\n"},{"Name":"Get_DispatchRequest_SendTo3PLProne","Schema":"dbo","Definition":"\r\nCREATE   PROC [dbo].[Get_DispatchRequest_SendTo3PLProne]\r\n\r\nAS\r\nSET NOCOUNT ON\r\nRETURN\r\nDROP TABLE IF EXISTS #PolygonID,#PCO21,#PCO19,#PCO20\r\n\r\nDECLARE @3DaysAgo BIGINT\r\n\r\nSELECT @3DaysAgo = FORMAT(GETDATE()-3,\u0027yyyMMdd\u0027)\u002B\u0027000000000\u0027\r\n\r\nSELECT DISTINCT\tp.Id\r\nINTO #PolygonID\r\nFROM  DP.Polygon p\r\nWHERE p.CityId in (SELECT distinct [CityId] \r\n  FROM [DP].[CityAvailableServiceProvider] with(nolock)\r\n  where DeliveryServiceProviderId \u003C\u003E 1)\r\n\r\n\r\nSELECT DISTINCT\r\n\tDeliveryServiceProviderId,\r\n\tParcelReferenceCode\r\nFROM\r\n(\r\n\tSELECT \r\n\t\tstbi.SupportDeliveryServiceProviderId AS DeliveryServiceProviderId,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.DeliveryServiceProviderId AS DeliveryServiceProviderId_Source,\r\n\t\tstbi.SupportDeliveryServiceProviderId AS DeliveryServiceProviderId_Destination\r\n\tFROM DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\tINNER JOIN #PolygonID pID\r\n\t\tON ps.PolygonId = pID.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi (NOLOCK)\r\n\t\tON ps.StoreId = stbi.StoreId\r\n\tINNER JOIN CS_OrderManagement.OM.Parcel pcl (NOLOCK)\r\n\t\tON dr.ParcelReferenceCode = pcl.ParcelReferenceCode\r\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\tON pcl.CourierRequestId = cr.Id\r\n\tWHERE \r\n\t\tdr.DispatchRequestStatusId IN ( 5,6,7 )\r\n\tAND dr.CourierRequestTypeId IN ( 5,15 )\r\n\tAND dr.IsAssignableTo3pl = 1\r\n\tAND dr.DeliveryServiceProviderId = 1\r\n\tAND dr.CreateDate \u003E= @3DaysAgo\r\n\tAND cr.ConfirmationDate IS NOT NULL\r\n\tAND dr.DeliveryServiceProviderId \u003C\u003E stbi.SupportDeliveryServiceProviderId\r\n\tAND cr.DistanceToClientMeter \u003E stbi.DistanceThresholdToChangeServiceProvider\r\n\tUNION ALL\r\n\tSELECT\r\n\t\tstbi.SupportDeliveryServiceProviderId AS DeliveryServiceProviderId,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.DeliveryServiceProviderId AS DeliveryServiceProviderId_Source,\r\n\t\tstbi.SupportDeliveryServiceProviderId AS DeliveryServiceProviderId_Destination\r\n\tFROM DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n    INNER JOIN DP.Store s (NOLOCK)\r\n        ON ps.StoreId = s.ID\r\n\tINNER JOIN #PolygonID pID\r\n\t\tON ps.PolygonId = pID.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi (NOLOCK)\r\n\t\tON ps.StoreId = stbi.StoreId\r\n\tINNER JOIN CS_OrderManagement.OM.Parcel pcl (NOLOCK)\r\n\t\tON dr.ParcelReferenceCode = pcl.ParcelReferenceCode\r\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\tON pcl.CourierRequestId = cr.Id\r\n    LEFT JOIN DP.StoreAvailableServiceProvider sasp (NOLOCK)\r\n        ON s.ID = sasp.StoreId\r\n        AND sasp.IsActive = 1\r\n        AND sasp.DeliveryServiceProviderId = 1\r\n\tWHERE \r\n\t\tdr.DispatchRequestStatusId IN ( 5,6,7 )\r\n\tAND dr.CourierRequestTypeId IN ( 5,15 )\r\n\tAND dr.IsAssignableTo3pl = 1\r\n\tAND dr.DeliveryServiceProviderId = 1\r\n\tAND dr.CreateDate \u003E= @3DaysAgo\r\n\tAND cr.ConfirmationDate IS NOT NULL\r\n\tAND dr.DeliveryServiceProviderId \u003C\u003E stbi.SupportDeliveryServiceProviderId \r\n\tAND DATEADD(MINUTE, stbi.TimeThresholdToChangeServiceProvider,CAST(CONVERT(varchar,FORMAT(dr.DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C GETDATE() \r\n    AND sasp.ID IS NULL\r\n\r\n    UNION ALL\r\n\tSELECT\r\n\t\tstbi.SupportDeliveryServiceProviderId AS DeliveryServiceProviderId,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.DeliveryServiceProviderId AS DeliveryServiceProviderId_Source,\r\n\t\tstbi.SupportDeliveryServiceProviderId AS DeliveryServiceProviderId_Destination\r\n\tFROM DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n    INNER JOIN DP.Store s (NOLOCK)\r\n        ON ps.StoreId = s.ID\r\n\tINNER JOIN #PolygonID pID\r\n\t\tON ps.PolygonId = pID.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi (NOLOCK)\r\n\t\tON ps.StoreId = stbi.StoreId\r\n\tINNER JOIN CS_OrderManagement.OM.Parcel pcl (NOLOCK)\r\n\t\tON dr.ParcelReferenceCode = pcl.ParcelReferenceCode\r\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\tON pcl.CourierRequestId = cr.Id\r\n    LEFT JOIN DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n        ON dr.Id = dsprm.DispatchRequestId\r\n\tWHERE \r\n\t\tdr.DispatchRequestStatusId IN ( 5,6,7 )\r\n\tAND dr.CourierRequestTypeId IN ( 5,15 )\r\n\tAND dr.IsAssignableTo3pl = 1\r\n\tAND dr.DeliveryServiceProviderId = 1\r\n\tAND dr.CreateDate \u003E= @3DaysAgo\r\n\tAND cr.ConfirmationDate IS NOT NULL\r\n\tAND dr.DeliveryServiceProviderId \u003C\u003E stbi.SupportDeliveryServiceProviderId \r\n\tAND DATEADD(MINUTE, stbi.TimeThresholdToChangeServiceProvider,CAST(CONVERT(varchar,FORMAT(dr.DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C GETDATE() \r\n    AND dsprm.ID IS NULL\r\n\r\n    UNION ALL\r\n    SELECT \r\n        DeliveryServiceProviderId,\r\n        ParcelReferenceCode,\r\n        DeliveryServiceProviderId_Source,\r\n        DeliveryServiceProviderId_Destination\r\n    FROM\r\n    (\r\n        SELECT TOP 1 WITH TIES\r\n            stbi.SupportDeliveryServiceProviderId AS DeliveryServiceProviderId,\r\n            dr.ParcelReferenceCode,\r\n            dr.DeliveryServiceProviderId AS DeliveryServiceProviderId_Source,\r\n            stbi.SupportDeliveryServiceProviderId AS DeliveryServiceProviderId_Destination,\r\n            stbi.TimeThresholdForResendTo3PL,\r\n            dsprm.UpdateDate\r\n        FROM DP.DispatchRequest dr (NOLOCK)\r\n        INNER JOIN DP.PolygonStore ps (NOLOCK)\r\n            ON dr.PolygonStoreId = ps.Id\r\n        INNER JOIN DP.Store s (NOLOCK)\r\n            ON ps.StoreId = s.ID\r\n        INNER JOIN #PolygonID pID\r\n            ON ps.PolygonId = pID.Id\r\n        INNER JOIN DP.StoreTechnicalBasicInformation stbi (NOLOCK)\r\n            ON ps.StoreId = stbi.StoreId\r\n        INNER JOIN CS_OrderManagement.OM.Parcel pcl (NOLOCK)\r\n            ON dr.ParcelReferenceCode = pcl.ParcelReferenceCode\r\n        INNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n            ON pcl.CourierRequestId = cr.Id\r\n        INNER JOIN DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n            ON dr.Id = dsprm.DispatchRequestId\r\n        WHERE \r\n            dr.DispatchRequestStatusId IN ( 5,6,7 )\r\n        AND dr.CourierRequestTypeId IN ( 5,15 )\r\n        AND dr.IsAssignableTo3pl = 1\r\n        AND dr.DeliveryServiceProviderId = 1\r\n        AND dr.CreateDate \u003E= @3DaysAgo\r\n        AND cr.ConfirmationDate IS NOT NULL\r\n        AND dr.DeliveryServiceProviderId \u003C\u003E stbi.SupportDeliveryServiceProviderId \r\n        ORDER BY ROW_NUMBER() OVER (PARTITION BY dr.ParcelReferenceCode ORDER BY dsprm.UpdateDate DESC)\r\n    ) SQ\r\n\tWHERE DATEDIFF(MINUTE,CAST(CONVERT(varchar,FORMAT(SQ.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME),GETDATE()) \u003E SQ.TimeThresholdForResendTo3PL \r\n\t--DATEADD(MINUTE,SQ.TimeThresholdForResendTo3PL,CAST(CONVERT(varchar,FORMAT(SQ.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C GETDATE() \r\n\r\n) SQ\r\n"},{"Name":"Get_DispatchRequestResultDetail_For_Driver","Schema":"dbo","Definition":"\r\n/*\r\nDECLARE @Result NVARCHAR(MAX)=\u0027\u0027\r\nEXEC Get_DispatchRequestResultDetail_For_Driver @DispatchRequestId=772913,@FleetId=4329,@Result=@Result OUTPUT\r\nSELECT @Result\r\n*/\r\n--DROP PROCEDURE Get_DispatchRequestResultDetail\r\nCREATE       PROCEDURE [dbo].[Get_DispatchRequestResultDetail_For_Driver]\r\n\t@DispatchRequestId\tBIGINT,\r\n\t@FleetId\t\t\tINT,\t\r\n\t@Result\t\t\t\tNVARCHAR(MAX) OUTPUT\r\n\r\nAS\r\n\r\n\t\tSET @Result=(\r\n\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t dr.Id Id\r\n\t\t\t\t\t,dr.DispatchRequestStatusId\r\n\t\t\t\t\t,Null StoreAddress \r\n\t\t\t\t\t,Null StoreTitle \r\n\t\t\t\t\t,NULL StoreLocation \r\n\t\t\t\t\t,ps.StoreId\r\n\t\t\t\t\t,ParcelReferenceCode \r\n\t\t\t\t\t,VendorParcelCode\r\n\t\t\t\t\t,CourierRequestTypeId \r\n\t\t\t\t\t,NULL CourierRequestTypeTitle \r\n\t\t\t\t\t,(\tSELECT TOP 1 WITH TIES sdpi.ShipmentDestinationPointStatusId\r\n\t\t\t\t\t\tFROM dp.ShipmentDestinationPoint sdpi (NOLOCK) \r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdri (NOLOCK)  ON sdpi.Id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\tWHERE sdpi.OperationTypeId=5/*Pickup*/\r\n\t\t\t\t\t\tAND sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY sdpdri.DispatchRequestId ORDER BY sdpi.CreateDate DESC)\r\n\t\t\t\t\t) PickupShipmentDestinationPointStatusId\r\n\t\t\t\t\t,(\tSELECT TOP 1 WITH TIES \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN (sdpi.ShipmentDestinationPointStatusId IN (20/*Met*/,25/*Met With Delay*/) AND dr.CourierRequestTypeId IN ( 26,30,35 )) OR dr.DispatchRequestStatusId = 80 \r\n\t\t\t\t\t\t\t\t\tTHEN CAST(200 AS TINYINT)\r\n\t\t\t\t\t\t\t\tWHEN sdpi.ShipmentDestinationPointStatusId = 40 AND dr.DispatchRequestStatusId \u003C\u003E 80 \r\n\t\t\t\t\t\t\t\t\tTHEN CAST(30 AS TINYINT) \r\n\t\t\t\t\t\t\t\tELSE \r\n\t\t\t\t\t\t\t\t\tsdpi.ShipmentDestinationPointStatusId  \r\n\t\t\t\t\t\t\tEND \r\n\t\t\t\t\t\tFROM dp.ShipmentDestinationPoint sdpi (NOLOCK) \r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdri (NOLOCK)  ON sdpi.Id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\tWHERE sdpi.OperationTypeId=10/*Delivery*/\r\n\t\t\t\t\t\tAND sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY sdpdri.DispatchRequestId ORDER BY sdpi.CreateDate DESC)\r\n\t\t\t\t\t) DeliveryShipmentDestinationPointStatusId\r\n\t\t\t\t\t,ClientAddress \r\n\t\t\t\t\t,JSON_QUERY(ISNULL((\r\n\t\t\t\t\t\t\tSELECT dr1.ClientLocation.STY  AS  Latitude,dr1.ClientLocation.STX  AS Longitude\r\n\t\t\t\t\t\t\tFROM dp.DispatchRequest dr1  (NOLOCK) \r\n\t\t\t\t\t\t\tWHERE dr1 .Id=dr.Id\r\n\t\t\t\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t\t\t),\u0027\u0027)) ClientLocation\r\n\t\t\t\t\t,FORMAT(dr.CreateDate ,\u0027####-##-## ##:##:##\\.###\u0027) CreateDateStr\r\n\t\t\t\t\t,FORMAT(dr.CreateDatePersian  ,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersianStr\r\n\t\t\t\t\t,ISNULL((\r\n\t\t\t\t\t\t--SELECT TOP 1 WITH TIES  FORMAT(sdpi.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)CreateDatePersian\r\n\t\t\t\t\t\t--FROM dp.ShipmentDestinationPoint sdpi (NOLOCK) \r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdri  (NOLOCK) ON sdpi.Id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t--WHERE sdpi.OperationTypeId=5/*Pickup*/\r\n\t\t\t\t\t\t--AND sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t--ORDER BY ROW_NUMBER() OVER (PARTITION BY sdpdri.DispatchRequestId ORDER BY sdpi.CreateDate DESC)\r\n\t\t\t\t\t\tSELECT TOP 1 WITH TIES FORMAT(drsh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersian\r\n\t\t\t\t\t\tFROM DP.DispatchRequestStatusHistory drsh (NOLOCK)\r\n\t\t\t\t\t\tWHERE drsh.DispatchRequestId = dr.Id\r\n\t\t\t\t\t\tAND drsh.DispatchRequestStatusId IN ( 10,11 )\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY drsh.DispatchRequestId ORDER BY drsh.CreateDate DESC)\r\n\t\t\t\t\t ),\u0027\u0027) AssignedTimePersianStr \r\n\t\t\t\t\t,ISNULL((\r\n\t\t\t\t\t\tSELECT TOP 1 WITH TIES \r\n\t\t\t\t\t\tREPLACE(\r\n\t\t\t\t\t\t\tCONCAT(dbo.ConvertToShamsi(\r\n\t\t\t\t\t\t\t\tDATEADD(\r\n\t\t\t\t\t\t\t\t\tSECOND,sdpi.EstimatedOperationTimeSeconds,\r\n\t\t\t\t\t\t\t\t\tCAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))),\r\n\t\t\t\t\t\t\t\t\t\u0027 \u0027,\r\n\t\t\t\t\t\t\t\t\tCONVERT(VARCHAR(10), DATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)), 108)\r\n\t\t\t\t\t\t\t\t\t)   \r\n\t\t\t\t\t\t,\u0027T\u0027,\u0027\u0027)\r\n\t\t\t\t\t\tFROM dp.ShipmentDestinationPoint sdpi (NOLOCK) \r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdri (NOLOCK)  ON sdpi.Id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\tWHERE sdpi.OperationTypeId=5/*Pickup*/\r\n\t\t\t\t\t\tAND sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY sdpdri.DispatchRequestId ORDER BY sdpi.CreateDate DESC)\r\n\t\t\t\t\t ),\u0027\u0027) PickUpEstimatedTimePersianStr \r\n\t\t\t\t\t,ISNULL((\r\n\t\t\t\t\t\t--SELECT TOP 1 WITH TIES  FORMAT(UpdateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)UpdateDatePersian\r\n\t\t\t\t\t\t--FROM dp.ShipmentDestinationPoint sdpi (NOLOCK) \r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdri (NOLOCK)  ON sdpi.Id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t--WHERE sdpi.OperationTypeId=5/*Pickup*/\r\n\t\t\t\t\t\t--AND sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t--ORDER BY ROW_NUMBER() OVER (PARTITION BY sdpdri.DispatchRequestId ORDER BY sdpi.CreateDate DESC)\r\n\t\t\t\t\t\tSELECT TOP 1 WITH TIES FORMAT(drsh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersian\r\n\t\t\t\t\t\tFROM DP.DispatchRequestStatusHistory drsh (NOLOCK)\r\n\t\t\t\t\t\tWHERE drsh.DispatchRequestId = dr.Id\r\n\t\t\t\t\t\tAND drsh.DispatchRequestStatusId IN ( 20 )\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY drsh.DispatchRequestId ORDER BY drsh.CreateDate DESC)\r\n\t\t\t\t\t ),\u0027\u0027) PickUpActualTimePersianStr \r\n\t\t\t\t\t,ISNULL((\r\n\t\t\t\t\t\tSELECT TOP 1 WITH TIES   \r\n\t\t\t\t\t\tREPLACE(\r\n\t\t\t\t\t\t\tCONCAT(dbo.ConvertToShamsi(\r\n\t\t\t\t\t\t\t\tDATEADD(\r\n\t\t\t\t\t\t\t\t\tSECOND,sdpi.EstimatedOperationTimeSeconds,\r\n\t\t\t\t\t\t\t\t\tCAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))),\r\n\t\t\t\t\t\t\t\t\t\u0027 \u0027,\r\n\t\t\t\t\t\t\t\t\tCONVERT(VARCHAR(10), DATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)), 108)\r\n\t\t\t\t\t\t\t\t\t)   \r\n\t\t\t\t\t\t,\u0027T\u0027,\u0027\u0027)\r\n\t\t\t\t\t\tFROM dp.ShipmentDestinationPoint sdpi (NOLOCK) \r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdri (NOLOCK)  ON sdpi.Id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\tWHERE sdpi.OperationTypeId IN (10)\r\n\t\t\t\t\t\tAND dr.DispatchRequestStatusId IN ( 30,35 )\r\n\t\t\t\t\t\tAND sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY sdpdri.DispatchRequestId ORDER BY sdpi.CreateDate DESC)\r\n\r\n\t\t\t\t\t\tUNION ALL\r\n\r\n\t\t\t\t\t\tSELECT TOP 1 WITH TIES   \r\n\t\t\t\t\t\tREPLACE(\r\n\t\t\t\t\t\t\tCONCAT(dbo.ConvertToShamsi(\r\n\t\t\t\t\t\t\t\tDATEADD(\r\n\t\t\t\t\t\t\t\t\tSECOND,sdp.EstimatedOperationTimeSeconds,\r\n\t\t\t\t\t\t\t\t\tCAST(CONVERT(VARCHAR, FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))),\r\n\t\t\t\t\t\t\t\t\t\u0027 \u0027,\r\n\t\t\t\t\t\t\t\t\tCONVERT(VARCHAR(10), DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)), 108)\r\n\t\t\t\t\t\t\t\t\t)   \r\n\t\t\t\t\t\t,\u0027T\u0027,\u0027\u0027)\r\n\t\t\t\t\t\tFROM DP.DispatchRequest dr_R (NOLOCK)\r\n\t\t\t\t\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\t\t\t\t\tON dr_R.Id = sdpdr.DispatchRequestId\r\n\t\t\t\t\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\t\t\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\t\t\t\t\t\tAND sdp.OperationTypeId IN ( 15,30 )\r\n\t\t\t\t\t\tWHERE dr.VendorParcelCode = dr_R.VendorParcelCode\r\n\t\t\t\t\t\t\tAND dr.VendorId = dr_R.VendorId\r\n\t\t\t\t\t\t\tAND dr.DispatchRequestStatusId = 80\r\n\t\t\t\t\t\t\tAND dr_R.CourierRequestTypeId IN ( 25,51 )\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY sdpdr.DispatchRequestId ORDER BY sdp.CreateDate DESC)\r\n\t\t\t\t\t ),\u0027\u0027) DeliveryEstimatedTimePersianStr \r\n\t\t\t\t\t,ISNULL((\r\n\t\t\t\t\t\t--SELECT TOP 1 WITH TIES   FORMAT(UpdateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)UpdateDatePersian\r\n\t\t\t\t\t\t--FROM dp.ShipmentDestinationPoint sdpi (NOLOCK) \r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdri (NOLOCK)  ON sdpi.Id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t--WHERE sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/,30)\r\n\t\t\t\t\t\t--AND sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t--ORDER BY ROW_NUMBER() OVER (PARTITION BY sdpdri.DispatchRequestId ORDER BY sdpi.CreateDate DESC)\r\n\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN dr2.DispatchRequestStatusId IN ( 30,35 )\r\n\t\t\t\t\t\t\t\tTHEN FORMAT(dr2.UpdateDate,\u0027####/##/## ##:##:##\\.###\u0027)\r\n\t\t\t\t\t\t\tWHEN dr2.DispatchRequestStatusId = 80\r\n\t\t\t\t\t\t\t\tTHEN FORMAT(dr_R.UpdateDate,\u0027####/##/## ##:##:##\\.###\u0027)\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tNULL\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tFROM DP.DispatchRequest dr2 (NOLOCK)\r\n\t\t\t\t\t\tLEFT JOIN DP.DispatchRequest dr_R (NOLOCK)\r\n\t\t\t\t\t\t\tON dr2.VendorParcelCode = dr_R.VendorParcelCode\r\n\t\t\t\t\t\t\tAND dr2.VendorId = dr_R.VendorId\r\n\t\t\t\t\t\t\tAND dr2.DispatchRequestStatusId = 80\r\n\t\t\t\t\t\t\tAND dr_R.CourierRequestTypeId IN ( 25,51 )\r\n\t\t\t\t\t\tWHERE dr2.ID = dr.Id\r\n\t\t\t\t\t ),\u0027\u0027) DeliveryActualTimePersianStr\r\n\r\n\t\t\t\t\t,ISNULL((\r\n\t\t\t\t\t\tSELECT TOP 1 WITH TIES FORMAT(uorh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersian\r\n\t\t\t\t\t\tFROM DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK)\r\n\t\t\t\t\t\tWHERE uorh.DispatchRequestId = dr.Id\r\n\t\t\t\t\t\tAND uorh.OperationTypeId IN ( 6 )\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY uorh.DispatchRequestId ORDER BY uorh.CreateDate DESC)\r\n\t\t\t\t\t ),\u0027\u0027) NotPickUpRequestTimePersianStr\r\n\t\t\t\t\t,ISNULL((\r\n\t\t\t\t\t\tSELECT TOP 1 WITH TIES FORMAT(uorh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersian\r\n\t\t\t\t\t\tFROM DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK)\r\n\t\t\t\t\t\tWHERE uorh.DispatchRequestId = dr.Id\r\n\t\t\t\t\t\tAND uorh.OperationTypeId IN ( 8,9,35 )\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY uorh.DispatchRequestId ORDER BY uorh.CreateDate DESC)\r\n\t\t\t\t\t ),\u0027\u0027) CancelTimePersianStr\r\n\t\t\t\t\t,ISNULL((\r\n\t\t\t\t\t\tSELECT TOP 1 WITH TIES FORMAT(drsh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersian\r\n\t\t\t\t\t\tFROM DP.DispatchRequestStatusHistory drsh (NOLOCK)\r\n\t\t\t\t\t\tWHERE drsh.DispatchRequestId = dr.Id\r\n\t\t\t\t\t\tAND drsh.DispatchRequestStatusId IN ( 45 )\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY drsh.DispatchRequestId ORDER BY drsh.CreateDate DESC)\r\n\t\t\t\t\t ),\u0027\u0027) ReturnRequestTimePersianStr \r\n\t\t\t\t\t,ISNULL(ISNULL((\r\n\t\t\t\t\t\tSELECT TOP 1 WITH TIES FORMAT(drsh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersian\r\n\t\t\t\t\t\tFROM DP.DispatchRequestStatusHistory drsh (NOLOCK)\r\n\t\t\t\t\t\tWHERE drsh.DispatchRequestId = dr.Id\r\n\t\t\t\t\t\tAND drsh.DispatchRequestStatusId IN ( 80 )\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY drsh.DispatchRequestId ORDER BY drsh.CreateDate DESC)\r\n\t\t\t\t\t ),CASE WHEN dr.DispatchRequestStatusId \u003C\u003E 80 THEN FORMAT(dr.UpdateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) ELSE NULL END),\u0027\u0027) ReturnConfirmationTimePersianStr ,\r\n\r\n\t\t\t\t\t dr.IsExclusiveDelivery,\r\n\t\t\t\t\t dr.IsNightly,\r\n\t\t\t\t\t (\r\n\t\t\t\t\t\tSELECT TOP 1\r\n\t\t\t\t\t\t\tcr.ClientName\r\n\t\t\t\t\t\tFROM CS_OrderManagement.OM.Parcel p WITH(NOLOCK) \r\n\t\t\t\t\t\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr WITH(NOLOCK)\r\n\t\t\t\t\t\t\tON p.CourierRequestId = cr.Id\r\n\t\t\t\t\t\tWHERE p.ParcelReferenceCode = dr.ParcelReferenceCode\r\n\t\t\t\t\t ) ClientName\r\n\t\t\tFROM dp.DispatchRequest dr (NOLOCK) \r\n\t\t\tINNER JOIN dp.PolygonStore ps\t\t\t\t\t\t\t\t(NOLOCK) ON ps.Id=dr.PolygonStoreId\r\n\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr\t(NOLOCK) ON dr.Id=sdpdr.DispatchRequestId\r\n\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp\t\t\t\t\t(NOLOCK) ON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\t\tINNER JOIN dp.Shipment s\t\t\t\t\t\t\t\t\t(NOLOCK) ON s.Id=sdp.ShipmentId\r\n\t\t\tINNER JOIN CS_DriverManagement.DM.Fleet f\t\t\t\t\t(NOLOCK) ON f.Id=s.FleetId\r\n\t\t\tWHERE dr.Id=@DispatchRequestId\r\n\t\t\tAND f.Id=@FleetId\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER,  INCLUDE_NULL_VALUES\r\n\t\t)\r\n\r\n\tSET @Result=REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\n"},{"Name":"Get_DispatchRequests_By_ShipmentId","Schema":"dbo","Definition":"CREATE      PROCEDURE [dbo].[Get_DispatchRequests_By_ShipmentId]\r\n\t--declare\r\n\t@ShipmentId\t\t\t\t\tBIGINT,\r\n\t@OperationWarningRangeTime\tTime(7),\r\n\t@Result\t\t\t\t\t\tNVARCHAR(MAX) = NULL OUTPUT,\r\n\t@Count\t\t\t\t\t\tSMALLINT OUTPUT,\r\n\t@ReturnToStore_ShipmentDestinationPointID BIGINT OUTPUT,\r\n\t@ReturnToStore_RemainedEsmatedDeliveryTimeSeconds INT OUTPUT,\r\n\t@ReturnToStore_EstimatedDeliveryDateTimeStr NVARCHAR(MAX) OUTPUT\r\nAS\r\n\r\n\r\n\t;WITH CTE_ReturnToStore AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tShipmentId,\r\n\t\t\tShipmentDestinationPointId ,\r\n\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) AS EstimatedDeliveryDateTimeStr ,\r\n\t\t\tDATEDIFF(SECOND,DATEADD(SECOND,EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)),GETDATE()) RemainedEsmatedDeliveryTimeSeconds\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tShipmentId,\r\n\t\t\t\tShipmentDestinationPointID,\r\n\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\tEstimatedOperationTimeSeconds,\r\n\t\t\t\tFIRST_VALUE(ShipmentDestinationPointID_ReturnToStore) OVER ( PARTITION BY ShipmentId ORDER BY ShipmentDestinationPointID_ReturnToStore DESC ) ShipmentDestinationPointID_ReturnToStore,\r\n\t\t\t\tFIRST_VALUE(SecondCon) OVER ( PARTITION BY ShipmentId ORDER BY SecondCon DESC ) SecondCon\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tsdp.ShipmentId,\r\n\t\t\t\t\tsdp.ID AS ShipmentDestinationPointID,\r\n\t\t\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId = 30 AND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35,40 ) AND dr.ID IS NULL THEN sdp.ID ELSE NULL END ShipmentDestinationPointID_ReturnToStore,\r\n\t\t\t\t\tCASE WHEN sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ) AND dr.ID IS NOT NULL  THEN 1 ELSE 0 END SecondCon\r\n\t\t\t\tFROM DP.Shipment s (NOLOCK)\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\t\tON s.ID = sdp.ShipmentId\r\n\t\t\t\t\tAND s.ID = @ShipmentId\r\n\t\t\t\tLEFT JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\t\t\tLEFT JOIN DP.DispatchRequest dr (NOLOCK)\r\n\t\t\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\t\t) SQ\r\n\t\t) SQ\r\n\t\tWHERE ShipmentDestinationPointID_ReturnToStore = ShipmentDestinationPointID\r\n\t\tAND SQ.SecondCon = 0\r\n\t)\r\n\tSELECT \r\n\t\t@ReturnToStore_ShipmentDestinationPointID = ShipmentDestinationPointId,\r\n\t\t@ReturnToStore_EstimatedDeliveryDateTimeStr = CONVERT(NVARCHAR(MAX),EstimatedDeliveryDateTimeStr,121) ,\r\n\t\t@ReturnToStore_RemainedEsmatedDeliveryTimeSeconds = RemainedEsmatedDeliveryTimeSeconds\r\n\tFROM CTE_ReturnToStore\r\n\r\n\tDROP TABLE IF EXISTS #DispatchRequestIds\r\n\r\n\tSELECT (CASE WHEN (COUNT(DISTINCT dr.VendorParcelCode)=COUNT(dr.VendorParcelCode)) THEN 1 ELSE 0 END) VendorParcelCode_Is_Unique,dr.VendorParcelCode\r\n\tINTO #DispatchRequestIds\r\n\tFROM dp.DispatchRequest(NOLOCK) dr\r\n\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs ON dr.DispatchRequestStatusId=drs.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr ON sdpdr.DispatchRequestId=dr.Id\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp ON sdp.id=sdpdr.ShipmentDestinationPointId\r\n\tWHERE sdp.ShipmentId=@ShipmentId\r\n\tAND sdp.OperationTypeId IN(5,20,25)/*Pickup*/\r\n\tGROUP BY dr.VendorParcelCode\r\n\r\n\r\n\t--DECLARE @Count\tSMALLINT=0\r\n\tSET @Count=(\r\n\tSELECT\tCount(DISTINCT VendorParcelCode)\r\n\tFROM(\r\n\tSELECT dr.Id,dri.VendorParcelCode,DispatchRequestStatusId,VendorParcelCode_Is_Unique\r\n\tFROM #DispatchRequestIds dri\r\n\tINNER JOIN dp.DispatchRequest(NOLOCK) dr ON dr.VendorParcelCode=dri.VendorParcelCode\r\n\t)CNT\r\n\t--WHERE (CNT.VendorParcelCode_Is_Unique=0 AND CNT.DispatchRequestStatusId\u003C\u003E40)OR (CNT.VendorParcelCode_Is_Unique=1)\r\n\t)\r\n\t\r\n\r\n\t\r\n\r\n\t--IF @Count=0 \r\n\t--BEGIN \r\n\t--\t--SET @RESULT=NULL--\u0027{\u0022Count\u0022:0}\u0027\r\n\t--\tRETURN \r\n\t--END\r\n\r\n\t--;WITH CTE1 AS\r\n\t--(\r\n\t--\tSELECT\tCNT.Id\r\n\t--\tFROM(\r\n\t--\tSELECT dr.Id,dri.VendorParcelCode,DispatchRequestStatusId,VendorParcelCode_Is_Unique\r\n\t--\tFROM #DispatchRequestIds dri\r\n\t--\tINNER JOIN dp.DispatchRequest dr ON dr.VendorParcelCode=dri.VendorParcelCode\r\n\t--\t)CNT\r\n\t--\t--WHERE (CNT.VendorParcelCode_Is_Unique=0 AND CNT.DispatchRequestStatusId\u003C\u003E40)OR (CNT.VendorParcelCode_Is_Unique=1)\r\n\t--)\r\n\t--SELECT @RESULT=(\r\n\t\t--SELECT  \r\n\t\t--\t@Count Count,\r\n\t\t--\t@ShipmentId As ,ShipmentId\r\n\t\t\t--(\r\n\t\t\t\r\n\t\t\t/*;WITH CTE_DR AS\r\n\t\t\t(\r\n\t\t\t\tSELECT DISTINCT dr.Id  \r\n\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dr\r\n\t\t\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs\t\t\t\t\t\tON dr.DispatchRequestStatusId=drs.Id\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr ON sdpdr.DispatchRequestId=dr.Id\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON sdp.id=sdpdr.ShipmentDestinationPointId AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 35\r\n\t\t\t\tINNER JOIN dp.PolygonStore(NOLOCK) dps\t\t\t\t\t\t\t\tON dps.Id=dr.PolygonStoreId\r\n\t\t\t\tINNER JOIN dp.Shipment s (NOLOCK)\r\n\t\t\t\t\tON sdp.ShipmentId = s.Id\r\n\t\t\t\tWHERE \r\n\t\t\t\tsdp.ShipmentId = @ShipmentId\r\n\t\t\t),*/ ;WITH CTE_Main AS\r\n\t\t\t(\r\n\t\t\t\t--SELECT * FROM\r\n\t\t\t\t--(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t--FIRST_VALUE( CASE WHEN sdp.OperationTypeId IN ( 10,20,25 ) THEN sdp.OperationTypeId ELSE NULL END ) OVER ( PARTITION BY dr.ID ORDER BY CASE WHEN sdp.OperationTypeId IN ( 10,20,25 ) THEN sdp.OperationTypeId ELSE NULL END DESC ) OperationType_10,\r\n\t\t\t\t\t\t--FIRST_VALUE( CASE WHEN sdp.OperationTypeId IN ( 10,20,25 ) AND sdp.ShipmentDestinationPointStatusId = 40 THEN 1 ELSE 0 END ) OVER ( PARTITION BY dr.ID ORDER BY CASE WHEN sdp.OperationTypeId IN ( 10,20,25 ) AND sdp.ShipmentDestinationPointStatusId = 40 THEN 1 ELSE 0 END DESC ) OperationStatus_Reassigned,\r\n\t\t\t\t\t\t--FIRST_VALUE(s.Id) OVER ( PARTITION BY dr.Id ORDER BY s.CreateDate ASC ) FSH,\r\n\t\t\t\t\t\t--FIRST_VALUE(s.Id) OVER ( PARTITION BY dr.Id ORDER BY s.CreateDate DESC) LSH,\r\n\t\t\t\t\t\tdr.Id , \r\n\t\t\t\t\t\tdr.DispatchRequestStatusId ,\r\n\t\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\t\tdr.IsWaitingForSupport ,\r\n\t\t\t\t\t\tdr.CourierRequestTypeId,\r\n\t\t\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\t\t\tdr.DeliveryStartTime,\r\n\t\t\t\t\t\tdr.DeliveryStartTimePersian,\r\n\t\t\t\t\t\tdr.DeliveryDeadLineTime,\r\n\t\t\t\t\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\t\t\t\t\tdr.ClientAddress,\r\n\t\t\t\t\t\tdr.ClientLocation,\r\n\t\t\t\t\t\tdr.VendorParcelCode,\r\n\r\n\t\t\t\t\t\tdrs.Title,\r\n\r\n\t\t\t\t\t\tdps.StoreId,\r\n\r\n\t\t\t\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\t\t\t\tsdp.OperationTypeId,\r\n\t\t\t\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\t\t\t\tsdp.ShipmentId,\r\n\t\t\t\t\t\tdr.VendorId,\r\n\t\t\t\t\t\tCASE WHEN dr.Version = FIRST_VALUE(sdpdr.Version) OVER ( PARTITION BY dr.Id ORDER BY sdpdr.Version DESC) THEN 0 ELSE 1 END OperationStatus_Reassigned,\r\n\t\t\t\t\t\tdr.Version AS DispatchRequestVersion,\r\n\t\t\t\t\t\tsdpdr.Version AS ShipmentDestinationPointDispatchRequestVersion\r\n\t\t\t\t\tFROM /*CTE_DR d\r\n\t\t\t\t\tINNER JOIN*/ dp.DispatchRequest(NOLOCK) dr\r\n\t\t\t\t\t\t--ON d.Id = dr.Id\r\n\t\t\t\t\t--INNER JOIN CTE1\t\t\t\t\t\t\t\t\t\t\t\tON dr.Id=CTE1.Id\r\n\t\t\t\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs\t\t\t\t\t\tON dr.DispatchRequestStatusId=drs.Id\r\n\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr ON sdpdr.DispatchRequestId=dr.Id\r\n\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON sdp.id=sdpdr.ShipmentDestinationPointId AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 35\r\n\t\t\t\t\tINNER JOIN dp.PolygonStore(NOLOCK) dps\t\t\t\t\t\t\t\tON dps.Id=dr.PolygonStoreId\r\n\t\t\t\t\tINNER JOIN dp.Shipment s (NOLOCK)\r\n\t\t\t\t\t\tON sdp.ShipmentId = s.Id\r\n\t\t\t\t\t\tAND s.ID = @ShipmentId\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tWHERE \r\n\r\n\t\t\t\t\tNOT \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\t\tdr.DispatchRequestStatusId = 80 --Not Delivered \r\n\t\t\t\t\t\tOR (dr.CourierRequestTypeId = 51 AND dr.DispatchRequestStatusId NOT IN (20,25,30,35))\r\n\t\t\t\t\t\tOR (dr.CourierRequestTypeId IN (40,45,50) AND dr.DispatchRequestStatusId IN (30,35))\r\n\t\t\t\t\t)\r\n\t\t\t\t--) SQ\r\n\t\t\t\t--WHERE SQ.ShipmentId = @ShipmentId\r\n\r\n\t\t\t),CTE_DSPRM AS\r\n\t\t\t(\r\n\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\tdsprm.DispatchRequestId,\r\n\t\t\t\t\tdsprm.DeliveryServiceProviderOrderId,\r\n\t\t\t\t\tdsprm.Version\r\n\t\t\t\tFROM DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\t\t\t\tINNER JOIN Dp.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\t\t\t\t\tON dsprm.DispatchRequestId = sdpdr.DispatchRequestId\r\n\t\t\t\t\tAND dsprm.Version = sdpdr.Version\r\n\t\t\t\tWHERE dsprm.IsActive = 1\r\n\t\t\t),CTE_DSPRMGo AS\r\n\t\t\t(\r\n\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\tdrGo.VendorId,\r\n\t\t\t\t\tdrGo.VendorParcelCode,\r\n\t\t\t\t\tdsprm.DeliveryServiceProviderOrderId,\r\n\t\t\t\t\tdsprm.Version\r\n\t\t\t\tFROM DP.DispatchRequest drGo (NOLOCK)\r\n\t\t\t\tINNER JOIN DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\t\t\t\t\tON dsprm.DispatchRequestId = drGo.Id\r\n\t\t\t\t\tAND dsprm.IsActive = 1\r\n\t\t\t\t\tAND drGo.CourierRequestTypeId IN ( 5,10,15 )\r\n\t\t\t\tINNER JOIN Dp.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\t\t\t\t\tON dsprm.DispatchRequestId = sdpdr.DispatchRequestId\r\n\t\t\t\t\tAND dsprm.Version = sdpdr.Version\r\n\t\t\t),CTE_FleetPreAssignmentStateCount AS\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tfas.DispatchRequestId,\r\n\t\t\t\t\tCOUNT(DISTINCT LEFT(fas.CreateDate,12)) fleetPreAssignmentStateCount\r\n\t\t\t\tFROM DP.FleetPreAssignmentStateLog fas WITH(NOLOCK) \t\t\t\t\t\r\n\t\t\t\t\tWHERE fas.DeliveryServiceProviderId = 1\r\n\t\t\t\t\tAND fas.AssignmentFailureReasonId NOT IN ( 100,105 )\r\n\t\t\t\tGroup By fas.DispatchRequestId\r\n\t\t\t)\r\n\r\n\t\t\tSELECT\tDISTINCT \r\n\t\t\t\t\tdr.Id,\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN OperationStatus_Reassigned = 1 THEN CAST(17 AS TINYINT)\r\n\t\t\t\t\tELSE dr.DispatchRequestStatusId\r\n\t\t\t\t\tEND AS DispatchRequestStatusId,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\t\tWHEN OperationStatus_Reassigned = 1 \r\n\t\t\t\t\t\t\tTHEN N\u0027\u062C\u0645\u0639 \u0622\u0648\u0631\u06CC \u0646\u0634\u062F\u0027\r\n\r\n\t\t\t\t\t\tWHEN dr.IsWaitingForSupport = 1 \r\n\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN ( 15,16 ) THEN N\u0027\u0645\u0646\u062A\u0638\u0631 \u067E\u0627\u0633\u062E \u0639\u062F\u0645 \u062C\u0645\u0639 \u0622\u0648\u0631\u06CC\u0027 \r\n\t\t\t\t\t\t\t\t\tELSE dr.Title\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId = 25 \r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 20 THEN N\u0027\u0645\u0631\u062C\u0648\u0639 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (30,35) THEN N\u0027\u062A\u062D\u0648\u06CC\u0644 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdr.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId IN (40,45,50)\r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0646\u0642\u0637\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdr.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId = 51 \r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 20 THEN N\u0027\u0628\u0633\u062A\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u062C\u0645\u0639 \u0622\u0648\u0631\u06CC \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0646\u0642\u0637\u0647 \u062A\u062D\u0648\u06CC\u0644 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 30 THEN N\u0027\u0628\u0633\u062A\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 35 THEN N\u0027\u0628\u0633\u062A\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u0628\u0627 \u062A\u0627\u062E\u06CC\u0631 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdr.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId IN (26,30,35) \r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 15 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0646\u0642\u0637\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 20 THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u062C\u0645\u0639 \u0622\u0648\u0631\u06CC \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0631\u0627\u06CC \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 30 THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 35 THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0627 \u062A\u0627\u062E\u06CC\u0631 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdr.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tELSE   \r\n\t\t\t\t\t\t\tdr.Title\t\t\t\t\t\r\n\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n\t\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\t\tdr.CourierRequestTypeId,\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryStartTime ,\u0027####-##-## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryStartTimeStr,\r\n\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryStartTimePersian ,\u0027####/##/## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryStartTimePersianStr,\r\n\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryDeadLineTime ,\u0027####-##-## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryDeadLineTimeStr,\r\n\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryDeadLineTimePersian ,\u0027####/##/## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryDeadLineTimePersianStr,\r\n\r\n\t\t\t\t\tdr.ClientAddress,\r\n\t\t\t\t\t--JSON_QUERY(ISNULL((\r\n\t\t\t\t\t--\tSELECT dr.ClientLocation.STY  AS  Latitude,dr.ClientLocation.STX  AS Longitude\r\n\t\t\t\t\t--\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t--),\u0027\u0027)) ClientLocation,\r\n\t\t\t\t\tdr.ClientLocation.STY AS Latitude,\r\n\t\t\t\t\tdr.ClientLocation.STX AS Longitude,\r\n\t\t\t\t\tdr.StoreId,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\t\t\t--SELECT  TOP 1 DATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t--FROM dp.DispatchRequest(NOLOCK) dri\r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t--WHERE dr.Id=dri.Id\r\n\t\t\t\t\t\t--AND sdpi.OperationTypeId in(5)/*PickUp*/\r\n\t\t\t\t\t\t--ORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t\tSELECT  TOP 1 DATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n                        FROM dp.DispatchRequest(NOLOCK) dri\r\n                        INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n                        INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n                        WHERE dr.Id=dri.Id\r\n\t\t\t\t\t\tAND sdpi.ShipmentId = @ShipmentId\r\n                        AND ((dri.CourierRequestTypeId = 51 and sdpi.OperationTypeId in (25)/*PickUp*/) or (dri.CourierRequestTypeId \u003C\u003E 51 and sdpi.OperationTypeId in (5,20)))\r\n                        ORDER BY sdpdri.CreateDate DESC\r\n\r\n\t\t\t\t\t),0) EstimatedPickupDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\tSELECT FORMAT(drshi.CreateDate ,\u0027####-##-## ##:##:##\\.###\u0027)\r\n\t\t\t\t\t\tFROM dp.DispatchRequestStatusHistory(NOLOCK) drshi \r\n\t\t\t\t\t\tWHERE drshi.DispatchRequestId=dr.Id \r\n\t\t\t\t\t\tAND drshi.DispatchRequestStatusId=20/*Pickup*/\r\n\t\t\t\t\t),\u0027\u0027) PickupDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\t\t\t--SELECT TOP 1 DATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t--FROM dp.ShipmentDestinationPoint(NOLOCK) sdpi\r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t--WHERE sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t--AND sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/)\r\n\t\t\t\t\t\t--ORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t\tSELECT TOP 1 DATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dri\r\n                        INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n                        INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n                        WHERE dr.Id=dri.Id\r\n                        AND sdpi.ShipmentId = @ShipmentId\r\n\t\t\t\t\t\tAnd ((dri.CourierRequestTypeId in (40,45,50) and sdpi.OperationTypeId =25) or (dri.CourierRequestTypeId not in  (40,45,50) \r\n\t\t\t\t\t\tAnd sdpi.OperationTypeId in (10,15,30))) \r\n\t\t\t\t\t\r\n\t\t\t\t\t\tORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t),\u0027\u0027) EstimatedDeliveryDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\tSELECT FORMAT(drshi.CreateDate ,\u0027####-##-## ##:##:##\\.###\u0027) \r\n\t\t\t\t\t\tFROM dp.DispatchRequestStatusHistory(NOLOCK) drshi \r\n\t\t\t\t\t\tWHERE drshi.DispatchRequestId=dr.Id \r\n\t\t\t\t\t\tAND drshi.DispatchRequestStatusId IN (30,35)/*Delivered,DeliveredWithDelay*/\r\n\t\t\t\t\t),\u0027\u0027) DeliveryDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\tSELECT TOP 1 sdpi.SequenceNumber\r\n\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dri\r\n                        INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n                        INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n                        WHERE dr.Id=dri.Id\r\n                        AND sdpi.ShipmentId = @ShipmentId\r\n\t\t\t\t\t\tAnd ((dri.CourierRequestTypeId in (40,45,50) and sdpi.OperationTypeId =25) or (dri.CourierRequestTypeId not in  (40,45,50) \r\n\t\t\t\t\t\tAnd sdpi.OperationTypeId in (10,15,30))) \r\n\t\t\t\t\t\tORDER BY sdpi.id DESC \r\n\t\t\t\t\t),0) SequenceNumber,\r\n\t\t\t\t\tISNULL((\t\r\n\t\t\t\t\t\tSELECT\tTOP 1 \r\n\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\tWHEN OperationStatus_Reassigned = 1 AND dr.DispatchRequestStatusId \u003C\u003E 17\r\n\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (10/*Assigned toCourier*/,15/*Arrived at Pickup point*/,11,16) \r\n\t\t\t\t\t\t\t\t\tTHEN (\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT TOP 1 \r\n\t\t\t\t\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003C(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,--A\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\tBETWEEN DATEADD(SECOND,--A\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 3\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003EDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND\t\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) drii\r\n\t\t\t\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdrii ON sdpdrii.DispatchRequestId=drii.Id\r\n\t\t\t\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpii ON sdpii.id=sdpdrii.ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE dri.Id=drii.Id\r\n                                            AND sdpi.ShipmentId = @ShipmentId\r\n\t\t\t\t\t\t\t\t\t\t\tAND ((drii.CourierRequestTypeId = 51 and sdpii.OperationTypeId in (25)/*PickUp*/) or (drii.CourierRequestTypeId \u003C\u003E 51 and sdpii.OperationTypeId in (5,20)))--AND sdpii.OperationTypeId=5/*PickUp*/\r\n\t\t\t\t\t\t\t\t\t\t\tORDER BY sdpdrii.CreateDate DESC\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (20,25,45,50,46,47,48,49,51,52,53,54)  \r\n\t\t\t\t\t\t\t\t\tTHEN (\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT\tTOP 1 CASE \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003C\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,--B\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE() BETWEEN \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,--B\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 3\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003EDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\t\t\t\t\tFROM dp.ShipmentDestinationPoint(NOLOCK) sdpi\r\n\t\t\t\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE sdpdri.DispatchRequestId=dr.Id\r\n                                            AND sdpi.ShipmentId = @ShipmentId\r\n\t\t\t\t\t\t\t\t\t\t\tAnd ((dri.CourierRequestTypeId in (40,45,50) and sdpi.OperationTypeId =25) or (dri.CourierRequestTypeId not in  (40,45,50) And sdpi.OperationTypeId in (10,15,30))) --AND sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/,25)\r\n\t\t\t\t\t\t\t\t\t\t\tORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId=30/*Delivered*/\r\n\t\t\t\t\t\t\t\t\tTHEN 2\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId=35/*DeliveredWithDelay*/\r\n\t\t\t\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (40,17)/*Canceled(40)*/ \r\n\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dri\r\n\t\t\t\t\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drsi ON dri.DispatchRequestStatusId=drsi.Id\r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\tWHERE dr.Id=dri.Id\r\n                        AND sdpi.ShipmentId = @ShipmentId\r\n\t\t\t\t\t),1) OperationStatus,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\tSELECT TOP 1 DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\tFROM dp.ShipmentDestinationPoint(NOLOCK) sdpi\r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\tWHERE sdpdri.DispatchRequestId=dr.Id\r\n                        AND sdpi.ShipmentId = @ShipmentId\r\n\t\t\t\t\t\tAND sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/,30)\r\n\t\t\t\t\t\tORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t),\u0027\u0027) RemainedEstimatedDeliveryTimeSeconds,\r\n\t\t\t\t\tdr.VendorParcelCode,\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\t\t-- SELECT COUNT(CreateDate)\r\n\t\t\t\t\t\t\t-- FROM \r\n\t\t\t\t\t\t\t-- (\r\n\t\t\t\t\t\t\t-- SELECT LEFT(drfpas.CreateDate,12) CreateDate\r\n\t\t\t\t\t\t\t-- FROM dp.DispatchRequestFleetPreAssignmentState(NOLOCK) drfpas \r\n\t\t\t\t\t\t\t-- WHERE drfpas.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t\t-- GROUP BY LEFT(drfpas.CreateDate,12)\r\n\t\t\t\t\t\t\t-- )UnsuccessfulCount\r\n                            --select [dbo].[GetFleetPreAssignmentStateCount](dr.id)\r\n\t\t\t\t\t\t\tISNULL(cnt.fleetPreAssignmentStateCount,0)\r\n\t\t\t\t\t) fleetPreAssignmentStateCount,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\tdr.IsWaitingForSupport ,\r\n\t\t\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\t\t\tdr.VendorId,\r\n\t\t\t\t\tv.BrandName AS VendorBrandName,\r\n\t\t\t\t\tCASE WHEN dr.CourierRequestTypeId = 25 THEN dsprmGo.DeliveryServiceProviderOrderId ELSE dsprm.DeliveryServiceProviderOrderId END DeliveryServiceProviderOrderId\r\n\t\t\tFROM CTE_Main dr\r\n\t\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\t\tON dr.VendorId = v.Id\r\n\t\t\tLEFT JOIN CTE_DSPRM dsprm\r\n\t\t\t\tON dr.Id = dsprm.DispatchRequestId\r\n\t\t\t\tAND dr.ShipmentDestinationPointDispatchRequestVersion = dsprm.Version\r\n\t\t\tLEFT JOIN CTE_DSPRMGo dsprmGo\r\n\t\t\t\tON dr.CourierRequestTypeId = 25\r\n\t\t\t\tAND dr.VendorId = dsprmGo.VendorId\r\n\t\t\t\tAND dr.VendorParcelCode = dsprmGo.VendorParcelCode\r\n\t\t\t\tAND dr.ShipmentDestinationPointDispatchRequestVersion = dsprm.Version \r\n\t\t\tLEFT JOIN CTE_FleetPreAssignmentStateCount cnt\r\n\t\t\t\tON dr.Id = cnt.DispatchRequestId\r\n\t\t\tORDER BY SequenceNumber\r\n\t\t--\tFOR JSON PATH\r\n\t\t--) DispatchRequests\r\n\t--\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t--)\r\n\r\n\t--IF @Count=0 \r\n\t--BEGIN \r\n\t--\tSET @RESULT=NULL--\u0027{\u0022Count\u0022:0}\u0027\r\n\t--\tRETURN \r\n\t--END\r\n\t--ELSE\r\n\t--\tSET @RESULT=REPLACE(@RESULT,\u0027\\\u0027,\u0027\u0027)\r\n\r\n\r\n\t--select @RESULT\r\n\t\r\n\r\nSET @Count = ISNULL(@Count,0)\r\n\r\n\r\n"},{"Name":"Get_DispatchRequests_By_ShipmentId_BACKUP","Schema":"dbo","Definition":"/*\r\n\r\n\tDECLARE\r\n\t\t@Result NVARCHAR(MAX)=\u0027\u0027,\r\n\t\t@Count SMALLINT,\r\n\t\t@ReturnToStore_ShipmentDestinationPointID BIGINT ,\r\n\t\t@ReturnToStore_RemainedEsmatedDeliveryTimeSeconds INT ,\r\n\t\t@ReturnToStore_EstimatedDeliveryDateTimeStr NVARCHAR(MAX) \r\n\texec Get_DispatchRequests_By_ShipmentId @ShipmentId=233900,@OperationWarningRangeTime=\u002700:05:00\u0027,@RESULT =@RESULT OUTPUT,@Count=@Count OUTPUT , \r\n\t\t@ReturnToStore_ShipmentDestinationPointID = @ReturnToStore_ShipmentDestinationPointID OUTPUT,\r\n\t\t@ReturnToStore_RemainedEsmatedDeliveryTimeSeconds = @ReturnToStore_RemainedEsmatedDeliveryTimeSeconds OUTPUT,\r\n\t\t@ReturnToStore_EstimatedDeliveryDateTimeStr = @ReturnToStore_EstimatedDeliveryDateTimeStr OUTPUT\r\n\tSELECT @Result\r\n\r\n\tDECLARE @Result NVARCHAR(MAX)=\u0027\u0027\r\n\texec Get_DispatchRequests_By_ShipmentId1 @ShipmentId=943,@OperationWarningRangeTime=\u002700:05:00\u0027,@RESULT =@RESULT OUTPUT\r\n\tSELECT @Result\r\n*/\r\nCREATE      PROCEDURE [dbo].[Get_DispatchRequests_By_ShipmentId_BACKUP]\r\n\t--declare\r\n\t@ShipmentId\t\t\t\t\tBIGINT,\r\n\t@OperationWarningRangeTime\tTime(7),\r\n\t@Result\t\t\t\t\t\tNVARCHAR(MAX) = NULL OUTPUT,\r\n\t@Count\t\t\t\t\t\tSMALLINT OUTPUT,\r\n\t@ReturnToStore_ShipmentDestinationPointID BIGINT OUTPUT,\r\n\t@ReturnToStore_RemainedEsmatedDeliveryTimeSeconds INT OUTPUT,\r\n\t@ReturnToStore_EstimatedDeliveryDateTimeStr NVARCHAR(MAX) OUTPUT\r\nAS\r\n\r\n\t--declare @ShipmentId\t\t\tBIGINT=29\r\n\t--DECLARE @result NVARCHAR(MAX)=\u0027\u0027\r\n\t\r\n\r\n\t;WITH CTE_ReturnToStore AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tShipmentId,\r\n\t\t\tShipmentDestinationPointId ,\r\n\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) AS EstimatedDeliveryDateTimeStr ,\r\n\t\t\tDATEDIFF(SECOND,DATEADD(SECOND,EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)),GETDATE()) RemainedEsmatedDeliveryTimeSeconds\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tShipmentId,\r\n\t\t\t\tShipmentDestinationPointID,\r\n\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\tEstimatedOperationTimeSeconds,\r\n\t\t\t\tFIRST_VALUE(ShipmentDestinationPointID_ReturnToStore) OVER ( PARTITION BY ShipmentId ORDER BY ShipmentDestinationPointID_ReturnToStore DESC ) ShipmentDestinationPointID_ReturnToStore,\r\n\t\t\t\tFIRST_VALUE(SecondCon) OVER ( PARTITION BY ShipmentId ORDER BY SecondCon DESC ) SecondCon\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tsdp.ShipmentId,\r\n\t\t\t\t\tsdp.ID AS ShipmentDestinationPointID,\r\n\t\t\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId = 30 AND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35,40 ) AND dr.ID IS NULL THEN sdp.ID ELSE NULL END ShipmentDestinationPointID_ReturnToStore,\r\n\t\t\t\t\tCASE WHEN sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ) AND dr.ID IS NOT NULL  THEN 1 ELSE 0 END SecondCon\r\n\t\t\t\tFROM DP.Shipment s (NOLOCK)\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\t\tON s.ID = sdp.ShipmentId\r\n\t\t\t\t\tAND s.ID = @ShipmentId\r\n\t\t\t\tLEFT JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\t\t\tLEFT JOIN DP.DispatchRequest dr (NOLOCK)\r\n\t\t\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\t\t) SQ\r\n\t\t) SQ\r\n\t\tWHERE ShipmentDestinationPointID_ReturnToStore = ShipmentDestinationPointID\r\n\t\tAND SQ.SecondCon = 0\r\n\t)\r\n\tSELECT \r\n\t\t@ReturnToStore_ShipmentDestinationPointID = ShipmentDestinationPointId,\r\n\t\t@ReturnToStore_EstimatedDeliveryDateTimeStr = CONVERT(NVARCHAR(MAX),EstimatedDeliveryDateTimeStr,121) ,\r\n\t\t@ReturnToStore_RemainedEsmatedDeliveryTimeSeconds = RemainedEsmatedDeliveryTimeSeconds\r\n\tFROM CTE_ReturnToStore\r\n\r\n\tDROP TABLE IF EXISTS #DispatchRequestIds\r\n\r\n\tSELECT (CASE WHEN (COUNT(DISTINCT dr.VendorParcelCode)=COUNT(dr.VendorParcelCode)) THEN 1 ELSE 0 END) VendorParcelCode_Is_Unique,dr.VendorParcelCode\r\n\tINTO #DispatchRequestIds\r\n\tFROM dp.DispatchRequest(NOLOCK) dr\r\n\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs ON dr.DispatchRequestStatusId=drs.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr ON sdpdr.DispatchRequestId=dr.Id\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp ON sdp.id=sdpdr.ShipmentDestinationPointId\r\n\tWHERE sdp.ShipmentId=@ShipmentId\r\n\tAND sdp.OperationTypeId IN(5,20,25)/*Pickup*/\r\n\tGROUP BY dr.VendorParcelCode\r\n\r\n\r\n\t--DECLARE @Count\tSMALLINT=0\r\n\tSET @Count=(\r\n\tSELECT\tCount(DISTINCT VendorParcelCode)\r\n\tFROM(\r\n\tSELECT dr.Id,dri.VendorParcelCode,DispatchRequestStatusId,VendorParcelCode_Is_Unique\r\n\tFROM #DispatchRequestIds dri\r\n\tINNER JOIN dp.DispatchRequest(NOLOCK) dr ON dr.VendorParcelCode=dri.VendorParcelCode\r\n\t)CNT\r\n\t--WHERE (CNT.VendorParcelCode_Is_Unique=0 AND CNT.DispatchRequestStatusId\u003C\u003E40)OR (CNT.VendorParcelCode_Is_Unique=1)\r\n\t)\r\n\t\r\n\t--IF @Count=0 \r\n\t--BEGIN \r\n\t--\t--SET @RESULT=NULL--\u0027{\u0022Count\u0022:0}\u0027\r\n\t--\tRETURN \r\n\t--END\r\n\r\n\t;WITH CTE1 AS\r\n\t(\r\n\t\tSELECT\tCNT.Id\r\n\t\tFROM(\r\n\t\tSELECT dr.Id,dri.VendorParcelCode,DispatchRequestStatusId,VendorParcelCode_Is_Unique\r\n\t\tFROM #DispatchRequestIds dri\r\n\t\tINNER JOIN dp.DispatchRequest dr ON dr.VendorParcelCode=dri.VendorParcelCode\r\n\t\t)CNT\r\n\t\t--WHERE (CNT.VendorParcelCode_Is_Unique=0 AND CNT.DispatchRequestStatusId\u003C\u003E40)OR (CNT.VendorParcelCode_Is_Unique=1)\r\n\t)\r\n\t--SELECT @RESULT=(\r\n\t\t--SELECT  \r\n\t\t--\t@Count Count,\r\n\t\t--\t@ShipmentId As ,ShipmentId\r\n\t\t\t--(\r\n\t\t\tSELECT\tDISTINCT\r\n\t\t\t\t\tdr.Id,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId IN ( 10,20,25 ) AND sdp.ShipmentDestinationPointStatusId = 40 AND dr.DispatchRequestStatusId \u003C\u003E 17\r\n\t\t\t\t\t\t\tTHEN CAST(17 AS TINYINT)\r\n\t\t\t\t\tELSE dr.DispatchRequestStatusId\r\n\t\t\t\t\tEND AS DispatchRequestStatusId,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\t\tWHEN dr.IsWaitingForSupport = 1 \r\n\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN ( 15,16 ) THEN N\u0027\u0645\u0646\u062A\u0638\u0631 \u067E\u0627\u0633\u062E \u0639\u062F\u0645 \u062C\u0645\u0639 \u0622\u0648\u0631\u06CC\u0027 \r\n\t\t\t\t\t\t\t\t\tELSE drs.Title\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId = 25 \r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 20 THEN N\u0027\u0645\u0631\u062C\u0648\u0639 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (30,35) THEN N\u0027\u062A\u062D\u0648\u06CC\u0644 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdrs.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId IN (40,45,50)\r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0646\u0642\u0637\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdrs.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId = 51 \r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 20 THEN N\u0027\u0628\u0633\u062A\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u062C\u0645\u0639 \u0622\u0648\u0631\u06CC \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0646\u0642\u0637\u0647 \u062A\u062D\u0648\u06CC\u0644 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 30 THEN N\u0027\u0628\u0633\u062A\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 35 THEN N\u0027\u0628\u0633\u062A\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u0628\u0627 \u062A\u0627\u062E\u06CC\u0631 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdrs.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId IN (26,30,35) \r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 15 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0646\u0642\u0637\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 20 THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u062C\u0645\u0639 \u0622\u0648\u0631\u06CC \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0631\u0627\u06CC \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 30 THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 35 THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0627 \u062A\u0627\u062E\u06CC\u0631 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdrs.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN sdp.OperationTypeId IN ( 10,20,25 ) AND sdp.ShipmentDestinationPointStatusId = 40 AND dr.DispatchRequestStatusId \u003C\u003E 17\r\n\t\t\t\t\t\t\tTHEN N\u0027\u062C\u0645\u0639 \u0622\u0648\u0631\u06CC \u0646\u0634\u062F\u0027\r\n\t\t\t\t\t\tELSE   \r\n\t\t\t\t\t\t\tdrs.Title\t\t\t\t\t\r\n\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n\t\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\t\tdr.CourierRequestTypeId,\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryStartTime ,\u0027####-##-## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryStartTimeStr,\r\n\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryStartTimePersian ,\u0027####/##/## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryStartTimePersianStr,\r\n\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryDeadLineTime ,\u0027####-##-## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryDeadLineTimeStr,\r\n\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryDeadLineTimePersian ,\u0027####/##/## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryDeadLineTimePersianStr,\r\n\r\n\t\t\t\t\tdr.ClientAddress,\r\n\t\t\t\t\t--JSON_QUERY(ISNULL((\r\n\t\t\t\t\t--\tSELECT dr.ClientLocation.STY  AS  Latitude,dr.ClientLocation.STX  AS Longitude\r\n\t\t\t\t\t--\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t--),\u0027\u0027)) ClientLocation,\r\n\t\t\t\t\tdr.ClientLocation.STY AS Latitude,\r\n\t\t\t\t\tdr.ClientLocation.STX AS Longitude,\r\n\t\t\t\t\tdps.StoreId,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\t\t\t--SELECT  TOP 1 DATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t--FROM dp.DispatchRequest(NOLOCK) dri\r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t--WHERE dr.Id=dri.Id\r\n\t\t\t\t\t\t--AND sdpi.OperationTypeId in(5)/*PickUp*/\r\n\t\t\t\t\t\t--ORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t\tSELECT  TOP 1 DATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n                        FROM dp.DispatchRequest(NOLOCK) dri\r\n                        INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n                        INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n                        WHERE dr.Id=dri.Id\r\n                        AND ((dri.CourierRequestTypeId = 51 and sdpi.OperationTypeId in (25)/*PickUp*/) or (dri.CourierRequestTypeId \u003C\u003E 51 and sdpi.OperationTypeId in (5,20)))\r\n                        ORDER BY sdpdri.CreateDate DESC\r\n\r\n\t\t\t\t\t),0) EstimatedPickupDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\tSELECT FORMAT(drshi.CreateDate ,\u0027####-##-## ##:##:##\\.###\u0027)\r\n\t\t\t\t\t\tFROM dp.DispatchRequestStatusHistory(NOLOCK) drshi \r\n\t\t\t\t\t\tWHERE drshi.DispatchRequestId=dr.Id \r\n\t\t\t\t\t\tAND drshi.DispatchRequestStatusId=20/*Pickup*/\r\n\t\t\t\t\t),\u0027\u0027) PickupDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\t\t\t--SELECT TOP 1 DATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t--FROM dp.ShipmentDestinationPoint(NOLOCK) sdpi\r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t--WHERE sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t--AND sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/)\r\n\t\t\t\t\t\t--ORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t\tSELECT TOP 1 DATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dri\r\n                        INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n                        INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n                        WHERE dr.Id=dri.Id\r\n\t\t\t\t\t\tAnd ((dri.CourierRequestTypeId in (40,45,50) and sdpi.OperationTypeId =25) or (dri.CourierRequestTypeId not in  (40,45,50) \r\n\t\t\t\t\t\tAnd sdpi.OperationTypeId in (10,15,30))) \r\n\t\t\t\t\t\r\n\t\t\t\t\t\tORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t),\u0027\u0027) EstimatedDeliveryDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\tSELECT FORMAT(drshi.CreateDate ,\u0027####-##-## ##:##:##\\.###\u0027) \r\n\t\t\t\t\t\tFROM dp.DispatchRequestStatusHistory(NOLOCK) drshi \r\n\t\t\t\t\t\tWHERE drshi.DispatchRequestId=dr.Id \r\n\t\t\t\t\t\tAND drshi.DispatchRequestStatusId IN (30,35)/*Delivered,DeliveredWithDelay*/\r\n\t\t\t\t\t),\u0027\u0027) DeliveryDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\tSELECT TOP 1 sdpi.SequenceNumber\r\n\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dri\r\n                        INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n                        INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n                        WHERE dr.Id=dri.Id\r\n\t\t\t\t\t\tAnd ((dri.CourierRequestTypeId in (40,45,50) and sdpi.OperationTypeId =25) or (dri.CourierRequestTypeId not in  (40,45,50) \r\n\t\t\t\t\t\tAnd sdpi.OperationTypeId in (10,15,30))) \r\n\t\t\t\t\t\tORDER BY sdpi.id DESC \r\n\t\t\t\t\t),0) SequenceNumber,\r\n\t\t\t\t\t(\t\r\n\t\t\t\t\t\tSELECT\tTOP 1 \r\n\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (10/*Assigned toCourier*/,15/*Arrived at Pickup point*/,11,16) \r\n\t\t\t\t\t\t\t\t\tTHEN (\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT TOP 1 \r\n\t\t\t\t\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003C(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,--A\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\tBETWEEN DATEADD(SECOND,--A\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 3\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003EDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND\t\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) drii\r\n\t\t\t\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdrii ON sdpdrii.DispatchRequestId=drii.Id\r\n\t\t\t\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpii ON sdpii.id=sdpdrii.ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE dri.Id=drii.Id\r\n\t\t\t\t\t\t\t\t\t\t\tAND ((dri.CourierRequestTypeId = 51 and sdpi.OperationTypeId in (25)/*PickUp*/) or (dri.CourierRequestTypeId \u003C\u003E 51 and sdpi.OperationTypeId in (5,20)))--AND sdpii.OperationTypeId=5/*PickUp*/\r\n\t\t\t\t\t\t\t\t\t\t\tORDER BY sdpdrii.CreateDate DESC\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (20,25,45,50,46,47,48,49,51,52,53,54)  \r\n\t\t\t\t\t\t\t\t\tTHEN (\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT\tTOP 1 CASE \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003C\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,--B\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE() BETWEEN \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,--B\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 3\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003EDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\t\t\t\t\tFROM dp.ShipmentDestinationPoint(NOLOCK) sdpi\r\n\t\t\t\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t\t\t\t\t\tAnd ((dri.CourierRequestTypeId in (40,45,50) and sdpi.OperationTypeId =25) or (dri.CourierRequestTypeId not in  (40,45,50) And sdpi.OperationTypeId in (10,15,30))) --AND sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/,25)\r\n\t\t\t\t\t\t\t\t\t\t\tORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId=30/*Delivered*/\r\n\t\t\t\t\t\t\t\t\tTHEN 2\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId=35/*DeliveredWithDelay*/\r\n\t\t\t\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (40,17)/*Canceled(40)*/ \r\n\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\t\tWHEN sdp.OperationTypeId IN ( 10,20,25 ) AND sdp.ShipmentDestinationPointStatusId = 40 AND dri.DispatchRequestStatusId \u003C\u003E 17\r\n\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dri\r\n\t\t\t\t\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drsi ON dri.DispatchRequestStatusId=drsi.Id\r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\tWHERE dr.Id=dri.Id\r\n\t\t\t\t\t) OperationStatus,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\tSELECT TOP 1 DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\tFROM dp.ShipmentDestinationPoint(NOLOCK) sdpi\r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\tWHERE sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\tAND sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/,30)\r\n\t\t\t\t\t\tORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t),\u0027\u0027) RemainedEstimatedDeliveryTimeSeconds,\r\n\t\t\t\t\tVendorParcelCode,\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\t\t-- SELECT COUNT(CreateDate)\r\n\t\t\t\t\t\t\t-- FROM \r\n\t\t\t\t\t\t\t-- (\r\n\t\t\t\t\t\t\t-- SELECT LEFT(drfpas.CreateDate,12) CreateDate\r\n\t\t\t\t\t\t\t-- FROM dp.DispatchRequestFleetPreAssignmentState(NOLOCK) drfpas \r\n\t\t\t\t\t\t\t-- WHERE drfpas.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t\t-- GROUP BY LEFT(drfpas.CreateDate,12)\r\n\t\t\t\t\t\t\t-- )UnsuccessfulCount\r\n                            select [dbo].[GetFleetPreAssignmentStateCount](dr.id)\r\n\t\t\t\t\t) fleetPreAssignmentStateCount,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\tdr.IsWaitingForSupport \r\n\t\t\tFROM dp.DispatchRequest(NOLOCK) dr\r\n\t\t\tINNER JOIN CTE1\t\t\t\t\t\t\t\t\t\t\t\tON dr.Id=CTE1.Id\r\n\t\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs\t\t\t\t\t\tON dr.DispatchRequestStatusId=drs.Id\r\n\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr ON sdpdr.DispatchRequestId=dr.Id\r\n\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON sdp.id=sdpdr.ShipmentDestinationPointId AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 35\r\n\t\t\tINNER JOIN dp.PolygonStore(NOLOCK) dps\t\t\t\t\t\t\t\tON dps.Id=dr.PolygonStoreId\r\n\t\t\tWHERE sdp.ShipmentId=@ShipmentId\r\n            and NOT (dr.DispatchRequestStatusId = 80 --Not Delivered \r\n\t\t\t\t\t\t OR (dr.CourierRequestTypeId = 51 AND dr.DispatchRequestStatusId NOT IN (20,25,30,35))\r\n\t\t\t\t\t\t OR (dr.CourierRequestTypeId IN (40,45,50) AND dr.DispatchRequestStatusId IN (30,35))\r\n\t\t\t\t )\r\n\t\t\tORDER BY SequenceNumber\r\n\t\t--\tFOR JSON PATH\r\n\t\t--) DispatchRequests\r\n\t--\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t--)\r\n\r\n\t--IF @Count=0 \r\n\t--BEGIN \r\n\t--\tSET @RESULT=NULL--\u0027{\u0022Count\u0022:0}\u0027\r\n\t--\tRETURN \r\n\t--END\r\n\t--ELSE\r\n\t--\tSET @RESULT=REPLACE(@RESULT,\u0027\\\u0027,\u0027\u0027)\r\n\r\n\r\n\t--select @RESULT\r\n\t\r\n\r\nSET @Count = ISNULL(@Count,0)\r\n\r\n\r\n\r\n"},{"Name":"Get_DispatchRequests_By_ShipmentId_WithVersionCLM","Schema":"dbo","Definition":"CREATE      PROCEDURE [dbo].[Get_DispatchRequests_By_ShipmentId_WithVersionCLM]\r\n\t--declare\r\n\t@ShipmentId\t\t\t\t\tBIGINT,\r\n\t@OperationWarningRangeTime\tTime(7),\r\n\t@Result\t\t\t\t\t\tNVARCHAR(MAX) = NULL OUTPUT,\r\n\t@Count\t\t\t\t\t\tSMALLINT OUTPUT,\r\n\t@ReturnToStore_ShipmentDestinationPointID BIGINT OUTPUT,\r\n\t@ReturnToStore_RemainedEsmatedDeliveryTimeSeconds INT OUTPUT,\r\n\t@ReturnToStore_EstimatedDeliveryDateTimeStr NVARCHAR(MAX) OUTPUT\r\nAS\r\n\r\n\r\n\t;WITH CTE_ReturnToStore AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tShipmentId,\r\n\t\t\tShipmentDestinationPointId ,\r\n\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) AS EstimatedDeliveryDateTimeStr ,\r\n\t\t\tDATEDIFF(SECOND,DATEADD(SECOND,EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)),GETDATE()) RemainedEsmatedDeliveryTimeSeconds\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tShipmentId,\r\n\t\t\t\tShipmentDestinationPointID,\r\n\t\t\t\tEstimatedArrivalTime,\r\n\t\t\t\tEstimatedOperationTimeSeconds,\r\n\t\t\t\tFIRST_VALUE(ShipmentDestinationPointID_ReturnToStore) OVER ( PARTITION BY ShipmentId ORDER BY ShipmentDestinationPointID_ReturnToStore DESC ) ShipmentDestinationPointID_ReturnToStore,\r\n\t\t\t\tFIRST_VALUE(SecondCon) OVER ( PARTITION BY ShipmentId ORDER BY SecondCon DESC ) SecondCon\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tsdp.ShipmentId,\r\n\t\t\t\t\tsdp.ID AS ShipmentDestinationPointID,\r\n\t\t\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId = 30 AND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35,40 ) AND dr.ID IS NULL THEN sdp.ID ELSE NULL END ShipmentDestinationPointID_ReturnToStore,\r\n\t\t\t\t\tCASE WHEN sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ) AND dr.ID IS NOT NULL  THEN 1 ELSE 0 END SecondCon\r\n\t\t\t\tFROM DP.Shipment s (NOLOCK)\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\t\tON s.ID = sdp.ShipmentId\r\n\t\t\t\t\tAND s.ID = @ShipmentId\r\n\t\t\t\tLEFT JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\t\t\tLEFT JOIN DP.DispatchRequest dr (NOLOCK)\r\n\t\t\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\t\t) SQ\r\n\t\t) SQ\r\n\t\tWHERE ShipmentDestinationPointID_ReturnToStore = ShipmentDestinationPointID\r\n\t\tAND SQ.SecondCon = 0\r\n\t)\r\n\tSELECT \r\n\t\t@ReturnToStore_ShipmentDestinationPointID = ShipmentDestinationPointId,\r\n\t\t@ReturnToStore_EstimatedDeliveryDateTimeStr = CONVERT(NVARCHAR(MAX),EstimatedDeliveryDateTimeStr,121) ,\r\n\t\t@ReturnToStore_RemainedEsmatedDeliveryTimeSeconds = RemainedEsmatedDeliveryTimeSeconds\r\n\tFROM CTE_ReturnToStore\r\n\r\n\tDROP TABLE IF EXISTS #DispatchRequestIds\r\n\r\n\tSELECT (CASE WHEN (COUNT(DISTINCT dr.VendorParcelCode)=COUNT(dr.VendorParcelCode)) THEN 1 ELSE 0 END) VendorParcelCode_Is_Unique,dr.VendorParcelCode\r\n\tINTO #DispatchRequestIds\r\n\tFROM dp.DispatchRequest(NOLOCK) dr\r\n\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs ON dr.DispatchRequestStatusId=drs.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr ON sdpdr.DispatchRequestId=dr.Id\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp ON sdp.id=sdpdr.ShipmentDestinationPointId\r\n\tWHERE sdp.ShipmentId=@ShipmentId\r\n\tAND sdp.OperationTypeId IN(5,20,25)/*Pickup*/\r\n\tGROUP BY dr.VendorParcelCode\r\n\r\n\r\n\t--DECLARE @Count\tSMALLINT=0\r\n\tSET @Count=(\r\n\tSELECT\tCount(DISTINCT VendorParcelCode)\r\n\tFROM(\r\n\tSELECT dr.Id,dri.VendorParcelCode,DispatchRequestStatusId,VendorParcelCode_Is_Unique\r\n\tFROM #DispatchRequestIds dri\r\n\tINNER JOIN dp.DispatchRequest(NOLOCK) dr ON dr.VendorParcelCode=dri.VendorParcelCode\r\n\t)CNT\r\n\t--WHERE (CNT.VendorParcelCode_Is_Unique=0 AND CNT.DispatchRequestStatusId\u003C\u003E40)OR (CNT.VendorParcelCode_Is_Unique=1)\r\n\t)\r\n\t\r\n\r\n\t\r\n\r\n\t--IF @Count=0 \r\n\t--BEGIN \r\n\t--\t--SET @RESULT=NULL--\u0027{\u0022Count\u0022:0}\u0027\r\n\t--\tRETURN \r\n\t--END\r\n\r\n\t--;WITH CTE1 AS\r\n\t--(\r\n\t--\tSELECT\tCNT.Id\r\n\t--\tFROM(\r\n\t--\tSELECT dr.Id,dri.VendorParcelCode,DispatchRequestStatusId,VendorParcelCode_Is_Unique\r\n\t--\tFROM #DispatchRequestIds dri\r\n\t--\tINNER JOIN dp.DispatchRequest dr ON dr.VendorParcelCode=dri.VendorParcelCode\r\n\t--\t)CNT\r\n\t--\t--WHERE (CNT.VendorParcelCode_Is_Unique=0 AND CNT.DispatchRequestStatusId\u003C\u003E40)OR (CNT.VendorParcelCode_Is_Unique=1)\r\n\t--)\r\n\t--SELECT @RESULT=(\r\n\t\t--SELECT  \r\n\t\t--\t@Count Count,\r\n\t\t--\t@ShipmentId As ,ShipmentId\r\n\t\t\t--(\r\n\t\t\t\r\n\t\t\t;WITH CTE_DR AS\r\n\t\t\t(\r\n\t\t\t\tSELECT DISTINCT dr.Id  \r\n\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dr\r\n\t\t\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs\t\t\t\t\t\tON dr.DispatchRequestStatusId=drs.Id\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr ON sdpdr.DispatchRequestId=dr.Id\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON sdp.id=sdpdr.ShipmentDestinationPointId AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 35\r\n\t\t\t\tINNER JOIN dp.PolygonStore(NOLOCK) dps\t\t\t\t\t\t\t\tON dps.Id=dr.PolygonStoreId\r\n\t\t\t\tINNER JOIN dp.Shipment s (NOLOCK)\r\n\t\t\t\t\tON sdp.ShipmentId = s.Id\r\n\t\t\t\tWHERE \r\n\t\t\t\tsdp.ShipmentId = @ShipmentId\r\n\t\t\t),CTE_Main AS\r\n\t\t\t(\r\n\t\t\t\tSELECT * FROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t--FIRST_VALUE( CASE WHEN sdp.OperationTypeId IN ( 10,20,25 ) THEN sdp.OperationTypeId ELSE NULL END ) OVER ( PARTITION BY dr.ID ORDER BY CASE WHEN sdp.OperationTypeId IN ( 10,20,25 ) THEN sdp.OperationTypeId ELSE NULL END DESC ) OperationType_10,\r\n\t\t\t\t\t\t--FIRST_VALUE( CASE WHEN sdp.OperationTypeId IN ( 10,20,25 ) AND sdp.ShipmentDestinationPointStatusId = 40 THEN 1 ELSE 0 END ) OVER ( PARTITION BY dr.ID ORDER BY CASE WHEN sdp.OperationTypeId IN ( 10,20,25 ) AND sdp.ShipmentDestinationPointStatusId = 40 THEN 1 ELSE 0 END DESC ) OperationStatus_Reassigned,\r\n\t\t\t\t\t\t--FIRST_VALUE(s.Id) OVER ( PARTITION BY dr.Id ORDER BY s.CreateDate ASC ) FSH,\r\n\t\t\t\t\t\t--FIRST_VALUE(s.Id) OVER ( PARTITION BY dr.Id ORDER BY s.CreateDate DESC) LSH,\r\n\t\t\t\t\t\tdr.Id , \r\n\t\t\t\t\t\tdr.DispatchRequestStatusId ,\r\n\t\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\t\tdr.IsWaitingForSupport ,\r\n\t\t\t\t\t\tdr.CourierRequestTypeId,\r\n\t\t\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\t\t\tdr.DeliveryStartTime,\r\n\t\t\t\t\t\tdr.DeliveryStartTimePersian,\r\n\t\t\t\t\t\tdr.DeliveryDeadLineTime,\r\n\t\t\t\t\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\t\t\t\t\tdr.ClientAddress,\r\n\t\t\t\t\t\tdr.ClientLocation,\r\n\t\t\t\t\t\tdr.VendorParcelCode,\r\n\r\n\t\t\t\t\t\tdrs.Title,\r\n\r\n\t\t\t\t\t\tdps.StoreId,\r\n\r\n\t\t\t\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\t\t\t\tsdp.OperationTypeId,\r\n\t\t\t\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\t\t\t\tsdp.ShipmentId,\r\n\t\t\t\t\t\tdr.VendorId,\r\n\t\t\t\t\t\tCASE WHEN dr.Version = sdpdr.Version THEN 0 ELSE 1 END OperationStatus_Reassigned,\r\n\t\t\t\t\t\tdr.Version AS DispatchRequestVersion,\r\n\t\t\t\t\t\tsdpdr.Version AS ShipmentDestinationPointDispatchRequestVersion\r\n\t\t\t\t\tFROM CTE_DR d\r\n\t\t\t\t\tINNER JOIN dp.DispatchRequest(NOLOCK) dr\r\n\t\t\t\t\t\tON d.Id = dr.Id\r\n\t\t\t\t\t--INNER JOIN CTE1\t\t\t\t\t\t\t\t\t\t\t\tON dr.Id=CTE1.Id\r\n\t\t\t\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs\t\t\t\t\t\tON dr.DispatchRequestStatusId=drs.Id\r\n\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr ON sdpdr.DispatchRequestId=dr.Id\r\n\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON sdp.id=sdpdr.ShipmentDestinationPointId AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 35\r\n\t\t\t\t\tINNER JOIN dp.PolygonStore(NOLOCK) dps\t\t\t\t\t\t\t\tON dps.Id=dr.PolygonStoreId\r\n\t\t\t\t\tINNER JOIN dp.Shipment s (NOLOCK)\r\n\t\t\t\t\t\tON sdp.ShipmentId = s.Id\r\n\t\t\t\t\tWHERE \r\n\r\n\t\t\t\t\tNOT \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\t\tdr.DispatchRequestStatusId = 80 --Not Delivered \r\n\t\t\t\t\t\tOR (dr.CourierRequestTypeId = 51 AND dr.DispatchRequestStatusId NOT IN (20,25,30,35))\r\n\t\t\t\t\t\tOR (dr.CourierRequestTypeId IN (40,45,50) AND dr.DispatchRequestStatusId IN (30,35))\r\n\t\t\t\t\t)\r\n\t\t\t\t) SQ\r\n\t\t\t\tWHERE SQ.ShipmentId = @ShipmentId\r\n\r\n\t\t\t),CTE_DSPRM AS\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tdsprm.DispatchRequestId,\r\n\t\t\t\t\tdsprm.DeliveryServiceProviderOrderId\r\n\t\t\t\tFROM DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\t\t\t\tINNER JOIN CTE_Main dr\r\n\t\t\t\t\tON dsprm.DispatchRequestId = dr.Id\r\n\t\t\t\t\tAND dsprm.IsActive = 1\r\n\t\t\t),CTE_DSPRMGo AS\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tdr.Id AS DispatchRequestId,\r\n\t\t\t\t\tdsprm.DeliveryServiceProviderOrderId\r\n\t\t\t\tFROM CTE_Main dr\r\n\t\t\t\tINNER JOIN DP.DispatchRequest drGo (NOLOCK)\r\n\t\t\t\t\tON dr.CourierRequestTypeId = 25\r\n\t\t\t\t\tAND dr.VendorId = drGo.VendorId\r\n\t\t\t\t\tAND dr.VendorParcelCode = drGo.VendorParcelCode\r\n\t\t\t\t\tAND drGo.CourierRequestTypeId IN ( 5,10,15 )\r\n\t\t\t\tINNER JOIN DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\t\t\t\t\tON dsprm.DispatchRequestId = drGo.Id\r\n\t\t\t\t\tAND dsprm.IsActive = 1\r\n\t\t\t)\r\n\r\n\t\t\tSELECT\tDISTINCT \r\n\t\t\t\t\tdr.Id,\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN OperationStatus_Reassigned = 1 AND ( dr.DispatchRequestStatusId = 7/*6 OR dr.DispatchRequestStatusId = 17*/ )\r\n\t\t\t\t\t\t\tTHEN CAST(17 AS TINYINT)\r\n\t\t\t\t\t\tWHEN OperationStatus_Reassigned = 1 AND dr.DispatchRequestStatusId IN ( 11,16 ) --AND ( dr.FSH = dr.LSH )\r\n\t\t\t\t\t\t\tTHEN dr.DispatchRequestStatusId\r\n\t\t\t\t\t\tWHEN OperationStatus_Reassigned = 1 AND dr.DispatchRequestStatusId IN ( 11,16,35 ) --AND ( dr.FSH \u003C\u003E dr.LSH )\r\n\t\t\t\t\t\t\tTHEN CASE WHEN dr.ShipmentId = @ShipmentId \r\n\t\t\t\t\t\t\tTHEN CAST(17 AS TINYINT) ELSE  dr.DispatchRequestStatusId END\r\n\t\t\t\t\tELSE dr.DispatchRequestStatusId\r\n\t\t\t\t\tEND AS DispatchRequestStatusId,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\t\tWHEN OperationStatus_Reassigned = 1 AND ( dr.DispatchRequestStatusId = 7/*6 OR dr.DispatchRequestStatusId = 17*/ )\r\n\t\t\t\t\t\t\tTHEN N\u0027\u062C\u0645\u0639 \u0622\u0648\u0631\u06CC \u0646\u0634\u062F\u0027\r\n\t\t\t\t\t\t\tWHEN OperationStatus_Reassigned = 1 AND dr.DispatchRequestStatusId IN ( 11,16 )-- AND ( dr.FSH = dr.LSH )\r\n\t\t\t\t\t\t\tTHEN dr.Title\r\n\t\t\t\t\t\tWHEN OperationStatus_Reassigned = 1 AND dr.DispatchRequestStatusId IN ( 11,16,35 ) --AND ( dr.FSH \u003C\u003E dr.LSH )\r\n\t\t\t\t\t\t\tTHEN CASE WHEN dr.ShipmentId = @ShipmentId \r\n\t\t\t\t\t\t\tTHEN N\u0027\u062C\u0645\u0639 \u0622\u0648\u0631\u06CC \u0646\u0634\u062F\u0027 ELSE  dr.Title END\r\n\r\n\t\t\t\t\t\tWHEN dr.IsWaitingForSupport = 1 \r\n\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN ( 15,16 ) THEN N\u0027\u0645\u0646\u062A\u0638\u0631 \u067E\u0627\u0633\u062E \u0639\u062F\u0645 \u062C\u0645\u0639 \u0622\u0648\u0631\u06CC\u0027 \r\n\t\t\t\t\t\t\t\t\tELSE dr.Title\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId = 25 \r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 20 THEN N\u0027\u0645\u0631\u062C\u0648\u0639 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (30,35) THEN N\u0027\u062A\u062D\u0648\u06CC\u0644 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdr.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId IN (40,45,50)\r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0646\u0642\u0637\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdr.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId = 51 \r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 20 THEN N\u0027\u0628\u0633\u062A\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u062C\u0645\u0639 \u0622\u0648\u0631\u06CC \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0646\u0642\u0637\u0647 \u062A\u062D\u0648\u06CC\u0644 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 30 THEN N\u0027\u0628\u0633\u062A\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 35 THEN N\u0027\u0628\u0633\u062A\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u0628\u0627 \u062A\u0627\u062E\u06CC\u0631 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdr.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\tdr.CourierRequestTypeId IN (26,30,35) \r\n\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 15 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0646\u0642\u0637\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 20 THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u062C\u0645\u0639 \u0622\u0648\u0631\u06CC \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0631\u0627\u06CC \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 30 THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tWHEN dr.DispatchRequestStatusId = 35 THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0627 \u062A\u0627\u062E\u06CC\u0631 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\tdr.Title\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tELSE   \r\n\t\t\t\t\t\t\tdr.Title\t\t\t\t\t\r\n\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n\t\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\t\tdr.CourierRequestTypeId,\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryStartTime ,\u0027####-##-## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryStartTimeStr,\r\n\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryStartTimePersian ,\u0027####/##/## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryStartTimePersianStr,\r\n\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryDeadLineTime ,\u0027####-##-## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryDeadLineTimeStr,\r\n\r\n\t\t\t\t\tISNULL(FORMAT(dr.DeliveryDeadLineTimePersian ,\u0027####/##/## ##:##:##\\.###\u0027),\u0027\u0027) DeliveryDeadLineTimePersianStr,\r\n\r\n\t\t\t\t\tdr.ClientAddress,\r\n\t\t\t\t\t--JSON_QUERY(ISNULL((\r\n\t\t\t\t\t--\tSELECT dr.ClientLocation.STY  AS  Latitude,dr.ClientLocation.STX  AS Longitude\r\n\t\t\t\t\t--\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t--),\u0027\u0027)) ClientLocation,\r\n\t\t\t\t\tdr.ClientLocation.STY AS Latitude,\r\n\t\t\t\t\tdr.ClientLocation.STX AS Longitude,\r\n\t\t\t\t\tdr.StoreId,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\t\t\t--SELECT  TOP 1 DATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t--FROM dp.DispatchRequest(NOLOCK) dri\r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t--WHERE dr.Id=dri.Id\r\n\t\t\t\t\t\t--AND sdpi.OperationTypeId in(5)/*PickUp*/\r\n\t\t\t\t\t\t--ORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t\tSELECT  TOP 1 DATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n                        FROM dp.DispatchRequest(NOLOCK) dri\r\n                        INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n                        INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n                        WHERE dr.Id=dri.Id\r\n                        AND ((dri.CourierRequestTypeId = 51 and sdpi.OperationTypeId in (25)/*PickUp*/) or (dri.CourierRequestTypeId \u003C\u003E 51 and sdpi.OperationTypeId in (5,20)))\r\n                        ORDER BY sdpdri.CreateDate DESC\r\n\r\n\t\t\t\t\t),0) EstimatedPickupDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\tSELECT FORMAT(drshi.CreateDate ,\u0027####-##-## ##:##:##\\.###\u0027)\r\n\t\t\t\t\t\tFROM dp.DispatchRequestStatusHistory(NOLOCK) drshi \r\n\t\t\t\t\t\tWHERE drshi.DispatchRequestId=dr.Id \r\n\t\t\t\t\t\tAND drshi.DispatchRequestStatusId=20/*Pickup*/\r\n\t\t\t\t\t),\u0027\u0027) PickupDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\t\t\t--SELECT TOP 1 DATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t--FROM dp.ShipmentDestinationPoint(NOLOCK) sdpi\r\n\t\t\t\t\t\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t--WHERE sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t--AND sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/)\r\n\t\t\t\t\t\t--ORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t\tSELECT TOP 1 DATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dri\r\n                        INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n                        INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n                        WHERE dr.Id=dri.Id\r\n\t\t\t\t\t\tAnd ((dri.CourierRequestTypeId in (40,45,50) and sdpi.OperationTypeId =25) or (dri.CourierRequestTypeId not in  (40,45,50) \r\n\t\t\t\t\t\tAnd sdpi.OperationTypeId in (10,15,30))) \r\n\t\t\t\t\t\r\n\t\t\t\t\t\tORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t),\u0027\u0027) EstimatedDeliveryDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\tSELECT FORMAT(drshi.CreateDate ,\u0027####-##-## ##:##:##\\.###\u0027) \r\n\t\t\t\t\t\tFROM dp.DispatchRequestStatusHistory(NOLOCK) drshi \r\n\t\t\t\t\t\tWHERE drshi.DispatchRequestId=dr.Id \r\n\t\t\t\t\t\tAND drshi.DispatchRequestStatusId IN (30,35)/*Delivered,DeliveredWithDelay*/\r\n\t\t\t\t\t),\u0027\u0027) DeliveryDateTimeStr,\r\n\t\t\t\t\tISNULL((\r\n\t\t\tSELECT TOP 1 sdpi.SequenceNumber\r\n\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dri\r\n                        INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n                        INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n                        WHERE dr.Id=dri.Id\r\n\t\t\t\t\t\tAnd ((dri.CourierRequestTypeId in (40,45,50) and sdpi.OperationTypeId =25) or (dri.CourierRequestTypeId not in  (40,45,50) \r\n\t\t\t\t\t\tAnd sdpi.OperationTypeId in (10,15,30))) \r\n\t\t\t\t\t\tORDER BY sdpi.id DESC \r\n\t\t\t\t\t),0) SequenceNumber,\r\n\t\t\t\t\tISNULL((\t\r\n\t\t\t\t\t\tSELECT\tTOP 1 \r\n\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\tWHEN OperationStatus_Reassigned = 1 AND dr.DispatchRequestStatusId \u003C\u003E 17\r\n\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (10/*Assigned toCourier*/,15/*Arrived at Pickup point*/,11,16) \r\n\t\t\t\t\t\t\t\t\tTHEN (\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT TOP 1 \r\n\t\t\t\t\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003C(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,--A\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\tBETWEEN DATEADD(SECOND,--A\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 3\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003EDATEADD(SECOND,sdpi.EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(sdpi.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND\t\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) drii\r\n\t\t\t\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdrii ON sdpdrii.DispatchRequestId=drii.Id\r\n\t\t\t\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpii ON sdpii.id=sdpdrii.ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE dri.Id=drii.Id\r\n\t\t\t\t\t\t\t\t\t\t\tAND ((drii.CourierRequestTypeId = 51 and sdpii.OperationTypeId in (25)/*PickUp*/) or (drii.CourierRequestTypeId \u003C\u003E 51 and sdpii.OperationTypeId in (5,20)))--AND sdpii.OperationTypeId=5/*PickUp*/\r\n\t\t\t\t\t\t\t\t\t\t\tORDER BY sdpdrii.CreateDate DESC\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (20,25,45,50,46,47,48,49,51,52,53,54)  \r\n\t\t\t\t\t\t\t\t\tTHEN (\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT\tTOP 1 CASE \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003C\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,--B\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE() BETWEEN \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,--B\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 3\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN GETDATE()\u003EDATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\t\t\t\t\tFROM dp.ShipmentDestinationPoint(NOLOCK) sdpi\r\n\t\t\t\t\t\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\t\t\t\t\t\tWHERE sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t\t\t\t\t\tAnd ((dri.CourierRequestTypeId in (40,45,50) and sdpi.OperationTypeId =25) or (dri.CourierRequestTypeId not in  (40,45,50) And sdpi.OperationTypeId in (10,15,30))) --AND sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/,25)\r\n\t\t\t\t\t\t\t\t\t\t\tORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId=30/*Delivered*/\r\n\t\t\t\t\t\t\t\t\tTHEN 2\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId=35/*DeliveredWithDelay*/\r\n\t\t\t\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (40,17)/*Canceled(40)*/ \r\n\t\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dri\r\n\t\t\t\t\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drsi ON dri.DispatchRequestStatusId=drsi.Id\r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpdri.DispatchRequestId=dri.Id\r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdpi ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\tWHERE dr.Id=dri.Id\r\n\t\t\t\t\t),1) OperationStatus,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\tSELECT TOP 1 DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,EstimatedOperationTimeSeconds, CAST(CONVERT(varchar, FORMAT(EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)))\r\n\t\t\t\t\t\tFROM dp.ShipmentDestinationPoint(NOLOCK) sdpi\r\n\t\t\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdri ON sdpi.id=sdpdri.ShipmentDestinationPointId\r\n\t\t\t\t\t\tWHERE sdpdri.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\tAND sdpi.OperationTypeId IN (10/*Delivery*/,15/*Return*/,30)\r\n\t\t\t\t\t\tORDER BY sdpdri.CreateDate DESC\r\n\t\t\t\t\t),\u0027\u0027) RemainedEstimatedDeliveryTimeSeconds,\r\n\t\t\t\t\tVendorParcelCode,\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\t\t-- SELECT COUNT(CreateDate)\r\n\t\t\t\t\t\t\t-- FROM \r\n\t\t\t\t\t\t\t-- (\r\n\t\t\t\t\t\t\t-- SELECT LEFT(drfpas.CreateDate,12) CreateDate\r\n\t\t\t\t\t\t\t-- FROM dp.DispatchRequestFleetPreAssignmentState(NOLOCK) drfpas \r\n\t\t\t\t\t\t\t-- WHERE drfpas.DispatchRequestId=dr.Id\r\n\t\t\t\t\t\t\t-- GROUP BY LEFT(drfpas.CreateDate,12)\r\n\t\t\t\t\t\t\t-- )UnsuccessfulCount\r\n                            select [dbo].[GetFleetPreAssignmentStateCount](dr.id)\r\n\t\t\t\t\t) fleetPreAssignmentStateCount,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\tdr.IsWaitingForSupport ,\r\n\t\t\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\t\t\tdr.VendorId,\r\n\t\t\t\t\tv.BrandName AS VendorBrandName,\r\n\t\t\t\t\tCASE WHEN dr.CourierRequestTypeId = 25 THEN dsprmGo.DeliveryServiceProviderOrderId ELSE dsprm.DeliveryServiceProviderOrderId END DeliveryServiceProviderOrderId\r\n\t\t\tFROM CTE_Main dr\r\n\t\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\t\tON dr.VendorId = v.Id\r\n\t\t\tLEFT JOIN CTE_DSPRM dsprm\r\n\t\t\t\tON dr.Id = dsprm.DispatchRequestId\r\n\t\t\tLEFT JOIN CTE_DSPRMGo dsprmGo\r\n\t\t\t\tON dr.Id = dsprmGo.DispatchRequestId\r\n\t\t\tORDER BY SequenceNumber\r\n\t\t--\tFOR JSON PATH\r\n\t\t--) DispatchRequests\r\n\t--\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t--)\r\n\r\n\t--IF @Count=0 \r\n\t--BEGIN \r\n\t--\tSET @RESULT=NULL--\u0027{\u0022Count\u0022:0}\u0027\r\n\t--\tRETURN \r\n\t--END\r\n\t--ELSE\r\n\t--\tSET @RESULT=REPLACE(@RESULT,\u0027\\\u0027,\u0027\u0027)\r\n\r\n\r\n\t--select @RESULT\r\n\t\r\n\r\nSET @Count = ISNULL(@Count,0)\r\n\r\n\r\n"},{"Name":"Get_DispatchRequestStatusHistory_By_ParcelReferenceCode","Schema":"dbo","Definition":"\nCREATE PROC [dbo].[Get_DispatchRequestStatusHistory_By_ParcelReferenceCode]\n\t@ParcelReferenceCode BIGINT ,\n\t@IsWaitingForSupport BIT OUTPUT,\n\t@IsConfirmed TINYINT OUTPUT,\n\t@CourierRequestTypeId TINYINT OUTPUT,\n\t@OperationParcelReferenceCode BIGINT OUTPUT,\n\t@DeliveryServiceProviderOrderId VARCHAR(100) OUTPUT,\n\t@IsDeliveryCodeRequired BIT OUTPUT,\n\t@DeliveryServiceProviderId TINYINT OUTPUT,\n\t@VendorId INT OUTPUT\n\nAS\nSET NOCOUNT ON\nBEGIN\n\n\nDROP TABLE IF EXISTS #Parcel,#Output,#FleetAssignmentHistory\n\n\nDECLARE \n\t@ParcelReferenceCode_Return BIGINT,\n\t@ParcelReferenceCode_Delivery BIGINT\n\nIF EXISTS \n(\n\tSELECT 1 FROM DP.DispatchRequest dr WITH(NOLOCK)\n\tWHERE dr.ParcelReferenceCode = @ParcelReferenceCode\n\tAND dr.DispatchRequestStatusId = 80\n)\nBEGIN\n\n\tSET @ParcelReferenceCode_Delivery = @ParcelReferenceCode\n\tSET @IsWaitingForSupport = 0\n\tSET @IsConfirmed = 1\n\n\tSELECT \n\t\t@ParcelReferenceCode_Return = drR.ParcelReferenceCode,\n\t\t@OperationParcelReferenceCode = drR.ParcelReferenceCode,\n\t\t@CourierRequestTypeId = drR.CourierRequestTypeId,\n\t\t@IsDeliveryCodeRequired = CASE WHEN drR.DeliveryCode = 0 THEN 0 ELSE 1 END,\n\t\t@DeliveryServiceProviderId = drR.DeliveryServiceProviderId,\n\t\t@VendorId = drR.VendorId\n\tFROM DP.DispatchRequest dr WITH(NOLOCK)\n\tINNER JOIN DP.DispatchRequest drR WITH(NOLOCK)\n\t\tON dr.VendorId = drR.VendorId\n\t\tAND dr.VendorParcelCode = drR.VendorParcelCode\n\t\tAND drR.CourierRequestTypeId = 25\n\tWHERE dr.ParcelReferenceCode = @ParcelReferenceCode\n\tAND dr.DispatchRequestStatusId = 80\n\nEND\n\nELSE IF EXISTS \n(\n\tSELECT 1 FROM DP.DispatchRequest dr WITH(NOLOCK)\n\tWHERE dr.ParcelReferenceCode = @ParcelReferenceCode\n\tAND dr.CourierRequestTypeId = 25\n)\nBEGIN\n\n\tSET @ParcelReferenceCode_Return = @ParcelReferenceCode\n\tSET @OperationParcelReferenceCode = @ParcelReferenceCode\n\tSET @CourierRequestTypeId = 25\n\tSET @IsWaitingForSupport = 0\n\tSET @IsConfirmed = 1\n\n\tSELECT \n\t\t@ParcelReferenceCode_Delivery = drD.ParcelReferenceCode,\n\t\t@IsDeliveryCodeRequired = CASE WHEN dr.DeliveryCode = 0 THEN 0 ELSE 1 END,\n\t\t@DeliveryServiceProviderId = dr.DeliveryServiceProviderId,\n\t\t@VendorId = dr.VendorId\n\tFROM DP.DispatchRequest dr WITH(NOLOCK)\n\tINNER JOIN DP.DispatchRequest drD WITH(NOLOCK)\n\t\tON dr.VendorId = drD.VendorId\n\t\tAND dr.VendorParcelCode = drD.VendorParcelCode\n\t\tAND drD.CourierRequestTypeId IN ( 5,10,15 )\n\tWHERE dr.ParcelReferenceCode = @ParcelReferenceCode\n\tAND dr.CourierRequestTypeId = 25\nEND\nELSE\nBEGIN\n\tSET @ParcelReferenceCode_Return = 0\n\tSET @ParcelReferenceCode_Delivery = @ParcelReferenceCode\n\tSET @OperationParcelReferenceCode = @ParcelReferenceCode\n\n\tSELECT \n\t\t@IsWaitingForSupport = dr.IsWaitingForSupport,\n\t\t@CourierRequestTypeId = dr.CourierRequestTypeId,\n\t\t@IsDeliveryCodeRequired = CASE WHEN dr.DeliveryCode = 0 THEN 0 ELSE 1 END,\n\t\t@DeliveryServiceProviderId = dr.DeliveryServiceProviderId,\n\t\t@VendorId = dr.VendorId\n\tFROM DP.DispatchRequest dr WITH(NOLOCK)\n\tWHERE dr.ParcelReferenceCode = @ParcelReferenceCode\n\n\tSELECT \n\t\t@IsConfirmed = CASE WHEN cr.ConfirmationDate IS NOT NULL THEN 1 ELSE 0 END\n\tFROM CS_OrderManagement.OM.Parcel p WITH(NOLOCK)\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr WITH(NOLOCK)\n\t\tON p.CourierRequestId = cr.Id\n\tWHERE p.ParcelReferenceCode = @ParcelReferenceCode\n\nEND\n\nSELECT\n\tp.ParcelReferenceCode,\n\tdrsh.DispatchRequestStatusId,\n\tpish.UnsuccessfulOperationReasonId,\n\tdrsh.Location,\n\tofr.Title /* drsh.ExceptionDescription*/ AS ExceptionDescription,\n\tdrsh.CreateDate,\n\tdrsh.CreateDatePersian,\n\tdrsh.CreatorUserName,\n\tdrsh.DistanceFromPointMeter,\n\tdrsh.IsOutOfLocation,\n\tdrsh.Version,\n\tdrsh.CustomerRoleId,\n\tpish.ParcelItemStatusId\nINTO #Parcel\nFROM DP.DispatchRequest dr WITH(NOLOCK)\nINNER JOIN DP.DispatchRequestStatusHistory drsh WITH(NOLOCK)\n\tON dr.ID = drsh.DispatchRequestId\nINNER JOIN CS_OrderManagement.OM.Parcel p WITH(NOLOCK)\n\tON dr.ParcelReferenceCode = p.ParcelReferenceCode\nINNER JOIN CS_OrderManagement.OM.ParcelItem pi WITH(NOLOCK)\n\tON p.Id = pi.ParcelId\nINNER JOIN CS_OrderManagement.OM.ParcelItemStatusHistory pish WITH(NOLOCK)\n\tON pi.ID = pish.ParcelItemId\nLEFT JOIN CS_OrderManagement.OM.UnsuccessfulOperationReason ofr WITH(NOLOCK)\n\tON pish.UnsuccessfulOperationReasonId = ofr.Id\nWHERE p.ParcelReferenceCode = @ParcelReferenceCode_Delivery\nAND \n(\n\t\t(drsh.DispatchRequestStatusId = 45 AND pish.ParcelItemStatusId = 35)\n\tOR\t(drsh.DispatchRequestStatusId = 46 AND pish.ParcelItemStatusId = 36)\n\tOR\t(drsh.DispatchRequestStatusId = 47 AND pish.ParcelItemStatusId = 37)\n\tOR\t(drsh.DispatchRequestStatusId = 48 AND pish.ParcelItemStatusId = 38)\n\tOR\t(drsh.DispatchRequestStatusId = 49 AND pish.ParcelItemStatusId = 39)\n)\n\nSELECT \n\tParcelReferenceCode,\n\tDispatchRequestStatusId,\n\tdrs.Title AS DispatchRequestStatusTitle,\n\tUnsuccessfulOperationReasonId,\n\tuor.Title AS UnsuccessfulOperationReasonTitle,\n\tLocation,\n\tExceptionDescription,\n\tCreateDate,\n\tCreateDatePersian,\n\tCreatorUserName,\n\tDistanceFromPointMeter,\n\tIsOutOfLocation,\n\tVersion,\n\tCustomerRoleId\nINTO #Output\nFROM\n(\n\tSELECT *, ROW_NUMBER() OVER ( PARTITION BY ParcelReferenceCode , ParcelItemStatusId ORDER BY CreateDate ) RowNum FROM #Parcel \n) SQ\nLEFT JOIN CS_OrderManagement.OM.UnsuccessfulOperationReason uor WITH(NOLOCK)\n\tON SQ.UnsuccessfulOperationReasonId = uor.Id\nINNER JOIN DP.DispatchRequestStatus drs WITH(NOLOCK)\n\tON SQ.DispatchRequestStatusId = drs.Id\nWHERE RowNum = 1\nUNION ALL\nSELECT \n\tdr.ParcelReferenceCode,\n\tdrsh.DispatchRequestStatusId,\n\tCASE WHEN  drsh.DispatchRequestStatusId = 80 THEN N\u0027\u062A\u0627\u06CC\u06CC\u062F \u0645\u0631\u062C\u0648\u0639\u06CC\u0027 ELSE drs.Title END AS DispatchRequestStatusTitle,\n\tNULL AS UnsuccessfulOperationReasonId,\n\tNULL AS UnsuccessfulOperationReasonTitle,\n\tdrsh.Location,\n\tdrsh.ExceptionDescription,\n\tdrsh.CreateDate,\n\tdrsh.CreateDatePersian,\n\tCASE WHEN psh.Id IS NOT NULL THEN psh.CreatorUserName ELSE drsh.CreatorUserName END CreatorUserName,\n\tdrsh.DistanceFromPointMeter,\n\tdrsh.IsOutOfLocation,\n\tdrsh.Version,\n\tdrsh.CustomerRoleId\nFROM DP.DispatchRequest dr WITH(NOLOCK)\nINNER JOIN DP.DispatchRequestStatusHistory drsh WITH(NOLOCK)\n\tON dr.ID = drsh.DispatchRequestId\nINNER JOIN DP.DispatchRequestStatus drs WITH(NOLOCK)\n\tON drsh.DispatchRequestStatusId = drs.Id\nLEFT JOIN CS_OrderManagement.OM.Parcel p WITH(NOLOCK)\n\tON dr.ParcelReferenceCode = p.ParcelReferenceCode\nLEFT JOIN CS_OrderManagement.OM.ParcelStatusHistory psh (NOLOCK)\n\tON p.Id = psh.ParcelId\n\tAND psh.ParcelStatusId = 55\n\tAND drsh.DispatchRequestStatusId = 40\n\tAND drsh.CreatorUserName = \u0027system|system\u0027\nWHERE dr.ParcelReferenceCode = @ParcelReferenceCode_Delivery\nAND drsh.DispatchRequestStatusId NOT IN ( 45,46,47,48,49 )\nUNION ALL\nSELECT \n\tp.ParcelReferenceCode,\n\tCAST(5 AS TINYINT) AS DispatchRequestStatusId,\n\tN\u0027\u062A\u0627\u06CC\u06CC\u062F \u062A\u0648\u0633\u0637 \u0645\u0634\u062A\u0631\u06CC\u0027 AS DispatchRequestStatusTitle,\n\tNULL UnsuccessfulOperationReasonId,\n\tNULL AS UnsuccessfulOperationReasonTitle,\n\tNULL AS Location,\n\tNULL AS ExceptionDescription,\n\tcr.ConfirmationDate AS CreateDate,\n\tcr.ConfirmationDatePersian AS CreateDatePersian,\n\tN\u0027\u0645\u0634\u062A\u0631\u06CC\u0027 CreatorUserName, \n\tNULL AS DistanceFromPointMeter,\n\tNULL AS IsOutOfLocation,\n\tCAST(0 AS SMALLINT) AS Version,\n\t10 AS CustomerRoleId\nFROM CS_OrderManagement.OM.Parcel p WITH(NOLOCK)\nINNER JOIN CS_OrderManagement.OM.CourierRequest cr WITH(NOLOCK)\n\tON p.CourierRequestId = cr.Id\nWHERE p.ParcelReferenceCode = @ParcelReferenceCode_Delivery\nUNION ALL\nSELECT \n\t@ParcelReferenceCode_Delivery AS ParcelReferenceCode,\n\tcast (255 as tinyint) AS DispatchRequestStatusId,\n\tot.Title AS DispatchRequestStatusTitle,\n\tCASE WHEN ot.ID = 7 THEN ot.ID ELSE NULL END UnsuccessfulOperationReasonId,\n\tNULL AS UnsuccessfulOperationReasonTitle,\n\tuorh.Location AS Location,\n\tofr.Title AS ExceptionDescription,\n\tuorh.CreateDate,\n\tuorh.CreateDatePersian,\n\tuorh.CreatorUserName, \n\tNULL AS DistanceFromPointMeter,\n\tNULL AS IsOutOfLocation,\n\tuorh.Version,\n\tuorh.CustomerRoleId\nFROM DP.DispatchRequest dr WITH(NOLOCK)\nINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh WITH(NOLOCK)\n\tON dr.ID = uorh.DispatchRequestId\nINNER JOIN DP.OperationType ot (NOLOCK)\n\tON uorh.OperationTypeId = ot.ID\nLEFT JOIN DP.OperationFailureReason ofr WITH(NOLOCK)\n\tON uorh.OperationFailureReasonId = ofr.Id\nWHERE dr.ParcelReferenceCode = @ParcelReferenceCode_Delivery\n\nUNION ALL\n\nSELECT\n\t@ParcelReferenceCode_Return AS ParcelReferenceCode,\n\tdrsh.DispatchRequestStatusId,\n\tCASE \n\t\tWHEN drsh.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0631\u0627\u06CC \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\n\t\tWHEN drsh.DispatchRequestStatusId IN (30,35) THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\n\tEND AS DispatchRequestStatusTitle,\n\tNULL UnsuccessfulOperationReasonId,\n\tNULL AS UnsuccessfulOperationReasonTitle,\n\tdrsh.Location,\n\tdrsh.ExceptionDescription,\n\tdrsh.CreateDate,\n\tdrsh.CreateDatePersian,\n\tdrsh.CreatorUserName, \n\tdrsh.DistanceFromPointMeter,\n\tdrsh.IsOutOfLocation,\n\tdrsh.Version,\n\tdrsh.CustomerRoleId\nFROM DP.DispatchRequest dr WITH(NOLOCK)\nINNER JOIN DP.DispatchRequestStatusHistory drsh WITH(NOLOCK)\n\tON dr.ID = drsh.DispatchRequestId\n\tAND drsh.DispatchRequestStatusId IN ( 25,30,35 )\nWHERE dr.ParcelReferenceCode = @ParcelReferenceCode_Return\n\n\nSELECT DISTINCT\n\tsdpdr.Version,\n\ts.FleetId,\n\ts.DeliveryServiceProviderId\nINTO #FleetAssignmentHistory\nFROM DP.DispatchRequest dr WITH(NOLOCK)\nINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\n\tON dr.ID = sdpdr.DispatchRequestId\nINNER JOIN DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\n\tON sdpdr.ShipmentDestinationPointId = sdp.Id\nINNER JOIN DP.Shipment s WITH(NOLOCK)\n\tON sdp.ShipmentId = s.Id\nWHERE dr.ParcelReferenceCode = @ParcelReferenceCode_Delivery\n\n\nSELECT \n\to.ParcelReferenceCode,\n\to.DispatchRequestStatusId,\n\to.DispatchRequestStatusTitle,\n\to.UnsuccessfulOperationReasonId,\n\to.UnsuccessfulOperationReasonTitle,\n\tLocation.STY AS Latitude,\n\tLocation.STX AS Longitude,\n\to.ExceptionDescription,\n\tFORMAT(o.CreateDate,\u0027####-##-## ##:##:##\\.###\u0027) CreateDate,\n\tFORMAT(o.CreateDatePersian,\u0027####-##-## ##:##:##\\.###\u0027) CreateDatePersian,\n\to.CreatorUserName,\n\to.DistanceFromPointMeter,\n\to.IsOutOfLocation,\n\to.Version,\n\tCAST\n\t(CASE \n\t\tWHEN o.CustomerRoleId IN ( 1,2,69 ) THEN 1\n\t\tWHEN o.CustomerRoleId IN ( 20,21,25,40,60,81,82,83) THEN 2\n\t\tWHEN o.CustomerRoleId IN ( 10 ) THEN 3\n\t\tWHEN o.CustomerRoleId IN ( 5,72,73,74,77,79,80,84,89 ) THEN 4\n\t\tELSE 4\n\tEND\n\tAS INT ) AS CustomerRoleId,\n\tCASE \n\t\tWHEN o.CustomerRoleId IN ( 1,2,69 ) THEN N\u0027\u0633\u0641\u06CC\u0631\u0027\n\t\tWHEN o.CustomerRoleId IN ( 20,21,25,40,60,81,82,83) THEN N\u0027\u067E\u0634\u062A\u06CC\u0628\u0627\u0646/ \u0639\u0645\u0644\u06CC\u0627\u062A\u0027\n\t\tWHEN o.CustomerRoleId IN ( 10 ) THEN N\u0027\u0645\u0634\u062A\u0631\u06CC\u0027\n\t\tWHEN o.CustomerRoleId IN ( 5,72,73,74,77,79,80,84,89 ) THEN N\u0027\u0633\u06CC\u0633\u062A\u0645\u0027\n\t\tELSE N\u0027\u0633\u06CC\u0633\u062A\u0645\u0027\n\tEND\n\tAS CustomerRoleTitle,\n\tfah.FleetId,\n\td.FirstName \u002B \u0027 \u0027 \u002B d.LastName AS DriverName,\n\tfah.DeliveryServiceProviderId\nFROM #Output o\nLEFT JOIN #FleetAssignmentHistory fah\n\tON o.Version = fah.Version\nLEFT JOIN CS_DriverManagement.DM.Fleet f WITH(NOLOCK)\n\tON fah.FleetId = f.Id\nLEFT JOIN CS_DriverManagement.DM.Driver d WITH(NOLOCK)\n\tON f.DriverId = d.Id\nORDER BY \n\t--o.Version,\n\to.CreateDate\n\nSET @DeliveryServiceProviderOrderId = ISNULL(@DeliveryServiceProviderOrderId,\u0027\u0027)\n\nEND\n"},{"Name":"Get_DispatchRequestStatusHistory_By_ParcelReferenceCode_BACKUP","Schema":"dbo","Definition":"\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1402/02/19\r\n--\tDescription:\tGet Dispatch Request Status History\r\n--\r\n--\t=======================================\r\n\r\n/*\r\n    DECLARE\t@Result NVARCHAR(MAX)=\u0027\u0027\r\n\r\n\tEXEC\t[dbo].[Get_DispatchRequestStatusHistory_By_ParcelReferenceCode]\r\n\t\t\t@ParcelReferenceCode = 1699712921579,\r\n\t\t\t@RESULT =@RESULT OUTPUT\r\n\r\n\tSELECT\t@Result\r\n*/\r\nCREATE    PROCEDURE [dbo].[Get_DispatchRequestStatusHistory_By_ParcelReferenceCode_BACKUP]\r\n\t    @ParcelReferenceCode BIGINT,\r\n\t\t@Result NVARCHAR(MAX) = NULL OUTPUT\r\nAS \r\n\tSET NOCOUNT ON\r\n    --############################################ Preparation Data ##################################\r\n\tDECLARE @IsConfirmed TINYINT,\r\n\t\t\t@CourierRequestTypeId TINYINT,\r\n\t\t\t@OperationParcelReferenceCode BIGINT,\r\n\t\t\t@IsWaitingForSupport BIT,\r\n\t\t\t@DeliveryServiceProviderOrderId VARCHAR(100),\r\n\t\t\t@IsDeliveryCodeRequired BIT,\r\n\t\t\t@DeliveryServiceProviderId TINYINT,\r\n            @VendorId INT\r\n\r\n\tDECLARE @CourierRequestTypeIds TABLE\r\n\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\tVendorId INT,\r\n\t\t\t\t\t\t\t\t\tVendorParcelCode NVARCHAR(MAX),\r\n\t\t\t\t\t\t\t\t\tCourierRequestTypeId TINYINT,\r\n\t\t\t\t\t\t\t\t\tDispatchRequestId BIGINT,\r\n\t\t\t\t\t\t\t\t\tDispatchRequestStatusId TINYINT,\r\n\t\t\t\t\t\t\t\t\tIsWaitingForSupport BIT,\r\n\t\t\t\t\t\t\t\t\tIsDeliveryCodeRequired BIT,\r\n\t\t\t\t\t\t\t\t\tDeliveryServiceProviderId Tinyint,\r\n\t\t\t\t\t\t\t\t\tVersion Smallint\r\n\t\t\t\t\t\t\t\t)\r\n\tDROP TABLE IF EXISTS \r\n\t\t\t\t\t\t\t#AllDispatchRequest,\r\n\t\t\t\t\t\t\t#DispatchRequestReturn,\r\n\t\t\t\t\t\t\t#DR,\r\n\t\t\t\t\t\t\t#DDR\r\n\tINSERT INTO @CourierRequestTypeIds\r\n\tSELECT DISTINCT \r\n\t\t\tdr.VendorId,\r\n\t\t\tdr.VendorParcelCode,\r\n\t\t\tdr.CourierRequestTypeId,\t\t\t\r\n\t\t\tdr.Id,\r\n\t\t\tdr.DispatchRequestStatusId,\r\n\t\t\tdr.IsWaitingForSupport,\r\n\t\t\tCASE WHEN dr.DeliveryCode = 0 THEN 0 ELSE 1 END,\r\n\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\tdr.Version\r\n\tFROM DP.DispatchRequest AS dr (NOLOCK)\r\n\t--JOIN DP.DispatchRequestStatusHistory AS drsh ON drsh.DispatchRequestId = dr.Id\r\n\t--JOIN DP.DispatchRequestStatus AS drs ON drs.Id = dr.DispatchRequestStatusId\r\n\tWHERE dr.ParcelReferenceCode = @ParcelReferenceCode\r\n\r\n\tSELECT \r\n        @DeliveryServiceProviderId = DeliveryServiceProviderId,\r\n        @IsDeliveryCodeRequired = IsDeliveryCodeRequired,\r\n        @VendorId = crt.VendorId\r\n     FROM @CourierRequestTypeIds crt\r\n\r\n\tIF EXISTS ( SELECT * FROM @CourierRequestTypeIds crt WHERE crt.CourierRequestTypeId = 25)\r\n\tBEGIN\r\n\t\tSELECT \r\n\t\t\t@DeliveryServiceProviderOrderId = dsprm.DeliveryServiceProviderOrderId\r\n\t\tFROM @CourierRequestTypeIds crt\r\n\t\tINNER JOIN DP.DispatchRequest dr (NOLOCK)\r\n\t\t\tON crt.VendorId = dr.VendorId\r\n\t\t\tAND crt.VendorParcelCode = dr.VendorParcelCode\r\n\t\t\tAND dr.CourierRequestTypeId IN ( 5,10,15 )\r\n\t\tINNER JOIN DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\t\t\tON dsprm.DispatchRequestId = dr.Id\r\n\t\t\tAND dsprm.IsActive = 1\r\n\t\t\tAND dsprm.DeliveryServiceProviderMapperStatusId = 3\r\n\tEND\r\n\tELSE\r\n\tBEGIN\r\n\t\tSELECT \r\n\t\t\t@DeliveryServiceProviderOrderId = dsprm.DeliveryServiceProviderOrderId\r\n\t\tFROM DP.DeliveryServiceProviderRequestMapper dsprm (NOLOCK)\r\n\t\tINNER JOIN @CourierRequestTypeIds dr\r\n\t\t\tON dsprm.DispatchRequestId = dr.DispatchRequestId\r\n\t\tWHERE dsprm.IsActive = 1\r\n\t\tAND dsprm.DeliveryServiceProviderMapperStatusId = 3\r\n\tEND\r\n\t\r\n\r\n\tSELECT DISTINCT\r\n\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\tdr.CourierRequestTypeId,\r\n\t\t\t\tdrsh.DispatchRequestStatusId,\r\n\t\t\t\tdrs.Title AS DispatchRequestStatusTitle,\r\n\t\t\t\tCASE WHEN psh.ID IS NOT NULL THEN psh.CreatorUserName ELSE drsh.CreatorUserName END CreatorUserName,\r\n\t\t\t\tFORMAT(drsh.CreateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS CreateDateStr,\r\n\t\t\t\tFORMAT(drsh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)AS CreateDatePersianStr,\r\n\t\t\t\tdrsh.CreateDate,\r\n\t\t\t\tdrsh.CreateDatePersian,\r\n\t\t\t\tpish.ParcelItemStatusId,\r\n\t\t\t\t(SELECT /*pish.UnsuccessfulOperationReasonId*/ NULL FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 17 AND pish.ParcelItemStatusId = 20) AS UnsuccessfulOperationReasonId20,\r\n\t\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 40 AND pish.ParcelItemStatusId = 50) AS UnsuccessfulOperationReasonId50,\r\n\t\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 80 AND pish.ParcelItemStatusId = 25) AS UnsuccessfulOperationReasonId25,\r\n\t\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 45 AND pish.ParcelItemStatusId = 35) AS UnsuccessfulOperationReasonId35,\r\n\t\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 46 AND pish.ParcelItemStatusId = 36) AS UnsuccessfulOperationReasonId36,\r\n\t\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 47 AND pish.ParcelItemStatusId = 37) AS UnsuccessfulOperationReasonId37,\r\n\t\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 48 AND pish.ParcelItemStatusId = 38) AS UnsuccessfulOperationReasonId38,\r\n\t\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 49 AND pish.ParcelItemStatusId = 39) AS UnsuccessfulOperationReasonId39,\r\n\t\t\t\t--uor.Id AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t--uor.Title AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\tcr.ConfirmationDate,\r\n\t\t\t\tcr.ConfirmationDatePersian,\r\n\t\t\t\tdrsh.Version\r\n\tINTO #AllDispatchRequest\r\n\tFROM DP.DispatchRequest AS dr (NOLOCK)\r\n\tJOIN DP.DispatchRequestStatusHistory AS drsh (NOLOCK)\r\n\t\tON drsh.DispatchRequestId = dr.Id\r\n\tJOIN DP.DispatchRequestStatus AS drs (NOLOCK)\r\n\t\tON drs.Id = drsh.DispatchRequestStatusId\r\n\tJOIN CS_OrderManagement.OM.Parcel AS p (NOLOCK)\r\n\t\tON p.ParcelReferenceCode = dr.ParcelReferenceCode --p.DispatchRequestId = drsh.DispatchRequestId\r\n\tJOIN CS_OrderManagement.OM.CourierRequest AS cr (NOLOCK)\r\n\t\tON cr.Id = p.CourierRequestId\r\n\tLEFT JOIN CS_OrderManagement.OM.ParcelItem AS pi (NOLOCK)\r\n\t\tON pi.ParcelId = p.Id\r\n\tJOIN CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK)\r\n\t\tON pish.ParcelItemId = pi.Id \r\n\tLEFT JOIN CS_OrderManagement.OM.ParcelStatusHistory psh (NOLOCK)\r\n\t\tON p.Id = psh.ParcelId\r\n\t\tAND psh.ParcelStatusId = 55\r\n\t\tAND drsh.DispatchRequestStatusId = 40\r\n\t\tAND drsh.CreatorUserName = \u0027system|system\u0027\r\n\t--LEFT JOIN CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor ON uor.Id = pish.UnsuccessfulOperationReasonId\r\n\tWHERE dr.ParcelReferenceCode = @ParcelReferenceCode\r\n\tAND drsh.DispatchRequestStatusId \u003C\u003E 17 AND pish.ParcelItemStatusId \u003C\u003E 20\r\n\r\n\tSELECT DISTINCT\r\n\t\t\tdr2.ParcelReferenceCode,\r\n\t\t\tdrsh.DispatchRequestStatusId,\r\n\t\t\tdrs.Title AS DispatchRequestStatusTitle,\r\n\t\t\tdrsh.CreatorUserName,\r\n\t\t\tFORMAT(drsh.CreateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS CreateDateStr,\r\n\t\t\tFORMAT(drsh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)AS CreateDatePersianStr,\r\n\t\t\tdrsh.CreateDate,\r\n\t\t\tdrsh.CreateDatePersian,\r\n\t\t\tpish.ParcelItemStatusId,\r\n\t\t\t(SELECT /*pish.UnsuccessfulOperationReasonId*/ NULL FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 17 AND pish.ParcelItemStatusId = 20) AS UnsuccessfulOperationReasonId20,\r\n\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 40 AND pish.ParcelItemStatusId = 50) AS UnsuccessfulOperationReasonId50,\r\n\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 80 AND pish.ParcelItemStatusId = 25) AS UnsuccessfulOperationReasonId25,\r\n\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 45 AND pish.ParcelItemStatusId = 35) AS UnsuccessfulOperationReasonId35,\r\n\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 46 AND pish.ParcelItemStatusId = 36) AS UnsuccessfulOperationReasonId36,\r\n\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 47 AND pish.ParcelItemStatusId = 37) AS UnsuccessfulOperationReasonId37,\r\n\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 48 AND pish.ParcelItemStatusId = 38) AS UnsuccessfulOperationReasonId38,\r\n\t\t\t(SELECT pish.UnsuccessfulOperationReasonId FROM CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK) WHERE pish.ParcelItemId = pi.id AND drsh.DispatchRequestStatusId = 49 AND pish.ParcelItemStatusId = 39) AS UnsuccessfulOperationReasonId39,\r\n\t\t\tcr.ConfirmationDate,\r\n\t\t\tcr.ConfirmationDatePersian,\r\n\t\t\tdr.CourierRequestTypeId,\r\n\t\t\tdr2.CourierRequestTypeId AS DDRCourierRequestTypeId,\r\n\t\t\tdrsh.Version\r\n\tINTO #DispatchRequestReturn\r\n\tFROM DP.DispatchRequest AS dr (NOLOCK)\r\n\tJOIN DP.DispatchRequest AS dr2 (NOLOCK)\r\n\t\tON dr2.VendorParcelCode = dr.VendorParcelCode \r\n\t\tAND dr2.PolygonStoreId = dr.PolygonStoreId \r\n\t\tAND dr2.ParcelReferenceCode \u003C\u003E @ParcelReferenceCode\r\n\tJOIN DP.DispatchRequestStatusHistory AS drsh (NOLOCK)\r\n\t\tON drsh.DispatchRequestId = dr2.Id\r\n\tJOIN DP.DispatchRequestStatus AS drs (NOLOCK)\r\n\t\tON drs.Id = drsh.DispatchRequestStatusId\r\n\tLEFT JOIN CS_OrderManagement.OM.Parcel AS p (NOLOCK)\r\n\t\tON p.ParcelReferenceCode = dr2.ParcelReferenceCode --p.DispatchRequestId = drsh.DispatchRequestId\r\n\tLEFT JOIN CS_OrderManagement.OM.CourierRequest AS cr (NOLOCK)\r\n\t\tON cr.Id = p.CourierRequestId\r\n\tLEFT JOIN CS_OrderManagement.OM.ParcelItem AS pi (NOLOCK)\r\n\t\tON pi.ParcelId = p.Id\r\n\tLEFT JOIN CS_OrderManagement.OM.ParcelItemStatusHistory AS pish (NOLOCK)\r\n\t\tON pish.ParcelItemId = pi.Id \r\n\t--LEFT JOIN CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor ON uor.Id = pish.UnsuccessfulOperationReasonId\r\n\tWHERE dr.ParcelReferenceCode = @ParcelReferenceCode\r\n\r\n\tSELECT \r\n\t\t\t@IsConfirmed =\tCASE \r\n\t\t\t\t\t\t\t\tWHEN adr.ConfirmationDate IS NOT NULL \r\n\t\t\t\t\t\t\t\tTHEN 1 \r\n\t\t\t\t\t\t\t\tELSE 0 \r\n\t\t\t\t\t\t\tEND \r\n\tFROM #AllDispatchRequest AS adr \r\n\r\n\t--######################################################### Calculate DR \u0026 DDR ##############################################################\r\n\tSELECT DISTINCT\r\n\t\tParcelReferenceCode\t,\r\n\t\tDispatchRequestStatusId\t,\r\n\t\tDispatchRequestStatusTitle\t,\r\n\t\tCreatorUserName\t,\r\n\t\tCreateDateStr\t,\r\n\t\tCreateDatePersianStr\t,\r\n\t\tVersion,\r\n\t\tFIRST_VALUE(UnsuccessfulOperationReasonId) OVER ( PARTITION BY ParcelReferenceCode,DispatchRequestStatusId ORDER BY UnsuccessfulOperationReasonId DESC )UnsuccessfulOperationReasonId,\r\n\t\tFIRST_VALUE(UnsuccessfulOperationReasonTitle) OVER ( PARTITION BY ParcelReferenceCode,DispatchRequestStatusId ORDER BY UnsuccessfulOperationReasonTitle DESC )UnsuccessfulOperationReasonTitle\r\n\tINTO #DR\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tParcelReferenceCode,\r\n\t\t\tDispatchRequestStatusId,\r\n\t\t\tDispatchRequestStatusTitle,\r\n\t\t\tCreatorUserName,\r\n\t\t\tCreateDateStr,\r\n\t\t\tCreateDatePersianStr,\r\n\t\t\tVersion,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 17 AND adr.ParcelItemStatusId = 20 AND adr.UnsuccessfulOperationReasonId20 IS NOT NULL THEN adr.UnsuccessfulOperationReasonId20\r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 40 AND adr.ParcelItemStatusId = 50 AND adr.UnsuccessfulOperationReasonId50 IS NOT NULL THEN adr.UnsuccessfulOperationReasonId50\r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 80 AND adr.ParcelItemStatusId = 25 AND adr.UnsuccessfulOperationReasonId25 IS NOT NULL THEN adr.UnsuccessfulOperationReasonId25\r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 45 AND adr.ParcelItemStatusId = 35 AND adr.UnsuccessfulOperationReasonId35 IS NOT NULL THEN adr.UnsuccessfulOperationReasonId35\r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 46 AND adr.ParcelItemStatusId = 36 AND adr.UnsuccessfulOperationReasonId36 IS NOT NULL THEN adr.UnsuccessfulOperationReasonId36\r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 47 AND adr.ParcelItemStatusId = 37 AND adr.UnsuccessfulOperationReasonId37 IS NOT NULL THEN adr.UnsuccessfulOperationReasonId37\r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 48 AND adr.ParcelItemStatusId = 38 AND adr.UnsuccessfulOperationReasonId38 IS NOT NULL THEN adr.UnsuccessfulOperationReasonId38\r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 49 AND adr.ParcelItemStatusId = 39 AND adr.UnsuccessfulOperationReasonId39 IS NOT NULL THEN adr.UnsuccessfulOperationReasonId39\r\n\t\t\tEND AS UnsuccessfulOperationReasonId,\r\n\t\t\tCASE\r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 17 AND adr.ParcelItemStatusId = 20 AND adr.UnsuccessfulOperationReasonId20 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = adr.UnsuccessfulOperationReasonId20) \r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 40 AND adr.ParcelItemStatusId = 50 AND adr.UnsuccessfulOperationReasonId50 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = adr.UnsuccessfulOperationReasonId50) \r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 80 AND adr.ParcelItemStatusId = 25 AND adr.UnsuccessfulOperationReasonId25 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = adr.UnsuccessfulOperationReasonId25) \r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 45 AND adr.ParcelItemStatusId = 35 AND adr.UnsuccessfulOperationReasonId35 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = adr.UnsuccessfulOperationReasonId35) \r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 46 AND adr.ParcelItemStatusId = 36 AND adr.UnsuccessfulOperationReasonId36 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = adr.UnsuccessfulOperationReasonId36) \r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 47 AND adr.ParcelItemStatusId = 37 AND adr.UnsuccessfulOperationReasonId37 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = adr.UnsuccessfulOperationReasonId37) \r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 48 AND adr.ParcelItemStatusId = 38 AND adr.UnsuccessfulOperationReasonId38 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = adr.UnsuccessfulOperationReasonId38) \r\n\t\t\t\tWHEN adr.DispatchRequestStatusId = 49 AND adr.ParcelItemStatusId = 39 AND adr.UnsuccessfulOperationReasonId39 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = adr.UnsuccessfulOperationReasonId39)\r\n\t\t\tEND AS UnsuccessfulOperationReasonTitle\r\n\t\tFROM #AllDispatchRequest AS adr\r\n\t) SQ\r\n\r\n\tSELECT DISTINCT\r\n\t\t\t\t\t\td.ParcelReferenceCode,\r\n\t\t\t\t\t\td.DispatchRequestStatusId,\r\n\t\t\t\t\t\td.DispatchRequestStatusTitle,\r\n\t\t\t\t\t\td.CreatorUserName,\r\n\t\t\t\t\t\td.CreateDateStr,\r\n\t\t\t\t\t\td.CreateDatePersianStr,\r\n\t\t\t\t\t\td.CourierRequestTypeId,\r\n\t\t\t\t\t\td.DDRCourierRequestTypeId,\r\n\t\t\t\t\t\td.ConfirmationDate,\r\n\t\t\t\t\t\td.ConfirmationDatePersian,\r\n\t\t\t\t\t\tVersion,\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 80 AND d.ParcelItemStatusId = 25 AND d.UnsuccessfulOperationReasonId25 IS NOT NULL THEN d.UnsuccessfulOperationReasonId25\r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 45 AND d.ParcelItemStatusId = 35 AND d.UnsuccessfulOperationReasonId35 IS NOT NULL THEN d.UnsuccessfulOperationReasonId35\r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 46 AND d.ParcelItemStatusId = 36 AND d.UnsuccessfulOperationReasonId36 IS NOT NULL THEN d.UnsuccessfulOperationReasonId36\r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 47 AND d.ParcelItemStatusId = 37 AND d.UnsuccessfulOperationReasonId37 IS NOT NULL THEN d.UnsuccessfulOperationReasonId37\r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 48 AND d.ParcelItemStatusId = 38 AND d.UnsuccessfulOperationReasonId38 IS NOT NULL THEN d.UnsuccessfulOperationReasonId38\r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 49 AND d.ParcelItemStatusId = 39 AND d.UnsuccessfulOperationReasonId39 IS NOT NULL THEN d.UnsuccessfulOperationReasonId39\r\n\t\t\t\t\t\tEND AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\tCASE\r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 80 AND d.ParcelItemStatusId = 25 AND d.UnsuccessfulOperationReasonId25 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = d.UnsuccessfulOperationReasonId25) \r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 45 AND d.ParcelItemStatusId = 35 AND d.UnsuccessfulOperationReasonId35 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = d.UnsuccessfulOperationReasonId35) \r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 46 AND d.ParcelItemStatusId = 36 AND d.UnsuccessfulOperationReasonId36 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = d.UnsuccessfulOperationReasonId36) \r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 47 AND d.ParcelItemStatusId = 37 AND d.UnsuccessfulOperationReasonId37 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = d.UnsuccessfulOperationReasonId37) \r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 48 AND d.ParcelItemStatusId = 38 AND d.UnsuccessfulOperationReasonId38 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = d.UnsuccessfulOperationReasonId38) \r\n\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 49 AND d.ParcelItemStatusId = 39 AND d.UnsuccessfulOperationReasonId39 IS NOT NULL THEN (SELECT uor.Title FROM CS_OrderManagement.OM.UnsuccessfulOperationReason AS uor (NOLOCK) WHERE uor.Id = d.UnsuccessfulOperationReasonId39)\r\n\t\t\t\t\t\tEND AS UnsuccessfulOperationReasonTitle\r\n\tINTO #DDR\r\n\tFROM #DispatchRequestReturn AS d\r\n\r\n\t; WITH CTE_UORH AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tdr.ParcelReferenceCode,\r\n\t\t\tuorh.CreatorUserName ,\r\n\t\t\t--FORMAT(uorh.CreateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS CreateDateStr,\r\n\t\t\t--FORMAT(uorh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS CreateDatePersianStr,                                       \r\n\t\t\tuorh.CreateDate,\r\n\t\t\tuorh.CreateDatePersian,\r\n\t\t\tuorh.OperationTypeId,\r\n\t\t\tot.Title AS OperationTypeTitle,\r\n\t\t\tuorh.OperationFailureReasonId AS UnsuccessfulOperationReasonId,\r\n\t\t\tofr.Title AS UnsuccessfulOperationReasonTitle,\r\n\t\t\tuorh.Version\r\n\t\tFROM DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK)\r\n\t\tINNER JOIN DP.DispatchRequest dr (NOLOCK)\r\n\t\t\tON uorh.DispatchRequestId = dr.ID\r\n\t\tINNER JOIN DP.OperationType ot (NOLOCK)\r\n\t\t\tON uorh.OperationTypeId = ot.ID\r\n\t\tLEFT JOIN DP.OperationFailureReason ofr (NOLOCK)\r\n\t\t\tON uorh.OperationFailureReasonId = ofr.Id\r\n\t\tWHERE dr.ParcelReferenceCode = @ParcelReferenceCode\r\n\t),CTE_DR AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tdr.ParcelReferenceCode,\r\n\t\t\tdr.DispatchRequestStatusId,\r\n\t\t\tdr.DispatchRequestStatusTitle,\r\n\t\t\tdr.CreateDate ,\r\n\t\t\tLEAD(dr.CreateDate) OVER ( ORDER BY dr.CreateDate ) AS CreateDate_Next\r\n\t\tFROM #AllDispatchRequest dr\r\n\t)\r\n\tSELECT \r\n\t\tuorh.ParcelReferenceCode,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tuorh.OperationTypeTitle DispatchRequestStatusTitle,\r\n\t\tuorh.CreatorUserName,\r\n        FORMAT(uorh.CreateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS CreateDateStr,\r\n        FORMAT(uorh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS CreateDatePersianStr,                                       \r\n        uorh.UnsuccessfulOperationReasonId,\r\n        uorh.UnsuccessfulOperationReasonTitle,\r\n\t\tVersion\r\n\tINTO #UORH\r\n\tFROM CTE_DR dr\r\n\tINNER JOIN CTE_UORH uorh\r\n\t\tON dr.ParcelReferenceCode = uorh.ParcelReferenceCode\r\n\t\tAND uorh.CreateDate \u003E= dr.CreateDate \r\n\t\tAND (uorh.CreateDate \u003C dr.CreateDate_Next OR dr.CreateDate_Next IS NULL)\r\n\t\r\n\r\n\t--############################################ Calculate Result ##############################################\r\n\r\n\tIF EXISTS(\r\n\t\t\tSELECT * FROM @CourierRequestTypeIds AS crti\r\n\t\t\tWHERE CourierRequestTypeId = 25\r\n\t\t\t)\r\n\tBEGIN\r\n\t\tSET @Result = \r\n\t\t( \r\n\t\t\t\t\tSELECT * \r\n\t\t\t\t\tFROM \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT TOP 1 WITH TIES d.ParcelReferenceCode,\r\n                                                d.DispatchRequestStatusId,\r\n\t\t\t\t\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 80 THEN N\u0027\u062A\u0627\u06CC\u06CC\u062F \u0645\u0631\u062C\u0648\u0639\u06CC\u0027 \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tELSE d.DispatchRequestStatusTitle\r\n\t\t\t\t\t\t\t\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n                                                d.CreatorUserName,\r\n                                                d.CreateDateStr,\r\n                                                d.CreateDatePersianStr,\r\n                                                d.UnsuccessfulOperationReasonId,\r\n                                                d.UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\t\t\t\t\t\t\tVersion\r\n\t\t\t\t\t\tFROM #DDR AS d\r\n\t\t\t\t\t\tWHERE d.DDRCourierRequestTypeId IN (5,10,15)\r\n\t\t\t\t\t\tORDER BY ROW_NUMBER() OVER (PARTITION BY d.DispatchRequestStatusId ORDER BY d.UnsuccessfulOperationReasonId DESC)\r\n\t\t\r\n\t\t\t\t\t\tUNION\r\n\r\n\t\t\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0631\u0627\u06CC \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (30,35) THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n\t\t\t\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\t\t\tVersion\r\n\t\t\t\t\t\tFROM #AllDispatchRequest AS adr\r\n\t\t\t\t\t\tWHERE adr.DispatchRequestStatusId IN (25,30,35)\r\n\r\n\t\t\t\t\t\tUNION\r\n\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\t\t\tCASE WHEN ISNULL(Version,0) = 0 THEN 5 ELSE 7 END AS DispatchRequestStatusId,\r\n\t\t\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\t\t\tCreateDatePersianStr,                                       \r\n\t\t\t\t\t\t\tUnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\t\tUnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\t\tISNULL(Version,0)  Version\r\n\t\t\t\t\t\tFROM\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\t\t\t\td2.ParcelReferenceCode,\r\n\t\t\t\t\t\t\t\t\tNULL AS DispatchRequestStatusId,\r\n\t\t\t\t\t\t\t\t\tN\u0027\u062A\u0627\u06CC\u06CC\u062F \u062F\u0631\u062E\u0648\u0627\u0633\u062A \u062F\u0647\u0646\u062F\u0647\u0027 AS DispatchRequestStatusTitle,\r\n\t\t\t\t\t\t\t\t\tNULL AS CreatorUserName,\r\n\t\t\t\t\t\t\t\t\tFORMAT(d2.ConfirmationDate,\u0027####-##-## ##:##:##\\.###\u0027) AS CreateDateStr,\r\n\t\t\t\t\t\t\t\t\tFORMAT(d2.ConfirmationDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS CreateDatePersianStr,                                       \r\n\t\t\t\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\t\t\t\tNULL AS Version\r\n\t\t\t\t\t\t\tFROM #DDR AS d2\r\n\t\t\t\t\t\t\tWHERE d2.DDRCourierRequestTypeId IN (5,10,15) AND d2.ConfirmationDatePersian IS NOT NULL\r\n\t\t\t\t\t\t) SQ\r\n\t\t\t\t\t\tUNION\r\n\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\t\t\tUnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\t\tUnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\t\tVersion\r\n\t\t\t\t\t\tFROM #UORH\r\n\t\t\t\t\t) DispatchRequestStatusHistory\r\n\r\n\t\t\t\tORDER BY CreateDateStr\r\n\t\t\t\tFOR JSON PATH , ROOT(\u0027DispatchRequestStatusHistory\u0027), INCLUDE_NULL_VALUES\r\n\t\t\t)\r\n\tEND\r\n\tELSE IF EXISTS(\r\n\t\t\tSELECT * FROM @CourierRequestTypeIds AS crti\r\n\t\t\tWHERE CourierRequestTypeId = 51\r\n\t\t\t)\r\n\tBEGIN\r\n\t\tSET @Result = ( SELECT * \r\n\t\t\t\t\t\tFROM (\r\n\t\t\t\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\t\t\t\td.ParcelReferenceCode,\r\n\t\t\t\t\t\t\t\t\td.DispatchRequestStatusId,\r\n\t\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId = 80 THEN N\u0027\u062A\u0627\u06CC\u06CC\u062F \u0645\u0631\u062C\u0648\u0639\u06CC\u0027 \r\n\t\t\t\t\t\t\t\t\t\tWHEN d.DispatchRequestStatusId IN (30,35) THEN N\u0027\u0628\u0633\u062A\u0647 \u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027 \r\n\t\t\t\t\t\t\t\t\t\tELSE d.DispatchRequestStatusTitle\r\n\t\t\t\t\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n\t\t\t\t\t\t\t\t\td.CreatorUserName,\r\n\t\t\t\t\t\t\t\t\td.CreateDateStr,\r\n\t\t\t\t\t\t\t\t\td.CreateDatePersianStr,\r\n\t\t\t\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\t\t\t\tVersion\r\n\t\t\t\t\t\t\tFROM #DispatchRequestReturn AS d\r\n\t\t\t\t\t\t\tWHERE d.DDRCourierRequestTypeId IN (40,45,50)\r\n\t\t\r\n\t\t\t\t\t\t\tUNION\r\n\r\n\t\t\t\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0631\u0627\u06CC \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (30,35) THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n\t\t\t\t\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\t\t\t\tVersion\r\n\t\t\t\t\t\t\tFROM #AllDispatchRequest AS adr\r\n\t\t\t\t\t\t\tWHERE adr.DispatchRequestStatusId IN (25,30,35)\r\n\t\t\t\t\t\t\tUNION\r\n\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\t\t\t\tUnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\t\t\tUnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\t\t\tVersion\r\n\t\t\t\t\t\t\tFROM #UORH\r\n\t\t\t\t\t\t) DispatchRequestStatusHistory\r\n\r\n\t\t\t\t\t\tORDER BY CreateDateStr\r\n\t\t\t\t\t\tFOR JSON PATH , ROOT(\u0027DispatchRequestStatusHistory\u0027), INCLUDE_NULL_VALUES\r\n\t\t\t\t\t\t)\r\n\tEND\r\n\tELSE IF EXISTS (SELECT * FROM @CourierRequestTypeIds AS crti WHERE DispatchRequestStatusId IN (80))\r\n\tBEGIN\r\n\t\tSET @Result = \r\n\t\t( \r\n\t\t\tSELECT * \r\n\t\t\tFROM \r\n\t\t\t(\r\n\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (80) THEN N\u0027\u062A\u0627\u06CC\u06CC\u062F \u0645\u0631\u062C\u0648\u0639\u06CC\u0027\r\n\t\t\t\t\t\t\tELSE DispatchRequestStatusTitle\r\n\t\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n\t\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\t\tUnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\tUnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\tVersion\r\n\t\t\t\tFROM #DR AS adr\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0631\u0627\u06CC \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (30,35) THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n\t\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\tVersion\r\n\t\t\t\tFROM #DispatchRequestReturn\r\n\t\t\t\tWHERE DDRCourierRequestTypeId IN ( 25,51 )\r\n\t\t\t\tAND DispatchRequestStatusId IN (25,30,35) \r\n\t\t\t\tUNION \r\n\t\t\t\tSELECT \r\n\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\tCASE WHEN ISNULL(Version,0) = 0 THEN 5 ELSE 7 END AS DispatchRequestStatusId,\r\n\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\tCreateDatePersianStr,                                       \r\n\t\t\t\t\tUnsuccessfulOperationReasonId,\r\n\t\t\t\t\tUnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\tISNULL(Version,0)  Version\r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\t\td2.ParcelReferenceCode,\r\n\t\t\t\t\t\t\tNULL AS DispatchRequestStatusId,\r\n\t\t\t\t\t\t\tN\u0027\u062A\u0627\u06CC\u06CC\u062F \u062F\u0631\u062E\u0648\u0627\u0633\u062A \u062F\u0647\u0646\u062F\u0647\u0027 AS DispatchRequestStatusTitle,\r\n\t\t\t\t\t\t\tNULL AS CreatorUserName,\r\n\t\t\t\t\t\t\tFORMAT(d2.ConfirmationDate,\u0027####-##-## ##:##:##\\.###\u0027) AS CreateDateStr,\r\n\t\t\t\t\t\t\tFORMAT(d2.ConfirmationDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS CreateDatePersianStr,                                       \r\n\t\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\t\tNULL AS Version\r\n\t\t\t\t\tFROM #AllDispatchRequest AS d2\r\n\t\t\t\t\tWHERE d2.CourierRequestTypeId IN (5,10,15) AND d2.ConfirmationDatePersian IS NOT NULL\r\n\t\t\t\t) SQ\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\tUnsuccessfulOperationReasonId,\r\n\t\t\t\t\tUnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\tVersion\r\n\t\t\t\tFROM #UORH\r\n\t\t\t) DispatchRequestStatusHistory\r\n\t\t\tORDER BY CreateDateStr\r\n\t\t\tFOR JSON PATH , ROOT(\u0027DispatchRequestStatusHistory\u0027), INCLUDE_NULL_VALUES\r\n\t\t)\r\n\r\n\tEND\r\n\tELSE IF EXISTS (SELECT * FROM @CourierRequestTypeIds AS crti WHERE CourierRequestTypeId IN ( 40,45,50 ) AND DispatchRequestStatusId IN (30,35) )\r\n\tBEGIN\r\n\t\t\t\r\n\t\tSET @Result = \r\n\t\t( \r\n\t\t\tSELECT * \r\n\t\t\tFROM \r\n\t\t\t(\r\n\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (30,35) THEN N\u0027\u062C\u0627\u06CC\u06AF\u0632\u06CC\u0646 \u0634\u062F\u0027\r\n\t\t\t\t\t\t\tELSE DispatchRequestStatusTitle\r\n\t\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n\t\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\tVersion\r\n\t\t\t\tFROM #AllDispatchRequest AS adr\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0631\u0627\u06CC \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t\tWHEN DispatchRequestStatusId IN (30,35) THEN N\u0027\u0628\u0633\u062A\u0647 \u0645\u0631\u062C\u0648\u0639\u06CC \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\tEND AS DispatchRequestStatusTitle,\r\n\t\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\tVersion\r\n\t\t\t\tFROM #DispatchRequestReturn\r\n\t\t\t\tWHERE DDRCourierRequestTypeId IN ( 25,51 )\r\n\t\t\t\tAND DispatchRequestStatusId IN (25,30,35)\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\tUnsuccessfulOperationReasonId,\r\n\t\t\t\t\tUnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\tVersion\r\n\t\t\t\tFROM #UORH\r\n\t\t\t) DispatchRequestStatusHistory\r\n\r\n\t\t\tORDER BY CreateDateStr\r\n\t\t\tFOR JSON PATH , ROOT(\u0027DispatchRequestStatusHistory\u0027), INCLUDE_NULL_VALUES\r\n\t\t)\r\n\tEND\r\n\tELSE\r\n\tBEGIN\r\n\t\tSET @Result = \r\n\t\t(\r\n\t\t\tSELECT * FROM \r\n\t\t\t(\r\n\t\t\t\tSELECT TOP 1 WITH TIES \r\n\t\t\t\t\td.ParcelReferenceCode,\r\n                    d.DispatchRequestStatusId,\r\n                    d.DispatchRequestStatusTitle,\r\n                    d.CreatorUserName,\r\n                    d.CreateDateStr,\r\n                    d.CreateDatePersianStr,\r\n                    d.UnsuccessfulOperationReasonId,\r\n                    d.UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\tVersion\r\n\t\t\t\tFROM #DR AS d\r\n\t\t\t\tORDER BY ROW_NUMBER() OVER(PARTITION BY d.DispatchRequestStatusId , d.version ORDER BY d.UnsuccessfulOperationReasonId DESC)\r\n\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\tCASE WHEN ISNULL(Version,0) = 0 THEN 5 ELSE 7 END AS DispatchRequestStatusId,\r\n\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\tCreateDatePersianStr,                                       \r\n\t\t\t\t\tUnsuccessfulOperationReasonId,\r\n\t\t\t\t\tUnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\tISNULL(Version,0)  Version\r\n\t\t\t\tFROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT DISTINCT \r\n\t\t\t\t\t\t d2.ParcelReferenceCode,\r\n\t\t\t\t\t\tNULL AS DispatchRequestStatusId,\r\n\t\t\t\t\t\tN\u0027\u062A\u0627\u06CC\u06CC\u062F \u062F\u0631\u062E\u0648\u0627\u0633\u062A \u062F\u0647\u0646\u062F\u0647\u0027 AS DispatchRequestStatusTitle,\r\n\t\t\t\t\t\tNULL AS CreatorUserName,\r\n\t\t\t\t\t\tFORMAT(d2.ConfirmationDate,\u0027####-##-## ##:##:##\\.###\u0027) AS CreateDateStr,\r\n\t\t\t\t\t\tFORMAT(d2.ConfirmationDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS CreateDatePersianStr,                                       \r\n\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonId,\r\n\t\t\t\t\t\tNULL AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\t\tNULL AS Version\r\n\t\t\t\t\tFROM #AllDispatchRequest  AS d2\r\n\t\t\t\t\tWHERE \r\n\t\t\t\t\t\t( \r\n\t\t\t\t\t\t\t\td2.CourierRequestTypeId IN (5,10,15) \r\n\t\t\t\t\t\t) \r\n\t\t\t\t\tAND d2.ConfirmationDatePersian IS NOT NULL\r\n\t\t\t\t)SQ\r\n\t\t\t\tUNION\r\n\r\n\t\t\t\tSELECT DISTINCT \r\n\t\t\t\t\t d2.ParcelReferenceCode,\r\n                    NULL AS DispatchRequestStatusId,\r\n                    N\u0027\u062A\u0627\u06CC\u06CC\u062F \u062F\u0631\u062E\u0648\u0627\u0633\u062A \u062F\u0647\u0646\u062F\u0647\u0027 AS DispatchRequestStatusTitle,\r\n                    NULL AS CreatorUserName,\r\n                    FORMAT(d2.ConfirmationDate,\u0027####-##-## ##:##:##\\.###\u0027) AS CreateDateStr,\r\n                    FORMAT(d2.ConfirmationDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS CreateDatePersianStr,                                       \r\n                    NULL AS UnsuccessfulOperationReasonId,\r\n                    NULL AS UnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\tNULL AS Version\r\n\t\t\t\tFROM #DispatchRequestReturn  AS d2\r\n\t\t\t\tWHERE \r\n\t\t\t\t\t( \r\n\t\t\t\t\t\t(d2.DDRCourierRequestTypeId IN (5,10,15) and d2.CourierRequestTypeId = 25) \r\n\t\t\t\t\t) \r\n\t\t\t\tAND d2.ConfirmationDatePersian IS NOT NULL\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tParcelReferenceCode,\r\n\t\t\t\t\tDispatchRequestStatusId,\r\n\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\t\t\tCreatorUserName,\r\n\t\t\t\t\tCreateDateStr,\r\n\t\t\t\t\tCreateDatePersianStr,\r\n\t\t\t\t\tUnsuccessfulOperationReasonId,\r\n\t\t\t\t\tUnsuccessfulOperationReasonTitle,\r\n\t\t\t\t\tVersion\r\n\t\t\t\tFROM #UORH\r\n\t\t\t) DispatchRequestStatusHistory\r\n\r\n\t\t\tORDER BY CreateDateStr\r\n\t\t\tFOR JSON PATH , ROOT(\u0027DispatchRequestStatusHistory\u0027), INCLUDE_NULL_VALUES\r\n\t\t\t\t\t\t\r\n\t\t)\r\n\tEND\r\n\r\n\tSELECT @IsWaitingForSupport = IsWaitingForSupport FROM @CourierRequestTypeIds\r\n\r\n\tIF EXISTS ( SELECT * FROM @CourierRequestTypeIds WHERE DispatchRequestStatusId = 80 OR ( CourierRequestTypeId IN ( 40,45,50 ) AND DispatchRequestStatusId IN ( 30,35 ) ) )\r\n\t\tBEGIN\r\n\t\t\tSELECT @OperationParcelReferenceCode = ParcelReferenceCode , @CourierRequestTypeId = DDRCourierRequestTypeId FROM #DispatchRequestReturn WHERE DDRCourierRequestTypeId IN ( 25,51 )\r\n\t\tEND\r\n\tELSE\r\n\t\tBEGIN\r\n\t\t\tSELECT @OperationParcelReferenceCode = ParcelReferenceCode , @CourierRequestTypeId = CourierRequestTypeId FROM #AllDispatchRequest\r\n\t\tEND\r\n\t\r\n\tSET @Result = REPLACE(@Result,N\u0027\\\u0027,N\u0027\u0027)\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.IsWaitingForSupport\u0027 , @IsWaitingForSupport)\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.IsConfirmed\u0027 , @IsConfirmed)\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.CourierRequestTypeId\u0027 , @CourierRequestTypeId)\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.OperationParcelReferenceCode\u0027 , @OperationParcelReferenceCode)\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.DeliveryServiceProviderOrderId\u0027 , @DeliveryServiceProviderOrderId)\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.IsDeliveryCodeRequired\u0027 , @IsDeliveryCodeRequired)\r\n\tSET @Result = JSON_MODIFY(@Result,\u0027$.DeliveryServiceProviderId\u0027 , @DeliveryServiceProviderId)\r\n    SET @Result = JSON_MODIFY(@Result,\u0027$.VendorId\u0027 , @VendorId)\r\n\r\n       \r\n"},{"Name":"Get_Drivers_By_Filter_BACKUP","Schema":"dbo","Definition":"\r\n/*\r\ndeclare @TotalCount nvarchar(max)\r\nexec [dbo].[Get_Drivers_By_Filter]\r\n\t@DriverName=N\u0027\u0645\u0631\u0027,\r\n\t@DriverMobile\t\t\t=NULL ,\r\n\t@DriverCode\t\t\t\t=NULL ,\r\n\t@CityId\t\t\t\t\t= null,\r\n\t@PolygonId\t\t\t\t= null,\r\n\t@VehicleTypeId\t\t\t= null,\r\n\t@PlateNumber\t\t\t= null,\r\n\t@IsActive\t\t\t\t= null,\r\n\t@FromCreateDatePersian\t= NULL,\r\n\t@ToCreateDatePersian\t= NULL,\r\n\t--@ShiftConfigurationIds\t=null,--\u0027[3]\u0027,--\u0027[{\u0022id\u0022:1},{\u0022id\u0022:2}]\u0027,--\r\n\r\n\t@PageIndex\t\t\t\t=0,\r\n\t@PageSize\t\t\t\t=40,\r\n\t@TotalCount=@TotalCount out\r\n\tselect @TotalCount\r\n*/\r\n\r\nCREATE   PROCEDURE [dbo].[Get_Drivers_By_Filter_BACKUP]\r\n\r\n\t@DriverName\t\t\t\t\tNVARCHAR(50),\r\n\t@DriverMobile\t\t\t\tBIGINT,\r\n\t@DriverCode\t\t\t\t\tBIGINT,\r\n\t@CityId\t\t\t\t\t\tINT,\r\n\t@PolygonId\t\t\t\t\tINT,\r\n\t@VehicleTypeId\t\t\t\tTINYINT,\r\n\t@PlateNumber\t\t\t\tNVARCHAR(12),\r\n\t@IsActive\t\t\t\t\tBIT,\r\n\t@FromCreateDatePersian\t\tBIGINT,\r\n\t@ToCreateDatePersian\t\tBIGINT,\r\n\t--@ShiftConfigurationIds\t\tNVARCHAR(MAX),\r\n\r\n\t@PageIndex\t\t\t\t\tINT\t,\r\n\t@PageSize\t\t\t\t\tINT\t,\r\n\t@TotalCount\t\t\t\t\tINT OUTPUT\r\nAS\r\n\t\r\n\r\n\t--SET @DriverName=CONCAT(\u0027\u0022*\u0027,@DriverName,\u0027*\u0022\u0027)\r\n\t--select @DriverName\r\n\tSET @DriverName=ISNULL(@DriverName,\u0027\u0027)\r\n\r\n\tSELECT  @TotalCount=COUNT(*)\r\n\tFROM\r\n\t(\r\n\t\tSELECT * FROM (\r\n\t\t\tSELECT DISTINCT  \r\n\t\t\t\t\t\t f.Id\t\t\t\tfleetId\r\n\t\t\t\t\t\t,d.Mobile\t\t\tdriverMobile\r\n\t\t\t\t\t\t,RIGHT(\u0027000\u0027 \u002B CAST(d.Code AS NVARCHAR(10)) , 10) AS \tdriverCode\r\n\t\t\t\t\t\t,CONCAT(d.FirstName,\u0027 \u0027,d.LastName) Name\r\n\t\t\t\t\t\t,p.CityId\t\t\t\r\n\t\t\t\t\t\t,d.IsActive\r\n\t\t\t\t\t\t,FORMAT(d.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)\tcreateDatePersian\r\n\t\t\t\t\t\t,\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT isc.Id,isc.startTime,isc.endTime,fs.Id fleetShiftId,WeekDayId,ShiftConfigurationId\r\n\t\t\t\t\t\t\tFROM dp.ShiftConfiguration(NOLOCK) isc\r\n\t\t\t\t\t\t\tINNER JOIN dp.FleetShift(NOLOCK) fs ON f.Id=fs.FleetId\r\n\t\t\t\t\t\t\tWHERE isc.id=fs.ShiftConfigurationId\r\n\t\t\t\t\t\t\tAND fs.IsDeleted=0\r\n\t\t\t\t\t\t\tFOR JSON PATH\r\n\t\t\t\t\t\t)\t\t\t\tAS ShiftConfigurationsJSON\r\n\t\t\tFROM dp.Driver(NOLOCK) d\r\n\t\t\tLEFT JOIN dp.Fleet(NOLOCK) f\t\t\t\t\t\t\t\tON f.DriverId=d.Id\t\tAND f.IsActive=1\r\n\t\t\tLEFT JOIN dp.PolygonFleet(NOLOCK) pf\t\t\t\t\t\tON pf.FleetId=f.Id\t\tAND pf.IsActive=1\r\n\t\t\tLEFT JOIN dp.Polygon(NOLOCK) p\t\t\t\t\t\t\t\tON p.id=pf.PolygonId\tAND p.IsActive=1\r\n\t\t\tLEFT JOIN dp.Vehicle(NOLOCK) v\t\t\t\t\t\t\t\tON v.Id=f.VehicleId\r\n\t\t\tWHERE \r\n\t\t\t\t\t((d.Mobile=@DriverMobile) OR (ISNULL(@DriverMobile,0)=0))\r\n\t\t\t\t--AND ((Contains(d.FirstName,@DriverName))OR (Contains(d.LastName,@DriverName))  OR(@DriverName=\u0027\u0022**\u0022\u0027))\r\n\t\t\t\tAND ((d.Code=@DriverCode) OR (ISNULL(@DriverCode,0)=0))\r\n\t\t\t\tAND ((d.IsActive=@IsActive) OR (@IsActive IS NULL))\r\n\t\t\t\tAND ((d.CreateDatePersian BETWEEN @FromCreateDatePersian AND @ToCreateDatePersian) OR @FromCreateDatePersian IS NULL)\r\n\t\t\t\tAND ((p.CityId=@CityId) OR (ISNULL(@CityId,0)=0))\r\n\t\t\t\tAND ((p.Id=@PolygonId) OR (ISNULL(@PolygonId,0)=0))\r\n\t\t\t\tAND ((v.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\t\t\tAND ((v.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t\t) X\r\n\t\twhere name like \u0027%\u0027\u002B@DriverName\u002B\u0027%\u0027 OR @DriverName=\u0027\u0027\r\n\t)totalCount\r\n\t\r\n\t\r\n\t;with cte as (\r\n\t\tSELECT\tDISTINCT\r\n\t\t\t\tISNULL(f.Id,0)\t\t\t\t\t\t\t\tFleetId\r\n\t\t\t\t,d.Id\t\t\t\t\t\t\t\t\t\tId\r\n\t\t\t\t,d.CustomerId\r\n\t\t\t\t,CONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\t\tName\r\n\t\t\t\t,d.FirstName\t\t\t\t\t\t\t\tFirstName\r\n\t\t\t\t,d.LastName\t\t\t\t\t\t\t\t\tLastName\r\n\t\t\t\t,NULL\t\t\t\t\t\t\t\t\t\tPhone\r\n\t\t\t\t,NULL\t\t\t\t\t\t\t\t\t\tAddress\r\n\t\t\t\t\t\r\n\t\t\t\t,CONCAT(\u00270\u0027,CAST(d.Mobile AS VARCHAR(11)))\tMobile\r\n\t\t\t\t,RIGHT(\u0027000\u0027 \u002B CAST(d.Code AS NVARCHAR(10)) , 10) AS\t\tCode\r\n\t\t\t\t,ISNULL(p.CityId,0)\t\t\t\t\t\t\tCityId\r\n\t\t\t\t,CAST(0 AS TINYINT)\t\t\t\t\t\t\tProvinceId\r\n\t\t\t\t,NULL\t\t\t\t\t\t\t\t\t\tCityName\r\n\t\t\t\t,ISNULL(CASE WHEN d.IsActive=1 THEN \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT p.Id \r\n\t\t\t\t\t\t\tFROM dp.fleet(NOLOCK) f\r\n\t\t\t\t\t\t\tINNER JOIN dp.PolygonFleet(NOLOCK) pf ON f.Id=pf.fleetId  \r\n\t\t\t\t\t\t\tINNER JOIN dp.Polygon(NOLOCK) p ON p.Id=pf.PolygonId\r\n\t\t\t\t\t\t\tWHERE pf.IsActive=1\r\n\t\t\t\t\t\t\tAND f.IsActive=1\r\n\t\t\t\t\t\t\tAND f.DriverId=d.Id \r\n\t\t\t\t\t\t)\r\n\t\t\t\tELSE\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT TOP 1 p.Id \r\n\t\t\t\t\t\t\tFROM dp.fleet(NOLOCK) f\r\n\t\t\t\t\t\t\tINNER JOIN dp.PolygonFleet(NOLOCK) pf ON f.Id=pf.fleetId  \r\n\t\t\t\t\t\t\tINNER JOIN dp.Polygon(NOLOCK) p ON p.Id=pf.PolygonId\r\n\t\t\t\t\t\t\tWHERE f.DriverId=d.Id \r\n\t\t\t\t\t\t\tORDER BY pf.Id DESC\r\n\t\t\t\t\t\t)\r\n\t\t\t\tEND,0) AS PolygonId\r\n\t\t\t\t,p.Title\t\t\t\t\t\t\t\t\tPolygonTitle\r\n\t\t\t\t,ISNULL(CASE WHEN d.IsActive=1 THEN \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT v2.VehicleTypeId\r\n\t\t\t\t\t\t\tFROM dp.fleet(NOLOCK) f2\r\n\t\t\t\t\t\t\tINNER JOIN dp.Vehicle(NOLOCK) v2 ON v2.id=f2.VehicleId\r\n\t\t\t\t\t\t\tWHERE f2.IsActive=1\r\n\t\t\t\t\t\t\tAND d.Id=f2.DriverId\r\n\t\t\t\t\t\t\tAND ((v2.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\t\t\t\t\t\tAND ((v2.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t\t\t\t\t\t)\r\n\t\t\t\tELSE\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT TOP 1 v2.VehicleTypeId\r\n\t\t\t\t\t\t\tFROM dp.fleet(NOLOCK) f2\r\n\t\t\t\t\t\t\tINNER JOIN dp.Vehicle(NOLOCK) v2 ON v2.id=f2.VehicleId\r\n\t\t\t\t\t\t\tWHERE d.Id=f2.DriverId\r\n\t\t\t\t\t\t\tAND ((v2.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\t\t\t\t\t\tAND ((v2.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t\t\t\t\t\t\tORDER BY F2.Id DESC\r\n\t\t\t\t\t\t)\r\n\t\t\t\tEND,0)\t\t\t\t\t\t\t\t\t\t\tVehicleTypeId\r\n\t\t\t\t,CASE WHEN d.IsActive=1 THEN (\r\n\t\t\t\t\t\t\tSELECT v2.plateNumber\r\n\t\t\t\t\t\t\tFROM dp.fleet(NOLOCK) f2\r\n\t\t\t\t\t\t\tINNER JOIN dp.Vehicle(NOLOCK) v2 ON v2.id=f2.VehicleId\r\n\t\t\t\t\t\t\tWHERE f2.IsActive=1\r\n\t\t\t\t\t\t\tAND d.Id=f2.DriverId\r\n\t\t\t\t\t\t\tAND ((v2.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\t\t\t\t\t\tAND ((v2.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\tELSE\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT TOP 1 v2.plateNumber\r\n\t\t\t\t\t\t\tFROM dp.fleet(NOLOCK) f2\r\n\t\t\t\t\t\t\tINNER JOIN dp.Vehicle(NOLOCK) v2 ON v2.id=f2.VehicleId\r\n\t\t\t\t\t\t\tWHERE d.Id=f2.DriverId\r\n\t\t\t\t\t\t\tAND ((v2.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\t\t\t\t\t\tAND ((v2.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t\t\t\t\t\t\tORDER BY F2.Id DESC\r\n\t\t\t\t\t\t)\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\tPlateNumber\r\n\t\t\t\t,d.IsActive\r\n\t\t\t\t,FORMAT(d.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)\tCreateDatePersianStr\r\n\t\t\t\t,(\r\n\t\t\t\t\tSELECT COUNT(DISTINCT fs.WeekDayId)\r\n\t\t\t\t\tFROM dp.FleetShift(NOLOCK) fs\r\n\t\t\t\t\tWHERE fs.FleetId=f.Id\r\n\t\t\t\t\tAND fs.IsDeleted=0\r\n\t\t\t\t\t) WorkingDaysCount\r\n\t\t\t\t,JSON_QUERY((\r\n\t\t\t\t\t--SELECT WeekDayId,\r\n\t\t\t\t\t\t\tSELECT\t\r\n\t\t\t\t\t\t\t\t\t--isc.Id,\r\n\t\t\t\t\t\t\t\t\tfs.Id fleetShiftId,\r\n\t\t\t\t\t\t\t\t\tShiftConfigurationId,\r\n\t\t\t\t\t\t\t\t\tisc.startTime,\r\n\t\t\t\t\t\t\t\t\tisc.endTime,\r\n\t\t\t\t\t\t\t\t\tWeekDayId--\r\n\t\t\t\t\t\t\tFROM dp.ShiftConfiguration(NOLOCK) isc\r\n\t\t\t\t\t\t\tINNER JOIN dp.FleetShift(NOLOCK) fs ON f.Id=fs.FleetId AND fs.IsDeleted=0\r\n\t\t\t\t\t\t\tWHERE isc.id=fs.ShiftConfigurationId\r\n\t\t\t\t\t\t\t--isc.id=fs.ShiftConfigurationId\r\n\t\t\t\t\t\t\tFOR JSON PATH\r\n\t\t\t\t\t\t\t--))Shifts\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t--FROM dp.FleetShift fs\r\n\t\t\t\t\t--WHERE fs.FleetId=f.Id\r\n\t\t\t\t\t--AND fs.IsDeleted=0\r\n\t\t\t\t\t--FOR JSON PATH\r\n\t\t\t\t\t))\t\t\t\t\t\t\t\t\t\tShiftConfigurationsJSON\r\n\t\tFROM dp.Driver(NOLOCK) d\r\n\t\tLEFT JOIN dp.Fleet(NOLOCK) f\t\t\t\t\t\t\t\tON f.DriverId=d.Id\t\tAND f.IsActive=1\r\n\t\tLEFT JOIN dp.PolygonFleet(NOLOCK) pf\t\t\t\t\t\tON pf.FleetId=f.Id\t\tAND pf.IsActive=1\r\n\t\tLEFT JOIN dp.Polygon(NOLOCK) p\t\t\t\t\t\t\t\tON p.id=pf.PolygonId\tAND p.IsActive=1\r\n\t\tLEFT JOIN dp.Vehicle(NOLOCK) v\t\t\t\t\t\t\t\tON v.Id=f.VehicleId\r\n\t\tWHERE \r\n\t\t\t((d.Mobile=@DriverMobile) OR (ISNULL(@DriverMobile,0)=0))\r\n\t\t\tAND ((d.Code=@DriverCode) OR (ISNULL(@DriverCode,0)=0))\r\n\t\t\tAND ((d.IsActive=@IsActive) OR (@IsActive IS NULL))\r\n\t\t\tAND ((d.CreateDatePersian BETWEEN @FromCreateDatePersian AND @ToCreateDatePersian) OR @FromCreateDatePersian IS NULL)\r\n\t\t\t--AND ((Contains(d.FirstName,@DriverName))OR (Contains(d.LastName,@DriverName))  OR(@DriverName=\u0027\u0022**\u0022\u0027))\r\n\t\t\tAND ((p.CityId=@CityId) OR (ISNULL(@CityId,0)=0))\r\n\t\t\tAND ((p.Id=@PolygonId) OR (ISNULL(@PolygonId,0)=0))\r\n\t\t\tAND ((v.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\t\tAND ((v.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t)\r\n\tselect * \r\n\tfrom cte\r\n\twhere name like \u0027%\u0027\u002B@DriverName\u002B\u0027%\u0027 OR @DriverName=\u0027\u0027 -- ((Contains(Name,@DriverName))OR (Contains(d.LastName,@DriverName))  OR(@DriverName=\u0027\u0022**\u0022\u0027)) \r\n\tORDER BY Id DESC\r\n\tOFFSET (@pageIndex * @pageSize) ROWS \r\n\tFETCH NEXT @pageSize ROWS ONLY\r\n\t\t\t\r\n\r\n\t\r\n"},{"Name":"Get_Drivers_By_Filter_Test","Schema":"dbo","Definition":"\r\n/* \r\ndeclare @TotalCount nvarchar(max)\r\nexec [dbo].[Get_Drivers_By_Filter_Test]\r\n\t@DriverName=N\u0027\u0645\u0631\u0027,\r\n\t@DriverMobile\t\t\t=NULL ,\r\n\t@DriverCode\t\t\t\t=NULL ,\r\n\t@CityId\t\t\t\t\t= null,\r\n\t@PolygonId\t\t\t\t= null,\r\n\t@VehicleTypeId\t\t\t= null,\r\n\t@PlateNumber\t\t\t= null,\r\n\t@IsActive\t\t\t\t= null,\r\n\t@FromCreateDate\t= NULL,\r\n\t@ToCreateDate\t= NULL,\r\n\t@DeliveryServiceProviderIds = NULL,\r\n\t@RegistrationProvider\t\t= NULL,\r\n\t@FleetIsActive\t\t\t\t= NULL,\r\n\t@DeliveryServiceTypeId\t\t= NULL,\r\n\t@AccommodationNeed\t\t\t= NULL,\r\n\t@IsUtilizing\t\t\t\t= NULL,\r\n\t@FleetContractTypeId\t\t= NULL,\r\n\t@ReasonFleetChangeStateId\t= NULL,\r\n\t@FleetIsInitial\t\t\t\t= NULL,\r\n\r\n\t@PageIndex\t\t\t\t=0,\r\n\t@PageSize\t\t\t\t=40,\r\n\t@TotalCount=@TotalCount out\r\n\tselect @TotalCount\r\n*/\r\n\r\nCREATE PROCEDURE [dbo].[Get_Drivers_By_Filter_Test]\r\n\r\n\t@DriverName\t\t\t\t\tNVARCHAR(50),\r\n\t@DriverMobile\t\t\t\tBIGINT,\r\n\t@DriverCode\t\t\t\t\tBIGINT,\r\n\t@CityId\t\t\t\t\t\tINT,\r\n\t@PolygonId\t\t\t\t\tINT,\r\n\t@VehicleTypeId\t\t\t\tTINYINT,\r\n\t@PlateNumber\t\t\t\tNVARCHAR(30),\r\n\t@IsActive\t\t\t\t\tBIT,\r\n\t@FromCreateDate\t\t\t\tBIGINT,\r\n\t@ToCreateDate\t\t\t\tBIGINT,\r\n\t@DeliveryServiceProviderIds VARCHAR(MAX) = NULL,\r\n\r\n\t@RegistrationProvider\t\tVARCHAR(MAX) = NULL,\r\n\t@FleetIsActive\t\t\t\tBIT = NULL,\r\n\t@DeliveryServiceTypeId\t\tVARCHAR(MAX) = NULL,\r\n\t@AccommodationNeed\t\t\tBIT = NULL,\r\n\t@IsUtilizing\t\t\t\tBIT = NULL,\r\n\t@FleetContractTypeId\t\tVARCHAR(MAX) = NULL,\r\n\t@ReasonFleetChangeStateId\tVARCHAR(MAX) = NULL,\r\n\t@FleetIsInitial\t\t\t\tBIT = NULL,\r\n\t--@ShiftConfigurationIds\t\tNVARCHAR(MAX),\r\n\r\n\t@PageIndex\t\t\t\t\tINT\t,\r\n\t@PageSize\t\t\t\t\tINT\t,\r\n\t@TotalCount\t\t\t\t\tINT OUTPUT\r\n\t--@NotFleetIsInitial\t\t\tINT OUTPUT\r\nAS\r\n\t--###########################################################################################################################\r\n\r\n\tSET @FleetIsInitial = ISNULL(@FleetIsInitial,0)\r\n\tSET @DriverName=ISNULL(@DriverName,\u0027\u0027)\r\n\tSET @DeliveryServiceProviderIds = ISNULL(@DeliveryServiceProviderIds,\u00270\u0027)\r\n\tSET @DeliveryServiceProviderIds = \u00271\u0027\r\n\r\n\t--###########################################################################################################################\r\n\t\r\n\tSELECT \r\n\t\tdsp.Id \r\n\tINTO #DeliveryServiceProviderID\r\n\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceProviderIds,\u0027,\u0027) ss\r\n\t\tON dsp.Id = ss.value\r\n\t\tOR @DeliveryServiceProviderIds = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#DeliveryServiceProviderID ON #DeliveryServiceProviderID\r\n\t(\r\n\t\tId\r\n\t)\r\n\t--###########################################################################################################################\r\n\r\n\tSELECT \r\n\t\trp.Id \r\n\tINTO #RegistrationProvider\r\n\tFROM DP.RegistrationProvider AS rp (NOLOCK)\r\n\tINNER JOIN string_split(@RegistrationProvider,\u0027,\u0027) ss\r\n\t\tON rp.Id = ss.value\r\n\t\tOR @RegistrationProvider = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#RegistrationProvider ON #RegistrationProvider\r\n\t(\r\n\t\tId\r\n\t)\r\n\t--#############################################################################################################################\r\n\r\n\tSELECT \r\n\t\tdst.Id \r\n\tINTO #DeliveryServiceTypeId\r\n\tFROM DP.DeliveryServiceType AS dst (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceTypeId,\u0027,\u0027) ss\r\n\t\tON dst.Id = ss.value\r\n\t\tOR @DeliveryServiceTypeId = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#DeliveryServiceTypeId ON #DeliveryServiceTypeId\r\n\t(\r\n\t\tId\r\n\t)\r\n\t--#############################################################################################################################\r\n\r\n\tSELECT \r\n\t\tfct.Id \r\n\tINTO #FleetContractTypeId\r\n\tFROM DP.FleetContractType AS fct (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceTypeId,\u0027,\u0027) ss\r\n\t\tON fct.Id = ss.value\r\n\t\tOR @FleetContractTypeId = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#FleetContractTypeId ON #FleetContractTypeId\r\n\t(\r\n\t\tId\r\n\t)\r\n\t--#############################################################################################################################\r\n\r\n\tSELECT \r\n\t\trfcs.Id \r\n\tINTO #ReasonFleetChangeStateId\r\n\tFROM DP.ReasonFleetChangeState AS rfcs (NOLOCK)\r\n\tINNER JOIN string_split(@ReasonFleetChangeStateId,\u0027,\u0027) ss\r\n\t\tON rfcs.Id = ss.value\r\n\t\tOR @ReasonFleetChangeStateId = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#ReasonFleetChangeStateId ON #ReasonFleetChangeStateId\r\n\t(\r\n\t\tId\r\n\t)\r\n\t--#############################################################################################################################\r\n\t\t   \r\n\tDROP TABLE IF EXISTS #Final\r\n\t/*SELECT \r\n\t\tISNULL(f.Id,0)\t\t\t\t\t\t\t\tFleetId\r\n\t\t,d.Id\t\t\t\t\t\t\t\t\t\tId\r\n\t\t,d.CustomerId\r\n\t\t,CONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\t\tName\r\n\t\t,d.FirstName\t\t\t\t\t\t\t\tFirstName\r\n\t\t,d.LastName\t\t\t\t\t\t\t\t\tLastName\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tPhone\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tAddress\r\n\t\t\t\t\t\r\n\t\t,CONCAT(\u00270\u0027,CAST(d.Mobile AS VARCHAR(11)))\tMobile\r\n\t\t,RIGHT(\u0027000\u0027 \u002B CAST(d.Code AS NVARCHAR(10)) , 10) AS\t\tCode\r\n\t\t,ISNULL(p.CityId,0)\t\t\t\t\t\t\tCityId\r\n\t\t,CAST(0 AS TINYINT)\t\t\t\t\t\t\tProvinceId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tCityName\r\n\t\t,d.IsActive\r\n\t\t,d.CreateDatePersian--FORMAT(d.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)\tCreateDatePersianStr\r\n\tINTO #Final\r\n\tFROM dp.Driver(NOLOCK) d\r\n\tLEFT JOIN dp.Fleet(NOLOCK) f\t\t\t\t\t\t\t\tON f.DriverId=d.Id\t\tAND f.IsActive=1\r\n\tLEFT JOIN dp.PolygonFleet(NOLOCK) pf\t\t\t\t\t\tON pf.FleetId=f.Id\t\tAND pf.IsActive=1\r\n\tLEFT JOIN dp.Polygon(NOLOCK) p\t\t\t\t\t\t\t\tON p.id=pf.PolygonId\tAND p.IsActive=1\r\n\tLEFT JOIN dp.Vehicle(NOLOCK) v\t\t\t\t\t\t\t\tON v.Id=f.VehicleId\r\n\tWHERE \r\n\t\t((d.Mobile=@DriverMobile) OR (ISNULL(@DriverMobile,0)=0))\r\n\t\tAND ((d.Code=@DriverCode) OR (ISNULL(@DriverCode,0)=0))\r\n\t\tAND ((d.IsActive=@IsActive) OR (@IsActive IS NULL))\r\n\t\tAND ((d.CreateDate BETWEEN @FromCreateDate AND @ToCreateDate) OR @FromCreateDate IS NULL)\r\n\t\t--AND ((Contains(d.FirstName,@DriverName))OR (Contains(d.LastName,@DriverName))  OR(@DriverName=\u0027\u0022**\u0022\u0027))\r\n\t\tAND ((p.CityId=@CityId) OR (ISNULL(@CityId,0)=0))\r\n\t\tAND ((p.Id=@PolygonId) OR (ISNULL(@PolygonId,0)=0))\r\n\t\tAND ((v.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\tAND ((v.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t\tAND (CONCAT(d.FirstName,\u0027 \u0027,d.LastName) like \u0027%\u0027\u002B@DriverName\u002B\u0027%\u0027 OR @DriverName=\u0027\u0027) -- ((Contains(Name,@DriverName))OR (Contains(d.LastName,@DriverName))  OR(@DriverName=\u0027\u0022**\u0022\u0027)) \r\n\t*/\r\n\r\n\tSELECT \r\n\t\tCAST(0 AS INT)\t\t\t\t\t\t\t\t\t\tFleetId\r\n\t\t,d.Id\t\t\t\t\t\t\t\t\t\t\t\tId\r\n\t\t,d.CustomerId\t\t\t\t\t\t\t\t\t\tCustomerId\r\n\t\t,CONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\t\t\t\tName\r\n\t\t,d.FirstName\t\t\t\t\t\t\t\t\t\tFirstName\r\n\t\t,d.LastName\t\t\t\t\t\t\t\t\t\t\tLastName\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tPhone\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tAddress\t\t\t\t\t\r\n\t\t,CONCAT(\u00270\u0027,CAST(d.Mobile AS VARCHAR(11)))\t\t\tMobile\r\n\t\t,RIGHT(\u0027000\u0027 \u002B CAST(d.Code AS NVARCHAR(10)) , 10)\tCode\r\n\t\t,CAST(0 AS SMALLINT)\t\t\t\t\t\t\t\tCityId\r\n\t\t,CAST(0 AS TINYINT)\t\t\t\t\t\t\t\t\tProvinceId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tCityName\r\n\t\t,d.IsActive\t\t\t\t\t\t\t\t\t\t\tIsActive\r\n\t\t,d.CreateDatePersian\t\t\t\t\t\t\t\tCreateDatePersian\r\n\t\t,CAST(NULL AS TINYINT)\t\t\t\t\t\t\t\tDeliveryServiceProviderId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tRegistrationProviderId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tRegistrationProviderTitle\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tFleetIsActive\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tDeliveryServiceTypeId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tDeliveryServiceTypeTitle\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tAccommodationNeed \r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tIsUtilizing\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tDormitoryStatusTitle\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tFleetContractTypeId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tFleetContractTypeTitle\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tReasonFleetChangeStateId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tReasonFleetChangeStateTitle\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\t\t\tFleetIsInitial\r\n\r\n\tINTO #Final\r\n\tFROM dp.Driver(NOLOCK) d\r\n\tLEFT JOIN dp.Fleet(NOLOCK) f ON f.DriverId = d.Id AND f.IsActive = 1\r\n\tWHERE f.ID IS NULL\r\n\tAND ((d.Mobile = @DriverMobile) OR (ISNULL(@DriverMobile,0)=0))\r\n\tAND ((d.Code = @DriverCode) OR (ISNULL(@DriverCode,0)=0))\r\n\tAND ((d.IsActive = @IsActive) OR (@IsActive IS NULL))\r\n\tAND \t \r\n\t(\r\n\t\t\t(d.CreateDate \u003E= @FromCreateDate OR @FromCreateDate IS NULL ) \r\n\t\tAND (d.CreateDate \u003C= @ToCreateDate OR @ToCreateDate IS NULL)\r\n\t)\r\n\tAND (CONCAT(d.FirstName,\u0027 \u0027,d.LastName) like \u0027%\u0027\u002B@DriverName\u002B\u0027%\u0027 OR @DriverName=\u0027\u0027) \r\n\tAND ISNULL( @CityId,0) = 0\r\n\tAND ISNULL( @PolygonId,0) = 0\r\n\tAND ISNULL( @VehicleTypeId,0) = 0\r\n\tAND ISNULL( @PlateNumber,\u0027\u0027) = \u0027\u0027\r\n\t--AND ISNULL( @RegistrationProvider\t,0) = 0\t\r\n\t--AND ISNULL(\t@FleetIsActive\t,0) = 0\t\t\t\r\n\t--AND ISNULL(\t@DeliveryServiceTypeId\t,0) = 0\t\r\n\t--AND ISNULL(\t@AccommodationNeed\t,0) = 0\t\t\r\n\t--AND ISNULL(\t@IsUtilizing\t,0) = 0\t\t\t\r\n\t--AND ISNULL(\t@FleetContractTypeId,0) = 0\t\t\r\n\t--AND ISNULL(\t@ReasonFleetChangeStateId\t,0) = 0\r\n\t--AND ISNULL(\t@FleetIsInitial\t,0) = 0\t\t\r\n\t\r\n\tUNION ALL\r\n\tSELECT \r\n\t\tISNULL(f.Id,0)\t\t\t\t\t\t\t\tFleetId\r\n\t\t,d.Id\t\t\t\t\t\t\t\t\t\tId\r\n\t\t,d.CustomerId\r\n\t\t,CONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\t\tName\r\n\t\t,d.FirstName\t\t\t\t\t\t\t\tFirstName\r\n\t\t,d.LastName\t\t\t\t\t\t\t\t\tLastName\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tPhone\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tAddress\t\t\t\t\t\r\n\t\t,CONCAT(\u00270\u0027,CAST(d.Mobile AS VARCHAR(11)))\tMobile\r\n\t\t,RIGHT(\u0027000\u0027 \u002B CAST(d.Code AS NVARCHAR(10)) , 10) AS\t\tCode\r\n\t\t,ISNULL(p.CityId,0)\t\t\t\t\t\t\tCityId\r\n\t\t,CAST(0 AS TINYINT)\t\t\t\t\t\t\tProvinceId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tCityName\r\n\t\t,d.IsActive\r\n\t\t,d.CreateDatePersian--FORMAT(d.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)\tCreateDatePersianStr \r\n\t\t,f.DeliveryServiceProviderId\r\n\t\t,rp2.Id AS RegistrationProviderId\r\n\t\t,rp2.Title AS RegistrationProviderTitle\r\n\t\t,f.IsActive AS FleetIsActive\r\n\t\t,dst2.Id AS DeliveryServiceTypeId\r\n\t\t,dst2.Title AS DeliveryServiceTypeTitle\r\n\t\t,ai.AccommodationNeed \r\n\t\t,afh2.IsUtilizing\r\n\t\t,afh2.DormitoryStatusTitle\r\n\t\t,fct2.Id AS FleetContractTypeId\r\n\t\t,fct2.Title AS FleetContractTypeTitle\r\n\t\t,rfcs2.Id AS ReasonFleetChangeStateId\r\n\t\t,rfcs2.Title AS ReasonFleetChangeStateTitle\r\n\t\t,f.IsInitial AS FleetIsInitial\r\n\r\n\tFROM dp.Driver(NOLOCK) d\r\n\tINNER JOIN dp.Fleet(NOLOCK) f ON f.DriverId = d.Id\tAND f.IsActive = 1\r\n\tLEFT JOIN #DeliveryServiceProviderID dps ON f.DeliveryServiceProviderId = dps.Id\r\n\tLEFT JOIN #RegistrationProvider AS rp ON rp.Id = d.RegistrationProviderId\t\r\n\tLEFT JOIN #FleetContractTypeId AS fct ON fct.Id = f.FleetContractTypeId\t\r\n\tLEFT JOIN DP.AdditionalInformation AS ai ON ai.DriverId = d.Id\r\n\tLEFT JOIN #DeliveryServiceTypeId AS dst ON dst.Id = ai.DeliveryServiceTypeId\r\n\t\r\n\tLEFT JOIN dp.PolygonFleet(NOLOCK) pf ON pf.FleetId = f.Id\tAND pf.IsActive = 1\r\n\tLEFT JOIN dp.Polygon(NOLOCK) p\tON p.id = pf.PolygonId\tAND p.IsActive = 1\r\n\tLEFT JOIN dp.Vehicle(NOLOCK) v\tON v.Id = f.VehicleId\r\n\t\r\n\tLEFT JOIN DP.RegistrationProvider AS rp2 ON rp2.Id = d.RegistrationProviderId\t\r\n\tLEFT JOIN DP.DeliveryServiceType AS dst2 ON dst2.Id = ai.DeliveryServiceTypeId\r\n\t\r\n\t--LEFT JOIN DP.AccommodationFacilitiesHistory AS afh ON afh.DriverId = d.Id\r\n\tOUTER APPLY (\r\n\t\t\t\tSELECT TOP 1 afh2.IsUtilizing ,afh2.DriverId,afh2.DormitoryStatusTitle\r\n\t\t\t\tFROM DP.AccommodationFacilitiesHistory AS afh2\r\n\t\t\t\tWHERE afh2.DriverId = d.Id\r\n\t\t\t\tORDER BY afh2.Id DESC\r\n\t) afh2 \r\n\r\n\tLEFT JOIN DP.FleetContractType AS fct2 ON fct2.Id = f.FleetContractTypeId\r\n\t--LEFT JOIN DP.FleetChangeStateHistory AS fcsh ON fcsh.FleetId = f.Id\r\n\tLEFT JOIN DP.ReasonFleetChangeState AS rfcs2 ON rfcs2.Id = f.ReasonFleetChangeStateId\r\n\tleft JOIN #ReasonFleetChangeStateId AS rfcs ON rfcs.Id = rfcs2.Id\r\n\r\n\tWHERE \t\r\n\t\t((d.Mobile=@DriverMobile) OR (ISNULL(@DriverMobile,0)=0))\r\n\tAND ((d.Code=@DriverCode) OR (ISNULL(@DriverCode,0)=0))\r\n\tAND ((d.IsActive=@IsActive) OR (@IsActive IS NULL))\r\n\tAND \r\n\t(\r\n\t\t\t(d.CreateDate \u003E= @FromCreateDate OR @FromCreateDate IS NULL ) \r\n\t\tAND (d.CreateDate \u003C= @ToCreateDate OR @ToCreateDate IS NULL)\r\n\t)\r\n\tAND (CONCAT(d.FirstName,\u0027 \u0027,d.LastName) LIKE \u0027%\u0027\u002B@DriverName\u002B\u0027%\u0027 OR @DriverName=\u0027\u0027) -- ((Contains(Name,@DriverName))OR (Contains(d.LastName,@DriverName))  OR(@DriverName=\u0027\u0022**\u0022\u0027)) \r\n\tAND ((p.CityId = @CityId) OR (ISNULL(@CityId,0) = 0))\r\n\tAND ((p.Id = @PolygonId) OR (ISNULL(@PolygonId,0) = 0))\r\n\tAND ((v.VehicleTypeId = @VehicleTypeId) OR (ISNULL(@VehicleTypeId,0) = 0))\r\n\tAND ((v.PlateNumber = @PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027) = \u0027\u0027))\r\n\tAND ((f.IsActive = @FleetIsActive ) OR  (ISNULL(\t@FleetIsActive\t,0) = 0\t))\t\t\r\n\tAND\t((ai.AccommodationNeed = @AccommodationNeed) OR(ISNULL(\t@AccommodationNeed\t,0) = 0\t\t))\r\n\tAND ((afh2.IsUtilizing = @IsUtilizing) OR (\tISNULL(\t@IsUtilizing\t,0) = 0\t))\t\t\r\n\tAND\t ((f.IsInitial = @FleetIsInitial) OR  (ISNULL(\t@FleetIsInitial\t,0) = 0\t\t))\r\n\r\n\tSET @TotalCount = @@ROWCOUNT\r\n\r\n\tCREATE INDEX IX_#Final ON #Final\r\n\t(\r\n\t\tID DESC\r\n\t)\r\n\r\n\tDROP TABLE IF EXISTS #Output\r\n\tSELECT\r\n\t\t* \r\n\tINTO #Output\r\n\tFROM #Final\r\n\tORDER BY Id DESC\r\n\tOFFSET (@pageIndex * @pageSize) ROWS \r\n\tFETCH NEXT @pageSize ROWS ONLY\r\n\r\n\tCREATE INDEX IX_#Output ON #Output\r\n\t(\r\n\t\tID ASC,\r\n\t\tFleetID ASC\r\n\t)\r\n\r\n\t;WITH CTE_PolygonId_Active AS\r\n\t(\r\n\t\tSELECT DISTINCT p.Id AS PolygonId , p.Title AS PolygonTitle, f.DriverId\r\n\t\tFROM #Output c\r\n\t\tINNER JOIN dp.fleet(NOLOCK) f ON c.ID = f.DriverId\r\n\t\tINNER JOIN dp.PolygonFleet(NOLOCK) pf ON f.Id=pf.fleetId  \r\n\t\tINNER JOIN dp.Polygon(NOLOCK) p ON p.Id=pf.PolygonId\r\n\t\tWHERE pf.IsActive=1\r\n\t\tAND f.IsActive=1\r\n\t),CTE_PolygonId_NotActive AS\r\n\t(\r\n\t\tSELECT PolygonId , PolygonTitle , DriverId\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT DISTINCT p.Id AS PolygonId , p.Title AS PolygonTitle , f.DriverId , ROW_NUMBER() OVER ( PARTITION BY f.DriverId ORDER BY pf.Id DESC ) RowNum\r\n\t\t\tFROM #Output c\r\n\t\t\tINNER JOIN dp.fleet(NOLOCK) f ON c.ID = f.DriverId\r\n\t\t\tINNER JOIN dp.PolygonFleet(NOLOCK) pf ON f.Id=pf.fleetId  \r\n\t\t\tINNER JOIN dp.Polygon(NOLOCK) p ON p.Id=pf.PolygonId\r\n\t\t) SQ \r\n\t\tWHERE SQ.RowNum = 1\r\n\r\n\t), CTE_Vehicle_IsActive AS\r\n\t(\r\n\r\n\t\tSELECT DISTINCT v2.VehicleTypeId , v2.PlateNumber , f2.DriverId\r\n\t\tFROM #Output c\r\n\t\tINNER JOIN dp.fleet(NOLOCK) f2 ON c.ID = f2.DriverId\r\n\t\tINNER JOIN dp.Vehicle(NOLOCK) v2 ON v2.id=f2.VehicleId\r\n\t\tWHERE f2.IsActive=1\r\n\t\tAND ((v2.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\tAND ((v2.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t),CTE_Vehicle_NotActive AS\r\n\t(\r\n\t\tSELECT VehicleTypeId, PlateNumber ,DriverId\r\n\t\tFROM \r\n\t\t(\r\n\t\t\tSELECT DISTINCT v2.VehicleTypeId, v2.PlateNumber ,f2.DriverId, ROW_NUMBER() OVER ( PARTITION BY f2.DriverId ORDER BY F2.Id DESC ) RowNum\r\n\t\t\tFROM #Output c\r\n\t\t\tINNER JOIN dp.fleet(NOLOCK) f2 ON c.ID = f2.DriverId\r\n\t\t\tINNER JOIN dp.Vehicle(NOLOCK) v2 ON v2.id=f2.VehicleId\r\n\t\t\tAND ((v2.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\t\tAND ((v2.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t\t) SQ\r\n\t\tWHERE SQ.RowNum = 1\r\n\t), CTE_WorkingDaysCount AS\r\n\t(\r\n\t\tSELECT c.FleetId , COUNT(DISTINCT fs.WeekDayId) WorkingDaysCount\r\n\t\tFROM #Output c \r\n\t\tINNER JOIN dp.FleetShift(NOLOCK) fs\tON c.FleetId = fs.FleetId AND fs.IsDeleted=0\r\n\t\tGroup By c.FleetId\r\n\t)\r\n\r\n\tSELECT \r\n\t\tc.FleetId\t\t\t\t\t,\r\n\t\tc.Id\t\t\t\t\t\t,\r\n\t\tc.CustomerId\t\t\t\t,\r\n\t\tc.Name\t\t\t\t\t\t,\r\n\t\tc.FirstName\t\t\t\t\t,\r\n\t\tc.LastName\t\t\t\t\t,\r\n\t\tc.Phone\t\t\t\t\t\t,\r\n\t\tc.Address\t\t\t\t\t,\r\n\t\tc.Mobile\t\t\t\t\t,\r\n\t\tc.Code\t\t\t\t\t\t,\r\n\t\tc.CityId\t\t\t\t\t,\r\n\t\tc.ProvinceId\t\t\t\t,\r\n\t\tc.CityName\t\t\t\t\t,\r\n\t\tISNULL(ISNULL(pa.PolygonId,pna.PolygonId),0) PolygonId ,\r\n\t\tISNULL(pa.PolygonTitle,pna.PolygonTitle) PolygonTitle ,\r\n\t\tISNULL(ISNULL(va.VehicleTypeId,vna.VehicleTypeId),0) VehicleTypeId ,\r\n\t\tISNULL(va.PlateNumber,vna.PlateNumber) PlateNumber ,\r\n\t\tc.IsActive\t\t\t\t\t,\r\n\t\tFORMAT(c.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersianStr\t,\r\n\t\tISNULL(wdc.WorkingDaysCount,0) WorkingDaysCount\t,\r\n\t\tJSON_QUERY((\r\n\t\t--SELECT WeekDayId,\r\n\t\t\t\tSELECT\t\r\n\t\t\t\t\t\t--isc.Id,\r\n\t\t\t\t\t\tfs.Id fleetShiftId,\r\n\t\t\t\t\t\tShiftConfigurationId,\r\n\t\t\t\t\t\tisc.startTime,\r\n\t\t\t\t\t\tisc.endTime,\r\n\t\t\t\t\t\tWeekDayId--\r\n\t\t\t\tFROM dp.ShiftConfiguration(NOLOCK) isc\r\n\t\t\t\tINNER JOIN dp.FleetShift(NOLOCK) fs ON c.FleetId=fs.FleetId AND fs.IsDeleted=0\r\n\t\t\t\tWHERE isc.id=fs.ShiftConfigurationId\r\n\t\t\t\tAND fs.FleetId = c.FleetId\r\n\t\t\t\t--isc.id=fs.ShiftConfigurationId\r\n\t\t\t\tFOR JSON PATH\r\n\t\t\t\t--))Shifts\r\n\t\t\t\t\t\t\t\r\n\t\t--FROM dp.FleetShift fs\r\n\t\t--WHERE fs.FleetId=f.Id\r\n\t\t--AND fs.IsDeleted=0\r\n\t\t--FOR JSON PATH\r\n\t\t))\t\t\t\t\t\t\t\t\t\tShiftConfigurationsJSON,\r\n\t\tISNULL(c.DeliveryServiceProviderId,CAST(1 AS TINYINT)) DeliveryServiceProviderId,\r\n\t\tISNULL(c.RegistrationProviderId,CAST(1 AS SMALLINT)) RegistrationProviderId,\r\n\t\tISNULL(c.RegistrationProviderTitle,\u0027\u0027) RegistrationProviderTitle,\r\n\t\tISNULL(c.FleetIsActive,CAST (0 AS BIT)) FleetIsActive,\r\n\t\tISNULL(c.DeliveryServiceTypeId,CAST(1 AS TINYINT)) DeliveryServiceTypeId,\r\n\t\tISNULL(c.DeliveryServiceTypeTitle,\u0027\u0027) DeliveryServiceTypeTitle,\r\n\t\tISNULL(c.AccommodationNeed,CAST(1 AS BIT)) AccommodationNeed,\r\n\t\tISNULL(c.IsUtilizing,CAST(0 AS BIT)) IsUtilizing,\r\n\t\tISNULL(c.DormitoryStatusTitle,N\u0027\u062F\u0631\u062E\u0648\u0627\u0633\u062A\u0027) AS DormitoryStatusTitle,\r\n\t\tISNULL(c.FleetContractTypeId,CAST(1 AS INT)) FleetContractTypeId,\r\n\t\tISNULL(c.FleetContractTypeTitle,\u0027\u0027) FleetContractTypeTitle,\r\n\t\tISNULL(c.ReasonFleetChangeStateId,CAST(1 AS INT)) ReasonFleetChangeStateId,\r\n\t\tISNULL(c.ReasonFleetChangeStateTitle,\u0027\u0027) ReasonFleetChangeStateTitle,\r\n\t\tISNULL(c.FleetIsInitial,CAST(1 AS BIT)) FleetIsInitial\r\n\r\n\r\n\r\n\tFROM #Output c\r\n\tLEFT JOIN CTE_PolygonId_Active pa\r\n\t\tON c.ID = pa.DriverId AND c.IsActive = 1\r\n\tLEFT JOIN CTE_PolygonId_NotActive pna\r\n\t\tON c.ID = pna.DriverId AND c.IsActive = 0\r\n\r\n\tLEFT JOIN CTE_Vehicle_IsActive va\r\n\t\tON c.ID = va.DriverId AND c.IsActive = 1\r\n\tLEFT JOIN CTE_Vehicle_NotActive vna\r\n\t\tON c.ID = vna.DriverId AND c.IsActive = 0\r\n\r\n\tLEFT JOIN CTE_WorkingDaysCount wdc\r\n\t\tON c.FleetId = wdc.FleetId\r\n\r\n\t\t\r\n\t\r\n"},{"Name":"Get_Drivers_By_Filter_Test2","Schema":"dbo","Definition":"\r\nCREATE PROCEDURE [dbo].[Get_Drivers_By_Filter_Test2]\r\n\r\n\t@DriverName\t\t\t\t\tNVARCHAR(50),\r\n\t@DriverMobile\t\t\t\tBIGINT,\r\n\t@DriverCode\t\t\t\t\tBIGINT,\r\n\t@CityId\t\t\t\t\t\tINT,\r\n\t@PolygonId\t\t\t\t\tINT,\r\n\t@VehicleTypeId\t\t\t\tTINYINT,\r\n\t@PlateNumber\t\t\t\tNVARCHAR(30),\r\n\t@IsActive\t\t\t\t\tBIT,\r\n\t@FromCreateDate\t\t\t\tBIGINT,\r\n\t@ToCreateDate\t\t\t\tBIGINT,\r\n\t@DeliveryServiceProviderIds VARCHAR(MAX) = NULL,\r\n\t--@ShiftConfigurationIds\t\tNVARCHAR(MAX),\r\n\r\n\t@PageIndex\t\t\t\t\tINT\t,\r\n\t@PageSize\t\t\t\t\tINT\t,\r\n\t@TotalCount\t\t\t\t\tINT OUTPUT\r\nAS\r\n\t\r\n\tSET @DriverName=ISNULL(@DriverName,\u0027\u0027)\r\n\r\n\tSET @DeliveryServiceProviderIds = ISNULL(@DeliveryServiceProviderIds,\u00270\u0027)\r\n\tSET @DeliveryServiceProviderIds = \u00271\u0027\r\n\tSELECT \r\n\t\tdsp.Id \r\n\tINTO #DeliveryServiceProviderID\r\n\tFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceProviderIds,\u0027,\u0027) ss\r\n\t\tON dsp.Id = ss.value\r\n\t\tOR @DeliveryServiceProviderIds = \u00270\u0027\r\n\r\n\tCREATE INDEX IX_#DeliveryServiceProviderID ON #DeliveryServiceProviderID\r\n\t(\r\n\t\tId\r\n\t)\r\n\r\n\r\n\r\n\tDROP TABLE IF EXISTS #Final\r\n\t/*SELECT \r\n\t\tISNULL(f.Id,0)\t\t\t\t\t\t\t\tFleetId\r\n\t\t,d.Id\t\t\t\t\t\t\t\t\t\tId\r\n\t\t,d.CustomerId\r\n\t\t,CONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\t\tName\r\n\t\t,d.FirstName\t\t\t\t\t\t\t\tFirstName\r\n\t\t,d.LastName\t\t\t\t\t\t\t\t\tLastName\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tPhone\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tAddress\r\n\t\t\t\t\t\r\n\t\t,CONCAT(\u00270\u0027,CAST(d.Mobile AS VARCHAR(11)))\tMobile\r\n\t\t,RIGHT(\u0027000\u0027 \u002B CAST(d.Code AS NVARCHAR(10)) , 10) AS\t\tCode\r\n\t\t,ISNULL(p.CityId,0)\t\t\t\t\t\t\tCityId\r\n\t\t,CAST(0 AS TINYINT)\t\t\t\t\t\t\tProvinceId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tCityName\r\n\t\t,d.IsActive\r\n\t\t,d.CreateDatePersian--FORMAT(d.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)\tCreateDatePersianStr\r\n\tINTO #Final\r\n\tFROM dp.Driver(NOLOCK) d\r\n\tLEFT JOIN dp.Fleet(NOLOCK) f\t\t\t\t\t\t\t\tON f.DriverId=d.Id\t\tAND f.IsActive=1\r\n\tLEFT JOIN dp.PolygonFleet(NOLOCK) pf\t\t\t\t\t\tON pf.FleetId=f.Id\t\tAND pf.IsActive=1\r\n\tLEFT JOIN dp.Polygon(NOLOCK) p\t\t\t\t\t\t\t\tON p.id=pf.PolygonId\tAND p.IsActive=1\r\n\tLEFT JOIN dp.Vehicle(NOLOCK) v\t\t\t\t\t\t\t\tON v.Id=f.VehicleId\r\n\tWHERE \r\n\t\t((d.Mobile=@DriverMobile) OR (ISNULL(@DriverMobile,0)=0))\r\n\t\tAND ((d.Code=@DriverCode) OR (ISNULL(@DriverCode,0)=0))\r\n\t\tAND ((d.IsActive=@IsActive) OR (@IsActive IS NULL))\r\n\t\tAND ((d.CreateDate BETWEEN @FromCreateDate AND @ToCreateDate) OR @FromCreateDate IS NULL)\r\n\t\t--AND ((Contains(d.FirstName,@DriverName))OR (Contains(d.LastName,@DriverName))  OR(@DriverName=\u0027\u0022**\u0022\u0027))\r\n\t\tAND ((p.CityId=@CityId) OR (ISNULL(@CityId,0)=0))\r\n\t\tAND ((p.Id=@PolygonId) OR (ISNULL(@PolygonId,0)=0))\r\n\t\tAND ((v.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\tAND ((v.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t\tAND (CONCAT(d.FirstName,\u0027 \u0027,d.LastName) like \u0027%\u0027\u002B@DriverName\u002B\u0027%\u0027 OR @DriverName=\u0027\u0027) -- ((Contains(Name,@DriverName))OR (Contains(d.LastName,@DriverName))  OR(@DriverName=\u0027\u0022**\u0022\u0027)) \r\n\t*/\r\n\r\n\tSELECT \r\n\t\tCAST(0 AS INT)\t\t\t\t\t\t\t\tFleetId\r\n\t\t,d.Id\t\t\t\t\t\t\t\t\t\tId\r\n\t\t,d.CustomerId\r\n\t\t,CONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\t\tName\r\n\t\t,d.FirstName\t\t\t\t\t\t\t\tFirstName\r\n\t\t,d.LastName\t\t\t\t\t\t\t\t\tLastName\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tPhone\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tAddress\r\n\t\t\t\t\t\r\n\t\t,CONCAT(\u00270\u0027,CAST(d.Mobile AS VARCHAR(11)))\tMobile\r\n\t\t,RIGHT(\u0027000\u0027 \u002B CAST(d.Code AS NVARCHAR(10)) , 10) AS\t\tCode\r\n\t\t,CAST(0 AS SMALLINT)\t\t\t\t\t\tCityId\r\n\t\t,CAST(0 AS TINYINT)\t\t\t\t\t\t\tProvinceId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tCityName\r\n\t\t,d.IsActive\r\n\t\t,d.CreateDatePersian,\r\n\t\tCAST(NULL AS TINYINT) AS DeliveryServiceProviderId\r\n\tINTO #Final\r\n\tFROM dp.Driver(NOLOCK) d\r\n\tLEFT JOIN dp.Fleet(NOLOCK) f\t\t\t\t\t\t\t\t\r\n\t\tON f.DriverId = d.Id\t\t\r\n\t\tAND f.IsActive = 1\r\n\tWHERE f.ID IS NULL\r\n\r\n\tAND ((d.Mobile = @DriverMobile) OR (ISNULL(@DriverMobile,0)=0))\r\n\tAND ((d.Code = @DriverCode) OR (ISNULL(@DriverCode,0)=0))\r\n\tAND ((d.IsActive = @IsActive) OR (@IsActive IS NULL))\r\n\tAND \t \r\n\t(\r\n\t\t\t(d.CreateDate \u003E= @FromCreateDate OR @FromCreateDate IS NULL ) \r\n\t\tAND (d.CreateDate \u003C= @ToCreateDate OR @ToCreateDate IS NULL)\r\n\t)\r\n\tAND (CONCAT(d.FirstName,\u0027 \u0027,d.LastName) like \u0027%\u0027\u002B@DriverName\u002B\u0027%\u0027 OR @DriverName=\u0027\u0027) \r\n\r\n\tAND ISNULL(@CityId,0) = 0\r\n\tAND ISNULL(@PolygonId,0) = 0\r\n\tAND ISNULL(@VehicleTypeId,0) = 0\r\n\tAND ISNULL(@PlateNumber,\u0027\u0027) = \u0027\u0027\r\n\tUNION ALL\r\n\tSELECT \r\n\t\tISNULL(f.Id,0)\t\t\t\t\t\t\t\tFleetId\r\n\t\t,d.Id\t\t\t\t\t\t\t\t\t\tId\r\n\t\t,d.CustomerId\r\n\t\t,CONCAT(d.FirstName,\u0027 \u0027,d.LastName)\t\t\tName\r\n\t\t,d.FirstName\t\t\t\t\t\t\t\tFirstName\r\n\t\t,d.LastName\t\t\t\t\t\t\t\t\tLastName\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tPhone\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tAddress\r\n\t\t\t\t\t\r\n\t\t,CONCAT(\u00270\u0027,CAST(d.Mobile AS VARCHAR(11)))\tMobile\r\n\t\t,RIGHT(\u0027000\u0027 \u002B CAST(d.Code AS NVARCHAR(10)) , 10) AS\t\tCode\r\n\t\t,ISNULL(p.CityId,0)\t\t\t\t\t\t\tCityId\r\n\t\t,CAST(0 AS TINYINT)\t\t\t\t\t\t\tProvinceId\r\n\t\t,NULL\t\t\t\t\t\t\t\t\t\tCityName\r\n\t\t,d.IsActive\r\n\t\t,d.CreateDatePersian--FORMAT(d.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027)\tCreateDatePersianStr \r\n\t\t,f.DeliveryServiceProviderId\r\n\tFROM dp.Driver(NOLOCK) d\r\n\tINNER JOIN dp.Fleet(NOLOCK) f\t\t\t\t\t\t\t\t\r\n\t\tON f.DriverId = d.Id\t\r\n\t\tAND f.IsActive = 1\r\n\tINNER JOIN #DeliveryServiceProviderID dps\r\n\t\tON f.DeliveryServiceProviderId = dps.Id\r\n\tLEFT JOIN dp.PolygonFleet(NOLOCK) pf\t\t\t\t\t\t\r\n\t\tON pf.FleetId = f.Id\t\t\r\n\t\tAND pf.IsActive = 1\r\n\tLEFT JOIN dp.Polygon(NOLOCK) p\t\t\t\t\t\t\t\t\r\n\t\tON p.id = pf.PolygonId\t\r\n\t\tAND p.IsActive = 1\r\n\tLEFT JOIN dp.Vehicle(NOLOCK) v\t\t\t\t\t\t\t\t\r\n\t\tON v.Id = f.VehicleId\r\n\tWHERE \t\r\n\t\t((d.Mobile=@DriverMobile) OR (ISNULL(@DriverMobile,0)=0))\r\n\tAND ((d.Code=@DriverCode) OR (ISNULL(@DriverCode,0)=0))\r\n\tAND ((d.IsActive=@IsActive) OR (@IsActive IS NULL))\r\n\tAND \r\n\t(\r\n\t\t\t(d.CreateDate \u003E= @FromCreateDate OR @FromCreateDate IS NULL ) \r\n\t\tAND (d.CreateDate \u003C= @ToCreateDate OR @ToCreateDate IS NULL)\r\n\t)\r\n\tAND (CONCAT(d.FirstName,\u0027 \u0027,d.LastName) LIKE \u0027%\u0027\u002B@DriverName\u002B\u0027%\u0027 OR @DriverName=\u0027\u0027) -- ((Contains(Name,@DriverName))OR (Contains(d.LastName,@DriverName))  OR(@DriverName=\u0027\u0022**\u0022\u0027)) \r\n\r\n\tAND ((p.CityId = @CityId) OR (ISNULL(@CityId,0) = 0))\r\n\tAND ((p.Id = @PolygonId) OR (ISNULL(@PolygonId,0) = 0))\r\n\tAND ((v.VehicleTypeId = @VehicleTypeId) OR (ISNULL(@VehicleTypeId,0) = 0))\r\n\tAND ((v.PlateNumber = @PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027) = \u0027\u0027))\r\n\r\n\tSET @TotalCount = @@ROWCOUNT\r\n\r\n\tCREATE INDEX IX_#Final ON #Final\r\n\t(\r\n\t\tID DESC\r\n\t)\r\n\r\n\tDROP TABLE IF EXISTS #Output\r\n\tSELECT\r\n\t\t* \r\n\tINTO #Output\r\n\tFROM #Final\r\n\tORDER BY Id DESC\r\n\tOFFSET (@pageIndex * @pageSize) ROWS \r\n\tFETCH NEXT @pageSize ROWS ONLY\r\n\r\n\tCREATE INDEX IX_#Output ON #Output\r\n\t(\r\n\t\tID ASC,\r\n\t\tFleetID ASC\r\n\t)\r\n\r\n\t;WITH CTE_PolygonId_Active AS\r\n\t(\r\n\t\tSELECT DISTINCT p.Id AS PolygonId , p.Title AS PolygonTitle, f.DriverId\r\n\t\tFROM #Output c\r\n\t\tINNER JOIN dp.fleet(NOLOCK) f ON c.ID = f.DriverId\r\n\t\tINNER JOIN dp.PolygonFleet(NOLOCK) pf ON f.Id=pf.fleetId  \r\n\t\tINNER JOIN dp.Polygon(NOLOCK) p ON p.Id=pf.PolygonId\r\n\t\tWHERE pf.IsActive=1\r\n\t\tAND f.IsActive=1\r\n\t),CTE_PolygonId_NotActive AS\r\n\t(\r\n\t\tSELECT PolygonId , PolygonTitle , DriverId\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT DISTINCT p.Id AS PolygonId , p.Title AS PolygonTitle , f.DriverId , ROW_NUMBER() OVER ( PARTITION BY f.DriverId ORDER BY pf.Id DESC ) RowNum\r\n\t\t\tFROM #Output c\r\n\t\t\tINNER JOIN dp.fleet(NOLOCK) f ON c.ID = f.DriverId\r\n\t\t\tINNER JOIN dp.PolygonFleet(NOLOCK) pf ON f.Id=pf.fleetId  \r\n\t\t\tINNER JOIN dp.Polygon(NOLOCK) p ON p.Id=pf.PolygonId\r\n\t\t) SQ \r\n\t\tWHERE SQ.RowNum = 1\r\n\r\n\t), CTE_Vehicle_IsActive AS\r\n\t(\r\n\r\n\t\tSELECT DISTINCT v2.VehicleTypeId , v2.PlateNumber , f2.DriverId\r\n\t\tFROM #Output c\r\n\t\tINNER JOIN dp.fleet(NOLOCK) f2 ON c.ID = f2.DriverId\r\n\t\tINNER JOIN dp.Vehicle(NOLOCK) v2 ON v2.id=f2.VehicleId\r\n\t\tWHERE f2.IsActive=1\r\n\t\tAND ((v2.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\tAND ((v2.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t),CTE_Vehicle_NotActive AS\r\n\t(\r\n\t\tSELECT VehicleTypeId, PlateNumber ,DriverId\r\n\t\tFROM \r\n\t\t(\r\n\t\t\tSELECT DISTINCT v2.VehicleTypeId, v2.PlateNumber ,f2.DriverId, ROW_NUMBER() OVER ( PARTITION BY f2.DriverId ORDER BY F2.Id DESC ) RowNum\r\n\t\t\tFROM #Output c\r\n\t\t\tINNER JOIN dp.fleet(NOLOCK) f2 ON c.ID = f2.DriverId\r\n\t\t\tINNER JOIN dp.Vehicle(NOLOCK) v2 ON v2.id=f2.VehicleId\r\n\t\t\tAND ((v2.VehicleTypeId=@VehicleTypeId) OR (ISNULL(@VehicleTypeId,0)=0))\r\n\t\t\tAND ((v2.PlateNumber=@PlateNumber) OR (ISNULL(@PlateNumber,\u0027\u0027)=\u0027\u0027))\r\n\t\t) SQ\r\n\t\tWHERE SQ.RowNum = 1\r\n\t), CTE_WorkingDaysCount AS\r\n\t(\r\n\t\tSELECT c.FleetId , COUNT(DISTINCT fs.WeekDayId) WorkingDaysCount\r\n\t\tFROM #Output c \r\n\t\tINNER JOIN dp.FleetShift(NOLOCK) fs\tON c.FleetId = fs.FleetId AND fs.IsDeleted=0\r\n\t\tGroup By c.FleetId\r\n\t)\r\n\r\n\tSELECT \r\n\t\tc.FleetId\t\t\t\t\t,\r\n\t\tc.Id\t\t\t\t\t\t,\r\n\t\tc.CustomerId\t\t\t\t,\r\n\t\tc.Name\t\t\t\t\t\t,\r\n\t\tc.FirstName\t\t\t\t\t,\r\n\t\tc.LastName\t\t\t\t\t,\r\n\t\tc.Phone\t\t\t\t\t\t,\r\n\t\tc.Address\t\t\t\t\t,\r\n\t\tc.Mobile\t\t\t\t\t,\r\n\t\tc.Code\t\t\t\t\t\t,\r\n\t\tc.CityId\t\t\t\t\t,\r\n\t\tc.ProvinceId\t\t\t\t,\r\n\t\tc.CityName\t\t\t\t\t,\r\n\t\tISNULL(ISNULL(pa.PolygonId,pna.PolygonId),0) PolygonId ,\r\n\t\tISNULL(pa.PolygonTitle,pna.PolygonTitle) PolygonTitle ,\r\n\t\tISNULL(ISNULL(va.VehicleTypeId,vna.VehicleTypeId),0) VehicleTypeId ,\r\n\t\tISNULL(va.PlateNumber,vna.PlateNumber) PlateNumber ,\r\n\t\tc.IsActive\t\t\t\t\t,\r\n\t\tFORMAT(c.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersianStr\t,\r\n\t\tISNULL(wdc.WorkingDaysCount,0) WorkingDaysCount\t,\r\n\t\tJSON_QUERY((\r\n\t\t--SELECT WeekDayId,\r\n\t\t\t\tSELECT\t\r\n\t\t\t\t\t\t--isc.Id,\r\n\t\t\t\t\t\tfs.Id fleetShiftId,\r\n\t\t\t\t\t\tShiftConfigurationId,\r\n\t\t\t\t\t\tisc.startTime,\r\n\t\t\t\t\t\tisc.endTime,\r\n\t\t\t\t\t\tWeekDayId--\r\n\t\t\t\tFROM dp.ShiftConfiguration(NOLOCK) isc\r\n\t\t\t\tINNER JOIN dp.FleetShift(NOLOCK) fs ON c.FleetId=fs.FleetId AND fs.IsDeleted=0\r\n\t\t\t\tWHERE isc.id=fs.ShiftConfigurationId\r\n\t\t\t\tAND fs.FleetId = c.FleetId\r\n\t\t\t\t--isc.id=fs.ShiftConfigurationId\r\n\t\t\t\tFOR JSON PATH\r\n\t\t\t\t--))Shifts\r\n\t\t\t\t\t\t\t\r\n\t\t--FROM dp.FleetShift fs\r\n\t\t--WHERE fs.FleetId=f.Id\r\n\t\t--AND fs.IsDeleted=0\r\n\t\t--FOR JSON PATH\r\n\t\t))\t\t\t\t\t\t\t\t\t\tShiftConfigurationsJSON,\r\n\t\tc.DeliveryServiceProviderId\r\n\r\n\tFROM #Output c\r\n\tLEFT JOIN CTE_PolygonId_Active pa\r\n\t\tON c.ID = pa.DriverId AND c.IsActive = 1\r\n\tLEFT JOIN CTE_PolygonId_NotActive pna\r\n\t\tON c.ID = pna.DriverId AND c.IsActive = 0\r\n\r\n\tLEFT JOIN CTE_Vehicle_IsActive va\r\n\t\tON c.ID = va.DriverId AND c.IsActive = 1\r\n\tLEFT JOIN CTE_Vehicle_NotActive vna\r\n\t\tON c.ID = vna.DriverId AND c.IsActive = 0\r\n\r\n\tLEFT JOIN CTE_WorkingDaysCount wdc\r\n\t\tON c.FleetId = wdc.FleetId\r\n\r\n\t\t\r\n\t"},{"Name":"Get_Fleet_ShiftAndPolygon_ByFleetId","Schema":"dbo","Definition":"/*\r\n\tDECLARE @Result NVARCHAR(MAX)\r\n\tEXEC dbo.Get_Fleet_ShiftAndPolygon_ByFleetId @FleetId = 4420 , @Result = @Result OUTPUT\r\n\tSELECT @Result \r\n*/\r\n\r\nCREATE   PROC [dbo].[Get_Fleet_ShiftAndPolygon_ByFleetId] \r\n(\r\n\t@FleetId INT,\r\n\t@Result NVARCHAR(MAX) OUTPUT\r\n)\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\n\r\n; WITH CTE_Fleet AS\r\n(\r\n\tSELECT \r\n\t\tpf.FleetId,\r\n\t\tTRIM(d.FirstName) \u002B \u0027 \u0027 \u002B TRIM(d.LastName) AS DriverName,\r\n\t\tpf.PolygonId,\r\n\t\tp.Title AS PolygonTitle\r\n\tFROM CS_DriverManagement.DM.PolygonFleet pf (NOLOCK)\r\n\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\tON pf.PolygonId = p.Id\t\t\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK)\r\n\t\tON pf.FleetId = f.ID\r\n\tINNER JOIN CS_DriverManagement.DM.Driver d (NOLOCK)\r\n\t\tON f.DriverId = d.Id\r\n\tWHERE \r\n\t\t\tpf.FleetId = @FleetId\r\n\t\tAND pf.IsActive = 1\r\n), CTE_Shift AS\r\n(\r\n\tSELECT \r\n\t\tfs.WeekDayId,\r\n\t\twd.Title AS WeekDayTitle,\r\n\t\tfs.ID AS FleetShiftId,\r\n\t\tfs.ShiftConfigurationId,\r\n\t\tsc.StartTime,\r\n\t\tsc.EndTime\r\n\tFROM CS_DriverManagement.DM.FleetShift fs (NOLOCK)\r\n\tINNER JOIN CS_DriverManagement.DM.ShiftConfiguration sc (NOLOCK)\r\n\t\tON fs.ShiftConfigurationId = sc.ID\r\n\tINNER JOIN CS_DriverManagement.DM.WeekDay wd\r\n\t\tON fs.WeekDayId = wd.Id\r\n\tWHERE fs.FleetId = @FleetId\r\n\tAND fs.IsDeleted = 0\r\n\tAND sc.IsActive = 1\r\n)\r\nSELECT @Result = \r\n(\r\n\tSELECT DISTINCT\r\n\t\tf.FleetId,\r\n\t\tf.DriverName,\r\n\t\tf.PolygonId,\r\n\t\tf.PolygonTitle,\r\n\t\t(\r\n\t\t\tSELECT DISTINCT\r\n\t\t\t\ts.WeekDayId,\r\n\t\t\t\ts.WeekDayTitle,\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\t\tss.FleetShiftId,\r\n\t\t\t\t\t\tss.ShiftConfigurationId,\r\n\t\t\t\t\t\tss.StartTime,\r\n\t\t\t\t\t\tss.EndTime\r\n\t\t\t\t\tFROM CTE_Shift ss\r\n\t\t\t\t\tWHERE\r\n\t\t\t\t\t\t\ts.WeekDayId = ss.WeekDayId\r\n\t\t\t\t\tORDER BY ss.StartTime\r\n\t\t\t\t\tFOR JSON PATH\r\n\t\t\t\t) ShiftConfiguration\r\n\t\t\tFROM CTE_Shift s\r\n\t\t\tORDER BY s.WeekDayId\r\n\t\t\tFOR JSON PATH\r\n\t\t)FleetShifts\r\n\tFROM CTE_Fleet f\r\n\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n)\r\n\r\nEND\r\n\r\n"},{"Name":"Get_FleetPerformanceReview_For_Driver","Schema":"dbo","Definition":"\r\nCREATE         PROCEDURE [dbo].[Get_FleetPerformanceReview_For_Driver]\r\n--declare\r\n\t@VendorParcelCode\t\t\tVARCHAR(32) = NULL\t,\r\n\t@FleetId\t\t\t\t\tINT = NULL,\r\n\t@StartRangeTime\t\t\t\tBIGINT = NULL,\r\n\t@EndRangeTime\t\t\t\tBIGINT = NULL,\r\n\r\n\t@Result\t\t\t\t\t\tNVARCHAR(MAX) = NULL OUTPUT,\r\n\r\n\t@TotalCount\t\t\t\t\tINT OUTPUT,\t\r\n\t@CountOfOnTimeDelivery\t\tINT OUTPUT,\t\r\n\t@CountOfDelayedDelivery\t\tINT OUTPUT,\t\r\n\t@CountOfReturnedDelivery\tINT OUTPUT,\t\r\n\t@CountOfCanceledRequest\t\tINT OUTPUT\r\nAS\r\n\tIF @FleetId IS NULL\r\n\t\tRETURN\r\n\r\n\tIF((ISNULL(@StartRangeTime,0) =0 OR ISNULL(@EndRangeTime,0) =0))  AND (ISNULL(@VendorParcelCode,\u0027\u0027)=\u0027\u0027)\r\n\tBEGIN\r\n\t\t\tSET @Result=-1 \r\n\t\t\tRETURN\r\n\tEND\r\n\r\n\tIF(ISNULL(@StartRangeTime,0) \u003C\u003E0 AND ISNULL(@EndRangeTime,0) \u003C\u003E0) \r\n\t\tIF dbo.FN_DateDiff(@StartRangeTime,@EndRangeTime)\u003E31 AND (ISNULL(@VendorParcelCode,\u0027\u0027)=\u0027\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @Result=-1 \r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\tSELECT ID\r\n\tINTO #ShipmentDestinationPointStatusID\r\n\tFROM [CS_Dispatcher].[DP].[ShipmentDestinationPointStatus] WHERE ID \u003C\u003E 35\r\n\t/*\r\n\tSELECT DISTINCT\r\n\t\tsh.Id ShipmentId\r\n\tINTO #Shipment\r\n\tFROM dp.Shipment sh WITH(NOLOCK)\r\n\tINNER JOIN dp.ShipmentDestinationPoint sdp WITH(NOLOCK)\t\t\r\n\t\tON sh.ID = sdp.ShipmentId\r\n\t\tAND sdp.OperationTypeId IN (10,20,25)\r\n\tINNER JOIN #ShipmentDestinationPointStatusID sdpID\r\n\t\tON sdp.ShipmentDestinationPointStatusId = sdpID.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK) \r\n\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdpdr.CreateDate \u003E= FORMAT(DATEADD(DAY,-1,FORMAT(@StartRangeTime,\u0027####-##-## ##:##:##\\.###\u0027)),\u0027yyyyMMddHHmmssfff\u0027)\r\n\tINNER JOIN dp.DispatchRequest dr WITH(NOLOCK)\r\n\t\tON sdpdr.DispatchRequestId = dr.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointStatus sdps (NOLOCK)\t\t\t\r\n\t\tON sdp.ShipmentDestinationPointStatusId=sdps.Id\r\n\tWHERE sh.ShipmentStatusId IN (45,50)\r\n\tAND sh.FleetId = @FleetId\r\n\tAND (sh.CreateDate \u003E= FORMAT(DATEADD(DAY,-1,FORMAT(@StartRangeTime,\u0027####-##-## ##:##:##\\.###\u0027)),\u0027yyyyMMddHHmmssfff\u0027))\r\n\tAND (ISNULL(@VendorParcelCode,\u0027\u0027) = \u0027\u0027)\r\n\tAND (dr.DeliveryStartTime \u003E= @StartRangeTime OR ISNULL(@StartRangeTime,0) \u003C\u003E 0)\r\n\tAND (dr.DeliveryStartTime \u003C= @EndRangeTime OR ISNULL(@EndRangeTime,0) \u003C\u003E 0)\r\n\tAND  dr.CourierRequestTypeId NOT IN ( 25,51 )\r\n\tUNION ALL\r\n\tSELECT DISTINCT\r\n\t\tsh.Id\r\n\tFROM dp.Shipment sh WITH(NOLOCK)\r\n\tINNER JOIN dp.ShipmentDestinationPoint sdp WITH(NOLOCK)\t\t\r\n\t\tON sh.ID = sdp.ShipmentId\r\n\t\tAND sdp.OperationTypeId IN (10,20,25)\r\n\tINNER JOIN #ShipmentDestinationPointStatusID sdpID\r\n\t\tON sdp.ShipmentDestinationPointStatusId = sdpID.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK) \r\n\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\tINNER JOIN dp.DispatchRequest dr WITH(NOLOCK)\r\n\t\tON sdpdr.DispatchRequestId = dr.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointStatus sdps (NOLOCK)\t\t\t\r\n\t\tON sdp.ShipmentDestinationPointStatusId=sdps.Id\r\n\tWHERE sh.ShipmentStatusId IN (45,50)\r\n\tAND sh.FleetId = @FleetId\r\n\tAND dr.VendorParcelCode = @VendorParcelCode\r\n\tAND (dr.DeliveryStartTime \u003E= @StartRangeTime OR ISNULL(@StartRangeTime,0) \u003C\u003E 0)\r\n\tAND (dr.DeliveryStartTime \u003C= @EndRangeTime OR ISNULL(@EndRangeTime,0) \u003C\u003E 0)\r\n\tAND  dr.CourierRequestTypeId NOT IN ( 25,51 )\r\n\tAND (ISNULL(@VendorParcelCode,\u0027\u0027) \u003C\u003E \u0027\u0027)\r\n\t*/\r\n\r\n\tDECLARE @Sql NVARCHAR(MAX) = \u0027\u0027\r\n\r\n\tSET @Sql \u002B=\r\n\t\u0027 SELECT DISTINCT\r\n\t\tdr.Id,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\tsdps.Title ShipmentDestinationPointStatusTitle,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\tNULL CourierRequestTypeTitle,\r\n\t\tdr.IsExclusiveDelivery,\r\n\t\tdr.IsNightly,\r\n\t\tdr.ClientAddress,\r\n\t\tsdp.UpdateDatePersian,\r\n\t\tdr.DeliveryDeadLineTimePersian\r\n\tINTO #CTE\r\n\tFROM dp.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK) \r\n\t\tON dr.id = sdpdr.DispatchRequestId\r\n\tINNER JOIN dp.ShipmentDestinationPoint sdp WITH(NOLOCK)\t\t\t\t\t\r\n\t\tON sdp.id=sdpdr.ShipmentDestinationPointId\r\n\tINNER JOIN #ShipmentDestinationPointStatusID sdpID\r\n\t\tON sdp.ShipmentDestinationPointStatusId = sdpID.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointStatus sdps (NOLOCK)\t\t\t\r\n\t\tON sdp.ShipmentDestinationPointStatusId=sdps.Id\r\n\tINNER JOIN dp.Shipment s (NOLOCK)\t\t\t\t\t\t\t\t\t\r\n\t\tON s.Id=sdp.ShipmentId\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK)\t\t\t\t\t\t\t\t\t\t\r\n\t\tON f.Id=s.FleetId\r\n\tWHERE dr.CourierRequestTypeId NOT IN ( 25,51 )\r\n\tAND (s.ShipmentStatusId IN (45,50))\r\n\tAND sdp.OperationTypeId IN (10,20,25)\u0027\r\n\r\n\tIF @FleetId IS NOT NULL AND @FleetId \u003C\u003E 0\r\n\t\tSET @Sql \u002B= \u0027 AND f.Id = \u0027\u002BCAST(@FleetId AS VARCHAR(MAX))\r\n\r\n\tIF @StartRangeTime IS NOT NULL AND @StartRangeTime \u003C\u003E 0 AND @EndRangeTime IS NOT NULL AND @EndRangeTime \u003C\u003E 0\r\n\tBEGIN\r\n\t\tSET @Sql \u002B=\r\n\t\t\u0027 AND s.CreateDate \u003E= \u0027\u002BCAST(FORMAT(DATEADD(DAY,-1,FORMAT(@StartRangeTime,\u0027####-##-## ##:##:##\\.###\u0027)),\u0027yyyyMMddHHmmssfff\u0027) AS VARCHAR(MAX))\r\n\t\t--SET @Sql \u002B=\r\n\t\t--\u0027 AND sdpdr.CreateDate \u003E= \u0027\u002BCAST(FORMAT(DATEADD(DAY,-1,FORMAT(@StartRangeTime,\u0027####-##-## ##:##:##\\.###\u0027)),\u0027yyyyMMddHHmmssfff\u0027) AS VARCHAR(MAX))\r\n\tEND\r\n\r\n\tIF @VendorParcelCode IS NOT NULL AND @VendorParcelCode \u003C\u003E \u0027\u0027\r\n\t\tSET @Sql \u002B=\r\n\t\t\u0027 AND dr.VendorParcelCode = \u0027\u0027\u0027\u002B@VendorParcelCode\u002B\u0027\u0027\u0027\u0027\r\n\r\n\tIF @StartRangeTime IS NOT NULL AND @StartRangeTime \u003C\u003E 0 AND @EndRangeTime IS NOT NULL AND @EndRangeTime \u003C\u003E 0\r\n\tBEGIN\r\n\t\tSET @Sql \u002B=\r\n\t\t\u0027 AND dr.DeliveryStartTime BETWEEN \u0027\u002BCAST(@StartRangeTime AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@EndRangeTime AS VARCHAR(MAX))\r\n\r\n\t\tSET @Sql \u002B=\r\n\t\t\u0027 AND sdpdr.CreateDate \u003E= \u0027\u002BFORMAT(DATEADD(DAY,-1,FORMAT(@StartRangeTime,\u0027####-##-## ##:##:##\\.###\u0027)),\u0027yyyyMMddHHmmssfff\u0027)\r\n\r\n\t\tSET @Sql \u002B=\r\n\t\t\u0027 AND s.CreateDate \u003E= \u0027\u002BFORMAT(DATEADD(DAY,-1,FORMAT(@StartRangeTime,\u0027####-##-## ##:##:##\\.###\u0027)),\u0027yyyyMMddHHmmssfff\u0027)\r\n\r\n\tEND\r\n\t--SET @Sql \u002B= \u0027 OPTION (USE HINT (\u0027\u0027FORCE_LEGACY_CARDINALITY_ESTIMATION\u0027\u0027),OPTIMIZE FOR (@FleetId=37069)) \u0027\r\n\r\nSET @Sql \u002B=\r\n\t\u0027 SELECT \r\n\t\t@TotalCount = COUNT(Id) ,\r\n\t\t@CountOfOnTimeDelivery = \r\n\t\tCount\r\n\t\t(\r\n\t\t\tCASE WHEN SQ.ShipmentDestinationPointStatusId=20/*Met*/\r\n\t\t\tAND SQ.CourierRequestTypeId IN (5,10,15,40,45,50,55,60,65,70) AND SQ.DispatchRequestStatusId \u003C\u003E 80 THEN ID ELSE NULL END \r\n\t\t),\r\n\t\t@CountOfDelayedDelivery = \r\n\t\tCount\r\n\t\t(\r\n\t\t\tCASE WHEN SQ.ShipmentDestinationPointStatusId=25/*Met With Delay*/\r\n\t\t\tAND Sq.CourierRequestTypeId IN (5,10,15,40,45,50,55,60,65,70) AND SQ.DispatchRequestStatusId \u003C\u003E 80 THEN ID ELSE NULL END \r\n\t\t),\r\n\t\t@CountOfReturnedDelivery = \r\n\t\tCount\r\n\t\t(\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t(\r\n\t\t\t\t\tSQ.ShipmentDestinationPointStatusId IN (20/*Met*/,25/*Met With Delay*/)\r\n\t\t\t\t\tAND sq.CourierRequestTypeId IN (26,\r\n\t\t\t\t\t\t\t\t\t\t\t30/*Scheduled Single Return*/,\r\n\t\t\t\t\t\t\t\t\t\t\t35/*Scheduled Multiple Return*/)\r\n\t\t\t\t)\r\n\t\t\t\tOR (SQ.DispatchRequestStatusId = 80)\r\n\t\t\t\tTHEN ID ELSE NULL END \r\n\t\t),\r\n\t\t@CountOfCanceledRequest = \r\n\t\tCount\r\n\t\t(\r\n\t\t\tCASE WHEN SQ.ShipmentDestinationPointStatusId IN (30/*Aborted*/) OR ( ShipmentDestinationPointStatusId = 40 AND DispatchRequestStatusId \u003C\u003E 80 ) THEN ID ELSE NULL END \r\n\t\t)\r\n\tFROM #CTE SQ\r\n\r\n\tSELECT \r\n\t\t\t\tId,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN (ShipmentDestinationPointStatusId IN (20/*Met*/,25/*Met With Delay*/) AND CourierRequestTypeId IN ( 26,30,35 )) OR DispatchRequestStatusId = 80 \r\n\t\t\t\t\t\tTHEN CAST(200 AS TINYINT)\r\n\t\t\t\t\tWHEN ShipmentDestinationPointStatusId = 40 AND DispatchRequestStatusId \u003C\u003E 80 \r\n\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCAST(30 AS TINYINT)\r\n\t\t\t\t\tELSE \r\n\t\t\t\t\t\tShipmentDestinationPointStatusId \r\n\t\t\t\tEND ShipmentDestinationPointStatusId,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN (ShipmentDestinationPointStatusId IN (20/*Met*/,25/*Met With Delay*/) AND CourierRequestTypeId IN ( 26,30,35 )) OR DispatchRequestStatusId = 80 \r\n\t\t\t\t\t\tTHEN N\u0027\u0027\u0645\u0631\u062C\u0648\u0639\u06CC\u0027\u0027 \r\n\t\t\t\t\tWHEN ShipmentDestinationPointStatusId = 40 AND DispatchRequestStatusId \u003C\u003E 80 \r\n\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tN\u0027\u0027\u0644\u063A\u0648 \u0634\u062F\u0027\u0027\r\n\t\t\t\t\tELSE \r\n\t\t\t\t\t\tShipmentDestinationPointStatusTitle \r\n\t\t\t\tEND ShipmentDestinationPointStatusTitle,\r\n\t\t\t\tParcelReferenceCode,\r\n\t\t\t\tVendorParcelCode,\r\n\t\t\t\tCourierRequestTypeId,\r\n\t\t\t\tNULL/*crt.Title*/ CourierRequestTypeTitle,\r\n\t\t\t\tIsExclusiveDelivery,\r\n\t\t\t\tIsNightly,\r\n\t\t\t\tClientAddress,\r\n\t\t\t\tFORMAT(ISNULL(UpdateDatePersian,\u0027\u0027\u0027\u0027),\u0027\u0027####/##/## ##:##:##\\.###\u0027\u0027) ShipmentDestinationPointUpdateDatePersianStr,\r\n\t\t\t\tFORMAT(ISNULL(DeliveryDeadLineTimePersian,\u0027\u0027\u0027\u0027),\u0027\u0027####/##/## ##:##:##\\.###\u0027\u0027) DeliveryDeadLineTimePersian\r\n\t\t\tFROM #CTE\r\n\r\n\t \r\n\tSET @TotalCount\t\t\t\t\t = ISNULL(@TotalCount,0)\r\n\tSET @CountOfOnTimeDelivery\t\t = ISNULL(@CountOfOnTimeDelivery,0)\r\n\tSET @CountOfDelayedDelivery\t\t = ISNULL(@CountOfDelayedDelivery,0)\r\n\tSET @CountOfReturnedDelivery\t = ISNULL(@CountOfReturnedDelivery,0)\r\n\tSET @CountOfCanceledRequest\t\t = ISNULL(@CountOfCanceledRequest,0)\u0027\r\n\r\n\r\n\tDECLARE @Param NVARCHAR(MAX)\r\n\tSET @Param = \r\n\t\u0027 @FleetId INT = NULL,\r\n\t@TotalCount INT OUTPUT,\r\n\t@CountOfOnTimeDelivery INT OUTPUT,\r\n\t@CountOfDelayedDelivery INT OUTPUT,\r\n\t@CountOfReturnedDelivery INT OUTPUT,\r\n\t@CountOfCanceledRequest INT OUTPUT\u0027\r\n\r\n\tSELECT @Sql\r\n\tEXECUTE sys.sp_executeSQL\r\n\t\t@Sql,\r\n\t\t@Param,\r\n\t\t\t@FleetId = @FleetId,\r\n\t\t\t@TotalCount = @TotalCount OUTPUT,\r\n\t\t\t@CountOfOnTimeDelivery = @CountOfOnTimeDelivery OUTPUT,\r\n\t\t\t@CountOfDelayedDelivery = @CountOfDelayedDelivery OUTPUT,\r\n\t\t\t@CountOfReturnedDelivery = @CountOfReturnedDelivery OUTPUT,\r\n\t\t\t@CountOfCanceledRequest = @CountOfCanceledRequest OUTPUT\r\n\r\n\tSET @TotalCount\t\t\t\t\t = ISNULL(@TotalCount,0)\r\n\tSET @CountOfOnTimeDelivery\t\t = ISNULL(@CountOfOnTimeDelivery,0)\r\n\tSET @CountOfDelayedDelivery\t\t = ISNULL(@CountOfDelayedDelivery,0)\r\n\tSET @CountOfReturnedDelivery\t = ISNULL(@CountOfReturnedDelivery,0)\r\n\tSET @CountOfCanceledRequest\t\t = ISNULL(@CountOfCanceledRequest,0)"},{"Name":"Get_FleetPerformanceReview_For_Driver_BACKUP","Schema":"dbo","Definition":"\r\nCREATE       PROCEDURE [dbo].[Get_FleetPerformanceReview_For_Driver_BACKUP]\r\n--declare\r\n\t@VendorParcelCode\t\t\tVARCHAR(32) = NULL\t,\r\n\t@FleetId\t\t\t\t\tINT = NULL,\r\n\t@StartRangeTime\t\t\t\tBIGINT = NULL,\r\n\t@EndRangeTime\t\t\t\tBIGINT = NULL,\r\n\r\n\t@Result\t\t\t\t\t\tNVARCHAR(MAX) = NULL OUTPUT,\r\n\r\n\t@TotalCount\t\t\t\t\tINT OUTPUT,\t\r\n\t@CountOfOnTimeDelivery\t\tINT OUTPUT,\t\r\n\t@CountOfDelayedDelivery\t\tINT OUTPUT,\t\r\n\t@CountOfReturnedDelivery\tINT OUTPUT,\t\r\n\t@CountOfCanceledRequest\t\tINT OUTPUT\r\nAS\r\n\tIF @FleetId IS NULL\r\n\t\tRETURN\r\n\r\n\tIF((ISNULL(@StartRangeTime,0) =0 OR ISNULL(@EndRangeTime,0) =0))  AND (ISNULL(@VendorParcelCode,\u0027\u0027)=\u0027\u0027)\r\n\tBEGIN\r\n\t\t\tSET @Result=-1 \r\n\t\t\tRETURN\r\n\tEND\r\n\r\n\tIF(ISNULL(@StartRangeTime,0) \u003C\u003E0 AND ISNULL(@EndRangeTime,0) \u003C\u003E0) \r\n\t\tIF dbo.FN_DateDiff(@StartRangeTime,@EndRangeTime)\u003E31 AND (ISNULL(@VendorParcelCode,\u0027\u0027)=\u0027\u0027)\r\n\t\tBEGIN\r\n\t\t\tSET @Result=-1 \r\n\t\t\tRETURN\r\n\t\tEND\r\n\t\tPRINT \u0027IM HERE\u0027\r\n\tSELECT ID\r\n\tINTO #ShipmentDestinationPointStatusID\r\n\tFROM [CS_Dispatcher].[DP].[ShipmentDestinationPointStatus] WHERE ID \u003C\u003E 35\r\n\r\n\tSELECT DISTINCT\r\n\t\tsh.Id ShipmentId\r\n\tINTO #Shipment\r\n\tFROM dp.Shipment sh WITH(NOLOCK)\r\n\tINNER JOIN dp.ShipmentDestinationPoint sdp WITH(NOLOCK)\t\t\r\n\t\tON sh.ID = sdp.ShipmentId\r\n\t\tAND sdp.OperationTypeId IN (10,20,25)\r\n\tINNER JOIN #ShipmentDestinationPointStatusID sdpID\r\n\t\tON sdp.ShipmentDestinationPointStatusId = sdpID.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK) \r\n\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdpdr.CreateDate \u003E= FORMAT(DATEADD(DAY,-1,FORMAT(@StartRangeTime,\u0027####-##-## ##:##:##\\.###\u0027)),\u0027yyyyMMddHHmmssfff\u0027)\r\n\tINNER JOIN dp.DispatchRequest dr WITH(NOLOCK)\r\n\t\tON sdpdr.DispatchRequestId = dr.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointStatus sdps (NOLOCK)\t\t\t\r\n\t\tON sdp.ShipmentDestinationPointStatusId=sdps.Id\r\n\tWHERE sh.ShipmentStatusId IN (45,50)\r\n\tAND sh.FleetId = @FleetId\r\n\tAND (sh.CreateDate \u003E= FORMAT(DATEADD(DAY,-1,FORMAT(@StartRangeTime,\u0027####-##-## ##:##:##\\.###\u0027)),\u0027yyyyMMddHHmmssfff\u0027))\r\n\tAND (ISNULL(@VendorParcelCode,\u0027\u0027) = \u0027\u0027)\r\n\tAND (dr.DeliveryStartTime \u003E= @StartRangeTime OR ISNULL(@StartRangeTime,0) \u003C\u003E 0)\r\n\tAND (dr.DeliveryStartTime \u003C= @EndRangeTime OR ISNULL(@EndRangeTime,0) \u003C\u003E 0)\r\n\tAND  dr.CourierRequestTypeId NOT IN ( 25,51 )\r\n\tUNION ALL\r\n\tSELECT DISTINCT\r\n\t\tsh.Id\r\n\tFROM dp.Shipment sh WITH(NOLOCK)\r\n\tINNER JOIN dp.ShipmentDestinationPoint sdp WITH(NOLOCK)\t\t\r\n\t\tON sh.ID = sdp.ShipmentId\r\n\t\tAND sdp.OperationTypeId IN (10,20,25)\r\n\tINNER JOIN #ShipmentDestinationPointStatusID sdpID\r\n\t\tON sdp.ShipmentDestinationPointStatusId = sdpID.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK) \r\n\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\tINNER JOIN dp.DispatchRequest dr WITH(NOLOCK)\r\n\t\tON sdpdr.DispatchRequestId = dr.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointStatus sdps (NOLOCK)\t\t\t\r\n\t\tON sdp.ShipmentDestinationPointStatusId=sdps.Id\r\n\tWHERE sh.ShipmentStatusId IN (45,50)\r\n\tAND sh.FleetId = @FleetId\r\n\tAND dr.VendorParcelCode = @VendorParcelCode\r\n\tAND (dr.DeliveryStartTime \u003E= @StartRangeTime OR ISNULL(@StartRangeTime,0) \u003C\u003E 0)\r\n\tAND (dr.DeliveryStartTime \u003C= @EndRangeTime OR ISNULL(@EndRangeTime,0) \u003C\u003E 0)\r\n\tAND  dr.CourierRequestTypeId NOT IN ( 25,51 )\r\n\tAND (ISNULL(@VendorParcelCode,\u0027\u0027) \u003C\u003E \u0027\u0027)\r\n\t\r\n\r\n\tDECLARE @Sql NVARCHAR(MAX) = \u0027\u0027\r\n\r\n\tSET @Sql \u002B=\r\n\t\u0027 SELECT DISTINCT\r\n\t\tdr.Id,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\tsdps.Title ShipmentDestinationPointStatusTitle,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\tNULL CourierRequestTypeTitle,\r\n\t\tdr.IsExclusiveDelivery,\r\n\t\tdr.IsNightly,\r\n\t\tdr.ClientAddress,\r\n\t\tsdp.UpdateDatePersian,\r\n\t\tdr.DeliveryDeadLineTimePersian\r\n\tINTO #CTE\r\n\tFROM dp.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK) \r\n\t\tON dr.id = sdpdr.DispatchRequestId --AND dr.Version = sdpdr.Version\r\n\tINNER JOIN dp.ShipmentDestinationPoint sdp WITH(NOLOCK)\t\t\t\t\t\r\n\t\tON sdp.id=sdpdr.ShipmentDestinationPointId\r\n\tINNER JOIN #ShipmentDestinationPointStatusID sdpID\r\n\t\tON sdp.ShipmentDestinationPointStatusId = sdpID.Id\r\n\tINNER JOIN dp.ShipmentDestinationPointStatus sdps (NOLOCK)\t\t\t\r\n\t\tON sdp.ShipmentDestinationPointStatusId=sdps.Id\r\n\tINNER JOIN dp.Shipment s (NOLOCK)\t\t\t\t\t\t\t\t\t\r\n\t\tON s.Id=sdp.ShipmentId\r\n\tINNER JOIN #Shipment SHID\r\n\t\tON s.ID = SHID.ShipmentId\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK)\t\t\t\t\t\t\t\t\t\t\r\n\t\tON f.Id=s.FleetId\r\n\tWHERE dr.CourierRequestTypeId NOT IN ( 25,51 )\r\n\tAND (s.ShipmentStatusId IN (45,50))\r\n\tAND sdp.OperationTypeId IN (10,20,25)\u0027\r\n\r\n\tIF @FleetId IS NOT NULL AND @FleetId \u003C\u003E 0\r\n\t\tSET @Sql \u002B= \u0027 AND f.Id = \u0027\u002BCAST(@FleetId AS VARCHAR(MAX))\r\n\r\n\tIF @StartRangeTime IS NOT NULL AND @StartRangeTime \u003C\u003E 0 AND @EndRangeTime IS NOT NULL AND @EndRangeTime \u003C\u003E 0\r\n\tBEGIN\r\n\t\tSET @Sql \u002B=\r\n\t\t\u0027 AND s.CreateDate \u003E= \u0027\u002BCAST(FORMAT(DATEADD(DAY,-1,FORMAT(@StartRangeTime,\u0027####-##-## ##:##:##\\.###\u0027)),\u0027yyyyMMddHHmmssfff\u0027) AS VARCHAR(MAX))\r\n\t\t--SET @Sql \u002B=\r\n\t\t--\u0027 AND sdpdr.CreateDate \u003E= \u0027\u002BCAST(FORMAT(DATEADD(DAY,-1,FORMAT(@StartRangeTime,\u0027####-##-## ##:##:##\\.###\u0027)),\u0027yyyyMMddHHmmssfff\u0027) AS VARCHAR(MAX))\r\n\tEND\r\n\r\n\tIF @VendorParcelCode IS NOT NULL AND @VendorParcelCode \u003C\u003E \u0027\u0027\r\n\t\tSET @Sql \u002B=\r\n\t\t\u0027 AND dr.VendorParcelCode = \u0027\u0027\u0027\u002B@VendorParcelCode\u002B\u0027\u0027\u0027\u0027\r\n\r\n\tIF @StartRangeTime IS NOT NULL AND @StartRangeTime \u003C\u003E 0 AND @EndRangeTime IS NOT NULL AND @EndRangeTime \u003C\u003E 0\r\n\t\tSET @Sql \u002B=\r\n\t\t\u0027 AND dr.DeliveryStartTime BETWEEN \u0027\u002BCAST(@StartRangeTime AS VARCHAR(MAX))\u002B\u0027 AND \u0027\u002BCAST(@EndRangeTime AS VARCHAR(MAX))\r\n\t--SET @Sql \u002B= \u0027 OPTION (USE HINT (\u0027\u0027FORCE_LEGACY_CARDINALITY_ESTIMATION\u0027\u0027),OPTIMIZE FOR (@FleetId=37069)) \u0027\r\n\r\nSET @Sql \u002B=\r\n\t\u0027 SELECT \r\n\t\t@TotalCount = COUNT(Id) ,\r\n\t\t@CountOfOnTimeDelivery = \r\n\t\tCount\r\n\t\t(\r\n\t\t\tCASE WHEN SQ.ShipmentDestinationPointStatusId=20/*Met*/\r\n\t\t\tAND SQ.CourierRequestTypeId IN (5,10,15,40,45,50,55,60,65,70) AND SQ.DispatchRequestStatusId \u003C\u003E 80 THEN ID ELSE NULL END \r\n\t\t),\r\n\t\t@CountOfDelayedDelivery = \r\n\t\tCount\r\n\t\t(\r\n\t\t\tCASE WHEN SQ.ShipmentDestinationPointStatusId=25/*Met With Delay*/\r\n\t\t\tAND Sq.CourierRequestTypeId IN (5,10,15,40,45,50,55,60,65,70) AND SQ.DispatchRequestStatusId \u003C\u003E 80 THEN ID ELSE NULL END \r\n\t\t),\r\n\t\t@CountOfReturnedDelivery = \r\n\t\tCount\r\n\t\t(\r\n\t\t\tCASE \r\n\t\t\t\tWHEN \r\n\t\t\t\t(\r\n\t\t\t\t\tSQ.ShipmentDestinationPointStatusId IN (20/*Met*/,25/*Met With Delay*/)\r\n\t\t\t\t\tAND sq.CourierRequestTypeId IN (26,\r\n\t\t\t\t\t\t\t\t\t\t\t30/*Scheduled Single Return*/,\r\n\t\t\t\t\t\t\t\t\t\t\t35/*Scheduled Multiple Return*/)\r\n\t\t\t\t)\r\n\t\t\t\tOR (SQ.DispatchRequestStatusId = 80)\r\n\t\t\t\tTHEN ID ELSE NULL END \r\n\t\t),\r\n\t\t@CountOfCanceledRequest = \r\n\t\tCount\r\n\t\t(\r\n\t\t\tCASE WHEN SQ.ShipmentDestinationPointStatusId IN (30/*Aborted*/) OR ( ShipmentDestinationPointStatusId = 40 AND DispatchRequestStatusId \u003C\u003E 80 ) THEN ID ELSE NULL END \r\n\t\t)\r\n\tFROM #CTE SQ\r\n\r\n\tSELECT \r\n\t\t\t\tId,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN (ShipmentDestinationPointStatusId IN (20/*Met*/,25/*Met With Delay*/) AND CourierRequestTypeId IN ( 26,30,35 )) OR DispatchRequestStatusId = 80 \r\n\t\t\t\t\t\tTHEN CAST(200 AS TINYINT)\r\n\t\t\t\t\tWHEN ShipmentDestinationPointStatusId = 40 AND DispatchRequestStatusId \u003C\u003E 80 \r\n\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tCAST(30 AS TINYINT)\r\n\t\t\t\t\tELSE \r\n\t\t\t\t\t\tShipmentDestinationPointStatusId \r\n\t\t\t\tEND ShipmentDestinationPointStatusId,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN (ShipmentDestinationPointStatusId IN (20/*Met*/,25/*Met With Delay*/) AND CourierRequestTypeId IN ( 26,30,35 )) OR DispatchRequestStatusId = 80 \r\n\t\t\t\t\t\tTHEN N\u0027\u0027\u0645\u0631\u062C\u0648\u0639\u06CC\u0027\u0027 \r\n\t\t\t\t\tWHEN ShipmentDestinationPointStatusId = 40 AND DispatchRequestStatusId \u003C\u003E 80 \r\n\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\tN\u0027\u0027\u0644\u063A\u0648 \u0634\u062F\u0027\u0027\r\n\t\t\t\t\tELSE \r\n\t\t\t\t\t\tShipmentDestinationPointStatusTitle \r\n\t\t\t\tEND ShipmentDestinationPointStatusTitle,\r\n\t\t\t\tParcelReferenceCode,\r\n\t\t\t\tVendorParcelCode,\r\n\t\t\t\tCourierRequestTypeId,\r\n\t\t\t\tNULL/*crt.Title*/ CourierRequestTypeTitle,\r\n\t\t\t\tIsExclusiveDelivery,\r\n\t\t\t\tIsNightly,\r\n\t\t\t\tClientAddress,\r\n\t\t\t\tFORMAT(ISNULL(UpdateDatePersian,\u0027\u0027\u0027\u0027),\u0027\u0027####/##/## ##:##:##\\.###\u0027\u0027) ShipmentDestinationPointUpdateDatePersianStr,\r\n\t\t\t\tFORMAT(ISNULL(DeliveryDeadLineTimePersian,\u0027\u0027\u0027\u0027),\u0027\u0027####/##/## ##:##:##\\.###\u0027\u0027) DeliveryDeadLineTimePersian\r\n\t\t\tFROM #CTE\r\n\r\n\t \r\n\tSET @TotalCount\t\t\t\t\t = ISNULL(@TotalCount,0)\r\n\tSET @CountOfOnTimeDelivery\t\t = ISNULL(@CountOfOnTimeDelivery,0)\r\n\tSET @CountOfDelayedDelivery\t\t = ISNULL(@CountOfDelayedDelivery,0)\r\n\tSET @CountOfReturnedDelivery\t = ISNULL(@CountOfReturnedDelivery,0)\r\n\tSET @CountOfCanceledRequest\t\t = ISNULL(@CountOfCanceledRequest,0)\u0027\r\n\r\n\r\n\tDECLARE @Param NVARCHAR(MAX)\r\n\tSET @Param = \r\n\t\u0027 @FleetId INT = NULL,\r\n\t@TotalCount INT OUTPUT,\r\n\t@CountOfOnTimeDelivery INT OUTPUT,\r\n\t@CountOfDelayedDelivery INT OUTPUT,\r\n\t@CountOfReturnedDelivery INT OUTPUT,\r\n\t@CountOfCanceledRequest INT OUTPUT\u0027\r\n\r\n\tEXECUTE sys.sp_executeSQL\r\n\t\t@Sql,\r\n\t\t@Param,\r\n\t\t\t@FleetId = @FleetId,\r\n\t\t\t@TotalCount = @TotalCount OUTPUT,\r\n\t\t\t@CountOfOnTimeDelivery = @CountOfOnTimeDelivery OUTPUT,\r\n\t\t\t@CountOfDelayedDelivery = @CountOfDelayedDelivery OUTPUT,\r\n\t\t\t@CountOfReturnedDelivery = @CountOfReturnedDelivery OUTPUT,\r\n\t\t\t@CountOfCanceledRequest = @CountOfCanceledRequest OUTPUT\r\n\r\n\tSET @TotalCount\t\t\t\t\t = ISNULL(@TotalCount,0)\r\n\tSET @CountOfOnTimeDelivery\t\t = ISNULL(@CountOfOnTimeDelivery,0)\r\n\tSET @CountOfDelayedDelivery\t\t = ISNULL(@CountOfDelayedDelivery,0)\r\n\tSET @CountOfReturnedDelivery\t = ISNULL(@CountOfReturnedDelivery,0)\r\n\tSET @CountOfCanceledRequest\t\t = ISNULL(@CountOfCanceledRequest,0)"},{"Name":"Get_FleetPreAssignmentState_By_DispatchRequestId","Schema":"dbo","Definition":"-- Stored Procedure\r\n\r\nCREATE      PROCEDURE [dbo].[Get_FleetPreAssignmentState_By_DispatchRequestId]\r\n\t@DispatchRequestId\tBIGINT\r\nWITH RECOMPILE\r\nAS\r\n\r\n\t;WITH CTE AS\r\n\t(\r\n\t\tSELECT\t\r\n\t\t\t\tfas.Id,\r\n\t\t\t\tdr.Id DispatchRequestId,\r\n\t\t\t\tParcelReferenceCode,\r\n\t\t\t\tfas.FleetId,\r\n\t\t\t\tdf.DriverId,\r\n\t\t\t\tdv.VehicleTypeId,\r\n\t\t\t\tfas.ShipmentId,\r\n\t\t\t\tdf.FleetStatusId,\r\n\t\t\t\tfas.FleetLocation,\r\n\t\t\t\tISNULL(fas.TodayDeliveredParcelCount,0) TodayDeliveredParcelCount,\r\n\t\t\t\tfas.ArrivalDurationTime ArrivalDurationTimeSeconds,\r\n\t\t\t\tfas.DistanceMeter,\r\n\t\t\t\tLEFT(fas.CreateDatePersian,12)CreateDatePersian,\r\n\t\t\t\tFORMAT(fas.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersianStr,\r\n\t\t\t\tfas.AssignmentFailureReasonId,\r\n\t\t\t\tafr.Title AssignmentFailureReasonTitle,\r\n\t\t\t\tfas.CreateDatePersian FleetPreAssignmentStateCreateDatePersian,\r\n\t\t\t\tfas.OngoingDispatchRequestCount,\r\n\t\t\t\tfas.OngoingShipments,\r\n\t\t\t\tfas.ArrivalDelaySeconds,\r\n\t\t\t\tfas.StartlocationToPickup,\r\n\t\t\t\tdrfas.DeliveryServiceProviderId,\r\n\t\t\t\tdrfas.CreatorUserName\r\n\r\n\t\tFROM dp.DispatchRequest(NOLOCK) dr\r\n\t\tINNER JOIN dp.DispatchRequestFleetPreAssignmentState(NOLOCK) drfas\tON dr.Id=drfas.dispatchrequestId\r\n\t\tINNER JOIN dp.FleetPreAssignmentState(NOLOCK) fas\t\t\t\t\tON drfas.FleetPreAssignmentStateId=fas.Id\r\n\t\tINNER JOIN dp.AssignmentFailureReason(NOLOCK) afr\t\t\t\t\tON afr.Id=fas.AssignmentFailureReasonId\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=fas.FleetId\r\n\t\tINNER JOIN CS_DriverManagement.DM.Vehicle(NOLOCK) dv\t\t\t\t\t\t\t\t\tON dv.Id=df.VehicleId\r\n\t\tWHERE dr.Id=@DispatchRequestId\r\n\t)\r\n\tSELECT ( SELECT COUNT(ID) FROM CTE ) count,\r\n\t\t\tId,\r\n\t\t\tDispatchRequestId,\r\n\t\t\tParcelReferenceCode,\r\n\t\t\tFleetId,\r\n\t\t\tDriverId,\r\n\t\t\tVehicleTypeId,\r\n\t\t\tShipmentId,\r\n\t\t\tFleetStatusId,\r\n\t\t\tFleetLocation,\r\n\t\t\tTodayDeliveredParcelCount,\r\n\t\t\tArrivalDurationTimeSeconds,\r\n\t\t\tDistanceMeter,\r\n\t\t\tCreateDatePersian,\r\n\t\t\tCreateDatePersianStr,\r\n\t\t\tAssignmentFailureReasonId,\r\n\t\t\tAssignmentFailureReasonTitle,\r\n\t\t\tFleetPreAssignmentStateCreateDatePersian,\r\n\t\t\tOngoingDispatchRequestCount,\r\n\t\t\tOngoingShipments,\r\n\t\t\tArrivalDelaySeconds,\r\n\t\t\tStartlocationToPickup,\r\n\t\t\tDeliveryServiceProviderId,\r\n\t\t\tCreatorUserName\r\n\tFROM CTE\r\n\tORDER BY CreateDatePersian DESC\r\n\r\n\r\n\r\n"},{"Name":"Get_FleetPreAssignmentState_By_DispatchRequestId_New","Schema":"dbo","Definition":"CREATE     PROCEDURE [dbo].[Get_FleetPreAssignmentState_By_DispatchRequestId_New]  \r\n\r\n\t@DispatchRequestId\tBIGINT,\r\n\t@Result NVARCHAR(MAX) OUTPUT\r\nAS\r\nSET NOCOUNT ON\r\n\r\n\r\n\tSELECT \r\n\t\tfleetId,\r\n\t\tdriverId,\r\n\t\tdriverName,\r\n\t\tdriverMobile,\r\n\t\tfleetStatusId,\r\n\t\tfleetStatusTitle,\r\n\t\tvehicleTypeId,\r\n\t\tvehicleTypeTitle,\r\n\t\tid,\r\n\t\tdispatchRequestId,\r\n\t\tdeliveryServiceProviderId,\r\n\t\ttodayDeliveredParcelCount,\r\n\t\tarrivalDurationTimeSeconds,\r\n\t\tdistanceMeter,\r\n\t\tcreateDatePersian_Parent,\r\n\t\tcreateDatePersian,\r\n\t\tcreateDatePersianStr,\r\n\t\tassignmentFailureReasonId,\r\n\t\tassignmentFailureReasonTitle,\r\n\t\tfleetPreAssignmentStateCreateDatePersian,\r\n\t\tongoingDispatchRequestCount,\r\n\t\t--creatorUserName,\r\n\t\tfleetLocation,\r\n\t\tstartlocationToPickup,\r\n\t\tongoingShipments,\r\n\t\tFIRST_VALUE(isFleetAssigned) OVER ( PARTITION BY dispatchRequestId , DeliveryServiceProviderId , createDatePersian_Parent ORDER BY isFleetAssigned DESC ) isFleetAssigned\r\n\tINTO #Output\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tfas.FleetId AS fleetId,\r\n\t\t\tf.DriverId AS driverId,\r\n\t\t\td.FirstName \u002B \u0027 \u0027 \u002B d.LastName AS driverName,\r\n\t\t\td.Mobile AS driverMobile,\r\n\t\t\tf.FleetStatusId AS fleetStatusId,\r\n\t\t\tfs.Title AS fleetStatusTitle,\r\n\t\t\tdv.VehicleTypeId AS vehicleTypeId,\r\n\t\t\tvt.Title AS vehicleTypeTitle,\r\n\t\t\tfas.Id AS id,\r\n\t\t\tfas.DispatchRequestId AS dispatchRequestId,\r\n\t\t\tfas.DeliveryServiceProviderId AS deliveryServiceProviderId,\r\n\t\t\tISNULL(fas.TodayDeliveredParcelCount,0) AS todayDeliveredParcelCount,\r\n\t\t\tfas.ArrivalDurationTime AS arrivalDurationTimeSeconds,\r\n\t\t\tfas.DistanceMeter AS distanceMeter,\r\n\t\t\tLEFT(fas.CreateDatePersian,12) createDatePersian_Parent,\r\n\t\t\tfas.CreateDatePersian createDatePersian,\r\n\t\t\tFORMAT(fas.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS createDatePersianStr,\r\n\t\t\tfas.AssignmentFailureReasonId AS assignmentFailureReasonId,\r\n\t\t\tafr.Title AS assignmentFailureReasonTitle,\r\n\t\t\tfas.CreateDatePersian AS fleetPreAssignmentStateCreateDatePersian,\r\n\t\t\tfas.OngoingDispatchRequestCount AS ongoingDispatchRequestCount,\r\n\t\t\t--fas.CreatorUserName AS creatorUserName,\r\n\t\t\tCASE WHEN fas.AssignmentFailureReasonId = 5 THEN 1 ELSE 0 END isFleetAssigned,\r\n\t\t\tfas.FleetLocation AS fleetLocation,\r\n\t\t\tfas.StartlocationToPickup AS startlocationToPickup,\r\n\t\t\tfas.OngoingShipments AS ongoingShipments\r\n\t\tFROM DP.FleetPreAssignmentStateLog fas WITH(NOLOCK)\r\n\t\tLEFT JOIN DP.AssignmentFailureReason afr WITH(NOLOCK) \t\t\t\t\t\r\n\t\t\tON afr.Id = fas.AssignmentFailureReasonId\r\n\t\tLEFT JOIN CS_DriverManagement.DM.Fleet f WITH(NOLOCK) \t\t\t\t\t\t\t\t\t\t\r\n\t\t\tON f.Id = fas.FleetId\r\n\t\tLEFT JOIN CS_DriverManagement.DM.FleetStatus fs WITH(NOLOCK)\r\n\t\t\tON f.FleetStatusId = fs.Id\r\n\t\tLEFT JOIN CS_DriverManagement.DM.Driver d WITH(NOLOCK)\r\n\t\t\tON f.DriverId = d.Id\r\n\t\tLEFT JOIN CS_DriverManagement.DM.Vehicle dv WITH(NOLOCK) \t\t\t\t\t\t\t\t\t\r\n\t\t\tON dv.Id = f.VehicleId\r\n\t\tLEFT JOIN CS_DriverManagement.DM.VehicleType vt WITH(NOLOCK)\r\n\t\t\tON dv.VehicleTypeId = vt.Id\r\n\t\tWHERE fas.DispatchRequestId = @DispatchRequestId\r\n\t\tAND NOT(fas.AssignmentFailureReasonId IN (105,100) AND fas.DeliveryServiceProviderId = 1)\r\n\t) SQ\r\n\t\r\n/*\r\n\tRETURN\r\n\r\n;WITH CTE_Output AS\r\n(\r\n\tSELECT \r\n\t\tfleetId,\r\n\t\tdriverId,\r\n\t\tdriverName,\r\n\t\tdriverMobile,\r\n\t\tfleetStatusId,\r\n\t\tfleetStatusTitle,\r\n\t\tvehicleTypeId,\r\n\t\tvehicleTypeTitle,\r\n\t\tid,\r\n\t\tdispatchRequestId,\r\n\t\tdeliveryServiceProviderId,\r\n\t\ttodayDeliveredParcelCount,\r\n\t\tarrivalDurationTimeSeconds,\r\n\t\tdistanceMeter,\r\n\t\tcreateDatePersian_Parent,\r\n\t\tcreateDatePersian,\r\n\t\tcreateDatePersianStr,\r\n\t\tassignmentFailureReasonId,\r\n\t\tassignmentFailureReasonTitle,\r\n\t\tfleetPreAssignmentStateCreateDatePersian,\r\n\t\tongoingDispatchRequestCount,\r\n\t\tcreatorUserName,\r\n\t\tfleetLocation,\r\n\t\tstartlocationToPickup,\r\n\t\tongoingShipments,\r\n\t\tFIRST_VALUE(isFleetAssigned) OVER ( PARTITION BY dispatchRequestId , DeliveryServiceProviderId , createDatePersian_Parent ORDER BY isFleetAssigned DESC ) isFleetAssigned\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tfas.FleetId AS fleetId,\r\n\t\t\tf.DriverId AS driverId,\r\n\t\t\td.FirstName \u002B \u0027 \u0027 \u002B d.LastName AS driverName,\r\n\t\t\td.Mobile AS driverMobile,\r\n\t\t\tf.FleetStatusId AS fleetStatusId,\r\n\t\t\tfs.Title AS fleetStatusTitle,\r\n\t\t\tdv.VehicleTypeId AS vehicleTypeId,\r\n\t\t\tvt.Title AS vehicleTypeTitle,\r\n\t\t\tfas.Id AS id,\r\n\t\t\tdrfas.DispatchRequestId AS dispatchRequestId,\r\n\t\t\tdrfas.DeliveryServiceProviderId AS deliveryServiceProviderId,\r\n\t\t\tISNULL(fas.TodayDeliveredParcelCount,0) AS todayDeliveredParcelCount,\r\n\t\t\tfas.ArrivalDurationTime AS arrivalDurationTimeSeconds,\r\n\t\t\tfas.DistanceMeter AS distanceMeter,\r\n\t\t\tLEFT(fas.CreateDatePersian,12) createDatePersian_Parent,\r\n\t\t\tfas.CreateDatePersian createDatePersian,\r\n\t\t\tFORMAT(fas.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS createDatePersianStr,\r\n\t\t\tfas.AssignmentFailureReasonId AS assignmentFailureReasonId,\r\n\t\t\tafr.Title AS assignmentFailureReasonTitle,\r\n\t\t\tfas.CreateDatePersian AS fleetPreAssignmentStateCreateDatePersian,\r\n\t\t\tfas.OngoingDispatchRequestCount AS ongoingDispatchRequestCount,\r\n\t\t\tdrfas.CreatorUserName AS creatorUserName,\r\n\t\t\tCASE WHEN fas.AssignmentFailureReasonId = 5 THEN 1 ELSE 0 END isFleetAssigned,\r\n\t\t\tfas.FleetLocation AS fleetLocation,\r\n\t\t\tfas.StartlocationToPickup AS startlocationToPickup,\r\n\t\t\tfas.OngoingShipments AS ongoingShipments\r\n\t\tFROM DP.DispatchRequestFleetPreAssignmentState drfas WITH(NOLOCK)\r\n\t\tLEFT JOIN DP.FleetPreAssignmentState fas WITH(NOLOCK) \t\t\t\t\t\r\n\t\t\tON drfas.FleetPreAssignmentStateId = fas.Id\r\n\t\tLEFT JOIN DP.AssignmentFailureReason afr WITH(NOLOCK) \t\t\t\t\t\r\n\t\t\tON afr.Id = fas.AssignmentFailureReasonId\r\n\t\tLEFT JOIN CS_DriverManagement.DM.Fleet f WITH(NOLOCK) \t\t\t\t\t\t\t\t\t\t\r\n\t\t\tON f.Id = fas.FleetId\r\n\t\tLEFT JOIN CS_DriverManagement.DM.FleetStatus fs WITH(NOLOCK)\r\n\t\t\tON f.FleetStatusId = fs.Id\r\n\t\tLEFT JOIN CS_DriverManagement.DM.Driver d WITH(NOLOCK)\r\n\t\t\tON f.DriverId = d.Id\r\n\t\tLEFT JOIN CS_DriverManagement.DM.Vehicle dv WITH(NOLOCK) \t\t\t\t\t\t\t\t\t\r\n\t\t\tON dv.Id = f.VehicleId\r\n\t\tLEFT JOIN CS_DriverManagement.DM.VehicleType vt WITH(NOLOCK)\r\n\t\t\tON dv.VehicleTypeId = vt.Id\r\n\t\tWHERE drfas.DispatchRequestId = @DispatchRequestId\r\n\t\tAND NOT(fas.AssignmentFailureReasonId IN (105,100) AND drfas.DeliveryServiceProviderId = 1)\r\n\t) SQ\r\n)*/\r\n--SELECT DISTINCT deliveryServiceProviderId,createDatePersian_Parent FROM #Output O3\r\n\r\n--CREATE INDEX IX_#Output ON #Output\r\n--(\r\n--\tcreateDatePersian_Parent,\r\n--\tdeliveryServiceProviderId\r\n--)\r\n--INCLUDE\r\n--(\r\n--\t\tfleetId,\r\n--\t\tdriverId,\r\n--\t\tdriverName,\r\n--\t\tdriverMobile,\r\n--\t\tfleetStatusId,\r\n--\t\tfleetStatusTitle,\r\n--\t\tvehicleTypeId,\r\n--\t\tvehicleTypeTitle,\r\n--\t\tid,\r\n--\t\tdispatchRequestId,\r\n--\t\ttodayDeliveredParcelCount,\r\n--\t\tarrivalDurationTimeSeconds,\r\n--\t\tdistanceMeter,\r\n--\t\tcreateDatePersian,\r\n--\t\tcreateDatePersianStr,\r\n--\t\tassignmentFailureReasonId,\r\n--\t\tassignmentFailureReasonTitle,\r\n--\t\tfleetPreAssignmentStateCreateDatePersian,\r\n--\t\tongoingDispatchRequestCount,\r\n--\t\tcreatorUserName,\r\n--\t\tfleetLocation,\r\n--\t\tstartlocationToPickup,\r\n--\t\tongoingShipments,\r\n--\t\tisFleetAssigned\r\n--)\r\n\r\n/*\r\nSELECT \r\n\t\tfleetId,\r\n\t\tdriverId,\r\n\t\tdriverName,\r\n\t\t\u00270\u0027\u002BCAST(driverMobile AS NVARCHAR(MAX)) driverMobile,\r\n\t\tfleetStatusId,\r\n\t\tfleetStatusTitle,\r\n\t\tvehicleTypeId,\r\n\t\tvehicleTypeTitle,\r\n\t\tid,\r\n\t\tdispatchRequestId,\r\n\t\ttodayDeliveredParcelCount,\r\n\t\tarrivalDurationTimeSeconds,\r\n\t\tdistanceMeter,\r\n\t\tCreateDatePersian,\r\n\t\tcreateDatePersianStr,\r\n\t\tassignmentFailureReasonId,\r\n\t\tassignmentFailureReasonTitle,\r\n\t\tfleetPreAssignmentStateCreateDatePersian,\r\n\t\tongoingDispatchRequestCount,\r\n\t\tcreatorUserName,\r\n\t\tongoingShipments,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tfleetLocation.STY  AS  Latitude,\r\n\t\t\t\tfleetLocation.STX  AS Longitude\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t) fleetLocation,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tstartlocationToPickup.STY  AS  Latitude,\r\n\t\t\t\tstartlocationToPickup.STX  AS Longitude\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t) startlocationToPickup\r\n\tFROM #Output O3\r\n\tWHERE o3.DispatchRequestId = @DispatchRequestId\r\n\tAND o3.DeliveryServiceProviderId = 1\r\n\tAND O3.createDatePersian_Parent = 140306060957\r\n\t*/\r\n\r\n\tSELECT DISTINCT \r\n\t\tdeliveryServiceProviderId,\r\n\t\tcreateDatePersian_Parent,\r\n\t\tisFleetAssigned\r\n\tINTO #DSP\r\n\tFROM #Output\r\n\r\n\tDECLARE \r\n\t\t@createDatePersian_Parent BIGINT,\r\n\t\t@deliveryServiceProviderId TINYINT,\r\n\t\t@isFleetAssigned BIT\r\n\r\n\t--CREATE TABLE #ItemJson\r\n\t--(\r\n\t--\tcreateDatePersian_Parent BIGINT,\r\n\t--\tdeliveryServiceProviderId TINYINT,\r\n\t--\tisFleetAssigned BIT,\r\n\t--\tItem NVARCHAR(MAX)\r\n\t--)\r\n\t--CREATE INDEX IX_#ItemJson ON #ItemJson\r\n\t--(\r\n\t--\tcreateDatePersian_Parent,\r\n\t--\tdeliveryServiceProviderId\r\n\t--)\r\n\t/*\r\n\tDECLARE C CURSOR FAST_FORWARD FOR\r\n\tSELECT DISTINCT createDatePersian_Parent , deliveryServiceProviderId , isFleetAssigned FROM #Output \r\n\r\n\tOPEN C\r\n\tFETCH NEXT FROM C INTO @createDatePersian_Parent , @deliveryServiceProviderId , @isFleetAssigned\r\n\r\n\tWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\r\n\tINSERT INTO #ItemJson (createDatePersian_Parent , deliveryServiceProviderId , isFleetAssigned , Item )\r\n\tSELECT \r\n\t\t@createDatePersian_Parent , \r\n\t\t@deliveryServiceProviderId,\r\n\t\t@isFleetAssigned,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tfleetId,\r\n\t\t\t\tdriverId,\r\n\t\t\t\tdriverName,\r\n\t\t\t\t\u00270\u0027\u002BCAST(driverMobile AS NVARCHAR(MAX)) driverMobile,\r\n\t\t\t\tfleetStatusId,\r\n\t\t\t\tfleetStatusTitle,\r\n\t\t\t\tvehicleTypeId,\r\n\t\t\t\tvehicleTypeTitle,\r\n\t\t\t\tid,\r\n\t\t\t\tdispatchRequestId,\r\n\t\t\t\ttodayDeliveredParcelCount,\r\n\t\t\t\tarrivalDurationTimeSeconds,\r\n\t\t\t\tdistanceMeter,\r\n\t\t\t\tCreateDatePersian,\r\n\t\t\t\tcreateDatePersianStr,\r\n\t\t\t\tassignmentFailureReasonId,\r\n\t\t\t\tassignmentFailureReasonTitle,\r\n\t\t\t\tfleetPreAssignmentStateCreateDatePersian,\r\n\t\t\t\tongoingDispatchRequestCount,\r\n\t\t\t\tcreatorUserName,\r\n\t\t\t\tongoingShipments,\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tfleetLocation.STY  AS  Latitude,\r\n\t\t\t\t\t\tfleetLocation.STX  AS Longitude\r\n\t\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t) fleetLocation,\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tstartlocationToPickup.STY  AS  Latitude,\r\n\t\t\t\t\t\tstartlocationToPickup.STX  AS Longitude\r\n\t\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t) startlocationToPickup\r\n\t\t\tFROM #Output O3\r\n\t\t\tWHERE o3.DispatchRequestId = @DispatchRequestId\r\n\t\t\tAND o3.DeliveryServiceProviderId = @deliveryServiceProviderId\r\n\t\t\tAND O3.createDatePersian_Parent = @createDatePersian_Parent\r\n\t\t\tFOR JSON PATH\r\n\t\t) Item\r\n\r\n\tFETCH NEXT FROM C INTO @createDatePersian_Parent , @deliveryServiceProviderId , @isFleetAssigned\r\n\tEND\r\n\tCLOSE C\r\n\tDEALLOCATE C\r\n\t*/\r\n\r\n;WITH CTE_DSPOrderID AS\r\n(\r\n\tSELECT TOP 1 WITH TIES\r\n\t\tdsprm.DeliveryServiceProviderOrderId,\r\n\t\tdsprm.DeliveryServiceProviderId,\r\n\t\tdsprm.DispatchRequestId\r\n\tFROM DP.DeliveryServiceProviderRequestMapper dsprm WITH(NOLOCK)\r\n\tWHERE dsprm.DispatchRequestId = @DispatchRequestId\r\n\tORDER BY ROW_NUMBER() OVER ( PARTITION BY dsprm.DispatchRequestId , dsprm.DeliveryServiceProviderId ORDER BY dsprm.CreateDate DESC )\r\n)\r\nSELECT @Result =\r\n(\r\n\tSELECT \r\n\t\tdr.DeliveryServiceProviderId AS selectedServiceProviderId,\r\n\t\tdr.ParcelReferenceCode AS parcelReferenceCode,\r\n\t\t(\r\n\t\t\tSELECT DISTINCT\r\n\t\t\t\to.deliveryServiceProviderId,\r\n\t\t\t\t( \r\n\t\t\t\t\tdspO.DeliveryServiceProviderOrderId\r\n\t\t\t\t) deliveryServiceProviderOrderId,\r\n\t\t\t\t(\r\n\t\t\t\t\t\tSELECT DISTINCT \r\n\t\t\t\t\t\t\tO1.createDatePersian_Parent AS createDatePersian , \r\n\t\t\t\t\t\t\tO1.isFleetAssigned ,\r\n\t\t\t\t\t\t\tItems.Item items\r\n\t\t\t\t\t\tFROM #DSP O1\r\n\t\t\t\t\t\tOUTER APPLY\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\tfleetId,\r\n\t\t\t\t\t\t\t\t\t\tdriverId,\r\n\t\t\t\t\t\t\t\t\t\tdriverName,\r\n\t\t\t\t\t\t\t\t\t\t\u00270\u0027\u002BCAST(driverMobile AS NVARCHAR(MAX)) driverMobile,\r\n\t\t\t\t\t\t\t\t\t\tfleetStatusId,\r\n\t\t\t\t\t\t\t\t\t\tfleetStatusTitle,\r\n\t\t\t\t\t\t\t\t\t\tvehicleTypeId,\r\n\t\t\t\t\t\t\t\t\t\tvehicleTypeTitle,\r\n\t\t\t\t\t\t\t\t\t\tid,\r\n\t\t\t\t\t\t\t\t\t\tdispatchRequestId,\r\n\t\t\t\t\t\t\t\t\t\ttodayDeliveredParcelCount,\r\n\t\t\t\t\t\t\t\t\t\tarrivalDurationTimeSeconds,\r\n\t\t\t\t\t\t\t\t\t\tdistanceMeter,\r\n\t\t\t\t\t\t\t\t\t\tCreateDatePersian,\r\n\t\t\t\t\t\t\t\t\t\tcreateDatePersianStr,\r\n\t\t\t\t\t\t\t\t\t\tassignmentFailureReasonId,\r\n\t\t\t\t\t\t\t\t\t\tassignmentFailureReasonTitle,\r\n\t\t\t\t\t\t\t\t\t\tfleetPreAssignmentStateCreateDatePersian,\r\n\t\t\t\t\t\t\t\t\t\tongoingDispatchRequestCount,\r\n\t\t\t\t\t\t\t\t\t\t--creatorUserName,\r\n\t\t\t\t\t\t\t\t\t\tongoingShipments,\r\n\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\tfleetLocation.STY  AS  Latitude,\r\n\t\t\t\t\t\t\t\t\t\t\t\tfleetLocation.STX  AS Longitude\r\n\t\t\t\t\t\t\t\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t\t\t\t\t\t) fleetLocation,\r\n\t\t\t\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT \r\n\t\t\t\t\t\t\t\t\t\t\t\tstartlocationToPickup.STY  AS  Latitude,\r\n\t\t\t\t\t\t\t\t\t\t\t\tstartlocationToPickup.STX  AS Longitude\r\n\t\t\t\t\t\t\t\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t\t\t\t\t\t) startlocationToPickup\r\n\t\t\t\t\t\t\t\t\tFROM #Output O3\r\n\t\t\t\t\t\t\t\t\tWHERE o3.DispatchRequestId = @DispatchRequestId\r\n\t\t\t\t\t\t\t\t\tAND o3.DeliveryServiceProviderId = O1.deliveryServiceProviderId\r\n\t\t\t\t\t\t\t\t\tAND O3.createDatePersian_Parent = o1.createDatePersian_Parent\r\n\t\t\t\t\t\t\t\t\tORDER BY o3.createDatePersian DESC\r\n\t\t\t\t\t\t\t\t\tFOR JSON PATH\r\n\t\t\t\t\t\t\t\t) Item\t\t\r\n\t\t\t\t\t\t) Items\r\n\t\t\t\t\t\tWHERE O1.deliveryServiceProviderId = O.deliveryServiceProviderId\r\n\t\t\t\t\t\tORDER BY o1.createDatePersian_Parent DESC\r\n\t\t\t\t\t\tFOR JSON PATH\t\t\t\t\t\r\n\t\t\t\t) serviceProviderPerformance\r\n\t\t\t\t\r\n\t\t\tFROM #DSP O\r\n\t\t\tLEFT JOIN CTE_DSPOrderID dspO\r\n\t\t\t\tON O.DeliveryServiceProviderId = dspO.DeliveryServiceProviderId\r\n\t\t\tFOR JSON PATH\r\n\t\t) serviceProvidersPerformance\r\n\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\tWHERE dr.ID = @DispatchRequestId\r\n\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n)\r\n\r\nSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\nSET @Result = REPLACE(@Result,\u0027:\u0022{\u0027,\u0027:{\u0027)\r\nSET @Result = REPLACE(@Result,\u0027}\u0022\u0027,\u0027}\u0027)\r\n\r\nSET @Result = REPLACE(@Result,\u0027\u0022items\u0022:\u0022[\u0027,\u0027\u0022items\u0022:[\u0027)\r\nSET @Result = REPLACE(@Result,\u0027]\u0022}\u0027,\u0027]}\u0027)\r\n\r\n--SET @Result = REPLACE(@Result,\u0027\u0022createDatePersian\u0022:\u0022\u0027,\u0027\u0022createDatePersian\u0022:\u0027)\r\n--SET @Result = REPLACE(@Result,\u0027\u0022,\u0022isFleetAssigned\u0022\u0027,\u0027,\u0022isFleetAssigned\u0022\u0027)\r\n\r\n--SELECT ISJSON(@Result)"},{"Name":"Get_HyperDelayedOrderCancellation","Schema":"dbo","Definition":"\r\n\r\nCREATE   PROC Get_HyperDelayedOrderCancellation\r\nAS\r\nSELECT \r\n\tdr.ParcelReferenceCode\r\nFROM DP.DispatchRequest dr WITH(NOLOCK)\r\nINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\tON dr.PolygonStoreId = ps.Id \r\nINNER JOIN DP.Store st WITH(NOLOCK)\r\n\tON ps.StoreId = st.Id \r\nINNER JOIN DP.StoreTechnicalBasicInformation stb WITH(NOLOCK)\r\n\tON st.Id = stb.StoreId \r\nINNER JOIN CS_OrderManagement.OM.Parcel p WITH(NOLOCK)\r\n\tON dr.ParcelReferenceCode = p.ParcelReferenceCode\r\nINNER JOIN CS_OrderManagement.OM.CourierRequest cr WITH(NOLOCK)\r\n\tON p.CourierRequestId = cr.Id\r\nWHERE dr.DispatchRequestStatusId IN(5,7)\r\nAND dr.DeliveryDeadLineTime \u003E= FORMAT(GETDATE()-1,\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027\r\nAND stb.TimeIntervalUntilCancellation \u003C DATEDIFF(MINUTE,CAST(CONVERT(varchar,FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME),GETDATE())\r\nAND cr.ConfirmationDate IS NOT NULL\r\n\r\n"},{"Name":"Get_MapServiceProviderApiCallingHistory_By_Filter","Schema":"dbo","Definition":"/*\r\nDECLARE @TotalCount INT\r\nEXEC [dbo].[Get_MapServiceProviderApiCallingHistory_By_Filter] \r\n\t@FromCreateDate\t\t = 20230709000000000,\r\n\t@ToCreateDate\t\t = 20230709235959999,\r\n\t@TotalCount\t\t\t = @TotalCount OUTPUT\r\n\r\nSELECT @TotalCount\r\n*/\r\n\r\nCREATE   PROC [dbo].[Get_MapServiceProviderApiCallingHistory_By_Filter] \r\n(\r\n\t@VendorParcelCode\t\t\tNVARCHAR(MAX) = NULL,\r\n\t@ShipmentNumber\t\t\t\tBIGINT = NULL,\r\n\t@FromCreateDate\t\t\t\tBIGINT ,\r\n\t@ToCreateDate\t\t\t\tBIGINT ,\r\n\t@MapServiceProviderId\t\tTinyint = NULL,\r\n\t@PageIndex\t\t\t\t\tINT\t= NULL,\r\n\t@PageSize\t\t\t\t\tINT\t= NULL,\r\n\t@TotalCount\t\t\t\t\tINT OUTPUT\r\n)\r\nAS\r\n\r\n\r\nSELECT \r\n\t@VendorParcelCode\t\t= ISNULL(@VendorParcelCode\t\t\t,\u00270\u0027),\r\n\t@ShipmentNumber\t\t\t= ISNULL(@ShipmentNumber\t\t\t,0)\t,\r\n\t@MapServiceProviderId\t= ISNULL(@MapServiceProviderId\t\t,0)\r\n\r\nDROP TABLE IF EXISTS #Final\r\nCREATE TABLE #Final\r\n(\r\n\tVendorName\t\t\t\tNVARCHAR(50),\r\n\tShipmentNumber\t\t\tBIGINT,\r\n\tMapServiceProviderTitle\tVARCHAR(64),\r\n\tAPITitle\t\t\t\tNVARCHAR(128),\r\n\tCreateDatePersian\t\tVARCHAR(24),\r\n\tRequestBody\t\t\t\tNVARCHAR(MAX),\r\n\tResponseBody\t\t\tNVARCHAR(MAX),\r\n\tResponseCode\t\t\tSMALLINT\r\n)\r\n\r\nIF @FromCreateDate \u003C\u003E 0 AND @ToCreateDate \u003C\u003E 0\r\n\tBEGIN\r\n\t\tIF dbo.FN_DateDiff(@FromCreateDate, @ToCreateDate) \u003E 31\r\n\t\tBEGIN\r\n\t\t\tSET @TotalCount = 0\r\n\t\t\tSELECT * FROM #Final\r\n\t\t\tRETURN;\r\n\t\tEND;\r\n\tEND;\r\n\tELSE\r\n\tBEGIN\r\n\t\r\n\t\tSELECT @FromCreateDate = FORMAT(DATEADD(MONTH,-1,GETDATE()), \u0027yyyyMMddHHmmss\u0027)\u002B\u0027000\u0027\r\n\t\tSELECT @ToCreateDate = FORMAT(GETDATE(), \u0027yyyyMMddHHmmss\u0027)\u002B\u0027999\u0027\r\n\tEND\r\n\r\n\r\n\r\n\r\nINSERT INTO #Final\r\n(\r\n\tVendorName,\r\n\tShipmentNumber,\r\n\tMapServiceProviderTitle,\r\n\tAPITitle,\r\n\tCreateDatePersian,\r\n\tRequestBody,\r\n\tResponseCode,\r\n\tResponseBody\r\n\t\t\t\t\r\n)\r\nSELECT \r\n\tv.BrandName AS VendorName,\r\n\ts.ShipmentNumber,\r\n\tmsp.Title AS MapServiceProviderTitle,\r\n\tmspa.APITitle,\r\n\tFORMAT(mspach.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersian,\r\n\tmspach.RequestBody,\r\n\tmspach.ResponseCode,\r\n\tmspach.ResponseJson ResponseBody \r\nFROM DP.DispatchRequest dr (NOLOCK)\r\n--INNER JOIN DP.PolygonStore ps (NOLOCK)\r\n--\tON dr.PolygonStoreId = ps.Id\r\n--INNER JOIN DP.Store s1 (NOLOCK)\r\n--\tON ps.StoreId=s1.Id\r\nINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\tON dr.VendorId = v.ID\r\nINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr  (NOLOCK)\r\n\tON dr.Id = sdpdr.DispatchRequestId\r\nINNER JOIN DP.ShipmentDestinationPoint sdp  (NOLOCK)\r\n\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\nINNER JOIN DP.Shipment s  (NOLOCK)\r\n\tON sdp.ShipmentId = s.Id\r\nINNER JOIN CS_Log.Haf.MapServiceProviderApiCallingHistory mspach  (NOLOCK)\r\n\tON s.ShipmentNumber = mspach.ShipmentNumber\r\nINNER JOIN DP.MapServiceProvider msp  (NOLOCK)\r\n\tON sdp.MapServiceProviderId = msp.Id\r\nINNER JOIN DP.MapServiceProviderApi mspa  (NOLOCK)\r\n\tON mspach.MapServiceProviderApiId = mspa.ID\r\n\tAND MapServiceProviderApiId In (1,2,4,6,10,11)\r\n\r\nWHERE mspach.CreateDate BETWEEN @FromCreateDate AND @ToCreateDate\r\nAND (dr.VendorParcelCode = @VendorParcelCode OR @VendorParcelCode = \u00270\u0027)\r\nAND (s.ShipmentNumber = @ShipmentNumber OR @ShipmentNumber = 0)\r\nAND (msp.ID = @MapServiceProviderId OR @MapServiceProviderId = 0)\r\n\r\nSET @TotalCount = @@ROWCOUNT\r\n\r\nIF ISNULL(@TotalCount,0)\u003E 0\r\n\tBEGIN\r\n\t\tIF \t@PageIndex IS NULL \r\n\t\t\tSET @PageIndex = 0\r\n\r\n\t\tIF @PageSize IS NULL\r\n\t\t\tSET @PageSize = @TotalCount\r\n\r\n\r\n\t\tSELECT * FROM #Final\r\n\t\tOrder By ( SELECT 1 )\r\n\t\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\tEND\r\nELSE\r\n\tSELECT * FROM #Final"},{"Name":"Get_NotPickReport_Grid","Schema":"dbo","Definition":"\r\nCREATE   PROC [dbo].[Get_NotPickReport_Grid]\r\n(\r\n\t@FromDeliveryStartTimePersian BIGINT,\r\n\t@ToDeliveryStartTimePersian BIGINT,\r\n\t@DispatchRequestStatusId TINYINT = NULL,\r\n\t@VendorParcelCode varchar(MAX) = NULL,\r\n\t@ParcelReferenceCode bigint = NULL,\r\n\t@ProvinceId TINYINT = NULL,\r\n\t@CityId SMALLINT = NULL,\r\n\t@PolygonIdS VARCHAR(MAX) = NULL,\r\n\t@StoreIdS VARCHAR(MAX) = NULL,\r\n\t@ShipmentNumber INT = NULL,\r\n\t@FleetId  INT = NULL,\r\n\t@NotPickupReasonIdOfFleet\tINT = NULL,\r\n\t@NotPickupReasonIdOfOperation INT = NULL,\r\n\t@NotPickupRequestDateTimePersian INT = NULL,\r\n\t@IsFirstNotPickupApprovedBySystem INT = NULL,\r\n\t@IsFirstNotPickupRequestApproved INT = NULL,\r\n\t@IsRequestCanceledInFirstNotPickupRequest INT = NULL\r\n\t\t\r\n)\r\nAS\r\n\r\nDROP TABLE IF EXISTS #STOREIDS,#PolygonIDS\r\n\r\nSELECT\r\n\tS.ID\r\nINTO #STOREIDS\r\nFROM DP.STORE S (NOLOCK)\r\nINNER JOIN string_split(ISNULL(@STOREIdS,\u00270\u0027),\u0027,\u0027) ss\r\n\tON S.Id = ss.value\r\n\tOR ISNULL(@STOREIdS,\u00270\u0027) = \u00270\u0027\r\n\r\nSELECT \r\n    P.Id\r\nINTO #PolygonIDS\r\nFROM DP.Polygon P\r\nINNER JOIN string_split(ISNULL(@PolygonIDS,\u00270\u0027),\u0027,\u0027)SS\r\n\tON P.ID=SS.value\r\n\tOR  ISNULL(@PolygonIDS,\u00270\u0027) = \u00270\u0027\r\n\r\n\r\n;WITH CTE_DR AS\r\n(\r\n\tSELECT \r\n\t\tdr.Id AS DispatchRequestId,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdrs.Title AS DispatchRequestStatusTitle,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.DeliveryStartTimePersian,\r\n\t\tdr.DeliveryDeadLineTime,\r\n\r\n\t\tpr.Id AS ProvinceId,\r\n\t\tpr.Name AS ProvinceTitle,\r\n\r\n\t\tc.Id AS CityId,\r\n\t\tc.Name AS CityName,\r\n\r\n\t\tp.Id AS PolygonId,\r\n\t\tp.Title AS PolygonTitle,\r\n\r\n\t\ts.Id AS StoreId,\r\n\t\ts.Title AS StoreTitle,\r\n\t\ts.VendorCode AS StoreCode\r\n\r\n\tFROM DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN DP.DispatchRequestStatus drs (NOLOCK)\r\n\t\tON dr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.Id\r\n\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\tON ps.StoreId = s.Id\r\n\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.Id\r\n\tINNER JOIN CS_Public.Haf.Province pr (NOLOCK)\r\n\t\tON c.ProvinceId = pr.Id\r\n\tINNER JOIN #PolygonIDS PLI\r\n\t\tON p.ID = PLI.Id\r\n\tINNER JOIN #STOREIDS SI\r\n\t\tON SI.ID = PS.StoreId\r\n\r\n\tWHERE \r\n\t\tdr.DeliveryStartTimePersian \u003E= @FromDeliveryStartTimePersian\r\n\tAND dr.DeliveryStartTimePersian \u003C= @ToDeliveryStartTimePersian\r\n\tAND EXISTS \r\n\t(\r\n\t\tSELECT * FROM DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK)\r\n\t\tWHERE dr.Id = uorh.DispatchRequestId\r\n\t)\r\n),CTE_Shipment AS\r\n(\r\n\tSELECT \r\n\t\tSQ.*,\r\n\t\td1.FirstName \u002B \u0027 \u0027 \u002B d1.LastName AS FirstDriverName,\r\n\t\td1.Mobile AS FirstDriverMobile,\r\n\t\td2.FirstName \u002B \u0027 \u0027 \u002B d2.LastName AS SecondDriverName,\r\n\t\td2.Mobile AS SecondDriverMobile\r\n\tFROM\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdpdr.DispatchRequestId,\r\n\t\t\tFIRST_VALUE(s.Id) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID , s.CreateDate ) FirstShipmentId,\r\n\t\t\tFIRST_VALUE(s.ShipmentNumber) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID , s.CreateDate ) FirstShipmentNumber,\r\n\t\t\tFIRST_VALUE(s.FleetId) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID , s.CreateDate ) FirstFleetId,\r\n\t\t\tFIRST_VALUE(s.Id) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID DESC, s.CreateDate DESC) SecondShipmentId,\r\n\t\t\tFIRST_VALUE(s.ShipmentNumber) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID DESC, s.CreateDate DESC) SecondShipmentNumber,\r\n\t\t\tFIRST_VALUE(s.FleetId) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID DESC, s.CreateDate DESC) SecondFleetId\r\n\t\tFROM CTE_DR dr\r\n\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\tON dr.DispatchRequestId = sdpdr.DispatchRequestId\r\n\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\tINNER JOIN DP.Shipment s (NOLOCK)\r\n\t\t\tON sdp.ShipmentId = s.Id\r\n\t) SQ\r\n\tLEFT JOIN CS_DriverManagement.DM.Fleet f1 (NOLOCK)\r\n\t\tON SQ.FirstFleetId = f1.ID\r\n\tLEFT JOIN CS_DriverManagement.DM.Driver d1 (NOLOCK)\r\n\t\tON f1.DriverId = d1.Id\r\n\r\n\tLEFT JOIN CS_DriverManagement.DM.Fleet f2 (NOLOCK)\r\n\t\tON SQ.SecondFleetId = f2.ID\r\n\tLEFT JOIN CS_DriverManagement.DM.Driver d2 (NOLOCK)\r\n\t\tON f2.DriverId = d2.Id\r\n),CTE_UOR AS\r\n(\r\n\tSELECT \r\n\t\tdr.DispatchRequestId ,\r\n\t\tuorh.CreatorUserName\r\n\tFROM CTE_DR dr\r\n\tINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK) \r\n\t\tON dr.DispatchRequestId = uorh.DispatchRequestId\r\n\t\tAND uorh.OperationTypeId = 7\r\n),CTE_Main AS\r\n(\r\n\tSELECT \r\n\t\tdr.DispatchRequestId,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdr.DispatchRequestStatusTitle,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.DeliveryStartTimePersian,\r\n\t\tdr.DeliveryDeadLineTime,\r\n\t\tdr.ProvinceId,\r\n\t\tdr.ProvinceTitle,\r\n\t\tdr.CityId,\r\n\t\tdr.CityName,\r\n\t\tdr.PolygonId,\r\n\t\tdr.PolygonTitle,\r\n\t\tdr.StoreId,\r\n\t\tdr.StoreTitle,\r\n\t\tdr.StoreCode,\r\n\r\n\t\ts.FirstShipmentNumber,\r\n\t\ts.FirstFleetId,\r\n\t\ts.FirstDriverName,\r\n\t\ts.FirstDriverMobile,\r\n\t\tCASE WHEN s.FirstShipmentId \u003C\u003E s.SecondShipmentId AND s.SecondShipmentId IS NOT NULL THEN 0 ELSE 1 END AS IsRequestCanceledInFirstNotPickupRequest,\r\n\t\tCASE WHEN s.FirstShipmentId \u003C\u003E s.SecondShipmentId THEN s.SecondShipmentNumber ELSE NULL END SecondShipmentNumber,\r\n\t\tCASE WHEN s.FirstShipmentId \u003C\u003E s.SecondShipmentId THEN s.SecondFleetId ELSE NULL END SecondFleetId,\r\n\t\tCASE WHEN s.FirstShipmentId \u003C\u003E s.SecondShipmentId THEN s.SecondDriverName ELSE NULL END SecondDriverName,\r\n\t\tCASE WHEN s.FirstShipmentId \u003C\u003E s.SecondShipmentId THEN s.SecondDriverMobile ELSE NULL END SecondDriverMobile,\r\n\t\tCASE WHEN s.FirstFleetId \u003C\u003E s.SecondFleetId THEN 1 ELSE 0 END IsFleetChanged\r\n\tFROM CTE_DR dr\r\n\tINNER JOIN CTE_Shipment s\r\n\t\tON dr.DispatchRequestId = s.DispatchRequestId\r\n),CTE_FirstFleet AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tSQ.DispatchRequestId,\r\n\t\tFIRST_VALUE(SQ.FirstNotPickupRequestDateTimePersian) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.FirstNotPickupRequestDateTimePersian DESC) AS FirstNotPickupRequestDateTimePersian,\r\n\t\tFIRST_VALUE(SQ.FirstNotPickupReasonOfFleet) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.FirstNotPickupReasonOfFleet DESC) AS FirstNotPickupReasonOfFleet,\r\n\t\tFIRST_VALUE(SQ.FirstNotPickupResultDateTimePersian) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.FirstNotPickupResultDateTimePersian DESC) AS FirstNotPickupResultDateTimePersian,\r\n\t\tFIRST_VALUE(SQ.FirstNotPickupReasonOfOperation) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.FirstNotPickupReasonOfOperation DESC) AS FirstNotPickupReasonOfOperation,\r\n\t\tFIRST_VALUE(SQ.FirstResponsibleOperationStaff) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.FirstResponsibleOperationStaff DESC) AS FirstResponsibleOperationStaff,\r\n\t\tFIRST_VALUE(SQ.IsFirstNotPickupApprovedBySystem) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.IsFirstNotPickupApprovedBySystem DESC) AS IsFirstNotPickupApprovedBySystem\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tuorh.DispatchRequestId,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.CreateDatePersian ELSE NULL END FirstNotPickupRequestDateTimePersian,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.OperationFailureReasonId ELSE NULL END FirstNotPickupReasonOfFleet,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 7,8,9,35 ) THEN uorh.CreateDatePersian ELSE NULL END FirstNotPickupResultDateTimePersian,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.OperationFailureReasonId ELSE NULL END FirstNotPickupReasonOfOperation,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.CreatorUserName ELSE NULL END FirstResponsibleOperationStaff,\r\n\t\t\tCASE WHEN uorh.OperationTypeId = 8 AND CreatorUserName = \u0027system|system\u0027 THEN 1 ELSE 0 END AS IsFirstNotPickupApprovedBySystem\r\n\t\tFROM CTE_Main f\r\n\t\tINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK) \r\n\t\t\tON f.DispatchRequestId = uorh.DispatchRequestId\r\n\t\t\tAND f.FirstFleetId = uorh.FleetId\r\n\t) SQ\r\n),CTE_SecondFleet AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tSQ.DispatchRequestId,\r\n\t\tFIRST_VALUE(SQ.SecondNotPickupRequestDateTimePersian) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.SecondNotPickupRequestDateTimePersian DESC) AS SecondNotPickupRequestDateTimePersian,\r\n\t\tFIRST_VALUE(SQ.SecondNotPickupReasonOfFleet) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.SecondNotPickupReasonOfFleet DESC) AS SecondNotPickupReasonOfFleet,\r\n\t\tFIRST_VALUE(SQ.SecondNotPickupResultDateTimePersian) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.SecondNotPickupResultDateTimePersian DESC) AS SecondNotPickupResultDateTimePersian,\r\n\t\tFIRST_VALUE(SQ.SecondNotPickupReasonOfOperation) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.SecondNotPickupReasonOfOperation DESC) AS SecondNotPickupReasonOfOperation,\r\n\t\tFIRST_VALUE(SQ.SecondResponsibleOperationStaff) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.SecondResponsibleOperationStaff DESC) AS SecondResponsibleOperationStaff,\r\n\t\tFIRST_VALUE(SQ.IsSecondNotPickupApprovedBySystem) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.IsSecondNotPickupApprovedBySystem DESC) AS IsSecondNotPickupApprovedBySystem\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tuorh.DispatchRequestId,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.CreateDatePersian ELSE NULL END SecondNotPickupRequestDateTimePersian,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.OperationFailureReasonId ELSE NULL END SecondNotPickupReasonOfFleet,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 7,8,9,35 ) THEN uorh.CreateDatePersian ELSE NULL END SecondNotPickupResultDateTimePersian,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.OperationFailureReasonId ELSE NULL END SecondNotPickupReasonOfOperation,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.CreatorUserName ELSE NULL END SecondResponsibleOperationStaff,\r\n\t\t\tCASE WHEN uorh.OperationTypeId = 8 AND CreatorUserName = \u0027system|system\u0027 THEN 1 ELSE 0 END AS IsSecondNotPickupApprovedBySystem\r\n\t\tFROM CTE_Main f\r\n\t\tINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK) \r\n\t\t\tON f.DispatchRequestId = uorh.DispatchRequestId\r\n\t\t\tAND f.SecondFleetId = uorh.FleetId\r\n\t\t\tAND f.IsFleetChanged = 1\r\n\t) SQ\r\n),CTE_Final AS\r\n(\r\n\r\nSELECT \r\n\tf.DispatchRequestId,\r\n\tf.DispatchRequestStatusId,\r\n\tf.DispatchRequestStatusTitle,\r\n\tf.VendorParcelCode,\r\n\tf.ParcelReferenceCode,\r\n\tf.DeliveryStartTimePersian,\r\n\tf.DeliveryDeadLineTime,\r\n\tf.ProvinceId,\r\n\tf.ProvinceTitle,\r\n\tf.CityId,\r\n\tf.CityName,\r\n\tf.PolygonId,\r\n\tf.PolygonTitle,\r\n\tf.StoreId,\r\n\tf.StoreTitle,\r\n\tf.StoreCode,\r\n\r\n\tf.FirstShipmentNumber,\r\n\tf.FirstFleetId,\r\n\tf.FirstDriverName,\r\n\tf.FirstDriverMobile,\r\n\tff.FirstNotPickupRequestDateTimePersian,\r\n\tff.FirstNotPickupReasonOfFleet AS FirstNotPickupReasonIdOfFleet,\r\n\tofrFF.Title AS FirstNotPickupReasonTitleOfFleet, \r\n\tff.FirstNotPickupResultDateTimePersian,\r\n\tff.FirstNotPickupReasonOfOperation AS FirstNotPickupReasonIdOfOperation,\r\n\tofrFO.Title AS FirstNotPickupReasonTitleOfOperation, \r\n\tISNULL(ff.IsFirstNotPickupApprovedBySystem,0) IsFirstNotPickupApprovedBySystem,\r\n\tCASE \r\n\t\tWHEN uor.DispatchRequestId IS NULL\r\n\t\t\tTHEN 1\r\n\t\tELSE \r\n\t\t\tCASE \r\n\t\t\t\tWHEN IsRequestCanceledInFirstNotPickupRequest = 0\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\tELSE\r\n\t\t\t\t\t0\r\n\t\t\tEND\r\n\tEND AS IsFirstNotPickupRequestApproved,\r\n\tISNULL(f.IsRequestCanceledInFirstNotPickupRequest,0) IsRequestCanceledInFirstNotPickupRequest,\r\n\r\n\tf.SecondShipmentNumber,\r\n\tf.SecondFleetId,\r\n\tf.SecondDriverName,\r\n\tf.SecondDriverMobile,\r\n\tsf.SecondNotPickupRequestDateTimePersian,\r\n\tsf.SecondNotPickupReasonOfFleet AS SecondNotPickupReasonIdOfFleet,\r\n\tofrSF.Title AS SecondNotPickupReasonTitleOfFleet, \r\n\tsf.SecondNotPickupResultDateTimePersian,\r\n\tsf.SecondNotPickupReasonOfOperation AS SecondNotPickupReasonIdOfOperation,\r\n\tofrSO.Title AS SecondNotPickupReasonTitleOfOperation, \r\n\tISNULL(sf.IsSecondNotPickupApprovedBySystem,0) IsSecondNotPickupApprovedBySystem,\r\n\tCASE \r\n\t\tWHEN IsRequestCanceledInFirstNotPickupRequest = 0 AND f.DispatchRequestStatusId = 40\r\n\t\t\tTHEN 1\r\n\t\tELSE \r\n\t\t\t0\r\n\tEND AS IsSecondNotPickupRequestApproved,\r\n\r\n\tuor.CreatorUserName,\r\n\tff.FirstResponsibleOperationStaff,\r\n\tsf.SecondResponsibleOperationStaff\r\n\r\nFROM CTE_Main f\r\nLEFT JOIN CTE_UOR uor\r\n\tON f.DispatchRequestId = uor.DispatchRequestId\r\nLEFT JOIN CTE_FirstFleet ff\r\n\tON f.DispatchRequestId = ff.DispatchRequestId\r\nLEFT JOIN CTE_SecondFleet sf\r\n\tON f.DispatchRequestId = sf.DispatchRequestId\r\n\r\nLEFT JOIN DP.OperationFailureReason ofrFF (NOLOCK)\r\n\tON ff.FirstNotPickupReasonOfFleet =  ofrFF.Id\r\nLEFT JOIN DP.OperationFailureReason ofrFO (NOLOCK)\r\n\tON ff.FirstNotPickupReasonOfOperation =  ofrFO.Id\r\n\r\nLEFT JOIN DP.OperationFailureReason ofrSF (NOLOCK)\r\n\tON sf.SecondNotPickupReasonOfFleet =  ofrSF.Id\r\nLEFT JOIN DP.OperationFailureReason ofrSO (NOLOCK)\r\n\tON sf.SecondNotPickupReasonOfOperation =  ofrSO.Id\r\n)\r\nSELECT\r\n\t DispatchRequestId\t\r\n\t,DispatchRequestStatusId\t\r\n\t,DispatchRequestStatusTitle\t\r\n\t,VendorParcelCode\t\r\n\t,ParcelReferenceCode\t\r\n\t,DeliveryStartTimePersian\t\r\n\t,DeliveryDeadLineTime\t\r\n\t,ProvinceId\t\r\n\t,ProvinceTitle\t\r\n\t,CityId\t\r\n\t,CityName\t\r\n\t,PolygonId\t\r\n\t,PolygonTitle\t\r\n\t,StoreId\t\r\n\t,StoreTitle\t\r\n\t,StoreCode\t\r\n\t,FirstShipmentNumber\t\r\n\t,FirstFleetId\t\r\n\t,FirstDriverName\t\r\n\t,FirstDriverMobile\t\r\n\t,FirstNotPickupRequestDateTimePersian\t\r\n\t,FirstNotPickupReasonIdOfFleet\t\r\n\t,FirstNotPickupReasonTitleOfFleet\t\r\n\t,FirstNotPickupResultDateTimePersian\t\r\n\t,FirstNotPickupReasonIdOfOperation\t\r\n\t,FirstNotPickupReasonTitleOfOperation\t\r\n\t,TRIM(SUBSTRING(FirstResponsibleOperationStaff,CHARINDEX(\u0027|\u0027,FirstResponsibleOperationStaff,1)\u002B1,LEN(FirstResponsibleOperationStaff))) FirstResponsibleOperationStaff\r\n\t,IsFirstNotPickupApprovedBySystem\t\r\n\t,IsFirstNotPickupRequestApproved\t\r\n\t,IsRequestCanceledInFirstNotPickupRequest\t\r\n\t,SecondShipmentNumber\t\r\n\t,SecondFleetId\t\r\n\t,SecondDriverName\t\r\n\t,SecondDriverMobile\t\r\n\t,SecondNotPickupRequestDateTimePersian\t\r\n\t,SecondNotPickupReasonIdOfFleet\t\r\n\t,SecondNotPickupReasonTitleOfFleet\t\r\n\t,SecondNotPickupResultDateTimePersian\t\r\n\t,SecondNotPickupReasonIdOfOperation\t\r\n\t,SecondNotPickupReasonTitleOfOperation\t\r\n\t,TRIM(SUBSTRING(SecondResponsibleOperationStaff,CHARINDEX(\u0027|\u0027,SecondResponsibleOperationStaff,1)\u002B1,LEN(SecondResponsibleOperationStaff))) SecondResponsibleOperationStaff\r\n\t,IsSecondNotPickupApprovedBySystem\t\r\n\t,IsSecondNotPickupRequestApproved\r\nFROM\r\n(\r\n\tSELECT \r\n\t\t DispatchRequestId\t\r\n\t\t,DispatchRequestStatusId\t\r\n\t\t,DispatchRequestStatusTitle\t\r\n\t\t,VendorParcelCode\t\r\n\t\t,ParcelReferenceCode\t\r\n\t\t,DeliveryStartTimePersian\t\r\n\t\t,DeliveryDeadLineTime\t\r\n\t\t,ProvinceId\t\r\n\t\t,ProvinceTitle\t\r\n\t\t,CityId\t\r\n\t\t,CityName\t\r\n\t\t,PolygonId\t\r\n\t\t,PolygonTitle\t\r\n\t\t,StoreId\t\r\n\t\t,StoreTitle\t\r\n\t\t,StoreCode\t\r\n\t\t,FirstShipmentNumber\t\r\n\t\t,FirstFleetId\t\r\n\t\t,FirstDriverName\t\r\n\t\t,FirstDriverMobile\t\r\n\t\t,FirstNotPickupRequestDateTimePersian\t\r\n\t\t,FirstNotPickupReasonIdOfFleet\t\r\n\t\t,FirstNotPickupReasonTitleOfFleet\t\r\n\t\t,FirstNotPickupResultDateTimePersian\t\r\n\t\t,FirstNotPickupReasonIdOfOperation\t\r\n\t\t,FirstNotPickupReasonTitleOfOperation\t\r\n\t\t,CASE WHEN IsFirstNotPickupRequestApproved = 0 THEN CreatorUserName ELSE FirstResponsibleOperationStaff END AS FirstResponsibleOperationStaff\r\n\t\t,IsFirstNotPickupApprovedBySystem\t\r\n\t\t,IsFirstNotPickupRequestApproved\t\r\n\t\t,IsRequestCanceledInFirstNotPickupRequest\t\r\n\t\t,SecondShipmentNumber\t\r\n\t\t,SecondFleetId\t\r\n\t\t,SecondDriverName\t\r\n\t\t,SecondDriverMobile\t\r\n\t\t,SecondNotPickupRequestDateTimePersian\t\r\n\t\t,SecondNotPickupReasonIdOfFleet\t\r\n\t\t,SecondNotPickupReasonTitleOfFleet\t\r\n\t\t,SecondNotPickupResultDateTimePersian\t\r\n\t\t,SecondNotPickupReasonIdOfOperation\t\r\n\t\t,SecondNotPickupReasonTitleOfOperation\t\r\n\t\t,\r\n\t\tCASE \r\n\t\t\tWHEN SecondNotPickupRequestDateTimePersian IS NOT NULL \r\n\t\t\tTHEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN IsSecondNotPickupRequestApproved = 0 \r\n\t\t\t\t\t\tTHEN CreatorUserName \r\n\t\t\t\t\tELSE \r\n\t\t\t\t\t\tSecondResponsibleOperationStaff \r\n\t\t\t\tEND\r\n\t\t\tELSE NULL\r\n\t\tEND AS SecondResponsibleOperationStaff\r\n\t\t,IsSecondNotPickupApprovedBySystem\t\r\n\t\t,IsSecondNotPickupRequestApproved\r\n\tFROM CTE_Final\r\n  WHERE \r\n\t\t(DispatchRequestStatusId = @DispatchRequestStatusId or ISNULL(@DispatchRequestStatusId,0) = 0)\t\r\n\tAND (VendorParcelCode = @VendorParcelCode or ISNULL(@VendorParcelCode,0) = 0) \r\n\tAND (ParcelReferenceCode = @ParcelReferenceCode or ISNULL(@ParcelReferenceCode,0) = 0) \r\n\tAND (ProvinceId = @ProvinceId or ISNULL(@provinceId,0) = 0) \r\n\tAND (CityId = @CityId OR ISNULL(@CityId,0) = 0)\t\r\n\tAND (FirstShipmentNumber = @ShipmentNumber  OR SecondShipmentNumber= @ShipmentNumber or ISNULL(@ShipmentNumber,0) = 0) \r\n\tAND (FirstFleetId = @FleetId OR SecondFleetId = @FleetId or ISNULL(@FleetId,0) = 0) \r\n\tAND (FirstNotPickupReasonIdOfFleet = @NotPickupReasonIdOfFleet or SecondNotPickupReasonIdOfFleet = @NotPickupReasonIdOfFleet or ISNULL(@NotPickupReasonIdOfFleet ,0) = 0)\t \r\n\tAND (FirstNotPickupReasonIdOfOperation = @NotPickupReasonIdOfOperation or SecondNotPickupReasonIdOfOperation = @NotPickupReasonIdOfOperation or ISNULL(@NotPickupReasonIdOfOperation ,0) = 0) \r\n\tAND (FirstNotPickupRequestDateTimePersian = @NotPickupRequestDateTimePersian or SecondNotPickupResultDateTimePersian = @NotPickupRequestDateTimePersian OR ISNULL(@NotPickupRequestDateTimePersian ,0) = 0)\r\n\t \r\n)SQ\r\n\r\n\r\n\r\nDROP TABLE IF EXISTS #STOREIDS,#PolygonIDS\r\n"},{"Name":"Get_NotPickUpDispatchRequestList","Schema":"dbo","Definition":"\r\n/*\r\nDECLARE @Result NVARCHAR(MAX),@TotalCount INT\r\nEXEC [Get_NotPickUpDispatchRequestList] @OperationStaffId = 150 ,@PolygonIds = \u002734,59\u0027 , @PageIndex = 0 , @PageSize = 1 , @Result = @Result OUTPUT--,@TotalCount = @TotalCount OUTPUT\r\nSELECT @Result,@TotalCount\r\n*/\r\n\r\nCREATE   PROCEDURE [dbo].[Get_NotPickUpDispatchRequestList]\r\n\r\n\t@OperationStaffId INT ,\r\n    @ParcelReferenceCode BIGINT = NULL,\r\n\t@VendorParcelCode VARCHAR(32) = NULL,\r\n    @ShipmentNumber BIGINT = NULL,\r\n    --@RequestTypes VARCHAR(20) = NULL,\r\n    @ProvinceId Tinyint = NULL,\r\n    @CityIds VARCHAR(MAX) = NULL,\r\n    @PolygonIds VARCHAR(MAX),\r\n    @StartDeliveryTime BIGINT = NULL,\r\n    @EndDeliveryTime BIGINT = NULL,\r\n    @FleetId INT = NULL,\r\n    --@UnsuccessfulOperationReasonId SMALLINT = NULL,\r\n    @VendorId INT = NULL,\r\n    @StoreIds VARCHAR(MAX) = NULL,\r\n    @StartCreateTime BIGINT = NULL,\r\n    @EndCreateTime BIGINT = NULL,\r\n\t@OperationFailureReasonId TINYINT = NULL,\r\n\t@CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t@OrderCategoryIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n    @PageIndex INT,\r\n\t@PageSize INT,\r\n\t--@TotalCount INT OUTPUT,\r\n\t@Result\tNVARCHAR(MAX) = NULL OUTPUT /*,\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,   \r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0 OUTPUT*/\r\n\r\nAS\r\nBEGIN\r\n\r\nDECLARE\r\n\t@TotalCount INT = 0,\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT = 0,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0,   \r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0\r\n\r\nSELECT\r\n\t@ParcelReferenceCode\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n    @VendorParcelCode\t\t\t\t\t    =ISNULL(@VendorParcelCode,\u00270\u0027),                \r\n\t@ShipmentNumber\t\t\t\t\t\t\t=ISNULL(@ShipmentNumber,0),\r\n    @ProvinceId\t\t\t\t\t\t\t\t=ISNULL(@ProvinceId,0),\r\n\t@CityIds\t\t\t\t\t\t\t\t=ISNULL(@CityIds,\u00270\u0027),\r\n\t@PolygonIds\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),        \r\n\t@StartDeliveryTime\t\t\t\t\t\t=ISNULL(@StartDeliveryTime,0),\r\n\t@EndDeliveryTime\t\t\t\t\t\t=ISNULL(@EndDeliveryTime,0),\t\t\t\t\r\n\t@FleetId\t\t\t\t\t\t\t\t=ISNULL(@FleetId,0),\t\t\t\t\r\n\t@VendorId\t\t\t\t\t\t        =ISNULL(@VendorId,0),\r\n    @StoreIds\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n    @StartCreateTime\t\t\t\t\t\t=ISNULL(@StartCreateTime,\u00270\u0027),\r\n    @EndCreateTime\t\t\t\t\t\t    =ISNULL(@EndCreateTime,\u00270\u0027),\r\n\t@OperationFailureReasonId\t\t\t\t=ISNULL(@OperationFailureReasonId,0),\r\n\t@CourierRequestTypeIds\t\t\t\t\t=ISNULL(@CourierRequestTypeIds,\u00270\u0027),\r\n\t@OrderCategoryIds = ISNULL(@OrderCategoryIds,\u00270\u0027)\r\n\r\nDECLARE @PolygonId TABLE\r\n(\r\n\tId SMALLINT\r\n)\r\nINSERT INTO @PolygonId\r\nSELECT \r\n\tCAST(ISNULL(value,0) AS SMALLINT)\r\nFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\t\r\nDECLARE @StoreId TABLE\r\n(\r\n\tId INT\r\n)\r\nINSERT INTO @StoreId\r\nSELECT \r\n\tCAST(ISNULL(value,0) AS INT)\r\nFROM string_split(@StoreIds,\u0027,\u0027)\r\n\r\nDROP TABLE IF EXISTS #CityId\r\nCREATE TABLE #CityId\r\n(\r\n\tId SMALLINT\r\n)\r\nINSERT INTO #CityId\r\nSELECT \r\n\tc.Id\r\nFROM CS_Public.HAF.City c (NOLOCK)\r\nINNER JOIN string_split(@CityIds,\u0027,\u0027) ss\r\n\tON c.Id = ss.value\r\n\tOR @CityIds = \u00270\u0027\r\n\r\nDROP TABLE IF EXISTS #CourierRequestTypeId\r\nCREATE TABLE #CourierRequestTypeId\r\n(\r\n\tId TinyInt\r\n)\r\nINSERT INTO #CourierRequestTypeId\r\nSELECT \r\n\tcrt.Id\r\nFROM CS_Public.PUB.CourierRequestType crt (NOLOCK)\r\nINNER JOIN string_split(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\tON crt.Id = ss.value\r\n\tOR @CourierRequestTypeIds = \u00270\u0027\r\n\r\n\tDROP TABLE IF EXISTS #OrderCategoryId\r\nSELECT\r\n\toc.Id\r\nINTO #OrderCategoryId\r\nFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\nINNER JOIN string_split(@OrderCategoryIds,\u0027,\u0027) ss\r\n\tON oc.Id = ss.value\r\n\tOR @OrderCategoryIds = \u00270\u0027\r\n\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-12,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-12, 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE \r\n\t\t@Now int=LEFT(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),8),\r\n\t\t@Yesterday int = LEFT(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),8)\r\n\r\n\t;WITH CTE_DR AS\r\n\t(\r\n\tSELECT\t\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\tddr.CourierRequestTypeId ,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tsdp.OperationTypeId,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id --AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tLEFT JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tLEFT JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tLEFT JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #CityId cid\r\n\t\tON dp.CityId = cid.Id\r\n\tINNER JOIN #CourierRequestTypeId crtId\r\n\t\tON ddr.CourierRequestTypeId = crtId.ID\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\tAND((ps.StoreId IN(SELECT Id FROM @StoreId)\t\t\t)\t\t\t\tOR (ISNULL(@StoreIds,\u00270\u0027)=\u00270\u0027))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\tAND\r\n\t(\r\n\t\t(ddr.DispatchRequestStatusId in (5,6) AND CAST(DeliveryStartTime/1000000000 AS BIGINT)IN(@Now,@Yesterday))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51))\r\n\t\tOR\r\n\t\t( (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) )\r\n\t\tOR\r\n\t\t(  sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) )\r\n\t\tOR\r\n\t\t( sdp.OperationTypeId = (10) AND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) )\r\n\t)\r\n\t)\r\n\r\n\r\n\tSELECT \r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date IN(@Now,@Yesterday) THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\t\tCASE WHEN ddr.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\t\tCASE WHEN \r\n\t\t\t\tddr.OperationTypeId = (10)  \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount\r\n\t\tFROM CTE_DR ddr\r\n\t) SQ\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\nDROP TABLE IF EXISTS #Final\r\nSELECT\r\n\tdr.ID AS DispatchRequestId,\r\n\tdr.DispatchRequestStatusId,\r\n\tdr.ParcelReferenceCode,\r\n\tdr.CourierRequestTypeId,\r\n\tdr.VendorParcelCode,\r\n\tdr.DeliveryStartTime,\r\n\tdr.DeliveryDeadLineTime,\r\n\tdr.ClientAddress,\r\n\tdr.DeliveryStartTimePersian,\r\n\tdr.DeliveryDeadLineTimePersian,\r\n\r\n\tsh.ID AS ShipmentId,\r\n\tsh.ShipmentStatusId,\r\n\tsh.ShipmentNumber,\r\n\tsh.TotalEstimatedDurationSeconds,\r\n\tsh.TotalDistanceMeter,\r\n\tc.ProvinceId,\r\n\tpr.Name AS ProvinceTitle,\r\n\ts.CityId,\r\n\tc.Name AS CityTitle,\r\n\tps.PolygonId,\r\n\tp.Title AS PolygonTitle,\r\n\tdr.VendorId,\r\n\tps.StoreId,\r\n\ts.Title AS StoreTitle,\r\n\ts.Location,\r\n\tsh.FleetId,\r\n\tsh.DeliveryServiceProviderId,\r\n\ts.OrderCategoryId,\r\n\toc.Title AS OrderCategoryTitle,\r\n\tDATEDIFF(SECOND,GETDATE(),DATEADD(MINUTE,stbi.NotPickupRequestReviewThresholdMinutes,sdp.BikerWaitingStartTime)) AS RemainedReviewTimeSeconds,\r\n\tDENSE_RANK() OVER ( ORDER BY DATEDIFF(SECOND,DATEADD(MINUTE,stbi.NotPickupRequestReviewThresholdMinutes,sdp.BikerWaitingStartTime),GETDATE()) DESC ) D_Rank\r\nINTO #Final\r\nFROM DP.DispatchRequest dr (NOLOCK)\r\nINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\tON dr.ID = sdpdr.DispatchRequestId\r\nINNER JOIN DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\nINNER JOIN DP.Shipment sh WITH(NOLOCK)\r\n\tON sdp.ShipmentId = sh.Id\r\nINNER JOIN #CourierRequestTypeId crtId\r\n\tON dr.CourierRequestTypeId = crtId.ID\r\nINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\tON dr.PolygonStoreId = ps.ID\r\nINNER JOIN DP.Polygon p (NOLOCK)\r\n\tON ps.PolygonId = p.ID\r\nINNER JOIN DP.Store s (NOLOCK)\r\n\tON ps.StoreId = s.ID\r\nINNER JOIN #CityId cid\r\n\tON s.CityId = cid.Id\r\nINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\tON s.CityId = c.ID\r\nINNER JOIN CS_Public.HAF.Province pr (NOLOCK)\r\n\tON c.ProvinceId = pr.ID\r\nINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\tON dr.VendorId = v.Id\r\nINNER JOIN #OrderCategoryId ocID\r\n\tON s.OrderCategoryId = ocID.Id\r\nINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\tON s.OrderCategoryId = oc.Id\r\nINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\tON s.ID = stbi.StoreId\r\nWHERE dr.DispatchRequestStatusId IN ( 15 )\r\nAND dr.IsWaitingForSupport = 1\r\nAND sdp.BikerWaitingStartTime IS NOT NULL\r\nAND sdp.BikerWaitingDuration IS NULL\r\nAND sdp.OperationTypeId = 5\r\nAND sdp.ShipmentDestinationPointStatusId = 15\r\nAND (dr.ParcelReferenceCode = @ParcelReferenceCode OR @ParcelReferenceCode = 0)\r\nAND (dr.VendorParcelCode = @VendorParcelCode OR @VendorParcelCode = \u00270\u0027)\r\nAND (c.ProvinceId = @ProvinceId OR @ProvinceId = 0)\r\nAND (ps.PolygonId in (SELECT Id FROM @PolygonId) )\r\nAND ((dr.DeliveryStartTime \u003E= @StartDeliveryTime and dr.DeliveryDeadLineTime \u003C= @EndDeliveryTime) OR (@StartDeliveryTime = 0 OR @EndDeliveryTime = 0))\r\nAND (dr.VendorId = @VendorId OR @VendorId = 0)\r\nAND (ps.StoreId in (SELECT Id FROM @StoreId) OR @StoreIds = \u00270\u0027)\r\nAND (dr.CreateDate BETWEEN @StartCreateTime AND @EndCreateTime OR (@StartCreateTime = 0 OR @EndCreateTime = 0))\r\n\r\nSELECT @TotalCount =  COUNT(DISTINCT ShipmentId) FROM #Final\r\n\r\n\r\nSET @pageIndex = ISNULL(@pageIndex,0)\r\nSET @TotalCount = ISNULL(@TotalCount,0)\r\n\r\nIF ISNULL(@pageSize,0) = 0\r\nBEGIN\r\n\tIF ISNULL(@TotalCount,0) = 0\r\n\t\tSET @pageSize = 1\r\n\tELSE\r\n\t\tSET @pageSize = @TotalCount\r\nEND\r\n\r\nDECLARE @FromRow INT = 0, @ToRow INT = 0\r\nSET @FromRow = @pageIndex * @pageSize\r\nSET @ToRow = ( @pageIndex * @pageSize ) \u002B @pageSize\r\n\r\nIF @TotalCount = 0\r\nBEGIN\r\n\tSET @Result = \u0027{}\u0027\r\nEND\r\nELSE\r\nBEGIN\r\n\r\n\r\n;WITH CTE_Output AS\r\n(\r\n\tSELECT * \r\n\tFROM #Final\r\n\tWHERE D_Rank BETWEEN @FromRow AND @ToRow\r\n)\r\nSELECT @Result = \r\n(\r\n\tSELECT \r\n\t\t*,\r\n\t\t(\r\n\t\t\tSELECT DISTINCT\r\n\t\t\t\tDispatchRequestId AS Id,\r\n\t\t\t\tdispatchRequestStatusId,\r\n\t\t\t\tdrs.Title AS dispatchRequestStatusTitle,\r\n\t\t\t\tparcelReferenceCode,\r\n\t\t\t\tcourierRequestTypeId,\r\n\t\t\t\tcrt.Title AS courierRequestTypeTitle,\r\n\t\t\t\tFORMAT(DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027) deliveryStartTimeStr,\r\n\t\t\t\tFORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) deliveryDeadLineTimeStr,\r\n\t\t\t\tclientAddress,\r\n\t\t\t\tFORMAT(DeliveryStartTimePersian,\u0027####/##/## ##:##:##\\.###\u0027) deliveryStartTimePersianStr,\r\n\t\t\t\tFORMAT(DeliveryDeadLineTimePersian,\u0027####/##/## ##:##:##\\.###\u0027) deliveryDeadLineTimePersianStr,\r\n\t\t\t\tFORMAT(uorh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS notPickupRequestDateTimeStr,\r\n\t\t\t\tuorh.OperationFailureReasonId AS notPickupRequestReasonId,\r\n\t\t\t\tuorh.OperationFailureReasonTitle AS notPickupRequestReasonTitle,\r\n\t\t\t\tvendorParcelCode\r\n\t\t\t\tFROM CTE_Output dr\r\n\t\t\t\tINNER JOIN CS_Public.PUB.CourierRequestType crt WITH(NOLOCK)\r\n\t\t\t\t\tON dr.CourierRequestTypeId = crt.Id\r\n\t\t\t\tINNER JOIN DP.DispatchRequestStatus drs WITH(NOLOCK)\r\n\t\t\t\t\tON dr.DispatchRequestStatusId = drs.Id\r\n\t\t\t\tOUTER APPLY \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT TOP 1\r\n\t\t\t\t\t\tuorh.OperationFailureReasonId,\r\n\t\t\t\t\t\tofr.Title AS OperationFailureReasonTitle,\r\n\t\t\t\t\t\tuorh.CreateDatePersian\r\n\t\t\t\t\tFROM DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK)\r\n\t\t\t\t\tINNER JOIN DP.OperationFailureReason ofr (NOLOCK)\t \r\n\t\t\t\t\t\tON ofr.id = uorh.OperationFailureReasonId  \r\n\t\t\t\t\tWHERE uorh.OperationTypeId = 6\r\n\t\t\t\t\tAND uorh.DispatchRequestId = dr.DispatchRequestId\r\n\t\t\t\t\tAND uorh.FleetId = dr.FleetId\r\n\t\t\t\t\tORDER BY uorh.ID DESC\r\n\t\t\t\t) UORH\r\n\t\t\t\tWHERE dr.ShipmentId = SQ.Id\r\n\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t\t) AS dispatchRequests\r\n\tFROM\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tsh.shipmentId AS Id,\r\n\t\t\tsh.shipmentStatusId AS statusId,\r\n\t\t\tsh.shipmentNumber,\r\n\t\t\tsh.totalEstimatedDurationSeconds,\r\n\t\t\tsh.totalDistanceMeter,\r\n\t\t\tsh.provinceId,\r\n\t\t\tsh.provinceTitle,\r\n\t\t\tsh.cityId,\r\n\t\t\tsh.cityTitle,\r\n\t\t\tsh.polygonId,\r\n\t\t\tsh.polygonTitle,\r\n\t\t\tsh.vendorId,\r\n\t\t\tvnd.BrandName AS vendorBrandName,\r\n\t\t\tsh.storeId,\r\n\t\t\tsh.storeTitle,\r\n\t\t\tsh.Location.STY AS storeLocationLat,\r\n\t\t\tsh.Location.STX AS storeLocationLong,\r\n\t\t\tsh.fleetId,\r\n\t\t\tf.driverId,\r\n\t\t\t(d.FirstName \u002B \u0027 \u0027 \u002B d.LastName) AS driverName,\r\n\t\t\t\u00270\u0027\u002BCAST(d.Mobile AS VARCHAR(20)) AS driverMobile,\r\n\t\t\tv.vehicleTypeId,\r\n\t\t\tv.plateNumber,\r\n\t\t\tsh.deliveryServiceProviderId,\r\n\t\t\tsh.orderCategoryId,\r\n\t\t\tsh.orderCategoryTitle,\r\n\t\t\tsh.remainedReviewTimeSeconds\r\n\t\tFROM CTE_Output sh\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet f WITH(NOLOCK)\r\n\t\t\tON sh.FleetId = f.Id\r\n\t\tINNER JOIN CS_DriverManagement.DM.Driver d WITH(NOLOCK)\r\n\t\t\tON f.DriverId = d.Id\r\n\t\tINNER JOIN CS_DriverManagement.DM.Vehicle v WITH(NOLOCK)\r\n\t\t\tON f.VehicleId = v.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor vnd WITH(NOLOCK)\r\n\t\t\tON sh.VendorId = vnd.Id\r\n\t) SQ\r\n\r\n\tFOR JSON PATH , INCLUDE_NULL_VALUES , ROOT (\u0027Shipments\u0027)\r\n)\r\n\r\nEND\r\n\r\n\r\nSET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\nSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\nSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\nSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\nSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\nSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\nSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\n\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.totalCount\u0027,@TotalCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.pageSize\u0027,@PageSize  )\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.currentPage\u0027,@PageIndex )\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.totalPages\u0027,(@TotalCount \u002B @PageSize - 1) / @PageSize)\r\n\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.delayedDeliveryRequestCount\u0027,@DelayedDeliveryRequestCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.delayedPickupCount\u0027,@DelayedPickupCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.returnedRequestCount\u0027,@ReturnedRequestCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.assignedDispatchRequestCount\u0027,@AssignedDispatchRequestCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.unassignedDispatchRequestCount\u0027,@UnassignedDispatchRequestCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.unassignedReturnAndReplacementRequestCount\u0027,@UnassignedReturnAndReplacementRequestCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.notPickUpRequestCount\u0027,@NotPickUpRequestCount)\r\n\r\n\r\nSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\nSET @Result = REPLACE(@Result,\u0027\u0022dispatchRequests\u0022:\u0022{\u0027,\u0027\u0022dispatchRequests\u0022:{\u0027)\r\nSET @Result = REPLACE(@Result,\u0027}\u0022}\u0027,\u0027}}\u0027)\r\n\r\nEND\r\n"},{"Name":"Get_NotPickUpDispatchRequestList_Backup","Schema":"dbo","Definition":"\r\n/*\r\nDECLARE @Result NVARCHAR(MAX),@TotalCount INT\r\nEXEC [Get_NotPickUpDispatchRequestList] @OperationStaffId = 150 ,@PolygonIds = \u002734,59\u0027 , @PageIndex = 0 , @PageSize = 1 , @Result = @Result OUTPUT,@TotalCount = @TotalCount OUTPUT\r\nSELECT @Result,@TotalCount\r\n*/\r\n\r\nCREATE     PROCEDURE [dbo].[Get_NotPickUpDispatchRequestList_Backup]\r\n\t@OperationStaffId INT ,\r\n    @ParcelReferenceCode BIGINT = NULL,\r\n\t@VendorParcelCode VARCHAR(32) = NULL,\r\n    @ShipmentNumber BIGINT = NULL,\r\n    --@RequestTypes VARCHAR(20) = NULL,\r\n    @ProvinceId Tinyint = NULL,\r\n    @CityIds VARCHAR(MAX) = NULL,\r\n    @PolygonIds VARCHAR(MAX),\r\n    @StartDeliveryTime BIGINT = NULL,\r\n    @EndDeliveryTime BIGINT = NULL,\r\n    @FleetId INT = NULL,\r\n    --@UnsuccessfulOperationReasonId SMALLINT = NULL,\r\n    @VendorId INT = NULL,\r\n    @StoreIds VARCHAR(MAX) = NULL,\r\n    @StartCreateTime BIGINT = NULL,\r\n    @EndCreateTime BIGINT = NULL,\r\n\t@OperationFailureReasonId TINYINT = NULL,\r\n\t@CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t@OrderCategoryIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n    @PageIndex INT,\r\n\t@PageSize INT,\r\n\t@TotalCount INT OUTPUT,\r\n\t@Result\tNVARCHAR(MAX) = NULL OUTPUT ,\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,   \r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0 OUTPUT\r\n\r\nAS \r\nBEGIN\r\n\r\nSELECT\r\n\t@ParcelReferenceCode\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n    @VendorParcelCode\t\t\t\t\t    =ISNULL(@VendorParcelCode,\u00270\u0027),                \r\n\t@ShipmentNumber\t\t\t\t\t\t\t=ISNULL(@ShipmentNumber,0),\r\n    --@RequestTypes\t\t\t\t\t\t\t=ISNULL(@RequestTypes,\u00270\u0027),\r\n    @ProvinceId\t\t\t\t\t\t\t\t=ISNULL(@ProvinceId,0),\r\n\t@CityIds\t\t\t\t\t\t\t\t=ISNULL(@CityIds,\u00270\u0027),\r\n\t@PolygonIds\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),        \r\n\t@StartDeliveryTime\t\t\t\t\t\t=ISNULL(@StartDeliveryTime,0),\r\n\t@EndDeliveryTime\t\t\t\t\t\t=ISNULL(@EndDeliveryTime,0),\t\t\t\t\r\n\t@FleetId\t\t\t\t\t\t\t\t=ISNULL(@FleetId,0),\t\t\t\t\r\n\t@VendorId\t\t\t\t\t\t        =ISNULL(@VendorId,0),\r\n    @StoreIds\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n    @StartCreateTime\t\t\t\t\t\t=ISNULL(@StartCreateTime,\u00270\u0027),\r\n    @EndCreateTime\t\t\t\t\t\t    =ISNULL(@EndCreateTime,\u00270\u0027),\r\n\t@OperationFailureReasonId\t\t\t\t=ISNULL(@OperationFailureReasonId,0),\r\n\t@CourierRequestTypeIds\t\t\t\t\t=ISNULL(@CourierRequestTypeIds,\u00270\u0027),\r\n\t@OrderCategoryIds = ISNULL(@OrderCategoryIds,\u00270\u0027)\r\n\r\n--DECLARE @AutomaticConfirmFirstNotPickupMinutes INT,\r\n--\t\t@AutomaticConfirmNotPickupMinutes INT\r\n\r\n--SELECT @AutomaticConfirmFirstNotPickupMinutes = Value FROM CS_Public.HAF.Setting WHERE NAME = \u0027DispatchRequestSettings.AutomaticConfirmFirstNotPickupMinutes\u0027\r\n--SELECT @AutomaticConfirmNotPickupMinutes = Value FROM CS_Public.HAF.Setting WHERE NAME = \u0027DispatchRequestSettings.AutomaticConfirmNotPickupMinutes\u0027\r\n\r\n--SET @AutomaticConfirmFirstNotPickupMinutes = ISNULL(@AutomaticConfirmFirstNotPickupMinutes,0)\r\n--SET @AutomaticConfirmNotPickupMinutes = ISNULL(@AutomaticConfirmNotPickupMinutes,0)\r\n\r\nDECLARE @PolygonId TABLE\r\n(\r\n\tId SMALLINT\r\n)\r\nINSERT INTO @PolygonId\r\nSELECT \r\n\tCAST(ISNULL(value,0) AS SMALLINT)\r\nFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\t\r\nDECLARE @StoreId TABLE\r\n(\r\n\tId SMALLINT\r\n)\r\nINSERT INTO @StoreId\r\nSELECT \r\n\tCAST(ISNULL(value,0) AS SMALLINT)\r\nFROM string_split(@StoreIds,\u0027,\u0027)\r\n\r\n--DECLARE @RequestType TABLE\r\n--(\r\n--\tId SMALLINT\r\n--)\r\n--INSERT INTO @RequestType\r\n--SELECT \r\n--\tCAST(ISNULL(value,0) AS SMALLINT)\r\n--FROM string_split(@RequestTypes,\u0027,\u0027)\r\n\r\n\r\nDROP TABLE IF EXISTS #CityId\r\nCREATE TABLE #CityId\r\n(\r\n\tId SMALLINT\r\n)\r\nINSERT INTO #CityId\r\nSELECT \r\n\tc.Id\r\nFROM CS_Public.HAF.City c (NOLOCK)\r\nINNER JOIN string_split(@CityIds,\u0027,\u0027) ss\r\n\tON c.Id = ss.value\r\n\tOR @CityIds = \u00270\u0027\r\n\r\nDROP TABLE IF EXISTS #CourierRequestTypeId\r\nCREATE TABLE #CourierRequestTypeId\r\n(\r\n\tId TinyInt\r\n)\r\nINSERT INTO #CourierRequestTypeId\r\nSELECT \r\n\tcrt.Id\r\nFROM CS_Public.PUB.CourierRequestType crt (NOLOCK)\r\nINNER JOIN string_split(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\tON crt.Id = ss.value\r\n\tOR @CourierRequestTypeIds = \u00270\u0027\r\n\r\nSELECT\r\n\toc.Id\r\nINTO #OrderCategoryId\r\nFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\nINNER JOIN string_split(@OrderCategoryIds,\u0027,\u0027) ss\r\n\tON oc.Id = ss.value\r\n\tOR @OrderCategoryIds = \u00270\u0027\r\n\r\n--SET @DelayedDeliveryRequestCount = NULL\r\n--SET @DelayedPickupCount = NULL\r\n--SET @ReturnedRequestCount = NULL\r\n--SET @AssignedDispatchRequestCount = NULL\r\n--SET @UnassignedDispatchRequestCount = NULL\r\n--SET @UnassignedReturnAndReplacementRequestCount = NULL\r\n--SET @NotPickupRequestCount = NULL\r\n\r\n--EXEC Get_OperationPanel_Count\r\n--\t@OperationStaffId = @OperationStaffId,\r\n--\t@CityIds = @CityIds,\r\n--\t@PolygonIds = @PolygonIds,\r\n--\t@VendorID = @VendorID,\r\n--\t@UnassignedDispatchRequestCount\t\t\t\t = @UnassignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n--\t@AssignedDispatchRequestCount\t\t\t\t = @AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n--\t@ReturnedRequestCount\t\t\t\t\t\t = @ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n--\t@DelayedDeliveryCount\t\t\t\t\t\t = @delayedDeliveryRequestCount\t\t\t\t\tOUTPUT,\r\n--\t@UnassignedReturnAndReplacementRequestCount  = @UnassignedReturnAndReplacementRequestCount\tOUTPUT,\r\n--\t--@NotPickupRequestCount\t\t\t\t\t\t = @NotPickupRequestCount\t\t\t\t\t\tOUTPUT,\r\n--\t@DelayedPickupCount\t\t\t\t\t\t\t = @DelayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\r\n--SELECT \r\n--\t@UnassignedDispatchRequestCount = ISNULL(@UnassignedDispatchRequestCount,0),\t\t\t\r\n--\t@AssignedDispatchRequestCount = ISNULL(@AssignedDispatchRequestCount,0),\t\t\t\t\r\n--\t@ReturnedRequestCount = ISNULL(@ReturnedRequestCount,0),\t\t\t\t\t\r\n--\t@delayedDeliveryRequestCount = ISNULL(@delayedDeliveryRequestCount,0),\t\t\t\t\t\t\r\n--\t@UnassignedReturnAndReplacementRequestCount = ISNULL(@UnassignedReturnAndReplacementRequestCount,0),\t\r\n--\t--@NotPickupRequestCount = ISNULL(@NotPickupRequestCount,0),\t\t\t\t\t\t\r\n--\t@DelayedPickupCount = ISNULL(@DelayedPickupCount,0)\t\t\r\n\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-12,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-12, 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE \r\n\t\t@Now int=LEFT(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),8),\r\n\t\t@Yesterday int = LEFT(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),8)\r\n\r\n\t;WITH CTE_DR AS\r\n\t(\r\n\tSELECT\t\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\tddr.CourierRequestTypeId ,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tsdp.OperationTypeId,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tLEFT JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tLEFT JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tLEFT JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #CityId cid\r\n\t\tON dp.CityId = cid.Id\r\n\tINNER JOIN #CourierRequestTypeId crtId\r\n\t\tON ddr.CourierRequestTypeId = crtId.ID\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\tAND((ps.StoreId IN(SELECT Id FROM @StoreId)\t\t\t)\t\t\t\tOR (ISNULL(@StoreIds,\u00270\u0027)=\u00270\u0027))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\r\n\tAND\r\n\t(\r\n\t\t(ddr.DispatchRequestStatusId in (5,6) AND CAST(DeliveryStartTime/1000000000 AS BIGINT)IN(@Now,@Yesterday))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51))\r\n\t\tOR\r\n\t\t( (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) )\r\n\t\tOR\r\n\t\t(  sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) )\r\n\t\tOR\r\n\t\t( sdp.OperationTypeId = (10) AND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) )\r\n\t)\r\n\t)\r\n\r\n\r\n\tSELECT \r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date IN(@Now,@Yesterday) THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t\t\tCASE WHEN ddr.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t\t\tCASE WHEN \r\n\t\t\t\tddr.OperationTypeId = (10)  \r\n\t\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount\r\n\t\tFROM CTE_DR ddr\r\n\t) SQ\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\nDROP TABLE IF EXISTS #Final,#Output\r\n\r\nDECLARE \r\n\t@DRSetting SMALLINT\r\n\r\nSELECT \r\n\t@DRSetting = Value \r\nFROM CS_Public.HAF.Setting s (NOLOCK)\r\nWHERE s.Name = \u0027DispatchRequestSettings.AutomaticConfirmNotPickupMinutes\u0027\r\n\r\nSET @DRSetting = ISNULL(@DRSetting,0)\r\n\r\n; WITH CTE_DR AS\r\n(\r\n\tSELECT \r\n\t\tdr.Id,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.VendorId,\r\n\t\tv.BrandName AS VendorBrandName,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\tdr.DeliveryStartTimePersian,\r\n\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\tdr.CreateDatePersian,\r\n\t\tc.ProvinceId,\r\n\t\tpr.Name AS ProvinceTitle,\r\n\t\ts.CityId,\r\n\t\tc.Name AS CityTitle,\r\n\t\tps.PolygonId,\r\n\t\tp.Title AS PolygonTitle,\r\n\t\tps.StoreId,\r\n\t\ts.Title AS StoreTitle,\r\n\t\tdr.AssignmentTryCount,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdr.UpdateDate,\r\n\t\tdr.UpdateDatePersian,\r\n\t\ts.OrderCategoryId,\r\n\t\toc.Title AS OrderCategoryTitle\r\n\tFROM DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN #CourierRequestTypeId crtId\r\n\t\tON dr.CourierRequestTypeId = crtId.ID\r\n\tINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\tON ps.StoreId = s.ID\r\n\tINNER JOIN #CityId cid\r\n\t\tON s.CityId = cid.Id\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\t\tON s.CityId = c.ID\r\n\tINNER JOIN CS_Public.HAF.Province pr (NOLOCK)\r\n\t\tON c.ProvinceId = pr.ID\r\n\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\tON dr.VendorId = v.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tON s.OrderCategoryId = oc.Id\r\n\tWHERE dr.DispatchRequestStatusId IN ( 15,16 )\r\n\tAND dr.IsWaitingForSupport = 1\r\n    AND (dr.ParcelReferenceCode = @ParcelReferenceCode OR @ParcelReferenceCode = 0)\r\n    AND (dr.VendorParcelCode = @VendorParcelCode OR @VendorParcelCode = \u00270\u0027)\r\n    --AND (dr.CourierRequestTypeId in (SELECT Id FROM @RequestType) OR @RequestTypes = \u00270\u0027)\r\n    AND (c.ProvinceId = @ProvinceId OR @ProvinceId = 0)\r\n    AND (ps.PolygonId in (SELECT Id FROM @PolygonId) )\r\n    AND ((dr.DeliveryStartTime \u003E= @StartDeliveryTime and dr.DeliveryDeadLineTime \u003C= @EndDeliveryTime) OR (@StartDeliveryTime = 0 OR @EndDeliveryTime = 0))\r\n    AND (dr.VendorId = @VendorId OR @VendorId = 0)\r\n    AND (ps.StoreId in (SELECT Id FROM @StoreId) OR @StoreIds = \u00270\u0027)\r\n\tAND (dr.CreateDate BETWEEN @StartCreateTime AND @EndCreateTime OR (@StartCreateTime = 0 OR @EndCreateTime = 0))\r\n), CTE_UOR AS\r\n(\r\n\tSELECT TOP 1 WITH TIES \r\n\t\to.Id DispatchRequestId,\r\n\t\tuorh.OperationFailureReasonId,\r\n\t\tofr.Title AS OperationFailureReasonTitle\r\n\tFROM CTE_DR o\r\n\tINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK)\r\n\t\tON o.Id = uorh.DispatchRequestId\r\n\tINNER JOIN DP.OperationFailureReason ofr (NOLOCK)\t \r\n\t\tON ofr.id = uorh.OperationFailureReasonId  \r\n\tWHERE (isnull(uorh.OperationFailureReasonId,0) = @OperationFailureReasonId OR @OperationFailureReasonId = 0)\r\n\tORDER BY ROW_NUMBER () OVER ( PARTITION BY uorh.DispatchRequestId ORDER BY uorh.CreateDate DESC , uorh.ID DESC )\r\n)\r\n\r\nSELECT \r\n\tSQ.Id,\r\n\tSQ.ParcelReferenceCode,\r\n\tSQ.VendorId,\r\n\tSQ.VendorBrandName,\r\n\tSQ.VendorParcelCode,\r\n\tSQ.CourierRequestTypeId,\r\n\tSQ.DeliveryStartTimePersian,\r\n\tSQ.DeliveryDeadLineTimePersian,\r\n\tSQ.CreateDatePersian,\r\n\tSQ.ShipmentNumber,\r\n\tSQ.ProvinceId,\r\n\tSQ.ProvinceTitle,\r\n\tSQ.CityId,\r\n\tSQ.CityTitle,\r\n\tSQ.PolygonId,\r\n\tSQ.PolygonTitle,\r\n\tSQ.StoreId,\r\n\tSQ.StoreTitle,\r\n\tSQ.FleetId,\r\n\tSQ.AssignmentTryCount,\r\n\tSQ.DispatchRequestStatusId,\r\n\tSQ.UpdateDate,\r\n\tSQ.UpdateDatePersian,\r\n\tSQ.OperationFailureReasonId,\r\n\tSQ.OperationFailureReasonTitle,\r\n\tSQ.OrderCategoryId,\r\n\tSQ.OrderCategoryTitle\r\nINTO #Final\r\nFROM\r\n(\r\n\tSELECT DISTINCT\r\n\t\tdr.Id,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.VendorId,\r\n\t\tdr.VendorBrandName,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\tdr.DeliveryStartTimePersian,\r\n\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\tdr.CreateDatePersian,\r\n\t\ts.ShipmentNumber,\r\n\t\tdr.ProvinceId,\r\n\t\tdr.ProvinceTitle,\r\n\t\tdr.CityId,\r\n\t\tdr.CityTitle,\r\n\t\tdr.PolygonId,\r\n\t\tdr.PolygonTitle,\r\n\t\tdr.StoreId,\r\n\t\tdr.StoreTitle,\r\n\t\ts.FleetId,\r\n\t\tdr.AssignmentTryCount,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdr.UpdateDate,\r\n\t\tdr.UpdateDatePersian,\r\n\t\tuor.OperationFailureReasonId,\r\n\t\tuor.OperationFailureReasonTitle,\r\n\t\tdr.OrderCategoryId,\r\n\t\tdr.OrderCategoryTitle,\r\n\t\tDENSE_RANK() OVER ( PARTITION BY dr.Id ORDER BY s.CreateDate Desc , s.Id DESC ) RowNum\r\n\tFROM CTE_DR dr\r\n\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\tON dr.ID = sdpdr.DispatchRequestId\r\n\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\tON sdpdr.ShipmentDestinationPointId = sdp.ID\r\n\tINNER JOIN DP.Shipment s (NOLOCK)\r\n\t\tON sdp.ShipmentId = s.ID\r\n\tLEFT JOIN CTE_UOR uor \r\n\t\tON dr.ID = uor.DispatchRequestId\r\n\tWHERE (s.ShipmentNumber = @ShipmentNumber OR @ShipmentNumber = 0)\r\n\tAND (s.FleetId = @FleetId OR @FleetId = 0)\r\n\tAND (isnull(uor.OperationFailureReasonId,0) = @OperationFailureReasonId OR @OperationFailureReasonId = 0)\r\n) SQ\r\nWHERE SQ.RowNum = 1\r\n\r\nSELECT @TotalCount = COUNT(DISTINCT Id), @NotPickupRequestCount = COUNT(DISTINCT Id) FROM #Final\r\nSET @TotalCount = ISNULL(@TotalCount,0)\r\n\r\nSET @pageIndex = ISNULL(@pageIndex,0)\r\n\r\nIF ISNULL(@pageSize,0) = 0\r\nBEGIN\r\n\tIF ISNULL(@TotalCount,0) = 0\r\n\t\tSET @pageSize = 1\r\n\tELSE\r\n\t\tSET @pageSize = @TotalCount\r\nEND\r\n\r\nSELECT \r\n\tId,\r\n\tParcelReferenceCode,\r\n\tVendorId,\r\n\tVendorBrandName,\r\n\tVendorParcelCode,\r\n\tCourierRequestTypeId,\r\n\tDeliveryStartTimePersian,\r\n\tDeliveryDeadLineTimePersian,\r\n\tCreateDatePersian,\r\n\tShipmentNumber,\r\n\tProvinceId,\r\n\tProvinceTitle,\r\n\tCityId,\r\n\tCityTitle,\r\n\tPolygonId,\r\n\tPolygonTitle,\r\n\tStoreId,\r\n\tStoreTitle,\r\n\tFleetId,\r\n\tAssignmentTryCount,\r\n\tDispatchRequestStatusId,\r\n\tUpdateDate,\r\n\tUpdateDatePersian,\r\n\tOperationFailureReasonId,\r\n\tOperationFailureReasonTitle,\r\n\tOrderCategoryId,\r\n\tOrderCategoryTitle\r\nINTO #Output\r\nFROM #Final\r\nOrder By ID\r\nOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\r\n--SELECT @Result = \r\n--(\r\n\tSELECT DISTINCT\r\n\t\to.id,\r\n\t\to.vendorId,\r\n\t\to.VendorBrandName,\r\n\t\to.vendorParcelCode,\r\n\t\to.parcelReferenceCode,\r\n\t\to.courierRequestTypeId,\r\n\t\tcrt.Title AS courierRequestTypeTitle,\r\n\t\to.shipmentNumber,\r\n\t\to.provinceId,\r\n\t\to.provinceTitle,\r\n\t\to.cityId,\r\n\t\to.cityTitle,\r\n\t\to.polygonId,\r\n\t\to.polygonTitle,\r\n\t\to.storeId,\r\n\t\to.storeTitle,\r\n\t\tSUBSTRING(FORMAT(DeliveryStartTimePersian,\u0027####/##/## ##:##:##\\.###\u0027),0,11) \u002B \u0027 (\u0027 \u002B SUBSTRING(FORMAT(DeliveryStartTimePersian,\u0027####/##/## ##:##:##\\.###\u0027),12,5) \u002B \u0027 - \u0027 \u002B\r\n\t\t\t\t\t\t\t\t\t\t\t\tSUBSTRING(FORMAT(DeliveryDeadLineTimePersian,\u0027####/##/## ##:##:##\\.###\u0027),12,5) \u002B \u0027)\u0027  AS deliveryDatePersianStr,\r\n\t\to.fleetId,\r\n\t\tf.vehicleId,\r\n\t\tv.vehicleTypeId,\r\n\t\tvt.Title vehicleTypeTitle,\r\n\t\td.FirstName AS driverFirstName,\r\n\t\td.LastName AS driverLastName,\r\n\t\t\u00270\u0027\u002BCAST(d.Mobile AS VARCHAR(11)) AS driverMobile,\r\n\t\tISNULL(o.AssignmentTryCount,0) AS assignmentTryCount,\r\n\t\tISNULL(o.OperationFailureReasonId, 0) AS operationFailureReasonId,\r\n\t\tISNULL(o.OperationFailureReasonTitle, \u0027-\u0027) AS operationFailureReasonTitle,\r\n\t\tSUBSTRING(FORMAT(o.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027),0,20) as createDatePersianStr,\r\n\t\to.dispatchRequestStatusId,\r\n\t\tSUBSTRING(FORMAT(o.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027),0,20) AS UnsuccessfulPickupRequestTimeStr ,\r\n\t\tSUBSTRING(FORMAT(o.UpdateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027),0,20) AS UnsuccessfulPickupRequestTimePersianStr,\r\n\t\tDATEDIFF\r\n\t\t(\r\n\t\t\tSECOND,\r\n\t\t\tGETDATE(),\r\n\t\t\tDATEADD(MINUTE,NotPickupRequestReviewThresholdMinutes,FORMAT(o.UpdateDate,\u0027####/##/## ##:##:##\\.###\u0027))\r\n\t\t) RemainedTimeToAutomaticConfirmSeconds,\r\n\t\to.orderCategoryId,\r\n\t\to.orderCategoryTitle\r\n\r\n\tFROM #Output o\r\n\tINNER JOIN CS_Public.[PUB].[CourierRequestType] crt\r\n\t\tON o.CourierRequestTypeId = crt.Id\r\n\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK)\r\n\t\tON o.FleetId = f.ID\r\n\tINNER JOIN CS_DriverManagement.DM.Vehicle v (NOLOCK)\r\n\t\tON f.VehicleId = v.ID\r\n\tINNER JOIN CS_DriverManagement.DM.VehicleType vt (NOLOCK)\r\n\t\tON v.VehicleTypeId = vt.ID\r\n\tINNER JOIN CS_DriverManagement.DM.Driver d (NOLOCK)\r\n\t\tON f.DriverId = d.ID\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\tON o.storeId = stbi.StoreId\r\n\t--WHERE --(isnull(uor.UnsuccessfulOperationReasonId,0) = @UnsuccessfulOperationReasonId OR @UnsuccessfulOperationReasonId = 0)\r\n\t--\t\t(isnull(uor.OperationFailureReasonId,0) = @OperationFailureReasonId OR @OperationFailureReasonId = 0)\r\n--\tFOR JSON PATH , INCLUDE_NULL_VALUES , ROOT (\u0027DispatchRequests\u0027 )-- , WITHOUT_ARRAY_WRAPPER\r\n--)\r\n\r\n\r\n--\tSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\n\r\n\r\n--\tSET @Result = JSON_MODIFY(@Result,\u0027$.totalCount\u0027,@TotalCount)\r\n--\tSET @Result = JSON_MODIFY(@Result,\u0027$.pageSize\u0027,@PageSize  )\r\n--\tSET @Result = JSON_MODIFY(@Result,\u0027$.currentPage\u0027,@PageIndex )\r\n--\tSET @Result = JSON_MODIFY(@Result,\u0027$.totalPages\u0027,(@TotalCount \u002B @PageSize - 1) / @PageSize)\r\n\r\n\tSET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\nEND\r\n\r\n\r\n\r\n"},{"Name":"Get_NotPickUpDispatchRequestList_HAMID","Schema":"dbo","Definition":"\r\n/*\r\nDECLARE @Result NVARCHAR(MAX),@TotalCount INT\r\nEXEC [Get_NotPickUpDispatchRequestList] @OperationStaffId = 150 ,@PolygonIds = \u002734,59\u0027 , @PageIndex = 0 , @PageSize = 1 , @Result = @Result OUTPUT--,@TotalCount = @TotalCount OUTPUT\r\nSELECT @Result,@TotalCount\r\n*/\r\n\r\nCREATE     PROCEDURE [dbo].[Get_NotPickUpDispatchRequestList_HAMID]\r\n\r\n\t@OperationStaffId INT ,\r\n    @ParcelReferenceCode BIGINT = NULL,\r\n\t@VendorParcelCode VARCHAR(32) = NULL,\r\n    @ShipmentNumber BIGINT = NULL,\r\n    --@RequestTypes VARCHAR(20) = NULL,\r\n    @ProvinceId Tinyint = NULL,\r\n    @CityIds VARCHAR(MAX) = NULL,\r\n    @PolygonIds VARCHAR(MAX),\r\n    @StartDeliveryTime BIGINT = NULL,\r\n    @EndDeliveryTime BIGINT = NULL,\r\n    @FleetId INT = NULL,\r\n    --@UnsuccessfulOperationReasonId SMALLINT = NULL,\r\n    @VendorId INT = NULL,\r\n    @StoreIds VARCHAR(MAX) = NULL,\r\n    @StartCreateTime BIGINT = NULL,\r\n    @EndCreateTime BIGINT = NULL,\r\n\t@OperationFailureReasonId TINYINT = NULL,\r\n\t@CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t@OrderCategoryIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n    @PageIndex INT,\r\n\t@PageSize INT,\r\n\t--@TotalCount INT OUTPUT,\r\n\t@Result\tNVARCHAR(MAX) = NULL OUTPUT /*,\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,   \r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0 OUTPUT*/\r\n\r\nAS\r\nBEGIN\r\n\r\nDECLARE\r\n\t@TotalCount INT = 0,\r\n\t@DelayedDeliveryRequestCount\t\t\t\tINT = 0,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0,   \r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t= 0\r\n\r\nSELECT\r\n\t@ParcelReferenceCode\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n    @VendorParcelCode\t\t\t\t\t    =ISNULL(@VendorParcelCode,\u00270\u0027),                \r\n\t@ShipmentNumber\t\t\t\t\t\t\t=ISNULL(@ShipmentNumber,0),\r\n    @ProvinceId\t\t\t\t\t\t\t\t=ISNULL(@ProvinceId,0),\r\n\t@CityIds\t\t\t\t\t\t\t\t=ISNULL(@CityIds,\u00270\u0027),\r\n\t@PolygonIds\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),        \r\n\t@StartDeliveryTime\t\t\t\t\t\t=ISNULL(@StartDeliveryTime,0),\r\n\t@EndDeliveryTime\t\t\t\t\t\t=ISNULL(@EndDeliveryTime,0),\t\t\t\t\r\n\t@FleetId\t\t\t\t\t\t\t\t=ISNULL(@FleetId,0),\t\t\t\t\r\n\t@VendorId\t\t\t\t\t\t        =ISNULL(@VendorId,0),\r\n    @StoreIds\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n    @StartCreateTime\t\t\t\t\t\t=ISNULL(@StartCreateTime,\u00270\u0027),\r\n    @EndCreateTime\t\t\t\t\t\t    =ISNULL(@EndCreateTime,\u00270\u0027),\r\n\t@OperationFailureReasonId\t\t\t\t=ISNULL(@OperationFailureReasonId,0),\r\n\t@CourierRequestTypeIds\t\t\t\t\t=ISNULL(@CourierRequestTypeIds,\u00270\u0027),\r\n\t@OrderCategoryIds = ISNULL(@OrderCategoryIds,\u00270\u0027)\r\n\r\nDECLARE @PolygonId TABLE\r\n(\r\n\tId SMALLINT\r\n)\r\nINSERT INTO @PolygonId\r\nSELECT \r\n\tCAST(ISNULL(value,0) AS SMALLINT)\r\nFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\t\r\nDECLARE @StoreId TABLE\r\n(\r\n\tId SMALLINT\r\n)\r\nINSERT INTO @StoreId\r\nSELECT \r\n\tCAST(ISNULL(value,0) AS SMALLINT)\r\nFROM string_split(@StoreIds,\u0027,\u0027)\r\n\r\nDROP TABLE IF EXISTS #CityId\r\nCREATE TABLE #CityId\r\n(\r\n\tId SMALLINT\r\n)\r\nINSERT INTO #CityId\r\nSELECT \r\n\tc.Id\r\nFROM CS_Public.HAF.City c (NOLOCK)\r\nINNER JOIN string_split(@CityIds,\u0027,\u0027) ss\r\n\tON c.Id = ss.value\r\n\tOR @CityIds = \u00270\u0027\r\n\r\nDROP TABLE IF EXISTS #CourierRequestTypeId\r\nCREATE TABLE #CourierRequestTypeId\r\n(\r\n\tId TinyInt\r\n)\r\nINSERT INTO #CourierRequestTypeId\r\nSELECT \r\n\tcrt.Id\r\nFROM CS_Public.PUB.CourierRequestType crt (NOLOCK)\r\nINNER JOIN string_split(@CourierRequestTypeIds,\u0027,\u0027) ss\r\n\tON crt.Id = ss.value\r\n\tOR @CourierRequestTypeIds = \u00270\u0027\r\n\r\n\tDROP TABLE IF EXISTS #OrderCategoryId\r\nSELECT\r\n\toc.Id\r\nINTO #OrderCategoryId\r\nFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\nINNER JOIN string_split(@OrderCategoryIds,\u0027,\u0027) ss\r\n\tON oc.Id = ss.value\r\n\tOR @OrderCategoryIds = \u00270\u0027\r\n\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-12,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-12, 114),\u0027:\u0027,\u0027\u0027)\r\n\tDECLARE \r\n\t\t@Now int=LEFT(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),8),\r\n\t\t@Yesterday int = LEFT(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),8)\r\n\r\n\r\n\t\tSELECT ddr.ParcelReferenceCode, CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120),\tsdp.EstimatedArrivalTime,--DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) , GETDATE(),\r\n\t--ISDATE(FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027)),\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tCAST(DeliveryStartTime/1000000000 AS BIGINT)\tDeliveryStartTime_Date,\r\n\t\tddr.CourierRequestTypeId ,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tsdp.OperationTypeId,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tLEFT JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tLEFT JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\tAND CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME) \u003C= GETDATE()\r\n\tLEFT JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #CityId cid\r\n\t\tON dp.CityId = cid.Id\r\n\tINNER JOIN #CourierRequestTypeId crtId\r\n\t\tON ddr.CourierRequestTypeId = crtId.ID\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\tAND((ps.StoreId IN(SELECT Id FROM @StoreId)\t\t\t)\t\t\t\tOR (ISNULL(@StoreIds,\u00270\u0027)=\u00270\u0027))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\tAND sdp.EstimatedArrivalTime IS NOT NULL\r\n\tAND\r\n\t(\r\n\t\t(ddr.DispatchRequestStatusId in (5,6) AND CAST(DeliveryStartTime/1000000000 AS BIGINT)IN(@Now,@Yesterday))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51))\r\n\t\tOR\r\n\t\t( (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) )\r\n\t\tOR\r\n\t\t(  sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) )\r\n\t\tOR\r\n\t\t( sdp.OperationTypeId = (10) AND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) )\r\n\t)\r\n\tAND ddr.ParcelReferenceCode NOT IN \r\n\t( \r\n\t1732693409063112,\r\n\t1732707616053813,\r\n\t1733040783244412,\r\n\t1733047235104301,\r\n\t1733049666717316,\r\n\t1733049667049508,\r\n\t1733221035711843,\r\n\t1733568898155107,\r\n\t1733568898432264,\r\n\t1733568903727846,\r\n\t1733648263980351,\r\n\t1733648264303844 \r\n\t)\r\n\tORDER BY ddr.ParcelReferenceCode , sdp.EstimatedArrivalTime\r\n\r\n\tPRINT \u002712312312321\u0027\r\n\t\t\r\n\t--;WITH CTE_DR AS\r\n\t--(\r\n\tSELECT DISTINCT ddr.ParcelReferenceCode\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tLEFT JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\t\r\n\t\tON ddr.id=sdpdr.DispatchRequestId\r\n\tLEFT JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\t\r\n\t\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tAND sdp.OperationTypeId IN ( 5,10 )\r\n\t\t--AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,TRY_CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C= GETDATE()\r\n\tLEFT JOIN dP.Shipment(NOLOCK) ds\r\n\t\tON ds.Id=sdp.ShipmentId\r\n\t\tand ds.ShipmentStatusId NOT IN ( 45,50,55,100 )\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #CityId cid\r\n\t\tON dp.CityId = cid.Id\r\n\tINNER JOIN #CourierRequestTypeId crtId\r\n\t\tON ddr.CourierRequestTypeId = crtId.ID\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\tAND((ps.StoreId IN(SELECT Id FROM @StoreId)\t\t\t)\t\t\t\tOR (ISNULL(@StoreIds,\u00270\u0027)=\u00270\u0027))\t\r\n\tAND ((ddr.ParcelReferenceCode=@ParcelReferenceCode\t)\t\t\t\tOR (ISNULL(@ParcelReferenceCode,0)=0))\r\n\tAND ((ddr.VendorParcelCode=@VendorParcelCode\t\t)\t\t\t\tOR (ISNULL(@VendorParcelCode,\u00270\u0027)=\u00270\u0027) OR @VendorParcelCode=\u0027\u0027)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId)\t\t\t\t\tOR (ISNULL(@PolygonIds,\u0027\u0027)=\u0027\u0027))\r\n\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\tAND sdp.EstimatedArrivalTime IS NOT NULL\r\n\tAND\r\n\t(\r\n\t\t(ddr.DispatchRequestStatusId in (5,6) AND CAST(DeliveryStartTime/1000000000 AS BIGINT)IN(@Now,@Yesterday))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70))\r\n\t\tOR\r\n\t\t(ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51))\r\n\t\tOR\r\n\t\t( (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) )\r\n\t\tOR\r\n\t\t(  sdp.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) )\r\n\t\tOR\r\n\t\t( sdp.OperationTypeId = (10) AND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) )\r\n\t)\r\n\t\tORDER BY ddr.ParcelReferenceCode --, sdp.EstimatedArrivalTime\r\n\t--)\r\n\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount),\r\n\t--\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount),\r\n\t--\t@AssignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount),\r\n\t--\t@ReturnedRequestCount = COUNT(DISTINCT ReturnedCount),\r\n\t--\t@DelayedPickupCount = COUNT(DISTINCT DelayedPickupCount),\r\n\t--\t@DelayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount)\r\n\t--FROM\r\n\t--(\r\n\t--\tSELECT \r\n\t--\t\tCASE WHEN ddr.DispatchRequestStatusId in (5,6) AND ddr.DeliveryStartTime_Date IN(@Now,@Yesterday) THEN ddr.ParcelReferenceCode ELSE NULL END UnassignedDispatchRequestCount,\r\n\t--\t\tCASE WHEN ddr.DispatchRequestStatusId in (5) AND ddr.CourierRequestTypeId in (26,30,35,40,45,50,60,65,70) THEN  ddr.ParcelReferenceCode ELSE NULL END UnassignedReturnAndReplacementRequestCount,\r\n\t--\t\tCASE WHEN ddr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51) THEN ddr.ParcelReferenceCode ELSE NULL END Assigned_DispatchRequestCount,\r\n\t--\t\tCASE WHEN (ddr.DispatchRequestStatusId not in (30,35,100) and ddr.CourierRequestTypeId = 25) OR (ddr.DispatchRequestStatusId in (45,46) and ddr.CourierRequestTypeId in (5,10,15)) THEN ddr.ParcelReferenceCode ELSE NULL END ReturnedCount,\r\n\t--\t\tCASE WHEN ddr.OperationTypeId = 5  AND ddr.DispatchRequestStatusId in (10,11,15,16) THEN ddr.ParcelReferenceCode ELSE NULL END DelayedPickupCount,\r\n\t--\t\tCASE WHEN \r\n\t--\t\t\tddr.OperationTypeId = (10)  \r\n\t--\t\t\tAND ddr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/) \r\n\t--\t\tTHEN ddr.ParcelReferenceCode ELSE NULL END DelayedDeliveryCount\r\n\t--\tFROM CTE_DR ddr\r\n\t--) SQ\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\tRETURN\r\n\r\nDROP TABLE IF EXISTS #Final\r\nSELECT\r\n\tdr.ID AS DispatchRequestId,\r\n\tdr.DispatchRequestStatusId,\r\n\tdr.ParcelReferenceCode,\r\n\tdr.CourierRequestTypeId,\r\n\tdr.VendorParcelCode,\r\n\tdr.DeliveryStartTime,\r\n\tdr.DeliveryDeadLineTime,\r\n\tdr.ClientAddress,\r\n\tdr.DeliveryStartTimePersian,\r\n\tdr.DeliveryDeadLineTimePersian,\r\n\r\n\tsh.ID AS ShipmentId,\r\n\tsh.ShipmentStatusId,\r\n\tsh.ShipmentNumber,\r\n\tsh.TotalEstimatedDurationSeconds,\r\n\tsh.TotalDistanceMeter,\r\n\tc.ProvinceId,\r\n\tpr.Name AS ProvinceTitle,\r\n\ts.CityId,\r\n\tc.Name AS CityTitle,\r\n\tps.PolygonId,\r\n\tp.Title AS PolygonTitle,\r\n\tdr.VendorId,\r\n\tps.StoreId,\r\n\ts.Title AS StoreTitle,\r\n\ts.Location,\r\n\tsh.FleetId,\r\n\tsh.DeliveryServiceProviderId,\r\n\ts.OrderCategoryId,\r\n\toc.Title AS OrderCategoryTitle,\r\n\tDATEDIFF(SECOND,GETDATE(),DATEADD(MINUTE,stbi.NotPickupRequestReviewThresholdMinutes,sdp.BikerWaitingStartTime)) AS RemainedReviewTimeSeconds,\r\n\tDENSE_RANK() OVER ( ORDER BY DATEDIFF(SECOND,DATEADD(MINUTE,stbi.NotPickupRequestReviewThresholdMinutes,sdp.BikerWaitingStartTime),GETDATE()) DESC ) D_Rank\r\nINTO #Final\r\nFROM DP.DispatchRequest dr (NOLOCK)\r\nINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\tON dr.ID = sdpdr.DispatchRequestId\r\nINNER JOIN DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\nINNER JOIN DP.Shipment sh WITH(NOLOCK)\r\n\tON sdp.ShipmentId = sh.Id\r\nINNER JOIN #CourierRequestTypeId crtId\r\n\tON dr.CourierRequestTypeId = crtId.ID\r\nINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\tON dr.PolygonStoreId = ps.ID\r\nINNER JOIN DP.Polygon p (NOLOCK)\r\n\tON ps.PolygonId = p.ID\r\nINNER JOIN DP.Store s (NOLOCK)\r\n\tON ps.StoreId = s.ID\r\nINNER JOIN #CityId cid\r\n\tON s.CityId = cid.Id\r\nINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\tON s.CityId = c.ID\r\nINNER JOIN CS_Public.HAF.Province pr (NOLOCK)\r\n\tON c.ProvinceId = pr.ID\r\nINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\tON dr.VendorId = v.Id\r\nINNER JOIN #OrderCategoryId ocID\r\n\tON s.OrderCategoryId = ocID.Id\r\nINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\tON s.OrderCategoryId = oc.Id\r\nINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\tON s.ID = stbi.StoreId\r\nWHERE dr.DispatchRequestStatusId IN ( 15 )\r\nAND dr.IsWaitingForSupport = 1\r\nAND sdp.BikerWaitingStartTime IS NOT NULL\r\nAND sdp.BikerWaitingDuration IS NULL\r\nAND sdp.OperationTypeId = 5\r\nAND sdp.ShipmentDestinationPointStatusId = 15\r\nAND (dr.ParcelReferenceCode = @ParcelReferenceCode OR @ParcelReferenceCode = 0)\r\nAND (dr.VendorParcelCode = @VendorParcelCode OR @VendorParcelCode = \u00270\u0027)\r\nAND (c.ProvinceId = @ProvinceId OR @ProvinceId = 0)\r\nAND (ps.PolygonId in (SELECT Id FROM @PolygonId) )\r\nAND ((dr.DeliveryStartTime \u003E= @StartDeliveryTime and dr.DeliveryDeadLineTime \u003C= @EndDeliveryTime) OR (@StartDeliveryTime = 0 OR @EndDeliveryTime = 0))\r\nAND (dr.VendorId = @VendorId OR @VendorId = 0)\r\nAND (ps.StoreId in (SELECT Id FROM @StoreId) OR @StoreIds = \u00270\u0027)\r\nAND (dr.CreateDate BETWEEN @StartCreateTime AND @EndCreateTime OR (@StartCreateTime = 0 OR @EndCreateTime = 0))\r\n\r\nSELECT @TotalCount =  COUNT(DISTINCT ShipmentId) FROM #Final\r\n\r\n\r\nSET @pageIndex = ISNULL(@pageIndex,0)\r\nSET @TotalCount = ISNULL(@TotalCount,0)\r\n\r\nIF ISNULL(@pageSize,0) = 0\r\nBEGIN\r\n\tIF ISNULL(@TotalCount,0) = 0\r\n\t\tSET @pageSize = 1\r\n\tELSE\r\n\t\tSET @pageSize = @TotalCount\r\nEND\r\n\r\nDECLARE @FromRow INT = 0, @ToRow INT = 0\r\nSET @FromRow = @pageIndex * @pageSize\r\nSET @ToRow = ( @pageIndex * @pageSize ) \u002B @pageSize\r\n\r\nIF @TotalCount = 0\r\nBEGIN\r\n\tSET @Result = \u0027{}\u0027\r\nEND\r\nELSE\r\nBEGIN\r\n\r\n\r\n;WITH CTE_Output AS\r\n(\r\n\tSELECT * \r\n\tFROM #Final\r\n\tWHERE D_Rank BETWEEN @FromRow AND @ToRow\r\n)\r\nSELECT @Result = \r\n(\r\n\tSELECT \r\n\t\t*,\r\n\t\t(\r\n\t\t\tSELECT DISTINCT\r\n\t\t\t\tDispatchRequestId AS Id,\r\n\t\t\t\tdispatchRequestStatusId,\r\n\t\t\t\tdrs.Title AS dispatchRequestStatusTitle,\r\n\t\t\t\tparcelReferenceCode,\r\n\t\t\t\tcourierRequestTypeId,\r\n\t\t\t\tcrt.Title AS courierRequestTypeTitle,\r\n\t\t\t\tFORMAT(DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027) deliveryStartTimeStr,\r\n\t\t\t\tFORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) deliveryDeadLineTimeStr,\r\n\t\t\t\tclientAddress,\r\n\t\t\t\tFORMAT(DeliveryStartTimePersian,\u0027####/##/## ##:##:##\\.###\u0027) deliveryStartTimePersianStr,\r\n\t\t\t\tFORMAT(DeliveryDeadLineTimePersian,\u0027####/##/## ##:##:##\\.###\u0027) deliveryDeadLineTimePersianStr,\r\n\t\t\t\tFORMAT(uorh.CreateDatePersian,\u0027####/##/## ##:##:##\\.###\u0027) AS notPickupRequestDateTimeStr,\r\n\t\t\t\tuorh.OperationFailureReasonId AS notPickupRequestReasonId,\r\n\t\t\t\tuorh.OperationFailureReasonTitle AS notPickupRequestReasonTitle,\r\n\t\t\t\tvendorParcelCode\r\n\t\t\t\tFROM CTE_Output dr\r\n\t\t\t\tINNER JOIN CS_Public.PUB.CourierRequestType crt WITH(NOLOCK)\r\n\t\t\t\t\tON dr.CourierRequestTypeId = crt.Id\r\n\t\t\t\tINNER JOIN DP.DispatchRequestStatus drs WITH(NOLOCK)\r\n\t\t\t\t\tON dr.DispatchRequestStatusId = drs.Id\r\n\t\t\t\tOUTER APPLY \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT TOP 1\r\n\t\t\t\t\t\tuorh.OperationFailureReasonId,\r\n\t\t\t\t\t\tofr.Title AS OperationFailureReasonTitle,\r\n\t\t\t\t\t\tuorh.CreateDatePersian\r\n\t\t\t\t\tFROM DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK)\r\n\t\t\t\t\tINNER JOIN DP.OperationFailureReason ofr (NOLOCK)\t \r\n\t\t\t\t\t\tON ofr.id = uorh.OperationFailureReasonId  \r\n\t\t\t\t\tWHERE uorh.OperationTypeId = 6\r\n\t\t\t\t\tAND uorh.ShipmentId = dr.ShipmentId\r\n\t\t\t\t\tAND uorh.FleetId = dr.FleetId\r\n\t\t\t\t\tORDER BY uorh.ID DESC\r\n\t\t\t\t) UORH\r\n\t\t\t\tWHERE dr.ShipmentId = SQ.Id\r\n\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t\t) AS dispatchRequests\r\n\tFROM\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tsh.shipmentId AS Id,\r\n\t\t\tsh.shipmentStatusId AS statusId,\r\n\t\t\tsh.shipmentNumber,\r\n\t\t\tsh.totalEstimatedDurationSeconds,\r\n\t\t\tsh.totalDistanceMeter,\r\n\t\t\tsh.provinceId,\r\n\t\t\tsh.provinceTitle,\r\n\t\t\tsh.cityId,\r\n\t\t\tsh.cityTitle,\r\n\t\t\tsh.polygonId,\r\n\t\t\tsh.polygonTitle,\r\n\t\t\tsh.vendorId,\r\n\t\t\tvnd.BrandName AS vendorBrandName,\r\n\t\t\tsh.storeId,\r\n\t\t\tsh.storeTitle,\r\n\t\t\tsh.Location.STY AS storeLocationLat,\r\n\t\t\tsh.Location.STX AS storeLocationLong,\r\n\t\t\tsh.fleetId,\r\n\t\t\tf.driverId,\r\n\t\t\t(d.FirstName \u002B \u0027 \u0027 \u002B d.LastName) AS driverName,\r\n\t\t\t\u00270\u0027\u002BCAST(d.Mobile AS VARCHAR(20)) AS driverMobile,\r\n\t\t\tv.vehicleTypeId,\r\n\t\t\tv.plateNumber,\r\n\t\t\tsh.deliveryServiceProviderId,\r\n\t\t\tsh.orderCategoryId,\r\n\t\t\tsh.orderCategoryTitle,\r\n\t\t\tsh.remainedReviewTimeSeconds\r\n\t\tFROM CTE_Output sh\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet f WITH(NOLOCK)\r\n\t\t\tON sh.FleetId = f.Id\r\n\t\tINNER JOIN CS_DriverManagement.DM.Driver d WITH(NOLOCK)\r\n\t\t\tON f.DriverId = d.Id\r\n\t\tINNER JOIN CS_DriverManagement.DM.Vehicle v WITH(NOLOCK)\r\n\t\t\tON f.VehicleId = v.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor vnd WITH(NOLOCK)\r\n\t\t\tON sh.VendorId = vnd.Id\r\n\t) SQ\r\n\r\n\tFOR JSON PATH , INCLUDE_NULL_VALUES , ROOT (\u0027Shipments\u0027)\r\n)\r\n\r\nEND\r\n\r\n\r\nSET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\nSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\nSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\nSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\nSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\nSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\nSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\n\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.totalCount\u0027,@TotalCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.pageSize\u0027,@PageSize  )\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.currentPage\u0027,@PageIndex )\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.totalPages\u0027,(@TotalCount \u002B @PageSize - 1) / @PageSize)\r\n\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.delayedDeliveryRequestCount\u0027,@DelayedDeliveryRequestCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.delayedPickupCount\u0027,@DelayedPickupCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.returnedRequestCount\u0027,@ReturnedRequestCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.assignedDispatchRequestCount\u0027,@AssignedDispatchRequestCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.unassignedDispatchRequestCount\u0027,@UnassignedDispatchRequestCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.unassignedReturnAndReplacementRequestCount\u0027,@UnassignedReturnAndReplacementRequestCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.notPickUpRequestCount\u0027,@NotPickUpRequestCount)\r\n\r\n\r\nSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\nSET @Result = REPLACE(@Result,\u0027\u0022dispatchRequests\u0022:\u0022{\u0027,\u0027\u0022dispatchRequests\u0022:{\u0027)\r\nSET @Result = REPLACE(@Result,\u0027}\u0022}\u0027,\u0027}}\u0027)\r\n\r\nEND\r\n"},{"Name":"Get_OnlineFleets_By_PolygonId","Schema":"dbo","Definition":"/*\r\nexec [Get_OnlineFleets_By_PolygonId] 20\r\n*/\r\nCREATE      PROCEDURE [dbo].[Get_OnlineFleets_By_PolygonId]\r\n\t@PolygonId\tSMALLINT\r\nAS\r\n\t\r\n\tDECLARE @ShiftTime\tTIME=CAST(getdate() AS TIME),\r\n\t\t\t@ShiftDate\tDATE=CAST(GETDATE() AS DATE)\r\n\tDECLARE @WeedDayId\tTINYINT=(SELECT DATEPART(dw,GETDATE())-1)\r\n\t\r\n\tSELECT\tDISTINCT\r\n\t\t\tCONCAT(dd.FirstName,\u0027\u0027,dd.LastName) Name1,\r\n\t\t\tdf.Id\tFleetId,\r\n\t\t\tdf.DriverId,\r\n\t\t\tCASE WHEN dd.IsIranianCitizen = 1 THEN dd.Code ELSE dd.FidaCode END DriverCode,\r\n\t\t\tdv.VehicleTypeId,\r\n\t\t\tdv.PlateNumber,\r\n\t\t\tdf.FleetStatusId,\r\n\t\t\t(\r\n\t\t\t\tSELECT COUNT(distinct dr.Id)\r\n\t\t\t\tFROM dp.Shipment (NOLOCK) ds \r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint (NOLOCK) sdp\t\t\t\t\t\r\n\t\t\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest (NOLOCK) drsdp \r\n\t\t\t\t\tON drsdp.shipmentDestinationPointId=sdp.Id\r\n\t\t\t\tINNER JOIN dp.dispatchRequest (NOLOCK) dr\t\t\t\t\t\t\t\r\n\t\t\t\t\tON dr.Id=drsdp.DispatchRequestId\r\n\t\t\t\tWHERE ds.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100/**/)--IN (10/*SubmittedWithDelay*/,15/*SubmittedByOperation*/,20/*PartiallyPickedUp*/,25/*PickedUp*/)\r\n\t\t\t\tAND dr.DispatchRequestStatusId NOT IN (30/*Delivered*/,35/*DeliveredWithDelay*/,40/*Canceled*/,100/**/)\r\n\t\t\t\tAND ds.FleetId=df.Id\r\n\t\t\t) DispatchRequestCount\r\n\tFROM CS_DriverManagement.DM.Fleet (NOLOCK) df\r\n\tINNER JOIN CS_DriverManagement.DM.Driver (NOLOCK) dd \t\t\t\t\r\n\t\tON dd.Id=df.DriverId \r\n\t\tAND df.DeliveryServiceProviderId =1\r\n\tINNER JOIN CS_DriverManagement.DM.Vehicle (NOLOCK) dv\t\t\t\r\n\t\tON dv.Id=df.VehicleId\r\n\t--INNER JOIN CS_DriverManagement.DM.PolygonFleet (NOLOCK) dpf\t\t\r\n\t--\tON dpf.FleetId=df.Id \r\n\t--\tAND dpf.IsActive=1\r\n\r\n\r\n\tINNER JOIN CS_DriverManagement.DM.ShiftFleetMap AS sfm ON sfm.FleetId = df.Id AND sfm.IsActive = 1 AND sfm.IsDeleted = 0\r\n\tINNER JOIN CS_DriverManagement.DM.ShiftDate AS sd ON sd.Id = sfm.ShiftDateId  AND sd.IsActive = 1\r\n\tINNER JOIN CS_DriverManagement.DM.Shift AS s ON s.Id = sd.ShiftId AND s.Status = 1\r\n\tINNER JOIN CS_DriverManagement.DM.TimeSlot AS ts ON ts.Id = s.TimeSlotId\r\n\r\n\tINNER JOIN dp.Polygon (NOLOCK) dp\t\t\t\r\n\tON dp.Id=s.PolygonId\r\n\r\n\t--INNER JOIN CS_DriverManagement.DM.FleetShift (NOLOCK) fs\t\t\t\r\n\t--\tON fs.FleetId=df.Id\r\n\t--INNER JOIN CS_DriverManagement.DM.ShiftConfiguration (NOLOCK) sc \r\n\t--\tOn fs.ShiftConfigurationId=sc.Id AND IsDeleted=0\r\n\r\n\tINNER JOIN dp.PolygonOperationStaff (NOLOCK) pos \r\n\t\tON pos.PolygonId=s.PolygonId \r\n\t\r\n\tWHERE df.FleetStatusId \u003C\u003E10/*Offline*/\r\n\tAND sd.Date = @ShiftDate \r\n\tAND @ShiftTime BETWEEN [ts].[From] AND [ts].[To]\r\n\t--AND @ShiftTime Between sc.StartTime AND sc.EndTime\r\n\t--AND @WeedDayId=fs.WeekDayId\r\n\tAND dp.id=@PolygonId\r\n\t\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"Name":"Get_OperationPanel_Count","Schema":"dbo","Definition":"\r\nCREATE   PROC [dbo].[Get_OperationPanel_Count]\r\n(\r\n\t@OperationStaffId\t\t\t\t\t\t\tINT ,\r\n\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX) = NULL ,\r\n\t@PolygonIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX) = NULL,\r\n\t@VendorID\t\t\t\t\t\t\t\t\tINT = NULL,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@AssignedDispatchRequestCount\t\t\t\tINT = 0 OUTPUT,\r\n\t@ReturnedRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@DelayedDeliveryCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t@NotPickupRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t@DelayedPickupCount\t\t\t\t\t\t\tINT = 0 OUTPUT\r\n)\r\nAS\r\n\r\nDECLARE @ToDate BIGINT = CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\nDECLARE @Today INT,@Yesterday int\r\n\r\nSELECT @Today = CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\nSELECT @Yesterday = CAST(SUBSTRING(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT)\r\n\r\nSELECT @PolygonIds = ISNULL(@PolygonIds,\u00270\u0027)\r\nSELECT @CityIds = ISNULL(@CityIds,\u00270\u0027)\r\nSET @VendorID = ISNULL(@VendorID,0)\r\n\r\nDROP TABLE IF EXISTS #PolygonIds\r\nCREATE TABLE #PolygonIds\r\n(\r\n\tId SMALLINT\r\n)\r\nCREATE INDEX IX_#PolygonIds ON #PolygonIds\r\n(\r\n\tId\r\n)\r\nINSERT INTO #PolygonIds ( Id )\r\nSELECT DISTINCT\r\n\tp.Id\r\nFROM CS_Dispatcher.DP.Polygon p (NOLOCK)\r\nINNER JOIN string_split(@PolygonIds,\u0027,\u0027) ss\r\n\tON p.Id = ss.value\r\n\tOR @PolygonIds = \u00270\u0027\r\n\r\nDROP TABLE IF EXISTS #CityIds\r\nCREATE TABLE #CityIds\r\n(\r\n\tId SMALLINT\r\n)\r\nCREATE INDEX IX_#CityIds ON #CityIds\r\n(\r\n\tId\r\n)\r\nINSERT INTO #CityIds ( Id )\r\nSELECT DISTINCT\r\n\tc.Id\r\nFROM CS_Public.HAF.City c (NOLOCK)\r\nINNER JOIN string_split(@CityIds,\u0027,\u0027) ss\r\n\tON c.Id = ss.value\r\n\tOR @CityIds = \u00270\u0027\r\n\r\n;WITH CTE_DR AS \r\n(\r\n\tSELECT\t\r\n\t\tddr.Id DispatchRequestId,\r\n\t\tddr.ParcelReferenceCode,\r\n\t\tddr.DispatchRequestStatusId,\r\n\t\tddr.CourierRequestTypeId,\r\n\t\tddr.DeliveryStartTime,\r\n\t\tddr.DeliveryDeadLineTime,\r\n\t\tddr.IsWaitingForSupport\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN #PolygonIds pids\r\n\t\tON dp.Id = pids.Id\r\n\tINNER JOIN #CityIds cids\r\n\t\tON dp.CityId = cids.Id\r\n\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\tAND ( ddr.VendorId = @VendorID OR @VendorID = 0)\r\n)\r\nSELECT \r\n\t@UnassignedDispatchRequestCount = COUNT(DISTINCT SQ.UnassignedDispatchRequestCount),\r\n\t@AssignedDispatchRequestCount = COUNT(DISTINCT SQ.AssignedDispatchRequestCount),\r\n\t@DelayedDeliveryCount = COUNT(DISTINCT SQ.DelayedDeliveryCount),\r\n\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT SQ.UnassignedReturnAndReplacementRequestCount),\r\n\t@DelayedPickupCount = COUNT(DISTINCT SQ.DelayedPickupCount),\r\n\t@ReturnedRequestCount = COUNT(DISTINCT SQ.ReturnedRequestCount),\r\n\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\nFROM\r\n(\r\n\tSELECT \r\n\t\tCASE \r\n\t\t\tWHEN dr.DispatchRequestStatusId IN (5,6)  AND LEFT(DeliveryStartTime,8) IN(@Today,@Yesterday) --= @Today\r\n\t\t\tTHEN dr.ParcelReferenceCode \r\n\t\t\tELSE NULL \r\n\t\tEND AS UnassignedDispatchRequestCount,\r\n\t\tCASE \r\n\t\t\tWHEN dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54) \r\n\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS AssignedDispatchRequestCount,\r\n\t\tNULL AS DelayedDeliveryCount,\r\n\t\tCASE \r\n\t\t\tWHEN \r\n\t\t\t\tdr.DispatchRequestStatusId = 5\r\n\t\t\t\tAND dr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70)\r\n\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS UnassignedReturnAndReplacementRequestCount,\r\n\t\tCASE \r\n\t\t\tWHEN \r\n\t\t\t\t(\r\n\t\t\t\t\t(DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n\t\t\t\t\tOR\r\n\t\t\t\t\t(DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\n\t\t\t\t\tAND dr.DeliveryDeadLineTime \u003E=@ToDate) \r\n\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS ReturnedRequestCount,\r\n\t\tNULL AS DelayedPickupCount,\r\n\t\tCASE \r\n\t\t\tWHEN \r\n\t\t\t\tdr.IsWaitingForSupport = 1 \r\n\t\t\t\tAND dr.DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS NotPickupRequestCount\r\n\tFROM CTE_DR dr\r\n\tUNION ALL\r\n\tSELECT\r\n\t\tNULL AS UnassignedDispatchRequestCount,\r\n\t\tNULL AS AssignedDispatchRequestCount,\r\n\t\tNULL AS DelayedDeliveryCount,\r\n\t\tNULL AS UnassignedReturnAndReplacementRequestCount,\r\n\t\tNULL AS ReturnedRequestCount,\r\n\t\tCASE \r\n\t\t\tWHEN sdp.ID IS NOT NULL \r\n\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\tELSE NULL\r\n\t\tEND AS DelayedPickupCount,\r\n\t\tNULL AS NotPickupRequestCount\r\n\tFROM CTE_DR dr\r\n\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  \r\n\t\tON sdpdr.DispatchRequestId = dr.DispatchRequestId AND dr.DispatchRequestStatusId in (10,11,15,16)\r\n\tINNER JOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  \r\n\t\tON sdp.Id = sdpdr.ShipmentDestinationPointId AND sdp.OperationTypeId = 5 AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= getdate() \r\n\tUNION ALL\r\n\tSELECT\r\n\t\tNULL AS UnassignedDispatchRequestCount,\r\n\t\tNULL AS AssignedDispatchRequestCount,\r\n\t\tCASE \r\n\t\t\tWHEN sdp.ID IS NOT NULL \r\n\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\tELSE NULL\r\n\t\tEND AS DelayedDeliveryCount,\r\n\t\tNULL AS UnassignedReturnAndReplacementRequestCount,\r\n\t\tNULL AS ReturnedRequestCount,\r\n\t\tNULL AS DelayedPickupCount,\r\n\t\tNULL AS NotPickupRequestCount\r\n\tFROM CTE_DR dr\r\n\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  \r\n\t\tON sdpdr.DispatchRequestId = dr.DispatchRequestId AND dr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\tINNER JOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  \r\n\t\tON sdp.Id = sdpdr.ShipmentDestinationPointId AND sdp.OperationTypeId IN (10) AND sdp.ShipmentDestinationPointStatusId IN ( 5,10,15 ) AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= getdate() \r\n\t--UNION ALL\r\n\t--SELECT\r\n\t--\tNULL AS UnassignedDispatchRequestCount,\r\n\t--\tNULL AS AssignedDispatchRequestCount,\r\n\t--\tNULL AS DelayedDeliveryCount,\r\n\t--\tNULL AS UnassignedReturnAndReplacementRequestCount,\r\n\t--\tCASE \r\n\t--\t\tWHEN sdp.ID IS NOT NULL \r\n\t--\t\tTHEN dr.ParcelReferenceCode\r\n\t--\t\tELSE NULL\r\n\t--\tEND AS ReturnedRequestCount,\r\n\t--\tNULL AS DelayedPickupCount,\r\n\t--\tNULL AS NotPickupRequestCount\r\n\t--FROM CTE_DR dr\r\n\t--INNER JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  \r\n\t--\tON sdpdr.DispatchRequestId = dr.DispatchRequestId \r\n\t--\tAND \r\n\t--\t(\r\n\t--\t\t\t(DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n\t--\t\tOR\t(DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\n\t--\t)\r\n\t--INNER JOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  \r\n\t--\tON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t--\tAND sdp.OperationTypeId IN ( 15,30 )\r\n) SQ"},{"Name":"Get_OperationStaff_By_Region","Schema":"dbo","Definition":"\r\n/*\r\ndeclare @Result NVARCHAR(MAX) =\u0027\u0027\r\nexec Get_OperationStaff_By_Region @CityId=\u00272\u0027, @Result=@Result OUTPUT\r\nselect @Result\r\n*/\r\n\r\nCREATE    procedure [dbo].[Get_OperationStaff_By_Region]\r\n--declare\r\n\t\t@CityId\t\t\t\tvarchar(1000),\r\n\t\t@Result\t\t\t\tNVARCHAR(MAX) = NULL OUTPUT,\r\n\t\t@OperationStaffCount\tSMALLINT OUTPUT,\r\n\t\t@TotalRegionPolygonCount SMALLINT OUTPUT\r\nAS\r\n\r\n\r\n\tdeclare @RegionIds Table\r\n\t(\r\n\t\tId INT\r\n\t)\r\n\tINSERT INTO @regionIds\r\n\tSELECT value\r\n\tFROM string_split(@CityId,\u0027,\u0027)\r\n\r\n\t--declare @OperationStaffCount SMALLINT=0\r\n\tselect @OperationStaffCount=COUNT(distinct pos.OperationStaffId)\r\n\tfrom dp.Polygon p\r\n\tinner join dp.PolygonOperationStaff pos on p.id=pos.PolygonId AND pos.IsActive=1\r\n\tJOIN DP.OperationStaff AS os ON os.Id = pos.OperationStaffId AND os.IsActive=1\r\n\tINNER JOIN @RegionIds r ON r.id=p.CityId\r\n\tWHERE p.IsActive = 1\r\n\r\n\t--DECLARE @TotalRegionPolygonCount SMALLINT=0\r\n\tselect @TotalRegionPolygonCount=COUNT(p.id)\r\n\tfrom dp.Polygon p\r\n\t--inner join dp.PolygonOperationStaff pos on p.id=pos.PolygonId AND p.IsActive=1\r\n\tINNER JOIN @RegionIds r ON r.id=p.CityId\r\n\tWHERE p.IsActive = 1\r\n\t/*\r\n\tSET @Result=(\r\n\t\tselect \r\n\t\t\t@OperationStaffCount OperationStaffCount,\r\n\t\t\t@TotalRegionPolygonCount TotalRegionPolygonCount,\r\n\t\t\tJSON_QUERY(\r\n\t\t\t(\r\n\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\tos.Id,\r\n\t\t\t\t\tos.Code,\r\n\t\t\t\t\tos.CustomerId,\r\n\t\t\t\t\tos.FirstName,\r\n\t\t\t\t\tos.LastName,\r\n\t\t\t\t\tCONCAT(\u00270\u0027,os.Mobile) Mobile,\r\n\t\t\t\t\tCOUNT(distinct pos.polygonid) PolygonCountInRegion\r\n\t\t\t\tFROM CS_Dispatcher.dp.OperationStaff os\r\n\t\t\t\tINNER JOIN CS_Dispatcher.dp.PolygonOperationStaff pos on os.id=pos.OperationStaffId and pos.IsActive=1\r\n\t\t\t\tJOIN DP.Polygon AS p ON p.Id = pos.PolygonId\r\n\t\t\t\tJOIN @RegionIds AS ri ON ri.Id = p.CityId\r\n\t\t\t\tWHERE os.IsActive = 1 AND p.IsActive = 1\r\n\t\t\t\tGROUP BY os.Id,\r\n\t\t\t\t\tos.Code,\r\n\t\t\t\t\tos.CustomerId,\r\n\t\t\t\t\tos.FirstName,\r\n\t\t\t\t\tos.LastName,\r\n\t\t\t\t\tos.Mobile\r\n\t\t\t\tORDER BY COUNT(distinct pos.polygonid) DESC\r\n\t\t\t\tFOR JSON PATH\r\n\t\t\t))RegionOperationStaffs\r\n\t\tFOR JSON PATH,WITHOUT_ARRAY_WRAPPER\r\n\t\t)\r\n\t\t--select @result\r\n\t\t*/\r\n\t\tSELECT DISTINCT\r\n\t\t\t--@OperationStaffCount OperationStaffCount,\r\n\t\t\t--@TotalRegionPolygonCount TotalRegionPolygonCount,\r\n\t\t\t\tos.Id,\r\n\t\t\t\tos.Code,\r\n\t\t\t\tos.CustomerId,\r\n\t\t\t\tos.FirstName,\r\n\t\t\t\tos.LastName,\r\n\t\t\t\tCONCAT(\u00270\u0027,os.Mobile) Mobile,\r\n\t\t\t\tCOUNT(distinct pos.polygonid) PolygonCountInRegion\r\n\t\t\tFROM CS_Dispatcher.dp.OperationStaff os\r\n\t\t\tINNER JOIN CS_Dispatcher.dp.PolygonOperationStaff pos on os.id=pos.OperationStaffId and pos.IsActive=1\r\n\t\t\tJOIN DP.Polygon AS p ON p.Id = pos.PolygonId\r\n\t\t\tJOIN @RegionIds AS ri ON ri.Id = p.CityId\r\n\t\t\tWHERE os.IsActive = 1 AND p.IsActive = 1\r\n\t\t\tGROUP BY os.Id,\r\n\t\t\t\tos.Code,\r\n\t\t\t\tos.CustomerId,\r\n\t\t\t\tos.FirstName,\r\n\t\t\t\tos.LastName,\r\n\t\t\t\tos.Mobile\r\n\t\t\tORDER BY COUNT(distinct pos.polygonid) DESC\r\n\r\n\t\t\r\n\r\n\t\tSET @OperationStaffCount = ISNULL(@OperationStaffCount,0)\r\n\t\tSET @TotalRegionPolygonCount = ISNULL(@TotalRegionPolygonCount,0)"},{"Name":"Get_OperationStaff_With_ActivePolygon_By_Filter","Schema":"dbo","Definition":"--/****** Object:  StoredProcedure [dbo].[Report_OperatoinStaff]    Script Date: 1/19/2022 9:35:07 AM ******/\r\n--SET ANSI_NULLS ON\r\n--GO\r\n--SET QUOTED_IDENTIFIER ON\r\n--GO\r\n/*\r\ndeclare @TotalCount nvarchar(max)\r\nexec [dbo].[Get_OperationStaff_With_ActivePolygon_By_Filter]\r\n\t@Name\t=N\u0027\u0627\u062D\u0645\u062F\u0027,\r\n\t@Mobile\t=0,\r\n\t@Code\t=0,\r\n\t@CityId\t=0,\r\n\t@IsActive=NULL,\r\n\t@PageIndex\t=0\t,\r\n\t@PageSize\t=10\t,\r\n\t@TotalCount=@TotalCount out\r\nselect @TotalCount\r\n*/\r\nCREATE        procedure [dbo].[Get_OperationStaff_With_ActivePolygon_By_Filter]\r\n\t@Name\t\t\t\t\t\tNVARCHAR(100)\t,\r\n\t@Mobile\t\t\t\t\t\tBIGINT\t,\r\n\t@Code\t\t\t\t\t\tBIGINT\t\t\t,\r\n\t@CityId\t\t\t\t\t\tSMALLINT\t\t,\r\n\t@IsActive\t\t\t\t\tBIT\t\t\t\t=NULL,\r\n\r\n\t@PageIndex\t\t\t\t\tINT\t,\r\n\t@PageSize\t\t\t\t\tINT\t,\r\n\t@TotalCount\t\t\t\t\tINT OUTPUT\r\nAS\r\n\r\n\t\r\n\t\r\n\tSELECT  @TotalCount=COUNT(DISTINCT os.Id)\r\n\tFROM dp.OperationStaff(NOLOCK) os\r\n\tLEFT JOIN DP.PolygonOperationStaff(NOLOCK) po\t\t\t\tON po.OperationStaffId=os.Id\r\n\tLEFT JOIN dp.Polygon(NOLOCK) p\t\t\t\t\t\t\t\tON p.id=po.PolygonId\r\n\tWHERE \r\n\t\t(os.IsActive=@IsActive\t\t\t\t\t\tOR @IsActive IS NULL)\r\n\tAND (CONCAT(os.FirstName,\u0027 \u0027,os.LastName) like \u0027%\u0027\u002B@Name\u002B\u0027%\u0027\tOR ISNULL(@Name\t,\u0027\u0027)=\u0027\u0027)--read from operaton name\r\n\tAND (os.Mobile=@Mobile\t\t\t\t\t\t\tOR ISNULL(@Mobile,0)=0)\r\n\tAND (os.code=@Code\t\t\t\t\t\t\t\tOR ISNULL(@Code\t,0)=0)\r\n\tAND (p.CityId=@CityId\t\t\t\t\t\t\tOR ISNULL(@CityId,0)=0)\r\n\r\n\r\n\tSELECT\t\r\n\t\tos.id,\r\n\t\tos.CustomerId,\r\n\t\tNULL userName,--c.userName,\r\n\t\tos.firstName,\r\n\t\tos.lastName,\r\n\t\tCONCAT(\u00270\u0027,os.Mobile)\t\t\t\t\t\t\tmobile,\r\n\t\tNULL  Phone,--ISNULL(CONCAT(\u00270\u0027,cph.phoneNumber),0)\t\t\tPhone,\r\n\t\tNULL address,--ISNULL(cp.address,\u0027\u0027)\t\t\t\t\t\t\taddress,\r\n\t\tNULL adminComment,--ISNULL(c.adminComment,\u0027\u0027)\t\t\t\t\t\tadminComment,\r\n\t\tRIGHT(CONCAT(\u00270000000000\u0027,os.code),10)\t\t\tcode,\r\n\t\tos.isActive,\r\n\t\tSUM(CASE WHEN po.IsActive=1 THEN 1 ELSE 0 END ) polygonCount,\r\n\t\t(\r\n\t\t\tSELECT STUFF((SELECT  DISTINCT \u0027,\u0027 \u002B cast(ip.CityId as varchar(5))\r\n\t\t\tFROM DP.PolygonOperationStaff(NOLOCK) ipo \r\n\t\t\tINNER JOIN dp.OperationStaff(NOLOCK) Ios\tON ipo.OperationStaffId=ios.Id \r\n\t\t\tINNER JOIN dp.Polygon(NOLOCK) ip\t\t\tON ip.id=ipo.PolygonId\r\n\t\t\tWHERE ipo.IsActive=1\r\n\t\t\tAND ios.Id=os.id\r\n\t\t\tFOR XML PATH (\u0027\u0027)),1,1,\u0027\u0027)\r\n\t\t)cities\r\n\t\t\t\r\n\tFROM dp.OperationStaff(NOLOCK) os\r\n\tLEFT JOIN DP.PolygonOperationStaff(NOLOCK) po\t\t\t\tON po.OperationStaffId=os.Id\r\n\tLEFT JOIN dp.Polygon(NOLOCK) p\t\t\t\t\t\t\t\tON p.id=po.PolygonId\r\n\tWHERE \r\n\t(os.IsActive=@IsActive\t\t\t\t\t\t\tOR @IsActive IS NULL)\r\n\tAND (CONCAT(os.FirstName,\u0027 \u0027,os.LastName) like \u0027%\u0027\u002B@Name\u002B\u0027%\u0027\tOR ISNULL(@Name\t,\u0027\u0027)=\u0027\u0027)\r\n\tAND (os.Mobile=@Mobile\t\t\t\t\t\t\tOR ISNULL(@Mobile,0)=0)\r\n\tAND (os.code=@Code\t\t\t\t\t\t\t\tOR ISNULL(@Code\t,0)=0)\r\n\tAND (p.CityId=@CityId\t\t\t\t\t\t\tOR ISNULL(@CityId,0)=0)\r\n\r\n\tGROUP BY\r\n\t\tos.Id,\r\n\t\tos.CustomerId,\r\n\t\tos.FirstName,\r\n\t\tos.LastName,\r\n\t\tos.Mobile,\r\n\t\tos.Code,\r\n\t\tos.IsActive\r\n\r\n\tORDER BY os.Id DESC\r\n\tOFFSET (@pageIndex * @pageSize) ROWS \r\n\tFETCH NEXT @pageSize ROWS ONLY\r\n\t\r\n\r\n"},{"Name":"Get_OrchestrationDispatchRequestsInfo","Schema":"dbo","Definition":"\r\nCREATE PROC Get_OrchestrationDispatchRequestsInfo\r\n(\r\n\t@DispatchRequestIds VARCHAR(MAX), --= \u002724318036,24318035,24318034\u0027--,24318033,24318019,24318001,24317854,24317853,24317852,24317851,24317850,24317849,24317840,24317837,24317834,24317826,24317810,24317807,24317806,24317805,24317804,24317803,24317802,24317794,24317792,24317765,24317756,24317734,24317718,24317717,24317716,24317715,24317714,24317713,24317712,24317711,24317710,24317709,24317708,24317707,24317706,24317705,24317704,24317703,24317702,24317701,24317700,24317699,24317698,24317697,24317696,24317695,24317694,24317693,24317692,24317691,24317690,24317689,24317688,24317687,24317686,24317685,24317684,24317683,24317682,24317681,24317680,24317679,24317678,24317677,24317676,24317675,24317674,24317673,24317672,24317671,24317670,24317669,24317668,24317667,24317666,24317665,24317664,24317663,24317662,24317661,24317660,24317659,24317658,24317657,24317655,24317654,24317653,24317652,24317651,24317650,24317649,24317648,24317647,24317646\u0027\r\n\t@Result NVARCHAR(MAX) OUTPUT\r\n)\r\nAS \r\nSET NOCOUNT ON\r\n\r\nDECLARE \r\n\t@STR NVARCHAR(MAX) = \u0027\u0027\r\n\t\r\nSET @STR \u002B=\r\n\u0027 SET @Result = \r\n(\r\nSELECT \r\n\tDRDR.Id,\r\n\tDRDR.ParcelReferenceCode,\r\n\tDRPS.StoreId,\r\n\tDRDR.Version,\r\n\tDRDR.VendorParcelCode,\r\n\tDRDR.PolygonStoreId,\r\n\tDRPS.PolygonId,\r\n\tDRDR.VendorId,\r\n\tDRDR.DeliveryStartTime,\r\n\tDRDR.CourierRequestTypeId,\r\n\tDRDR.DeliveryDeadLineTime,\r\n\t(\r\n\t\tSELECT\r\n\t\t\tDRSTBI.ScoreFactor,\r\n\t\t\tDRDR.VendorId,\r\n\t\t\tUMV.BrandName AS VendorTitle,\r\n\t\t\tPP.Name AS ProvinceTitle,\r\n\t\t\tUMV.ServiceRadius,\r\n\t\t\tDRS.OrderCategoryId,\r\n\t\t\tDRS.StoreType\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t) Store,\r\n\t(\r\n\t\tSELECT\r\n\t\t\tOMCR.ClientName,\r\n\t\t\tOMCR.ClientMobile,\r\n\t\t\tOMCR.ClientAddress,\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tOMCR.ClientLocation.STY  AS  Latitude,\r\n\t\t\t\t\tOMCR.ClientLocation.STX  AS Longitude\r\n\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t) ClientLocation\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t) ClientInfoByDispatchRequest,\r\n\t(\r\n\t\tSELECT \r\n\t\t\tDRDSPRM.DeliveryServiceProviderId\r\n\t\tFROM DP.DeliveryServiceProviderRequestMapper DRDSPRM WITH(NOLOCK)\r\n\t\tWHERE DRDSPRM.DispatchRequestId = DRDR.ID\r\n\t\tAND DRDSPRM.IsActive = 1\r\n\t\tAND DRDSPRM.DeliveryServiceProviderMapperStatusId = 1\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t) PendingDeliveryServiceProviders\r\nFROM DP.DispatchRequest DRDR WITH(NOLOCK)\r\nINNER JOIN DP.PolygonStore DRPS WITH(NOLOCK)\r\n\tON DRDR.PolygonStoreId = DRPS.Id\r\nINNER JOIN CS_OrderManagement.OM.Parcel OMP WITH(NOLOCK)\r\n\tON DRDR.ParcelReferenceCode = OMP.ParcelReferenceCode\r\nINNER JOIN CS_OrderManagement.OM.CourierRequest OMCR WITH(NOLOCK)\r\n\tON OMP.CourierRequestId = OMCR.Id\r\n\tAND OMCR.ConfirmationDate IS NOT NULL\r\nINNER JOIN DP.StoreTechnicalBasicInformation DRSTBI WITH(NOLOCK)\r\n\tON DRPS.StoreId = DRSTBI.StoreId\r\nINNER JOIN DP.Store DRS WITH(NOLOCK)\r\n\tON DRPS.StoreId = DRS.Id\r\nINNER JOIN CS_Public.HAF.City PC WITH(NOLOCK)\r\n\tON DRS.CityId = PC.Id\r\nINNER JOIN CS_Public.HAF.Province PP WITH(NOLOCK)\r\n\tON PC.ProvinceId = PP.Id\r\nINNER JOIN CS_UserManagement.UM.Vendor UMV WITH(NOLOCK)\r\n\tON DRDR.VendorId = UMV.Id\r\nWHERE DRDR.ID IN ( \u0027\u002B@DispatchRequestIds\u002B\u0027 )\r\nFOR JSON PATH \r\n)\u0027\r\n\r\n\r\n\r\nDECLARE @Param NVARCHAR(MAX) = \u0027 @Result NVARCHAR(MAX) OUTPUT\u0027\r\n--SELECT @STR\r\nEXEC sys.sp_executesql @STR,@Param, @Result = @Result OUTPUT\r\n\r\nSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\nSET @Result = REPLACE(@Result,\u0027:\u0022{\u0027,\u0027:{\u0027)\r\nSET @Result = REPLACE(@Result,\u0027}\u0022\u0027,\u0027}\u0027)\r\n\r\n\r\n--SELECT (@Result)\r\n\r\n\r\n"},{"Name":"Get_Returned_By_Filter","Schema":"dbo","Definition":"\r\nCREATE      PROCEDURE [dbo].[Get_Returned_By_Filter]\r\n\t    --@ProvinceId\tSMALLINT = NULL,\r\n\t\t@CityIds VARCHAR(MAX) = NULL,\r\n\t\t@PolygonIds VARCHAR(MAX) = NULL,\r\n\t\t@StoreIds VARCHAR(MAX) = NULL,\r\n\t\t@ParcelReferenceCode BIGINT = NULL,\r\n\t\t@CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n\t\t@StartDeliveryTime BIGINT = NULL,\r\n\t\t@EndDeliveryTime BIGINT = NULL,\r\n\t\t@VendorParcelCode VARCHAR(32) = NULL,\r\n\t\t@VendorID\t\tINT = NULL,\r\n\t\t@DispatchRequestStatusId SMALLINT = NULL,\r\n        @FleetId INT = NULL,\r\n\t\t@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX) = NULL,\r\n\t\t@OrderCategoryIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n        @OrderBy NVARCHAR(200) = NULL,\r\n        @IsAsc BIT = NULL,\r\n\t\t@UnassignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@AssignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@DelayedPickupCount INT = 0 OUTPUT,\r\n\t\t@DelayedDelayedCount INT = 0 OUTPUT,\r\n\t\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t\t@NotPickUpRequestCount\t\t\t\t\t\tINT = 0 OUTPUT,\r\n\t\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t\t@OperationStaffId\t\t\t\t\t\tINT \r\n\r\nAS \r\n\tSET NOCOUNT ON\r\n\tPRINT SYSDATETIME()\r\n    --############################################ Preparation Data ##################################\r\nSET @IsNightly = NULL\r\nSET @IsExclusiveDelivery = NULL\r\nDECLARE @CityIds_Local NVARCHAR(MAX) = NULL,\r\n\t\t@PolygonIds_Local NVARCHAR(MAX) = NULL,\r\n\t\t@StoreIds_Local NVARCHAR(MAX) = NULL,\r\n\t\t@ParcelReferenceCode_Local BIGINT = NULL,\r\n\t\t@CourierRequestTypeIds_Local NVARCHAR(MAX) = NULL,\r\n\t\t@StartDeliveryTime_Local BIGINT = NULL,\r\n\t\t@EndDeliveryTime_Local BIGINT = NULL,\r\n\t\t@VendorParcelCode_Local VARCHAR(32) = NULL,\r\n\t\t@VendorID_Local\t\tINT = NULL,\r\n\t\t@DispatchRequestStatusId_Local SMALLINT = NULL,\r\n        @FleetId_Local INT = NULL,\r\n\t\t@OperationStaffId_Local\tINT ,\r\n\t\t@DeliveryServiceProviderIds_Local VARCHAR(MAX) = NULL,\r\n\t\t@IsExclusiveDelivery_Local\t\tBIT = NULL,\r\n\t\t@IsNightly_Local\t\t\t\tBIT = NULL,\r\n\t\t@OrderCategoryIds_Local VARCHAR(MAX) = NULL\r\n\r\n    drop table if EXISTS    #DispatchRequest,\r\n                            #Shipment,\r\n                            #Fleet,\r\n                            #FinalResult,\r\n\t\t\t\t\t\t\t#AllDispatchRequests,\r\n\t\t\t\t\t\t\t#DeliveryServiceProviderId\r\n    SELECT\r\n\t\t\t@CityIds_Local                                 =ISNULL(@CityIds,\u00270\u0027),\r\n            @PolygonIds_Local\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),\r\n            @StoreIds_Local\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n            @ParcelReferenceCode_Local\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n            @CourierRequestTypeIds_Local                  =ISNULL(@CourierRequestTypeIds,\u00270\u0027),\r\n            @StartDeliveryTime_Local                      =ISNULL(@StartDeliveryTime,0),\r\n            @EndDeliveryTime_Local                        =ISNULL(@EndDeliveryTime,0),\r\n            @VendorParcelCode_Local\t\t\t\t\t    =ISNULL(@VendorParcelCode,\u00270\u0027),\r\n\t\t\t@DispatchRequestStatusId_Local\t\t\t\t=ISNULL(@DispatchRequestStatusId,0),\r\n            @OrderBy\t\t\t\t\t\t\t\t =ISNULL(@OrderBy,\u00270\u0027),\r\n            @IsAsc                                  =ISNULL(@IsAsc,0),\r\n\t\t\t@FleetId_Local                                =ISNULL(@FleetId,0),\r\n\t\t\t@OperationStaffId_Local = ISNULL(@OperationStaffId,0),\r\n\t\t\t@VendorID_Local = ISNULL(@VendorID,0),\r\n\t\t\t@DeliveryServiceProviderIds_Local = ISNULL(@DeliveryServiceProviderIds,\u00270\u0027),\r\n\t\t\t@IsExclusiveDelivery_Local = @IsExclusiveDelivery,\r\n\t\t\t@IsNightly_Local = @IsNightly,\r\n\t\t\t@OrderCategoryIds_Local = ISNULL(@OrderCategoryIds,\u00270\u0027)\r\n\r\n\r\n\t\tSELECT \r\n\t\t\tdsp.Id\r\n\t\tINTO #DeliveryServiceProviderId\r\n\t\tFROM DP.DeliveryServiceProvider dsp(NOLOCK)\r\n\t\tINNER JOIN string_split(@DeliveryServiceProviderIds_Local,\u0027,\u0027) ss\r\n\t\t\tON dsp.Id = ss.value\r\n\t\t\tOR @DeliveryServiceProviderIds_Local = \u00270\u0027\r\n\r\n\t\tCREATE TABLE #CityId \r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO #CityId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CityIds_Local,\u0027,\u0027)\r\n\r\n        CREATE TABLE #PolygonId \r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO #PolygonId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@PolygonIds_Local,\u0027,\u0027)\r\n\r\n        CREATE TABLE #StoreId \r\n\t\t(\r\n\t\t\tId INT\r\n\t\t)\r\n\t\tINSERT INTO #StoreId\r\n\t\tSELECT \r\n\t\t\tvalue\r\n\t\tFROM string_split(@StoreIds_Local,\u0027,\u0027) ss\r\n\r\n\r\n\t\tCREATE TABLE #CourierRequestTypeId\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO #CourierRequestTypeId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CourierRequestTypeIds_Local,\u0027,\u0027)\r\n\r\n\t\tSELECT\r\n\t\t\toc.Id\r\n\t\tINTO #OrderCategoryId\r\n\t\tFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\tINNER JOIN string_split(@OrderCategoryIds_Local,\u0027,\u0027) ss\r\n\t\t\tON oc.Id = ss.value\r\n\t\t\tOR @OrderCategoryIds_Local = \u00270\u0027\r\n\r\n\t\tDECLARE @Today BIGINT,@Yesterday BIGINT\r\n\t\tSELECT @Today = FORMAT(GETDATE(),\u0027yyyyMMdd\u0027)\u002B\u0027235959999\u0027\r\n\t\tselect @Yesterday = FORMAT(GETDATE()-1,\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027 \r\n\r\n\r\n\t\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t/*\r\n\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\tLEFT(DeliveryStartTime,8) DeliveryStartTime_Date,\r\n\t\t\t\tddr.PolygonStoreId,\r\n\t\t\t\tdp.Id PolygonId,\r\n\t\t\t\tdp.Title PolygonTitle,\r\n\t\t\t\tps.StoreId,\r\n\t\t\t\ts.title\tStoreTitle,\r\n\t\t\t\tdp.CityId,\r\n\t\t\t\tddr.VendorParcelCode\r\n\t\tINTO #AllDispatchRequests\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore (NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\tAND (dp.Id IN (SELECT Id FROM #PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and (dp.CityId IN (SELECT Id FROM #CityId) OR @CityIds=\u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\t\t\r\n----------------------------------------------------------------------------------------------------\r\n\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (5,6)\r\n\t\t\t  AND dr.DeliveryStartTime_Date = @Today\r\n\r\n\r\n\r\n\t\tSELECT \r\n\t\t\t\t@AssignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,47,48,49,50,51,52,53,54)\r\n\t\t\t  --AND dr.DeliveryStartTime_Date = @Today\r\n\r\n/******************************DelayedPickupCount**********************************************************/\r\n\r\n\t\tSELECT\r\n\t\t\t\t@DelayedPickupCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE dr.DispatchRequestStatusId in (10,11,15,16)\r\n\t\t--AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30\r\n\t\tAND sdp.OperationTypeId = 5\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\t\t----------------------------------------------------------------------------------------\r\n\t\tSELECT\r\n\t\t\t\t@DelayedDelayedCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE sdp.OperationTypeId IN (10) \r\n\t\t--AND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t\tAND dr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n/********************************UnassignedReturnAndReplacementRequestCount*************************************************************/\r\n\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT ddr.ParcelReferenceCode)\r\n\t\tFROM #AllDispatchRequests ddr\r\n\tWHERE ddr.DispatchRequestStatusId in (5) \r\n\tAND CourierRequestTypeId in (26,30,35,40,45,50,60,65,70)\r\n\t\t*/\r\n    --############################################ Pre Calculate Result ##############################################\r\n\t--SET @DelayedDelayedCount = NULL\r\n\t--SET @DelayedPickupCount = NULL\r\n\t--SET @NotPickupRequestCount = NULL\r\n\t--SET @AssignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedReturnAndReplacementRequestCount = NULL\r\n\r\n\t--EXEC Get_OperationPanel_Count\r\n\t--\t@OperationStaffId = @OperationStaffId_Local,\r\n\t--\t@CityIds = @CityIds_Local,\r\n\t--\t@PolygonIds = @PolygonIds_Local,\r\n\t--\t@VendorID = @VendorID_Local,\r\n\t--\t@UnassignedDispatchRequestCount\t\t\t\t = @UnassignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t@AssignedDispatchRequestCount\t\t\t\t = @AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t@DelayedDeliveryCount\t\t\t\t\t\t = @DelayedDelayedCount\t\t\t\t\t\t\tOUTPUT,\r\n\t--\t@UnassignedReturnAndReplacementRequestCount  = @UnassignedReturnAndReplacementRequestCount\tOUTPUT,\r\n\t--\t@NotPickupRequestCount\t\t\t\t\t\t = @NotPickupRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t@DelayedPickupCount\t\t\t\t\t\t\t = @DelayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = ISNULL(@UnassignedDispatchRequestCount,0),\t\t\t\r\n\t--\t@AssignedDispatchRequestCount = ISNULL(@AssignedDispatchRequestCount,0),\t\t\t\t\t\t\t\t\t\r\n\t--\t@DelayedDelayedCount = ISNULL(@DelayedDelayedCount,0),\t\t\t\t\t\t\r\n\t--\t@UnassignedReturnAndReplacementRequestCount = ISNULL(@UnassignedReturnAndReplacementRequestCount,0),\t\r\n\t--\t@NotPickupRequestCount = ISNULL(@NotPickupRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@DelayedPickupCount = ISNULL(@DelayedPickupCount,0)\t\t\r\n\r\n\t; WITH CTE_DR AS \r\n\t\t(\r\n\t\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\t\tddr.DeliveryStartTime,\r\n\t\t\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\t\t\tddr.IsWaitingForSupport,\r\n\t\t\t\t\tddr.Version\r\n\r\n\t\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\tON ddr.DeliveryServiceProviderId = dspID.Id\r\n\t\t\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\t\t\tON ps.StoreId = s.Id\r\n\t\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\t\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\t\tAND (dp.Id IN (SELECT Id FROM #PolygonId) OR @PolygonIds_Local=\u00270\u0027)\r\n\t\t\tand (dp.CityId IN (SELECT Id FROM #CityId) OR @CityIds_Local=\u00270\u0027)\r\n\t\t\tAND (pos.OperationStaffId = @OperationStaffId_Local)\r\n\t\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery_Local OR @IsExclusiveDelivery_Local IS NULL )\r\n\t\t\tAND ( ddr.IsNightly = @IsNightly_Local OR @IsNightly_Local IS NULL )\r\n\t\t\tAND ( ddr.VendorId = @VendorID_Local OR @VendorID_Local = 0)\r\n\t\t)\r\n\t\tSELECT \r\n\t\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT SQ.UnassignedDispatchRequestCount),\r\n\t\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT SQ.AssignedDispatchRequestCount),\r\n\t\t\t@DelayedDelayedCount = COUNT(DISTINCT SQ.DelayedDelayedCount),\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT SQ.UnassignedReturnAndReplacementRequestCount),\r\n\t\t\t@DelayedPickupCount = COUNT(DISTINCT SQ.DelayedPickupCount),\r\n\t\t\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (5,6,7)  AND DeliveryStartTime BETWEEN @Yesterday AND @Today\r\n\t\t\t\t\tTHEN dr.DispatchRequestId \r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS UnassignedDispatchRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS AssignedDispatchRequestCount,\r\n\t\t\t\tNULL AS DelayedDelayedCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN \r\n\t\t\t\t\t\tdr.DispatchRequestStatusId = 5\r\n\t\t\t\t\t\tAND dr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70)\r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t\r\n\t\t\t\tNULL AS DelayedPickupCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN \r\n\t\t\t\t\t\tdr.IsWaitingForSupport = 1 \r\n\t\t\t\t\t\tAND dr.DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS NotPickupRequestCount\r\n\t\t\tFROM CTE_DR dr\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT\r\n\t\t\t\tNULL AS UnassignedDispatchRequestCount,\r\n\t\t\t\tNULL AS AssignedDispatchRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN sdp.OperationTypeId = 10 AND dr.DispatchRequestStatusId IN ( 20,25 )\r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS DelayedDelayedCount,\r\n\t\t\t\tNULL AS UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN sdp.OperationTypeId = 5 AND dr.DispatchRequestStatusId IN ( 10,11,15,16 )\r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS DelayedPickupCount,\r\n\t\t\t\tNULL AS NotPickupRequestCount\r\n\t\t\tFROM CTE_DR dr\r\n\t\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  \r\n\t\t\t\tON sdpdr.DispatchRequestId = dr.DispatchRequestId \r\n\t\t\t\tAND dr.DispatchRequestStatusId IN (10,11,15,16,20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\t\t\t\tAND dr.Version = sdpdr.Version\r\n\t\t\tINNER JOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  \r\n\t\t\t\tON sdp.Id = sdpdr.ShipmentDestinationPointId \r\n\t\t\t\tAND sdp.OperationTypeId IN (5,10) \r\n\t\t\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= getdate() \r\n\r\n\t\t) SQ\r\n\t\t\r\n\t\t--OPTION(RECOMPILE)--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\t\tPRINT SYSDATETIME()\r\n\r\n\t\t\tSELECT \r\n\t\t\t\t\t\t[dr].[Id],\r\n\t\t\t\t\t\t[dr].[DispatchRequestStatusId],\r\n\t\t\t\t\t\t[dr].[ParcelReferenceCode],\r\n\t\t\t\t\t\tdr.CourierRequestTypeId,\r\n\t\t\t\t\t\tp1.CityId,\r\n\t\t\t\t\t\tps.PolygonId,\r\n\t\t\t\t\t\tp1.Title as PolygonTitle,\r\n\t\t\t\t\t\tStoreId,\r\n\t\t\t\t\t\ts.[Location].STY  StoreLocationLatitude,\r\n\t\t\t\t\t\ts.[Location].STX StoreLocationLongitude,\r\n\t\t\t\t\t\ts.Title as StoreTitle,\r\n\t\t\t\t\t\tdr.DeliveryStartTime,\r\n\t\t\t\t\t\tdr.DeliveryStartTimePersian,\r\n\t\t\t\t\t\tdr.DeliveryDeadLineTime,\r\n\t\t\t\t\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\t\t\t\t\tdr.ClientAddress,\r\n\t\t\t\t\t\tdr.ClientLocation.STY ClientLocationLatitude,\r\n\t\t\t\t\t\tdr.ClientLocation.STX ClientLocationLongitude,\r\n\t\t\t\t\t  ISNULL(dr.AssignmentTryCount,0) as FleetPreAssignmentStateCount,\r\n\t\t\t\t\t\tdr.VendorParcelCode,\r\n\t\t\t\t\t\tdr.CreateDate,\r\n\t\t\t\t\t\tdr.CreateDatePersian,\r\n\t\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\t\tdr.VendorId,\r\n\t\t\t\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\t\t\t\ts.orderCategoryId,\r\n\t\t\t\t\t\toc.Title AS orderCategoryTitle\r\n\t\t\tINTO #Final\r\n\t\t\tFROM dp.DispatchRequest dr (NOLOCK) \r\n\t\t\tjoin dp.DispatchRequestStatus drs (NOLOCK)  on dr.DispatchRequestStatusId = drs.Id\r\n\t\t\tjoin dp.PolygonStore ps (NOLOCK)  on dr.PolygonStoreId = ps.Id\r\n\r\n\t\t\tjoin dp.Polygon p1 (NOLOCK)  on ps.PolygonId = p1.Id\r\n\t\t\tjoin dp.Store s (NOLOCK)  on ps.StoreId = s.Id\r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n\t\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\tON dr.DeliveryServiceProviderId = dspID.Id\r\n\t\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\t\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\t\t\tON s.OrderCategoryId = oc.Id\r\n\r\n\t\t\twhere (\r\n\t\t\t\t\t(DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n\t\t\t\t\t\r\n\t\t\t\t  )\r\n\t\t\tAND (dr.DispatchRequestStatusId = @DispatchRequestStatusId_Local OR @DispatchRequestStatusId_Local = 0)\r\n\t\t\tand ((dr.DeliveryStartTime BETWEEN @StartDeliveryTime_Local and @EndDeliveryTime or dr.DeliveryDeadLineTime BETWEEN @StartDeliveryTime_Local and @EndDeliveryTime) or @StartDeliveryTime_Local = 0 or @EndDeliveryTime_Local = 0)\r\n\t\t\tand ((s.Id IN (Select Id from #StoreId)) OR (@StoreIds_Local=\u00270\u0027))\r\n\t\t\tand (p1.Id IN (SELECT Id FROM #PolygonId) OR @PolygonIds_Local=\u00270\u0027)\r\n\t\t\tand ((dr.CourierRequestTypeId in (Select Id FROM #CourierRequestTypeId)) OR (@CourierRequestTypeIds_Local = \u00270\u0027))\r\n\t\t\tand (p1.CityId IN (SELECT Id FROM #CityId) OR @CityIds_Local=\u00270\u0027)\r\n\t\t\tand (dr.ParcelReferenceCode = @ParcelReferenceCode_Local OR @ParcelReferenceCode_Local = 0)\r\n\t\t\tand (dr.VendorParcelCode = @VendorParcelCode_Local or @VendorParcelCode_Local = \u00270\u0027)\r\n\t\t\tAND (pos.OperationStaffId = @OperationStaffId_Local)\r\n\t\t\tAND ( dr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\t\tAND ( dr.IsNightly = @IsNightly OR @IsNightly IS NULL)\r\n\t\t\tAND ( dr.VendorId = @VendorID_Local OR @VendorID_Local = 0)\r\n\r\n\t\t\tAND EXISTS \r\n\t\t\t(\r\n\t\t\t\tSELECT 1 \r\n\t\t\t\tFROM dp.ShipmentDestinationPointDispatchRequest s3 (NOLOCK)  \r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)   on sdp.id = s3.ShipmentDestinationPointId and OperationTypeId IN( 15,10)\r\n\t\t\t\tINNER join dp.Shipment s (NOLOCK)  on s.id = sdp.ShipmentId\r\n\t\t\t\tINNER join dp.ShipmentStatus ss (NOLOCK)  on s.ShipmentStatusId = ss.Id\r\n\t\t\t\tWHERE dr.id = s3.DispatchRequestId\r\n\t\t\t)\r\n\t\tUNION  ALL\r\n\t\tSELECT \r\n\t\t\t\t[dr].[Id],\r\n\t\t\t\t[dr].[DispatchRequestStatusId],\r\n\t\t\t\t[dr].[ParcelReferenceCode],\r\n\t\t\t\tdr.CourierRequestTypeId,\r\n\t\t\t\tp1.CityId,\r\n\t\t\t\tps.PolygonId,\r\n\t\t\t\tp1.Title as PolygonTitle,\r\n\t\t\t\tStoreId,\r\n\t\t\t\ts.[Location].STY  StoreLocationLatitude,\r\n\t\t\t\ts.[Location].STX StoreLocationLongitude,\r\n\t\t\t\ts.Title as StoreTitle,\r\n\t\t\t\tdr.DeliveryStartTime,\r\n\t\t\t\tdr.DeliveryStartTimePersian,\r\n\t\t\t\tdr.DeliveryDeadLineTime,\r\n\t\t\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\t\t\tdr.ClientAddress,\r\n\t\t\t\tdr.ClientLocation.STY ClientLocationLatitude,\r\n\t\t\t\tdr.ClientLocation.STX ClientLocationLongitude,\r\n\t\t\t\tISNULL(dr.AssignmentTryCount,0) as FleetPreAssignmentStateCount,\r\n\t\t\t\tdr.VendorParcelCode,\r\n\t\t\t\tdr.CreateDate,\r\n\t\t\t\tdr.CreateDatePersian,\r\n\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\tdr.IsNightly,\r\n\t\t\t\tdr.VendorId,\r\n\t\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\t\ts.orderCategoryId,\r\n\t\t\t\toc.Title AS orderCategoryTitle\r\n\r\n\r\n\t\t\tFROM dp.DispatchRequest dr (NOLOCK) \r\n\t\t\t\r\n\t\t\tjoin dp.PolygonStore ps (NOLOCK)  on dr.PolygonStoreId = ps.Id\r\n\r\n\t\t\tjoin dp.Polygon p1 (NOLOCK)  on ps.PolygonId = p1.Id\r\n\t\t\tjoin dp.Store s (NOLOCK)  on ps.StoreId = s.Id\r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n\t\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\tON dr.DeliveryServiceProviderId = dspID.Id\r\n\t\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\t\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\t\t\tON s.OrderCategoryId = oc.Id\r\n\t\t\twhere (\r\n\t\t\t\t\t(DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\n\t\t\t\t  )\r\n\t\t\tAND (dr.DispatchRequestStatusId = @DispatchRequestStatusId_Local OR @DispatchRequestStatusId_Local = 0)\r\n\t\t\tand ((dr.DeliveryStartTime BETWEEN @StartDeliveryTime_Local and @EndDeliveryTime_Local or dr.DeliveryDeadLineTime BETWEEN @StartDeliveryTime_Local and @EndDeliveryTime_Local) or @StartDeliveryTime_Local = 0 or @EndDeliveryTime_Local = 0)\r\n\t\t\tand ((s.Id IN (Select Id from #StoreId)) OR (@StoreIds_Local=\u00270\u0027))\r\n\t\t\tand (p1.Id IN (SELECT Id FROM #PolygonId) OR @PolygonIds_Local=\u00270\u0027)\r\n\t\t\tand ((dr.CourierRequestTypeId in (Select Id FROM #CourierRequestTypeId)) OR (@CourierRequestTypeIds_Local = \u00270\u0027))\r\n\t\t\tand (p1.CityId IN (SELECT Id FROM #CityId) OR @CityIds_Local=\u00270\u0027)\r\n\t\t\tand (dr.ParcelReferenceCode = @ParcelReferenceCode_Local OR @ParcelReferenceCode_Local = 0)\r\n\t\t\tand (dr.VendorParcelCode = @VendorParcelCode_Local or @VendorParcelCode_Local = \u00270\u0027)\r\n\t\t\tAND (pos.OperationStaffId = @OperationStaffId_Local)\r\n\t\t\tAND ( dr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\t\tAND ( dr.IsNightly = @IsNightly OR @IsNightly IS NULL)\r\n\t\t\tAND ( dr.VendorId = @VendorID_Local OR @VendorID_Local = 0)\r\n\t\t\t\r\n\t\t\tAND EXISTS \r\n\t\t\t(\r\n\t\t\t\tSELECT 1 \r\n\t\t\t\tFROM dp.ShipmentDestinationPointDispatchRequest s3 (NOLOCK)  \r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)   on sdp.id = s3.ShipmentDestinationPointId and OperationTypeId IN( 15,10)\r\n\t\t\t\tINNER join dp.Shipment s (NOLOCK)  on s.id = sdp.ShipmentId\r\n\t\t\t\tINNER join dp.ShipmentStatus ss (NOLOCK)  on s.ShipmentStatusId = ss.Id\r\n\t\t\t\tWHERE dr.id = s3.DispatchRequestId\r\n\t\t\t)\r\n\t\t\t\r\n\t\t\tSET @TotalCount = @@ROWCOUNT\r\n\t\t\tPRINT SYSDATETIME()\r\n\r\n\t\t;WITH CTE_DR AS\r\n\t\t(\r\n\t\t\tSELECT * FROM #Final\r\n\t\t\t ORDER by \r\n\t\t\t\t\t CASE \r\n\t\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027DeliveryDeadLineTimeStr\u0027 AND @IsAsc = 1 THEN FORMAT([DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027)\r\n\t\t\t\t\t End ASC,\r\n\t\t\t\t\t CASE\r\n\t\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027DeliveryDeadLineTimeStr\u0027 AND @IsAsc = 0 THEN FORMAT([DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027)\r\n\t\t\t\t\t End DESC,\r\n\t\t\t\t\t CASE \r\n\t\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027RemainedToDeadlineSeconds\u0027 AND @IsAsc = 1 THEN CAST(DATEDIFF(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSECOND,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tGETDATE(),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tCAST(CONVERT(VARCHAR, FORMAT(DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t) as BIGINT)\r\n\t\t\t\t\tEnd ASC,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\t\tWHEN (@OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027RemainedToDeadlineSeconds\u0027 AND @IsAsc = 0) OR (@OrderBy IS NULL OR @OrderBy = \u00270\u0027) THEN CAST(DATEDIFF(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSECOND,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tGETDATE(),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tCAST(CONVERT(VARCHAR, FORMAT(DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t) as BIGINT)\r\n\t\t\t\t\tEnd DESC\r\n\t\t\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\t\t),CTE_Shipment AS\r\n\t\t(\r\n\t\t\tSELECT * FROM\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\ts.Id,\r\n\t\t\t\t\ts.ShipmentStatusId as StatusId,\r\n\t\t\t\t\tss.Title as StatusTitle,\r\n\t\t\t\t\tShipmentNumber,\r\n\t\t\t\t\ts.FleetId,\r\n\t\t\t\t\tdr.Id as DispatchRequestId,\r\n\t\t\t\t\tROW_NUMBER() over (partition by dr.id order by dr.id,sdp.id desc) RowNum\r\n\t\t\t\tfrom CTE_DR dr\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest s3 (NOLOCK)  on dr.id = s3.DispatchRequestId\r\n\t\t\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)   on sdp.id = s3.ShipmentDestinationPointId and OperationTypeId IN( 15,10)\r\n\t\t\t\tINNER join dp.Shipment s (NOLOCK)  on s.id = sdp.ShipmentId\r\n\t\t\t\tINNER join dp.ShipmentStatus ss (NOLOCK)  on s.ShipmentStatusId = ss.Id\r\n\t\t\t) SQ\r\n\t\t\tWHERE SQ.RowNum = 1\r\n\t\t), CTE_Fleet AS\r\n\t\t(\r\n        select \r\n                    f.Id,\r\n                    DriverId,\r\n                    FirstName \u002B \u0027 \u0027 \u002B LastName as DriverName,\r\n                    \u00270\u0027\u002BCAST(d.Mobile AS VARCHAR(20)) as DriverMobile,\r\n                    v.VehicleTypeId,\r\n                    v.PlateNumber,\r\n                    s.Id as ShipmentId,\r\n                    s.DispatchRequestId\r\n\r\n        from CTE_Shipment s\r\n        join CS_DriverManagement.DM.Fleet f (NOLOCK)  on s.FleetId = f.Id\r\n        join CS_DriverManagement.DM.Driver d (NOLOCK)  on f.DriverId = d.Id\r\n        join CS_DriverManagement.DM.Vehicle v (NOLOCK)  on f.VehicleId = v.Id\r\n\t\t),CTE_DSPRMR AS\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\td.Id,\r\n\t\t\t\tdsprm.DeliveryServiceProviderOrderId\r\n\t\t\tFROM CTE_DR d\r\n\t\t\tINNER JOIN DP.DispatchRequest dr (NOLOCK)\r\n\t\t\t\tON d.VendorId = dr.VendorId\r\n\t\t\t\tAND d.VendorParcelCode = dr.VendorParcelCode\r\n\t\t\t\tAND d.CourierRequestTypeId = 25\r\n\t\t\t\tAND dr.CourierRequestTypeId IN ( 5,10,15 )\r\n\t\t\tINNER JOIN DP.DeliveryServiceProviderRequestMapper dsprm\r\n\t\t\t\tON dr.Id = dsprm.DispatchRequestId\r\n\t\t\t\tAND dsprm.IsActive = 1\r\n\t\t),CTE_DSPRM AS\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tdr.Id,\r\n\t\t\t\tdsprm.DeliveryServiceProviderOrderId\r\n\t\t\tFROM CTE_DR dr\r\n\t\t\tINNER JOIN DP.DeliveryServiceProviderRequestMapper dsprm\r\n\t\t\t\tON dr.Id = dsprm.DispatchRequestId\r\n\t\t\t\tAND dsprm.IsActive = 1\r\n\t\t)\r\n    --############################################ Calculate Result ##############################################\r\n\t,CTE_OUTPUT AS\r\n\t(\r\n        select \r\n            [dr].[Id] DispatchRequestId,\r\n            [dr].[DispatchRequestStatusId],\r\n            [dr].[ParcelReferenceCode],\r\n            [dr].[CourierRequestTypeId],\r\n            [dr].[CityId],\r\n            [dr].[PolygonId],\r\n            [dr].[PolygonTitle],\r\n            [dr].[StoreId],\r\n            [dr].[StoreLocationLatitude],\r\n            dr.StoreLocationLongitude,\r\n            [dr].[StoreTitle],\r\n            [dr].[DeliveryStartTime],\r\n            [dr].[DeliveryStartTimePersian],\r\n            [dr].[DeliveryDeadLineTime],\r\n            [dr].[DeliveryDeadLineTimePersian],\r\n            [dr].[ClientAddress],\r\n            [dr].[ClientLocationLatitude],\r\n            dr.ClientLocationLongitude,\r\n            [dr].[FleetPreAssignmentStateCount],\r\n            [dr].[VendorParcelCode],\r\n            dr.CreateDate,\r\n            [dr].[CreateDatePersian] ,\r\n\r\n            [s].[Id] as ShipmentId,\r\n            [s].[StatusId] as ShipmentStatusId,\r\n            [s].[StatusTitle] as ShipmentStatusTitle,\r\n            [s].[ShipmentNumber],\r\n\r\n            [f].[Id] FleetId,\r\n            [f].[DriverId],\r\n            [f].[DriverName],\r\n            [f].[DriverMobile],\r\n            [f].[VehicleTypeId],\r\n            [f].[PlateNumber],\r\n\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\tdr.IsNightly,\r\n\t\t\tdr.VendorId,\r\n\t\t\tv.BrandName AS VendorBrandName,\r\n\t\t\tdr.DeliveryServiceProviderId,\r\n\t\t\tCASE WHEN dr.CourierRequestTypeId = 25 THEN dsprmr.DeliveryServiceProviderOrderId ELSE dsprm.DeliveryServiceProviderOrderId END DeliveryServiceProviderOrderId,\r\n\t\t\tdr.orderCategoryId,\r\n\t\t\tdr.orderCategoryTitle\r\n        from CTE_DR dr\r\n        INNER JOIN CTE_Shipment s on dr.Id = s.DispatchRequestId\r\n        INNER JOIN CTE_Fleet f on s.DispatchRequestId = f.DispatchRequestId and s.Id = f.ShipmentId\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\tON dr.VendorId = v.Id\r\n\t\tLEFT JOIN CTE_DSPRMR dsprmr\r\n\t\t\tON dr.id = dsprmr.Id\r\n\t\tLEFT JOIN CTE_DSPRM dsprm\r\n\t\t\tON dr.Id = dsprm.Id\r\n\t)\r\n        select \r\n\t\t\tDispatchRequestId\t\t\t\t,\r\n\t\t\tDispatchRequestStatusId\t\t\t,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN DispatchRequestStatusId = 20 THEN N\u0027\u0645\u0631\u062C\u0648\u0639 \u0634\u062F\u0027\r\n\t\t\t\tWHEN DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\tWHEN DispatchRequestStatusId = 30 THEN N\u0027\u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\tELSE drs.Title\r\n\t\t\tEND AS DispatchRequestStatusTitle\t\t,\r\n\t\t\tParcelReferenceCode\t\t\t\t,\r\n\t\t\tCourierRequestTypeId\t\t\t,\r\n\t\t\tCityId\t\t\t\t\t\t\t,\r\n\t\t\tPolygonId\t\t\t\t\t\t,\r\n\t\t\tPolygonTitle\t\t\t\t\t,\r\n\t\t\tStoreId\t\t\t\t\t\t\t,\r\n\t\t\tStoreLocationLatitude\t\t\t,\r\n\t\t\tStoreLocationLongitude\t\t\t,\r\n\t\t\tStoreTitle\t\t\t\t\t\t,\r\n            FORMAT([DeliveryStartTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryStartTimeStr,\r\n            FORMAT([DeliveryStartTimePersian],\u0027####/##/## ##:##:##\\.###\u0027)DeliveryStartTimePersianStr,\r\n            FORMAT([DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryDeadLineTimeStr,\r\n            FORMAT([DeliveryDeadLineTimePersian],\u0027####/##/## ##:##:##\\.###\u0027) DeliveryDeadLineTimePersianStr,\r\n\t\t\tClientAddress\t\t\t\t\t,\r\n\t\t\tClientLocationLatitude\t\t\t,\r\n\t\t\tClientLocationLongitude\t\t\t,\r\n\t\t\tFleetPreAssignmentStateCount\t,\r\n\t\t\tCAST(DATEDIFF(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSECOND,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tGETDATE(),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tCAST(CONVERT(VARCHAR, FORMAT(DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)\r\n\r\n\t\t\t\t\t\t\t\t\t\t) as BIGINT) RemainedToDeadlineSeconds\t\t,\r\n\t\t\tVendorParcelCode\t\t\t\t,\r\n\t\t\tCreateDate\t\t\t\t\t\t,\r\n\t\t\tFORMAT([CreateDatePersian],\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersianStr\t\t\t,\r\n\t\t\tShipmentId\t\t\t\t\t\t,\r\n\t\t\tShipmentStatusId\t\t\t\t,\r\n\t\t\tShipmentStatusTitle\t\t\t\t,\r\n\t\t\tShipmentNumber\t\t\t\t\t,\r\n\t\t\tFleetId\t\t\t\t\t\t\t,\r\n\t\t\tDriverId\t\t\t\t\t\t,\r\n\t\t\tDriverName\t\t\t\t\t\t,\r\n\t\t\tDriverMobile\t\t\t\t\t,\r\n\t\t\tVehicleTypeId\t\t\t\t\t,\r\n\t\t\tPlateNumber\t\t\t\t\t\t,\r\n\t\t\tIsExclusiveDelivery\t\t\t\t,\r\n\t\t\tIsNightly\t\t\t\t\t\t,\r\n\t\t\tVendorId\t\t\t\t\t\t,\r\n\t\t\tVendorBrandName\t\t\t\t\t,\r\n\t\t\tDeliveryServiceProviderId,\r\n\t\t\tDeliveryServiceProviderOrderId,\r\n\t\t\torderCategoryId,\r\n\t\t\torderCategoryTitle\r\n        from CTE_OUTPUT\r\n\t\tINNER JOIN dp.DispatchRequestStatus drs (NOLOCK)  on DispatchRequestStatusId = drs.Id\r\n        ORDER by \r\n                 CASE \r\n                    WHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027DeliveryDeadLineTimeStr\u0027 AND @IsAsc = 1 THEN FORMAT([DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027)\r\n                 End ASC,\r\n                 CASE\r\n                    WHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027DeliveryDeadLineTimeStr\u0027 AND @IsAsc = 0 THEN FORMAT([DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027)\r\n                 End DESC,\r\n\t\t\t\t CASE \r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027RemainedToDeadlineSeconds\u0027 AND @IsAsc = 1 THEN CAST(DATEDIFF(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSECOND,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tGETDATE(),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tCAST(CONVERT(VARCHAR, FORMAT(DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)\r\n\r\n\t\t\t\t\t\t\t\t\t\t) as BIGINT)\r\n\t\t\t\tEnd ASC,\r\n\t\t\t\tCASE\r\n\t\t\t\t\tWHEN (@OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027RemainedToDeadlineSeconds\u0027 AND @IsAsc = 0) OR (@OrderBy IS NULL OR @OrderBy = \u00270\u0027) THEN CAST(DATEDIFF(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSECOND,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tGETDATE(),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tCAST(CONVERT(VARCHAR, FORMAT(DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)\r\n\r\n\t\t\t\t\t\t\t\t\t\t) as BIGINT)\r\n\t\t\t\tEnd DESC\r\n\t\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @DelayedDelayedCount\t\t\t\t\t\t = ISNULL(@DelayedDelayedCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)"},{"Name":"Get_Returned_By_Filter_BACKUP","Schema":"dbo","Definition":"--############################################################################################################################################################################################################\r\n-- Stored Procedure\r\n\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/07/26\r\n--\tDescription:\tGet Returned List By Filter\r\n--\tUpdate date\t\t1401/08/11 Parisa Khorshidi\r\n--\t=======================================\r\n\r\n/*\r\n\tDECLARE\t@return_value int,\r\n\t\t\t@UnassignedDispatchRequestCount int,\r\n\t\t\t@AssignedDispatchRequestCount int,\r\n\t\t\t@DelayedPickupCount int,\r\n\t\t\t@DelayedDelayedCount int,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount int,\r\n\t\t\t@TotalCount\tINT\r\n\r\n\tEXEC\t@return_value = [dbo].[Get_Returned_By_Filter]\r\n\t\t\t@UnassignedDispatchRequestCount = @UnassignedDispatchRequestCount OUTPUT,\r\n\t\t\t@AssignedDispatchRequestCount = @AssignedDispatchRequestCount OUTPUT,\r\n\t\t\t@DelayedPickupCount = @DelayedPickupCount OUTPUT,\r\n\t\t\t@DelayedDelayedCount = @DelayedDelayedCount OUTPUT,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount = @UnassignedReturnAndReplacementRequestCount OUTPUT,\r\n\t\t\t@TotalCount = @TotalCount OUTPUT,\r\n\t\t\t@PageIndex = 0,\r\n\t\t\t@PageSize = 100,\r\n\t\t\t@OperationStaffId = 100\r\n\r\n\tSELECT\t@UnassignedDispatchRequestCount as N\u0027@UnassignedDispatchRequestCount\u0027,\r\n\t\t\t@AssignedDispatchRequestCount as N\u0027@AssignedDispatchRequestCount\u0027,\r\n\t\t\t@DelayedPickupCount as N\u0027@DelayedPickupCount\u0027,\r\n\t\t\t@DelayedDelayedCount as N\u0027@DelayedDelayedCount\u0027,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount as N\u0027@UnassignedReturnAndReplacementRequestCount\u0027,\r\n\t\t\t@TotalCount AS N\u0027@TotalCount\u0027\r\n\r\n*/\r\nCREATE      PROCEDURE [dbo].[Get_Returned_By_Filter_BACKUP]\r\n\t    --@ProvinceId\tSMALLINT = NULL,\r\n\t\t@CityIds NVARCHAR(MAX) = NULL,\r\n\t\t@PolygonIds NVARCHAR(MAX) = NULL,\r\n\t\t@StoreIds NVARCHAR(MAX) = NULL,\r\n\t\t@ParcelReferenceCode BIGINT = NULL,\r\n\t\t@CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n\t\t@StartDeliveryTime BIGINT = NULL,\r\n\t\t@EndDeliveryTime BIGINT = NULL,\r\n\t\t@VendorParcelCode VARCHAR(32) = NULL,\r\n\t\t@DispatchRequestStatusId SMALLINT = NULL,\r\n        @FleetId INT = NULL,\r\n\t\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n        @OrderBy NVARCHAR(200) = NULL,\r\n        @IsAsc BIT = NULL,\r\n\t\t@UnassignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@AssignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@DelayedPickupCount INT = 0 OUTPUT,\r\n\t\t@DelayedDelayedCount INT = 0 OUTPUT,\r\n\t\t@UnassignedReturnAndReplacementRequestCount INT = 0 OUTPUT,\r\n\t\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t\t@OperationStaffId\t\t\t\t\t\tINT \r\n\r\nAS \r\n\tSET NOCOUNT ON\r\n    --############################################ Preparation Data ##################################\r\n\r\n    drop table if EXISTS    #DispatchRequest,\r\n                            #Shipment,\r\n                            #Fleet,\r\n                            #FinalResult,\r\n\t\t\t\t\t\t\t#AllDispatchRequests\r\n    SELECT\r\n\t\t\t@CityIds                                 =ISNULL(@CityIds,\u00270\u0027),\r\n            @PolygonIds\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),\r\n            @StoreIds\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n            @ParcelReferenceCode\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n            @CourierRequestTypeIds                  =ISNULL(@CourierRequestTypeIds,0),\r\n            @StartDeliveryTime                      =ISNULL(@StartDeliveryTime,0),\r\n            @EndDeliveryTime                        =ISNULL(@EndDeliveryTime,0),\r\n            @VendorParcelCode\t\t\t\t\t    =ISNULL(@VendorParcelCode,\u00270\u0027),\r\n\t\t\t@DispatchRequestStatusId\t\t\t\t=ISNULL(@DispatchRequestStatusId,0),\r\n            @OrderBy                                =ISNULL(@OrderBy,\u00270\u0027),\r\n            @IsAsc                                  =ISNULL(@IsAsc,0),\r\n\t\t\t@FleetId                                =ISNULL(@FleetId,0)\r\n\t\t\r\n\r\n\t\tDECLARE @CityId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CityId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\r\n        DECLARE @PolygonId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @PolygonId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\r\n        DECLARE @StoreId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @StoreId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@StoreIds,\u0027,\u0027)\r\n\r\n\t\tDECLARE @CourierRequestTypeId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CourierRequestTypeId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CourierRequestTypeIds,\u0027,\u0027)\r\n\r\n\t\tDECLARE @Today INT\r\n\t\tSELECT @Today = CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\r\n\r\n\t\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\r\n\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\tLEFT(DeliveryStartTime,8) DeliveryStartTime_Date,\r\n\t\t\t\tddr.PolygonStoreId,\r\n\t\t\t\tdp.Id PolygonId,\r\n\t\t\t\tdp.Title PolygonTitle,\r\n\t\t\t\tps.StoreId,\r\n\t\t\t\ts.title\tStoreTitle,\r\n\t\t\t\tdp.CityId,\r\n\t\t\t\tddr.VendorParcelCode\r\n\t\tINTO #AllDispatchRequests\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore (NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\tAND (dp.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\tAND ( ddr.IsNightly = @IsNightly OR @IsNightly IS NULL)\r\n----------------------------------------------------------------------------------------------------\r\n\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (5,6)\r\n\t\t\t  AND dr.DeliveryStartTime_Date = @Today\r\n\r\n\r\n\r\n\t\tSELECT \r\n\t\t\t\t@AssignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,47,48,49,50,51,52,53,54)\r\n\t\t\t  --AND dr.DeliveryStartTime_Date = @Today\r\n\r\n/******************************DelayedPickupCount**********************************************************/\r\n\r\n\t\tSELECT\r\n\t\t\t\t@DelayedPickupCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE dr.DispatchRequestStatusId in (10,11,15,16)\r\n\t\t--AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30\r\n\t\tAND sdp.OperationTypeId = 5\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\t\t----------------------------------------------------------------------------------------\r\n\t\tSELECT\r\n\t\t\t\t@DelayedDelayedCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE sdp.OperationTypeId IN (10) \r\n\t\t--AND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t\tAND dr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n/********************************UnassignedReturnAndReplacementRequestCount*************************************************************/\r\n\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT ddr.ParcelReferenceCode)\r\n\t\tFROM #AllDispatchRequests ddr\r\n\tWHERE ddr.DispatchRequestStatusId in (5) \r\n\tAND CourierRequestTypeId in (26,30,35,40,45,50,60,65,70)\r\n\t\t\r\n    --############################################ Pre Calculate Result ##############################################\r\n\r\n\t\tSELECT \r\n                    [dr].[Id],\r\n                    [dr].[DispatchRequestStatusId],\r\n                    CASE WHEN dr.DispatchRequestStatusId = 20 THEN N\u0027\u0645\u0631\u062C\u0648\u0639 \u0634\u062F\u0027\r\n\t\t\t\t\t\t WHEN dr.DispatchRequestStatusId = 25 THEN N\u0027\u0633\u0641\u06CC\u0631 \u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u0631\u0633\u06CC\u062F\u0027\r\n\t\t\t\t\t\t WHEN dr.DispatchRequestStatusId = 30 THEN N\u0027\u0628\u0647 \u0641\u0631\u0648\u0634\u06AF\u0627\u0647 \u062A\u062D\u0648\u06CC\u0644 \u0634\u062F\u0027\r\n\t\t\t\t\t\t ELSE\r\n\t\t\t\t\t\t\tdrs.Title\r\n\t\t\t\t\tEND AS StatusTitle,\r\n                    [dr].[ParcelReferenceCode],\r\n                    dr.CourierRequestTypeId,\r\n                    p1.CityId,\r\n                    ps.PolygonId,\r\n                    p1.Title as PolygonTitle,\r\n                    StoreId,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT s.[Location].STY  AS  StoreLocationLatitude\r\n\t\t\t\t\t\t\t\t\t\t--FOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t)StoreLocationLatitude,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT s.[Location].STX  AS  StoreLocationLongitude\r\n\t\t\t\t\t\t\t\t\t\t--FOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t)StoreLocationLongitude,\r\n                    s.Title as StoreTitle,\r\n                    dr.DeliveryStartTime,\r\n                    dr.DeliveryStartTimePersian,\r\n                    dr.DeliveryDeadLineTime,\r\n                    dr.DeliveryDeadLineTimePersian,\r\n                    dr.ClientAddress,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT dr.ClientLocation.STY  AS  ClientLocationLatitude\r\n\t\t\t\t\t\t\t\t\t\t--FOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t)ClientLocationLatitude,\r\n                    (\r\n\t\t\t\t\t\t\t\t\t\tSELECT dr.ClientLocation.STX  AS  ClientLocationLongitude\r\n\t\t\t\t\t\t\t\t\t\t--FOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t)ClientLocationLongitude,\r\n                  ISNULL(dr.AssignmentTryCount,0) as FleetPreAssignmentStateCount,\r\n                    (\r\n                                    select CAST(DATEDIFF(\r\n                                                            SECOND,\r\n                                                            GETDATE(),\r\n                                                            CAST(CONVERT(VARCHAR, FORMAT(dr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)\r\n\r\n\t\t\t\t\t\t\t\t    ) as BIGINT)\r\n                    ) as RemainedToDeadlineSeconds,\r\n                    dr.VendorParcelCode,\r\n\t\t\t\t\tdr.CreateDate,\r\n                    dr.CreateDatePersian,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly\r\n\r\n        into #DispatchRequest\r\n        FROM dp.DispatchRequest dr (NOLOCK) \r\n        join dp.DispatchRequestStatus drs (NOLOCK)  on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps (NOLOCK)  on dr.PolygonStoreId = ps.Id\r\n\r\n        join dp.Polygon p1 (NOLOCK)  on ps.PolygonId = p1.Id\r\n        join dp.Store s (NOLOCK)  on ps.StoreId = s.Id\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        where (\r\n                (DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n                OR\r\n                (DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\n              )\r\n\t\tAND (dr.DispatchRequestStatusId = @DispatchRequestStatusId OR @DispatchRequestStatusId = 0)\r\n        and ((dr.DeliveryStartTime BETWEEN @StartDeliveryTime and @EndDeliveryTime or dr.DeliveryDeadLineTime BETWEEN @StartDeliveryTime and @EndDeliveryTime) or @StartDeliveryTime = 0 or @EndDeliveryTime = 0)\r\n        and ((s.Id IN (Select Id from @StoreId)) OR (@StoreIds=\u00270\u0027))\r\n        and (p1.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and ((dr.CourierRequestTypeId in (Select Id from @CourierRequestTypeId)) OR (@CourierRequestTypeIds = \u00270\u0027))\r\n        and (p1.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n        and (dr.ParcelReferenceCode = @ParcelReferenceCode OR @ParcelReferenceCode = 0)\r\n        and (dr.VendorParcelCode = @VendorParcelCode or @VendorParcelCode = \u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\t\tAND ( dr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\tAND ( dr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\r\n\t\tOPTION(RECOMPILE)\r\n        select \r\n                    s.Id,\r\n                    s.ShipmentStatusId as StatusId,\r\n                    ss.Title as StatusTitle,\r\n                    ShipmentNumber,\r\n                    s.FleetId,\r\n                    dr.Id as DispatchRequestId\r\n        into #Shipment\r\n        from #DispatchRequest dr\r\n        join (\r\n                select \r\n                        top 1 with ties s3.DispatchRequestId, sdp.id \r\n                from #DispatchRequest dr \r\n                join dp.ShipmentDestinationPointDispatchRequest s3 (NOLOCK)  on dr.id = s3.DispatchRequestId\r\n                join dp.ShipmentDestinationPoint sdp (NOLOCK)   on sdp.id = s3.ShipmentDestinationPointId and OperationTypeId IN( 15,10)\r\n                order by ROW_NUMBER() over (partition by dr.id order by dr.id,sdp.id desc)\r\n            )sdp on sdp.DispatchRequestId = dr.id --and OperationTypeId = 5\r\n        join dp.ShipmentDestinationPoint s2 (NOLOCK)  on sdp.id = s2.Id \r\n        join dp.Shipment s (NOLOCK)  on s.id = s2.ShipmentId\r\n        join dp.ShipmentStatus ss (NOLOCK)  on s.ShipmentStatusId = ss.Id\r\n\r\n        select \r\n                    f.Id,\r\n                    DriverId,\r\n                    FirstName \u002B \u0027 \u0027 \u002B LastName as DriverName,\r\n                    d.Mobile as DriverMobile,\r\n                    v.VehicleTypeId,\r\n                    v.PlateNumber,\r\n                    s.Id as ShipmentId,\r\n                    s.DispatchRequestId\r\n\r\n        into #Fleet\r\n        from #Shipment s\r\n        join dp.Fleet f (NOLOCK)  on s.FleetId = f.Id\r\n        join dp.Driver d (NOLOCK)  on f.DriverId = d.Id\r\n        join dp.Vehicle v (NOLOCK)  on f.VehicleId = v.Id\r\n\r\n    --############################################ Calculate Result ##############################################\r\n        select distinct\r\n                    [dr].[Id] DispatchRequestId,\r\n                    [dr].[DispatchRequestStatusId],\r\n                    [dr].[StatusTitle] as DispatchRequestStatusTitle,\r\n                    [dr].[ParcelReferenceCode],\r\n                    [dr].[CourierRequestTypeId],\r\n                    [dr].[CityId],\r\n                    [dr].[PolygonId],\r\n                    [dr].[PolygonTitle],\r\n                    [dr].[StoreId],\r\n                    [dr].[StoreLocationLatitude],\r\n                    dr.StoreLocationLongitude,\r\n                    [dr].[StoreTitle],\r\n                    FORMAT([dr].[DeliveryStartTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryStartTimeStr,\r\n                    FORMAT([dr].[DeliveryStartTimePersian],\u0027####-##-## ##:##:##\\.###\u0027)DeliveryStartTimePersianStr,\r\n                    FORMAT([dr].[DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryDeadLineTimeStr,\r\n                    FORMAT([dr].[DeliveryDeadLineTimePersian],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryDeadLineTimePersianStr,\r\n                    [dr].[ClientAddress],\r\n                    [dr].[ClientLocationLatitude],\r\n                    dr.ClientLocationLongitude,\r\n                    [dr].[FleetPreAssignmentStateCount],\r\n                    [dr].[RemainedToDeadlineSeconds],\r\n                    [dr].[VendorParcelCode],\r\n                    dr.CreateDate,\r\n                    FORMAT([dr].[CreateDatePersian],\u0027####-##-## ##:##:##\\.###\u0027) CreateDatePersianStr,\r\n\r\n                    [s].[Id] as ShipmentId,\r\n                    [s].[StatusId] as ShipmentStatusId,\r\n                    [s].[StatusTitle] as ShipmentStatusTitle,\r\n                    [s].[ShipmentNumber],\r\n\r\n                    [f].[Id] FleetId,\r\n                    [f].[DriverId],\t\r\n                    [f].[DriverName],\r\n                    [f].[DriverMobile],\r\n                    [f].[VehicleTypeId],\r\n                    [f].[PlateNumber],\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly\t\r\n\r\n        INTO #FinalResult\r\n        from #DispatchRequest dr\r\n        JOIN #Shipment s on dr.Id = s.DispatchRequestId\r\n        JOIN #Fleet f on s.DispatchRequestId = f.DispatchRequestId and s.Id = f.ShipmentId\r\n\r\n\t\tSET @TotalCount = @@ROWCOUNT\r\n\r\n        select * \r\n        from #FinalResult\r\n        ORDER by \r\n                 CASE \r\n                    WHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027DeliveryDeadLineTimeStr\u0027 AND @IsAsc = 1 THEN DeliveryDeadLineTimeStr\r\n                 End ASC,\r\n                 CASE\r\n                    WHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027DeliveryDeadLineTimeStr\u0027 AND @IsAsc = 0 THEN DeliveryDeadLineTimeStr\r\n                 End DESC,\r\n\t\t\t\t CASE \r\n\t\t\t\t\tWHEN @OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027RemainedToDeadlineSeconds\u0027 AND @IsAsc = 1 THEN RemainedToDeadlineSeconds\r\n\t\t\t\tEnd ASC,\r\n\t\t\t\tCASE\r\n\t\t\t\t\tWHEN (@OrderBy \u003C\u003E \u00270\u0027 AND @OrderBy = \u0027RemainedToDeadlineSeconds\u0027 AND @IsAsc = 0) OR (@OrderBy IS NULL OR @OrderBy = \u00270\u0027) THEN RemainedToDeadlineSeconds\r\n\t\t\t\tEnd DESC\r\n\t\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\r\n"},{"Name":"Get_StoreHistory_By_Score","Schema":"dbo","Definition":"\r\nCREATE   PROC [dbo].[Get_StoreHistory_By_Score]    \r\n(    \r\n @ParcelReferenceCode BIGINT \r\n)    \r\nAS    \r\n\r\nIF @ParcelReferenceCode IS NULL    \r\n RETURN -1    \r\n\r\n; WITH CTE_Data As\r\n(\r\nSELECT \r\n\tpass.RunCode,\r\n\tps.PolygonId\r\nFROM [DP].[DispatchRequest] dr WITH (NOLOCK)    \r\nINNER JOIN [DP].[StorePreAssignmentScoreDetail] sasd WITH (NOLOCK)    \r\n\tON dr.ID = sasd.DispatchRequestId  \r\nINNER JOIN [DP].[PreAssignmentStoreScore] pass WITH (NOLOCK)    \r\n\tON sasd.PreAssignmentStoreScoreId = pass.ID  \r\nINNER JOIN [DP].[PolygonStore] ps WITH (NOLOCK)    \r\n\tON dr.PolygonStoreId = ps.ID\r\nWHERE dr.ParcelReferenceCode = @ParcelReferenceCode  \r\n), CTE_RuneCode AS\r\n(\r\n\tSELECT DISTINCT RunCode FROM CTE_Data\r\n), CTE_StoreId AS\r\n(\r\n\tSELECT DISTINCT ps.StoreId FROM CTE_Data d\r\n\tINNER JOIN [DP].[PolygonStore] ps WITH (NOLOCK)   \r\n\t\tON d.PolygonId = ps.PolygonId\r\n)\r\n\r\nSELECT DISTINCT\r\n\tpass.RunCode,    \r\n\tpass.CreateDate,    \r\n\tpass.CreateDatePersian,    \r\n\ts.Title AS StoreTitle,    \r\n\tpass.StoreId,   \r\n\ts.VendorId,\r\n\ts.VendorCode,    \r\n\ts.[Address],    \r\n\tCOUNT(DISTINCT sasd.DispatchRequestId) CountOfRequests,    \r\n\tpass.StoreFactor,\r\n\tpass.Score \r\nFROM CTE_RuneCode rc\r\nINNER JOIN [DP].[PreAssignmentStoreScore] pass WITH (NOLOCK)    \r\n\tON rc.RunCode = pass.RunCode\r\nINNER JOIN CTE_StoreId sID1\r\n\tON pass.StoreId = sID1.StoreId\r\nINNER JOIN [DP].[Store] s WITH (NOLOCK)    \r\n\tON pass.StoreId = s.ID \r\nINNER JOIN [DP].[StorePreAssignmentScoreDetail] sasd WITH (NOLOCK)    \r\n\tON pass.ID = sasd.PreAssignmentStoreScoreId\r\nGroup By \r\n\tpass.RunCode,    \r\n\tpass.CreateDate,    \r\n\tpass.CreateDatePersian,    \r\n\ts.Title,\r\n\tpass.StoreId,   \r\n\ts.VendorId,\r\n\ts.VendorCode,    \r\n\ts.[Address],\r\n\tpass.StoreFactor,\r\n\tpass.Score \r\nORDER BY\r\n\tpass.CreateDatePersian DESC,pass.Score DESC\r\n\r\n"},{"Name":"Get_StoreOrderStatisticsAndConfig_By_PolygonId","Schema":"dbo","Definition":"CREATE   PROC [dbo].[Get_StoreOrderStatisticsAndConfig_By_PolygonId]\r\n\t@PolygonId SMALLINT,\r\n\t@DateInput INT,\r\n\t@CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n\t@DeliveryServiceProviderId INT = NULL,\r\n\t@OrderBy NVARCHAR(200) = NULL,\r\n\t@IsAsc BIT = NULL,\r\n\t@vendorIds  NVARCHAR(MAX) = NULL,\r\n\t@storeName NVARCHAR(MAX) = NULL,\r\n\t@storeStatusId BIT = 0,\r\n\t@storeStatusStr NVARCHAR(500) = \u0027\u0027,\r\n\t@Result NVARCHAR(MAX) = NULL OUTPUT\r\n\r\nAS \r\nSET NOCOUNT ON\r\nSET NOCOUNT ON\r\n\r\nIF @PolygonId IS NULL OR @PolygonId = 0\r\n\tRETURN\r\nIF @DateInput IS NULL OR @DateInput = 0\r\n\tRETURN\r\n\r\n\r\n\t\r\nDROP TABLE IF EXISTS \r\n\t#Final,\r\n\t#CourierRequestTypeId,\r\n\t#vendorIds\r\n\r\nSELECT crt.Id \r\n\tINTO #CourierRequestTypeId\r\nFROM CS_Public.PUB.CourierRequestType crt WITH(NOLOCK)\r\nINNER JOIN string_split(@CourierRequestTypeIds , \u0027,\u0027 ) ss\r\n\tON crt.Id = ss.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\r\nCREATE TABLE #vendorIds (VId NVARCHAR(100))\r\n\r\n\r\nIF @vendorIds IS NOT NULL \r\n\tBEGIN \r\n\t\tINSERT INTO #vendorIds (VId)\r\n\t\tSELECT value\r\n\t\tFROM STRING_SPLIT(@vendorIds, \u0027,\u0027);\t\t\r\n\tEND \r\n\r\nIF @storeStatusId =1 \r\n\tBEGIN \r\n       SET @storeStatusStr = \u0027 WHERE countOfUnassignedRequest !=0 OR countOfTryingToAssign!=0 OR countOfPickupQueue!=0 OR countOfDelayedEtaPickupQueue!=0 OR countOfDeliveryQueue!=0 OR countOfDelayedSlaDeliveryQueue!=0 OR countOfDelivered!=0 OR countOfCanceledRequest!=0 OR countOfReturnedDelivery!=0 OR countOfSlaOntimeDelivery!=0 OR countOfSlaHyperDelayedDelivery!=0\u0027\r\n\tEND \r\n\r\n\r\nDECLARE \r\n\t@Now_DateTime DATETIME = GETDATE()\r\nDECLARE\r\n\t@Now BIGINT = FORMAT(@Now_DateTime,\u0027yyyyMMddHHmmssfff\u0027)\r\n\r\nDECLARE\r\n\t@StartRangeTime BIGINT = CAST(@DateInput AS VARCHAR(MAX)) \u002B \u0027000000000\u0027,\r\n\t@EndRangeTime BIGINT = CAST(@DateInput AS VARCHAR(MAX)) \u002B \u0027235959999\u0027\r\n\r\nDECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t \t@ScheduledHyperDelayThresholdMinutes SMALLINT\r\nSELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\nSELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n;WITH CTE_Final AS\r\n(\r\n\tSELECT\r\n\t\tps.StoreId AS Id,\r\n\t\ts.Title AS Title,\r\n\t\ts.Phone,\r\n\t\ts.ResponsibleMobile,\r\n\t\tv.BrandName AS VendorBrandName,\r\n\t\ts.VendorCode,\r\n\t\ts.Location StoreLocation,\r\n\t\tc.ProvinceId,\r\n\t\ts.CityId,\r\n\t\tps.PolygonId,\r\n\t\ts.VendorId,\r\n\t\tstbi.ScoreFactor,\r\n\t\ts.OrderCategoryId\r\n\tFROM DP.PolygonStore ps WITH(NOLOCK)\r\n\tINNER JOIN Dp.Store s WITH(NOLOCK)\r\n\t\tON ps.StoreId = s.Id\r\n\t\tAND ps.IsActive = 1\r\n\tINNER JOIN CS_UserManagement.UM.Vendor v WITH(NOLOCK)\r\n\t\tON s.VendorId = v.Id\r\n\tINNER JOIN CS_Public.HAF.City c WITH(NOLOCK)\r\n\t\tON s.CityId = c.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\tON ps.StoreId = stbi.StoreId\r\n\tWHERE ps.PolygonId = @PolygonId\r\n\tAND (@vendorIds IS NULL OR VendorId IN (SELECT VId FROM #vendorIds))\r\n\tAND (@storeName IS NULL OR s.Title LIKE \u0027%\u0027\u002B @storeName\u002B\u0027%\u0027)\r\n\r\n),CTE_DRCounts AS\r\n(\r\n\tSELECT\r\n\t\tps.StoreId AS Id,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 5,7 ) THEN 1 ELSE 0 END) AS CountOfUnassignedRequest,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 5,7 ) AND dr.DeliveryStartTime \u003C @Now THEN 1 ELSE 0 END) AS CountOfTryingToAssign,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 10,15 ) THEN 1 ELSE 0 END) AS CountOfPickupQueue,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 20, 25, 46,47,48,49, 51,52,53,54 ) THEN 1 ELSE 0 END) AS CountOfDeliveryQueue,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 20, 25, 46,47,48,49, 51,52,53,54 ) AND dr.DeliveryDeadLineTime \u003C @Now THEN 1 ELSE 0 END) AS CountOfDelayedSlaDeliveryQueue,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 30,35 ) AND dr.CourierRequestTypeId IN ( 5,10,15 ) THEN 1 ELSE 0 END) AS CountOfDelivered,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 40 ) THEN 1 ELSE 0 END) AS CountOfCanceledRequest,\r\n\t\tSUM(CASE WHEN drR.DispatchRequestStatusId IN ( 30,35 ) AND drR.CourierRequestTypeId IN ( 25 ) THEN 1 ELSE 0 END) AS CountOfReturnedDelivery,\r\n\t\t-- ( CountOfSlaOntimeDelivery / CountOfDelivered )*100 AS PercentageOfSlaOntimeDelivery,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 30 ) THEN 1 ELSE 0 END) AS CountOfSlaOntimeDelivery,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 35 ) AND dr.CourierRequestTypeId IN ( 5,10,15 ) THEN 1 ELSE 0 END) AS CountOfSlaDelayedDelivery,\r\n\t\t-- ( CountOfSlaHyperDelayedDelivery / CountOfDelivered )*100 AS PercentageOfSlaHyperDelayedDelivery,\r\n\t\tSUM((CASE WHEN dr.DispatchRequestStatusId = 35  AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime AND ((dr.CourierRequestTypeId IN ( 5,26,40,55,60 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @OndemandHyperDelayThresholdMinutes) OR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @ScheduledHyperDelayThresholdMinutes)) THEN 1 ELSE 0 END)) AS CountOfSlaHyperDelayedDelivery\r\n\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\t\tAND ps.IsActive = 1\r\n\tINNER JOIN Dp.Store s WITH(NOLOCK)\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN CS_UserManagement.UM.Vendor v WITH(NOLOCK)\r\n\t\tON s.VendorId = v.Id\r\n\tINNER JOIN CS_Public.HAF.City c WITH(NOLOCK)\r\n\t\tON s.CityId = c.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\tON ps.StoreId = stbi.StoreId\r\n\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\tLEFT JOIN DP.DispatchRequest drR WITH(NOLOCK)\r\n\t\tON dr.VendorId = drR.VendorId\r\n\t\tAND dr.VendorParcelCode = drR.VendorParcelCode\r\n\t\tAND drR.CourierRequestTypeId = 25\r\n\tWHERE ps.PolygonId = @PolygonId\r\n\tAND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\tAND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n\tAND (@vendorIds IS NULL OR V.Id IN (SELECT VId FROM #vendorIds))\r\n\tAND (@storeName IS NULL OR s.Title LIKE \u0027%\u0027\u002B @storeName\u002B\u0027%\u0027)\r\n\tGroup By ps.StoreId\r\n),CTE_ETADelayedDeliveryCount AS\r\n(\r\n\tSELECT \r\n\t\tps.StoreId AS Id,\r\n\t\tCOUNT(DISTINCT dr.Id) AS countOfDelayedEtaPickupQueue\r\n\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\t\tAND ps.IsActive = 1\r\n\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\t\tON dr.Id = sdpdr.DispatchRequestId\r\n\t\tAND dr.Version = sdpdr.Version\r\n\tINNER JOIN DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\tAND sdp.OperationTypeId = 5\r\n\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C @Now_DateTime\r\n\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\tWHERE ps.PolygonId = @PolygonId\r\n\tAND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\tAND dr.DispatchRequestStatusId IN ( 10,15 )\r\n\tAND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n\tGroup By ps.StoreId\r\n),CTE_OperationSlaIndex AS\r\n(\r\n\tSELECT \r\n\t\tSQ.Id,\r\n\t\tCASE \r\n\t\t\tWHEN OperationSlaIndex \u003C= 1 THEN 1\r\n\t\t\tWHEN OperationSlaIndex \u003E 1 AND OperationSlaIndex \u003C= 1.5 THEN 2\r\n\t\t\tWHEN OperationSlaIndex \u003E 1.5 THEN 3\r\n\t\tEND AS OperationSlaIndex\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tps.StoreId AS Id,\r\n\t\t\tSUM(DATEDIFF(MINUTE,CAST(CONVERT(varchar,FORMAT(dr.DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME),@Now_DateTime)) \r\n\t\t\t/SUM(DATEDIFF(MINUTE,CAST(CONVERT(varchar,FORMAT(dr.DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME),CAST(CONVERT(varchar,FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))) OperationSlaIndex\r\n\t\tFROM DP.DispatchRequest dr WITH(NOLOCK) \r\n\t\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\t\tON dr.PolygonStoreId = ps.Id\r\n\t\t\tAND ps.IsActive = 1\r\n\t\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\t\tWHERE ps.PolygonId = @PolygonId\r\n\t\tAND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\t\tAND dr.DispatchRequestStatusId IN ( 5,7,10,15,20,25, 45,46,47,48,49,50,51,52,53,54 )\r\n\t\tAND dr.CourierRequestTypeId IN ( 5,10,15 )\r\n\t\tAND dr.DeliveryStartTime \u003C @Now\r\n\t\tAND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n\t\tGroup By ps.StoreId\r\n\t) SQ\r\n\t\r\n)\r\nSELECT \r\n\tf.Id,\r\n\tf.Title,\r\n\tf.Phone,\r\n\tf.ResponsibleMobile,\r\n\tf.VendorBrandName,\r\n\tf.VendorCode,\r\n\tf.StoreLocation,\r\n\tf.ProvinceId,\r\n\tf.CityId,\r\n\tf.PolygonId,\r\n\tf.VendorId,\r\n\tf.ScoreFactor,\r\n\tf.OrderCategoryId,\t\r\n\r\n\tISNULL(osi.OperationSlaIndex,1) AS OperationSlaIndex,\r\n\r\n\tISNULL(dr.CountOfUnassignedRequest,0) CountOfUnassignedRequest,\r\n\tISNULL(dr.CountOfTryingToAssign,0) CountOfTryingToAssign,\r\n\tISNULL(dr.CountOfPickupQueue,0) CountOfPickupQueue,\r\n\tISNULL(dr.CountOfDeliveryQueue,0) CountOfDeliveryQueue,\r\n\tISNULL(dr.CountOfDelayedSlaDeliveryQueue,0) CountOfDelayedSlaDeliveryQueue,\r\n\tCASE WHEN ISNULL(dr.CountOfDelivered,0) = 0 THEN 0.00 ELSE ( ISNULL(dr.CountOfDelayedSlaDeliveryQueue,0) / ISNULL(CAST(dr.CountOfDelivered AS numeric),0.00) )*100 END AS PercentageOfDelayedSlaDeliveryQueue,\r\n\tISNULL(dr.CountOfDelivered,0) CountOfDelivered,\r\n\tISNULL(dr.CountOfCanceledRequest,0) CountOfCanceledRequest,\r\n\tISNULL(dr.CountOfReturnedDelivery,0) CountOfReturnedDelivery,\r\n\tISNULL(dr.CountOfSlaOntimeDelivery,0) CountOfSlaOnTimeDelivery,\r\n\tCASE WHEN ISNULL(dr.CountOfDelivered,0) = 0 THEN 0 ELSE ( ISNULL(dr.CountOfSlaOntimeDelivery,0) / ISNULL(CAST(dr.CountOfDelivered AS NUMERIC(5,2)),0.00) )*100 END AS PercentageOfSlaOnTimeDelivery,\r\n\tISNULL(dr.CountOfSlaHyperDelayedDelivery,0) CountOfSlaHyperDelayedDelivery,\r\n\tCASE WHEN ISNULL(dr.CountOfDelivered,0) = 0 THEN 0 ELSE ( ISNULL(dr.CountOfSlaHyperDelayedDelivery,0) / ISNULL(CAST(dr.CountOfDelivered AS NUMERIC(5,2)),0.00) )*100 END AS PercentageOfSlaHyperDelayedDelivery,\r\n\tISNULL(sdd.countOfDelayedEtaPickupQueue,0) CountOfDelayedEtaPickupQueue,\r\n\tISNULL(dr.CountOfSlaDelayedDelivery,0) CountOfSlaDelayedDelivery,\r\n\r\n\tCASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE 100 - (CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfSlaOntimeDelivery/CAST(CountOfDelivered AS FLOAT))*100 END) - (CASE WHEN CountOfDelivered = 0 THEN 0 ELSE (CountOfSlaHyperDelayedDelivery/CAST(CountOfDelivered AS FLOAT))*100 END) END AS      percentageOfSlaDelayedDelivery\r\n\r\n\r\n\r\n--\tCASE WHEN ISNULL(dr.CountOfDelivered,0) = 0 THEN 0 ELSE ( ISNULL(dr.CountOfSlaDelayedDelivery,0) / ISNULL(CAST(dr.CountOfDelivered AS NUMERIC(5,2)),0.00) )*100 END AS   percentageOfSlaDelayedDelivery\r\n\r\n\r\nINTO #Final\r\nFROM CTE_Final f\r\nLEFT JOIN CTE_DRCounts dr\r\n\tON f.Id = dr.Id\r\nLEFT JOIN CTE_ETADelayedDeliveryCount sdd\r\n\tON f.Id = sdd.Id\r\nLEFT JOIN CTE_OperationSlaIndex osi\r\n\tON f.Id = osi.Id\r\n\t\r\nDECLARE @Str NVARCHAR(MAX) = \u0027\u0027,\r\n\t\t@Param  NVARCHAR(MAX) = \u0027@Result NVARCHAR(MAX) OUTPUT\u0027\r\n\r\nSET @Str \u002B=\r\n\u0027 DECLARE\r\n\t@CountOfUnassignedRequestInPolygon INT = NULL,\t\r\n\t@CountOfTryingToAssignInPolygon INT = NULL,\t\r\n\t@CountOfPickupQueueInPolygon INT = NULL,\t\r\n\t@CountOfDelayedEtaPickupQueueInPolygon INT = NULL,\t\r\n\t@CountOfDeliveryQueueInPolygon INT = NULL,\t\r\n\t@CountOfDelayedSlaDeliveryQueueInPolygon INT = NULL,\r\n\t@CountOfDeliveredInPolygon INT = NULL,\r\n\t@CountOfCanceledRequestInPolygon INT = NULL,\r\n\t@CountOfReturnedDeliveryInPolygon INT = NULL,\r\n\t@PercentageOfSlaOntimeDeliveryInPolygon NUMERIC(5,2) = NULL,\r\n\t@CountOfSlaOntimeDeliveryInPolygon INT = NULL,\r\n\t@PercentageOfSlaHyperDelayedDeliveryInPolygon NUMERIC(5,2) = NULL,\r\n\t@CountOfSlaHyperDelayedDeliveryInPolygon INT = NULL,\r\n\r\n\r\n\t@totalPercentageOfSlaHyperDelayedDelivery NUMERIC(5,2) = NULL,\r\n\t@totalCountOfDelivered INT = NULL,\r\n\t@totalCountOfSlaOnTimeDelivery INT = NULL,\r\n\t@totalPercentageOfSlaOnTimeDelivery NUMERIC(5,2) = NULL,\r\n\t@totalCountOfSlaDelayedDelivery INT = NULL,\r\n\t@totalPercentageOfSlaNormalDelayedDelivery NUMERIC(5,2) = NULL,\r\n\t@totalCountOfSlaHyperDelayedDelivery INT = NULL \u0027\r\n--\t@CountOfSlaDelayedDelivery INT = NULL \u0027\r\n\r\n\r\n\r\n\r\n\r\nSET @Str \u002B=\r\n\u0027 SELECT \r\n\t@CountOfUnassignedRequestInPolygon = SUM(CountOfUnassignedRequest),\t\r\n\t@CountOfTryingToAssignInPolygon = SUM(CountOfTryingToAssign),\t\r\n\t@CountOfPickupQueueInPolygon = SUM(CountOfPickupQueue),\t\r\n\t@CountOfDelayedEtaPickupQueueInPolygon = SUM(CountOfDelayedEtaPickupQueue),\r\n\t@CountOfDeliveryQueueInPolygon = SUM(CountOfDeliveryQueue),\r\n\t@CountOfDelayedSlaDeliveryQueueInPolygon = SUM(CountOfDelayedSlaDeliveryQueue),\r\n\t@CountOfDeliveredInPolygon = SUM(CountOfDelivered),\r\n\t@CountOfCanceledRequestInPolygon = SUM(CountOfCanceledRequest),\r\n\t@CountOfReturnedDeliveryInPolygon = SUM(CountOfReturnedDelivery),\r\n\t@PercentageOfSlaOntimeDeliveryInPolygon = ( CASE WHEN ISNULL(SUM(CountOfDelivered),0) = 0.00 THEN 0 ELSE ( ISNULL(SUM(CountOfSlaOntimeDelivery),0) / ISNULL(CAST(SUM(CountOfDelivered) AS FLOAT),0.00) )*100 END ),\r\n\t@CountOfSlaOntimeDeliveryInPolygon = SUM(CountOfSlaOntimeDelivery),\r\n\t@PercentageOfSlaHyperDelayedDeliveryInPolygon = ( CASE WHEN ISNULL(SUM(CountOfDelivered),0) = 0.00 THEN 0 ELSE ( ISNULL(SUM(CountOfSlaHyperDelayedDelivery),0) / ISNULL(CAST(SUM(CountOfDelivered) AS FLOAT),0.00) )*100 END ),\r\n\t@CountOfSlaHyperDelayedDeliveryInPolygon = SUM(CountOfSlaHyperDelayedDelivery) ,\r\n\r\n\r\n\t@totalPercentageOfSlaHyperDelayedDelivery  = ( CASE WHEN ISNULL(SUM(CountOfDelivered),0) = 0.00 THEN 0 ELSE ( ISNULL(SUM(CountOfSlaHyperDelayedDelivery),0) / ISNULL(CAST(SUM(CountOfDelivered) AS FLOAT),0.00) )*100 END ),\r\n\t@totalCountOfDelivered  = SUM(CountOfDelivered),\r\n\t@totalCountOfSlaOnTimeDelivery  = SUM(CountOfSlaOntimeDelivery),\r\n\t@totalPercentageOfSlaOnTimeDelivery  = ( CASE WHEN ISNULL(SUM(CountOfDelivered),0) = 0.00 THEN 0 ELSE ( ISNULL(SUM(CountOfSlaOntimeDelivery),0) / ISNULL(CAST(SUM(CountOfDelivered) AS FLOAT),0.00) )*100 END ),\r\n\t@totalCountOfSlaDelayedDelivery  = SUM(CountOfSlaDelayedDelivery),\r\n\t@totalPercentageOfSlaNormalDelayedDelivery  = (CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE 100 - (CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaOntimeDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END) - (CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END) END ),\r\n\t@totalCountOfSlaHyperDelayedDelivery  = SUM(CountOfSlaHyperDelayedDelivery)\r\n\r\n\r\n\r\n\r\nFROM #Final\u0027\r\n\r\nSET @Str \u002B=\r\n\u0027 SELECT\r\n\t@CountOfUnassignedRequestInPolygon = ISNULL(@CountOfUnassignedRequestInPolygon,0),\t\r\n\t@CountOfTryingToAssignInPolygon = ISNULL(@CountOfTryingToAssignInPolygon,0),\t\r\n\t@CountOfPickupQueueInPolygon = ISNULL(@CountOfPickupQueueInPolygon,0),\t\r\n\t@CountOfDelayedEtaPickupQueueInPolygon = ISNULL(@CountOfDelayedEtaPickupQueueInPolygon,0),\r\n\t@CountOfDeliveryQueueInPolygon = ISNULL(@CountOfDeliveryQueueInPolygon,0),\r\n\t@CountOfDelayedSlaDeliveryQueueInPolygon = ISNULL(@CountOfDelayedSlaDeliveryQueueInPolygon,0),\r\n\t@CountOfDeliveredInPolygon = ISNULL(@CountOfDeliveredInPolygon,0),\r\n\t@CountOfCanceledRequestInPolygon = ISNULL(@CountOfCanceledRequestInPolygon,0),\r\n\t@CountOfReturnedDeliveryInPolygon = ISNULL(@CountOfReturnedDeliveryInPolygon,0),\r\n\t@PercentageOfSlaOntimeDeliveryInPolygon = ISNULL(@PercentageOfSlaOntimeDeliveryInPolygon,0.00),\r\n\t@CountOfSlaOntimeDeliveryInPolygon = ISNULL(@CountOfSlaOntimeDeliveryInPolygon,0),\r\n\t@PercentageOfSlaHyperDelayedDeliveryInPolygon = ISNULL(@PercentageOfSlaHyperDelayedDeliveryInPolygon,0.00),\r\n\t@CountOfSlaHyperDelayedDeliveryInPolygon = ISNULL(@CountOfSlaHyperDelayedDeliveryInPolygon,0),\r\n\t--@CountOfSlaDelayedDelivery = ISNULL(@CountOfSlaDelayedDelivery,0),\r\n\t@totalPercentageOfSlaNormalDelayedDelivery = ISNULL(@totalPercentageOfSlaNormalDelayedDelivery,0),\r\n\t@totalCountOfSlaDelayedDelivery = ISNULL(@totalCountOfSlaDelayedDelivery,0) \u0027\r\nSET @Str \u002B=\r\n\u0027 SET @Result = \r\n(\r\n\tSELECT\r\n\t\t@CountOfUnassignedRequestInPolygon AS countOfUnassignedRequestInPolygon,\r\n\t\t@CountOfTryingToAssignInPolygon AS countOfTryingToAssignInPolygon,\r\n\t\t@CountOfPickupQueueInPolygon AS countOfPickupQueueInPolygon,\r\n\t\t@CountOfDelayedEtaPickupQueueInPolygon AS countOfDelayedEtaPickupQueueInPolygon,\r\n\t\t@CountOfDeliveryQueueInPolygon AS countOfDeliveryQueueInPolygon,\r\n\t\t@CountOfDelayedSlaDeliveryQueueInPolygon AS countOfDelayedSlaDeliveryQueueInPolygon,\r\n\t\t@CountOfDeliveredInPolygon AS countOfDeliveredInPolygon,\r\n\t\t@CountOfCanceledRequestInPolygon AS countOfCanceledRequestInPolygon,\r\n\t\t@CountOfReturnedDeliveryInPolygon AS countOfReturnedDeliveryInPolygon,\r\n\t\t@PercentageOfSlaOntimeDeliveryInPolygon AS percentageOfSlaOntimeDeliveryInPolygon,\r\n\t\t@CountOfSlaOntimeDeliveryInPolygon AS countOfSlaOntimeDeliveryInPolygon,\r\n\t\t@PercentageOfSlaHyperDelayedDeliveryInPolygon AS percentageOfSlaHyperDelayedDeliveryInPolygon,\r\n\t\t@CountOfSlaHyperDelayedDeliveryInPolygon AS countOfSlaHyperDelayedDeliveryInPolygon,\r\n\t\t--@CountOfSlaDelayedDelivery AS totalCountOfSlaDelayedDelivery ,\r\n\t\t\r\n\t\t\r\n\t\t@totalCountOfSlaDelayedDelivery AS totalCountOfSlaDelayedDelivery ,\r\n\t\t@totalPercentageOfSlaNormalDelayedDelivery  AS totalPercentageOfSlaNormalDelayedDelivery,\r\n\t\t@PercentageOfSlaHyperDelayedDeliveryInPolygon AS totalPercentageOfSlaHyperDelayedDelivery,\r\n\t\t@CountOfSlaHyperDelayedDeliveryInPolygon AS totalCountOfSlaHyperDelayedDelivery,\r\n\t\t@CountOfDeliveredInPolygon AS totalCountOfDelivered,\r\n\t\t@CountOfSlaOntimeDeliveryInPolygon AS totalCountOfSlaOnTimeDelivery,\r\n\t\t@PercentageOfSlaOntimeDeliveryInPolygon AS totalPercentageOfSlaOnTimeDelivery ,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tid,\r\n\t\t\t\ttitle,\r\n\t\t\t\tphone,\r\n\t\t\t\tresponsibleMobile,\r\n\t\t\t\tvendorBrandName,\r\n\t\t\t\tvendorCode,\r\n\t\t\t\t( SELECT StoreLocation.STY latitude, StoreLocation.STX AS longitude FOR JSON PATH , WITHOUT_ARRAY_WRAPPER ) location,\r\n\t\t\t\tprovinceId,\r\n\t\t\t\tcityId,\r\n\t\t\t\tpolygonId,\r\n\t\t\t\tvendorId,\r\n\t\t\t\tscoreFactor,\r\n\t\t\t\torderCategoryId,\t\r\n\t\t\t\toperationSlaIndex,\r\n\t\t\t\tcountOfUnassignedRequest,\r\n\t\t\t\tcountOfTryingToAssign,\r\n\t\t\t\tcountOfPickupQueue,\r\n\t\t\t\tcountOfDelayedEtaPickupQueue,\r\n\t\t\t\tcountOfDeliveryQueue,\r\n\t\t\t\tcountOfDelayedSlaDeliveryQueue,\r\n\t\t\t\tcountOfDelivered,\r\n\t\t\t\tcountOfCanceledRequest,\r\n\t\t\t\tcountOfReturnedDelivery,\r\n\t\t\t\tcountOfSlaOnTimeDelivery,\r\n\t\t\t\tpercentageOfSlaOnTimeDelivery,\r\n\t\t\t\tcountOfSlaHyperDelayedDelivery,\r\n\t\t\t\tpercentageOfSlaHyperDelayedDelivery,\r\n\t\t\t\tcountOfSlaDelayedDelivery,\r\n\t\t\t\tpercentageOfSlaDelayedDelivery\r\n\r\n\t\t\tFROM #Final\u0027\r\n\t\t\tSET @Str  \u002B= @storeStatusStr\r\n\t\t\tSET @Str  \u002B= CASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 THEN \u0027 ORDER BY \u0027 \u002B @OrderBy \u002B CASE WHEN ISNULL(@IsAsc,0) = 0 THEN \u0027 DESC\u0027 ELSE \u0027 ASC\u0027 END ELSE \u0027 ORDER BY OperationSlaIndex DESC , ScoreFactor Desc , VendorId , OrderCategoryId\u0027 END\r\n\t\t\tSET @Str  \u002B= \u0027 FOR JSON PATH\r\n\t\t) AS Stores \u0027\r\n \r\n SET @Str  \u002B= \u0027\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n)\u0027\r\n\r\nEXEC SP_executesql @Str , @Param , @Result = @Result OUTPUT\r\n\r\nSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\nSET @Result = REPLACE(@Result,\u0027}\u0022,\u0022\u0027,\u0027},\u0022\u0027)\r\nSET @Result = REPLACE(@Result,\u0027\u0022:\u0022{\u0027,\u0027\u0022:{\u0027)\r\n"},{"Name":"Get_StoreOrderStatisticsAndConfig_By_PolygonId_New","Schema":"dbo","Definition":"CREATE   PROC [dbo].[Get_StoreOrderStatisticsAndConfig_By_PolygonId_New]\r\n\t@PolygonId SMALLINT,\r\n\t@DateInput INT,\r\n\t@CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n\t@DeliveryServiceProviderId INT = NULL,\r\n\t@OrderBy NVARCHAR(200) = NULL,\r\n\t@IsAsc BIT = NULL,\r\n\t@vendorIds  NVARCHAR(MAX) = NULL,\r\n\t@storeName NVARCHAR(MAX) = NULL,\r\n\t@storeStatusId BIT = 1,\r\n\t@Result NVARCHAR(MAX) = NULL OUTPUT\r\n\r\nAS \r\nSET NOCOUNT ON\r\n\r\nIF @PolygonId IS NULL OR @PolygonId = 0\r\n\tRETURN\r\nIF @DateInput IS NULL OR @DateInput = 0\r\n\tRETURN\r\n\r\n\r\n\t\r\nDROP TABLE IF EXISTS \r\n\t#Final,\r\n\t#CourierRequestTypeId,\r\n\t#vendorIds\r\n\r\nSELECT crt.Id \r\n\tINTO #CourierRequestTypeId\r\nFROM CS_Public.PUB.CourierRequestType crt WITH(NOLOCK)\r\nINNER JOIN string_split(@CourierRequestTypeIds , \u0027,\u0027 ) ss\r\n\tON crt.Id = ss.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\n\r\nCREATE TABLE #vendorIds (VId NVARCHAR(100))\r\n\r\n\r\nIF @vendorIds IS NOT NULL \r\n\tBEGIN \r\n\t\tINSERT INTO #vendorIds (VId)\r\n\t\tSELECT value\r\n\t\tFROM STRING_SPLIT(@vendorIds, \u0027,\u0027);\t\t\r\n\tEND \r\n\r\nDECLARE \r\n\t@Now_DateTime DATETIME = GETDATE()\r\nDECLARE\r\n\t@Now BIGINT = FORMAT(@Now_DateTime,\u0027yyyyMMddHHmmssfff\u0027)\r\n\r\nDECLARE\r\n\t@StartRangeTime BIGINT = CAST(@DateInput AS VARCHAR(MAX)) \u002B \u0027000000000\u0027,\r\n\t@EndRangeTime BIGINT = CAST(@DateInput AS VARCHAR(MAX)) \u002B \u0027235959999\u0027\r\n\r\nDECLARE @OndemandHyperDelayThresholdMinutes SMALLINT,\r\n\t \t@ScheduledHyperDelayThresholdMinutes SMALLINT\r\nSELECT @OndemandHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.OndemandHyperDelayThresholdMinutes\u0027\r\nSELECT @ScheduledHyperDelayThresholdMinutes = Value FROM CS_Public.Haf.Setting WHERE Name = \u0027DispatchRequestSettings.ScheduledHyperDelayThresholdMinutes\u0027\r\n\r\n;WITH CTE_Final AS\r\n(\r\n\tSELECT\r\n\t\tps.StoreId AS Id,\r\n\t\ts.Title AS Title,\r\n\t\ts.Phone,\r\n\t\ts.ResponsibleMobile,\r\n\t\tv.BrandName AS VendorBrandName,\r\n\t\ts.VendorCode,\r\n\t\ts.Location StoreLocation,\r\n\t\tc.ProvinceId,\r\n\t\ts.CityId,\r\n\t\tps.PolygonId,\r\n\t\ts.VendorId,\r\n\t\tstbi.ScoreFactor,\r\n\t\ts.OrderCategoryId\r\n\tFROM DP.PolygonStore ps WITH(NOLOCK)\r\n\tINNER JOIN Dp.Store s WITH(NOLOCK)\r\n\t\tON ps.StoreId = s.Id\r\n\t\tAND ps.IsActive = 1\r\n\tINNER JOIN CS_UserManagement.UM.Vendor v WITH(NOLOCK)\r\n\t\tON s.VendorId = v.Id\r\n\tINNER JOIN CS_Public.HAF.City c WITH(NOLOCK)\r\n\t\tON s.CityId = c.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\tON ps.StoreId = stbi.StoreId\r\n\tWHERE ps.PolygonId = @PolygonId\r\n\tAND (@vendorIds IS NULL OR VendorId IN (SELECT VId FROM #vendorIds))\r\n\tAND (@storeName IS NULL OR s.Title LIKE \u0027%\u0027\u002B @storeName\u002B\u0027%\u0027)\r\n\r\n),CTE_DRCounts AS\r\n(\r\n\tSELECT\r\n\t\tps.StoreId AS Id,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 5,7 ) THEN 1 ELSE 0 END) AS CountOfUnassignedRequest,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 5,7 ) AND dr.DeliveryStartTime \u003C @Now THEN 1 ELSE 0 END) AS CountOfTryingToAssign,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 10,15 ) THEN 1 ELSE 0 END) AS CountOfPickupQueue,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 20, 25, 46,47,48,49, 51,52,53,54 ) THEN 1 ELSE 0 END) AS CountOfDeliveryQueue,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 20, 25, 46,47,48,49, 51,52,53,54 ) AND dr.DeliveryDeadLineTime \u003C @Now THEN 1 ELSE 0 END) AS CountOfDelayedSlaDeliveryQueue,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 30,35 ) AND dr.CourierRequestTypeId IN ( 5,10,15 ) THEN 1 ELSE 0 END) AS CountOfDelivered,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 40 ) THEN 1 ELSE 0 END) AS CountOfCanceledRequest,\r\n\t\tSUM(CASE WHEN drR.DispatchRequestStatusId IN ( 30,35 ) AND drR.CourierRequestTypeId IN ( 25 ) THEN 1 ELSE 0 END) AS CountOfReturnedDelivery,\r\n\t\t-- ( CountOfSlaOntimeDelivery / CountOfDelivered )*100 AS PercentageOfSlaOntimeDelivery,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 30 ) THEN 1 ELSE 0 END) AS CountOfSlaOntimeDelivery,\r\n\t\tSUM(CASE WHEN dr.DispatchRequestStatusId IN ( 35 ) AND dr.CourierRequestTypeId IN ( 5,10,15 ) THEN 1 ELSE 0 END) AS CountOfSlaDelayedDelivery,\r\n\t\t-- ( CountOfSlaHyperDelayedDelivery / CountOfDelivered )*100 AS PercentageOfSlaHyperDelayedDelivery,\r\n\t\tSUM((CASE WHEN dr.DispatchRequestStatusId = 35  AND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime AND ((dr.CourierRequestTypeId IN ( 5,26,40,55,60 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @OndemandHyperDelayThresholdMinutes) OR (dr.CourierRequestTypeId IN ( 10,15,30,35,45,50,60,65,70 ) AND DATEDIFF(MINUTE,CAST(FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME),CAST(FORMAT(dr.UpdateDate,\u0027####-##-## ##:##:##\\.###\u0027) AS DATETIME)) \u003E @ScheduledHyperDelayThresholdMinutes)) THEN 1 ELSE 0 END)) AS CountOfSlaHyperDelayedDelivery\r\n\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\t\tAND ps.IsActive = 1\r\n\tINNER JOIN Dp.Store s WITH(NOLOCK)\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN CS_UserManagement.UM.Vendor v WITH(NOLOCK)\r\n\t\tON s.VendorId = v.Id\r\n\tINNER JOIN CS_Public.HAF.City c WITH(NOLOCK)\r\n\t\tON s.CityId = c.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\tON ps.StoreId = stbi.StoreId\r\n\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\tLEFT JOIN DP.DispatchRequest drR WITH(NOLOCK)\r\n\t\tON dr.VendorId = drR.VendorId\r\n\t\tAND dr.VendorParcelCode = drR.VendorParcelCode\r\n\t\tAND drR.CourierRequestTypeId = 25\r\n\tWHERE ps.PolygonId = @PolygonId\r\n\tAND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\tAND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n\tAND (@vendorIds IS NULL OR V.Id IN (SELECT VId FROM #vendorIds))\r\n\tAND (@storeName IS NULL OR s.Title LIKE \u0027%\u0027\u002B @storeName\u002B\u0027%\u0027)\r\n\tGroup By ps.StoreId\r\n),CTE_ETADelayedDeliveryCount AS\r\n(\r\n\tSELECT \r\n\t\tps.StoreId AS Id,\r\n\t\tCOUNT(DISTINCT dr.Id) AS countOfDelayedEtaPickupQueue\r\n\tFROM DP.DispatchRequest dr WITH(NOLOCK)\r\n\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\t\tAND ps.IsActive = 1\r\n\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\t\tON dr.Id = sdpdr.DispatchRequestId\r\n\t\tAND dr.Version = sdpdr.Version\r\n\tINNER JOIN DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\tAND sdp.OperationTypeId = 5\r\n\t\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) \u003C @Now_DateTime\r\n\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\tWHERE ps.PolygonId = @PolygonId\r\n\tAND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\tAND dr.DispatchRequestStatusId IN ( 10,15 )\r\n\tAND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n\tGroup By ps.StoreId\r\n),CTE_OperationSlaIndex AS\r\n(\r\n\tSELECT \r\n\t\tSQ.Id,\r\n\t\tCASE \r\n\t\t\tWHEN OperationSlaIndex \u003C= 1 THEN 1\r\n\t\t\tWHEN OperationSlaIndex \u003E 1 AND OperationSlaIndex \u003C= 1.5 THEN 2\r\n\t\t\tWHEN OperationSlaIndex \u003E 1.5 THEN 3\r\n\t\tEND AS OperationSlaIndex\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tps.StoreId AS Id,\r\n\t\t\tSUM(DATEDIFF(MINUTE,CAST(CONVERT(varchar,FORMAT(dr.DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME),@Now_DateTime)) \r\n\t\t\t/SUM(DATEDIFF(MINUTE,CAST(CONVERT(varchar,FORMAT(dr.DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME),CAST(CONVERT(varchar,FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))) OperationSlaIndex\r\n\t\tFROM DP.DispatchRequest dr WITH(NOLOCK) \r\n\t\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\t\tON dr.PolygonStoreId = ps.Id\r\n\t\t\tAND ps.IsActive = 1\r\n\t\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\t\tON dr.CourierRequestTypeId = crtId.Id\r\n\t\tWHERE ps.PolygonId = @PolygonId\r\n\t\tAND dr.DeliveryStartTime BETWEEN @StartRangeTime AND @EndRangeTime\r\n\t\tAND dr.DispatchRequestStatusId IN ( 5,7,10,15,20,25, 45,46,47,48,49,50,51,52,53,54 )\r\n\t\tAND dr.CourierRequestTypeId IN ( 5,10,15 )\r\n\t\tAND dr.DeliveryStartTime \u003C @Now\r\n\t\tAND ( dr.DeliveryServiceProviderId = @DeliveryServiceProviderId OR ISNULL(@DeliveryServiceProviderId,0) = 0 )\r\n\t\tGroup By ps.StoreId\r\n\t) SQ\r\n\t\r\n)\r\nSELECT \r\n\tf.Id,\r\n\tf.Title,\r\n\tf.Phone,\r\n\tf.ResponsibleMobile,\r\n\tf.VendorBrandName,\r\n\tf.VendorCode,\r\n\tf.StoreLocation,\r\n\tf.ProvinceId,\r\n\tf.CityId,\r\n\tf.PolygonId,\r\n\tf.VendorId,\r\n\tf.ScoreFactor,\r\n\tf.OrderCategoryId,\t\r\n\r\n\tISNULL(osi.OperationSlaIndex,1) AS OperationSlaIndex,\r\n\r\n\tISNULL(dr.CountOfUnassignedRequest,0) CountOfUnassignedRequest,\r\n\tISNULL(dr.CountOfTryingToAssign,0) CountOfTryingToAssign,\r\n\tISNULL(dr.CountOfPickupQueue,0) CountOfPickupQueue,\r\n\tISNULL(dr.CountOfDeliveryQueue,0) CountOfDeliveryQueue,\r\n\tISNULL(dr.CountOfDelayedSlaDeliveryQueue,0) CountOfDelayedSlaDeliveryQueue,\r\n\tCASE WHEN ISNULL(dr.CountOfDelivered,0) = 0 THEN 0.00 ELSE ( ISNULL(dr.CountOfDelayedSlaDeliveryQueue,0) / ISNULL(CAST(dr.CountOfDelivered AS numeric),0.00) )*100 END AS PercentageOfDelayedSlaDeliveryQueue,\r\n\tISNULL(dr.CountOfDelivered,0) CountOfDelivered,\r\n\tISNULL(dr.CountOfCanceledRequest,0) CountOfCanceledRequest,\r\n\tISNULL(dr.CountOfReturnedDelivery,0) CountOfReturnedDelivery,\r\n\tISNULL(dr.CountOfSlaOntimeDelivery,0) CountOfSlaOnTimeDelivery,\r\n\tCASE WHEN ISNULL(dr.CountOfDelivered,0) = 0 THEN 0 ELSE ( ISNULL(dr.CountOfSlaOntimeDelivery,0) / ISNULL(CAST(dr.CountOfDelivered AS NUMERIC(5,2)),0.00) )*100 END AS PercentageOfSlaOnTimeDelivery,\r\n\tISNULL(dr.CountOfSlaHyperDelayedDelivery,0) CountOfSlaHyperDelayedDelivery,\r\n\tCASE WHEN ISNULL(dr.CountOfDelivered,0) = 0 THEN 0 ELSE ( ISNULL(dr.CountOfSlaHyperDelayedDelivery,0) / ISNULL(CAST(dr.CountOfDelivered AS NUMERIC(5,2)),0.00) )*100 END AS PercentageOfSlaHyperDelayedDelivery,\r\n\tISNULL(sdd.countOfDelayedEtaPickupQueue,0) CountOfDelayedEtaPickupQueue,\r\n\tISNULL(dr.CountOfSlaDelayedDelivery,0) CountOfSlaDelayedDelivery,\r\n\r\n\tCASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE 100 - (CASE WHEN ISNULL(CountOfDelivered,0) = 0 THEN 0 ELSE (CountOfSlaOntimeDelivery/CAST(CountOfDelivered AS FLOAT))*100 END) - (CASE WHEN CountOfDelivered = 0 THEN 0 ELSE (CountOfSlaHyperDelayedDelivery/CAST(CountOfDelivered AS FLOAT))*100 END) END AS      percentageOfSlaDelayedDelivery\r\n\r\n\r\n\r\n--\tCASE WHEN ISNULL(dr.CountOfDelivered,0) = 0 THEN 0 ELSE ( ISNULL(dr.CountOfSlaDelayedDelivery,0) / ISNULL(CAST(dr.CountOfDelivered AS NUMERIC(5,2)),0.00) )*100 END AS   percentageOfSlaDelayedDelivery\r\n\r\n\r\nINTO #Final\r\nFROM CTE_Final f\r\nLEFT JOIN CTE_DRCounts dr\r\n\tON f.Id = dr.Id\r\nLEFT JOIN CTE_ETADelayedDeliveryCount sdd\r\n\tON f.Id = sdd.Id\r\nLEFT JOIN CTE_OperationSlaIndex osi\r\n\tON f.Id = osi.Id\r\n\t\r\nDECLARE @Str NVARCHAR(MAX) = \u0027\u0027,\r\n\t\t@Param  NVARCHAR(MAX) = \u0027@Result NVARCHAR(MAX) OUTPUT\u0027\r\n\r\nSET @Str \u002B=\r\n\u0027 DECLARE\r\n\t@CountOfUnassignedRequestInPolygon INT = NULL,\t\r\n\t@CountOfTryingToAssignInPolygon INT = NULL,\t\r\n\t@CountOfPickupQueueInPolygon INT = NULL,\t\r\n\t@CountOfDelayedEtaPickupQueueInPolygon INT = NULL,\t\r\n\t@CountOfDeliveryQueueInPolygon INT = NULL,\t\r\n\t@CountOfDelayedSlaDeliveryQueueInPolygon INT = NULL,\r\n\t@CountOfDeliveredInPolygon INT = NULL,\r\n\t@CountOfCanceledRequestInPolygon INT = NULL,\r\n\t@CountOfReturnedDeliveryInPolygon INT = NULL,\r\n\t@PercentageOfSlaOntimeDeliveryInPolygon NUMERIC(5,2) = NULL,\r\n\t@CountOfSlaOntimeDeliveryInPolygon INT = NULL,\r\n\t@PercentageOfSlaHyperDelayedDeliveryInPolygon NUMERIC(5,2) = NULL,\r\n\t@CountOfSlaHyperDelayedDeliveryInPolygon INT = NULL,\r\n\r\n\r\n\t@totalPercentageOfSlaHyperDelayedDelivery NUMERIC(5,2) = NULL,\r\n\t@totalCountOfDelivered INT = NULL,\r\n\t@totalCountOfSlaOnTimeDelivery INT = NULL,\r\n\t@totalPercentageOfSlaOnTimeDelivery NUMERIC(5,2) = NULL,\r\n\t@totalCountOfSlaDelayedDelivery INT = NULL,\r\n\t@totalPercentageOfSlaNormalDelayedDelivery NUMERIC(5,2) = NULL,\r\n\t@totalCountOfSlaHyperDelayedDelivery INT = NULL \u0027\r\n--\t@CountOfSlaDelayedDelivery INT = NULL \u0027\r\n\r\n\r\n\r\n\r\n\r\nSET @Str \u002B=\r\n\u0027 SELECT \r\n\t@CountOfUnassignedRequestInPolygon = SUM(CountOfUnassignedRequest),\t\r\n\t@CountOfTryingToAssignInPolygon = SUM(CountOfTryingToAssign),\t\r\n\t@CountOfPickupQueueInPolygon = SUM(CountOfPickupQueue),\t\r\n\t@CountOfDelayedEtaPickupQueueInPolygon = SUM(CountOfDelayedEtaPickupQueue),\r\n\t@CountOfDeliveryQueueInPolygon = SUM(CountOfDeliveryQueue),\r\n\t@CountOfDelayedSlaDeliveryQueueInPolygon = SUM(CountOfDelayedSlaDeliveryQueue),\r\n\t@CountOfDeliveredInPolygon = SUM(CountOfDelivered),\r\n\t@CountOfCanceledRequestInPolygon = SUM(CountOfCanceledRequest),\r\n\t@CountOfReturnedDeliveryInPolygon = SUM(CountOfReturnedDelivery),\r\n\t@PercentageOfSlaOntimeDeliveryInPolygon = ( CASE WHEN ISNULL(SUM(CountOfDelivered),0) = 0.00 THEN 0 ELSE ( ISNULL(SUM(CountOfSlaOntimeDelivery),0) / ISNULL(CAST(SUM(CountOfDelivered) AS FLOAT),0.00) )*100 END ),\r\n\t@CountOfSlaOntimeDeliveryInPolygon = SUM(CountOfSlaOntimeDelivery),\r\n\t@PercentageOfSlaHyperDelayedDeliveryInPolygon = ( CASE WHEN ISNULL(SUM(CountOfDelivered),0) = 0.00 THEN 0 ELSE ( ISNULL(SUM(CountOfSlaHyperDelayedDelivery),0) / ISNULL(CAST(SUM(CountOfDelivered) AS FLOAT),0.00) )*100 END ),\r\n\t@CountOfSlaHyperDelayedDeliveryInPolygon = SUM(CountOfSlaHyperDelayedDelivery) ,\r\n\r\n\r\n\t@totalPercentageOfSlaHyperDelayedDelivery  = ( CASE WHEN ISNULL(SUM(CountOfDelivered),0) = 0.00 THEN 0 ELSE ( ISNULL(SUM(CountOfSlaHyperDelayedDelivery),0) / ISNULL(CAST(SUM(CountOfDelivered) AS FLOAT),0.00) )*100 END ),\r\n\t@totalCountOfDelivered  = SUM(CountOfDelivered),\r\n\t@totalCountOfSlaOnTimeDelivery  = SUM(CountOfSlaOntimeDelivery),\r\n\t@totalPercentageOfSlaOnTimeDelivery  = ( CASE WHEN ISNULL(SUM(CountOfDelivered),0) = 0.00 THEN 0 ELSE ( ISNULL(SUM(CountOfSlaOntimeDelivery),0) / ISNULL(CAST(SUM(CountOfDelivered) AS FLOAT),0.00) )*100 END ),\r\n\t@totalCountOfSlaDelayedDelivery  = SUM(CountOfSlaDelayedDelivery),\r\n\t@totalPercentageOfSlaNormalDelayedDelivery  = (CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE 100 - (CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaOntimeDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END) - (CASE WHEN SUM(CountOfDelivered) = 0 THEN 0 ELSE (SUM(CountOfSlaHyperDelayedDelivery)/CAST(SUM(CountOfDelivered) AS FLOAT))*100 END) END ),\r\n\t@totalCountOfSlaHyperDelayedDelivery  = SUM(CountOfSlaHyperDelayedDelivery)\r\n\r\n\r\n\r\n\r\nFROM #Final\u0027\r\n\r\nSET @Str \u002B=\r\n\u0027 SELECT\r\n\t@CountOfUnassignedRequestInPolygon = ISNULL(@CountOfUnassignedRequestInPolygon,0),\t\r\n\t@CountOfTryingToAssignInPolygon = ISNULL(@CountOfTryingToAssignInPolygon,0),\t\r\n\t@CountOfPickupQueueInPolygon = ISNULL(@CountOfPickupQueueInPolygon,0),\t\r\n\t@CountOfDelayedEtaPickupQueueInPolygon = ISNULL(@CountOfDelayedEtaPickupQueueInPolygon,0),\r\n\t@CountOfDeliveryQueueInPolygon = ISNULL(@CountOfDeliveryQueueInPolygon,0),\r\n\t@CountOfDelayedSlaDeliveryQueueInPolygon = ISNULL(@CountOfDelayedSlaDeliveryQueueInPolygon,0),\r\n\t@CountOfDeliveredInPolygon = ISNULL(@CountOfDeliveredInPolygon,0),\r\n\t@CountOfCanceledRequestInPolygon = ISNULL(@CountOfCanceledRequestInPolygon,0),\r\n\t@CountOfReturnedDeliveryInPolygon = ISNULL(@CountOfReturnedDeliveryInPolygon,0),\r\n\t@PercentageOfSlaOntimeDeliveryInPolygon = ISNULL(@PercentageOfSlaOntimeDeliveryInPolygon,0.00),\r\n\t@CountOfSlaOntimeDeliveryInPolygon = ISNULL(@CountOfSlaOntimeDeliveryInPolygon,0),\r\n\t@PercentageOfSlaHyperDelayedDeliveryInPolygon = ISNULL(@PercentageOfSlaHyperDelayedDeliveryInPolygon,0.00),\r\n\t@CountOfSlaHyperDelayedDeliveryInPolygon = ISNULL(@CountOfSlaHyperDelayedDeliveryInPolygon,0),\r\n\t--@CountOfSlaDelayedDelivery = ISNULL(@CountOfSlaDelayedDelivery,0),\r\n\t@totalPercentageOfSlaNormalDelayedDelivery = ISNULL(@totalPercentageOfSlaNormalDelayedDelivery,0),\r\n\t@totalCountOfSlaDelayedDelivery = ISNULL(@totalCountOfSlaDelayedDelivery,0) \u0027\r\nSET @Str \u002B=\r\n\u0027 SET @Result = \r\n(\r\n\tSELECT\r\n\t\t@CountOfUnassignedRequestInPolygon AS countOfUnassignedRequestInPolygon,\r\n\t\t@CountOfTryingToAssignInPolygon AS countOfTryingToAssignInPolygon,\r\n\t\t@CountOfPickupQueueInPolygon AS countOfPickupQueueInPolygon,\r\n\t\t@CountOfDelayedEtaPickupQueueInPolygon AS countOfDelayedEtaPickupQueueInPolygon,\r\n\t\t@CountOfDeliveryQueueInPolygon AS countOfDeliveryQueueInPolygon,\r\n\t\t@CountOfDelayedSlaDeliveryQueueInPolygon AS countOfDelayedSlaDeliveryQueueInPolygon,\r\n\t\t@CountOfDeliveredInPolygon AS countOfDeliveredInPolygon,\r\n\t\t@CountOfCanceledRequestInPolygon AS countOfCanceledRequestInPolygon,\r\n\t\t@CountOfReturnedDeliveryInPolygon AS countOfReturnedDeliveryInPolygon,\r\n\t\t@PercentageOfSlaOntimeDeliveryInPolygon AS percentageOfSlaOntimeDeliveryInPolygon,\r\n\t\t@CountOfSlaOntimeDeliveryInPolygon AS countOfSlaOntimeDeliveryInPolygon,\r\n\t\t@PercentageOfSlaHyperDelayedDeliveryInPolygon AS percentageOfSlaHyperDelayedDeliveryInPolygon,\r\n\t\t@CountOfSlaHyperDelayedDeliveryInPolygon AS countOfSlaHyperDelayedDeliveryInPolygon,\r\n\t\t--@CountOfSlaDelayedDelivery AS totalCountOfSlaDelayedDelivery ,\r\n\t\t\r\n\t\t\r\n\t\t@totalCountOfSlaDelayedDelivery AS totalCountOfSlaDelayedDelivery ,\r\n\t\t@totalPercentageOfSlaNormalDelayedDelivery  AS totalPercentageOfSlaNormalDelayedDelivery,\r\n\t\t@PercentageOfSlaHyperDelayedDeliveryInPolygon AS totalPercentageOfSlaHyperDelayedDelivery,\r\n\t\t@CountOfSlaHyperDelayedDeliveryInPolygon AS totalCountOfSlaHyperDelayedDelivery,\r\n\t\t@CountOfDeliveredInPolygon AS totalCountOfDelivered,\r\n\t\t@CountOfSlaOntimeDeliveryInPolygon AS totalCountOfSlaOnTimeDelivery,\r\n\t\t@PercentageOfSlaOntimeDeliveryInPolygon AS totalPercentageOfSlaOnTimeDelivery ,\r\n\r\n\t\r\n\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tid,\r\n\t\t\t\ttitle,\r\n\t\t\t\tphone,\r\n\t\t\t\tresponsibleMobile,\r\n\t\t\t\tvendorBrandName,\r\n\t\t\t\tvendorCode,\r\n\t\t\t\t( SELECT StoreLocation.STY latitude, StoreLocation.STX AS longitude FOR JSON PATH , WITHOUT_ARRAY_WRAPPER ) location,\r\n\t\t\t\tprovinceId,\r\n\t\t\t\tcityId,\r\n\t\t\t\tpolygonId,\r\n\t\t\t\tvendorId,\r\n\t\t\t\tscoreFactor,\r\n\t\t\t\torderCategoryId,\t\r\n\t\t\t\toperationSlaIndex,\r\n\t\t\t\tcountOfUnassignedRequest,\r\n\t\t\t\tcountOfTryingToAssign,\r\n\t\t\t\tcountOfPickupQueue,\r\n\t\t\t\tcountOfDelayedEtaPickupQueue,\r\n\t\t\t\tcountOfDeliveryQueue,\r\n\t\t\t\tcountOfDelayedSlaDeliveryQueue,\r\n\t\t\t\tcountOfDelivered,\r\n\t\t\t\tcountOfCanceledRequest,\r\n\t\t\t\tcountOfReturnedDelivery,\r\n\t\t\t\tcountOfSlaOnTimeDelivery,\r\n\t\t\t\tpercentageOfSlaOnTimeDelivery,\r\n\t\t\t\tcountOfSlaHyperDelayedDelivery,\r\n\t\t\t\tpercentageOfSlaHyperDelayedDelivery,\r\n\t\t\t\tcountOfSlaDelayedDelivery,\r\n\t\t\t\tpercentageOfSlaDelayedDelivery\r\n\r\n\t\t\tFROM #Final\u0027\r\n\t\t\t\u002B CASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 THEN \u0027 ORDER BY \u0027 \u002B @OrderBy \u002B CASE WHEN ISNULL(@IsAsc,0) = 0 THEN \u0027 DESC\u0027 ELSE \u0027 ASC\u0027 END ELSE \u0027 ORDER BY OperationSlaIndex DESC , ScoreFactor Desc , VendorId , OrderCategoryId\u0027 END\r\n\t\t\t\u002B \u0027 FOR JSON PATH\r\n\t\t) AS Stores\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n)\u0027\r\n\r\nEXEC SP_executesql @Str , @Param , @Result = @Result OUTPUT\r\n\r\nSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\nSET @Result = REPLACE(@Result,\u0027}\u0022,\u0022\u0027,\u0027},\u0022\u0027)\r\nSET @Result = REPLACE(@Result,\u0027\u0022:\u0022{\u0027,\u0027\u0022:{\u0027)\r\n"},{"Name":"Get_StorePolygonAssignment","Schema":"dbo","Definition":"\r\n/*\r\n\tDECLARE\r\n\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT\r\n\r\n\tEXEC Get_StorePolygonAssignment\r\n\t@OperationStaffId = 42,\r\n\t@PageIndex  = 0,\r\n\t@PageSize = 100,\r\n\t--@FromCreateDate = \u00272024043017100000000\u0027,\r\n\t--@ToCreateDate = \u00272024043017230000000\u0027,\r\n\t@TotalCount = @TotalCount OUTPUT\t\r\n\r\n\tSELECT\r\n\t\t@TotalCount\t\t\t\t\t\t\t\r\n*/\r\nCREATE   PROC [dbo].[Get_StorePolygonAssignment]\r\n\t@OperationStaffId INT ,\r\n\r\n\t@VendorId\tINT = NULL,\r\n\t@ProvinceId\tTINYINT = NULL,\r\n\t@CityId\t\tSMALLINT = NULL,\r\n\t@PolygonId\tSMALLINT = NULL,\r\n\t@StoreIds\tVARCHAR(MAX) = NULL,\r\n\t@VendorCode\tVARCHAR(50) = NULL,\r\n\t@FromCreateDate\tBIGINT = NULL,\r\n\t@ToCreateDate\tBIGINT = NULL,\r\n\t@DefaultDeliveryServiceProviderId TINYINT = NULL,\r\n\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t\t= NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t= NULL,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t= NULL,--=10,\t\r\n\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT/*,\r\n\t@StorePolygonAssignmentAllCount\t\t\t\tINT OUTPUT,\r\n\t@StorePolygonAssignmentFailureCount\t\t\tINT OUTPUT\t*/\t\r\n\r\nAS \r\nSET NOCOUNT ON\r\n\r\nIF (@OrderBy IS NULL OR @OrderBy = \u0027\u0027)\r\n\tSET @OrderBy = \u0027createDateStr\u0027\r\n\r\nIF @IsASC IS NULL \r\n\tSET @IsASC = 0\r\n\r\nIF @pageIndex IS NULL \r\n\tSET @pageIndex = 0\r\n\r\nIF @PageSize IS NULL\r\n\tSET @PageSize = 0\r\n\r\nIF @PageIndex = 0 AND @PageSize = 0\r\n\tReturn\r\n\r\nSELECT\r\n\t@VendorId = ISNULL(@VendorId,0),\r\n\t@ProvinceId = ISNULL(@ProvinceId,0),\r\n\t@CityId = ISNULL(@CityId,0),\r\n\t@PolygonId = ISNULL(@PolygonId,0),\r\n\t@StoreIds = ISNULL(@StoreIds,\u00270\u0027),\r\n\t@DefaultDeliveryServiceProviderId = ISNULL(@DefaultDeliveryServiceProviderId,0),\r\n\t@VendorCode = ISNULL(@VendorCode,\u00270\u0027),\r\n\t@FromCreateDate = ISNULL(@FromCreateDate,0),\r\n\t@ToCreateDate = ISNULL(@ToCreateDate,0)\r\n\r\n\r\nSELECT \r\n\ts.Id\r\nINTO #StoreIDs\r\nFROM DP.Store s (NOLOCK)\r\nINNER JOIN string_split(@StoreIds,\u0027,\u0027) ss\r\n\tON s.ID = ss.value\r\n\tOR @StoreIds = \u00270\u0027\r\n\r\n-- TotalCount\r\nBEGIN\r\n\r\n\t;WITH CTE_Polygons AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tpos.PolygonId\r\n\t\tFROM DP.PolygonOperationStaff pos (NOLOCK)\r\n\t\tWHERE pos.IsActive = 1\r\n\t\tAND pos.OperationStaffId = @OperationStaffId\r\n\t\tAND ( pos.PolygonId = @PolygonId OR @PolygonId = 0 )\r\n\t)\r\n\tSELECT \r\n\t\t@TotalCount = COUNT(*)\r\n\tFROM DP.PolygonStore ps (NOLOCK)\r\n\tINNER JOIN CTE_Polygons pos\r\n\t\tON pos.PolygonId = ps.PolygonId\r\n\t\tAND ps.IsActive = 1\r\n\t\tAND ps.IsApprovedByOperationStaff IS NULL\r\n\t\tAND ps.AssignmentType = 1\r\n\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\tON ps.StoreId = s.Id\r\n\t\tAND s.IsActive = 1\r\n\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.ID\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\t\tON p.CityId = c.Id\r\n\tINNER JOIN CS_Public.HAF.Province pv (NOLOCK)\r\n\t\tON c.ProvinceId = pv.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi\r\n\t\tON s.Id = stbi.StoreId\r\n\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\tON s.VendorID = v.Id\r\n\tINNER JOIN #StoreIDs sIDs\r\n\t\tON ps.StoreId = sIDs.Id\r\n\tWHERE \r\n\t\t( s.VendorId = @VendorId OR @VendorId = 0 )\r\n\tAND ( c.ProvinceId = @ProvinceId OR @ProvinceId = 0 )\r\n\tAND ( p.CityId = @CityId OR @CityId = 0 )\r\n\t--AND ( stbi.DefaultDeliveryServiceProviderId = @DefaultDeliveryServiceProviderId OR @DefaultDeliveryServiceProviderId = 0 )\r\n\tAND ( s.VendorCode = @VendorCode OR @VendorCode = \u00270\u0027 )\r\n\tAND ( s.CreateDate \u003E= @FromCreateDate OR @FromCreateDate = 0 )\r\n\tAND ( s.CreateDate \u003C= @ToCreateDate OR @ToCreateDate = 0 )\r\n\t --EXEC StorePolygonAssignmentsCount\r\n\t\t-- @OperationStaffId = @OperationStaffId ,\r\n\t\t-- @VendorId = @VendorId,\r\n\t\t-- @ProvinceId = @ProvinceId,\r\n\t\t-- @CityId = @CityId,\r\n\t\t-- @PolygonId = @PolygonId,\r\n\t\t-- @StoreId = @StoreId,\r\n\t\t-- @CreateDate = @CreateDate,\r\n\t\t-- @DefaultDeliveryServiceProviderId = @DefaultDeliveryServiceProviderId,\r\n\t\t-- @StorePolygonAssignmentAllCount = @StorePolygonAssignmentAllCount OUTPUT,\r\n\t\t-- @StorePolygonAssignmentFailureCount = @StorePolygonAssignmentFailureCount OUTPUT\r\n\r\nEND\r\n\r\n--Output\r\nBEGIN\r\n\r\n\tDECLARE @SQLStr NVARCHAR(MAX) = \u0027\u0027\r\n\r\n\tSET @SQLStr \u002B=\r\n\t\u0027; WITH CTE_Polygons AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tpos.PolygonId\r\n\t\tFROM DP.PolygonOperationStaff pos (NOLOCK)\r\n\t\tWHERE pos.IsActive = 1\r\n\t\tAND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @PolygonId IS NOT NULL AND @PolygonId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND pos.PolygonId = \u0027\u002B CAST(@PolygonId AS VARCHAR(MAX))\r\n\r\n\tSET @SQLStr \u002B=\r\n\t\u0027 )\r\n\tSELECT \r\n\t\t*\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\ts.Id AS storeId,\r\n\t\t\ts.Title AS storeTitle,\r\n\t\t\tps.ID AS polygonStoreId,\r\n\t\t\ts.vendorId,\r\n\t\t\tV.BrandName AS vendorBrandName,\r\n\t\t\ts.Location.STY AS storeLocationLat,\r\n\t\t\ts.Location.STX AS storeLocationLong,\r\n\t\t\t\u0027\u00270\u0027\u0027 \u002B CAST(s.responsibleMobile AS VARCHAR(11)) responsibleMobile,\r\n\t\t\ts.responsibleName,\r\n\t\t\t\u0027\u00270\u0027\u0027 \u002B CAST(s.phone AS VARCHAR(11)) phone,\r\n\t\t\ts.vendorCode,\r\n\t\t\tp.Id AS polygonId,\r\n\t\t\tp.Title AS polygonTitle,\r\n\t\t\ts.cityId,\r\n\t\t\tc.Name AS cityTitle,\r\n\t\t\ts.isActive,\r\n\t\t\ts.address,\r\n\t\t\tFORMAT(s.createDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) createDateStr,\r\n\t\t\tFORMAT(s.createDatePersian,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) createDatePersianStr,\r\n\t\t\ts.orderCategoryId,\r\n\t\t\toc.Title AS orderCategoryTitle,\r\n\t\t\tc.provinceId,\r\n\t\t\tpv.Name AS provinceTitle,\r\n\t\t\tstbi.scoreFactor\r\n\t\tFROM DP.PolygonStore ps (NOLOCK)\r\n\t\tINNER JOIN CTE_Polygons pos\r\n\t\t\tON pos.PolygonId = ps.PolygonId\r\n\t\t\tAND ps.IsActive = 1\r\n\t\t\tAND ps.IsApprovedByOperationStaff IS NULL\r\n\t\t\tAND ps.AssignmentType = 1\r\n\t\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\t\tON ps.StoreId = s.Id\r\n\t\t\tAND s.IsActive = 1\r\n\t\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\t\tON ps.PolygonId = p.ID\r\n\t\tINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\t\t\tON p.CityId = c.Id\r\n\t\tINNER JOIN CS_Public.HAF.Province pv (NOLOCK)\r\n\t\t\tON c.ProvinceId = pv.Id\r\n\t\tINNER JOIN DP.StoreTechnicalBasicInformation stbi\r\n\t\t\tON s.Id = stbi.StoreId\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\tON s.VendorID = v.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\t\tON s.OrderCategoryId = oc.Id\r\n\t\tINNER JOIN #StoreIDs sIDs\r\n\t\t\tON ps.StoreId = sIDs.Id\r\n\t\tWHERE 1=1\u0027;\r\n\r\n\tIF @VendorId IS NOT NULL AND @VendorId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.VendorId = \u0027\u002B CAST(@VendorId AS VARCHAR(MAX));\r\n\r\n\tIF @ProvinceId IS NOT NULL AND @ProvinceId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND c.ProvinceId = \u0027\u002B CAST(@ProvinceId AS VARCHAR(MAX));\r\n\r\n\tIF @CityId IS NOT NULL AND @CityId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND p.CityId = \u0027\u002B CAST(@CityId AS VARCHAR(MAX))\r\n\r\n\t--IF @DefaultDeliveryServiceProviderId IS NULL OR @DefaultDeliveryServiceProviderId \u003C\u003E 0\r\n\t--\tSET @SQLStr \u002B= \u0027 AND stbi.DefaultDeliveryServiceProviderId = \u0027\u002B CAST(@DefaultDeliveryServiceProviderId AS VARCHAR(MAX));\r\n\r\n\tIF @VendorCode IS NULL OR @VendorCode \u003C\u003E \u00270\u0027\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.VendorCode = \u0027\u0027\u0027\u002B CAST(@VendorCode AS VARCHAR(MAX))\u002B\u0027\u0027\u0027\u0027;\r\n\r\n\tIF @FromCreateDate IS NOT NULL AND @FromCreateDate \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.CreateDate \u003E= \u0027\u002B CAST(@FromCreateDate AS VARCHAR(MAX))\r\n\r\n\tIF @ToCreateDate IS NOT NULL AND @ToCreateDate \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.CreateDate \u003C= \u0027\u002B CAST(@ToCreateDate AS VARCHAR(MAX))\r\n\r\n\tSET @SQLStr \u002B=\r\n\t\u0027)SQ\r\n\tOrder By \u0027 \u002B @OrderBy \u002B CASE WHEN @IsASC = 0 THEN \u0027 DESC \u0027 ELSE \u0027 ASC \u0027 END \u002B\u0027\r\n\tOFFSET \u0027\u002BCAST(@pageIndex * @pageSize AS VARCHAR(MAX))\u002B\u0027 ROWS FETCH NEXT \u0027\u002BCAST(@pageSize AS VARCHAR(MAX))\u002B\u0027 ROWS ONLY\u0027;\r\n\t--SELECT @SQLStr\r\n\tEXECUTE sys.sp_executeSQL @SQLStr\r\n\t\r\nEND\r\n\r\nSELECT\r\n\t@TotalCount\t\t\t\t\t\t\t\t= ISNULL(@TotalCount,0)/*,\r\n\t@StorePolygonAssignmentAllCount\t\t\t= ISNULL(@StorePolygonAssignmentAllCount,0),\r\n\t@StorePolygonAssignmentFailureCount\t\t= ISNULL(@StorePolygonAssignmentFailureCount,0)*/"},{"Name":"Get_StorePolygonAssignmentFailure","Schema":"dbo","Definition":"CREATE   PROC [dbo].[Get_StorePolygonAssignmentFailure]\r\n\t@OperationStaffId INT ,\r\n\r\n\t@VendorId\tINT = NULL,\r\n\t@ProvinceId\tTINYINT = NULL,\r\n\t@CityId\t\tSMALLINT = NULL,\r\n\t@PolygonId\tSMALLINT = NULL,\r\n\t@StoreIds\tVARCHAR(MAX) = NULL,\r\n\t@VendorCode\tVARCHAR(50) = NULL,\r\n\t@FromCreateDate\tBIGINT = NULL,\r\n\t@ToCreateDate\tBIGINT = NULL,\r\n\t@DefaultDeliveryServiceProviderId TINYINT = NULL,\r\n\t@PolygonAssignmentReasonId\t\tTINYINT = NULL,\r\n\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t= NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t= NULL,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t= NULL,--=10,\t\r\n\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT/*,\r\n\t@StorePolygonAssignmentAllCount\t\t\t\tINT OUTPUT,\r\n\t@StorePolygonAssignmentCount\t\t\t\tINT OUTPUT*/\t\r\n\r\nAS \r\nSET NOCOUNT ON\r\n\r\nSET @FromCreateDate = 0\r\nSET @ToCreateDate = 0\r\n\r\n\r\nDECLARE @LastWeek BIGINT = FORMAT(GETDATE()-7,\u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027\r\n\r\nIF (@OrderBy IS NULL OR @OrderBy = \u0027\u0027)\r\n\tSET @OrderBy = \u0027createDate\u0027\r\n\r\nIF @IsASC IS NULL \r\n\tSET @IsASC = 0\r\n\r\nIF @pageIndex IS NULL \r\n\tSET @pageIndex = 0\r\n\r\nIF @PageSize IS NULL\r\n\tSET @PageSize = 0\r\n\r\nIF @PageIndex = 0 AND @PageSize = 0\r\n\tReturn\r\n\r\nSELECT\r\n\t@VendorId = ISNULL(@VendorId,0),\r\n\t@ProvinceId = ISNULL(@ProvinceId,0),\r\n\t@CityId = ISNULL(@CityId,0),\r\n\t@PolygonId = ISNULL(@PolygonId,0),\r\n\t@StoreIds = ISNULL(@StoreIds,\u00270\u0027),\r\n\t@DefaultDeliveryServiceProviderId = ISNULL(@DefaultDeliveryServiceProviderId,0),\r\n\t@VendorCode = ISNULL(@VendorCode,\u00270\u0027),\r\n\t@FromCreateDate = ISNULL(@FromCreateDate,0),\r\n\t@ToCreateDate = ISNULL(@ToCreateDate,0),\r\n\t@PolygonAssignmentReasonId = ISNULL(@PolygonAssignmentReasonId,0)\r\n\r\n\tDROP TABLE IF EXISTS #StoreIDs\r\nSELECT \r\n\ts.Id\r\nINTO #StoreIDs\r\nFROM DP.Store s (NOLOCK)\r\nINNER JOIN string_split(@StoreIds,\u0027,\u0027) ss\r\n\tON s.ID = ss.value\r\n\tOR @StoreIds = \u00270\u0027\r\n\r\n-- TotalCount\r\nBEGIN\r\n\r\n\t;WITH CTE_Polygons AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tpos.PolygonId\r\n\t\tFROM DP.PolygonOperationStaff pos (NOLOCK)\r\n\t\tWHERE pos.IsActive = 1\r\n\t\tAND pos.OperationStaffId = @OperationStaffId\r\n\t\tAND ( pos.PolygonId = @PolygonId OR @PolygonId = 0 )\r\n\t)\r\n\tSELECT \r\n\t\t@TotalCount = COUNT(DISTINCT SQ.StoreId)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tpar.StoreId\r\n\t\tFROM CTE_Polygons pos\r\n\t\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\t\tON pos.PolygonId = p.ID\r\n\t\tINNER JOIN DP.PolygonAssignmentResult par (NOLOCK)\r\n\t\t\tON p.Id = par.PolygonId\r\n\t\t\t--AND par.IsActive = 1\r\n\t\tINNER JOIN DP.StoreTechnicalBasicInformation stbil\r\n\t\t\tON par.StoreId = stbil.StoreId\r\n\t\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\t\tON par.StoreId = s.Id\r\n\t\t\tAND s.IsActive = 1\r\n\t\tINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\t\t\tON p.CityId = c.Id\r\n\t\tINNER JOIN CS_Public.HAF.Province pv (NOLOCK)\r\n\t\t\tON c.ProvinceId = pv.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\tON s.VendorID = v.Id\r\n\t\tINNER JOIN #StoreIDs sIDs\r\n\t\t\tON s.Id = sIDs.Id\r\n\t\tWHERE \r\n\t\t\t( s.VendorId = @VendorId OR @VendorId = 0 )\r\n\t\tAND ( c.ProvinceId = @ProvinceId OR @ProvinceId = 0 )\r\n\t\tAND ( p.CityId = @CityId OR @CityId = 0 )\r\n\t\t--AND ( stbil.DefaultDeliveryServiceProviderId = @DefaultDeliveryServiceProviderId OR @DefaultDeliveryServiceProviderId = 0 )\r\n\t\tAND ( s.VendorCode = @VendorCode OR @VendorCode = \u00270\u0027 )\r\n\t\tAND ( s.CreateDate \u003E= @FromCreateDate OR @FromCreateDate = 0 )\r\n\t\tAND ( s.CreateDate \u003C= @ToCreateDate OR @ToCreateDate = 0 )\r\n\t\tAND ( par.PolygonAssignmentReasonId = @PolygonAssignmentReasonId OR @PolygonAssignmentReasonId = 0 )\r\n\t\tAND NOT EXISTS (SELECT * FROM DP.PolygonStore ps (NOLOCK) WHERE S.Id = PS.StoreId AND PS.IsActive = 1)\r\n\t\tUNION ALL\r\n\t\tSELECT \r\n\t\t\tpar.StoreId\r\n\t\tFROM DP.PolygonAssignmentResult par (NOLOCK) \r\n\t\tINNER JOIN DP.PolygonAssignmentReason pare (NOLOCK) \r\n\t\t\tON par.PolygonAssignmentReasonId = pare.Id\r\n\t\tINNER JOIN DP.StoreTechnicalBasicInformation stbil \r\n\t\t\tON par.StoreId = stbil.StoreId\r\n\t\t\t--AND par.IsActive = 1\r\n\t\t\tAND par.PolygonId IS NULL\r\n\t\tINNER JOIN DP.Store s (NOLOCK) \r\n\t\t\tON par.StoreId = s.Id\r\n\t\t\tAND s.IsActive = 1\r\n\t\tINNER JOIN CS_Public.HAF.City c (NOLOCK) \r\n\t\t\tON s.CityId = c.Id\r\n\t\tINNER JOIN CS_Public.HAF.Province pv (NOLOCK) \r\n\t\t\tON c.ProvinceId = pv.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK) \r\n\t\t\tON s.VendorID = v.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK) \r\n\t\t\tON s.OrderCategoryId = oc.Id\r\n\t\tINNER JOIN #StoreIDs sIDs \r\n\t\t\tON s.Id = sIDs.Id\r\n\t\tWHERE \r\n\t\t\t( s.VendorId = @VendorId OR @VendorId = 0 )\r\n\t\tAND ( c.ProvinceId = @ProvinceId OR @ProvinceId = 0 )\r\n\t\tAND ( s.CityId = @CityId OR @CityId = 0 )\r\n\t\t--AND ( stbil.DefaultDeliveryServiceProviderId = @DefaultDeliveryServiceProviderId OR @DefaultDeliveryServiceProviderId = 0 )\r\n\t\tAND ( s.VendorCode = @VendorCode OR @VendorCode = \u00270\u0027 )\r\n\t\tAND ( s.CreateDate \u003E= @FromCreateDate OR @FromCreateDate = 0 )\r\n\t\tAND ( s.CreateDate \u003C= @ToCreateDate OR @ToCreateDate = 0 )\r\n\t\tAND ( par.PolygonAssignmentReasonId = @PolygonAssignmentReasonId OR @PolygonAssignmentReasonId = 0 )\r\n\t\tAND NOT EXISTS (SELECT * FROM DP.PolygonStore ps (NOLOCK) WHERE S.Id = PS.StoreId AND PS.IsActive = 1)\r\n\t) SQ\r\n\t --EXEC StorePolygonAssignmentsCount\r\n\t\t-- @OperationStaffId = @OperationStaffId ,\r\n\t\t-- @VendorId = @VendorId,\r\n\t\t-- @ProvinceId = @ProvinceId,\r\n\t\t-- @CityId = @CityId,\r\n\t\t-- @PolygonId = @PolygonId,\r\n\t\t-- @StoreId = @StoreId,\r\n\t\t-- @CreateDate = @CreateDate,\r\n\t\t-- @DefaultDeliveryServiceProviderId = @DefaultDeliveryServiceProviderId,\r\n\t\t-- @StorePolygonAssignmentAllCount = @StorePolygonAssignmentAllCount OUTPUT,\r\n\t\t-- @StorePolygonAssignmentCount = @StorePolygonAssignmentCount OUTPUT\r\n\r\nEND\r\n\r\n--Output\r\nBEGIN\r\n\r\n\tDECLARE @SQLStr NVARCHAR(MAX) = \u0027\u0027\r\n\r\n\tSET @SQLStr \u002B=\r\n\t\u0027; WITH CTE_Polygons AS\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tpos.PolygonId\r\n\t\tFROM DP.PolygonOperationStaff pos (NOLOCK)\r\n\t\tWHERE pos.IsActive = 1\r\n\t\tAND pos.OperationStaffId = \u0027\u002BCAST(@OperationStaffId AS VARCHAR(MAX))\r\n\r\n\tIF @PolygonId IS NOT NULL AND @PolygonId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND pos.PolygonId = \u0027\u002B CAST(@PolygonId AS VARCHAR(MAX))\r\n\r\n\tSET @SQLStr \u002B=\r\n\t\u0027 )\r\n\tSELECT \r\n\t\tstoreId,\r\n\t\tstoreTitle,\r\n\t\tvendorId,\r\n\t\tvendorBrandName,\r\n\t\tstoreLocationLat,\r\n\t\tstoreLocationLong,\r\n\t\t\u0027\u00270\u0027\u0027 \u002B CAST(responsibleMobile AS VARCHAR(11)) responsibleMobile,\r\n\t\tresponsibleName,\r\n\t\t\u0027\u00270\u0027\u0027 \u002B CAST(phone AS VARCHAR(11)) phone ,\r\n\t\tvendorCode,\r\n\t\tcityId,\r\n\t\tcityTitle,\r\n\t\tisActive,\r\n\t\taddress,\r\n\t\tFORMAT(createDate,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) createDateStr,\r\n\t\tFORMAT(createDatePersian,\u0027\u0027####-##-## ##:##:##\\.###\u0027\u0027) createDatePersianStr,\r\n\t\torderCategoryId,\r\n\t\torderCategoryTitle,\r\n\t\tprovinceId,\r\n\t\tprovinceTitle,\r\n\t\tscoreFactor,\r\n\t\tString_Agg(PolygonId,\u0027\u0027,\u0027\u0027) AS PolygonIds,\r\n\t\tString_Agg(CAST(PolygonTitle AS NVARCHAR(MAX)),\u0027\u0027,\u0027\u0027) AS PolygonTitles,\r\n\t\tMAX(PolygonAssignmentReasonId) polygonAssignmentReasonId ,\r\n\t\tMAX(PolygonAssignmentReasonTitle) polygonAssignmentReasonTitle \r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\ts.id AS storeId,\r\n\t\t\ts.Title AS storeTitle,\r\n\t\t\ts.vendorId,\r\n\t\t\ts.vendorCode,\r\n\t\t\tV.BrandName AS vendorBrandName,\r\n\t\t\ts.Location.STY AS storeLocationLat,\r\n\t\t\ts.Location.STX AS storeLocationLong,\r\n\t\t\ts.responsibleMobile,\r\n\t\t\ts.responsibleName,\r\n\t\t\ts.phone,\r\n\t\t\ts.cityId,\r\n\t\t\tc.Name AS cityTitle,\r\n\t\t\ts.isActive,\r\n\t\t\ts.address,\r\n\t\t\ts.createDate,\r\n\t\t\ts.createDatePersian,\r\n\t\t\ts.orderCategoryId,\r\n\t\t\toc.Title AS orderCategoryTitle,\r\n\t\t\tc.provinceId,\r\n\t\t\tpv.Name AS provinceTitle,\r\n\t\t\tstbil.scoreFactor,\r\n\t\t\tp.Id AS PolygonId,\r\n\t\t\tp.Title AS PolygonTitle,\r\n\t\t\tpar.PolygonAssignmentReasonId,\r\n\t\t\tpare.Title AS PolygonAssignmentReasonTitle\r\n\t\tFROM CTE_Polygons pos\r\n\t\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\t\tON pos.PolygonId = p.ID\r\n\t\tINNER JOIN DP.PolygonAssignmentResult par (NOLOCK)\r\n\t\t\tON p.Id = par.PolygonId\r\n\t\t\t--AND par.IsActive = 1\r\n\t\tINNER JOIN DP.PolygonAssignmentReason pare (NOLOCK)\r\n\t\t\tON par.PolygonAssignmentReasonId = pare.Id\r\n\t\tINNER JOIN DP.StoreTechnicalBasicInformation stbil\r\n\t\t\tON par.StoreId = stbil.StoreId\r\n\t\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\t\tON par.StoreId = s.Id\r\n\t\t\tAND s.IsActive = 1\r\n\t\tINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\t\t\tON p.CityId = c.Id\r\n\t\tINNER JOIN CS_Public.HAF.Province pv (NOLOCK)\r\n\t\t\tON c.ProvinceId = pv.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\tON s.VendorID = v.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\t\tON s.OrderCategoryId = oc.Id\r\n\t\tINNER JOIN #StoreIDs sIDs\r\n\t\t\tON s.Id = sIDs.Id\r\n\t\tWHERE 1=1\r\n\t\tAND NOT EXISTS (SELECT * FROM DP.PolygonStore ps (NOLOCK) WHERE S.Id = PS.StoreId AND PS.IsActive = 1)\u0027;\r\n\r\n\tIF @VendorId IS NOT NULL AND @VendorId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.VendorId = \u0027\u002B CAST(@VendorId AS VARCHAR(MAX))\r\n\r\n\tIF @ProvinceId IS NOT NULL AND @ProvinceId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND c.ProvinceId = \u0027\u002B CAST(@ProvinceId AS VARCHAR(MAX))\r\n\r\n\tIF @CityId IS NOT NULL AND @CityId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND p.CityId = \u0027\u002B CAST(@CityId AS VARCHAR(MAX))\r\n\r\n\t--IF @DefaultDeliveryServiceProviderId IS NULL OR @DefaultDeliveryServiceProviderId \u003C\u003E 0\r\n\t--\tSET @SQLStr \u002B= \u0027 AND stbil.DefaultDeliveryServiceProviderId = \u0027\u002B CAST(@DefaultDeliveryServiceProviderId AS VARCHAR(MAX))\r\n\r\n\tIF @VendorCode IS NULL OR @VendorCode \u003C\u003E \u00270\u0027\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.VendorCode = \u0027\u0027\u0027\u002B CAST(@VendorCode AS VARCHAR(MAX))\u002B\u0027\u0027\u0027\u0027;\r\n\r\n\tIF @FromCreateDate IS NOT NULL AND @FromCreateDate \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.CreateDate \u003E= \u0027\u002B CAST(@FromCreateDate AS VARCHAR(MAX))\r\n\r\n\tIF @ToCreateDate IS NOT NULL AND @ToCreateDate \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.CreateDate \u003C= \u0027\u002B CAST(@ToCreateDate AS VARCHAR(MAX))\r\n\r\n\tIF @PolygonAssignmentReasonId IS NOT NULL AND @PolygonAssignmentReasonId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND par.PolygonAssignmentReasonId = \u0027\u002BCAST(@PolygonAssignmentReasonId AS VARCHAR(MAX))\r\n\r\n\tSET @SQLStr \u002B=\r\n\t\u0027 UNION ALL\r\n\tSELECT \r\n\t\ts.id AS storeId,\r\n\t\ts.Title AS storeTitle,\r\n\t\ts.vendorId,\r\n\t\ts.vendorCode,\r\n\t\tV.BrandName AS vendorBrandName,\r\n\t\ts.Location.STY AS storeLocationLat,\r\n\t\ts.Location.STX AS storeLocationLong,\r\n\t\ts.responsibleMobile,\r\n\t\ts.responsibleName,\r\n\t\ts.phone,\r\n\t\ts.cityId,\r\n\t\tc.Name AS cityTitle,\r\n\t\ts.isActive,\r\n\t\ts.address,\r\n\t\ts.createDate,\r\n\t\ts.createDatePersian,\r\n\t\ts.orderCategoryId,\r\n\t\toc.Title AS orderCategoryTitle,\r\n\t\tc.provinceId,\r\n\t\tpv.Name AS provinceTitle,\r\n\t\tstbil.scoreFactor,\r\n\t\tNULL AS PolygonId,\r\n\t\tNULL AS PolygonTitle,\r\n\t\tpar.PolygonAssignmentReasonId,\r\n\t\tpare.Title AS PolygonAssignmentReasonTitle\r\n\tFROM DP.PolygonAssignmentResult par (NOLOCK) \r\n\tINNER JOIN DP.PolygonAssignmentReason pare (NOLOCK) \r\n\t\tON par.PolygonAssignmentReasonId = pare.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbil \r\n\t\tON par.StoreId = stbil.StoreId\r\n\t\t--AND par.IsActive = 1\r\n\t\tAND par.PolygonId IS NULL\r\n\tINNER JOIN DP.Store s (NOLOCK) \r\n\t\tON par.StoreId = s.Id\r\n\t\tAND s.IsActive = 1\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK) \r\n\t\tON s.CityId = c.Id\r\n\tINNER JOIN CS_Public.HAF.Province pv (NOLOCK) \r\n\t\tON c.ProvinceId = pv.Id\r\n\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK) \r\n\t\tON s.VendorID = v.Id\r\n\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK) \r\n\t\tON s.OrderCategoryId = oc.Id\r\n\tINNER JOIN #StoreIDs sIDs \r\n\t\tON s.Id = sIDs.Id\r\n\tWHERE 1=1\r\n\tAND NOT EXISTS (SELECT * FROM DP.PolygonStore ps (NOLOCK) WHERE S.Id = PS.StoreId AND PS.IsActive = 1)\t\t\u0027\r\n\r\n\tIF @VendorId IS NOT NULL AND @VendorId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.VendorId = \u0027\u002B CAST(@VendorId AS VARCHAR(MAX))\r\n\r\n\tIF @ProvinceId IS NOT NULL AND @ProvinceId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND c.ProvinceId = \u0027\u002B CAST(@ProvinceId AS VARCHAR(MAX))\r\n\r\n\tIF @CityId IS NOT NULL AND @CityId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.CityId = \u0027\u002B CAST(@CityId AS VARCHAR(MAX))\r\n\r\n\t--IF @DefaultDeliveryServiceProviderId IS NULL OR @DefaultDeliveryServiceProviderId \u003C\u003E 0\r\n\t--\tSET @SQLStr \u002B= \u0027 AND stbil.DefaultDeliveryServiceProviderId = \u0027\u002B CAST(@DefaultDeliveryServiceProviderId AS VARCHAR(MAX))\r\n\r\n\tIF @VendorCode IS NULL OR @VendorCode \u003C\u003E \u00270\u0027\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.VendorCode = \u0027\u0027\u0027\u002B CAST(@VendorCode AS VARCHAR(MAX))\u002B\u0027\u0027\u0027\u0027;\r\n\r\n\tIF @FromCreateDate IS NOT NULL AND @FromCreateDate \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.CreateDate \u003E= \u0027\u002B CAST(@FromCreateDate AS VARCHAR(MAX))\r\n\r\n\tIF @ToCreateDate IS NOT NULL AND @ToCreateDate \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND s.CreateDate \u003C= \u0027\u002B CAST(@ToCreateDate AS VARCHAR(MAX))\r\n\r\n\tIF @PolygonAssignmentReasonId IS NOT NULL AND @PolygonAssignmentReasonId \u003C\u003E 0\r\n\t\tSET @SQLStr \u002B= \u0027 AND par.PolygonAssignmentReasonId = \u0027\u002BCAST(@PolygonAssignmentReasonId AS VARCHAR(MAX))\r\n\r\n\tSET @SQLStr \u002B=\r\n\t\u0027)SQ\r\n\tGroup By\r\n\t\tstoreId,\r\n\t\tstoreTitle,\r\n\t\tvendorId,\r\n\t\tvendorBrandName,\r\n\t\tstoreLocationLat,\r\n\t\tstoreLocationLong,\r\n\t\tresponsibleMobile,\r\n\t\tresponsibleName,\r\n\t\tphone,\r\n\t\tvendorCode,\r\n\t\tcityId,\r\n\t\tcityTitle,\r\n\t\tisActive,\r\n\t\taddress,\r\n\t\tcreateDate,\r\n\t\tcreateDatePersian,\r\n\t\tOrderCategoryId,\r\n\t\tOrderCategoryTitle,\r\n\t\tprovinceId,\r\n\t\tprovinceTitle,\r\n\t\tscoreFactor\r\n\tOrder By \u0027 \u002B @OrderBy \u002B CASE WHEN @IsASC = 0 THEN \u0027 DESC \u0027 ELSE \u0027 ASC \u0027 END \u002B\u0027\r\n\tOFFSET \u0027\u002BCAST(@pageIndex * @pageSize AS VARCHAR(MAX))\u002B\u0027 ROWS FETCH NEXT \u0027\u002BCAST(@pageSize AS VARCHAR(MAX))\u002B\u0027 ROWS ONLY\u0027;\r\n--\tSELECT @SQLStr\r\n\tEXECUTE sys.sp_executeSQL @SQLStr\r\n\r\nEND\r\n\r\nSELECT\r\n\t@TotalCount\t\t\t\t\t\t\t\t= ISNULL(@TotalCount,0)/*,\r\n\t@StorePolygonAssignmentAllCount\t\t\t= ISNULL(@StorePolygonAssignmentAllCount,0),\r\n\t@StorePolygonAssignmentCount\t\t= ISNULL(@StorePolygonAssignmentCount,0)*/\r\n\r\n\r\n"},{"Name":"Get_SubmitPickupResult","Schema":"dbo","Definition":"-- Stored Procedure\r\n\r\nCREATE PROCEDURE [dbo].[Get_SubmitPickupResult]\r\n\t @OperationTypeId TINYINT,\r\n\t @ParcelReferenceCodes NVARCHAR(MAX)\t\r\nAS\r\nDECLARE @ParcelReferenceCode TABLE \r\n\t(\r\n\t\tId\tBIGINT\r\n\t)\r\n\tINSERT INTO @ParcelReferenceCode\r\n\tSELECT value\r\n\tFROM string_split(@ParcelReferenceCodes,\u0027,\u0027)\r\n\r\nSELECT \r\n       sdps.[Id] ShipmentDestinationPointStatus_Id,[Name],[Title],[IsActive],[Description],\r\n\r\n\t   sdpsh.[Id] ShipmentDestinationPointStatusHistory_Id,sdpsh.[ShipmentDestinationPointStatusId],sdpsh.[ShipmentDestinationPointId],sdpsh.[CreateDate],sdpsh.[CreateDatePersian],\r\n\r\n\t   sdp.[Id] ShipmentDestinationPoint_Id,[ShipmentId],[OperationTypeId],sdp.[ShipmentDestinationPointStatusId],[AssignmentMethodId],[Location],[IsVendorLocation]\r\n      ,[SequenceNumber],sdp.[CreateDate],sdp.[CreateDatePersian],[DisplacementMeter],[DistanceMeter],[EstimatedDurationSeconds],[EstimatedOperationTimeSeconds]\r\n      ,[EstimatedArrivalTime],[EstimatedArrivalTimePersian],sdp.[UpdateDate],sdp.[UpdateDatePersian],sdp.[ModifierUserName],\r\n\r\n\t  sdpdr.[Id] ShipmentDestinationPointDispatchRequest_Id,sdpdr.[DispatchRequestId],sdpdr.[ShipmentDestinationPointId],sdpdr.[CreateDate],sdpdr.[CreateDatePersian],\r\n\r\n\t  dr.[Id] DispatchRequest_Id,[PolygonStoreId],[DispatchRequestStatusId],[CourierRequestTypeId],[ParcelReferenceCode],[ClientLocation],[ClientAddress],dr.[CreateDate],dr.[CreateDatePersian],\r\n\t  [DeliveryStartTime],[DeliveryDeadLineTime],[DeliveryStartTimePersian],[DeliveryDeadLineTimePersian],dr.[UpdateDate],dr.[UpdateDatePersian],dr.[ModifierUserName],[VendorParcelCode]\r\n\r\nFROM \r\n             [DP].[ShipmentDestinationPointStatus] sdps\r\n\t\tJOIN [DP].[ShipmentDestinationPointStatusHistory] sdpsh ON sdps.id = sdpsh.ShipmentDestinationPointStatusId\r\n\t\tJOIN [DP].[ShipmentDestinationPoint] sdp ON sdp.Id = sdpsh.ShipmentDestinationPointId\r\n\t\tJOIN [DP].[ShipmentDestinationPointDispatchRequest] sdpdr ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tJOIN [DP].[DispatchRequest] dr ON dr.Id = sdpdr.DispatchRequestId\r\n\r\nWHERE \r\n      sdp.OperationTypeId=@OperationTypeId and \r\n      dr.ParcelReferenceCode in (select id from @ParcelReferenceCode)\r\n"},{"Name":"Get_SubmittedDispatchRequest","Schema":"dbo","Definition":"-- Stored Procedure\r\n\r\n/*\r\ndeclare @result nvarchar(max)=\u0027\u0027\r\nexec [Get_SubmittedDispatchRequest_TEST] @OperationStaffId=42 ,@PageIndex=0,@PageSize=10,@result=@result OUTPUT\r\nSELECT @Result\r\n\r\ndeclare @result nvarchar(max)=\u0027\u0027\r\nexec [Get_SubmittedDispatchRequest] @OperationStaffId=42 ,@PageIndex=0,@PageSize=10,@result=@result OUTPUT\r\nSELECT @Result\r\n*/\r\nCREATE   PROCEDURE [dbo].[Get_SubmittedDispatchRequest]\r\n\t@OperationStaffId\t\tINT\t\t\t\t\t\t\t,\r\n\t@CityId\t\t\t\t\tSMALLINT\t\t=\tNULL\t,\r\n\t@PolygonIds\t\t\t\tNVARCHAR(MAX)\t=\tNULL\t,\r\n\t@StoreId\t\t\t\tINT\t\t\t\t=\tNULL\t,\r\n\t@ParcelReferenceCode\tBIGINT\t\t\t=\tNULL\t,\r\n\t@CourierRequestTypeIds\tNVARCHAR(MAX)\t=\tNULL\t,\r\n\r\n\t@PageIndex\t\t\t\tINT\t\t\t\t\t\t\t,\r\n\t@PageSize\t\t\t\tINT\t\t\t\t\t\t\t,\r\n\t@Result\t\t\t\t\tNVARCHAR(MAX)\tOUTPUT\r\nWITH RECOMPILE\r\nAS\r\n\r\n\t--@PolygonIds\r\n\tDECLARE @PolygonId\tTABLE \r\n\t(\r\n\t\tId\tTINYINT\r\n\t)\r\n\tINSERT INTO @PolygonId\r\n\tSELECT *\r\n\tFROM OPENJSON(@PolygonIds)\r\n\tWITH \r\n\t(\r\n\t\tId TINYINT \u0027$\u0027\r\n\t)\r\n\r\n\t--@CourierRequestTypeIds\r\n\tDECLARE @CourierRequestTypeId\tTABLE \r\n\t(\r\n\t\tId\tTINYINT\r\n\t)\r\n\tINSERT INTO @CourierRequestTypeId\r\n\tSELECT *\r\n\tFROM OPENJSON(@CourierRequestTypeIds)\r\n\tWITH \r\n\t(\r\n\t\tId TINYINT \u0027$\u0027\r\n\t)\r\n\r\n\tDECLARE @TotalCount int=0\r\n\tSELECT\t@TotalCount=COUNT(DISTINCT dr.ParcelReferenceCode)\r\n\tFROM dp.DispatchRequest(NOLOCK)\tdr\r\n\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs\t\t\t\tON dr.DispatchRequestStatusId=drs.Id\r\n\tINNER JOIN dp.PolygonStore(NOLOCK) ps\t\t\t\t\t\tON ps.Id=dr.PolygonStoreId\r\n\tINNER JOIN dp.Polygon(NOLOCK) dp\t\t\t\t\t\t\tON dp.Id=ps.PolygonId\r\n\tINNER JOIN dp.PolygonOperationStaff(NOLOCK) pos\t\t\t\tON pos.PolygonId=dp.Id\r\n\tWHERE dr.DispatchRequestStatusId=5--submitted\r\n\tAND (pos.OperationStaffId=@OperationStaffId)\r\n\tAND((dp.Id=@CityId\t\t\t\t\t\t\t\t\t) OR @CityId\t\t\t\t\tIS NULL\t)\r\n\tAND((ps.StoreId=@StoreId\t\t\t\t\t\t\t) OR @StoreId\t\t\t\t\tIS NULL\t)\r\n\tAND((dr.ParcelReferenceCode=@ParcelReferenceCode\t) OR @ParcelReferenceCode\t\tIS NULL\t)\r\n\tAND (dp.Id IN (SELECT Id FROM @PolygonId) OR (@PolygonIds IS NULL))\r\n\tAND (dr.CourierRequestTypeId IN (SELECT Id FROM @CourierRequestTypeId) OR (@CourierRequestTypeIds IS NULL))\r\n\r\n\r\n\tSET @Result=\r\n\t(\r\n\t\tSELECT\tTOP 1 @TotalCount count,\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tDISTINCT\r\n\t\t\t\t\t\tdr.Id\t\t\t\t\t\tdispatchRequestId,\r\n\t\t\t\t\t\tdr.DispatchRequestStatusId\tstatusId,\r\n\t\t\t\t\t\tdrs.Title\t\t\t\t\tstatusTitle,\r\n\t\t\t\t\t\tdr.parcelReferenceCode,\r\n\t\t\t\t\t\tdr.CourierRequestTypeId\t\tcourierRequestType,\r\n\t\t\t\t\t\tdp.CityId,\r\n\t\t\t\t\t\tdp.Id\t\t\t\t\t\tpolygonId,\r\n\t\t\t\t\t\tdp.Title\t\t\t\t\tpolygonTitle,\r\n\t\t\t\t\t\tps.StoreId,\r\n\t\t\t\t\t\tdr.DeliveryStartTimePersian,\r\n\t\t\t\t\t\tdr.DeliveryDeadLineTimePersian\r\n\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK)\tdr\r\n\t\t\t\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs\t\t\t\tON dr.DispatchRequestStatusId=drs.Id\r\n\t\t\t\t\tINNER JOIN dp.PolygonStore(NOLOCK) ps\t\t\t\t\t\tON ps.Id=dr.PolygonStoreId\r\n\t\t\t\t\tINNER JOIN dp.Polygon(NOLOCK) dp\t\t\t\t\t\t\tON dp.Id=ps.PolygonId\r\n\t\t\t\t\tINNER JOIN dp.PolygonOperationStaff(NOLOCK) pos\t\t\t\tON pos.PolygonId=dp.Id\r\n\t\t\t\t\tWHERE dr.DispatchRequestStatusId=5--submitted\r\n\t\t\t\t\tAND (pos.OperationStaffId=@OperationStaffId)\r\n\t\t\t\t\tAND((dp.Id=@CityId\t\t\t\t\t\t\t\t\t) OR @CityId\t\t\t\t\tIS NULL\t)\r\n\t\t\t\t\tAND((ps.StoreId=@StoreId\t\t\t\t\t\t\t) OR @StoreId\t\t\t\t\tIS NULL\t)\r\n\t\t\t\t\tAND((dr.ParcelReferenceCode=@ParcelReferenceCode\t) OR @ParcelReferenceCode\t\tIS NULL\t)\r\n\t\t\t\t\tAND (dp.Id IN (SELECT Id FROM @PolygonId) OR (@PolygonIds IS NULL))\r\n\t\t\t\t\tAND (dr.CourierRequestTypeId IN (SELECT Id FROM @CourierRequestTypeId) OR (@CourierRequestTypeIds IS NULL))\r\n\t\t\t\t\tORDER BY dr.Id\r\n\t\t\t\t\tOFFSET (@pageIndex * @pageSize) ROWS \r\n\t\t\t\t\tFETCH NEXT @pageSize ROWS ONLY\r\n\r\n\t\t\t\t\tFOR JSON PATH\r\n\r\n\t\t\t\t) DispatchRequests\r\n\r\n\r\n\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t)\r\n\r\n\t--IF @TotalCount=0 \r\n\t--BEGIN\r\n\t--\tSET @Result=\u0027{\u0022count\u0022:0}\u0027\r\n\t--\tRETURN\r\n\t--END\r\n\t--ELSE\r\n\t--BEGIN\r\n\t--\tSET @Result=REPLACE(REPLACE(@Result,\u0027[{\u0022count\u0022\u0027,\u0027{\u0022count\u0022\u0027),\u0027}]}]\u0027,\u0027}]}\u0027)\r\n\t--\tSET @Result = JSON_MODIFY(@Result,\u0027$.totalCount\u0027 ,@TotalCount)\r\n\t--\tSET @Result = JSON_MODIFY(@Result,\u0027$.pageSize\u0027   ,@PageSize  )\r\n\t--\tSET @Result = JSON_MODIFY(@Result,\u0027$.currentPage\u0027,@PageIndex )\r\n\t--\tSET @Result = JSON_MODIFY(@Result,\u0027$.totalPages\u0027,(@TotalCount \u002B @PageSize - 1) / @PageSize)\r\n\t--END\r\n\r\n\r\n"},{"Name":"Get_TotalCurrentInfo_For_Driver","Schema":"dbo","Definition":"/*\r\n\r\nDECLARE @Result\t\tNVARCHAR(MAX) \r\nEXEC [dbo].[Get_TotalCurrentInfo_For_Driver] @FleetId = 6161, @Result = @Result OUTPUT\r\nSELECT @Result\r\n\r\n*/\r\n\r\nCREATE   PROCEDURE [dbo].[Get_TotalCurrentInfo_For_Driver]\r\n\t@FleetId\tBIGINT ,\r\n\t@Result\t\tNVARCHAR(MAX)  OUTPUT\r\nAS\r\n\r\n--DECLARE @AutomaticConfirmFirstNotPickupMinutes INT,\r\n--\t\t@AutomaticConfirmNotPickupMinutes INT\r\n\r\n--SELECT @AutomaticConfirmFirstNotPickupMinutes = Value FROM CS_Public.HAF.Setting WHERE NAME = \u0027DispatchRequestSettings.AutomaticConfirmFirstNotPickupMinutes\u0027\r\n--SELECT @AutomaticConfirmNotPickupMinutes = Value FROM CS_Public.HAF.Setting WHERE NAME = \u0027DispatchRequestSettings.AutomaticConfirmNotPickupMinutes\u0027\r\n\r\n--SET @AutomaticConfirmFirstNotPickupMinutes = ISNULL(@AutomaticConfirmFirstNotPickupMinutes,0)\r\n--SET @AutomaticConfirmNotPickupMinutes = ISNULL(@AutomaticConfirmNotPickupMinutes,0)\r\n\r\nDROP TABLE IF EXISTS #CTE_Fleet,#CTE_ShipmentDestinationPoint\r\n\r\n\r\n\tSELECT \r\n\t\tf.Id ,\r\n\t\tf.DriverId,\t\t \r\n\t\tv.VehicleTypeId, \r\n\t\tv.PlateNumber,\t \r\n\t\tCASE WHEN d.EmploymentTypeId = 1 THEN 0 \r\n\t\t\t WHEN d.EmploymentTypeId = 2 THEN 1 END AS IsAllowToViewShift ,\r\n\t\tfs.Id\t\t\t StatusId,\r\n\t\tfs.Title\t\t StatusTitle,\r\n\t\td.CustomerId\t CustomerId,\r\n\t\td.GradeId\r\n\tINTO #CTE_Fleet\r\n\tFROM CS_DriverManagement.DM.Fleet f (NOLOCK)\r\n\tINNER JOIN CS_DriverManagement.DM.Vehicle v (NOLOCK)\r\n\t\tON f.VehicleId=v.Id\r\n\tINNER JOIN CS_DriverManagement.DM.FleetStatus fs (NOLOCK)\r\n\t\tON fs.Id=f.FleetStatusId\r\n\tJOIN CS_DriverManagement.DM.Driver AS d (NOLOCK)\r\n\t\tON d.Id = f.DriverId\r\n\tWHERE f.Id = @FleetId\r\n\r\n\tSELECT \r\n\t\t* \r\n\tINTO #CTE_ShipmentDestinationPoint\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tsdp.ID ShipmentDestinationPointID,\r\n\t\t\tdr.DispatchRequestStatusId,\r\n\t\t\tdr.Id,\r\n\t\t\tdr.UpdateDate,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdp.OperationTypeId,\r\n\t\t\tdr.DispatchRequestStatusId AS StatusId,\r\n\t\t\tdrs.Title AS StatusTitle,\r\n\t\t\tJSON_QUERY(ISNULL((\r\n\t\t\t\tSELECT sdp.Location.STY  AS  Latitude,sdp.Location.STX  AS Longitude\r\n\t\t\t\tFROM dp.ShipmentDestinationPoint sdp1 (NOLOCK)\r\n\t\t\t\tWHERE sdp1.Id=sdp.Id\r\n\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t),\u0027\u0027))Location,\r\n\t\t\tsdp.IsVendorLocation,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tsdp.DisplacementMeter,\r\n\t\t\tsdp.DistanceMeter,\r\n\t\t\tsdp.EstimatedDurationSeconds,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime AS EstimatedArrivalTimeStr,\r\n\t\t\tsdp.CreateDatePersian AS CreateDatePersianStr,\r\n\t\t\tsdp.FleetPayableCost,\r\n\r\n\t\t\tdr.ParcelReferenceCode,\r\n\t\t\tdr.CourierRequestTypeId,\r\n\t\t\tdr.VendorId,\r\n\t\t\t--dr.CourierRequestTypeTitle,\r\n\t\t\tp.CityId,\r\n\t\t\t--dr.CityTitle,\r\n\t\t\tps.PolygonId,\r\n\t\t\tp.Title AS PolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN dr.CourierRequestTypeId IN ( 26,30,35,51 )\r\n\t\t\t\t\tTHEN 0\r\n\t\t\t\tELSE\r\n\t\t\t\t\t1\r\n\t\t\tEND AS IsStorePickupPoint,\r\n\t\t\ts.Location StoreLocation,\r\n\t\t\ts.Title AS StoreTitle,\r\n\t\t\ts.Address AS StoreAddress,\r\n\t\t\ts.ResponsibleName,\r\n\t\t\ts.ResponsibleMobile,\r\n\t\t\tdr.DeliveryStartTime,\r\n\t\t\tdr.DeliveryStartTimePersian,\r\n\t\t\tdr.DeliveryDeadLineTime,\r\n\t\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\t\t--CASE WHEN dr.Plaque IS NOT NULL AND dr.Floor IS NOT NULL AND dr.Unit IS NOT NULL THEN dr.ClientAddress \u002B N\u0027 \u067E\u0644\u0627\u06A9 \u0027 \u002B dr.Plaque \u002B N\u0027 \u0637\u0628\u0642\u0647 \u0027 \u002B dr.Floor \u002B N\u0027 \u0648\u0627\u062D\u062F \u0027\u002Bdr.Unit\r\n\t\t\t--else\r\n\t\t\t--CASE WHEN dr.Plaque IS NOT NULL AND dr.Floor IS NOT NULL AND dr.Unit IS NULL THEN dr.ClientAddress \u002B N\u0027 \u067E\u0644\u0627\u06A9 \u0027 \u002B dr.Plaque \u002B N\u0027 \u0637\u0628\u0642\u0647 \u0027 \u002B dr.Floor\r\n\t\t\t--ELSE\r\n\t\t\t--CASE WHEN dr.Plaque IS NOT NULL AND dr.Floor IS NULL AND dr.Unit IS NOT NULL THEN dr.ClientAddress \u002B N\u0027 \u067E\u0644\u0627\u06A9 \u0027 \u002B dr.Plaque \u002B  N\u0027 \u0648\u0627\u062D\u062F \u0027\u002Bdr.Unit\r\n\t\t\t--ELSE \r\n\t\t\t--CASE WHEN dr.Plaque IS NULL AND dr.Floor IS NOT NULL AND dr.Unit IS NOT NULL THEN dr.ClientAddress \u002B N\u0027 \u0637\u0628\u0642\u0647 \u0027 \u002B dr.Floor \u002B N\u0027 \u0648\u0627\u062D\u062F \u0027\u002Bdr.Unit\r\n\t\t\t--ELSE\r\n\t\t\t--CASE WHEN dr.Plaque IS NULL AND dr.Floor IS NULL AND dr.Unit IS NOT NULL THEN dr.ClientAddress \u002B  N\u0027 \u0648\u0627\u062D\u062F \u0027\u002Bdr.Unit\r\n\t\t\t--ELSE\r\n\t\t\t--CASE WHEN dr.Plaque IS NULL AND dr.Floor IS not NULL AND dr.Unit IS NULL THEN dr.ClientAddress \u002B N\u0027 \u0637\u0628\u0642\u0647 \u0027 \u002B dr.Floor \r\n\t\t\t--ELSE\r\n\t\t\t--CASE WHEN dr.Plaque IS NOT NULL AND dr.Floor IS NULL AND dr.Unit IS NULL THEN dr.ClientAddress \u002B N\u0027 \u067E\u0644\u0627\u06A9 \u0027 \u002B dr.Plaque \r\n\t\t\t--else\r\n\t\t\t--CASE WHEN dr.Plaque IS NULL AND dr.Floor IS NULL AND dr.Unit IS NULL THEN dr.ClientAddress \r\n\r\n\t\t\t--end\r\n\t\t\t--END\r\n\t\t\t--END\r\n\t\t\t--end\r\n\t\t\t--end\r\n\t\t\t--END\r\n\t\t\t--END\r\n\t\t\t--END AS ClientAddress,\r\n\r\n\t\t\tdr.ClientAddress \u002B ISNULL(N\u0027 \u067E\u0644\u0627\u06A9 \u0027 \u002B dr.Plaque,\u0027\u0027) \u002B ISNULL(N\u0027 \u0637\u0628\u0642\u0647 \u0027 \u002B dr.Floor,\u0027\u0027) \u002B ISNULL(N\u0027 \u0648\u0627\u062D\u062F \u0027 \u002B dr.Unit,\u0027\u0027)  AS ClientAddress,\r\n\r\n\t\t\tdr.ClientLocation,\r\n\t\t\tdr.VendorParcelCode,\r\n\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\tdr.IsNightly,\r\n\t\t\tdr.IsWaitingForSupport ,\r\n\t\t\tdr.DeliveryCode,\r\n\t\t\tsi.ShipmentStatusId,\r\n\t\t\tss.Title AS ShipmentStatusTitle,\r\n\t\t\tsi.ShipmentNumber,\r\n\r\n\t\t\tsdps.ID AS ShipmentDestinationPoint_StatusId,\r\n\t\t\tsdps.Title AS ShipmentDestinationPoint_StatusTitle,\r\n\t\t\tFIRST_VALUE(CASE WHEN sdp.OperationTypeId = 10 AND sdp.ShipmentDestinationPointStatusId = 40 THEN 1 ELSE 0 END) OVER ( PARTITION BY sdp.ShipmentID, dr.ID ORDER BY CASE WHEN sdp.OperationTypeId = 10 AND sdp.ShipmentDestinationPointStatusId = 40 THEN 1 ELSE 0 END DESC) IsReassignedDispatch,\r\n\t\t\tFIRST_VALUE(sdp.ShipmentId) OVER ( PARTITION BY dr.ID ORDER BY si.CreateDATE ASC ) FSH,\r\n\t\t\tFIRST_VALUE(sdp2.ShipmentId) OVER ( PARTITION BY dr.ID ORDER BY s2.CreateDATE DESC ) LSH\r\n\t\tFROM dp.Shipment si (NOLOCK)\r\n\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\tON si.ID = sdp.ShipmentId\r\n\t\tLEFT JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\tLEFT JOIN dp.DispatchRequest dr (NOLOCK)\r\n\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\t\tAND dr.Version = sdpdr.Version\r\n\t\tLEFT JOIN DP.DispatchRequestStatus AS drs (NOLOCK)\r\n\t\t\tON drs.Id = dr.DispatchRequestStatusId\r\n\t\tLEFT JOIN dp.PolygonStore ps (NOLOCK)\t\r\n\t\t\tON ps.Id=dr.PolygonStoreId\r\n\t\tLEFT JOIN DP.Store AS s (NOLOCK)\r\n\t\t\tON ps.StoreId = s.Id\r\n\t\tLEFT JOIN dp.Polygon p (NOLOCK)\r\n\t\t\tON p.Id=ps.PolygonId\r\n\t\tINNER JOIN dp.ShipmentDestinationPointStatus sdps (NOLOCK)\r\n\t\t\tON sdp.ShipmentDestinationPointStatusId = sdps.ID\r\n\t\tINNER JOIN dp.ShipmentStatus ss (NOLOCK)\r\n\t\t\tON si.ShipmentStatusId = ss.ID\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK)\r\n\t\t\tON si.FleetId = f.ID\r\n\t\tLEFT JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr2 (NOLOCK)\r\n\t\t\tON sdpdr.DispatchRequestId = sdpdr2.DispatchRequestId\r\n\t\t\tAND sdpdr.ShipmentDestinationPointId \u003C\u003E sdpdr2.ShipmentDestinationPointId\r\n\t\t\tAND sdp.OperationTypeId = 10 AND sdp.ShipmentDestinationPointStatusId = 40\r\n\t\tLEFT JOIN DP.ShipmentDestinationPoint sdp2 (NOLOCK)\r\n\t\t\tON sdpdr2.ShipmentDestinationPointId = sdp2.Id\r\n\t\tLEFT JOIN DP.Shipment s2 (NOLOCK)\r\n\t\t\tON sdp2.ShipmentId = s2.Id\r\n\t\tWHERE f.IsActive = 1\r\n\t\tAND si.FleetId = @FleetId\r\n\t\tAND si.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100/*OutOfOrder*/)\r\n\t\tAND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35 )\r\n\t\tAND (sdp.ShipmentDestinationPointStatusId \u003C\u003E 40 OR (sdp.ShipmentDestinationPointStatusId = 40 AND sdp.OperationTypeId = 10))\r\n\t\tAND \r\n\t\t(\r\n\t\t\t(\r\n\t\t\t\t\tdr.DispatchRequestStatusId NOT IN ( 30,35,40,80,100 )\r\n\t\t\t\tAND \r\n\t\t\t\t(\r\n\t\t\t\t\t\tdr.CourierRequestTypeId \u003C\u003E 51\r\n\t\t\t\t\tOR\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tdr.CourierRequestTypeId = 51 AND dr.DispatchRequestStatusId IN ( 20,25 )\r\n\t\t\t\t\t)\r\n\t\t\t\t)\r\n\t\t\t\tAND sdp.OperationTypeId \u003C\u003E 30\r\n\t\t\t)\r\n\t\t\tOR\r\n\t\t\t\tsdp.OperationTypeId = 30\r\n\t\t)\r\n\t) SQ\r\n\tWHERE (SQ.IsReassignedDispatch = 0) OR (SQ.IsReassignedDispatch = 1 AND SQ.FSH = SQ.LSH)\r\n\tAND SQ.DispatchRequestStatusId \u003C\u003E 6\r\n\tAND SQ.ShipmentDestinationPoint_StatusId \u003C\u003E 40\r\n\r\n;WITH CTE_ShipmentPolygonID AS\r\n(\r\n\r\n\t\tSELECT TOP 1 WITH TIES\r\n\t\t\tsdp1.ShipmentId,\r\n\t\t\tsdp1.ShipmentDestinationPointID AS ShipmentDestinationPointID_ReturnToStore,\r\n\t\t\ts.ID StoreId,\r\n\t\t\ts.Location StoreLocation,\r\n\t\t\ts.Title AS StoreTitle,\r\n\t\t\ts.Address AS StoreAddress \r\n\t\tFROM #CTE_ShipmentDestinationPoint sdp1\r\n\t\tINNER JOIN DP.ShipmentDestinationPoint sdp\r\n\t\t\tON sdp1.ShipmentID = sdp.ShipmentID\r\n\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\tINNER JOIN dp.DispatchRequest dr (NOLOCK)\r\n\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\tINNER JOIN dp.PolygonStore ps (NOLOCK)\t\r\n\t\t\tON ps.Id=dr.PolygonStoreId\r\n\t\tINNER JOIN DP.Store AS s (NOLOCK)\r\n\t\t\tON ps.StoreId = s.Id\r\n\t\tWHERE sdp.OperationTypeId = 5\r\n\t\tAND sdp1.OperationTypeId = 30\r\n\t\tORDER BY ROW_NUMBER() OVER ( PARTITION BY sdp1.ShipmentId ORDER BY sdp.ID DESC )\r\n),CTE_ParcelInvoice AS\r\n(\r\n\tSELECT * \r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tm.ID,\r\n\t\t\tpi.ParcelInvoiceStatusId,\r\n\t\t\tpi.CodAmount,\r\n\t\t\tcr.ConfirmationDate,\r\n\t\t\tROW_NUMBER() OVER ( PARTITION BY parcel.ID , m.ID order by pi.CreateDate DESC , pi.ID DESC ) RowNum\r\n\t\tFROM #CTE_ShipmentDestinationPoint m\r\n\t\tINNER JOIN CS_OrderManagement.OM.Parcel parcel (NOLOCK)\r\n\t\t\tON m.ParcelReferenceCode = parcel.ParcelReferenceCode\r\n\t\tINNER JOIN CS_OrderManagement.OM.ParcelInvoice pi (NOLOCK)\r\n\t\t\tON parcel.ID = pi.ParcelId\r\n\t\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\t\tON parcel.CourierRequestId = cr.Id\r\n\t) SQ\r\n\tWHERE SQ.RowNum = 1\r\n), CTE_PickupPoint AS\r\n(\r\n\tSELECT \r\n\t\tsdp.ID,\r\n\t\tCASE \r\n\t\t\t\tWHEN CourierRequestTypeId = 51 \r\n\t\t\t\t\tTHEN CASE WHEN sdp.OperationTypeId = 25 THEN FIRST_VALUE(sdp.ShipmentDestinationPointID) OVER ( PARTITION BY sdp.ShipmentID, sdp.ID ORDER BY sdp.ShipmentDestinationPointID) ELSE NULL END\r\n\t\t\t\tELSE\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId IN (5,20) THEN FIRST_VALUE(sdp.ShipmentDestinationPointID) OVER ( PARTITION BY sdp.ShipmentID, sdp.ID ORDER BY sdp.ShipmentDestinationPointID) ELSE NULL END\r\n\t\t\tEND AS PickupPointId\r\n\tFROM #CTE_ShipmentDestinationPoint sdp\r\n\tWHERE \r\n\t\t(sdp.CourierRequestTypeId = 51 AND sdp.OperationTypeId = 25)\r\n\tOR\tsdp.OperationTypeId IN (5,20)\r\n), CTE_DeliveryPoint  AS\r\n(\r\n\tSELECT \r\n\t\tsdp.ID,\r\n\t\tCASE \r\n\t\t\tWHEN CourierRequestTypeId IN (40,45,50)\r\n\t\t\tTHEN CASE WHEN sdp.OperationTypeId = 25 THEN FIRST_VALUE(sdp.ShipmentDestinationPointID) OVER ( PARTITION BY sdp.ShipmentID , sdp.ID ORDER BY sdp.ShipmentDestinationPointID) ELSE NULL END\r\n\t\t\tELSE\r\n\t\t\t\tCASE WHEN sdp.OperationTypeId IN (10,15,30) THEN FIRST_VALUE(sdp.ShipmentDestinationPointID) OVER ( PARTITION BY sdp.ShipmentID , sdp.ID ORDER BY sdp.ShipmentDestinationPointID) ELSE NULL END\r\n\t\tEND AS DeliveryPointId\r\n\tFROM #CTE_ShipmentDestinationPoint sdp\r\n\tWHERE \r\n\t\t(sdp.CourierRequestTypeId IN (40,45,50) AND sdp.OperationTypeId = 25)\r\n\tOR\tsdp.OperationTypeId IN (10,15,30)\r\n), CTE_PickupPoint_Data AS\r\n(\r\n\tSELECT \r\n\t\tp.Id,\r\n\t\tp.PickupPointId,\r\n\t\tISNULL(sdp.estimatedDurationSeconds,0) PickupEstimatedDurationSeconds,\r\n\t\tISNULL(sdp.estimatedOperationTimeSeconds,0) PickupEstimatedOperationTimeSeconds,\r\n\t\tFORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027) PickupPointEstimatedArrivalTimeStr,\r\n\t\tsdp.SequenceNumber AS PickupPointSequenceNumber,\r\n\t\tCAST(DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))) AS BIGINT) RemainedToEstimatedTimeSeconds_Pickup\r\n\tFROM CTE_PickupPoint p\r\n\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\tON p.PickupPointId = sdp.ID\r\n), CTE_DeliveryPoint_Data AS\r\n(\r\n\tSELECT \r\n\t\tp.Id,\r\n\t\tp.DeliveryPointId,\r\n\t\tISNULL(sdp.estimatedDurationSeconds,0) DeliveryEstimatedDurationSeconds,\r\n\t\tISNULL(sdp.estimatedOperationTimeSeconds,0) DeliveryEstimatedOperationTimeSeconds,\r\n\t\tFORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027) DeliveryPointEstimatedArrivalTimeStr,\r\n\t\tsdp.SequenceNumber AS DeliveryPointSequenceNumber,\r\n\t\tCAST(DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))) AS BIGINT) RemainedToEstimatedTimeSeconds_Delivery\r\n\tFROM CTE_DeliveryPoint p\r\n\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\tON p.DeliveryPointId = sdp.ID\r\n), CTE_DR AS\r\n(\r\n\t--SELECT \r\n\t--\tId,\r\n\t--\tUpdateDate,\r\n\t--\tShipmentId,\r\n\t--\tStatusId,\r\n\t--\tStatusTitle,\r\n\t--\tParcelReferenceCode,\r\n\t--\tCourierRequestTypeId,\r\n\t--\tOperationTypeId,\r\n\t--\tCityId,\r\n\t--\tPolygonId,\r\n\t--\tPolygonTitle,\r\n\t--\tStoreId,\r\n\t--\tIsStorePickupPoint,\r\n\t--\tStoreLocation,\r\n\t--\tStoreTitle,\r\n\t--\tStoreAddress,\r\n\t--\tResponsibleName,\r\n\t--\tResponsibleMobile,\r\n\t--\tDeliveryStartTime,\r\n\t--\tDeliveryStartTimePersian,\r\n\t--\tDeliveryDeadLineTime,\r\n\t--\tDeliveryDeadLineTimePersian,\r\n\t--\tClientAddress,\r\n\t--\tClientLocation,\r\n\t--\tVendorParcelCode,\r\n\t--\tVendorId,\r\n\t--\tShipmentStatusId,\r\n\t--\tShipmentStatusTitle,\r\n\t--\tShipmentNumber,\r\n\t--\tDispatchRequestStatusId,\r\n\t--\tIsExclusiveDelivery,\r\n\t--\tIsNightly,\r\n\t--\tIsWaitingForSupport,\r\n\t--\tDeliveryCode\r\n\t--FROM\r\n\t--(\r\n\t\tSELECT\r\n\t\t\t\r\n\t\t\tId,\r\n\t\t\tUpdateDate,\r\n\t\t\tShipmentId,\r\n\t\t\tStatusId,\r\n\t\t\tStatusTitle,\r\n\t\t\tParcelReferenceCode,\r\n\t\t\tCourierRequestTypeId,\r\n\t\t\tOperationTypeId,\r\n\t\t\tCityId,\r\n\t\t\tPolygonId,\r\n\t\t\tPolygonTitle,\r\n\t\t\tStoreId,\r\n\t\t\tIsStorePickupPoint,\r\n\t\t\tStoreLocation,\r\n\t\t\tStoreTitle,\r\n\t\t\tStoreAddress,\r\n\t\t\tResponsibleName,\r\n\t\t\tResponsibleMobile,\r\n\t\t\tDeliveryStartTime,\r\n\t\t\tDeliveryStartTimePersian,\r\n\t\t\tDeliveryDeadLineTime,\r\n\t\t\tDeliveryDeadLineTimePersian,\r\n\t\t\tClientAddress,\r\n\t\t\tsdp.ClientLocation,\r\n\t\t\tVendorParcelCode,\r\n\t\t\tVendorId,\r\n\t\t\tShipmentStatusId,\r\n\t\t\tShipmentStatusTitle,\r\n\t\t\tShipmentNumber,\r\n\t\t\tDispatchRequestStatusId,\r\n\t\t\tIsExclusiveDelivery,\r\n\t\t\tIsNightly,\r\n\t\t\tIsWaitingForSupport,\r\n\t\t\tDeliveryCode,\r\n\t\t\tsdp.FleetPayableCost--,\r\n\t\t\t--ROW_NUMBER() OVER ( PARTITION BY sdp.ID ORDER BY sdp.ID ) RowNum\r\n\t\tFROM #CTE_ShipmentDestinationPoint sdp\r\n\t--) SQ\r\n\t--WHERE SQ.RowNum = 1 OR OperationTypeId = 30\r\n), CTE_Final AS\r\n(\r\n\tSELECT \r\n\t\tdr.Id,\r\n\t\tdr.UpdateDate,\r\n\t\tdr.ShipmentId,\r\n\t\tdr.StatusId,\r\n\t\tdr.StatusTitle,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\tdr.OperationTypeId,\r\n\t\tdr.CityId,\r\n\t\tdr.PolygonId,\r\n\t\tdr.PolygonTitle,\r\n\t\tISNULL(dr.StoreId,spid.StoreId)StoreId,\r\n\t\tdr.IsStorePickupPoint,\r\n\t\tCASE WHEN dr.StoreLocation IS NULL THEN spid.StoreLocation ELSE dr.StoreLocation END StoreLocation,\r\n\t\tISNULL(dr.StoreTitle,spid.StoreTitle) StoreTitle,\r\n\t\tISNULL(dr.StoreAddress,spid.StoreAddress) StoreAddress,\r\n\t\tdr.ResponsibleName,\r\n\t\tdr.ResponsibleMobile,\r\n\t\tFORMAT(dr.DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027) DeliveryStartTimeStr,\r\n\t\tFORMAT(dr.DeliveryStartTimePersian,\u0027####/##/## ##:##:##\\.###\u0027) DeliveryStartTimePersianStr,\r\n\t\tFORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) DeliveryDeadLineTimeStr,\r\n\t\tFORMAT(dr.DeliveryDeadLineTimePersian,\u0027####/##/## ##:##:##\\.###\u0027) DeliveryDeadLineTimePersianStr,\r\n\t\tdr.ClientAddress,\r\n\t\tdr.ClientLocation,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.VendorId,\r\n\t\tdr.ShipmentStatusId,\r\n\t\tdr.ShipmentStatusTitle,\r\n\t\tdr.ShipmentNumber,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdr.IsExclusiveDelivery,\r\n\t\tdr.IsNightly,\r\n\t\tdr.IsWaitingForSupport ,\r\n\t\tpi.ParcelInvoiceStatusId,\r\n\t\tpi.CodAmount,\r\n\t\tpi.ConfirmationDate,\r\n\t\tPickupPointId,\r\n\t\tPickupEstimatedDurationSeconds,\r\n\t\tPickupEstimatedOperationTimeSeconds,\r\n\t\tPickupPointEstimatedArrivalTimeStr,\r\n\t\tPickupPointSequenceNumber,\r\n\t\tDeliveryPointId,\r\n\t\tDeliveryEstimatedDurationSeconds,\r\n\t\tDeliveryEstimatedOperationTimeSeconds,\r\n\t\tDeliveryPointEstimatedArrivalTimeStr,\r\n\t\tDeliveryPointSequenceNumber,\r\n\t\tRemainedToEstimatedTimeSeconds_Pickup,\r\n\t\tRemainedToEstimatedTimeSeconds_Delivery,\r\n\t\tShipmentDestinationPointID_ReturnToStore,\r\n\t\tdr.DeliveryCode\r\n\tFROM CTE_DR dr\r\n\tLEFT JOIN CTE_PickupPoint_Data ppd\r\n\t\tON dr.ID = ppd.Id\r\n\tLEFT JOIN CTE_DeliveryPoint_Data dpd\r\n\t\tON dr.ID = dpd.Id\r\n\tLEFT JOIN CTE_ParcelInvoice pi\r\n\t\tON dr.ID = pi.Id\r\n\tLEFT JOIN CTE_ShipmentPolygonID spid\r\n\t\tON dr.ShipmentId = spid.ShipmentId\r\n),CTE_UPA AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tuorh.DispatchRequestId\r\n\tFROM CTE_Final f\r\n\tINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh\r\n\t\tON f.Id = uorh.DispatchRequestId\r\n\t\tAND uorh.FleetId = @FleetId\r\n),CTE_Attribute AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tdrav.DispatchRequestId,\r\n\t\tdraav.DispatchRequestAttributeId AS AttributeId,\r\n\t\tdrav.DispatchRequestAttributeAllowedValueId AS AttributeValueId\r\n\tFROM DP.DispatchRequestAttributeValue drav WITH(NOLOCK)\r\n\tINNER JOIN DP.DispatchRequestAttributeAllowedValue draav\r\n\t\tON drav.DispatchRequestAttributeAllowedValueId = draav.Id\r\n\tINNER JOIN #CTE_ShipmentDestinationPoint sdp\r\n\t\tON drav.DispatchRequestId = sdp.Id\r\n)\r\n\r\nSELECT  @Result = (\r\nSELECT\r\n(\r\n\tSELECT distinct\r\n\t\tcsdp.ShipmentId,\r\n\t\tcsdp.FleetPayableCost AS PickupPayableCost\r\n\tFROM #CTE_ShipmentDestinationPoint csdp\r\n\tWhere csdp.OperationTypeId = 5\r\n\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n)pickupPayableCosts,\r\n(\r\n\tSELECT \r\n\t\tId,\r\n\t\tDriverId,\r\n\t\tVehicleTypeId,\r\n\t\tPlateNumber,\r\n\t\tf.IsAllowToViewShift,\r\n\t\tStatusId,\r\n\t\tStatusTitle,\r\n\t\tCustomerId,\r\n\t\tGradeId\r\n\tFROM #CTE_Fleet f\r\n\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n) Fleet,\r\n(\r\n\tSELECT DISTINCT\r\n\t\t\tsdp.ShipmentDestinationPointID Id,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdp.OperationTypeId,\r\n\t\t\tsdp.ShipmentDestinationPoint_StatusId StatusId,\r\n\t\t\tsdp.ShipmentDestinationPoint_StatusTitle StatusTitle,\r\n\t\t\tsdp.Location,\r\n\t\t\tsdp.IsVendorLocation,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tsdp.DisplacementMeter,\r\n\t\t\tsdp.DistanceMeter,\r\n\t\t\tsdp.EstimatedDurationSeconds,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTimeStr,\r\n\t\t\tsdp.CreateDatePersianStr\r\n\t\t\t--sdp.FleetPayableCost\r\n\tFROM #CTE_ShipmentDestinationPoint sdp\r\n\tFOR JSON PATH\r\n) ShipmentDestinationPoints,\r\n(\r\n\tSELECT DISTINCT\r\n\t\tf.Id,\r\n\t\tf.ShipmentId,\r\n\t\tf.StatusId,\r\n\t\tf.StatusTitle,\r\n\t\tf.ParcelReferenceCode,\r\n\t\t--po.PaymentEstimate,\r\n\t\tf.CourierRequestTypeId,\r\n\t\tf.CityId,\r\n\t\tf.PolygonId,\r\n\t\tf.PolygonTitle,\r\n\t\tf.StoreId,\r\n\t\tf.IsStorePickupPoint,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\t\tSELECT f.StoreLocation.STY  AS  Latitude,f.StoreLocation.STX  AS Longitude\r\n\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t),\u0027\u0027))StoreLocation,\r\n\t\tf.StoreTitle,\r\n\t\tf.StoreAddress,\r\n\t\tf.ResponsibleName,\r\n\t\t\u00270\u0027\u002BCAST(f.ResponsibleMobile AS VARCHAR(MAX)) ResponsibleMobile,\r\n\t\tf.DeliveryStartTimeStr,\r\n\t\tf.DeliveryStartTimePersianStr,\r\n\t\tf.DeliveryDeadLineTimeStr,\r\n\t\tf.DeliveryDeadLineTimePersianStr,\r\n\t\tf.ClientAddress,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\tSELECT ISNULL(f.ClientLocation.STY,0)  AS  Latitude,ISNULL(f.ClientLocation.STX,0)  AS Longitude\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t),\u0027\u0027)) ClientLocation,\r\n\t\tf.VendorParcelCode,\r\n\t\tf.VendorId,\r\n\t\tf.ShipmentStatusId,\r\n\t\tf.ShipmentStatusTitle,\r\n\t\tf.ShipmentNumber,\r\n\t\tf.PickupPointId,\r\n\t\tf.PickupEstimatedDurationSeconds,\r\n\t\tf.PickupEstimatedOperationTimeSeconds,\r\n\t\tf.PickupPointEstimatedArrivalTimeStr,\r\n\t\tf.PickupPointSequenceNumber,\r\n\t\tf.DeliveryPointId,\r\n\t\tf.DeliveryEstimatedDurationSeconds,\r\n\t\tf.DeliveryEstimatedOperationTimeSeconds,\r\n\t\tf.DeliveryPointEstimatedArrivalTimeStr,\r\n\t\tf.DeliveryPointSequenceNumber,\r\n\t\tcsdp.FleetPayableCost AS FleetPickupPayableCost,\r\n\t\tf.RemainedToEstimatedTimeSeconds_Pickup AS RemainedToEstimatedTimeSeconds,\r\n\t\tf.IsExclusiveDelivery,\r\n\t\tf.IsNightly,\r\n\t\tf.ParcelInvoiceStatusId,\r\n\t\tf.CodAmount,\r\n\t\tCAST(CASE WHEN f.ConfirmationDate IS NULL THEN 0 ELSE 1 END AS BIT) AS IsConfirmed,\r\n\t\tf.IsWaitingForSupport ,\r\n\t\t/*CASE \r\n\t\t\tWHEN DATEDIFF(SECOND,GETDATE(),DATEADD(MINUTE,@DRSetting,FORMAT(f.UpdateDate,\u0027####/##/## ##:##:##\\.###\u0027))) \u003C= 0 OR f.UpdateDate IS NULL \r\n\t\t\t\tTHEN 0 \r\n\t\t\tELSE DATEDIFF(SECOND,GETDATE(),DATEADD(MINUTE,@DRSetting,FORMAT(f.UpdateDate,\u0027####/##/## ##:##:##\\.###\u0027))) \r\n\t\tEND*/\r\n\t\tDATEDIFF\r\n\t\t(\r\n\t\t\tSECOND,\r\n\t\t\tGETDATE(),\r\n\t\t\tDATEADD(MINUTE,NotPickupRequestReviewThresholdMinutes,FORMAT(f.UpdateDate,\u0027####/##/## ##:##:##\\.###\u0027))\r\n\t\t) RemainedTimeToAutomaticConfirmSeconds,\r\n\t\tCAST(CASE WHEN f.IsWaitingForSupport = 1 OR upa.DispatchRequestId IS NOT NULL THEN 0 ELSE 1 END AS BIT) AS IsUnsuccessfulPickupAvailable,\r\n        p.ProofOfPickup,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tatt.AttributeId,\r\n\t\t\t\tatt.AttributeValueId\r\n\t\t\tFROM CTE_Attribute att\r\n\t\t\tWHERE f.ID = att.DispatchRequestId\r\n\t\t\tFOR JSON PATH\r\n\t\t) AS Attributes\r\n\tFROM CTE_Final f\r\n    INNER JOIN CS_OrderManagement.OM.Parcel p (NOLOCK)\r\n        ON f.ParcelReferenceCode = p.ParcelReferenceCode\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\tON f.StoreId = stbi.StoreId\r\n\t--JOIN CS_Pricing.PR.PriceOrder AS po ON po.ParcelReferenceCode = f.ParcelReferenceCode AND po.ShipmentNumber = f.ShipmentNumber\r\n\tLEFT JOIN CTE_UPA upa\r\n\t\tON f.id = upa.DispatchRequestId\r\n\tINNER JOIN #CTE_ShipmentDestinationPoint AS csdp ON csdp.ShipmentDestinationPointID = f.DeliveryPointId\r\n\tWHERE f.DispatchRequestStatusId IN ( 5,6,7,10,11,15,16 )\r\n\tORDER BY f.DeliveryPointEstimatedArrivalTimeStr\r\n\tFOR JSON PATH\r\n)PickupDispatchRequests,\r\n(\r\n\tSELECT DISTINCT\r\n\t\tf.Id,\r\n\t\tf.ShipmentId,\r\n\t\tf.StatusId,\r\n\t\tf.StatusTitle,\r\n\t\tf.ParcelReferenceCode,\r\n\t\t--po.PaymentEstimate,\r\n\t\t--(SELECT po2.PaymentEstimate FROM CS_Pricing.PR.PriceOrder AS po2 WHERE po2.ShipmentNumber = f.ShipmentNumber AND po2.OrderStateTypeId = 4) AS PaymentEstimate,\r\n\t\tf.CourierRequestTypeId,\r\n\t\tf.CityId,\r\n\t\tf.PolygonId,\r\n\t\tf.PolygonTitle,\r\n\t\tf.StoreId,\r\n\t\tf.IsStorePickupPoint,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\t\tSELECT f.StoreLocation.STY  AS  Latitude,f.StoreLocation.STX  AS Longitude\r\n\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t),\u0027\u0027))StoreLocation,\r\n\t\tf.StoreTitle,\r\n\t\tf.StoreAddress,\r\n\t\tf.ResponsibleName,\r\n\t\t\u00270\u0027\u002BCAST(f.ResponsibleMobile AS VARCHAR(MAX)) ResponsibleMobile,\r\n\t\tf.DeliveryStartTimeStr,\r\n\t\tf.DeliveryStartTimePersianStr,\r\n\t\tf.DeliveryDeadLineTimeStr,\r\n\t\tf.DeliveryDeadLineTimePersianStr,\r\n\t\tf.ClientAddress,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\tSELECT ISNULL(f.ClientLocation.STY,0)  AS  Latitude,ISNULL(f.ClientLocation.STX,0)  AS Longitude\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t),\u0027\u0027)) ClientLocation,\r\n\t\tf.VendorParcelCode,\r\n\t\tf.VendorId,\r\n\t\tf.ShipmentStatusId,\r\n\t\tf.ShipmentStatusTitle,\r\n\t\tf.ShipmentNumber,\r\n\t\tf.PickupPointId,\r\n\t\tf.PickupEstimatedDurationSeconds,\r\n\t\tf.PickupEstimatedOperationTimeSeconds,\r\n\t\tf.PickupPointEstimatedArrivalTimeStr,\r\n\t\tf.PickupPointSequenceNumber,\r\n\t\tcsdp.FleetPayableCost AS FleetDeliveryPayableCost,\r\n\t\tf.DeliveryPointId,\r\n\t\tf.DeliveryEstimatedDurationSeconds,\r\n\t\tf.DeliveryEstimatedOperationTimeSeconds,\r\n\t\tf.DeliveryPointEstimatedArrivalTimeStr,\r\n\t\tf.DeliveryPointSequenceNumber,\r\n\t\tf.RemainedToEstimatedTimeSeconds_Delivery AS RemainedToEstimatedTimeSeconds,\r\n\t\tf.IsExclusiveDelivery,\r\n\t\tf.IsNightly,\r\n\t\tf.ParcelInvoiceStatusId,\r\n\t\tf.CodAmount,\r\n\t\tCAST(CASE WHEN ISNULL(f.DeliveryCode,0) = 0 THEN 0 ELSE 1 END AS BIT) IsDeliveryCodeRequired,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tatt.AttributeId,\r\n\t\t\t\tatt.AttributeValueId\r\n\t\t\tFROM CTE_Attribute att\r\n\t\t\tWHERE f.ID = att.DispatchRequestId\r\n\t\t\tFOR JSON PATH\r\n\t\t) AS Attributes\r\n\tFROM CTE_Final f\r\n\tJOIN CS_Financial.FN.PriceOrder AS po ON po.ShipmentNumber = f.ShipmentNumber\r\n\tINNER JOIN #CTE_ShipmentDestinationPoint AS csdp ON csdp.ShipmentDestinationPointID = f.DeliveryPointId\r\n\tWHERE f.DispatchRequestStatusId IN (20,25,45,46,47,48,49,50,51,52,53,54) \r\n\tAND f.CourierRequestTypeId IN (5,10,15,40,45,50,60,65,70)\r\n\tORDER BY f.DeliveryPointEstimatedArrivalTimeStr\r\n\tFOR JSON PATH\r\n)DeliveryDispatchRequests,\r\n(\r\n\tSELECT \r\n\t\tId,\r\n\t\tShipmentId,\r\n\t\tStatusId,\r\n\t\tStatusTitle,\r\n\t\tParcelReferenceCode,\r\n\t\t--PaymentEstimate,\r\n\t\tCourierRequestTypeId,\r\n\t\tCityId,\r\n\t\tPolygonId,\r\n\t\tPolygonTitle,\r\n\t\tStoreId,\r\n\t\tIsStorePickupPoint,\r\n\t\tStoreLocation,\r\n\t\tStoreTitle,\r\n\t\tStoreAddress,\r\n\t\tResponsibleName,\r\n\t\tResponsibleMobile,\r\n\t\tDeliveryStartTimeStr,\r\n\t\tDeliveryStartTimePersianStr,\r\n\t\tDeliveryDeadLineTimeStr,\r\n\t\tDeliveryDeadLineTimePersianStr,\r\n\t\tClientAddress,\r\n\t\tClientLocation,\r\n\t\tVendorParcelCode,\r\n\t\tVendorId,\r\n\t\tShipmentStatusId,\r\n\t\tShipmentStatusTitle,\r\n\t\tShipmentNumber,\r\n\t\tPickupPointId,\r\n\t\tPickupEstimatedDurationSeconds,\r\n\t\tPickupEstimatedOperationTimeSeconds,\r\n\t\tPickupPointEstimatedArrivalTimeStr,\r\n\t\tPickupPointSequenceNumber,\r\n\t\tDeliveryPointId,\r\n\t\tDeliveryEstimatedDurationSeconds,\r\n\t\tDeliveryEstimatedOperationTimeSeconds,\r\n\t\tDeliveryPointEstimatedArrivalTimeStr,\r\n\t\tDeliveryPointSequenceNumber,\r\n\t\tRemainedToEstimatedTimeSeconds\t,\r\n\t\tIsExclusiveDelivery,\r\n\t\tIsNightly,\r\n\t\tIsDeliveryCodeRequired,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tatt.AttributeId,\r\n\t\t\t\tatt.AttributeValueId\r\n\t\t\tFROM CTE_Attribute att\r\n\t\t\tWHERE SQ.ID = att.DispatchRequestId\r\n\t\t\tFOR JSON PATH\r\n\t\t) AS Attributes\r\n\tFROM\r\n\t(\r\n\t\tSELECT \tDISTINCT\t\r\n\t\tFIRST_VALUE(CASE WHEN f.DispatchRequestStatusId = 25 THEN 1 ELSE 0 END) OVER ( PARTITION BY f.ShipmentId ORDER BY CASE WHEN f.DispatchRequestStatusId = 25 THEN 1 ELSE 0 END DESC) ShipmentHasReturn,\r\n\t\tf.DispatchRequestStatusId,\r\n\t\tOperationTypeId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ID END Id,\r\n\t\tf.ShipmentId ShipmentId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.StatusId END StatusId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.StatusTitle END StatusTitle,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ParcelReferenceCode END ParcelReferenceCode,\r\n\t\t--CASE WHEN f.OperationTypeID = 30 THEN NULL ELSE (SELECT po2.PaymentEstimate FROM CS_Pricing.PR.PriceOrder AS po2 WHERE po2.ShipmentNumber = f.ShipmentNumber AND po2.OrderStateTypeId = 4) END AS PaymentEstimate,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.CourierRequestTypeId END CourierRequestTypeId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.CityId END CityId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PolygonId END PolygonId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PolygonTitle END PolygonTitle,\r\n\t\tf.StoreId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.IsStorePickupPoint END IsStorePickupPoint,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\t\tSELECT f.StoreLocation.STY  AS  Latitude,f.StoreLocation.STX  AS Longitude\r\n\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t),\u0027\u0027))StoreLocation,\r\n\t\tf.StoreTitle,\r\n\t\tf.StoreAddress,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ResponsibleName END ResponsibleName,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE \u00270\u0027\u002BCAST(f.ResponsibleMobile AS VARCHAR(MAX)) END ResponsibleMobile,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryStartTimeStr END DeliveryStartTimeStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryStartTimePersianStr END DeliveryStartTimePersianStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryDeadLineTimeStr END DeliveryDeadLineTimeStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryDeadLineTimePersianStr END DeliveryDeadLineTimePersianStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ClientAddress END ClientAddress,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\tSELECT ISNULL(f.ClientLocation.STY,0)  AS  Latitude,ISNULL(f.ClientLocation.STX,0)  AS Longitude\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t),\u0027\u0027)) ClientLocation,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.VendorParcelCode END VendorParcelCode,\r\n\t\tf.VendorId VendorId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ShipmentStatusId END ShipmentStatusId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ShipmentStatusTitle END ShipmentStatusTitle,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ShipmentNumber END ShipmentNumber,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PickupPointId END PickupPointId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PickupEstimatedDurationSeconds END PickupEstimatedDurationSeconds,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PickupEstimatedOperationTimeSeconds END PickupEstimatedOperationTimeSeconds,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PickupPointEstimatedArrivalTimeStr END PickupPointEstimatedArrivalTimeStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PickupPointSequenceNumber END PickupPointSequenceNumber,\r\n\t\tCASE WHEN f.OperationTypeId = 30 THEN ShipmentDestinationPointID_ReturnToStore ELSE DeliveryPointId END DeliveryPointId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryEstimatedDurationSeconds END DeliveryEstimatedDurationSeconds,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryEstimatedOperationTimeSeconds END DeliveryEstimatedOperationTimeSeconds,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryPointEstimatedArrivalTimeStr END DeliveryPointEstimatedArrivalTimeStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryPointSequenceNumber END DeliveryPointSequenceNumber,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.RemainedToEstimatedTimeSeconds_Delivery END  AS RemainedToEstimatedTimeSeconds\t,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN CAST(NULL AS BIT) ELSE f.IsExclusiveDelivery END IsExclusiveDelivery,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN CAST(NULL AS BIT) ELSE f.IsNightly END IsNightly,\r\n\t\tCAST(CASE WHEN ISNULL(f.DeliveryCode,0) = 0 THEN 0 ELSE 1 END AS BIT) IsDeliveryCodeRequired\r\n\tFROM CTE_Final f\r\n\r\n\t) SQ\r\n\tWHERE (SQ.DispatchRequestStatusId IN (20,25,45,46,47,48,49,50,51,52,53,54) AND CourierRequestTypeId IN (25,26,30,35,51) AND OperationTypeId \u003C\u003E 30)\r\n\tOR (SQ.ShipmentHasReturn = 0 AND OperationTypeId = 30)\r\n\tORDER BY DeliveryPointEstimatedArrivalTimeStr \r\n\tFOR JSON PATH\r\n)ReturnDispatchRequests\r\n\r\nFOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n)\r\nOPTION (max_grant_percent = 0.001)\r\n\r\n\t--SET @Result=REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(@Result,\u0027\u0022dispatchRequestIds\u0022:[{\u0022dRequestId\u0022:\u0027,\u0027\u0022dispatchRequestIds\u0022:[\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027},{\u0022dRequestId\u0022:\u0027,\u0027,\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027}]}]}]}\u0027,\u0027]}]}]}\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027}]},{\u0022shipmentDestinationPointId\u0022\u0027,\u0027]},{\u0022shipmentDestinationPointId\u0022\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027}]}]},{\u0022shipmentId\u0022\u0027,\u0027]}]},{\u0022shipmentId\u0022\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027\u0022:null\u0027,\u0027\u0022:[]\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027\u0022Shipments\u0022:null\u0027,\u0027\u0022Shipments\u0022:[]\u0027)\r\n\t\r\n\tSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027\u0022:\u0022{\u0022\u0027,\u0027\u0022:{\u0022\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027\u0022:null\u0027,\u0027\u0022:[]\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027}\u0022,\u0027,\u0027},\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027},\u0022ClientLocation\u0022:{\u0027,\u0027}\u0022,\u0022ClientLocation\u0022:{\u0027)\r\n"},{"Name":"Get_TotalCurrentInfo_For_Driver_BACKUP","Schema":"dbo","Definition":"/*\r\n\r\nDECLARE @Result\t\tNVARCHAR(MAX) \r\nEXEC [dbo].[Get_TotalCurrentInfo_For_Driver] @FleetId = 6161, @Result = @Result OUTPUT\r\nSELECT @Result\r\n\r\n*/\r\n\r\nCREATE   PROCEDURE [dbo].[Get_TotalCurrentInfo_For_Driver_BACKUP]\r\n\t@FleetId\tBIGINT ,\r\n\t@Result\t\tNVARCHAR(MAX)  OUTPUT\r\nAS\r\n\r\n--DECLARE @AutomaticConfirmFirstNotPickupMinutes INT,\r\n--\t\t@AutomaticConfirmNotPickupMinutes INT\r\n\r\n--SELECT @AutomaticConfirmFirstNotPickupMinutes = Value FROM CS_Public.HAF.Setting WHERE NAME = \u0027DispatchRequestSettings.AutomaticConfirmFirstNotPickupMinutes\u0027\r\n--SELECT @AutomaticConfirmNotPickupMinutes = Value FROM CS_Public.HAF.Setting WHERE NAME = \u0027DispatchRequestSettings.AutomaticConfirmNotPickupMinutes\u0027\r\n\r\n--SET @AutomaticConfirmFirstNotPickupMinutes = ISNULL(@AutomaticConfirmFirstNotPickupMinutes,0)\r\n--SET @AutomaticConfirmNotPickupMinutes = ISNULL(@AutomaticConfirmNotPickupMinutes,0)\r\n\r\nDROP TABLE IF EXISTS #CTE_Fleet,#CTE_ShipmentDestinationPoint\r\n\r\n\r\n\tSELECT \r\n\t\tf.Id ,\r\n\t\tf.DriverId,\t\t \r\n\t\tv.VehicleTypeId, \r\n\t\tv.PlateNumber,\t \r\n\t\tCASE WHEN d.EmploymentTypeId = 1 THEN 0 \r\n\t\t\t WHEN d.EmploymentTypeId = 2 THEN 1 END AS IsAllowToViewShift ,\r\n\t\tfs.Id\t\t\t StatusId,\r\n\t\tfs.Title\t\t StatusTitle,\r\n\t\td.CustomerId\t CustomerId,\r\n\t\td.GradeId\r\n\tINTO #CTE_Fleet\r\n\tFROM CS_DriverManagement.DM.Fleet f (NOLOCK)\r\n\tINNER JOIN CS_DriverManagement.DM.Vehicle v (NOLOCK)\r\n\t\tON f.VehicleId=v.Id\r\n\tINNER JOIN CS_DriverManagement.DM.FleetStatus fs (NOLOCK)\r\n\t\tON fs.Id=f.FleetStatusId\r\n\tJOIN CS_DriverManagement.DM.Driver AS d (NOLOCK)\r\n\t\tON d.Id = f.DriverId\r\n\tWHERE f.Id = @FleetId\r\n\r\n\tSELECT \r\n\t\t* \r\n\tINTO #CTE_ShipmentDestinationPoint\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tsdp.ID ShipmentDestinationPointID,\r\n\t\t\tdr.DispatchRequestStatusId,\r\n\t\t\tdr.Id,\r\n\t\t\tdr.UpdateDate,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdp.OperationTypeId,\r\n\t\t\tdr.DispatchRequestStatusId AS StatusId,\r\n\t\t\tdrs.Title AS StatusTitle,\r\n\t\t\tJSON_QUERY(ISNULL((\r\n\t\t\t\tSELECT sdp.Location.STY  AS  Latitude,sdp.Location.STX  AS Longitude\r\n\t\t\t\tFROM dp.ShipmentDestinationPoint sdp1 (NOLOCK)\r\n\t\t\t\tWHERE sdp1.Id=sdp.Id\r\n\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t),\u0027\u0027))Location,\r\n\t\t\tsdp.IsVendorLocation,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tsdp.DisplacementMeter,\r\n\t\t\tsdp.DistanceMeter,\r\n\t\t\tsdp.EstimatedDurationSeconds,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime AS EstimatedArrivalTimeStr,\r\n\t\t\tsdp.CreateDatePersian AS CreateDatePersianStr,\r\n\t\t\tsdp.FleetPayableCost,\r\n\r\n\t\t\tdr.ParcelReferenceCode,\r\n\t\t\tdr.CourierRequestTypeId,\r\n\t\t\tdr.VendorId,\r\n\t\t\t--dr.CourierRequestTypeTitle,\r\n\t\t\tp.CityId,\r\n\t\t\t--dr.CityTitle,\r\n\t\t\tps.PolygonId,\r\n\t\t\tp.Title AS PolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN dr.CourierRequestTypeId IN ( 26,30,35,51 )\r\n\t\t\t\t\tTHEN 0\r\n\t\t\t\tELSE\r\n\t\t\t\t\t1\r\n\t\t\tEND AS IsStorePickupPoint,\r\n\t\t\ts.Location StoreLocation,\r\n\t\t\ts.Title AS StoreTitle,\r\n\t\t\ts.Address AS StoreAddress,\r\n\t\t\ts.ResponsibleName,\r\n\t\t\ts.ResponsibleMobile,\r\n\t\t\tdr.DeliveryStartTime,\r\n\t\t\tdr.DeliveryStartTimePersian,\r\n\t\t\tdr.DeliveryDeadLineTime,\r\n\t\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\t\t--CASE WHEN dr.Plaque IS NOT NULL AND dr.Floor IS NOT NULL AND dr.Unit IS NOT NULL THEN dr.ClientAddress \u002B N\u0027 \u067E\u0644\u0627\u06A9 \u0027 \u002B dr.Plaque \u002B N\u0027 \u0637\u0628\u0642\u0647 \u0027 \u002B dr.Floor \u002B N\u0027 \u0648\u0627\u062D\u062F \u0027\u002Bdr.Unit\r\n\t\t\t--else\r\n\t\t\t--CASE WHEN dr.Plaque IS NOT NULL AND dr.Floor IS NOT NULL AND dr.Unit IS NULL THEN dr.ClientAddress \u002B N\u0027 \u067E\u0644\u0627\u06A9 \u0027 \u002B dr.Plaque \u002B N\u0027 \u0637\u0628\u0642\u0647 \u0027 \u002B dr.Floor\r\n\t\t\t--ELSE\r\n\t\t\t--CASE WHEN dr.Plaque IS NOT NULL AND dr.Floor IS NULL AND dr.Unit IS NOT NULL THEN dr.ClientAddress \u002B N\u0027 \u067E\u0644\u0627\u06A9 \u0027 \u002B dr.Plaque \u002B  N\u0027 \u0648\u0627\u062D\u062F \u0027\u002Bdr.Unit\r\n\t\t\t--ELSE \r\n\t\t\t--CASE WHEN dr.Plaque IS NULL AND dr.Floor IS NOT NULL AND dr.Unit IS NOT NULL THEN dr.ClientAddress \u002B N\u0027 \u0637\u0628\u0642\u0647 \u0027 \u002B dr.Floor \u002B N\u0027 \u0648\u0627\u062D\u062F \u0027\u002Bdr.Unit\r\n\t\t\t--ELSE\r\n\t\t\t--CASE WHEN dr.Plaque IS NULL AND dr.Floor IS NULL AND dr.Unit IS NOT NULL THEN dr.ClientAddress \u002B  N\u0027 \u0648\u0627\u062D\u062F \u0027\u002Bdr.Unit\r\n\t\t\t--ELSE\r\n\t\t\t--CASE WHEN dr.Plaque IS NULL AND dr.Floor IS not NULL AND dr.Unit IS NULL THEN dr.ClientAddress \u002B N\u0027 \u0637\u0628\u0642\u0647 \u0027 \u002B dr.Floor \r\n\t\t\t--ELSE\r\n\t\t\t--CASE WHEN dr.Plaque IS NOT NULL AND dr.Floor IS NULL AND dr.Unit IS NULL THEN dr.ClientAddress \u002B N\u0027 \u067E\u0644\u0627\u06A9 \u0027 \u002B dr.Plaque \r\n\t\t\t--else\r\n\t\t\t--CASE WHEN dr.Plaque IS NULL AND dr.Floor IS NULL AND dr.Unit IS NULL THEN dr.ClientAddress \r\n\r\n\t\t\t--end\r\n\t\t\t--END\r\n\t\t\t--END\r\n\t\t\t--end\r\n\t\t\t--end\r\n\t\t\t--END\r\n\t\t\t--END\r\n\t\t\t--END AS ClientAddress,\r\n\r\n\t\t\tdr.ClientAddress \u002B ISNULL(N\u0027 \u067E\u0644\u0627\u06A9 \u0027 \u002B dr.Plaque,\u0027\u0027) \u002B ISNULL(N\u0027 \u0637\u0628\u0642\u0647 \u0027 \u002B dr.Floor,\u0027\u0027) \u002B ISNULL(N\u0027 \u0648\u0627\u062D\u062F \u0027 \u002B dr.Unit,\u0027\u0027)  AS ClientAddress,\r\n\r\n\t\t\tdr.ClientLocation,\r\n\t\t\tdr.VendorParcelCode,\r\n\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\tdr.IsNightly,\r\n\t\t\tdr.IsWaitingForSupport ,\r\n\t\t\tdr.DeliveryCode,\r\n\t\t\tsi.ShipmentStatusId,\r\n\t\t\tss.Title AS ShipmentStatusTitle,\r\n\t\t\tsi.ShipmentNumber,\r\n\r\n\t\t\tsdps.ID AS ShipmentDestinationPoint_StatusId,\r\n\t\t\tsdps.Title AS ShipmentDestinationPoint_StatusTitle,\r\n\t\t\tFIRST_VALUE(CASE WHEN sdp.OperationTypeId = 10 AND sdp.ShipmentDestinationPointStatusId = 40 THEN 1 ELSE 0 END) OVER ( PARTITION BY sdp.ShipmentID, dr.ID ORDER BY CASE WHEN sdp.OperationTypeId = 10 AND sdp.ShipmentDestinationPointStatusId = 40 THEN 1 ELSE 0 END DESC) IsReassignedDispatch,\r\n\t\t\tFIRST_VALUE(sdp.ShipmentId) OVER ( PARTITION BY dr.ID ORDER BY si.CreateDATE ASC ) FSH,\r\n\t\t\tFIRST_VALUE(sdp2.ShipmentId) OVER ( PARTITION BY dr.ID ORDER BY s2.CreateDATE DESC ) LSH\r\n\t\tFROM dp.Shipment si (NOLOCK)\r\n\t\tINNER JOIN dp.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\tON si.ID = sdp.ShipmentId\r\n\t\tLEFT JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\tLEFT JOIN dp.DispatchRequest dr (NOLOCK)\r\n\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\t\tAND dr.Version = sdpdr.Version\r\n\t\tLEFT JOIN DP.DispatchRequestStatus AS drs (NOLOCK)\r\n\t\t\tON drs.Id = dr.DispatchRequestStatusId\r\n\t\tLEFT JOIN dp.PolygonStore ps (NOLOCK)\t\r\n\t\t\tON ps.Id=dr.PolygonStoreId\r\n\t\tLEFT JOIN DP.Store AS s (NOLOCK)\r\n\t\t\tON ps.StoreId = s.Id\r\n\t\tLEFT JOIN dp.Polygon p (NOLOCK)\r\n\t\t\tON p.Id=ps.PolygonId\r\n\t\tINNER JOIN dp.ShipmentDestinationPointStatus sdps (NOLOCK)\r\n\t\t\tON sdp.ShipmentDestinationPointStatusId = sdps.ID\r\n\t\tINNER JOIN dp.ShipmentStatus ss (NOLOCK)\r\n\t\t\tON si.ShipmentStatusId = ss.ID\r\n\t\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK)\r\n\t\t\tON si.FleetId = f.ID\r\n\t\tLEFT JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr2 (NOLOCK)\r\n\t\t\tON sdpdr.DispatchRequestId = sdpdr2.DispatchRequestId\r\n\t\t\tAND sdpdr.ShipmentDestinationPointId \u003C\u003E sdpdr2.ShipmentDestinationPointId\r\n\t\t\tAND sdp.OperationTypeId = 10 AND sdp.ShipmentDestinationPointStatusId = 40\r\n\t\tLEFT JOIN DP.ShipmentDestinationPoint sdp2 (NOLOCK)\r\n\t\t\tON sdpdr2.ShipmentDestinationPointId = sdp2.Id\r\n\t\tLEFT JOIN DP.Shipment s2 (NOLOCK)\r\n\t\t\tON sdp2.ShipmentId = s2.Id\r\n\t\tWHERE f.IsActive = 1\r\n\t\tAND si.FleetId = @FleetId\r\n\t\tAND si.ShipmentStatusId NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100/*OutOfOrder*/)\r\n\t\tAND sdp.ShipmentDestinationPointStatusId NOT IN ( 30,35 )\r\n\t\tAND (sdp.ShipmentDestinationPointStatusId \u003C\u003E 40 OR (sdp.ShipmentDestinationPointStatusId = 40 AND sdp.OperationTypeId = 10))\r\n\t\tAND \r\n\t\t(\r\n\t\t\t(\r\n\t\t\t\t\tdr.DispatchRequestStatusId NOT IN ( 30,35,40,80,100 )\r\n\t\t\t\tAND \r\n\t\t\t\t(\r\n\t\t\t\t\t\tdr.CourierRequestTypeId \u003C\u003E 51\r\n\t\t\t\t\tOR\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tdr.CourierRequestTypeId = 51 AND dr.DispatchRequestStatusId IN ( 20,25 )\r\n\t\t\t\t\t)\r\n\t\t\t\t)\r\n\t\t\t\tAND sdp.OperationTypeId \u003C\u003E 30\r\n\t\t\t)\r\n\t\t\tOR\r\n\t\t\t\tsdp.OperationTypeId = 30\r\n\t\t)\r\n\t) SQ\r\n\tWHERE (SQ.IsReassignedDispatch = 0) OR (SQ.IsReassignedDispatch = 1 AND SQ.FSH = SQ.LSH)\r\n\tAND SQ.DispatchRequestStatusId \u003C\u003E 6\r\n\tAND SQ.ShipmentDestinationPoint_StatusId \u003C\u003E 40\r\n\r\n;WITH CTE_ShipmentPolygonID AS\r\n(\r\n\r\n\t\tSELECT TOP 1 WITH TIES\r\n\t\t\tsdp1.ShipmentId,\r\n\t\t\tsdp1.ShipmentDestinationPointID AS ShipmentDestinationPointID_ReturnToStore,\r\n\t\t\ts.ID StoreId,\r\n\t\t\ts.Location StoreLocation,\r\n\t\t\ts.Title AS StoreTitle,\r\n\t\t\ts.Address AS StoreAddress \r\n\t\tFROM #CTE_ShipmentDestinationPoint sdp1\r\n\t\tINNER JOIN DP.ShipmentDestinationPoint sdp\r\n\t\t\tON sdp1.ShipmentID = sdp.ShipmentID\r\n\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\n\t\tINNER JOIN dp.DispatchRequest dr (NOLOCK)\r\n\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\tINNER JOIN dp.PolygonStore ps (NOLOCK)\t\r\n\t\t\tON ps.Id=dr.PolygonStoreId\r\n\t\tINNER JOIN DP.Store AS s (NOLOCK)\r\n\t\t\tON ps.StoreId = s.Id\r\n\t\tWHERE sdp.OperationTypeId = 5\r\n\t\tAND sdp1.OperationTypeId = 30\r\n\t\tORDER BY ROW_NUMBER() OVER ( PARTITION BY sdp1.ShipmentId ORDER BY sdp.ID DESC )\r\n),CTE_ParcelInvoice AS\r\n(\r\n\tSELECT * \r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tm.ID,\r\n\t\t\tpi.ParcelInvoiceStatusId,\r\n\t\t\tpi.CodAmount,\r\n\t\t\tcr.ConfirmationDate,\r\n\t\t\tROW_NUMBER() OVER ( PARTITION BY parcel.ID , m.ID order by pi.CreateDate DESC , pi.ID DESC ) RowNum\r\n\t\tFROM #CTE_ShipmentDestinationPoint m\r\n\t\tINNER JOIN CS_OrderManagement.OM.Parcel parcel (NOLOCK)\r\n\t\t\tON m.ParcelReferenceCode = parcel.ParcelReferenceCode\r\n\t\tINNER JOIN CS_OrderManagement.OM.ParcelInvoice pi (NOLOCK)\r\n\t\t\tON parcel.ID = pi.ParcelId\r\n\t\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\t\tON parcel.CourierRequestId = cr.Id\r\n\t) SQ\r\n\tWHERE SQ.RowNum = 1\r\n), CTE_PickupPoint AS\r\n(\r\n\tSELECT \r\n\t\tsdp.ID,\r\n\t\tCASE \r\n\t\t\t\tWHEN CourierRequestTypeId = 51 \r\n\t\t\t\t\tTHEN CASE WHEN sdp.OperationTypeId = 25 THEN FIRST_VALUE(sdp.ShipmentDestinationPointID) OVER ( PARTITION BY sdp.ShipmentID, sdp.ID ORDER BY sdp.ShipmentDestinationPointID) ELSE NULL END\r\n\t\t\t\tELSE\r\n\t\t\t\t\tCASE WHEN sdp.OperationTypeId IN (5,20) THEN FIRST_VALUE(sdp.ShipmentDestinationPointID) OVER ( PARTITION BY sdp.ShipmentID, sdp.ID ORDER BY sdp.ShipmentDestinationPointID) ELSE NULL END\r\n\t\t\tEND AS PickupPointId\r\n\tFROM #CTE_ShipmentDestinationPoint sdp\r\n\tWHERE \r\n\t\t(sdp.CourierRequestTypeId = 51 AND sdp.OperationTypeId = 25)\r\n\tOR\tsdp.OperationTypeId IN (5,20)\r\n), CTE_DeliveryPoint  AS\r\n(\r\n\tSELECT \r\n\t\tsdp.ID,\r\n\t\tCASE \r\n\t\t\tWHEN CourierRequestTypeId IN (40,45,50)\r\n\t\t\tTHEN CASE WHEN sdp.OperationTypeId = 25 THEN FIRST_VALUE(sdp.ShipmentDestinationPointID) OVER ( PARTITION BY sdp.ShipmentID , sdp.ID ORDER BY sdp.ShipmentDestinationPointID) ELSE NULL END\r\n\t\t\tELSE\r\n\t\t\t\tCASE WHEN sdp.OperationTypeId IN (10,15,30) THEN FIRST_VALUE(sdp.ShipmentDestinationPointID) OVER ( PARTITION BY sdp.ShipmentID , sdp.ID ORDER BY sdp.ShipmentDestinationPointID) ELSE NULL END\r\n\t\tEND AS DeliveryPointId\r\n\tFROM #CTE_ShipmentDestinationPoint sdp\r\n\tWHERE \r\n\t\t(sdp.CourierRequestTypeId IN (40,45,50) AND sdp.OperationTypeId = 25)\r\n\tOR\tsdp.OperationTypeId IN (10,15,30)\r\n), CTE_PickupPoint_Data AS\r\n(\r\n\tSELECT \r\n\t\tp.Id,\r\n\t\tp.PickupPointId,\r\n\t\tISNULL(sdp.estimatedDurationSeconds,0) PickupEstimatedDurationSeconds,\r\n\t\tISNULL(sdp.estimatedOperationTimeSeconds,0) PickupEstimatedOperationTimeSeconds,\r\n\t\tFORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027) PickupPointEstimatedArrivalTimeStr,\r\n\t\tsdp.SequenceNumber AS PickupPointSequenceNumber,\r\n\t\tCAST(DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))) AS BIGINT) RemainedToEstimatedTimeSeconds_Pickup\r\n\tFROM CTE_PickupPoint p\r\n\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\tON p.PickupPointId = sdp.ID\r\n), CTE_DeliveryPoint_Data AS\r\n(\r\n\tSELECT \r\n\t\tp.Id,\r\n\t\tp.DeliveryPointId,\r\n\t\tISNULL(sdp.estimatedDurationSeconds,0) DeliveryEstimatedDurationSeconds,\r\n\t\tISNULL(sdp.estimatedOperationTimeSeconds,0) DeliveryEstimatedOperationTimeSeconds,\r\n\t\tFORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027) DeliveryPointEstimatedArrivalTimeStr,\r\n\t\tsdp.SequenceNumber AS DeliveryPointSequenceNumber,\r\n\t\tCAST(DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))) AS BIGINT) RemainedToEstimatedTimeSeconds_Delivery\r\n\tFROM CTE_DeliveryPoint p\r\n\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\tON p.DeliveryPointId = sdp.ID\r\n), CTE_DR AS\r\n(\r\n\tSELECT \r\n\t\tId,\r\n\t\tUpdateDate,\r\n\t\tShipmentId,\r\n\t\tStatusId,\r\n\t\tStatusTitle,\r\n\t\tParcelReferenceCode,\r\n\t\tCourierRequestTypeId,\r\n\t\tOperationTypeId,\r\n\t\tCityId,\r\n\t\tPolygonId,\r\n\t\tPolygonTitle,\r\n\t\tStoreId,\r\n\t\tIsStorePickupPoint,\r\n\t\tStoreLocation,\r\n\t\tStoreTitle,\r\n\t\tStoreAddress,\r\n\t\tResponsibleName,\r\n\t\tResponsibleMobile,\r\n\t\tDeliveryStartTime,\r\n\t\tDeliveryStartTimePersian,\r\n\t\tDeliveryDeadLineTime,\r\n\t\tDeliveryDeadLineTimePersian,\r\n\t\tClientAddress,\r\n\t\tClientLocation,\r\n\t\tVendorParcelCode,\r\n\t\tVendorId,\r\n\t\tShipmentStatusId,\r\n\t\tShipmentStatusTitle,\r\n\t\tShipmentNumber,\r\n\t\tDispatchRequestStatusId,\r\n\t\tIsExclusiveDelivery,\r\n\t\tIsNightly,\r\n\t\tIsWaitingForSupport,\r\n\t\tDeliveryCode\r\n\tFROM\r\n\t(\r\n\t\tSELECT\r\n\t\t\t\r\n\t\t\tId,\r\n\t\t\tUpdateDate,\r\n\t\t\tShipmentId,\r\n\t\t\tStatusId,\r\n\t\t\tStatusTitle,\r\n\t\t\tParcelReferenceCode,\r\n\t\t\tCourierRequestTypeId,\r\n\t\t\tOperationTypeId,\r\n\t\t\tCityId,\r\n\t\t\tPolygonId,\r\n\t\t\tPolygonTitle,\r\n\t\t\tStoreId,\r\n\t\t\tIsStorePickupPoint,\r\n\t\t\tStoreLocation,\r\n\t\t\tStoreTitle,\r\n\t\t\tStoreAddress,\r\n\t\t\tResponsibleName,\r\n\t\t\tResponsibleMobile,\r\n\t\t\tDeliveryStartTime,\r\n\t\t\tDeliveryStartTimePersian,\r\n\t\t\tDeliveryDeadLineTime,\r\n\t\t\tDeliveryDeadLineTimePersian,\r\n\t\t\tClientAddress,\r\n\t\t\tsdp.ClientLocation,\r\n\t\t\tVendorParcelCode,\r\n\t\t\tVendorId,\r\n\t\t\tShipmentStatusId,\r\n\t\t\tShipmentStatusTitle,\r\n\t\t\tShipmentNumber,\r\n\t\t\tDispatchRequestStatusId,\r\n\t\t\tIsExclusiveDelivery,\r\n\t\t\tIsNightly,\r\n\t\t\tIsWaitingForSupport,\r\n\t\t\tDeliveryCode,\r\n\t\t\tsdp.FleetPayableCost,\r\n\t\t\tROW_NUMBER() OVER ( PARTITION BY sdp.ID ORDER BY sdp.ID ) RowNum\r\n\t\tFROM #CTE_ShipmentDestinationPoint sdp\r\n\t) SQ\r\n\tWHERE SQ.RowNum = 1 OR OperationTypeId = 30\r\n), CTE_Final AS\r\n(\r\n\tSELECT \r\n\t\tdr.Id,\r\n\t\tdr.UpdateDate,\r\n\t\tdr.ShipmentId,\r\n\t\tdr.StatusId,\r\n\t\tdr.StatusTitle,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\tdr.OperationTypeId,\r\n\t\tdr.CityId,\r\n\t\tdr.PolygonId,\r\n\t\tdr.PolygonTitle,\r\n\t\tISNULL(dr.StoreId,spid.StoreId)StoreId,\r\n\t\tdr.IsStorePickupPoint,\r\n\t\tCASE WHEN dr.StoreLocation IS NULL THEN spid.StoreLocation ELSE dr.StoreLocation END StoreLocation,\r\n\t\tISNULL(dr.StoreTitle,spid.StoreTitle) StoreTitle,\r\n\t\tISNULL(dr.StoreAddress,spid.StoreAddress) StoreAddress,\r\n\t\tdr.ResponsibleName,\r\n\t\tdr.ResponsibleMobile,\r\n\t\tFORMAT(dr.DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027) DeliveryStartTimeStr,\r\n\t\tFORMAT(dr.DeliveryStartTimePersian,\u0027####/##/## ##:##:##\\.###\u0027) DeliveryStartTimePersianStr,\r\n\t\tFORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) DeliveryDeadLineTimeStr,\r\n\t\tFORMAT(dr.DeliveryDeadLineTimePersian,\u0027####/##/## ##:##:##\\.###\u0027) DeliveryDeadLineTimePersianStr,\r\n\t\tdr.ClientAddress,\r\n\t\tdr.ClientLocation,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.VendorId,\r\n\t\tdr.ShipmentStatusId,\r\n\t\tdr.ShipmentStatusTitle,\r\n\t\tdr.ShipmentNumber,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdr.IsExclusiveDelivery,\r\n\t\tdr.IsNightly,\r\n\t\tdr.IsWaitingForSupport ,\r\n\t\tpi.ParcelInvoiceStatusId,\r\n\t\tpi.CodAmount,\r\n\t\tpi.ConfirmationDate,\r\n\t\tPickupPointId,\r\n\t\tPickupEstimatedDurationSeconds,\r\n\t\tPickupEstimatedOperationTimeSeconds,\r\n\t\tPickupPointEstimatedArrivalTimeStr,\r\n\t\tPickupPointSequenceNumber,\r\n\t\tDeliveryPointId,\r\n\t\tDeliveryEstimatedDurationSeconds,\r\n\t\tDeliveryEstimatedOperationTimeSeconds,\r\n\t\tDeliveryPointEstimatedArrivalTimeStr,\r\n\t\tDeliveryPointSequenceNumber,\r\n\t\tRemainedToEstimatedTimeSeconds_Pickup,\r\n\t\tRemainedToEstimatedTimeSeconds_Delivery,\r\n\t\tShipmentDestinationPointID_ReturnToStore,\r\n\t\tdr.DeliveryCode\r\n\tFROM CTE_DR dr\r\n\tLEFT JOIN CTE_PickupPoint_Data ppd\r\n\t\tON dr.ID = ppd.Id\r\n\tLEFT JOIN CTE_DeliveryPoint_Data dpd\r\n\t\tON dr.ID = dpd.Id\r\n\tLEFT JOIN CTE_ParcelInvoice pi\r\n\t\tON dr.ID = pi.Id\r\n\tLEFT JOIN CTE_ShipmentPolygonID spid\r\n\t\tON dr.ShipmentId = spid.ShipmentId\r\n),CTE_UPA AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tuorh.DispatchRequestId\r\n\tFROM CTE_Final f\r\n\tINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh\r\n\t\tON f.Id = uorh.DispatchRequestId\r\n\t\tAND uorh.FleetId = @FleetId\r\n),CTE_Attribute AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tdrav.DispatchRequestId,\r\n\t\tdraav.DispatchRequestAttributeId AS AttributeId,\r\n\t\tdrav.DispatchRequestAttributeAllowedValueId AS AttributeValueId\r\n\tFROM DP.DispatchRequestAttributeValue drav WITH(NOLOCK)\r\n\tINNER JOIN DP.DispatchRequestAttributeAllowedValue draav\r\n\t\tON drav.DispatchRequestAttributeAllowedValueId = draav.Id\r\n\tINNER JOIN #CTE_ShipmentDestinationPoint sdp\r\n\t\tON drav.DispatchRequestId = sdp.Id\r\n)\r\n\r\nSELECT  @Result = (\r\nSELECT\r\n(\r\n\tSELECT distinct\r\n\t\tcsdp.ShipmentId,\r\n\t\tcsdp.FleetPayableCost AS PickupPayableCost\r\n\tFROM #CTE_ShipmentDestinationPoint csdp\r\n\tWhere csdp.OperationTypeId = 5\r\n\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n)pickupPayableCosts,\r\n(\r\n\tSELECT \r\n\t\tId,\r\n\t\tDriverId,\r\n\t\tVehicleTypeId,\r\n\t\tPlateNumber,\r\n\t\tf.IsAllowToViewShift,\r\n\t\tStatusId,\r\n\t\tStatusTitle,\r\n\t\tCustomerId,\r\n\t\tGradeId\r\n\tFROM #CTE_Fleet f\r\n\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n) Fleet,\r\n(\r\n\tSELECT DISTINCT\r\n\t\t\tsdp.ShipmentDestinationPointID Id,\r\n\t\t\tsdp.ShipmentId,\r\n\t\t\tsdp.OperationTypeId,\r\n\t\t\tsdp.ShipmentDestinationPoint_StatusId StatusId,\r\n\t\t\tsdp.ShipmentDestinationPoint_StatusTitle StatusTitle,\r\n\t\t\tsdp.Location,\r\n\t\t\tsdp.IsVendorLocation,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tsdp.DisplacementMeter,\r\n\t\t\tsdp.DistanceMeter,\r\n\t\t\tsdp.EstimatedDurationSeconds,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTimeStr,\r\n\t\t\tsdp.CreateDatePersianStr\r\n\t\t\t--sdp.FleetPayableCost\r\n\tFROM #CTE_ShipmentDestinationPoint sdp\r\n\tFOR JSON PATH\r\n) ShipmentDestinationPoints,\r\n(\r\n\tSELECT DISTINCT\r\n\t\tf.Id,\r\n\t\tf.ShipmentId,\r\n\t\tf.StatusId,\r\n\t\tf.StatusTitle,\r\n\t\tf.ParcelReferenceCode,\r\n\t\t--po.PaymentEstimate,\r\n\t\tf.CourierRequestTypeId,\r\n\t\tf.CityId,\r\n\t\tf.PolygonId,\r\n\t\tf.PolygonTitle,\r\n\t\tf.StoreId,\r\n\t\tf.IsStorePickupPoint,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\t\tSELECT f.StoreLocation.STY  AS  Latitude,f.StoreLocation.STX  AS Longitude\r\n\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t),\u0027\u0027))StoreLocation,\r\n\t\tf.StoreTitle,\r\n\t\tf.StoreAddress,\r\n\t\tf.ResponsibleName,\r\n\t\t\u00270\u0027\u002BCAST(f.ResponsibleMobile AS VARCHAR(MAX)) ResponsibleMobile,\r\n\t\tf.DeliveryStartTimeStr,\r\n\t\tf.DeliveryStartTimePersianStr,\r\n\t\tf.DeliveryDeadLineTimeStr,\r\n\t\tf.DeliveryDeadLineTimePersianStr,\r\n\t\tf.ClientAddress,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\tSELECT ISNULL(f.ClientLocation.STY,0)  AS  Latitude,ISNULL(f.ClientLocation.STX,0)  AS Longitude\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t),\u0027\u0027)) ClientLocation,\r\n\t\tf.VendorParcelCode,\r\n\t\tf.VendorId,\r\n\t\tf.ShipmentStatusId,\r\n\t\tf.ShipmentStatusTitle,\r\n\t\tf.ShipmentNumber,\r\n\t\tf.PickupPointId,\r\n\t\tf.PickupEstimatedDurationSeconds,\r\n\t\tf.PickupEstimatedOperationTimeSeconds,\r\n\t\tf.PickupPointEstimatedArrivalTimeStr,\r\n\t\tf.PickupPointSequenceNumber,\r\n\t\tf.DeliveryPointId,\r\n\t\tf.DeliveryEstimatedDurationSeconds,\r\n\t\tf.DeliveryEstimatedOperationTimeSeconds,\r\n\t\tf.DeliveryPointEstimatedArrivalTimeStr,\r\n\t\tf.DeliveryPointSequenceNumber,\r\n\t\tcsdp.FleetPayableCost AS FleetPickupPayableCost,\r\n\t\tf.RemainedToEstimatedTimeSeconds_Pickup AS RemainedToEstimatedTimeSeconds,\r\n\t\tf.IsExclusiveDelivery,\r\n\t\tf.IsNightly,\r\n\t\tf.ParcelInvoiceStatusId,\r\n\t\tf.CodAmount,\r\n\t\tCAST(CASE WHEN f.ConfirmationDate IS NULL THEN 0 ELSE 1 END AS BIT) AS IsConfirmed,\r\n\t\tf.IsWaitingForSupport ,\r\n\t\t/*CASE \r\n\t\t\tWHEN DATEDIFF(SECOND,GETDATE(),DATEADD(MINUTE,@DRSetting,FORMAT(f.UpdateDate,\u0027####/##/## ##:##:##\\.###\u0027))) \u003C= 0 OR f.UpdateDate IS NULL \r\n\t\t\t\tTHEN 0 \r\n\t\t\tELSE DATEDIFF(SECOND,GETDATE(),DATEADD(MINUTE,@DRSetting,FORMAT(f.UpdateDate,\u0027####/##/## ##:##:##\\.###\u0027))) \r\n\t\tEND*/\r\n\t\tDATEDIFF\r\n\t\t(\r\n\t\t\tSECOND,\r\n\t\t\tGETDATE(),\r\n\t\t\tDATEADD(MINUTE,NotPickupRequestReviewThresholdMinutes,FORMAT(f.UpdateDate,\u0027####/##/## ##:##:##\\.###\u0027))\r\n\t\t) RemainedTimeToAutomaticConfirmSeconds,\r\n\t\tCAST(CASE WHEN f.IsWaitingForSupport = 1 OR upa.DispatchRequestId IS NOT NULL THEN 0 ELSE 1 END AS BIT) AS IsUnsuccessfulPickupAvailable,\r\n        p.ProofOfPickup,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tatt.AttributeId,\r\n\t\t\t\tatt.AttributeValueId\r\n\t\t\tFROM CTE_Attribute att\r\n\t\t\tWHERE f.ID = att.DispatchRequestId\r\n\t\t\tFOR JSON PATH\r\n\t\t) AS Attributes\r\n\tFROM CTE_Final f\r\n    INNER JOIN CS_OrderManagement.OM.Parcel p (NOLOCK)\r\n        ON f.ParcelReferenceCode = p.ParcelReferenceCode\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\tON f.StoreId = stbi.StoreId\r\n\t--JOIN CS_Pricing.PR.PriceOrder AS po ON po.ParcelReferenceCode = f.ParcelReferenceCode AND po.ShipmentNumber = f.ShipmentNumber\r\n\tLEFT JOIN CTE_UPA upa\r\n\t\tON f.id = upa.DispatchRequestId\r\n\tINNER JOIN #CTE_ShipmentDestinationPoint AS csdp ON csdp.ShipmentDestinationPointID = f.DeliveryPointId\r\n\tWHERE f.DispatchRequestStatusId IN ( 5,6,7,10,11,15,16 )\r\n\tORDER BY f.DeliveryPointEstimatedArrivalTimeStr\r\n\tFOR JSON PATH\r\n)PickupDispatchRequests,\r\n(\r\n\tSELECT DISTINCT\r\n\t\tf.Id,\r\n\t\tf.ShipmentId,\r\n\t\tf.StatusId,\r\n\t\tf.StatusTitle,\r\n\t\tf.ParcelReferenceCode,\r\n\t\t--po.PaymentEstimate,\r\n\t\t--(SELECT po2.PaymentEstimate FROM CS_Pricing.PR.PriceOrder AS po2 WHERE po2.ShipmentNumber = f.ShipmentNumber AND po2.OrderStateTypeId = 4) AS PaymentEstimate,\r\n\t\tf.CourierRequestTypeId,\r\n\t\tf.CityId,\r\n\t\tf.PolygonId,\r\n\t\tf.PolygonTitle,\r\n\t\tf.StoreId,\r\n\t\tf.IsStorePickupPoint,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\t\tSELECT f.StoreLocation.STY  AS  Latitude,f.StoreLocation.STX  AS Longitude\r\n\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t),\u0027\u0027))StoreLocation,\r\n\t\tf.StoreTitle,\r\n\t\tf.StoreAddress,\r\n\t\tf.ResponsibleName,\r\n\t\t\u00270\u0027\u002BCAST(f.ResponsibleMobile AS VARCHAR(MAX)) ResponsibleMobile,\r\n\t\tf.DeliveryStartTimeStr,\r\n\t\tf.DeliveryStartTimePersianStr,\r\n\t\tf.DeliveryDeadLineTimeStr,\r\n\t\tf.DeliveryDeadLineTimePersianStr,\r\n\t\tf.ClientAddress,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\tSELECT ISNULL(f.ClientLocation.STY,0)  AS  Latitude,ISNULL(f.ClientLocation.STX,0)  AS Longitude\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t),\u0027\u0027)) ClientLocation,\r\n\t\tf.VendorParcelCode,\r\n\t\tf.VendorId,\r\n\t\tf.ShipmentStatusId,\r\n\t\tf.ShipmentStatusTitle,\r\n\t\tf.ShipmentNumber,\r\n\t\tf.PickupPointId,\r\n\t\tf.PickupEstimatedDurationSeconds,\r\n\t\tf.PickupEstimatedOperationTimeSeconds,\r\n\t\tf.PickupPointEstimatedArrivalTimeStr,\r\n\t\tf.PickupPointSequenceNumber,\r\n\t\tcsdp.FleetPayableCost AS FleetDeliveryPayableCost,\r\n\t\tf.DeliveryPointId,\r\n\t\tf.DeliveryEstimatedDurationSeconds,\r\n\t\tf.DeliveryEstimatedOperationTimeSeconds,\r\n\t\tf.DeliveryPointEstimatedArrivalTimeStr,\r\n\t\tf.DeliveryPointSequenceNumber,\r\n\t\tf.RemainedToEstimatedTimeSeconds_Delivery AS RemainedToEstimatedTimeSeconds,\r\n\t\tf.IsExclusiveDelivery,\r\n\t\tf.IsNightly,\r\n\t\tf.ParcelInvoiceStatusId,\r\n\t\tf.CodAmount,\r\n\t\tCAST(CASE WHEN ISNULL(f.DeliveryCode,0) = 0 THEN 0 ELSE 1 END AS BIT) IsDeliveryCodeRequired,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tatt.AttributeId,\r\n\t\t\t\tatt.AttributeValueId\r\n\t\t\tFROM CTE_Attribute att\r\n\t\t\tWHERE f.ID = att.DispatchRequestId\r\n\t\t\tFOR JSON PATH\r\n\t\t) AS Attributes\r\n\tFROM CTE_Final f\r\n\tJOIN CS_Pricing.PR.PriceOrder AS po ON po.ShipmentNumber = f.ShipmentNumber\r\n\tINNER JOIN #CTE_ShipmentDestinationPoint AS csdp ON csdp.ShipmentDestinationPointID = f.DeliveryPointId\r\n\tWHERE f.DispatchRequestStatusId IN (20,25,45,46,47,48,49,50,51,52,53,54) \r\n\tAND f.CourierRequestTypeId IN (5,10,15,40,45,50,60,65,70)\r\n\tORDER BY f.DeliveryPointEstimatedArrivalTimeStr\r\n\tFOR JSON PATH\r\n)DeliveryDispatchRequests,\r\n(\r\n\tSELECT \r\n\t\tId,\r\n\t\tShipmentId,\r\n\t\tStatusId,\r\n\t\tStatusTitle,\r\n\t\tParcelReferenceCode,\r\n\t\t--PaymentEstimate,\r\n\t\tCourierRequestTypeId,\r\n\t\tCityId,\r\n\t\tPolygonId,\r\n\t\tPolygonTitle,\r\n\t\tStoreId,\r\n\t\tIsStorePickupPoint,\r\n\t\tStoreLocation,\r\n\t\tStoreTitle,\r\n\t\tStoreAddress,\r\n\t\tResponsibleName,\r\n\t\tResponsibleMobile,\r\n\t\tDeliveryStartTimeStr,\r\n\t\tDeliveryStartTimePersianStr,\r\n\t\tDeliveryDeadLineTimeStr,\r\n\t\tDeliveryDeadLineTimePersianStr,\r\n\t\tClientAddress,\r\n\t\tClientLocation,\r\n\t\tVendorParcelCode,\r\n\t\tVendorId,\r\n\t\tShipmentStatusId,\r\n\t\tShipmentStatusTitle,\r\n\t\tShipmentNumber,\r\n\t\tPickupPointId,\r\n\t\tPickupEstimatedDurationSeconds,\r\n\t\tPickupEstimatedOperationTimeSeconds,\r\n\t\tPickupPointEstimatedArrivalTimeStr,\r\n\t\tPickupPointSequenceNumber,\r\n\t\tDeliveryPointId,\r\n\t\tDeliveryEstimatedDurationSeconds,\r\n\t\tDeliveryEstimatedOperationTimeSeconds,\r\n\t\tDeliveryPointEstimatedArrivalTimeStr,\r\n\t\tDeliveryPointSequenceNumber,\r\n\t\tRemainedToEstimatedTimeSeconds\t,\r\n\t\tIsExclusiveDelivery,\r\n\t\tIsNightly,\r\n\t\tIsDeliveryCodeRequired,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tatt.AttributeId,\r\n\t\t\t\tatt.AttributeValueId\r\n\t\t\tFROM CTE_Attribute att\r\n\t\t\tWHERE SQ.ID = att.DispatchRequestId\r\n\t\t\tFOR JSON PATH\r\n\t\t) AS Attributes\r\n\tFROM\r\n\t(\r\n\t\tSELECT \tDISTINCT\t\r\n\t\tFIRST_VALUE(CASE WHEN f.DispatchRequestStatusId = 25 THEN 1 ELSE 0 END) OVER ( PARTITION BY f.ShipmentId ORDER BY CASE WHEN f.DispatchRequestStatusId = 25 THEN 1 ELSE 0 END DESC) ShipmentHasReturn,\r\n\t\tf.DispatchRequestStatusId,\r\n\t\tOperationTypeId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ID END Id,\r\n\t\tf.ShipmentId ShipmentId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.StatusId END StatusId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.StatusTitle END StatusTitle,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ParcelReferenceCode END ParcelReferenceCode,\r\n\t\t--CASE WHEN f.OperationTypeID = 30 THEN NULL ELSE (SELECT po2.PaymentEstimate FROM CS_Pricing.PR.PriceOrder AS po2 WHERE po2.ShipmentNumber = f.ShipmentNumber AND po2.OrderStateTypeId = 4) END AS PaymentEstimate,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.CourierRequestTypeId END CourierRequestTypeId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.CityId END CityId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PolygonId END PolygonId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PolygonTitle END PolygonTitle,\r\n\t\tf.StoreId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.IsStorePickupPoint END IsStorePickupPoint,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\t\tSELECT f.StoreLocation.STY  AS  Latitude,f.StoreLocation.STX  AS Longitude\r\n\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t),\u0027\u0027))StoreLocation,\r\n\t\tf.StoreTitle,\r\n\t\tf.StoreAddress,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ResponsibleName END ResponsibleName,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE \u00270\u0027\u002BCAST(f.ResponsibleMobile AS VARCHAR(MAX)) END ResponsibleMobile,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryStartTimeStr END DeliveryStartTimeStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryStartTimePersianStr END DeliveryStartTimePersianStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryDeadLineTimeStr END DeliveryDeadLineTimeStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryDeadLineTimePersianStr END DeliveryDeadLineTimePersianStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ClientAddress END ClientAddress,\r\n\t\tJSON_QUERY(ISNULL((\r\n\t\t\tSELECT ISNULL(f.ClientLocation.STY,0)  AS  Latitude,ISNULL(f.ClientLocation.STX,0)  AS Longitude\r\n\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t),\u0027\u0027)) ClientLocation,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.VendorParcelCode END VendorParcelCode,\r\n\t\tf.VendorId VendorId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ShipmentStatusId END ShipmentStatusId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ShipmentStatusTitle END ShipmentStatusTitle,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.ShipmentNumber END ShipmentNumber,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PickupPointId END PickupPointId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PickupEstimatedDurationSeconds END PickupEstimatedDurationSeconds,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PickupEstimatedOperationTimeSeconds END PickupEstimatedOperationTimeSeconds,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PickupPointEstimatedArrivalTimeStr END PickupPointEstimatedArrivalTimeStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.PickupPointSequenceNumber END PickupPointSequenceNumber,\r\n\t\tCASE WHEN f.OperationTypeId = 30 THEN ShipmentDestinationPointID_ReturnToStore ELSE DeliveryPointId END DeliveryPointId,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryEstimatedDurationSeconds END DeliveryEstimatedDurationSeconds,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryEstimatedOperationTimeSeconds END DeliveryEstimatedOperationTimeSeconds,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryPointEstimatedArrivalTimeStr END DeliveryPointEstimatedArrivalTimeStr,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.DeliveryPointSequenceNumber END DeliveryPointSequenceNumber,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN NULL ELSE f.RemainedToEstimatedTimeSeconds_Delivery END  AS RemainedToEstimatedTimeSeconds\t,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN CAST(NULL AS BIT) ELSE f.IsExclusiveDelivery END IsExclusiveDelivery,\r\n\t\tCASE WHEN f.OperationTypeID = 30 THEN CAST(NULL AS BIT) ELSE f.IsNightly END IsNightly,\r\n\t\tCAST(CASE WHEN ISNULL(f.DeliveryCode,0) = 0 THEN 0 ELSE 1 END AS BIT) IsDeliveryCodeRequired\r\n\tFROM CTE_Final f\r\n\r\n\t) SQ\r\n\tWHERE (SQ.DispatchRequestStatusId IN (20,25,45,46,47,48,49,50,51,52,53,54) AND CourierRequestTypeId IN (25,26,30,35,51) AND OperationTypeId \u003C\u003E 30)\r\n\tOR (SQ.ShipmentHasReturn = 0 AND OperationTypeId = 30)\r\n\tORDER BY DeliveryPointEstimatedArrivalTimeStr \r\n\tFOR JSON PATH\r\n)ReturnDispatchRequests\r\n\r\nFOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n)\r\nOPTION (max_grant_percent = 0.001)\r\n\r\n\t--SET @Result=REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(@Result,\u0027\u0022dispatchRequestIds\u0022:[{\u0022dRequestId\u0022:\u0027,\u0027\u0022dispatchRequestIds\u0022:[\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027},{\u0022dRequestId\u0022:\u0027,\u0027,\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027}]}]}]}\u0027,\u0027]}]}]}\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027}]},{\u0022shipmentDestinationPointId\u0022\u0027,\u0027]},{\u0022shipmentDestinationPointId\u0022\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027}]}]},{\u0022shipmentId\u0022\u0027,\u0027]}]},{\u0022shipmentId\u0022\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027\u0022:null\u0027,\u0027\u0022:[]\u0027),\r\n\t--\t\t\t\t\t\t\t\t\t\u0027\u0022Shipments\u0022:null\u0027,\u0027\u0022Shipments\u0022:[]\u0027)\r\n\t\r\n\tSET @Result = REPLACE(@Result,\u0027\\\u0027,\u0027\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027\u0022:\u0022{\u0022\u0027,\u0027\u0022:{\u0022\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027\u0022:null\u0027,\u0027\u0022:[]\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027}\u0022,\u0027,\u0027},\u0027)\r\n\tSET @Result = REPLACE(@Result,\u0027},\u0022ClientLocation\u0022:{\u0027,\u0027}\u0022,\u0022ClientLocation\u0022:{\u0027)\r\n"},{"Name":"Get_TotalShipmentInfo_By_FleetId","Schema":"dbo","Definition":"\r\nCREATE   PROC [dbo].[Get_TotalShipmentInfo_By_FleetId]\r\n(\r\n\t@FleetId BIGINT\r\n) \r\nAS\r\n\r\nIF @FleetId IS NULL \r\n\tRETURN;\r\n\r\ndeclare  @date bigint = FORMAT(GETDATE()-1, \u0027yyyyMMdd\u0027)\u002B\u0027000000000\u0027\r\nSELECT \r\n\tsh.Id AS ShipmentId,\r\n\tsh.ShipmentNumber AS ShipmentNumber,\r\n\tsh.TotalDistanceMeter AS TotalDistance,\r\n\tsh.TotalEstimatedDurationSeconds AS TotalDuration,\r\n\tsh.ShipmentStatusId AS ShipmentStatusId,\r\n\tshs.Title AS ShipmentStatusTitle,\r\n\tsh.CreateDate AS ShipmentCreateDate,\r\n\tsh.CreateDatePersian AS ShipmentCreateDatePersian,\r\n\ts.VendorId AS VendorId,\r\n\tv.BrandName AS VendorTitle,\r\n\ts.CityId AS CityId,\r\n\tc.Name AS CityTitle,\r\n\tps.PolygonId AS PolygonId,\r\n\tp.Title AS PolygonTitle,\r\n\tps.StoreId AS StoreId,\r\n\ts.Title AS StoreTitle,\r\n\ts.Address AS StoreAddress,\r\n\tISNULL(s.Location.STY,0) AS StoreLocationLat,\r\n\tISNULL(s.Location.STX,0) AS StoreLocationLong,\r\n\ts.ResponsibleName AS StoreResponsibleName,\r\n\t--s.ResponsibleMobile AS StoreResponsibleMobile,\r\n\tCASE WHEN v.id= 41 THEN s.Phone ELSE s.ResponsibleMobile END AS StoreResponsibleMobile,\r\n\tstbi.NotPickupRequestReviewThresholdMinutes AS NotPickupRequestReviewThresholdMinutes,\r\n\tstbi.FleetRecaptureAfterOriginArrivalMinutes AS FleetRecaptureAfterOriginArrivalMinutes,\r\n\tstbi.FleetAssignmentSecondNotifyMinutes AS FleetAssignmentSecondNotifyMinutes,\r\n\tstbi.FleetRecaptureAfterAssignmentMinutes AS FleetRecaptureAfterAssignmentMinutes,\r\n\tstbi.FleetPickupNotificationMinutes AS FleetPickupNotificationMinutes,\r\n\tstbi.FleetForcedBikerWaiting AS FleetForcedBikerWaiting,\r\n\tCASE \r\n\t\tWHEN ShipmentStatusId IN ( 5,6,10,15,20 ) THEN 1\r\n\t\tELSE\r\n\t\t\tCASE \r\n\t\t\t\tWHEN dr.CourierRequestTypeId IN (5,10,15) THEN 2\r\n\t\t\t\tWHEN dr.CourierRequestTypeId IN (25) THEN 3\r\n\t\t\t\tELSE 0 \r\n\t\t\tEND\r\n\tEND AS QueueType,\r\n\tdr.ID AS DispatchRequestId,\r\n\tCASE WHEN dr.Version \u003C\u003E sdpdr.Version THEN CAST(40 AS TINYINT) ELSE dr.DispatchRequestStatusId END AS DispatchRequestStatusId,\r\n\tCASE WHEN dr.Version \u003C\u003E sdpdr.Version THEN N\u0027\u0644\u063A\u0648 \u0634\u062F\u0027 ELSE drs.Title END AS DispatchRequestStatusTitle,\r\n\tdr.ParcelReferenceCode AS ParcelReferenceCode,\r\n\tdr.VendorParcelCode AS VendorParcelCode,\r\n\tdr.CourierRequestTypeId AS CourierRequestTypeId,\r\n\tcrt.Title AS CourierRequestTypeTitle,\r\n\tdr.DeliveryStartTime AS DeliveryStartTime,\r\n\tdr.DeliveryStartTimePersian AS DeliveryStartTimePersian,\r\n\tdr.DeliveryDeadLineTime AS DeliveryDeadLineTime,\r\n\tdr.DeliveryDeadLineTimePersian AS DeliveryDeadLineTimePersian,\r\n\tdr.ClientAddress,\r\n\tISNULL(dr.ClientLocation.STY,0) AS ClientLocationLat,\r\n\tISNULL(dr.ClientLocation.STX,0) AS ClientLocationLong,\r\n\tsdp.Id AS DeliveryPointId,\r\n\tsdp.DisplacementMeter AS DeliveryDisplacementMeter,\r\n\tsdp.DistanceMeter AS DeliveryDistanceMeter,\r\n\tISNULL(sdp.estimatedDurationSeconds,0) AS DeliveryEstimatedDurationSeconds,\r\n\tISNULL(sdp.estimatedOperationTimeSeconds,0) AS DeliveryEstimatedOperationTimeSeconds,\r\n\tsdp.EstimatedArrivalTime AS DeliveryEstimatedArrivalTime,\r\n\t(sdp.SequenceNumber - 1) AS DeliverySequenceNumber,\r\n\tCAST(DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))) AS BIGINT) AS RemainedToEstimatedTimeSeconds,\r\n\tdr.IsExclusiveDelivery,\r\n\tdr.IsNightly,\r\n\tdr.IsWaitingForSupport,\r\n\tCAST(CASE WHEN dr.IsWaitingForSupport = 1 OR UOR.HasUOR IS NOT NULL THEN 0 ELSE 1 END AS BIT) AS IsUnsuccessfulPickupAvailable,\r\n\tCAST(CASE WHEN ISNULL(dr.DeliveryCode,0) = 0 THEN 0 ELSE 1 END AS BIT) IsDeliveryCodeRequired,\r\n\tsdp.FleetPayableCost AS FleetDeliveryPayableCost,\r\n\tdrav.DispatchRequestAttributeAllowedValueId,\r\n\tsh.FleetShiftId,\r\n\tsh.TypeOfShipmentId,\r\n\tsh.ApproveShipmentTime\r\nFROM DP.Shipment sh WITH(NOLOCK)\r\nINNER JOIN DP.ShipmentStatus shs WITH(NOLOCK)\r\n\tON sh.ShipmentStatusId = shs.Id\r\nINNER JOIN DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\tON sh.ID = sdp.ShipmentId\r\n\tAND sdp.OperationTypeId IN ( 10,15 )\r\n\tAND sdp.ShipmentDestinationPointStatusId NOT IN ( 35 )\r\nINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\tON sdp.ID = sdpdr.ShipmentDestinationPointId\r\nINNER JOIN DP.DispatchRequest dr WITH(NOLOCK)\r\n\tON sdpdr.DispatchRequestId = dr.Id\r\n\t--AND dr.Version = sdpdr.Version\r\nINNER JOIN DP.DispatchRequestStatus drs WITH(NOLOCK)\r\n\tON dr.DispatchRequestStatusId = drs.Id\r\nINNER JOIN CS_Public.PUB.CourierRequestType crt WITH(NOLOCK)\r\n\tON dr.CourierRequestTypeId = crt.Id\r\nINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\tON dr.PolygonStoreId = ps.Id\r\nINNER JOIN DP.Polygon p WITH(NOLOCK)\r\n\tON ps.PolygonId = p.Id\r\nINNER JOIN DP.Store s WITH(NOLOCK)\r\n\tON ps.StoreId = s.Id\r\nINNER JOIN CS_UserManagement.UM.Vendor v WITH(NOLOCK)\r\n\tON dr.VendorId = v.Id\r\nINNER JOIN CS_Public.HAF.City c WITH(NOLOCK)\r\n\tON p.CityId = c.Id\r\nINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\tON ps.StoreId = stbi.StoreId\t\r\nLEFT JOIN DP.DispatchRequestAttributeValue drav WITH(NOLOCK)\r\n\tON dr.ID = drav.DispatchRequestId\r\nOUTER APPLY\r\n(\r\n\tSELECT 1 HasUOR\r\n\tFROM DP.UnsuccessfulOperationRequestHistory uorh WITH(NOLOCK)\r\n\tWHERE uorh.FleetId = @FleetId\r\n\tAND dr.ID = uorh.DispatchRequestId\r\n) UOR\r\nWHERE sh.FleetId = @FleetId\r\nAND sh.ShipmentStatusId NOT IN (45,50,55,100)\r\n--AND dr.DispatchRequestStatusId NOT IN ( 30,35,40,80,100 )\r\nand sh.CreateDate \u003E= @date\r\n\r\nUNION ALL\r\nSELECT \r\n\tsh.Id AS ShipmentId,\r\n\tsh.ShipmentNumber AS ShipmentNumber,\r\n\tsh.TotalDistanceMeter AS TotalDistance,\r\n\tsh.TotalEstimatedDurationSeconds AS TotalDuration,\r\n\tsh.ShipmentStatusId AS ShipmentStatusId,\r\n\tshs.Title AS ShipmentStatusTitle,\r\n\tsh.CreateDate AS ShipmentCreateDate,\r\n\tsh.CreateDatePersian AS ShipmentCreateDatePersian,\r\n\tdr.VendorId,\r\n\tdr.VendorTitle,\r\n\tdr.CityId,\r\n\tdr.CityTitle,\r\n\tdr.PolygonId,\r\n\tdr.PolygonTitle,\r\n\tdr.StoreId,\r\n\tdr.StoreTitle,\r\n\tdr.StoreAddress,\r\n\tdr.StoreLocationLat,\r\n\tdr.StoreLocationLong,\r\n\tdr.StoreResponsibleName,\r\n\tdr.StoreResponsibleMobile,\r\n\tdr.NotPickupRequestReviewThresholdMinutes AS NotPickupRequestReviewThresholdMinutes,\r\n\tdr.FleetRecaptureAfterOriginArrivalMinutes AS FleetRecaptureAfterOriginArrivalMinutes,\r\n\tdr.FleetAssignmentSecondNotifyMinutes AS FleetAssignmentSecondNotifyMinutes,\r\n\tdr.FleetRecaptureAfterAssignmentMinutes AS FleetRecaptureAfterAssignmentMinutes,\r\n\tdr.FleetPickupNotificationMinutes AS FleetPickupNotificationMinutes,\r\n\tdr.FleetForcedBikerWaiting AS FleetForcedBikerWaiting,\r\n\tCASE \r\n\t\tWHEN ShipmentStatusId IN ( 5,6,10,15,20 ) THEN 1\r\n\t\tELSE\r\n\t\t\tCASE \r\n\t\t\t\tWHEN dr.CourierRequestTypeId IN (5,10,15) THEN 2\r\n\t\t\t\tWHEN dr.CourierRequestTypeId IN (25) THEN 3\r\n\t\t\t\tELSE 0 \r\n\t\t\tEND\r\n\tEND AS QueueType,\r\n\tdr.DispatchRequestId,\r\n\tdr.DispatchRequestStatusId AS DispatchRequestStatusId,\r\n\tdr.DispatchRequestStatusTitle,\r\n\tdr.ParcelReferenceCode AS ParcelReferenceCode,\r\n\tdr.VendorParcelCode AS VendorParcelCode,\r\n\tdr.CourierRequestTypeId AS CourierRequestTypeId,\r\n\tdr.CourierRequestTypeTitle,\r\n\tdr.DeliveryStartTime AS DeliveryStartTime,\r\n\tdr.DeliveryStartTimePersian AS DeliveryStartTimePersian,\r\n\tdr.DeliveryDeadLineTime AS DeliveryDeadLineTime,\r\n\tdr.DeliveryDeadLineTimePersian AS DeliveryDeadLineTimePersian,\r\n\tdr.ClientAddress,\r\n\tdr.ClientLocationLat,\r\n\tdr.ClientLocationLong,\r\n\tsdp.Id AS DeliveryPointId,\r\n\tsdp.DisplacementMeter AS DeliveryDisplacementMeter,\r\n\tsdp.DistanceMeter AS DeliveryDistanceMeter,\r\n\tISNULL(sdp.estimatedDurationSeconds,0) AS DeliveryEstimatedDurationSeconds,\r\n\tISNULL(sdp.estimatedOperationTimeSeconds,0) AS DeliveryEstimatedOperationTimeSeconds,\r\n\tsdp.EstimatedArrivalTime AS DeliveryEstimatedArrivalTime,\r\n\t(sdp.SequenceNumber - 1) AS DeliverySequenceNumber,\r\n\tCAST(DATEDIFF(SECOND,GETDATE(),DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))) AS BIGINT) AS RemainedToEstimatedTimeSeconds,\r\n\tdr.IsExclusiveDelivery,\r\n\tdr.IsNightly,\r\n\tdr.IsWaitingForSupport,\r\n\tdr.IsUnsuccessfulPickupAvailable,\r\n\tdr.IsDeliveryCodeRequired,\r\n\tsdp.FleetPayableCost AS FleetDeliveryPayableCost,\r\n\tdr.DispatchRequestAttributeAllowedValueId,\r\n\tsh.FleetShiftId,\r\n\tsh.TypeOfShipmentId,\r\n\tsh.ApproveShipmentTime\r\nFROM DP.Shipment sh WITH(NOLOCK)\r\nINNER JOIN DP.ShipmentStatus shs WITH(NOLOCK)\r\n\tON sh.ShipmentStatusId = shs.Id\r\nINNER JOIN DP.ShipmentDestinationPoint sdp WITH(NOLOCK)\r\n\tON sh.ID = sdp.ShipmentId\r\n\tAND sdp.OperationTypeId IN ( 30 )\r\n\tAND sdp.ShipmentDestinationPointStatusId NOT IN ( 35 )\r\nLEFT JOIN\r\n(\r\n\tSELECT\r\n\t\tsdpdr.ShipmentDestinationPointId,\r\n\t\ts.VendorId AS VendorId,\r\n\t\tv.BrandName AS VendorTitle,\r\n\t\ts.CityId AS CityId,\r\n\t\tc.Name AS CityTitle,\r\n\t\tps.PolygonId AS PolygonId,\r\n\t\tp.Title AS PolygonTitle,\r\n\t\tps.StoreId AS StoreId,\r\n\t\ts.Title AS StoreTitle,\r\n\t\ts.Address AS StoreAddress,\r\n\t\tISNULL(s.Location.STY,0) AS StoreLocationLat,\r\n\t\tISNULL(s.Location.STX,0) AS StoreLocationLong,\r\n\t\ts.ResponsibleName AS StoreResponsibleName,\r\n\t\tCASE WHEN V.Id= 41 THEN s.Phone ELSE s.ResponsibleMobile END AS StoreResponsibleMobile,\r\n\t\tstbi.NotPickupRequestReviewThresholdMinutes AS NotPickupRequestReviewThresholdMinutes,\r\n\t\tstbi.FleetRecaptureAfterOriginArrivalMinutes AS FleetRecaptureAfterOriginArrivalMinutes,\r\n\t\tstbi.FleetAssignmentSecondNotifyMinutes AS FleetAssignmentSecondNotifyMinutes,\r\n\t\tstbi.FleetRecaptureAfterAssignmentMinutes AS FleetRecaptureAfterAssignmentMinutes,\r\n\t\tstbi.FleetPickupNotificationMinutes AS FleetPickupNotificationMinutes,\r\n\t\tstbi.FleetForcedBikerWaiting AS FleetForcedBikerWaiting,\r\n\t\tdr.ID AS DispatchRequestId,\r\n\t\tCASE WHEN dr.Version \u003C\u003E sdpdr.Version THEN CAST(40 AS TINYINT) ELSE dr.DispatchRequestStatusId END AS DispatchRequestStatusId,\r\n\t\tCASE WHEN dr.Version \u003C\u003E sdpdr.Version THEN N\u0027\u0644\u063A\u0648 \u0634\u062F\u0027 ELSE drs.Title END AS DispatchRequestStatusTitle,\r\n\t\tdr.ParcelReferenceCode AS ParcelReferenceCode,\r\n\t\tdr.VendorParcelCode AS VendorParcelCode,\r\n\t\tdr.CourierRequestTypeId AS CourierRequestTypeId,\r\n\t\tcrt.Title AS CourierRequestTypeTitle,\r\n\t\tdr.DeliveryStartTime AS DeliveryStartTime,\r\n\t\tdr.DeliveryStartTimePersian AS DeliveryStartTimePersian,\r\n\t\tdr.DeliveryDeadLineTime AS DeliveryDeadLineTime,\r\n\t\tdr.DeliveryDeadLineTimePersian AS DeliveryDeadLineTimePersian,\r\n\t\tdr.ClientAddress,\r\n\t\tISNULL(dr.ClientLocation.STY,0) AS ClientLocationLat,\r\n\t\tISNULL(dr.ClientLocation.STX,0) AS ClientLocationLong,\r\n\t\tdr.IsExclusiveDelivery,\r\n\t\tdr.IsNightly,\r\n\t\tdr.IsWaitingForSupport,\r\n\t\tCAST(CASE WHEN dr.IsWaitingForSupport = 1 OR UOR.HasUOR IS NOT NULL THEN 0 ELSE 1 END AS BIT) AS IsUnsuccessfulPickupAvailable,\r\n\t\tCAST(CASE WHEN ISNULL(dr.DeliveryCode,0) = 0 THEN 0 ELSE 1 END AS BIT) IsDeliveryCodeRequired,\r\n\t\tdrav.DispatchRequestAttributeAllowedValueId\r\n\tFROM DP.ShipmentDestinationPointDispatchRequest sdpdr WITH(NOLOCK)\r\n\tINNER JOIN DP.DispatchRequest dr WITH(NOLOCK)\r\n\t\tON sdpdr.DispatchRequestId = dr.Id\r\n\t\t--AND dr.Version = sdpdr.Version\r\n\tINNER JOIN DP.DispatchRequestStatus drs WITH(NOLOCK)\r\n\t\tON dr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN CS_Public.PUB.CourierRequestType crt WITH(NOLOCK)\r\n\t\tON dr.CourierRequestTypeId = crt.Id\r\n\tINNER JOIN DP.PolygonStore ps WITH(NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\tINNER JOIN DP.Polygon p WITH(NOLOCK)\r\n\t\tON ps.PolygonId = p.Id\r\n\tINNER JOIN DP.Store s WITH(NOLOCK)\r\n\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN CS_UserManagement.UM.Vendor v WITH(NOLOCK)\r\n\t\tON dr.VendorId = v.Id\r\n\tINNER JOIN CS_Public.HAF.City c WITH(NOLOCK)\r\n\t\tON p.CityId = c.Id\r\n\tINNER JOIN DP.StoreTechnicalBasicInformation stbi WITH(NOLOCK)\r\n\t\tON ps.StoreId = stbi.StoreId\t\r\n\tLEFT JOIN DP.DispatchRequestAttributeValue drav WITH(NOLOCK)\r\n\t\tON dr.ID = drav.DispatchRequestId\r\n\tOUTER APPLY\r\n\t(\r\n\t\tSELECT 1 HasUOR\r\n\t\tFROM DP.UnsuccessfulOperationRequestHistory uorh WITH(NOLOCK)\r\n\t\tWHERE uorh.FleetId = @FleetId\r\n\t\tAND dr.ID = uorh.DispatchRequestId\r\n\t) UOR\r\n\t--WHERE dr.DispatchRequestStatusId NOT IN ( 30,35,40,80,100 )\r\n) DR\r\nON sdp.ID = dr.ShipmentDestinationPointId\r\nWHERE sh.FleetId = @FleetId\r\nAND sh.ShipmentStatusId NOT IN (45,50,55,100)\r\nand sh.CreateDate \u003E= @date\r\n"},{"Name":"Get_UnassignedDispatchRequest_By_DispatchRequestId","Schema":"dbo","Definition":"-- Stored Procedure\r\n\r\n/*\r\nDECLARE @Result NVARCHAR(MAX)\r\nexec Get_UnassignedDispatchRequest_By_DispatchRequestId @Id=26,@Result=@Result OUTPUT\r\nSELECT @RESULT\r\n\r\nDECLARE @Result NVARCHAR(MAX)\r\nexec Get_UnassignedDispatchRequest_By_DispatchRequestId @Id=954,@Result=@Result OUTPUT\r\nSELECT @RESULT\r\n\r\nDECLARE @Result NVARCHAR(MAX)\r\nexec Get_UnassignedDispatchRequest_By_DispatchRequestId @DispatchRequestId=3444,@OperationWarningRangeTime=\u002700:01\u0027,@MinimumDeliveryTime=\u002700:02\u0027, @Result=@Result OUTPUT\r\nSELECT @RESULT\r\n\r\n*/\r\nCREATE   PROCEDURE [dbo].[Get_UnassignedDispatchRequest_By_DispatchRequestId] \r\n\t@DispatchRequestId\t\t\tBIGINT ,\r\n\t@OperationWarningRangeTime\tVARCHAR(10),\r\n\t@MinimumDeliveryTime\t\tVARCHAR(10),\r\n\t@Result\t\t\t\t\t\tNVARCHAR(MAX) OUTPUT\r\nWITH RECOMPILE\r\nAS\r\n\t-- just DispatchRequestStatusId 10 , 40 and id and assignment status\r\n\tIF EXISTS (\t\r\n\t\t\t\tSELECT 1\r\n\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dp\r\n\t\t\t\tWHERE dp.Id=@DispatchRequestId\r\n\t\t\t\tAND dp.DispatchRequestStatusId IN (10,40)\r\n\t\t\t\t)\r\n\tBEGIN\r\n\t\tSET @RESULT=(\r\n\t\tSELECT \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT pos.OperationStaffId\r\n\t\t\t\t\tFROM dp.PolygonStore(NOLOCK) ps\r\n\t\t\t\t\tINNER JOIN dp.polygon(NOLOCK) p ON p.id=ps.PolygonId\r\n\t\t\t\t\tINNER JOIN dp.polygonOperationStaff(NOLOCK) pos ON pos.polygonId=p.Id\r\n\t\t\t\t\tWHERE dr.PolygonStoreId=ps.Id\r\n\t\t\t\t\tFOR JSON PATH\r\n\t\t\t\t)OperationStaffIds,\r\n\r\n\t\t\t\tJSON_QUERY((\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tdr.id,\r\n\t\t\t\t\tdrs.id\t\tdispatchRequeststatusId,\r\n\t\t\t\t\tdrs.title\tdispatchRequeststatusTitle\r\n\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t\t\t\t))DispatchRequests\r\n\t\tFROM dp.DispatchRequest(NOLOCK) dr\r\n\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) drs ON drs.id=dr.DispatchRequestStatusId\r\n\t\tWHERE dr.Id=@DispatchRequestId\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t)\r\n\r\n\t\tSET @Result=REPLACE(REPLACE(REPLACE(REPLACE(@Result,\r\n\t\t\t\t\t\t\t\t\t\t\t\u0027{\u0022OperationStaffIds\u0022:[{\u0022OperationStaffId\u0022:\u0027,\u0027{\u0022OperationStaffIds\u0022:[\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\u0027},{\u0022OperationStaffId\u0022:\u0027,\u0027,\u0027),\u0027}],\u0022id\u0022:\u0027,\u0027],\u0022id\u0022:\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\u0027}],\u0022DispatchRequests\u0022\u0027,\u0027],\u0022DispatchRequests\u0022\u0027)\r\n\t\tRETURN\r\n\tEND\r\n\tELSE \r\n\r\n\tSET @RESULT=(\r\n\t\tSELECT \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT pos.OperationStaffId\r\n\t\t\t\t\tFROM dp.PolygonStore(NOLOCK) ps\r\n\t\t\t\t\tINNER JOIN dp.polygon(NOLOCK) p ON p.id=ps.PolygonId\r\n\t\t\t\t\tINNER JOIN dp.polygonOperationStaff(NOLOCK) pos ON pos.polygonId=p.Id\r\n\t\t\t\t\tWHERE dr.PolygonStoreId=ps.Id\r\n\t\t\t\t\tFOR JSON PATH\r\n\t\t\t\t)OperationStaffIds,\r\n\r\n\r\n\t\t\t\tJSON_QUERY((\r\n\t\t\t\t\tSELECT\r\n\t\t\t\t\t\tdr.id,\r\n\t\t\t\t\t\tdps.id\t\tdispatchRequeststatusId,\r\n\t\t\t\t\t\tdps.title\tdispatchRequeststatusTitle,\r\n\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN GETDATE()\u003C\r\n\t\t\t\t\t\t\tDATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\tDATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t-(DATEPART(HOUR,@MinimumDeliveryTime)*3600\u002BDATEPART(MINUTE,@MinimumDeliveryTime)*60\u002BDATEPART(SECOND,@MinimumDeliveryTime)),CAST(CONVERT(VARCHAR, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\tWHEN GETDATE() BETWEEN \r\n\t\t\t\t\t\t\t\tDATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t-(DATEDIFF (SECOND,0,@OperationWarningRangeTime)),\r\n\t\t\t\t\t\t\t\tDATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t-(DATEPART(HOUR,@MinimumDeliveryTime)*3600\u002BDATEPART(MINUTE,@MinimumDeliveryTime)*60\u002BDATEPART(SECOND,@MinimumDeliveryTime)),CAST(CONVERT(VARCHAR, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\tAND \r\n\t\t\t\t\t\t\t\t\tDATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t-(DATEPART(HOUR,@MinimumDeliveryTime)*3600\u002BDATEPART(MINUTE,@MinimumDeliveryTime)*60\u002BDATEPART(SECOND,@MinimumDeliveryTime)),CAST(CONVERT(VARCHAR, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\tTHEN 3\r\n\t\t\t\t\t\tWHEN GETDATE()\u003EDATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t-(DATEPART(HOUR,@MinimumDeliveryTime)*3600\u002BDATEPART(MINUTE,@MinimumDeliveryTime)*60\u002BDATEPART(SECOND,@MinimumDeliveryTime)),CAST(CONVERT(VARCHAR, FORMAT(DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))\r\n\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\t\tEND assignmentStatus,\r\n\r\n\t\t\t\t\t\tdr.parcelReferenceCode,\r\n\t\t\t\t\t\tdr.courierRequestTypeId,\r\n\t\t\t\t\t\tp.cityId,\r\n\t\t\t\t\t\tp.id polygonId,\r\n\t\t\t\t\t\tp.title polygonTitle,\r\n\t\t\t\t\t\tps.storeId storeId,\r\n\t\t\t\t\t\tFORMAT(dr.DeliveryStartTime,\u0027####-##-## ##:##:##\\.###\u0027) deliveryStartTimeStr,\r\n\r\n\t\t\t\t\t\tFORMAT(dr.DeliveryStartTimePersian,\u0027####/##/## ##:##:##\\.###\u0027) deliveryStartTimePersianStr,\r\n\r\n\t\t\t\t\t\tFORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027) deliveryDeadLineTimeStr,\r\n\r\n\t\t\t\t\t\tFORMAT(dr.DeliveryDeadLineTimePersian,\u0027####/##/## ##:##:##\\.###\u0027) deliveryDeadLineTimePersianStr,\r\n\r\n\t\t\t\t\t\tdr.clientAddress,\r\n\t\t\t\t\t\tJSON_QUERY((\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT dr.clientLocation.STY  AS  Latitude,dr.clientLocation.STX  AS Longitude\r\n\t\t\t\t\t\t\t\t\t\t\tFROM dp.DispatchRequest(NOLOCK) dr1 \r\n\t\t\t\t\t\t\t\t\t\t\tWHERE dr1.Id=dr.Id\r\n\t\t\t\t\t\t\t\t\t\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t\t\t\t\t\t\t\t))clientLocation,\r\n\r\n\r\n\t\t\t\t\t\tDATEDIFF(SECOND,GETDATE(),CAST(CONVERT(VARCHAR, FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME)) remainedToDeadlineSeconds,\r\n\t\t\t\t\t\tvendorParcelCode\r\n\t\t\t\t\tFOR JSON PATH , INCLUDE_NULL_VALUES\r\n\t\t\t\t)) DispatchRequests\r\n\t\tFROM dp.DispatchRequest(NOLOCK) dr\r\n\t\tINNER JOIN dp.DispatchRequestStatus(NOLOCK) dps ON dps.id=dr.DispatchRequestStatusId\r\n\t\tINNER JOIN dp.PolygonStore(NOLOCK) ps ON ps.id=dr.PolygonStoreId\r\n\t\tINNER JOIN dp.Polygon(NOLOCK) p ON p.id=ps.PolygonId\r\n\t\tWHERE dr.Id=@DispatchRequestId\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER , INCLUDE_NULL_VALUES\r\n\t\t)\r\n\r\n\t\tSET @Result=REPLACE(REPLACE(REPLACE(REPLACE(@Result,\u0027\\\u0027,\u0027\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\u0027{\u0022OperationStaffIds\u0022:[{\u0022OperationStaffId\u0022:\u0027,\u0027{\u0022OperationStaffIds\u0022:[\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\u0027},{\u0022OperationStaffId\u0022:\u0027,\u0027,\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\u0027}],\u0022DispatchRequests\u0022\u0027,\u0027],\u0022DispatchRequests\u0022\u0027)\r\n\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--\u0027}],\u0022id\u0022:\u0027,\u0027],\u0022id\u0022:\u0027)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--\u0027\u0022clientLocation\u0022:\u0022{\u0027,\u0027\u0022clientLocation\u0022:{\u0027),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--\u0027\u0022,\u0022assignmentStatus\u0022\u0027,\u0027,\u0022assignmentStatus\u0022\u0027)\r\n\r\n\r\n\r\n\r\n"},{"Name":"Get_UnassignedDispatchRequests_By_Filter","Schema":"dbo","Definition":"CREATE           PROCEDURE [dbo].[Get_UnassignedDispatchRequests_By_Filter]\r\n   -- declare\r\n    @OperationStaffId\t\t\t\t\t\t\tINT,\r\n    @CityIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t= NULL, --@CityId--SMALLINT=CityIds--VARCHAR(200)\r\n    @PolygonIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t= NULL,\r\n    @StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,\r\n    @ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @CourierRequestTypeIds\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n    @OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n    @MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),\r\n    @StartDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @EndDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t= NULL,\r\n\t@VendorID\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,\r\n\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX)\t= NULL,\r\n\t@IsConfirmed\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t@OrderCategoryIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t= NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t/**********************************************/\r\n\t@delayedDeliveryRequestCount\t\t\t\tINT\t\t\t\t= 0 OUTPUT,\r\n\t@assignedDispatchRequestCount\t\t\t\tINT\t\t\t\t= 0 OUTPUT,\r\n\t@returnedRequestCount\t\t\t\t\t\tINT\t\t\t\t= 0 OUTPUT,\r\n\t@delayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\t= 0 OUTPUT,\r\n\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\t= 0 OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT\t\t\t\t= 0 OUTPUT,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t\t\t\t= 0 OUTPUT\r\n\t/**********************************************/\r\n    --@Result\t\t\t\t\t\t\t\tNVARCHAR(MAX)\tOUTPUT\r\nAS\r\n\r\n\tset nocount on;\r\n\t\r\n\tSET @CityIds        = ISNULL(@CityIds,\u00270\u0027)        \r\n    SET @PolygonIds = ISNULL(@PolygonIds,\u00270\u0027)        \r\n    SET @StoreId        = ISNULL(@StoreId,0)\r\n\tSET @DeliveryServiceProviderIds = ISNULL(@DeliveryServiceProviderIds,\u00270\u0027)\r\n\tSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\tSET @OrderCategoryIds = ISNULL(@OrderCategoryIds,\u00270\u0027)\r\n\r\n\tSELECT \r\n\t\tcpc.StoreId,\r\n\t\t\u0027[\u0027 \u002BSTRING_AGG(DeliveryServiceProviderId,\u0027,\u0027) WITHIN GROUP (ORDER BY DeliveryServiceProviderId ASC)\u002B\u0027]\u0027 AS availableServiceProviderIds\r\n\tINTO #DeliveryServiceProviderId\r\n\tFROM DP.CoefficientProviderConfig cpc (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceProviderIds,\u0027,\u0027) ss\r\n\t\tON cpc.Id = ss.value\r\n\t\tOR @DeliveryServiceProviderIds = \u00270\u0027\r\n\tWHERE cpc.IsActive = 1\r\n\tGroup By cpc.StoreId\r\n\r\n\r\n\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t(\r\n\t\tStoreId\r\n\t)\r\n\t--select \r\n\t--@OperationStaffId=42 ,\r\n\t--@CityIds=NULL, \r\n\t--@PolygonIds=\u0027\u0027, \r\n\t--@StoreId=0, \r\n\t--@ParcelReferenceCode=0, \r\n\t--@CourierRequestTypeIds=\u0027\u0027, \r\n\t--@StartDeliveryTime=NULL, \r\n\t--@EndDeliveryTime=NULL, \r\n\t--@VendorParcelCode=NULL, \r\n\t--@MinimumDeliveryTime=\u002700:19:00\u0027, \r\n\t--@OperationWarningRangeTime=\u002700:02:00\u0027, \r\n\t--@OrderBy=\u0027\u0027, \r\n\t--@IsAsc=\u0027False\u0027\r\n\r\n\tdeclare \r\n\t\t@sql nvarchar(max)\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\r\n\r\n\tDROP TABLE IF EXISTS #PolygonId ,#CityId , #CourierRequestTypeId\r\n\r\n\tSELECT p.Id\r\n\tINTO #PolygonId\r\n\tFROM STRING_SPLIT(@PolygonIds, \u0027,\u0027) ss\r\n\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\tON ss.value = p.Id\r\n\t\tOR @PolygonIds = \u00270\u0027\r\n\r\n\r\n\t--DECLARE @CityId TABLE\r\n\t--(\r\n\t--\tId SMALLINT\r\n\t--);\r\n\t--INSERT INTO @CityId\r\n\t--SELECT value\r\n\t--FROM STRING_SPLIT(@CityIds, \u0027,\u0027);\r\n\r\n\tSELECT c.Id\r\n\tINTO #CityId\r\n\tFROM STRING_SPLIT(@CityIds, \u0027,\u0027) ss\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\t\tON ss.value = c.Id\r\n\t\tOR @CityIds = \u00270\u0027\r\n\r\n\r\n\t--DECLARE @CourierRequestTypeId TABLE\r\n\t--(\r\n\t--\tId TINYINT\r\n\t--);\r\n\t--INSERT INTO @CourierRequestTypeId\r\n\t--SELECT value\r\n\t--FROM STRING_SPLIT(@CourierRequestTypeIds, \u0027,\u0027);\r\n\r\n\tSELECT crt.Id\r\n\tINTO #CourierRequestTypeId\r\n\tFROM STRING_SPLIT(@CourierRequestTypeIds, \u0027,\u0027) ss\r\n\tINNER JOIN CS_Public.[PUB].[CourierRequestType] crt\r\n\t\tON ss.value = crt.Id\r\n\t\tOR @CourierRequestTypeIds = \u00270\u0027\r\n\tSELECT\r\n\t\toc.Id\r\n\tINTO #OrderCategoryId\r\n\tFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\tINNER JOIN string_split(@OrderCategoryIds,\u0027,\u0027) ss\r\n\t\tON oc.Id = ss.value\r\n\t\tOR @OrderCategoryIds = \u00270\u0027\r\n\r\n\tIF (@StartDeliveryTime \u003C\u003E 0)\r\n\t   AND (@EndDeliveryTime \u003C\u003E 0)\r\n\t   AND dbo.FN_DateDiff(@StartDeliveryTime, @EndDeliveryTime) \u003E 31\r\n\tBEGIN\r\n\t\t--SET @Result = -1;\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\tIF @StartDeliveryTime IS NOT NULL AND @EndDeliveryTime IS NULL \r\n\t\tSET @EndDeliveryTime = @StartDeliveryTime \u002B 100000000000\r\n\tELSE IF @StartDeliveryTime IS NULL AND @EndDeliveryTime IS NOT NULL\r\n\t\tSET @StartDeliveryTime = @EndDeliveryTime - 100000000000\r\n\t\r\n\t/**************************************************/\r\n\tDECLARE @Today INT= CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\t/**************************************************/\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027)\r\n\r\n\t/**************************************************/\r\n\t--DROP TABLE IF EXISTS #ActiveShipmentCount\r\n\t--DROP TABLE IF EXISTS #TotalCount\r\n\tDROP TABLE IF EXISTS #AllDispatchRequests\r\n\tDROP TABLE IF EXISTS #AllShipmentDestinationPoint\r\n\tDROP TABLE IF EXISTS #ReturnedCount\r\n\tDROP TABLE IF EXISTS #DelayedPickupCount\r\n\tDROP TABLE IF EXISTS #DelayedDeliveryCount\r\n\t/**************************************************AllDispatchRequests*/\r\n\r\nSELECT \r\n\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount) ,\r\n\t@assignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount) ,\r\n\t@returnedRequestCount = COUNT(DISTINCT ReturnedCount) ,\r\n\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount) ,\r\n\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\nFROM\r\n(\r\n\tSELECT\t\r\n\t\tCASE\r\n\t\t\tWHEN ddr.CourierRequestTypeId IN (26,30,35,40,45,50) AND ddr.DispatchRequestStatusId IN (5) \r\n\t\t\tTHEN ddr.Id ELSE NULL \r\n\t\tEND AS UnassignedReturnAndReplacementRequestCount,\r\n\r\n\t\tCASE \r\n\t\t\tWHEN ddr.DispatchRequestStatusId IN (5,6,7) AND ddr.DeliveryStartTime BETWEEN CAST(@Today\u002B\u0027000000000\u0027 AS BIGINT) AND CAST(@Today\u002B\u0027235959999\u0027 AS BIGINT)\r\n\t\t\tTHEN ddr.Id ELSE NULL \r\n\t\tEND AS UnassignedDispatchRequestCount,\r\n\r\n\t\tCASE \r\n\t\t\tWHEN \r\n\t\t\t\t\t( ddr.DispatchRequestStatusId NOT IN (30,35,100) and ddr.CourierRequestTypeId = 25 )\r\n\t\t\t\tOR\t( ddr.DispatchRequestStatusId in (45,46,47,48,49) and ddr.CourierRequestTypeId in (5,10,15) )\r\n\t\t\tTHEN ddr.Id \r\n\t\t\tELSE NULL \r\n\t\tEND AS ReturnedCount,\r\n\r\n\t\tCASE \r\n\r\n\t\t\tWHEN ddr.DispatchRequestStatusId IN(10,11,15,16,20,25,45,46,47,48,49,50,51,52,53,54)\r\n\t\t\tTHEN ddr.ParcelReferenceCode\r\n\r\n\t\t\tELSE NULL\r\n\t\tEND AS Assigned_DispatchRequestCount,\r\n\r\n\tCASE \r\n\t\tWHEN \r\n\t\t\tddr.IsWaitingForSupport = 1 \r\n\t\t\tAND ddr.DispatchRequestStatusId IN ( 15,16 ) \r\n\t\tTHEN ddr.ParcelReferenceCode\r\n\t\tELSE NULL \r\n\t\tEND AS NotPickupRequestCount\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON dspId.StoreId = s.Id\r\n\tINNER JOIN CS_OrderManagement.OM.Parcel p (NOLOCK)\r\n\t\tON ddr.ParcelReferenceCode = p.ParcelReferenceCode\r\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\tON p.CourierRequestId = cr.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON dp.Id = pID.Id\r\n\tINNER JOIN #CityId cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId\r\n    AND ddr.DeliveryStartTime \u003E= @StartDeliveryTime AND ddr.DeliveryDeadLineTime \u003C= @EndDeliveryTime\r\n\tAND ( (ddr.DispatchRequestStatusId IN ( 5,6,7 ,10,11,15,16,20,25,45,46,47,48,49,50,51,52,53,54 )) OR (ddr.DispatchRequestStatusId NOT IN (30,35,100) and ddr.CourierRequestTypeId = 25))\r\n\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\tAND ( ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\tAND ((@IsConfirmed = 1 AND cr.ConfirmationDate IS NOT NULL) OR (@IsConfirmed = 0 AND cr.ConfirmationDate IS NULL) OR @IsConfirmed IS NULL )\r\n) SQ\r\n\r\nSELECT \r\n\t@delayedPickupCount = COUNT(DISTINCT DelayedPickupCount) ,\r\n\t@delayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount)\r\nFROM\r\n(\r\n\tSELECT\r\n\t\tCASE WHEN (ddr.DispatchRequestStatusId in (10,11,15,16) AND sdp.OperationTypeId = 5)  THEN sdpdr.DispatchRequestId ELSE NULL END AS DelayedPickupCount,\r\n\t\tCASE WHEN (sdp.OperationTypeId = 10 AND ddr.DispatchRequestStatusId IN (20,25)) THEN sdpdr.DispatchRequestId ELSE NULL END DelayedDeliveryCount\r\n\tFROM dP.Shipment(NOLOCK) ds\r\n\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON ds.Id=sdp.ShipmentId\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\tINNER JOIN DP.DispatchRequest ddr WITH(NOLOCK)\r\n\t\tON sdpdr.DispatchRequestId = ddr.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON dspId.StoreId = s.Id\r\n\tINNER JOIN CS_OrderManagement.OM.Parcel p (NOLOCK)\r\n\t\tON ddr.ParcelReferenceCode = p.ParcelReferenceCode\r\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\tON p.CourierRequestId = cr.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON dp.Id = pID.Id\r\n\tINNER JOIN #CityId cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId\r\n    AND ddr.DeliveryStartTime \u003E= @StartDeliveryTime AND ddr.DeliveryDeadLineTime \u003C= @EndDeliveryTime\r\n\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\tAND ( ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\tAND ((@IsConfirmed = 1 AND cr.ConfirmationDate IS NOT NULL) OR (@IsConfirmed = 0 AND cr.ConfirmationDate IS NULL) OR @IsConfirmed IS NULL )\r\n\tAND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= GETDATE()\r\n\tAND\r\n\t(\r\n\t\t\t(ddr.DispatchRequestStatusId in (10,11,15,16) AND sdp.OperationTypeId = 5)\r\n\t\tOR\t(sdp.OperationTypeId = 10 AND ddr.DispatchRequestStatusId IN (20,25))\r\n\t)\r\n) SQ\r\n\t\r\n\t/***********************************************************/\r\n\t\r\n\tDECLARE @OperationWarningRangeTime_Second\tINT=DATEDIFF (SECOND,0,@OperationWarningRangeTime)\r\n\tDECLARE @MinimumDeliveryTime_Second\t\t\tINT=DATEDIFF (SECOND,0,@MinimumDeliveryTime)\r\n\r\n\tSELECT @TotalCount = COUNT(ddr.Id)\r\n\t--\tINTO #AllDispatchRequests\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\tON dspId.StoreId = s.Id\r\n\t\tINNER JOIN CS_OrderManagement.OM.Parcel p (NOLOCK)\r\n\t\t\tON ddr.ParcelReferenceCode = p.ParcelReferenceCode\r\n\t\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\t\tON p.CourierRequestId = cr.Id\r\n\t\tINNER JOIN #PolygonId pID\r\n\t\t\tON dp.Id = pID.Id\r\n\t\tINNER JOIN #CityId cID\r\n\t\t\tON dp.CityId = cID.Id\r\n\t\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\t\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n        AND ddr.DeliveryStartTime \u003E= @StartDeliveryTime AND ddr.DeliveryDeadLineTime \u003C= @EndDeliveryTime        \r\n\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\tAND ( ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\t\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\t\tAND ((@IsConfirmed = 1 AND cr.ConfirmationDate IS NOT NULL) OR (@IsConfirmed = 0 AND cr.ConfirmationDate IS NULL) OR @IsConfirmed IS NULL )\r\n\t\tAND ddr.DispatchRequestStatusId in (5 /*submitted*/,6 /*Reassignment Requested*/,7)\r\n\t\t\tAND ddr.CourierRequestTypeId \u003C\u003E 51\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(ps.StoreId = @StoreId)\r\n\t\t\t\tOR (ISNULL(@StoreId, 0) = 0)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(ddr.ParcelReferenceCode = @ParcelReferenceCode)\r\n\t\t\t\tOR (ISNULL(@ParcelReferenceCode, 0) = 0)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(DeliveryStartTime\r\n\t\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t\t)\r\n\t\t\t\tOR (DeliveryDeadLineTime\r\n\t\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t\t)\r\n\t\t\t\tOR\r\n\t\t\t\t(\r\n\t\t\t\t\t(DeliveryStartTime \u003C @StartDeliveryTime)\r\n\t\t\t\t\tAND (DeliveryDeadLineTime \u003E @EndDeliveryTime)\r\n\t\t\t\t)\r\n\t\t\t\tOR\r\n\t\t\t\t(\r\n\t\t\t\t\tISNULL(@StartDeliveryTime, 0) = 0\r\n\t\t\t\t\tAND ISNULL(@EndDeliveryTime, 0) = 0\r\n\t\t\t\t)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\tddr.VendorParcelCode = @VendorParcelCode\r\n\t\t\t\tOR ISNULL(@VendorParcelCode, \u0027\u0027) = \u0027\u0027\r\n\t\t\t)\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027));\r\n\r\n\t--SET @TotalCount = @@ROWCOUNT\r\n\t--;WITH CTE_AllDispatchRequests AS\r\n\t--(\r\n\t\tSELECT\t \r\n\t\t\tddr.Id DispatchRequestId,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tLEFT(ddr.DeliveryStartTime,8)\tDeliveryStartTime_Date,\r\n\t\t\tDeliveryStartTime,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode,\r\n\t\t\tpos.OperationStaffId,\r\n\t\t\tdrs.title\t\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\tddr.CourierRequestTypeId,\r\n\t\t\ts.Location.STY\t\t\t\t\tStoreLocation_Latitude,\r\n\t\t\ts.Location.STX\t\t\t\t\tStoreLocation_Longitude,\r\n\t\t\t\r\n\t\t\tddr.ClientLocation.STY\t\t\tclientlocation_Lat,\r\n\t\t\tddr.ClientLocation.STX\t\t\tclientlocation_Long,\r\n\r\n\t\t\t--CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)DeliveryDeadLineTime_DateTime,\r\n\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\tddr.DeliveryStartTimePersian, \r\n\t\t\tddr.DeliveryDeadLineTimePersian,\r\n\t\t\tddr.ClientAddress,\r\n\t\t\tddr.IsExclusiveDelivery,\r\n\t\t\tddr.IsNightly,\r\n\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\tddr.VendorId,\r\n\t\t\tCAST(CASE WHEN cr.ConfirmationDate IS NOT NULL THEN 1 ELSE 0 END AS BIT ) AS IsConfirmed,\r\n\t\t\ts.OrderCategoryId,\r\n\t\t\toc.Title AS OrderCategoryTitle,\r\n\t\t\tdspId.availableServiceProviderIds,\r\n\t\t\tCAST(ISNULL(ddr.Version,1)\u002B1 AS INT) AS [Version],\r\n\t\t\tCASE\r\n\t\t\t\tWHEN GETDATE() \u003C DATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t\t- @OperationWarningRangeTime_Second,\r\n\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,- @MinimumDeliveryTime_Second,CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t) \r\n\t\t\t\tTHEN 1\r\n\t\t\t\tWHEN GETDATE()\r\n\t\t\t\t\tBETWEEN DATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t- @OperationWarningRangeTime_Second,\r\n\t\t\t\t\t\t\t\t\tDATEADD(SECOND,- @MinimumDeliveryTime_Second,CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t) AND DATEADD(SECOND,- @MinimumDeliveryTime_Second,CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\t\t\t\tTHEN 3\r\n\t\t\t\tWHEN GETDATE() \u003E DATEADD(SECOND,- @MinimumDeliveryTime_Second,CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\t\t\t\tTHEN 4\r\n\t\t\tEND AssignmentStatus,\r\n\t\t\tDATEDIFF(SECOND,GETDATE(),CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\t\t\tremainedToDeadlineSeconds\r\n\t--\tINTO #AllDispatchRequests\r\n\tINTO #CTE_AllDispatchRequests\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\tON dspId.StoreId = s.Id\r\n\t\tINNER JOIN CS_OrderManagement.OM.Parcel p (NOLOCK)\r\n\t\t\tON ddr.ParcelReferenceCode = p.ParcelReferenceCode\r\n\t\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\t\tON p.CourierRequestId = cr.Id\r\n\t\tINNER JOIN #PolygonId pID\r\n\t\t\tON dp.Id = pID.Id\r\n\t\tINNER JOIN #CityId cID\r\n\t\t\tON dp.CityId = cID.Id\r\n\t\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\t\tON s.OrderCategoryId = oc.Id\r\n\t\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\t\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n        AND ddr.DeliveryStartTime \u003E= @StartDeliveryTime AND ddr.DeliveryDeadLineTime \u003C= @EndDeliveryTime\r\n\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\tAND ( ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\t\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\t\tAND ((@IsConfirmed = 1 AND cr.ConfirmationDate IS NOT NULL) OR (@IsConfirmed = 0 AND cr.ConfirmationDate IS NULL) OR @IsConfirmed IS NULL )\r\n\t\tAND ddr.DispatchRequestStatusId in (5 /*submitted*/,6 /*Reassignment Requested*/,7)\r\n\t\tAND ddr.CourierRequestTypeId \u003C\u003E 51\r\n\t\tAND\r\n\t\t(\r\n\t\t\t(ps.StoreId = @StoreId)\r\n\t\t\tOR (ISNULL(@StoreId, 0) = 0)\r\n\t\t)\r\n\t\tAND\r\n\t\t(\r\n\t\t\t(ddr.ParcelReferenceCode = @ParcelReferenceCode)\r\n\t\t\tOR (ISNULL(@ParcelReferenceCode, 0) = 0)\r\n\t\t)\r\n\t\tAND\r\n\t\t(\r\n\t\t\t(DeliveryStartTime\r\n\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t)\r\n\t\t\tOR (DeliveryDeadLineTime\r\n\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t)\r\n\t\t\tOR\r\n\t\t\t(\r\n\t\t\t\t(DeliveryStartTime \u003C @StartDeliveryTime)\r\n\t\t\t\tAND (DeliveryDeadLineTime \u003E @EndDeliveryTime)\r\n\t\t\t)\r\n\t\t\tOR\r\n\t\t\t(\r\n\t\t\t\tISNULL(@StartDeliveryTime, 0) = 0\r\n\t\t\t\tAND ISNULL(@EndDeliveryTime, 0) = 0\r\n\t\t\t)\r\n\t\t)\r\n\t\tAND\r\n\t\t(\r\n\t\t\tddr.VendorParcelCode = @VendorParcelCode\r\n\t\t\tOR ISNULL(@VendorParcelCode, \u0027\u0027) = \u0027\u0027\r\n\t\t)\r\n\tORDER BY \r\n\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t@OrderByReplace \r\n\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\tEND,\r\n\tAssignmentStatus DESC,\r\n\tRemainedToDeadlineSeconds ASC\r\n\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\t\r\n\t\r\n\t\t/**************************************************AllShipmentDestinationPoint*/\r\n\t\r\n\t;WITH CTE_FleetPreAssignmentStateCount AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tdr.DispatchRequestId,\r\n\t\t\tCOUNT(DISTINCT LEFT(fas.CreateDate,12)) fleetPreAssignmentStateCount\r\n        FROM DP.FleetPreAssignmentStateLog fas WITH(NOLOCK)\r\n\t\tINNER JOIN #CTE_AllDispatchRequests dr\r\n\t\t\tON fas.DispatchRequestId = dr.DispatchRequestId\r\n\t\t\tAND fas.DeliveryServiceProviderId = 1\r\n\t\t\tAND fas.AssignmentFailureReasonId NOT IN ( 100,105 )\r\n\t\t\tAND fas.CreateDate \u003E= @StartDeliveryTime\r\n\t\tGroup By dr.DispatchRequestId\r\n\t),CTE_Att AS\r\n\t(\r\n\t\tSELECT\r\n\t\t\tDispatchRequestId,\r\n\t\t\t\u0027[\u0027\u002BSTRING_AGG(DispatchRequestAttributeAllowedValueId,\u0027,\u0027)\u002B\u0027]\u0027 AS DispatchRequestAttributeAllowedValueIds\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT DISTINCT\r\n\t\t\t\tdr.DispatchRequestId,\r\n\t\t\t\tdrav.DispatchRequestAttributeAllowedValueId\r\n\t\t\tFROM DP.DispatchRequestAttributeValue drav WITH(NOLOCK)\r\n\t\t\tINNER JOIN #CTE_AllDispatchRequests dr\r\n\t\t\t\tON drav.DispatchRequestId = dr.DispatchRequestId\r\n\t\t) SQ\r\n\t\tGroup BY DispatchRequestId\r\n\t)\r\n\tSELECT \r\n\t\t\t\t\tdr.DispatchRequestId\t\t\t\t\tId,\r\n\t\t\t\t\tdr.DispatchRequestStatusId\t\t\t\tdispatchRequeststatusId,\r\n\t\t\t\t\tdr.dispatchRequestStatusTitle\t\t\t,\r\n\t\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\t\tdr.VendorParcelCode,\r\n\t\t\t\t\tdr.CourierRequestTypeId\t\t\t\t\tcourierRequestTypeId,\r\n\t\t\t\t\tdr.CityId,\r\n\t\t\t\t\tdr.polygonId,\r\n\t\t\t\t\tdr.polygonTitle,\r\n\t\t\t\t\tdr.storeId,\r\n\t\t\t\t\tdr.StoreLocation_Latitude\t\t\t\tstoreLocation_Lat,\r\n\t\t\t\t\tdr.StoreLocation_Longitude\t\t\t\tstoreLocation_Long,\r\n\t\t\t\t\tdr.storeTitle,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\t\t--select [dbo].[GetFleetPreAssignmentStateCount](dr.DispatchRequestId)\r\n\t\t\t\t\t\t--SELECT \r\n      --                          COUNT(*)\r\n      --                  FROM \r\n      --                  (\r\n      --                      SELECT DeliveryServiceProviderId , LEFT(fas.CreateDate,12) CreateDate\r\n      --                      FROM DP.DispatchRequestFleetPreAssignmentState drfpas \r\n\t\t\t\t\t\t--\tINNER JOIN DP.FleetPreAssignmentState fas WITH(NOLOCK) \t\t\t\t\t\r\n\t\t\t\t\t\t--\t\tON drfpas.FleetPreAssignmentStateId = fas.Id\r\n      --                      WHERE drfpas.DispatchRequestId= dr.DispatchRequestId\r\n\t\t\t\t\t\t--\tAND drfpas.DeliveryServiceProviderId = 1\r\n      --                      AND fas.AssignmentFailureReasonId NOT IN ( 100,105 )\r\n\t\t\t\t\t\t--\tGroup BY \r\n\t\t\t\t\t\t--\t\tDeliveryServiceProviderId,\r\n\t\t\t\t\t\t--\t\tLEFT(fas.CreateDate,12) \r\n      --                  )UnsuccessfulCount\r\n\t\t\t\t\t\tfpasc.fleetPreAssignmentStateCount\r\n\t\t\t\t\t),0) fleetPreAssignmentStateCount,\r\n\t\t\t\t\tremainedToDeadlineSeconds,\r\n\t\t\t\t\tFORMAT(dr.DeliveryStartTime, \u0027####-##-## ##:##:##\\.###\u0027)\t\t\tdeliveryStartTimeStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryStartTimePersian, \u0027####/##/## ##:##:##\\.###\u0027)\t\tdeliveryStartTimePersianStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027)\t\t\tdeliveryDeadLineTimeStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryDeadLineTimePersian, \u0027####/##/## ##:##:##\\.###\u0027)\tdeliveryDeadLineTimePersianStr,\r\n\t\t\t\t\tdr.ClientAddress,\r\n\t\t\t\t\tdr.clientlocation_Lat,\r\n\t\t\t\t\tdr.clientlocation_Long,\r\n\t\t\t\t\tAssignmentStatus,\r\n\t\t\t\t\tdr.OperationStaffId\t   ,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\t--dr.DeliveryServiceProviderId,\r\n\t\t\t\t\tdr.VendorId,\r\n\t\t\t\t\tv.BrandName AS VendorBrandName,\r\n\t\t\t\t\t--dsprm.DeliveryServiceProviderOrderId,\r\n\t\t\t\t\tdr.IsConfirmed,\r\n\t\t\t\t\tdr.orderCategoryId,\r\n\t\t\t\t\tdr.orderCategoryTitle,\r\n\t\t\t\t\tdr.availableServiceProviderIds,\r\n\t\t\t\t\tdr.[version],\r\n\t\t\t\t\tatt.DispatchRequestAttributeAllowedValueIds\r\n\t\t\tFROM #CTE_AllDispatchRequests dr\r\n\t\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\t\tON dr.VendorId = v.Id\t\r\n\t\t\tLEFT JOIN CTE_FleetPreAssignmentStateCount fpasc\r\n\t\t\t\tON dr.DispatchRequestId = fpasc.DispatchRequestId\r\n\t\t\tLEFT JOIN CTE_Att att\r\n\t\t\t\tON dr.DispatchRequestId = att.DispatchRequestId\r\n\r\n\tORDER BY \r\n\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t@OrderByReplace \r\n\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\tEND,\r\n\tAssignmentStatus DESC,\r\n\tRemainedToDeadlineSeconds ASC\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027));\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\r\n\tSET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\n\t/*\r\n\tSET @sql = \u0027\r\n\t\t\t\t\tSELECT cte.id,\r\n                           cte.dispatchRequeststatusId,\r\n                           cte.dispatchRequeststatusTitle,\r\n                           cte.parcelReferenceCode,\r\n                           cte.vendorParcelCode,\r\n                           cte.courierRequestTypeId,\r\n                           cte.cityId,\r\n                           cte.polygonId,\r\n                           cte.polygonTitle,\r\n                           cte.storeId,\r\n                           cte.storeLocation_Lat,\r\n\t\t\t\t\t\t   cte.storeLocation_Long,\r\n                           cte.storeTitle,\r\n                           cte.fleetPreAssignmentStateCount,\r\n                           cte.remainedToDeadlineSeconds,\r\n\t\t\t\t\t\t   cte.deliveryStartTimeStr,\r\n                           cte.deliveryStartTimePersianStr,\r\n                           cte.deliveryDeadLineTimePersianStr,\r\n\t\t\t\t\t\t   cte.deliveryDeadLineTimeStr,\r\n                           cte.clientAddress,\r\n                           cte.clientlocation_Lat,\r\n\t\t\t\t\t\t   cte.clientlocation_Long,\r\n                           cte.assignmentStatus,\r\n                           cte.operationStaffId\r\n\r\n\t\t\t\t\tFROM #cte AS CTE \r\n\t\t\t\t\tORDER BY \u0027 \u002B\r\n\t\t\t\t\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\t\t\t\u002B  @OrderByReplace \u002B \u0027 , \u0027\r\n\t\t\t\t\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\u002B \u0027 AssignmentStatus DESC,\r\n\t\t\t\t\tRemainedToDeadlineSeconds ASC\r\n\t\t\t\t\tOFFSET (\u0027 \u002B CAST(@pageIndex * @pageSize AS NVARCHAR(10)) \u002B \u0027) ROWS FETCH NEXT \u0027\u002B CAST(@pageSize AS NVARCHAR(10))\u002B \u0027ROWS ONLY\r\n\r\nSET @delayedDeliveryRequestCount\t\t\t\t=(SELECT DelayedDeliveryCount\t\t\t\t\t\tFROM #DelayedDeliveryCount)\t\t\t\t\t\r\nSET @assignedDispatchRequestCount\t\t\t\t=(SELECT Assigned_DispatchRequestCount\t\t\t\tFROM #Assigned_DispatchRequestCount)\t\r\nSET @returnedRequestCount\t\t\t\t\t\t=(SELECT ReturnedCount\t\t\t\t\t\t\t\tFROM #ReturnedCount)\t\t\t\t\t\t\t\t\t\r\nSET @delayedPickupCount\t\t\t\t\t\t\t=(SELECT DelayedPickupCount\t\t\t\t\t\t\tFROM #DelayedPickupCount)\t\r\nSET @UnassignedReturnAndReplacementRequestCount =(SELECT UnassignedReturnAndReplacementRequestCount FROM #UnassignedReturnAndReplacementRequestCount)\r\nSELECT @TotalCount = COUNT(CTE.ID) FROM #cte AS CTE \r\n\r\n\u0027\r\n\t\r\n--\tPRINT @sql\t\r\n\tDECLARE @Param NVARCHAR(4000) =\t\u0027\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\tINT,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@CourierRequestTypeIds\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n\t\t\t\t\t\t\t\t\t\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),\r\n\t\t\t\t\t\t\t\t\t\t@StartDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@EndDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t= NULL,\t\r\n\t\t\t\t\t\t\t\t\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedDeliveryRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@assignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@returnedRequestCount\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\tOUTPUT\r\n\r\n\t\t\t\t\t\t\t\t\t\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL @sql,@Param,\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\t= @OperationStaffId,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\t= @CityIds,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\t= @PolygonIds,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\t= @StoreId,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\t= @ParcelReferenceCode,\r\n\t\t\t\t\t\t\t\t\t\t@CourierRequestTypeIds\t\t\t\t\t\t= @CourierRequestTypeIds,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\t= @OperationWarningRangeTime,\r\n\t\t\t\t\t\t\t\t\t\t@MinimumDeliveryTime\t\t\t\t\t\t= @MinimumDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@StartDeliveryTime\t\t\t\t\t\t\t= @StartDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@EndDeliveryTime\t\t\t\t\t\t\t= @EndDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\t= @VendorParcelCode,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\t= @OrderBy,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\t= @IsASC,\t\r\n\t\t\t\t\t\t\t\t\t\t@TotalCount\t\t\t\t\t\t\t\t\t= @TotalCount OUTPUT,\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@delayedDeliveryRequestCount\t\t\t\t= @delayedDeliveryRequestCount\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@assignedDispatchRequestCount\t\t\t\t= @assignedDispatchRequestCount\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@returnedRequestCount\t\t\t\t\t\t= @returnedRequestCount\t\t\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedPickupCount\t\t\t\t\t\t\t= @delayedPickupCount\t\t\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount = @UnassignedReturnAndReplacementRequestCount\tOUTPUT\r\n*/\r\n\r\n"},{"Name":"Get_UnassignedDispatchRequests_By_Filter_HAMID","Schema":"dbo","Definition":"\r\n/*\r\ndeclare @delayedDeliveryRequestCount\t\t\t\tINT=0\r\ndeclare @assignedDispatchRequestCount\t\t\t\tINT=0\r\ndeclare @returnedRequestCount\t\t\t\t\t\tINT=0\r\ndeclare @delayedPickupCount\t\t\t\t\t\t\tINT=0\r\ndeclare @UnassignedReturnAndReplacementRequestCount\tINT=0\r\ndeclare @UnassignedDispatchRequestCount\t\t\t\tINT=0\r\nDECLARE @TotalCount\t\t\t\t\t\t\t\t\tINT=0\r\n\r\nexec [Get_UnassignedDispatchRequests_By_Filter] \r\n\t\t\t @OperationStaffId=53\r\n\t\t\t,@StartDeliveryTime=20230111000000000\r\n\t\t\t,@EndDeliveryTime  =20230113134212985\r\n\t\t\t,@OperationWarningRangeTime=\u002701:01\u0027\r\n\t\t\t,@MinimumDeliveryTime=\u002701:01\u0027\r\n\t\t\t,@PageIndex = 25\r\n\t\t\t,@PageSize = 5\r\n\t\t\t,@delayedDeliveryRequestCount\t\t\t\t=@delayedDeliveryRequestCount\t\t\t\t\tOUTPUT\r\n\t\t\t,@assignedDispatchRequestCount\t\t\t\t=@assignedDispatchRequestCount\t\t\t\t\tOUTPUT\r\n\t\t\t,@returnedRequestCount\t\t\t\t\t\t=@returnedRequestCount\t\t\t\t\t\t\tOUTPUT\r\n\t\t\t,@delayedPickupCount\t\t\t\t\t\t=@delayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\t\t\t,@UnassignedReturnAndReplacementRequestCount=@UnassignedReturnAndReplacementRequestCount\tOUTPUT\r\n\t\t\t,@UnassignedDispatchRequestCount\t\t\t=@UnassignedDispatchRequestCount\t\t\t\tOUTPUT\r\n\t\t\t,@TotalCount\t\t\t\t\t\t\t\t=@TotalCount\r\n\r\nSELECT\t\t@delayedDeliveryRequestCount,\r\n\t\t\t@assignedDispatchRequestCount,\r\n\t\t\t@returnedRequestCount,\r\n\t\t\t@delayedPickupCount,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t@UnassignedDispatchRequestCount,\r\n\t\t\t@TotalCount\r\n\t\t\t\r\n*/\r\nCREATE           PROCEDURE [dbo].[Get_UnassignedDispatchRequests_By_Filter_HAMID]\r\n   -- declare\r\n    @OperationStaffId\t\t\t\t\t\t\tINT,\r\n    @CityIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t= NULL, --@CityId--SMALLINT=CityIds--VARCHAR(200)\r\n    @PolygonIds\t\t\t\t\t\t\t\t\tVARCHAR(MAX)\t= NULL,\r\n    @StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,\r\n    @ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @CourierRequestTypeIds\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n    @OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n    @MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),\r\n    @StartDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @EndDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t= NULL,\r\n\t@VendorID\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,\r\n\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t@DeliveryServiceProviderIds\t\t\t\t\tVARCHAR(MAX)\t= NULL,\r\n\t@IsConfirmed\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t@OrderCategoryIds\t\t\t\t\t\tVARCHAR(MAX)\t\t= NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t= NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t/**********************************************/\r\n\t@delayedDeliveryRequestCount\t\t\t\tINT\t\t\t\t= 0 OUTPUT,\r\n\t@assignedDispatchRequestCount\t\t\t\tINT\t\t\t\t= 0 OUTPUT,\r\n\t@returnedRequestCount\t\t\t\t\t\tINT\t\t\t\t= 0 OUTPUT,\r\n\t@delayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\t= 0 OUTPUT,\r\n\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\t= 0 OUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT\t\t\t\t= 0 OUTPUT,\r\n\t@NotPickUpRequestCount\t\t\t\t\t\tINT\t\t\t\t= 0 OUTPUT\r\n\t/**********************************************/\r\n    --@Result\t\t\t\t\t\t\t\tNVARCHAR(MAX)\tOUTPUT\r\nAS\r\n\r\n\tset nocount on;\r\n\t\r\n\tSET @CityIds        = ISNULL(@CityIds,\u00270\u0027)        \r\n    SET @PolygonIds = ISNULL(@PolygonIds,\u00270\u0027)        \r\n    SET @StoreId        = ISNULL(@StoreId,0)\r\n\tSET @DeliveryServiceProviderIds = ISNULL(@DeliveryServiceProviderIds,\u00270\u0027)\r\n\tSET @CourierRequestTypeIds = ISNULL(@CourierRequestTypeIds,\u00270\u0027)\r\n\tSET @OrderCategoryIds = ISNULL(@OrderCategoryIds,\u00270\u0027)\r\n\r\n\tSELECT \r\n\t\tcpc.StoreId,\r\n\t\t\u0027[\u0027 \u002BSTRING_AGG(DeliveryServiceProviderId,\u0027,\u0027) WITHIN GROUP (ORDER BY DeliveryServiceProviderId ASC)\u002B\u0027]\u0027 AS availableServiceProviderIds\r\n\tINTO #DeliveryServiceProviderId\r\n\tFROM DP.CoefficientProviderConfig cpc (NOLOCK)\r\n\tINNER JOIN string_split(@DeliveryServiceProviderIds,\u0027,\u0027) ss\r\n\t\tON cpc.Id = ss.value\r\n\t\tOR @DeliveryServiceProviderIds = \u00270\u0027\r\n\tWHERE cpc.IsActive = 1\r\n\tGroup By cpc.StoreId\r\n\r\n\r\n\tCREATE INDEX IX_#DeliveryServiceProviderId ON #DeliveryServiceProviderId \r\n\t(\r\n\t\tStoreId\r\n\t)\r\n\t--select \r\n\t--@OperationStaffId=42 ,\r\n\t--@CityIds=NULL, \r\n\t--@PolygonIds=\u0027\u0027, \r\n\t--@StoreId=0, \r\n\t--@ParcelReferenceCode=0, \r\n\t--@CourierRequestTypeIds=\u0027\u0027, \r\n\t--@StartDeliveryTime=NULL, \r\n\t--@EndDeliveryTime=NULL, \r\n\t--@VendorParcelCode=NULL, \r\n\t--@MinimumDeliveryTime=\u002700:19:00\u0027, \r\n\t--@OperationWarningRangeTime=\u002700:02:00\u0027, \r\n\t--@OrderBy=\u0027\u0027, \r\n\t--@IsAsc=\u0027False\u0027\r\n\r\n\tdeclare \r\n\t\t@sql nvarchar(max)\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\r\n\r\n\tDROP TABLE IF EXISTS #PolygonId ,#CityId , #CourierRequestTypeId\r\n\r\n\tSELECT p.Id\r\n\tINTO #PolygonId\r\n\tFROM STRING_SPLIT(@PolygonIds, \u0027,\u0027) ss\r\n\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\tON ss.value = p.Id\r\n\t\tOR @PolygonIds = \u00270\u0027\r\n\r\n\r\n\t--DECLARE @CityId TABLE\r\n\t--(\r\n\t--\tId SMALLINT\r\n\t--);\r\n\t--INSERT INTO @CityId\r\n\t--SELECT value\r\n\t--FROM STRING_SPLIT(@CityIds, \u0027,\u0027);\r\n\r\n\tSELECT c.Id\r\n\tINTO #CityId\r\n\tFROM STRING_SPLIT(@CityIds, \u0027,\u0027) ss\r\n\tINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\t\tON ss.value = c.Id\r\n\t\tOR @CityIds = \u00270\u0027\r\n\r\n\r\n\t--DECLARE @CourierRequestTypeId TABLE\r\n\t--(\r\n\t--\tId TINYINT\r\n\t--);\r\n\t--INSERT INTO @CourierRequestTypeId\r\n\t--SELECT value\r\n\t--FROM STRING_SPLIT(@CourierRequestTypeIds, \u0027,\u0027);\r\n\r\n\tSELECT crt.Id\r\n\tINTO #CourierRequestTypeId\r\n\tFROM STRING_SPLIT(@CourierRequestTypeIds, \u0027,\u0027) ss\r\n\tINNER JOIN CS_Public.[PUB].[CourierRequestType] crt\r\n\t\tON ss.value = crt.Id\r\n\t\tOR @CourierRequestTypeIds = \u00270\u0027\r\n\tSELECT\r\n\t\toc.Id\r\n\tINTO #OrderCategoryId\r\n\tFROM CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\tINNER JOIN string_split(@OrderCategoryIds,\u0027,\u0027) ss\r\n\t\tON oc.Id = ss.value\r\n\t\tOR @OrderCategoryIds = \u00270\u0027\r\n\r\n\tIF (@StartDeliveryTime \u003C\u003E 0)\r\n\t   AND (@EndDeliveryTime \u003C\u003E 0)\r\n\t   AND dbo.FN_DateDiff(@StartDeliveryTime, @EndDeliveryTime) \u003E 31\r\n\tBEGIN\r\n\t\t--SET @Result = -1;\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\tIF @StartDeliveryTime IS NOT NULL AND @EndDeliveryTime IS NULL \r\n\t\tSET @EndDeliveryTime = @StartDeliveryTime \u002B 100000000000\r\n\tELSE IF @StartDeliveryTime IS NULL AND @EndDeliveryTime IS NOT NULL\r\n\t\tSET @StartDeliveryTime = @EndDeliveryTime - 100000000000\r\n\t\r\n\t/**************************************************/\r\n\tDECLARE @Today INT= CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\t/**************************************************/\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027)\r\n\r\n\t/**************************************************/\r\n\t--DROP TABLE IF EXISTS #ActiveShipmentCount\r\n\t--DROP TABLE IF EXISTS #TotalCount\r\n\tDROP TABLE IF EXISTS #AllDispatchRequests\r\n\tDROP TABLE IF EXISTS #AllShipmentDestinationPoint\r\n\tDROP TABLE IF EXISTS #ReturnedCount\r\n\tDROP TABLE IF EXISTS #DelayedPickupCount\r\n\tDROP TABLE IF EXISTS #DelayedDeliveryCount\r\n\t/**************************************************AllDispatchRequests*/\r\n--\tSET @NotPickupRequestCount = NULL\r\n--\tSET @DelayedPickupCount = NULL\r\n--\tSET @ReturnedRequestCount = NULL\r\n--\tSET @AssignedDispatchRequestCount = NULL\r\n--\tSET @UnassignedDispatchRequestCount = NULL\r\n--\tSET @UnassignedReturnAndReplacementRequestCount = NULL\r\n--\tSET @delayedDeliveryRequestCount = NULL\r\n\t\r\n--\tEXEC Get_OperationPanel_Count\r\n--\t\t@OperationStaffId = @OperationStaffId,\r\n--\t\t@CityIds = @CityIds,\r\n--\t\t@PolygonIds = @PolygonIds,\r\n--\t\t@VendorID = @VendorID,\r\n--\t\t@UnassignedDispatchRequestCount\t\t\t\t = @UnassignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n--\t\t@AssignedDispatchRequestCount\t\t\t\t = @AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n--\t\t@ReturnedRequestCount\t\t\t\t\t\t = @ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n--\t\t@DelayedDeliveryCount\t\t\t\t\t\t = @delayedDeliveryRequestCount\t\t\t\t\tOUTPUT,\r\n--\t\t@UnassignedReturnAndReplacementRequestCount  = @UnassignedReturnAndReplacementRequestCount\tOUTPUT,\r\n--\t\t@NotPickupRequestCount\t\t\t\t\t\t = @NotPickupRequestCount\t\t\t\t\t\tOUTPUT,\r\n--\t\t@DelayedPickupCount\t\t\t\t\t\t\t = @DelayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\r\n--SELECT \r\n--\t@UnassignedDispatchRequestCount = ISNULL(@UnassignedDispatchRequestCount,0),\t\t\t\r\n--\t@AssignedDispatchRequestCount = ISNULL(@AssignedDispatchRequestCount,0),\t\t\t\t\r\n--\t@ReturnedRequestCount = ISNULL(@ReturnedRequestCount,0),\t\t\t\t\t\r\n--\t@delayedDeliveryRequestCount = ISNULL(@delayedDeliveryRequestCount,0),\t\t\t\t\t\t\r\n--\t@UnassignedReturnAndReplacementRequestCount = ISNULL(@UnassignedReturnAndReplacementRequestCount,0),\t\r\n--\t@NotPickupRequestCount = ISNULL(@NotPickupRequestCount,0),\t\t\t\t\t\t\r\n--\t@DelayedPickupCount = ISNULL(@DelayedPickupCount,0)\t\t\t\t\t\t\t\r\n\r\n\t\r\n\t;WITH CTE_AllDispatchRequests AS\r\n\t(\r\n\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tLEFT(ddr.DeliveryStartTime,8)\tDeliveryStartTime_Date,\r\n\t\t\tDeliveryStartTime,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode,\r\n\t\t\tpos.OperationStaffId,\r\n\t\t\tdrs.title\t\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t--s.Location.STY\t\t\t\t\tStoreLocation_Latitude,\r\n\t\t\t--s.Location.STX\t\t\t\t\tStoreLocation_Longitude,\r\n\t\t\t\r\n\t\t\t--ddr.ClientLocation.STY\t\t\tclientlocation_Lat,\r\n\t\t\t--ddr.ClientLocation.STX\t\t\tclientlocation_Long,\r\n\r\n\t\t\t--CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)DeliveryDeadLineTime_DateTime,\r\n\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\t--ddr.DeliveryStartTimePersian, \r\n\t\t\t--ddr.DeliveryDeadLineTimePersian,\r\n\t\t\t--ddr.ClientAddress,\r\n\t\t\t--ddr.IsExclusiveDelivery,\r\n\t\t\t--ddr.IsNightly,\r\n\t\t\tddr.IsWaitingForSupport\r\n--\tINTO #AllDispatchRequests\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\tON dspId.StoreId = s.Id\r\n\tINNER JOIN CS_OrderManagement.OM.Parcel p (NOLOCK)\r\n\t\tON ddr.ParcelReferenceCode = p.ParcelReferenceCode\r\n\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\tON p.CourierRequestId = cr.Id\r\n\tINNER JOIN #PolygonId pID\r\n\t\tON dp.Id = pID.Id\r\n\tINNER JOIN #CityId cID\r\n\t\tON dp.CityId = cID.Id\r\n\tINNER JOIN #OrderCategoryId ocID\r\n\t\tON s.OrderCategoryId = ocID.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n    AND ddr.DeliveryStartTime \u003E= @StartDeliveryTime AND ddr.DeliveryDeadLineTime \u003C= @EndDeliveryTime\r\n\t--AND (dp.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n    --and (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\tAND ( ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\tAND ((@IsConfirmed = 1 AND cr.ConfirmationDate IS NOT NULL) OR (@IsConfirmed = 0 AND cr.ConfirmationDate IS NULL) OR @IsConfirmed IS NULL )\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t\r\n\t/**************************************************AllShipmentDestinationPoint*/\r\n\t), CTE_AllShipmentDestinationPoint AS\r\n\t(\r\n\t\tSELECT\tDISTINCT ddr.DispatchRequestId,\r\n\t\t\t\t--DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))EstimatedArrivalTime,\r\n\t\t\t\tCASE WHEN (ddr.DispatchRequestStatusId in (10,11,15,16) AND sdp.OperationTypeId = 5)  THEN 1 ELSE 0 END AS DelayedPickupCount,\r\n\t\t\t\tCASE WHEN (sdp.OperationTypeId = 10 AND ddr.DispatchRequestStatusId IN (20,25)) THEN 1 ELSE 0 END DelayedDeliveryCount\r\n\t\t--INTO #AllShipmentDestinationPoint\r\n\t\tFROM dP.Shipment(NOLOCK) ds\r\n\t\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON ds.Id=sdp.ShipmentId\r\n\t\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t\tINNER JOIN CTE_AllDispatchRequests ddr\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdpdr.DispatchRequestId\r\n\t\tWHERE DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= GETDATE()\r\n\t\tAND\r\n\t\t(\r\n\t\t\t\t(ddr.DispatchRequestStatusId in (10,11,15,16) AND sdp.OperationTypeId = 5)\r\n\t\t\tOR\t(sdp.OperationTypeId = 10 AND ddr.DispatchRequestStatusId IN (20,25))\r\n\t\t)\r\n\t--option(maxdop 4);\r\n\t)\r\n\r\n\tSELECT\r\n\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT UnassignedDispatchRequestCount) ,\r\n\t\t@assignedDispatchRequestCount = COUNT(DISTINCT Assigned_DispatchRequestCount) ,\r\n\t\t@returnedRequestCount = COUNT(DISTINCT ReturnedCount) ,\r\n\t\t@delayedPickupCount = COUNT(DISTINCT DelayedPickupCount) ,\r\n\t\t@delayedDeliveryRequestCount = COUNT(DISTINCT DelayedDeliveryCount) ,\r\n\t\t@UnassignedReturnAndReplacementRequestCount = COUNT(DISTINCT UnassignedReturnAndReplacementRequestCount) ,\r\n\t\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tCASE\r\n\t\t\t\tWHEN dr.CourierRequestTypeId IN (26,30,35,40,45,50) AND dr.DispatchRequestStatusId IN (5) \r\n\t\t\t\tTHEN dr.DispatchRequestId ELSE NULL \r\n\t\t\tEND AS UnassignedReturnAndReplacementRequestCount,\r\n\r\n\t\t\tCASE \r\n\t\t\t\tWHEN dr.DispatchRequestStatusId IN (5,6,7) AND dr.DeliveryStartTime_Date = @Today \r\n\t\t\t\tTHEN dr.DispatchRequestId ELSE NULL \r\n\t\t\tEND AS UnassignedDispatchRequestCount,\r\n\r\n\t\t\t-- CASE\r\n\t\t\t-- \tWHEN dr.DeliveryDeadLineTime \u003E= @ToDate\r\n\t\t\t-- \tTHEN\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t\t\t( dr.DispatchRequestStatusId NOT IN (30,35,100) and dr.CourierRequestTypeId = 25 )\r\n\t\t\t\t\t\t\tOR\t( dr.DispatchRequestStatusId in (45,46,47,48,49) and dr.CourierRequestTypeId in (5,10,15) )\r\n\t\t\t\t\t\tTHEN dr.DispatchRequestId \r\n\t\t\t\t\t\tELSE NULL \r\n\t\t\t\t-- \tEND\r\n\t\t\t\t-- ELSE NULL \r\n\t\t\tEND AS ReturnedCount,\r\n\r\n\t\t\tCASE \r\n\t\t\t\tWHEN dr.DispatchRequestStatusId IN(10,11,15,16,20,25,45,46,47,48,49,50,51,52,53,54)\r\n\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND AS Assigned_DispatchRequestCount,\r\n\r\n\t\t\tCASE \r\n\t\t\t\tWHEN sdp.DelayedPickupCount = 1\r\n\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND\tAS DelayedPickupCount,\r\n\r\n\t\t\tCASE \r\n\t\t\t\tWHEN sdp.DelayedDeliveryCount = 1\r\n\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND\tAS DelayedDeliveryCount,\r\n\t\t\t\t\tCASE \r\n\t\t\tWHEN \r\n\t\t\t\tdr.IsWaitingForSupport = 1 \r\n\t\t\t\tAND dr.DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\tELSE NULL \r\n\t\tEND AS NotPickupRequestCount\r\n\t\tFROM CTE_AllDispatchRequests dr\r\n\t\tLEFT JOIN CTE_AllShipmentDestinationPoint sdp\r\n\t\t\tON dr.DispatchRequestId = sdp.DispatchRequestId\r\n\t) SQ\r\n\tOPTION(RECOMPILE,USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027))\r\n\t/***************************************************/\r\n\t--SELECT \r\n\t--\t\t@UnassignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\t--FROM #AllDispatchRequests dr\r\n\t--WHERE dr.DispatchRequestStatusId IN (5,6)\r\n\t--AND dr.DeliveryStartTime_Date = @Today\r\n\t--/***************************************************/\r\n\t--SELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tAssigned_DispatchRequestCount\r\n\t--INTO #Assigned_DispatchRequestCount\r\n\t--FROM #AllDispatchRequests ddr\r\n\t--WHERE ddr.DispatchRequestStatusId IN (10/*Assigned To Courier*/,11/*Reassigned*/,15/*Arrived at Pickup point*/,\r\n\t--\t\t\t\t\t\t\t\t\t 16/*SecondFleetArrivedAtPickupPoint*/,20/*Picked up*/,25/*Arrived at Delivery Point*/,\r\n\t--\t\t\t\t\t\t\t\t\t 45/*Cancel Response Pending*/,46/*Second Cancel Request Pending*/,50/*Cancel Request Rejected*/,\r\n\t--\t\t\t\t\t\t\t\t\t 51/*Second Cancel Request Rejected*/)\r\n\t--AND ddr.DeliveryStartTime_Date = @Today\r\n\t/***********************************************************/\t\r\n--\t\t\tSELECT COUNT( dr.ParcelReferenceCode) ReturnedCount\r\n--\tINTO #ReturnedCount\r\n--\t\tFROM #AllDispatchRequests dr\r\n--        join dp.DispatchRequestStatus drs on dr.DispatchRequestStatusId = drs.Id\r\n--        join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n--        join dp.Polygon p1 on ps.PolygonId = p1.Id\r\n--        --JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n--        join dp.Store s on ps.StoreId = s.Id\r\n\r\n--        where (\r\n--                (DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n--                OR\r\n--                (DispatchRequestStatusId in (45,46) and CourierRequestTypeId in (5,10,15))\r\n\r\n----AND p1.Id =@PolygonIds\r\n--AND dr.DeliveryDeadLineTime \u003E=@ToDate\r\n--        )\r\n        \r\n\t/***************************************************/\r\n\t--SELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tDelayedPickupCount\r\n\t--INTO #DelayedPickupCount\r\n\t--FROM #AllShipmentDestinationPoint sdp\r\n\t--INNER JOIN #AllDispatchRequests ddr ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\t--WHERE ddr.DispatchRequestStatusId in (10,11,15,16)\r\n\t----AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30\r\n\t--AND sdp.OperationTypeId = 5\r\n\t--AND GETDATE()\u003Esdp.EstimatedArrivalTime\r\n\t/***************************************************/\r\n\t--SELECT COUNT(DISTINCT dr.ParcelReferenceCode) DelayedDeliveryCount\r\n\t--INTO #DelayedDeliveryCount\r\n --   FROM #AllDispatchRequests dr\r\n\t--JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t--JOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t--WHERE sdp.OperationTypeId IN (10) \r\n\t--AND dr.DispatchRequestStatusId IN (20,25)\r\n\t--AND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\t/***************************************************/\r\n\t--SELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tUnassignedReturnAndReplacementRequestCount\r\n\t--INTO #UnassignedReturnAndReplacementRequestCount\r\n\t--FROM #AllDispatchRequests ddr\r\n\t--WHERE ddr.CourierRequestTypeId IN (26,30,35,40,45,50)\r\n\t--AND ddr.DispatchRequestStatusId IN (5)\r\n\t/***************************************************/\r\n\t\r\n\t/***********************************************************/\r\n\t\r\n\tDECLARE @OperationWarningRangeTime_Second\tINT=DATEDIFF (SECOND,0,@OperationWarningRangeTime)\r\n\tDECLARE @MinimumDeliveryTime_Second\t\t\tINT=DATEDIFF (SECOND,0,@MinimumDeliveryTime)\r\n\r\n\tSELECT @TotalCount = COUNT(ddr.Id)\r\n\t--\tINTO #AllDispatchRequests\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\tON dspId.StoreId = s.Id\r\n\t\tINNER JOIN CS_OrderManagement.OM.Parcel p (NOLOCK)\r\n\t\t\tON ddr.ParcelReferenceCode = p.ParcelReferenceCode\r\n\t\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\t\tON p.CourierRequestId = cr.Id\r\n\t\tINNER JOIN #PolygonId pID\r\n\t\t\tON dp.Id = pID.Id\r\n\t\tINNER JOIN #CityId cID\r\n\t\t\tON dp.CityId = cID.Id\r\n\t\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\t\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n        AND ddr.DeliveryStartTime \u003E= @StartDeliveryTime AND ddr.DeliveryDeadLineTime \u003C= @EndDeliveryTime        \r\n\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\tAND ( ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\t\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\t\tAND ((@IsConfirmed = 1 AND cr.ConfirmationDate IS NOT NULL) OR (@IsConfirmed = 0 AND cr.ConfirmationDate IS NULL) OR @IsConfirmed IS NULL )\r\n\t\tAND ddr.DispatchRequestStatusId in (5 /*submitted*/,6 /*Reassignment Requested*/,7)\r\n\t\t\tAND ddr.CourierRequestTypeId \u003C\u003E 51\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(ps.StoreId = @StoreId)\r\n\t\t\t\tOR (ISNULL(@StoreId, 0) = 0)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(ddr.ParcelReferenceCode = @ParcelReferenceCode)\r\n\t\t\t\tOR (ISNULL(@ParcelReferenceCode, 0) = 0)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(DeliveryStartTime\r\n\t\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t\t)\r\n\t\t\t\tOR (DeliveryDeadLineTime\r\n\t\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t\t)\r\n\t\t\t\tOR\r\n\t\t\t\t(\r\n\t\t\t\t\t(DeliveryStartTime \u003C @StartDeliveryTime)\r\n\t\t\t\t\tAND (DeliveryDeadLineTime \u003E @EndDeliveryTime)\r\n\t\t\t\t)\r\n\t\t\t\tOR\r\n\t\t\t\t(\r\n\t\t\t\t\tISNULL(@StartDeliveryTime, 0) = 0\r\n\t\t\t\t\tAND ISNULL(@EndDeliveryTime, 0) = 0\r\n\t\t\t\t)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\tddr.VendorParcelCode = @VendorParcelCode\r\n\t\t\t\tOR ISNULL(@VendorParcelCode, \u0027\u0027) = \u0027\u0027\r\n\t\t\t)\r\n\r\n\t\tSELECT\t \r\n\t\t\tddr.Id DispatchRequestId,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tLEFT(ddr.DeliveryStartTime,8)\tDeliveryStartTime_Date,\r\n\t\t\tDeliveryStartTime,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode,\r\n\t\t\tpos.OperationStaffId,\r\n\t\t\tdrs.title\t\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\tddr.CourierRequestTypeId,\r\n\t\t\ts.Location.STY\t\t\t\t\tStoreLocation_Latitude,\r\n\t\t\ts.Location.STX\t\t\t\t\tStoreLocation_Longitude,\r\n\t\t\t\r\n\t\t\tddr.ClientLocation.STY\t\t\tclientlocation_Lat,\r\n\t\t\tddr.ClientLocation.STX\t\t\tclientlocation_Long,\r\n\r\n\t\t\t--CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)DeliveryDeadLineTime_DateTime,\r\n\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\tddr.DeliveryStartTimePersian, \r\n\t\t\tddr.DeliveryDeadLineTimePersian,\r\n\t\t\tddr.ClientAddress,\r\n\t\t\tddr.IsExclusiveDelivery,\r\n\t\t\tddr.IsNightly,\r\n\t\t\tddr.DeliveryServiceProviderId,\r\n\t\t\tddr.VendorId,\r\n\t\t\tCAST(CASE WHEN cr.ConfirmationDate IS NOT NULL THEN 1 ELSE 0 END AS BIT ) AS IsConfirmed,\r\n\t\t\ts.OrderCategoryId,\r\n\t\t\toc.Title AS OrderCategoryTitle,\r\n\t\t\tdspId.availableServiceProviderIds,\r\n\t\t\tCAST(ISNULL(ddr.Version,1)\u002B1 AS INT) AS [Version],\r\n\t\t\tCASE\r\n\t\t\t\tWHEN GETDATE() \u003C DATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t\t- @OperationWarningRangeTime_Second,\r\n\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,- @MinimumDeliveryTime_Second,CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t\t) \r\n\t\t\t\tTHEN 1\r\n\t\t\t\tWHEN GETDATE()\r\n\t\t\t\t\tBETWEEN DATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t- @OperationWarningRangeTime_Second,\r\n\t\t\t\t\t\t\t\t\tDATEADD(SECOND,- @MinimumDeliveryTime_Second,CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\t\t\t\t\t\t\t\t\t) AND DATEADD(SECOND,- @MinimumDeliveryTime_Second,CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\t\t\t\tTHEN 3\r\n\t\t\t\tWHEN GETDATE() \u003E DATEADD(SECOND,- @MinimumDeliveryTime_Second,CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\t\t\t\tTHEN 4\r\n\t\t\tEND AssignmentStatus,\r\n\t\t\tDATEDIFF(SECOND,GETDATE(),CAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\t\t\tremainedToDeadlineSeconds\r\n\t\tINTO #CTE_AllDispatchRequests\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN #DeliveryServiceProviderId dspID\r\n\t\t\t\tON dspId.StoreId = s.Id\r\n\t\tINNER JOIN CS_OrderManagement.OM.Parcel p (NOLOCK)\r\n\t\t\tON ddr.ParcelReferenceCode = p.ParcelReferenceCode\r\n\t\tINNER JOIN CS_OrderManagement.OM.CourierRequest cr (NOLOCK)\r\n\t\t\tON p.CourierRequestId = cr.Id\r\n\t\tINNER JOIN #PolygonId pID\r\n\t\t\tON dp.Id = pID.Id\r\n\t\tINNER JOIN #CityId cID\r\n\t\t\tON dp.CityId = cID.Id\r\n\t\tINNER JOIN #CourierRequestTypeId crtID\r\n\t\t\tON ddr.CourierRequestTypeId = crtID.Id\r\n\t\tINNER JOIN #OrderCategoryId ocID\r\n\t\t\tON s.OrderCategoryId = ocID.Id\r\n\t\tINNER JOIN CS_UserManagement.UM.OrderCategory oc (NOLOCK)\r\n\t\t\tON s.OrderCategoryId = oc.Id\r\n\t\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\t\t--AND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n        AND ddr.DeliveryStartTime \u003E= @StartDeliveryTime AND ddr.DeliveryDeadLineTime \u003C= @EndDeliveryTime\r\n\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\tAND ( ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\t\tAND (ddr.VendorId = @VendorID OR ISNULL(@VendorID,0) = 0 ) \r\n\t\tAND ((@IsConfirmed = 1 AND cr.ConfirmationDate IS NOT NULL) OR (@IsConfirmed = 0 AND cr.ConfirmationDate IS NULL) OR @IsConfirmed IS NULL )\r\n\t\tAND ddr.DispatchRequestStatusId in (5 /*submitted*/,6 /*Reassignment Requested*/,7)\r\n\t\tAND ddr.CourierRequestTypeId \u003C\u003E 51\r\n\t\tAND\r\n\t\t(\r\n\t\t\t(ps.StoreId = @StoreId)\r\n\t\t\tOR (ISNULL(@StoreId, 0) = 0)\r\n\t\t)\r\n\t\tAND\r\n\t\t(\r\n\t\t\t(ddr.ParcelReferenceCode = @ParcelReferenceCode)\r\n\t\t\tOR (ISNULL(@ParcelReferenceCode, 0) = 0)\r\n\t\t)\r\n\t\tAND\r\n\t\t(\r\n\t\t\t(DeliveryStartTime\r\n\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t)\r\n\t\t\tOR (DeliveryDeadLineTime\r\n\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t)\r\n\t\t\tOR\r\n\t\t\t(\r\n\t\t\t\t(DeliveryStartTime \u003C @StartDeliveryTime)\r\n\t\t\t\tAND (DeliveryDeadLineTime \u003E @EndDeliveryTime)\r\n\t\t\t)\r\n\t\t\tOR\r\n\t\t\t(\r\n\t\t\t\tISNULL(@StartDeliveryTime, 0) = 0\r\n\t\t\t\tAND ISNULL(@EndDeliveryTime, 0) = 0\r\n\t\t\t)\r\n\t\t)\r\n\t\tAND\r\n\t\t(\r\n\t\t\tddr.VendorParcelCode = @VendorParcelCode\r\n\t\t\tOR ISNULL(@VendorParcelCode, \u0027\u0027) = \u0027\u0027\r\n\t\t)\r\n\t\tORDER BY \r\n\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t@OrderByReplace \r\n\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\tEND,\r\n\tAssignmentStatus DESC,\r\n\tRemainedToDeadlineSeconds ASC\r\n\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\r\n\t;WITH CTE_X AS\r\n\t(\r\n\r\n            SELECT dr.DispatchRequestId, COUNT(DISTINCT LEFT(fas.CreateDate,12)) fleetPreAssignmentStateCount\r\n            FROM DP.DispatchRequestFleetPreAssignmentState drfpas WITH(NOLOCK)\r\n\t\t\tINNER JOIN #CTE_AllDispatchRequests dr\r\n\t\t\t\tON drfpas.DispatchRequestId= dr.DispatchRequestId\r\n\t\t\tINNER JOIN DP.FleetPreAssignmentState fas WITH(NOLOCK) \t\t\t\t\t\r\n\t\t\t\tON drfpas.FleetPreAssignmentStateId = fas.Id\r\n            WHERE fas.AssignmentFailureReasonId NOT IN ( 100,105 )\r\n\t\t\tAND drfpas.DeliveryServiceProviderId = 1\t\t\t\r\n\t\t\tGroup By dr.DispatchRequestId\r\n\t)\r\n\tSELECT \r\n\t\t\t\t\tdr.DispatchRequestId\t\t\t\t\tId,\r\n\t\t\t\t\tdr.DispatchRequestStatusId\t\t\t\tdispatchRequeststatusId,\r\n\t\t\t\t\tdr.dispatchRequestStatusTitle\t\t\t,\r\n\t\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\t\tdr.VendorParcelCode,\r\n\t\t\t\t\tdr.CourierRequestTypeId\t\t\t\t\tcourierRequestTypeId,\r\n\t\t\t\t\tdr.CityId,\r\n\t\t\t\t\tdr.polygonId,\r\n\t\t\t\t\tdr.polygonTitle,\r\n\t\t\t\t\tdr.storeId,\r\n\t\t\t\t\tdr.StoreLocation_Latitude\t\t\t\tstoreLocation_Lat,\r\n\t\t\t\t\tdr.StoreLocation_Longitude\t\t\t\tstoreLocation_Long,\r\n\t\t\t\t\tdr.storeTitle,\r\n\t\t\t\t\tISNULL((\r\n\t\t\t\t\tx.fleetPreAssignmentStateCount\r\n\t\t\t\t\t),0) fleetPreAssignmentStateCount,\r\n\t\t\t\t\tremainedToDeadlineSeconds,\r\n\t\t\t\t\tFORMAT(dr.DeliveryStartTime, \u0027####-##-## ##:##:##\\.###\u0027)\t\t\tdeliveryStartTimeStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryStartTimePersian, \u0027####/##/## ##:##:##\\.###\u0027)\t\tdeliveryStartTimePersianStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027)\t\t\tdeliveryDeadLineTimeStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryDeadLineTimePersian, \u0027####/##/## ##:##:##\\.###\u0027)\tdeliveryDeadLineTimePersianStr,\r\n\t\t\t\t\tdr.ClientAddress,\r\n\t\t\t\t\tdr.clientlocation_Lat,\r\n\t\t\t\t\tdr.clientlocation_Long,\r\n\t\t\t\t\tAssignmentStatus,\r\n\t\t\t\t\tdr.OperationStaffId\t   ,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly,\r\n\t\t\t\t\t--dr.DeliveryServiceProviderId,\r\n\t\t\t\t\tdr.VendorId,\r\n\t\t\t\t\tv.BrandName AS VendorBrandName,\r\n\t\t\t\t\t--dsprm.DeliveryServiceProviderOrderId,\r\n\t\t\t\t\tdr.IsConfirmed,\r\n\t\t\t\t\tdr.orderCategoryId,\r\n\t\t\t\t\tdr.orderCategoryTitle,\r\n\t\t\t\t\tdr.availableServiceProviderIds,\r\n\t\t\t\t\tdr.[version]\r\n\t\t\tFROM #CTE_AllDispatchRequests dr\r\n\t\t\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\t\t\tON dr.VendorId = v.Id\r\n\t\t\tLEFT JOIN CTE_X x\r\n\t\t\t\tON dr.DispatchRequestId = x.DispatchRequestId\r\n\t\t\t--LEFT JOIN CTE_DSPRM dsprm\r\n\t\t\t--\tON dr.DispatchRequestId = dsprm.DispatchRequestId\r\n\t\t\t\r\n\tORDER BY \r\n\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t@OrderByReplace \r\n\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\tEND,\r\n\tAssignmentStatus DESC,\r\n\tRemainedToDeadlineSeconds ASC\r\n\r\n\tOPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027));\r\n\t--OPTION(USE HINT(\u0027ENABLE_PARALLEL_PLAN_PREFERENCE\u0027));\r\n\r\n\tSET @DelayedDeliveryRequestCount\t\t\t\t = ISNULL(@DelayedDeliveryRequestCount,0)\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @UnassignedReturnAndReplacementRequestCount  = ISNULL(@UnassignedReturnAndReplacementRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)\r\n\r\n\t/*\r\n\tSET @sql = \u0027\r\n\t\t\t\t\tSELECT cte.id,\r\n                           cte.dispatchRequeststatusId,\r\n                           cte.dispatchRequeststatusTitle,\r\n                           cte.parcelReferenceCode,\r\n                           cte.vendorParcelCode,\r\n                           cte.courierRequestTypeId,\r\n                           cte.cityId,\r\n                           cte.polygonId,\r\n                           cte.polygonTitle,\r\n                           cte.storeId,\r\n                           cte.storeLocation_Lat,\r\n\t\t\t\t\t\t   cte.storeLocation_Long,\r\n                           cte.storeTitle,\r\n                           cte.fleetPreAssignmentStateCount,\r\n                           cte.remainedToDeadlineSeconds,\r\n\t\t\t\t\t\t   cte.deliveryStartTimeStr,\r\n                           cte.deliveryStartTimePersianStr,\r\n                           cte.deliveryDeadLineTimePersianStr,\r\n\t\t\t\t\t\t   cte.deliveryDeadLineTimeStr,\r\n                           cte.clientAddress,\r\n                           cte.clientlocation_Lat,\r\n\t\t\t\t\t\t   cte.clientlocation_Long,\r\n                           cte.assignmentStatus,\r\n                           cte.operationStaffId\r\n\r\n\t\t\t\t\tFROM #cte AS CTE \r\n\t\t\t\t\tORDER BY \u0027 \u002B\r\n\t\t\t\t\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\t\t\t\u002B  @OrderByReplace \u002B \u0027 , \u0027\r\n\t\t\t\t\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\u002B \u0027 AssignmentStatus DESC,\r\n\t\t\t\t\tRemainedToDeadlineSeconds ASC\r\n\t\t\t\t\tOFFSET (\u0027 \u002B CAST(@pageIndex * @pageSize AS NVARCHAR(10)) \u002B \u0027) ROWS FETCH NEXT \u0027\u002B CAST(@pageSize AS NVARCHAR(10))\u002B \u0027ROWS ONLY\r\n\r\nSET @delayedDeliveryRequestCount\t\t\t\t=(SELECT DelayedDeliveryCount\t\t\t\t\t\tFROM #DelayedDeliveryCount)\t\t\t\t\t\r\nSET @assignedDispatchRequestCount\t\t\t\t=(SELECT Assigned_DispatchRequestCount\t\t\t\tFROM #Assigned_DispatchRequestCount)\t\r\nSET @returnedRequestCount\t\t\t\t\t\t=(SELECT ReturnedCount\t\t\t\t\t\t\t\tFROM #ReturnedCount)\t\t\t\t\t\t\t\t\t\r\nSET @delayedPickupCount\t\t\t\t\t\t\t=(SELECT DelayedPickupCount\t\t\t\t\t\t\tFROM #DelayedPickupCount)\t\r\nSET @UnassignedReturnAndReplacementRequestCount =(SELECT UnassignedReturnAndReplacementRequestCount FROM #UnassignedReturnAndReplacementRequestCount)\r\nSELECT @TotalCount = COUNT(CTE.ID) FROM #cte AS CTE \r\n\r\n\u0027\r\n\t\r\n--\tPRINT @sql\t\r\n\tDECLARE @Param NVARCHAR(4000) =\t\u0027\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\tINT,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@CourierRequestTypeIds\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n\t\t\t\t\t\t\t\t\t\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),\r\n\t\t\t\t\t\t\t\t\t\t@StartDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@EndDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t= NULL,\t\r\n\t\t\t\t\t\t\t\t\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedDeliveryRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@assignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@returnedRequestCount\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\tOUTPUT\r\n\r\n\t\t\t\t\t\t\t\t\t\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL @sql,@Param,\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\t= @OperationStaffId,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\t= @CityIds,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\t= @PolygonIds,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\t= @StoreId,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\t= @ParcelReferenceCode,\r\n\t\t\t\t\t\t\t\t\t\t@CourierRequestTypeIds\t\t\t\t\t\t= @CourierRequestTypeIds,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\t= @OperationWarningRangeTime,\r\n\t\t\t\t\t\t\t\t\t\t@MinimumDeliveryTime\t\t\t\t\t\t= @MinimumDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@StartDeliveryTime\t\t\t\t\t\t\t= @StartDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@EndDeliveryTime\t\t\t\t\t\t\t= @EndDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\t= @VendorParcelCode,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\t= @OrderBy,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\t= @IsASC,\t\r\n\t\t\t\t\t\t\t\t\t\t@TotalCount\t\t\t\t\t\t\t\t\t= @TotalCount OUTPUT,\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@delayedDeliveryRequestCount\t\t\t\t= @delayedDeliveryRequestCount\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@assignedDispatchRequestCount\t\t\t\t= @assignedDispatchRequestCount\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@returnedRequestCount\t\t\t\t\t\t= @returnedRequestCount\t\t\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedPickupCount\t\t\t\t\t\t\t= @delayedPickupCount\t\t\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount = @UnassignedReturnAndReplacementRequestCount\tOUTPUT\r\n*/\r\n\r\n"},{"Name":"Get_UnassignedDispatchRequests_By_Filter_test","Schema":"dbo","Definition":"/*\r\ndeclare @delayedDeliveryRequestCount\t\t\t\tINT=0\r\ndeclare @assignedDispatchRequestCount\t\t\t\tINT=0\r\ndeclare @returnedRequestCount\t\t\t\t\t\tINT=0\r\ndeclare @delayedPickupCount\t\t\t\t\t\t\tINT=0\r\ndeclare @UnassignedReturnAndReplacementRequestCount\tINT=0\r\ndeclare @UnassignedDispatchRequestCount\t\t\t\tINT=0\r\nDECLARE @totalcount\t\t\t\t\t\t\t\t\tINT=0\r\n\r\nexec [Get_UnassignedDispatchRequests_By_Filter] \r\n\t\t\t @OperationStaffId=53\r\n\t\t\t,@StartDeliveryTime=20230111000000000\r\n\t\t\t,@EndDeliveryTime  =20230113134212985\r\n\t\t\t,@OperationWarningRangeTime=\u002701:01\u0027\r\n\t\t\t,@MinimumDeliveryTime=\u002701:01\u0027\r\n\t\t\t,@PageIndex = 25\r\n\t\t\t,@PageSize = 5\r\n\t\t\t,@delayedDeliveryRequestCount\t\t\t\t=@delayedDeliveryRequestCount\t\t\t\t\tOUTPUT\r\n\t\t\t,@assignedDispatchRequestCount\t\t\t\t=@assignedDispatchRequestCount\t\t\t\t\tOUTPUT\r\n\t\t\t,@returnedRequestCount\t\t\t\t\t\t=@returnedRequestCount\t\t\t\t\t\t\tOUTPUT\r\n\t\t\t,@delayedPickupCount\t\t\t\t\t\t=@delayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\t\t\t,@UnassignedReturnAndReplacementRequestCount=@UnassignedReturnAndReplacementRequestCount\tOUTPUT\r\n\t\t\t,@UnassignedDispatchRequestCount\t\t\t=@UnassignedDispatchRequestCount\t\t\t\tOUTPUT\r\n\t\t\t,@totalcount\t\t\t\t\t\t\t\t=@totalcount\r\n\r\nSELECT\t\t@delayedDeliveryRequestCount,\r\n\t\t\t@assignedDispatchRequestCount,\r\n\t\t\t@returnedRequestCount,\r\n\t\t\t@delayedPickupCount,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount,\r\n\t\t\t@UnassignedDispatchRequestCount,\r\n\t\t\t@totalcount\r\n\t\t\t\r\n*/\r\nCREATE   PROCEDURE [dbo].[Get_UnassignedDispatchRequests_By_Filter_test]\r\n   -- declare\r\n    @OperationStaffId\t\t\t\t\t\t\tINT,\r\n    @CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t= NULL, --@CityId--SMALLINT=CityIds--VARCHAR(200)\r\n    @PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n    @StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,\r\n    @ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @CourierRequestTypeIds\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n    @OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n    @MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),\r\n    @StartDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @EndDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t= NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t= NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t/**********************************************/\r\n\t@delayedDeliveryRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t@assignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t@returnedRequestCount\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t@delayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\tOUTPUT,\r\n\t@UnassignedDispatchRequestCount\t\t\t\tINT = 0\t\t\tOUTPUT\r\n\t/**********************************************/\r\n    --@Result\t\t\t\t\t\t\t\tNVARCHAR(MAX)\tOUTPUT\r\nAS\r\n\r\n\t--select \r\n\t--@OperationStaffId=42 ,\r\n\t--@CityIds=NULL, \r\n\t--@PolygonIds=\u0027\u0027, \r\n\t--@StoreId=0, \r\n\t--@ParcelReferenceCode=0, \r\n\t--@CourierRequestTypeIds=\u0027\u0027, \r\n\t--@StartDeliveryTime=NULL, \r\n\t--@EndDeliveryTime=NULL, \r\n\t--@VendorParcelCode=NULL, \r\n\t--@MinimumDeliveryTime=\u002700:19:00\u0027, \r\n\t--@OperationWarningRangeTime=\u002700:02:00\u0027, \r\n\t--@OrderBy=\u0027\u0027, \r\n\t--@IsAsc=\u0027False\u0027\r\n\r\n\tdeclare \r\n\t\t@sql nvarchar(max)\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\r\n\t--@PolygonIds\r\n\tDECLARE @PolygonId TABLE\r\n\t(\r\n\t\tId SMALLINT\r\n\t);\r\n\tINSERT INTO @PolygonId\r\n\tSELECT value\r\n\tFROM STRING_SPLIT(@PolygonIds, \u0027,\u0027);\r\n\r\n\r\n\t--@CityIds\r\n\tDECLARE @CityId TABLE\r\n\t(\r\n\t\tId SMALLINT\r\n\t);\r\n\tINSERT INTO @CityId\r\n\tSELECT value\r\n\tFROM STRING_SPLIT(@CityIds, \u0027,\u0027);\r\n\r\n\r\n\t--@CourierRequestTypeIds\r\n\tDECLARE @CourierRequestTypeId TABLE\r\n\t(\r\n\t\tId TINYINT\r\n\t);\r\n\tINSERT INTO @CourierRequestTypeId\r\n\tSELECT value\r\n\tFROM STRING_SPLIT(@CourierRequestTypeIds, \u0027,\u0027);\r\n\r\n\r\n\tIF (@StartDeliveryTime \u003C\u003E 0)\r\n\t   AND (@EndDeliveryTime \u003C\u003E 0)\r\n\t   AND dbo.FN_DateDiff(@StartDeliveryTime, @EndDeliveryTime) \u003E 31\r\n\tBEGIN\r\n\t\t--SET @Result = -1;\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\tIF @StartDeliveryTime IS NOT NULL AND @EndDeliveryTime IS NULL \r\n\t\tSET @EndDeliveryTime = @StartDeliveryTime \u002B 100000000000\r\n\tELSE IF @StartDeliveryTime IS NULL AND @EndDeliveryTime IS NOT NULL\r\n\t\tSET @StartDeliveryTime = @EndDeliveryTime - 100000000000\r\n\t\r\n\t/**************************************************/\r\n\tDECLARE @Today INT= CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\t/**************************************************/\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\t/**************************************************/\r\n\t--DROP TABLE IF EXISTS #ActiveShipmentCount\r\n\t--DROP TABLE IF EXISTS #TotalCount\r\n\tDROP TABLE IF EXISTS #AllDispatchRequests\r\n\tDROP TABLE IF EXISTS #AllShipmentDestinationPoint\r\n\tDROP TABLE IF EXISTS #ReturnedCount\r\n\tDROP TABLE IF EXISTS #DelayedPickupCount\r\n\tDROP TABLE IF EXISTS #DelayedDeliveryCount\r\n\t/**************************************************AllDispatchRequests*/\r\n\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tLEFT(ddr.DeliveryStartTime,8)\tDeliveryStartTime_Date,\r\n\t\t\tDeliveryStartTime,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode,\r\n\t\t\tpos.OperationStaffId,\r\n\t\t\tdrs.title\t\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\tddr.CourierRequestTypeId,\r\n\t\t\ts.Location.STY\t\t\t\t\tStoreLocation_Latitude,\r\n\t\t\ts.Location.STX\t\t\t\t\tStoreLocation_Longitude,\r\n\t\t\t\r\n\t\t\tddr.ClientLocation.STY\t\t\tclientlocation_Lat,\r\n\t\t\tddr.ClientLocation.STX\t\t\tclientlocation_Long,\r\n\r\n\t\t\tCAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)DeliveryDeadLineTime_DateTime,\r\n\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\tddr.DeliveryStartTimePersian, \r\n\t\t\tddr.DeliveryDeadLineTimePersian,\r\n\t\t\tClientAddress,\r\n\t\t\tddr.AssignmentTryCount\r\n\tINTO #AllDispatchRequests\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t/**************************************************AllShipmentDestinationPoint*/\r\n\tSELECT\tsdp.Id\t\tShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\tsdp.OperationTypeId,\r\n\t\t\tddr.DispatchRequestId,\r\n            ddr.DispatchRequestStatusId,\r\n\t\t\tds.Id\t\tShipmentId,\r\n\t\t\tdss.Id\t\tShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tDATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))EstimatedArrivalTime\r\n\tINTO #AllShipmentDestinationPoint\r\n\tFROM dP.Shipment(NOLOCK) ds\r\n\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON ds.Id=sdp.ShipmentId\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\tINNER JOIN #AllDispatchRequests(NOLOCK) ddr\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdpdr.DispatchRequestId\r\n\t/***************************************************/\r\n\tSELECT \r\n\t\t\t@UnassignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\tFROM #AllDispatchRequests dr\r\n\tWHERE dr.DispatchRequestStatusId IN (5,6)\r\n\tAND dr.DeliveryStartTime_Date = @Today\r\n\t/***************************************************/\r\n\tSELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tAssigned_DispatchRequestCount\r\n\tINTO #Assigned_DispatchRequestCount\r\n\tFROM #AllDispatchRequests ddr\r\n\tWHERE ddr.DispatchRequestStatusId IN (10/*Assigned To Courier*/,11/*Reassigned*/,15/*Arrived at Pickup point*/,\r\n\t\t\t\t\t\t\t\t\t\t 16/*SecondFleetArrivedAtPickupPoint*/,20/*Picked up*/,25/*Arrived at Delivery Point*/,\r\n\t\t\t\t\t\t\t\t\t\t 45/*Cancel Response Pending*/,46/*Second Cancel Request Pending*/,50/*Cancel Request Rejected*/,\r\n\t\t\t\t\t\t\t\t\t\t 51/*Second Cancel Request Rejected*/)\r\n\t--AND ddr.DeliveryStartTime_Date = @Today\r\n\t/***********************************************************/\t\r\n\t\t\tSELECT COUNT( dr.ParcelReferenceCode) ReturnedCount\r\n\tINTO #ReturnedCount\r\n\t\tFROM #AllDispatchRequests dr\r\n        join dp.DispatchRequestStatus drs on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n        join dp.Polygon p1 on ps.PolygonId = p1.Id\r\n        --JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        join dp.Store s on ps.StoreId = s.Id\r\n\r\n        where (\r\n                (DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n                OR\r\n                (DispatchRequestStatusId in (45,46) and CourierRequestTypeId in (5,10,15))\r\n\r\n--AND p1.Id =@PolygonIds\r\nAND dr.DeliveryDeadLineTime \u003E=@ToDate\r\n        )\r\n        \r\n        \r\n--        \tSELECT @ReturnedRequestCount=COUNT( dr.ParcelReferenceCode)\r\n--\tFROM #AllDispatchRequests dr\r\n--        join dp.DispatchRequestStatus drs on dr.DispatchRequestStatusId = drs.Id\r\n--        join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n--        join dp.Polygon p1 on ps.PolygonId = p1.Id\r\n--        --INNER JOIN @PolygonId p2\tON p1.Id = p2.Id\r\n--        --JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n--        join dp.Store s on ps.StoreId = s.Id\r\n\r\n--        where (\r\n--                (DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n--                OR\r\n--                (DispatchRequestStatusId in (45,46) and CourierRequestTypeId in (5,10,15))\r\n--AND dr.DeliveryDeadLineTime \u003E=@ToDate)\r\n\r\n\t/*AS marziyeh said Nahale has been commented*/--SELECT COUNT(DISTINCT sdp.ShipmentDestinationPointId)\tReturnedCount\r\n\t--INTO #ReturnedCount\r\n\t--FROM #AllShipmentDestinationPoint sdp\r\n\t--WHERE ((sdp.OperationTypeId in (15))/*Return*/ or (OperationTypeId = 10 and DispatchRequestStatusId in (45,46)))\r\n\t--AND ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t/***************************************************/\r\n\tSELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tDelayedPickupCount\r\n\tINTO #DelayedPickupCount\r\n\tFROM #AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #AllDispatchRequests ddr ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tWHERE ddr.DispatchRequestStatusId in (10,11,15,16)\r\n\t--AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30\r\n\tAND sdp.OperationTypeId = 5\r\n\tAND GETDATE()\u003Esdp.EstimatedArrivalTime\r\n\t/***************************************************/\r\n\t--SELECT COUNT(DISTINCT sdp.ShipmentDestinationPointId)\tDelayedDeliveryCount\r\n\t--INTO #DelayedDeliveryCount\r\n\t--FROM #AllShipmentDestinationPoint sdp\r\n\t--WHERE sdp.OperationTypeId=10/*Delivered*/\r\n\t--AND ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t--AND GETDATE()\u003EEstimatedArrivalTime\r\n\tSELECT COUNT(DISTINCT dr.ParcelReferenceCode) DelayedDeliveryCount\r\n\tINTO #DelayedDeliveryCount\r\n    FROM #AllDispatchRequests dr\r\n\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\tJOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\tWHERE sdp.OperationTypeId IN (10) \r\n\t--AND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\\task_4021\\\r\n\tAND dr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\t/***************************************************/\r\n\tSELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tUnassignedReturnAndReplacementRequestCount\r\n\tINTO #UnassignedReturnAndReplacementRequestCount\r\n\tFROM #AllDispatchRequests ddr\r\n\tWHERE ddr.CourierRequestTypeId IN (26,30,35,40,45,50)\r\n\tAND ddr.DispatchRequestStatusId IN (5)\r\n\t/***************************************************/\r\n\t--SELECT \r\n\t--\t\tCOUNT(DISTINCT ds.Id) ActiveShipmentCount\r\n\t--INTO #ActiveShipmentCount\r\n\t--FROM dP.Shipment(NOLOCK) ds\r\n\t--INNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t--INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON ds.Id=sdp.ShipmentId\r\n\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t--INNER JOIN dp.DispatchRequest(NOLOCK) ddr\t\t\t\t\t\t\tON ddr.Id=sdpdr.DispatchRequestId\r\n\t--INNER JOIN dp.PolygonStore(NOLOCK) dps\t\t\t\t\t\t\t\tON dps.Id=ddr.PolygonStoreId\r\n\t--INNER JOIN dp.Polygon(NOLOCK) dp\t\t\t\t\t\t\t\t\tON dp.Id=dps.PolygonId\r\n\t--JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\t\t\t\t\t\tON dps.StoreId = s.Id\r\n\t--INNER JOIN dp.PolygonFleet(NOLOCK) dpf\t\t\t\t\t\t\t\tON dpf.PolygonId=dp.Id  AND dpf.IsActive=1\r\n\t--INNER JOIN dp.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=ds.FleetId AND df.IsActive=1\r\n\t--INNER JOIN dp.PolygonOperationStaff(NOLOCK) dpos\t\t\t\t\tON dpos.PolygonId=dp.Id AND dpos.IsActive=1\r\n\t--WHERE dss.Id NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t--AND dpos.OperationStaffId=@OperationStaffId\r\n\t/***********************************************************/\r\n\t\r\n\t--SELECT  COUNT(DISTINCT dr.ParcelReferenceCode) TotalCount\r\n\t--INTO #TotalCount\r\n\t--FROM DP.DispatchRequest(NOLOCK) dr\r\n\t--\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\r\n\t--\t\tON dr.DispatchRequestStatusId = drs.Id\r\n\t--\tINNER JOIN DP.PolygonStore(NOLOCK) ps\r\n\t--\t\tON ps.Id = dr.PolygonStoreId\r\n\t--\tINNER JOIN DP.Polygon(NOLOCK) dp\r\n\t--\t\tON dp.Id = ps.PolygonId\r\n\t--\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\r\n\t--\t\tON pos.PolygonId = dp.Id and pos.IsActive = 1\r\n\t--WHERE dr.DispatchRequestStatusId in(5,6) --submitted\r\n\t--\t  AND (pos.OperationStaffId = @OperationStaffId)\r\n\t--\t  AND ((dp.CityId IN (SELECT Id FROM @CityId))\t\t\t\t\t\t\t\tOR (ISNULL(@CityIds, \u00270\u0027) = \u00270\u0027))\r\n\t--\t  AND ((ps.StoreId = @StoreId)\t\t\t\t\t\t\t\t\t\t\t\tOR (ISNULL(@StoreId, 0) = 0))\r\n\t--\t  AND ((dr.ParcelReferenceCode = @ParcelReferenceCode)\t\t\t\t\t\tOR (ISNULL(@ParcelReferenceCode, 0) = 0))\r\n\t--\t  AND (dp.Id IN(SELECT Id FROM @PolygonId)\t\t\t\t\t\t\t\t\tOR (ISNULL(@PolygonIds, \u0027\u0027) = \u0027\u0027))\r\n\t--\t  AND (dr.CourierRequestTypeId IN(SELECT Id FROM @CourierRequestTypeId)\t\tOR (ISNULL(@CourierRequestTypeIds, \u0027\u0027) = \u0027\u0027))\r\n\t--\t  AND ((DeliveryStartTime BETWEEN @StartDeliveryTime AND @EndDeliveryTime)\tOR (DeliveryDeadLineTime BETWEEN @StartDeliveryTime AND @EndDeliveryTime)\r\n\t--\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tOR ((DeliveryStartTime \u003C @StartDeliveryTime) AND (DeliveryDeadLineTime \u003E @EndDeliveryTime))\r\n\t--\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tOR (ISNULL(@StartDeliveryTime, 0) = 0 AND ISNULL(@EndDeliveryTime, 0) = 0))\r\n\t--\t  AND\r\n\t--\t  (\r\n\t--\t\t  dr.VendorParcelCode = @VendorParcelCode\r\n\t--\t\t  OR ISNULL(@VendorParcelCode, \u0027\u0027) = \u0027\u0027\r\n\t--\t  );\r\n\r\n\r\n\tDECLARE @OperationWarningRangeTime_Second\tINT=DATEDIFF (SECOND,0,@OperationWarningRangeTime)\r\n\tDECLARE @MinimumDeliveryTime_Second\t\t\tINT=DATEDIFF (SECOND,0,@MinimumDeliveryTime)\r\n\r\n\tSELECT DISTINCT\r\n\t\t\t\t\tdr.DispatchRequestId\t\t\t\t\tId,\r\n\t\t\t\t\tdr.DispatchRequestStatusId\t\t\t\tdispatchRequeststatusId,\r\n\t\t\t\t\tdr.dispatchRequestStatusTitle\t\t\t,\r\n\t\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\t\tdr.VendorParcelCode,\r\n\t\t\t\t\tdr.CourierRequestTypeId\t\t\t\t\tcourierRequestTypeId,\r\n\t\t\t\t\tdr.CityId,\r\n\t\t\t\t\tdr.polygonId,\r\n\t\t\t\t\tdr.polygonTitle,\r\n\t\t\t\t\tdr.storeId,\r\n\t\t\t\t\tdr.StoreLocation_Latitude\t\t\t\tstoreLocation_Lat,\r\n\t\t\t\t\tdr.StoreLocation_Longitude\t\t\t\tstoreLocation_Long,\r\n\t\t\t\t\tdr.storeTitle,\r\n\t\t\t\t\t(\r\n\t\t\t\t\tdr.AssignmentTryCount\r\n\t\t\t\t\t) fleetPreAssignmentStateCount,\r\n\t\t\t\t\tDATEDIFF(SECOND,GETDATE(),dr.DeliveryDeadLineTime_DateTime)\t\t\tremainedToDeadlineSeconds,\r\n\t\t\t\t\tFORMAT(dr.DeliveryStartTime, \u0027####-##-## ##:##:##\\.###\u0027)\t\t\tdeliveryStartTimeStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryStartTimePersian, \u0027####/##/## ##:##:##\\.###\u0027)\t\tdeliveryStartTimePersianStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027)\t\t\tdeliveryDeadLineTimeStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryDeadLineTimePersian, \u0027####/##/## ##:##:##\\.###\u0027)\tdeliveryDeadLineTimePersianStr,\r\n\t\t\t\t\tdr.ClientAddress,\r\n\t\t\t\t\tdr.clientlocation_Lat,\r\n\t\t\t\t\tdr.clientlocation_Long,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\t\tWHEN GETDATE() \u003C DATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t\t\t\t- @OperationWarningRangeTime_Second,\r\n\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,- @MinimumDeliveryTime_Second,dr.DeliveryDeadLineTime_DateTime)\r\n\t\t\t\t\t\t\t\t\t\t\t\t) \r\n\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\tWHEN GETDATE()\r\n\t\t\t\t\t\t\tBETWEEN DATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t\t\t- @OperationWarningRangeTime_Second,\r\n\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,- @MinimumDeliveryTime_Second,DeliveryDeadLineTime_DateTime)\r\n\t\t\t\t\t\t\t\t\t\t\t) AND DATEADD(SECOND,- @MinimumDeliveryTime_Second,dr.DeliveryDeadLineTime_DateTime) \r\n\t\t\t\t\t\tTHEN 3\r\n\t\t\t\t\t\tWHEN GETDATE() \u003E DATEADD(SECOND,- @MinimumDeliveryTime_Second,dr.DeliveryDeadLineTime_DateTime) \r\n\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\tEND AssignmentStatus,\r\n\t\t\t\t\tdr.OperationStaffId\r\n\t\t\t\t   \r\n\t\t\tINTO #CTE\r\n\t\t\tFROM #AllDispatchRequests dr\r\n\t\t\tWHERE dr.DispatchRequestStatusId in (5 /*submitted*/,6 /*Reassignment Requested*/)\r\n\t\t\tAND dr.CourierRequestTypeId \u003C\u003E 51\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(dr.CityId IN\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT Id FROM @CityId\r\n\t\t\t\t)\r\n\t\t\t\t)\r\n\t\t\t\tOR (ISNULL(@CityIds, \u00270\u0027) = \u00270\u0027)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(dr.StoreId = @StoreId)\r\n\t\t\t\tOR (ISNULL(@StoreId, 0) = 0)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(dr.ParcelReferenceCode = @ParcelReferenceCode)\r\n\t\t\t\tOR (ISNULL(@ParcelReferenceCode, 0) = 0)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\tdr.PolygonId IN\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT Id FROM @PolygonId\r\n\t\t\t\t)\r\n\t\t\t\tOR (ISNULL(@PolygonIds, \u0027\u0027) = \u0027\u0027)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\tdr.CourierRequestTypeId IN\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT Id FROM @CourierRequestTypeId   --where id!=51\r\n\t\t\t\t)\r\n\t\t\t\tOR (ISNULL(@CourierRequestTypeIds, \u0027\u0027) = \u0027\u0027)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(DeliveryStartTime\r\n\t\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t\t)\r\n\t\t\t\tOR (DeliveryDeadLineTime\r\n\t\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t\t)\r\n\t\t\t\tOR\r\n\t\t\t\t(\r\n\t\t\t\t\t(DeliveryStartTime \u003C @StartDeliveryTime)\r\n\t\t\t\t\tAND (DeliveryDeadLineTime \u003E @EndDeliveryTime)\r\n\t\t\t\t)\r\n\t\t\t\tOR\r\n\t\t\t\t(\r\n\t\t\t\t\tISNULL(@StartDeliveryTime, 0) = 0\r\n\t\t\t\t\tAND ISNULL(@EndDeliveryTime, 0) = 0\r\n\t\t\t\t)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\tdr.VendorParcelCode = @VendorParcelCode\r\n\t\t\t\tOR ISNULL(@VendorParcelCode, \u0027\u0027) = \u0027\u0027\r\n\t\t\t)\r\n\t\r\n\t\r\n\tSET @sql = \u0027\r\n\t\t\t\t\tSELECT cte.id,\r\n                           cte.dispatchRequeststatusId,\r\n                           cte.dispatchRequeststatusTitle,\r\n                           cte.parcelReferenceCode,\r\n                           cte.vendorParcelCode,\r\n                           cte.courierRequestTypeId,\r\n                           cte.cityId,\r\n                           cte.polygonId,\r\n                           cte.polygonTitle,\r\n                           cte.storeId,\r\n                           cte.storeLocation_Lat,\r\n\t\t\t\t\t\t   cte.storeLocation_Long,\r\n                           cte.storeTitle,\r\n                           cte.fleetPreAssignmentStateCount,\r\n                           cte.remainedToDeadlineSeconds,\r\n\t\t\t\t\t\t   cte.deliveryStartTimeStr,\r\n                           cte.deliveryStartTimePersianStr,\r\n                           cte.deliveryDeadLineTimePersianStr,\r\n\t\t\t\t\t\t   cte.deliveryDeadLineTimeStr,\r\n                           cte.clientAddress,\r\n                           cte.clientlocation_Lat,\r\n\t\t\t\t\t\t   cte.clientlocation_Long,\r\n                           cte.assignmentStatus,\r\n                           cte.operationStaffId\r\n\r\n\t\t\t\t\tFROM #cte AS CTE \r\n\t\t\t\t\tORDER BY \u0027 \u002B\r\n\t\t\t\t\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\t\t\t\u002B  @OrderByReplace \u002B \u0027 , \u0027\r\n\t\t\t\t\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\u002B \u0027 AssignmentStatus DESC,\r\n\t\t\t\t\tRemainedToDeadlineSeconds ASC\r\n\t\t\t\t\tOFFSET (\u0027 \u002B CAST(@pageIndex * @pageSize AS NVARCHAR(10)) \u002B \u0027) ROWS FETCH NEXT \u0027\u002B CAST(@pageSize AS NVARCHAR(10))\u002B \u0027ROWS ONLY\r\n\r\nSET @delayedDeliveryRequestCount\t\t\t\t=(SELECT DelayedDeliveryCount\t\t\t\t\t\tFROM #DelayedDeliveryCount)\t\t\t\t\t\r\nSET @assignedDispatchRequestCount\t\t\t\t=(SELECT Assigned_DispatchRequestCount\t\t\t\tFROM #Assigned_DispatchRequestCount)\t\r\nSET @returnedRequestCount\t\t\t\t\t\t=(SELECT ReturnedCount\t\t\t\t\t\t\t\tFROM #ReturnedCount)\t\t\t\t\t\t\t\t\t\r\nSET @delayedPickupCount\t\t\t\t\t\t\t=(SELECT DelayedPickupCount\t\t\t\t\t\t\tFROM #DelayedPickupCount)\t\r\nSET @UnassignedReturnAndReplacementRequestCount =(SELECT UnassignedReturnAndReplacementRequestCount FROM #UnassignedReturnAndReplacementRequestCount)\r\nSELECT @TotalCount = COUNT(CTE.ID) FROM #cte AS CTE \r\n\r\n\u0027\r\n\t\r\n\tPRINT @sql\t\r\n\tDECLARE @Param NVARCHAR(4000) =\t\u0027\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\tINT,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@CourierRequestTypeIds\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n\t\t\t\t\t\t\t\t\t\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),\r\n\t\t\t\t\t\t\t\t\t\t@StartDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@EndDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t= NULL,\t\r\n\t\t\t\t\t\t\t\t\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedDeliveryRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@assignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@returnedRequestCount\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\tOUTPUT\r\n\r\n\t\t\t\t\t\t\t\t\t\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL @sql,@Param,\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\t= @OperationStaffId,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\t= @CityIds,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\t= @PolygonIds,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\t= @StoreId,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\t= @ParcelReferenceCode,\r\n\t\t\t\t\t\t\t\t\t\t@CourierRequestTypeIds\t\t\t\t\t\t= @CourierRequestTypeIds,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\t= @OperationWarningRangeTime,\r\n\t\t\t\t\t\t\t\t\t\t@MinimumDeliveryTime\t\t\t\t\t\t= @MinimumDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@StartDeliveryTime\t\t\t\t\t\t\t= @StartDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@EndDeliveryTime\t\t\t\t\t\t\t= @EndDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\t= @VendorParcelCode,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\t= @OrderBy,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\t= @IsASC,\t\r\n\t\t\t\t\t\t\t\t\t\t@TotalCount\t\t\t\t\t\t\t\t\t= @TotalCount OUTPUT,\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t@delayedDeliveryRequestCount\t\t\t\t= @delayedDeliveryRequestCount\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@assignedDispatchRequestCount\t\t\t\t= @assignedDispatchRequestCount\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@returnedRequestCount\t\t\t\t\t\t= @returnedRequestCount\t\t\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedPickupCount\t\t\t\t\t\t\t= @delayedPickupCount\t\t\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount = @UnassignedReturnAndReplacementRequestCount\tOUTPUT\r\n\r\n"},{"Name":"Get_UnassignedDispatchRequests_By_Filter_withoutpaging","Schema":"dbo","Definition":"--############################################################################################################################################################################################################\r\n-- Stored Procedure\r\n\r\n/*\r\ndeclare @delayedDeliveryRequestCount\t\t\t\tINT=0\r\ndeclare @assignedDispatchRequestCount\t\t\t\tINT=0\r\ndeclare @returnedRequestCount\t\t\t\t\t\tINT=0\r\ndeclare @delayedPickupCount\t\t\t\t\t\t\tINT=0\r\ndeclare @UnassignedReturnAndReplacementRequestCount\tINT=0\r\n\r\nexec [Get_UnassignedDispatchRequests_By_Filter] \r\n\t\t\t @OperationStaffId=42\r\n\t\t\t,@StartDeliveryTime=20221101000000000\r\n\t\t\t,@EndDeliveryTime  =20221106235959999\r\n\t\t\t,@OperationWarningRangeTime=\u002701:01\u0027\r\n\t\t\t,@MinimumDeliveryTime=\u002701:01\u0027\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t,@delayedDeliveryRequestCount\t\t\t\t=@delayedDeliveryRequestCount\t\t\t\t\tOUTPUT\r\n\t\t\t,@assignedDispatchRequestCount\t\t\t\t=@assignedDispatchRequestCount\t\t\t\t\tOUTPUT\r\n\t\t\t,@returnedRequestCount\t\t\t\t\t\t=@returnedRequestCount\t\t\t\t\t\t\tOUTPUT\r\n\t\t\t,@delayedPickupCount\t\t\t\t\t\t=@delayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\t\t\t,@UnassignedReturnAndReplacementRequestCount=@UnassignedReturnAndReplacementRequestCount\tOUTPUT\r\n\r\nSELECT\t\t@delayedDeliveryRequestCount,\r\n\t\t\t@assignedDispatchRequestCount,\r\n\t\t\t@returnedRequestCount,\r\n\t\t\t@delayedPickupCount,\r\n\t\t\t@UnassignedReturnAndReplacementRequestCount\r\n*/\r\ncreate   PROCEDURE [dbo].[Get_UnassignedDispatchRequests_By_Filter_withoutpaging]\r\n   -- declare\r\n    @OperationStaffId\t\t\t\t\t\t\tINT,\r\n    @CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t= NULL, --@CityId--SMALLINT=CityIds--VARCHAR(200)\r\n    @PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n    @StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,\r\n    @ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @CourierRequestTypeIds\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n    @OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n    @MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),\r\n    @StartDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @EndDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n    @VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t= NULL,\r\n\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t= NULL,\r\n\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t= NULL,\r\n\t/**********************************************/\r\n\t@delayedDeliveryRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t@assignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t@returnedRequestCount\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t@delayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\tOUTPUT\r\n\t/**********************************************/\r\n    --@Result\t\t\t\t\t\t\t\tNVARCHAR(MAX)\tOUTPUT\r\nAS\r\n\r\n\t--select \r\n\t--@OperationStaffId=42 ,\r\n\t--@CityIds=NULL, \r\n\t--@PolygonIds=\u0027\u0027, \r\n\t--@StoreId=0, \r\n\t--@ParcelReferenceCode=0, \r\n\t--@CourierRequestTypeIds=\u0027\u0027, \r\n\t--@StartDeliveryTime=NULL, \r\n\t--@EndDeliveryTime=NULL, \r\n\t--@VendorParcelCode=NULL, \r\n\t--@MinimumDeliveryTime=\u002700:19:00\u0027, \r\n\t--@OperationWarningRangeTime=\u002700:02:00\u0027, \r\n\t--@OrderBy=\u0027\u0027, \r\n\t--@IsAsc=\u0027False\u0027\r\n\r\n\r\n\tdeclare \r\n\t\t@sql nvarchar(max)\r\n\r\n\tDECLARE @OrderByReplace NVARCHAR(200)\r\n\tSELECT @OrderByReplace =   CONCAT(REPLACE(@OrderBy,\u0027,\u0027,CASE WHEN @IsAsc = 1 THEN \u0027 ASC,\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC,\u0027 END),CASE WHEN @IsAsc = 1 THEN \u0027 ASC\u0027 WHEN @IsAsc = 0 THEN \u0027 DESC\u0027 END)\r\n\r\n\t--@PolygonIds\r\n\tDECLARE @PolygonId TABLE\r\n\t(\r\n\t\tId SMALLINT\r\n\t);\r\n\tINSERT INTO @PolygonId\r\n\tSELECT value\r\n\tFROM STRING_SPLIT(@PolygonIds, \u0027,\u0027);\r\n\r\n\r\n\t--@CityIds\r\n\tDECLARE @CityId TABLE\r\n\t(\r\n\t\tId SMALLINT\r\n\t);\r\n\tINSERT INTO @CityId\r\n\tSELECT value\r\n\tFROM STRING_SPLIT(@CityIds, \u0027,\u0027);\r\n\r\n\r\n\t--@CourierRequestTypeIds\r\n\tDECLARE @CourierRequestTypeId TABLE\r\n\t(\r\n\t\tId TINYINT\r\n\t);\r\n\tINSERT INTO @CourierRequestTypeId\r\n\tSELECT value\r\n\tFROM STRING_SPLIT(@CourierRequestTypeIds, \u0027,\u0027);\r\n\r\n\r\n\tIF (@StartDeliveryTime \u003C\u003E 0)\r\n\t   AND (@EndDeliveryTime \u003C\u003E 0)\r\n\t   AND dbo.FN_DateDiff(@StartDeliveryTime, @EndDeliveryTime) \u003E 31\r\n\tBEGIN\r\n\t\t--SET @Result = -1;\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\tIF @StartDeliveryTime IS NOT NULL AND @EndDeliveryTime IS NULL \r\n\t\tSET @EndDeliveryTime = @StartDeliveryTime \u002B 100000000000\r\n\tELSE IF @StartDeliveryTime IS NULL AND @EndDeliveryTime IS NOT NULL\r\n\t\tSET @StartDeliveryTime = @EndDeliveryTime - 100000000000\r\n\r\n\t/**************************************************/\r\n\tDECLARE @Today INT= CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\t/**************************************************/\r\n\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\t/**************************************************/\r\n\t--DROP TABLE IF EXISTS #ActiveShipmentCount\r\n\t--DROP TABLE IF EXISTS #TotalCount\r\n\tDROP TABLE IF EXISTS #AllDispatchRequests\r\n\tDROP TABLE IF EXISTS #AllShipmentDestinationPoint\r\n\tDROP TABLE IF EXISTS #ReturnedCount\r\n\tDROP TABLE IF EXISTS #DelayedPickupCount\r\n\tDROP TABLE IF EXISTS #DelayedDeliveryCount\r\n\t/**************************************************AllDispatchRequests*/\r\n\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\tddr.ParcelReferenceCode,\r\n\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\tLEFT(ddr.DeliveryStartTime,8)\tDeliveryStartTime_Date,\r\n\t\t\tDeliveryStartTime,\r\n\t\t\tddr.PolygonStoreId,\r\n\t\t\tdp.Id\t\t\t\t\t\t\tPolygonId,\r\n\t\t\tdp.Title\t\t\t\t\t\tPolygonTitle,\r\n\t\t\tps.StoreId,\r\n\t\t\ts.title\t\t\t\t\t\t\tStoreTitle,\r\n\t\t\tdp.CityId,\r\n\t\t\tddr.VendorParcelCode,\r\n\t\t\tpos.OperationStaffId,\r\n\t\t\tdrs.title\t\t\t\t\t\tDispatchRequestStatusTitle,\r\n\t\t\tddr.CourierRequestTypeId,\r\n\t\t\ts.Location.STY\t\t\t\t\tStoreLocation_Latitude,\r\n\t\t\ts.Location.STX\t\t\t\t\tStoreLocation_Longitude,\r\n\r\n\t\t\tddr.ClientLocation.STY\t\t\tclientlocation_Lat,\r\n\t\t\tddr.ClientLocation.STX\t\t\tclientlocation_Long,\r\n\r\n\t\t\tCAST(CONVERT(VARCHAR, FORMAT(ddr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)DeliveryDeadLineTime_DateTime,\r\n\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\tddr.DeliveryStartTimePersian, \r\n\t\t\tddr.DeliveryDeadLineTimePersian,\r\n\t\t\tClientAddress\r\n\tINTO #AllDispatchRequests\r\n\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\tWHERE pos.OperationStaffId=@OperationStaffId\r\n\tAND ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t/**************************************************AllShipmentDestinationPoint*/\r\n\tSELECT\tsdp.Id\t\tShipmentDestinationPointId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\tsdp.OperationTypeId,\r\n\t\t\tddr.DispatchRequestId,\r\n            ddr.DispatchRequestStatusId,\r\n\t\t\tds.Id\t\tShipmentId,\r\n\t\t\tdss.Id\t\tShipmentStatusId,\r\n\t\t\tdss.Title\tShipmentStatusTitle,\r\n\t\t\tds.FleetId,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tds.ShipmentNumber,\r\n\t\t\tds.TotalEstimatedDurationSeconds,\r\n\t\t\tds.TotalDistanceMeter,\r\n\t\t\tDATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(varchar,FORMAT(sdp.EstimatedArrivalTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS DATETIME))EstimatedArrivalTime\r\n\tINTO #AllShipmentDestinationPoint\r\n\tFROM dP.Shipment(NOLOCK) ds\r\n\tINNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\tINNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON ds.Id=sdp.ShipmentId\r\n\tINNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\tINNER JOIN #AllDispatchRequests(NOLOCK) ddr\t\t\t\t\t\t\tON ddr.DispatchRequestId=sdpdr.DispatchRequestId\r\n\t/***************************************************/\r\n\tSELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tAssigned_DispatchRequestCount\r\n\tINTO #Assigned_DispatchRequestCount\r\n\tFROM #AllDispatchRequests ddr\r\n\tWHERE ddr.DispatchRequestStatusId IN (10/*Assigned To Courier*/,11/*Reassigned*/,15/*Arrived at Pickup point*/,\r\n\t\t\t\t\t\t\t\t\t\t 16/*SecondFleetArrivedAtPickupPoint*/,20/*Picked up*/,25/*Arrived at Delivery Point*/,\r\n\t\t\t\t\t\t\t\t\t\t 45/*Cancel Response Pending*/,46/*Second Cancel Request Pending*/,50/*Cancel Request Rejected*/,\r\n\t\t\t\t\t\t\t\t\t\t 51/*Second Cancel Request Rejected*/)\r\n\t--AND ddr.DeliveryStartTime_Date = @Today\r\n\t/***********************************************************/\t\r\n\r\n\tSELECT COUNT(DISTINCT sdp.ShipmentDestinationPointId)\tReturnedCount\r\n\tINTO #ReturnedCount\r\n\tFROM #AllShipmentDestinationPoint sdp\r\n\tWHERE ((sdp.OperationTypeId in (15))/*Return*/ or (OperationTypeId = 10 and DispatchRequestStatusId in (45,46)))\r\n\tAND ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t/***************************************************/\r\n\tSELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tDelayedPickupCount\r\n\tINTO #DelayedPickupCount\r\n\tFROM #AllShipmentDestinationPoint sdp\r\n\tINNER JOIN #AllDispatchRequests ddr ON ddr.DispatchRequestId=sdp.DispatchRequestId\r\n\tWHERE ddr.DispatchRequestStatusId in (10,11,15,16)\r\n\tAND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30\r\n\tAND sdp.OperationTypeId = 5\r\n\tAND GETDATE()\u003Esdp.EstimatedArrivalTime\r\n\t/***************************************************/\r\n\t--SELECT COUNT(DISTINCT sdp.ShipmentDestinationPointId)\tDelayedDeliveryCount\r\n\t--INTO #DelayedDeliveryCount\r\n\t--FROM #AllShipmentDestinationPoint sdp\r\n\t--WHERE sdp.OperationTypeId=10/*Delivered*/\r\n\t--AND ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t--AND GETDATE()\u003EEstimatedArrivalTime\r\n\r\n\r\n\tSELECT COUNT(sdp.Id) DelayedDeliveryCount\r\n\tINTO #DelayedDeliveryCount\r\n    FROM #AllDispatchRequests dr\r\n\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\tJOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\tWHERE sdp.OperationTypeId IN (10) \r\n\tAND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\r\n\tAND dr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedDurationSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n\t/***************************************************/\r\n\tSELECT COUNT(DISTINCT ddr.ParcelReferenceCode)\t\t\tUnassignedReturnAndReplacementRequestCount\r\n\tINTO #UnassignedReturnAndReplacementRequestCount\r\n\tFROM #AllDispatchRequests ddr\r\n\tWHERE ddr.CourierRequestTypeId IN (26,30,35,40,45,50)\r\n\tAND ddr.DispatchRequestStatusId IN (5)\r\n\t/***************************************************/\r\n\t--SELECT \r\n\t--\t\tCOUNT(DISTINCT ds.Id) ActiveShipmentCount\r\n\t--INTO #ActiveShipmentCount\r\n\t--FROM dP.Shipment(NOLOCK) ds\r\n\t--INNER JOIN dp.ShipmentStatus(NOLOCK) dss\t\t\t\t\t\t\tON dss.Id=ds.ShipmentStatusId\r\n\t--INNER JOIN dp.ShipmentDestinationPoint(NOLOCK) sdp\t\t\t\t\tON ds.Id=sdp.ShipmentId\r\n\t--INNER JOIN dp.ShipmentDestinationPointDispatchRequest(NOLOCK) sdpdr\tON sdp.Id=sdpdr.ShipmentDestinationPointId\r\n\t--INNER JOIN dp.DispatchRequest(NOLOCK) ddr\t\t\t\t\t\t\tON ddr.Id=sdpdr.DispatchRequestId\r\n\t--INNER JOIN dp.PolygonStore(NOLOCK) dps\t\t\t\t\t\t\t\tON dps.Id=ddr.PolygonStoreId\r\n\t--INNER JOIN dp.Polygon(NOLOCK) dp\t\t\t\t\t\t\t\t\tON dp.Id=dps.PolygonId\r\n\t--JOIN DP.Store(NOLOCK) AS s\t\t\t\t\t\t\t\t\t\t\tON dps.StoreId = s.Id\r\n\t--INNER JOIN dp.PolygonFleet(NOLOCK) dpf\t\t\t\t\t\t\t\tON dpf.PolygonId=dp.Id  AND dpf.IsActive=1\r\n\t--INNER JOIN dp.Fleet(NOLOCK) df\t\t\t\t\t\t\t\t\t\tON df.Id=ds.FleetId AND df.IsActive=1\r\n\t--INNER JOIN dp.PolygonOperationStaff(NOLOCK) dpos\t\t\t\t\tON dpos.PolygonId=dp.Id AND dpos.IsActive=1\r\n\t--WHERE dss.Id NOT IN (45/*Completed*/,50/*Canceled*/,55/*Modified*/,100)\r\n\t--AND dpos.OperationStaffId=@OperationStaffId\r\n\t/***********************************************************/\r\n\r\n\t--SELECT  COUNT(DISTINCT dr.ParcelReferenceCode) TotalCount\r\n\t--INTO #TotalCount\r\n\t--FROM DP.DispatchRequest(NOLOCK) dr\r\n\t--\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\r\n\t--\t\tON dr.DispatchRequestStatusId = drs.Id\r\n\t--\tINNER JOIN DP.PolygonStore(NOLOCK) ps\r\n\t--\t\tON ps.Id = dr.PolygonStoreId\r\n\t--\tINNER JOIN DP.Polygon(NOLOCK) dp\r\n\t--\t\tON dp.Id = ps.PolygonId\r\n\t--\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\r\n\t--\t\tON pos.PolygonId = dp.Id and pos.IsActive = 1\r\n\t--WHERE dr.DispatchRequestStatusId in(5,6) --submitted\r\n\t--\t  AND (pos.OperationStaffId = @OperationStaffId)\r\n\t--\t  AND ((dp.CityId IN (SELECT Id FROM @CityId))\t\t\t\t\t\t\t\tOR (ISNULL(@CityIds, \u00270\u0027) = \u00270\u0027))\r\n\t--\t  AND ((ps.StoreId = @StoreId)\t\t\t\t\t\t\t\t\t\t\t\tOR (ISNULL(@StoreId, 0) = 0))\r\n\t--\t  AND ((dr.ParcelReferenceCode = @ParcelReferenceCode)\t\t\t\t\t\tOR (ISNULL(@ParcelReferenceCode, 0) = 0))\r\n\t--\t  AND (dp.Id IN(SELECT Id FROM @PolygonId)\t\t\t\t\t\t\t\t\tOR (ISNULL(@PolygonIds, \u0027\u0027) = \u0027\u0027))\r\n\t--\t  AND (dr.CourierRequestTypeId IN(SELECT Id FROM @CourierRequestTypeId)\t\tOR (ISNULL(@CourierRequestTypeIds, \u0027\u0027) = \u0027\u0027))\r\n\t--\t  AND ((DeliveryStartTime BETWEEN @StartDeliveryTime AND @EndDeliveryTime)\tOR (DeliveryDeadLineTime BETWEEN @StartDeliveryTime AND @EndDeliveryTime)\r\n\t--\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tOR ((DeliveryStartTime \u003C @StartDeliveryTime) AND (DeliveryDeadLineTime \u003E @EndDeliveryTime))\r\n\t--\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tOR (ISNULL(@StartDeliveryTime, 0) = 0 AND ISNULL(@EndDeliveryTime, 0) = 0))\r\n\t--\t  AND\r\n\t--\t  (\r\n\t--\t\t  dr.VendorParcelCode = @VendorParcelCode\r\n\t--\t\t  OR ISNULL(@VendorParcelCode, \u0027\u0027) = \u0027\u0027\r\n\t--\t  );\r\n\r\n\r\n\tDECLARE @OperationWarningRangeTime_Second\tINT=DATEDIFF (SECOND,0,@OperationWarningRangeTime)\r\n\tDECLARE @MinimumDeliveryTime_Second\t\t\tINT=DATEDIFF (SECOND,0,@MinimumDeliveryTime)\r\n\r\n\tSELECT DISTINCT\r\n\t\t\t\t\tdr.DispatchRequestId\t\t\t\t\tId,\r\n\t\t\t\t\tdr.DispatchRequestStatusId\t\t\t\tdispatchRequeststatusId,\r\n\t\t\t\t\tdr.dispatchRequestStatusTitle\t\t\t,\r\n\t\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\t\tdr.VendorParcelCode,\r\n\t\t\t\t\tdr.CourierRequestTypeId\t\t\t\t\tcourierRequestTypeId,\r\n\t\t\t\t\tdr.CityId,\r\n\t\t\t\t\tdr.polygonId,\r\n\t\t\t\t\tdr.polygonTitle,\r\n\t\t\t\t\tdr.storeId,\r\n\t\t\t\t\tdr.StoreLocation_Latitude\t\t\t\tstoreLocation_Lat,\r\n\t\t\t\t\tdr.StoreLocation_Longitude\t\t\t\tstoreLocation_Long,\r\n\t\t\t\t\tdr.storeTitle,\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tselect [dbo].[GetFleetPreAssignmentStateCount](dr.DispatchRequestId)\r\n\t\t\t\t\t) fleetPreAssignmentStateCount,\r\n\t\t\t\t\tDATEDIFF(SECOND,GETDATE(),dr.DeliveryDeadLineTime_DateTime)\t\t\tremainedToDeadlineSeconds,\r\n\t\t\t\t\tFORMAT(dr.DeliveryStartTime, \u0027####-##-## ##:##:##\\.###\u0027)\t\t\tdeliveryStartTimeStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryStartTimePersian, \u0027####/##/## ##:##:##\\.###\u0027)\t\tdeliveryStartTimePersianStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027)\t\t\tdeliveryDeadLineTimeStr,\r\n\t\t\t\t\tFORMAT(dr.DeliveryDeadLineTimePersian, \u0027####/##/## ##:##:##\\.###\u0027)\tdeliveryDeadLineTimePersianStr,\r\n\t\t\t\t\tdr.ClientAddress,\r\n\t\t\t\t\tdr.clientlocation_Lat,\r\n\t\t\t\t\tdr.clientlocation_Long,\r\n\t\t\t\t\tCASE\r\n\t\t\t\t\t\tWHEN GETDATE() \u003C DATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t\t\t\t- @OperationWarningRangeTime_Second,\r\n\t\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,- @MinimumDeliveryTime_Second,dr.DeliveryDeadLineTime_DateTime)\r\n\t\t\t\t\t\t\t\t\t\t\t\t) \r\n\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\tWHEN GETDATE()\r\n\t\t\t\t\t\t\tBETWEEN DATEADD(SECOND,\r\n\t\t\t\t\t\t\t\t\t\t\t- @OperationWarningRangeTime_Second,\r\n\t\t\t\t\t\t\t\t\t\t\tDATEADD(SECOND,- @MinimumDeliveryTime_Second,DeliveryDeadLineTime_DateTime)\r\n\t\t\t\t\t\t\t\t\t\t\t) AND DATEADD(SECOND,- @MinimumDeliveryTime_Second,dr.DeliveryDeadLineTime_DateTime) \r\n\t\t\t\t\t\tTHEN 3\r\n\t\t\t\t\t\tWHEN GETDATE() \u003E DATEADD(SECOND,- @MinimumDeliveryTime_Second,dr.DeliveryDeadLineTime_DateTime) \r\n\t\t\t\t\t\tTHEN 4\r\n\t\t\t\t\tEND AssignmentStatus,\r\n\t\t\t\t\tdr.OperationStaffId\r\n\r\n\t\t\tINTO #CTE\r\n\t\t\tFROM #AllDispatchRequests dr\r\n\t\t\tWHERE dr.DispatchRequestStatusId in (5 /*submitted*/,6 /*Reassignment Requested*/)\r\n\t\t\tAND dr.CourierRequestTypeId \u003C\u003E 51\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(dr.CityId IN\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT Id FROM @CityId\r\n\t\t\t\t)\r\n\t\t\t\t)\r\n\t\t\t\tOR (ISNULL(@CityIds, \u00270\u0027) = \u00270\u0027)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(dr.StoreId = @StoreId)\r\n\t\t\t\tOR (ISNULL(@StoreId, 0) = 0)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(dr.ParcelReferenceCode = @ParcelReferenceCode)\r\n\t\t\t\tOR (ISNULL(@ParcelReferenceCode, 0) = 0)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\tdr.PolygonId IN\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT Id FROM @PolygonId\r\n\t\t\t\t)\r\n\t\t\t\tOR (ISNULL(@PolygonIds, \u0027\u0027) = \u0027\u0027)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\tdr.CourierRequestTypeId IN\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT Id FROM @CourierRequestTypeId   --where id!=51\r\n\t\t\t\t)\r\n\t\t\t\tOR (ISNULL(@CourierRequestTypeIds, \u0027\u0027) = \u0027\u0027)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\t(DeliveryStartTime\r\n\t\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t\t)\r\n\t\t\t\tOR (DeliveryDeadLineTime\r\n\t\t\t\t\tBETWEEN @StartDeliveryTime AND @EndDeliveryTime\r\n\t\t\t\t)\r\n\t\t\t\tOR\r\n\t\t\t\t(\r\n\t\t\t\t\t(DeliveryStartTime \u003C @StartDeliveryTime)\r\n\t\t\t\t\tAND (DeliveryDeadLineTime \u003E @EndDeliveryTime)\r\n\t\t\t\t)\r\n\t\t\t\tOR\r\n\t\t\t\t(\r\n\t\t\t\t\tISNULL(@StartDeliveryTime, 0) = 0\r\n\t\t\t\t\tAND ISNULL(@EndDeliveryTime, 0) = 0\r\n\t\t\t\t)\r\n\t\t\t)\r\n\t\t\tAND\r\n\t\t\t(\r\n\t\t\t\tdr.VendorParcelCode = @VendorParcelCode\r\n\t\t\t\tOR ISNULL(@VendorParcelCode, \u0027\u0027) = \u0027\u0027\r\n\t\t\t)\r\n\r\n\tSET @sql = \u0027\r\n\t\t\t\t\tSELECT cte.id,\r\n                           cte.dispatchRequeststatusId,\r\n                           cte.dispatchRequeststatusTitle,\r\n                           cte.parcelReferenceCode,\r\n                           cte.vendorParcelCode,\r\n                           cte.courierRequestTypeId,\r\n                           cte.cityId,\r\n                           cte.polygonId,\r\n                           cte.polygonTitle,\r\n                           cte.storeId,\r\n                           cte.storeLocation_Lat,\r\n\t\t\t\t\t\t   cte.storeLocation_Long,\r\n                           cte.storeTitle,\r\n                           cte.fleetPreAssignmentStateCount,\r\n                           cte.remainedToDeadlineSeconds,\r\n\t\t\t\t\t\t   cte.deliveryStartTimeStr,\r\n                           cte.deliveryStartTimePersianStr,\r\n                           cte.deliveryDeadLineTimePersianStr,\r\n\t\t\t\t\t\t   cte.deliveryDeadLineTimeStr,\r\n                           cte.clientAddress,\r\n                           cte.clientlocation_Lat,\r\n\t\t\t\t\t\t   cte.clientlocation_Long,\r\n                           cte.assignmentStatus,\r\n                           cte.operationStaffId\r\n\r\n\t\t\t\t\tFROM #cte AS CTE \r\n\t\t\t\t\tORDER BY \u0027 \u002B\r\n\t\t\t\t\t\t\tCASE WHEN @OrderBy IS NOT NULL AND @OrderBy \u003C\u003E \u0027\u0027 AND @OrderBy \u003C\u003E \u0027NULL\u0027 \r\n\t\t\t\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\t\t\t\t\u002B  @OrderByReplace \u002B \u0027 , \u0027\r\n\t\t\t\t\t\t\t\t\tELSE \u0027 \u0027\r\n\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\u002B \u0027 AssignmentStatus DESC,\r\n\t\t\t\t\tRemainedToDeadlineSeconds ASC\r\n\r\nSET @delayedDeliveryRequestCount\t\t\t\t=(SELECT DelayedDeliveryCount\t\t\t\t\t\tFROM #DelayedDeliveryCount)\t\t\t\t\t\r\nSET @assignedDispatchRequestCount\t\t\t\t=(SELECT Assigned_DispatchRequestCount\t\t\t\tFROM #Assigned_DispatchRequestCount)\t\r\nSET @returnedRequestCount\t\t\t\t\t\t=(SELECT ReturnedCount\t\t\t\t\t\t\t\tFROM #ReturnedCount)\t\t\t\t\t\t\t\t\t\r\nSET @delayedPickupCount\t\t\t\t\t\t\t=(SELECT DelayedPickupCount\t\t\t\t\t\t\tFROM #DelayedPickupCount)\t\r\nSET @UnassignedReturnAndReplacementRequestCount =(SELECT UnassignedReturnAndReplacementRequestCount FROM #UnassignedReturnAndReplacementRequestCount)\r\n\r\n\r\n\u0027\r\n\r\n\tPRINT @sql\t\r\n\tDECLARE @Param NVARCHAR(4000) =\t\u0027\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\tINT,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\tVARCHAR(200)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@CourierRequestTypeIds\t\t\t\t\t\tNVARCHAR(MAX)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\tVARCHAR(10),\r\n\t\t\t\t\t\t\t\t\t\t@MinimumDeliveryTime\t\t\t\t\t\tVARCHAR(10),\r\n\t\t\t\t\t\t\t\t\t\t@StartDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@EndDeliveryTime\t\t\t\t\t\t\tBIGINT\t\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\tVARCHAR(32)\t\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\tNVARCHAR(200)\t= NULL,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\tBIT\t\t\t\t= NULL,\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\t\t\t@delayedDeliveryRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@assignedDispatchRequestCount\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@returnedRequestCount\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedPickupCount\t\t\t\t\t\t\tINT\t\t\t\tOUTPUT,\r\n\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount INT\t\t\t\tOUTPUT\r\n\r\n\t\t\t\t\t\t\t\t\t\u0027\r\n\r\n\t\tEXECUTE sys.sp_executeSQL @sql,@Param,\r\n\t\t\t\t\t\t\t\t\t\t@OperationStaffId\t\t\t\t\t\t\t= @OperationStaffId,\r\n\t\t\t\t\t\t\t\t\t\t@CityIds\t\t\t\t\t\t\t\t\t= @CityIds,\r\n\t\t\t\t\t\t\t\t\t\t@PolygonIds\t\t\t\t\t\t\t\t\t= @PolygonIds,\r\n\t\t\t\t\t\t\t\t\t\t@StoreId\t\t\t\t\t\t\t\t\t= @StoreId,\r\n\t\t\t\t\t\t\t\t\t\t@ParcelReferenceCode\t\t\t\t\t\t= @ParcelReferenceCode,\r\n\t\t\t\t\t\t\t\t\t\t@CourierRequestTypeIds\t\t\t\t\t\t= @CourierRequestTypeIds,\r\n\t\t\t\t\t\t\t\t\t\t@OperationWarningRangeTime\t\t\t\t\t= @OperationWarningRangeTime,\r\n\t\t\t\t\t\t\t\t\t\t@MinimumDeliveryTime\t\t\t\t\t\t= @MinimumDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@StartDeliveryTime\t\t\t\t\t\t\t= @StartDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@EndDeliveryTime\t\t\t\t\t\t\t= @EndDeliveryTime,\r\n\t\t\t\t\t\t\t\t\t\t@VendorParcelCode\t\t\t\t\t\t\t= @VendorParcelCode,\r\n\t\t\t\t\t\t\t\t\t\t@OrderBy\t\t\t\t\t\t\t\t\t= @OrderBy,\r\n\t\t\t\t\t\t\t\t\t\t@IsASC\t\t\t\t\t\t\t\t\t\t= @IsASC,\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\t\t\t@delayedDeliveryRequestCount\t\t\t\t= @delayedDeliveryRequestCount\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@assignedDispatchRequestCount\t\t\t\t= @assignedDispatchRequestCount\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@returnedRequestCount\t\t\t\t\t\t= @returnedRequestCount\t\t\t\t\t\t\tOUTPUT,\r\n\t\t\t\t\t\t\t\t\t\t@delayedPickupCount\t\t\t\t\t\t\t= @delayedPickupCount\t\t\t\t\t\t\tOUTPUT,\r\n\r\n\t\t\t\t\t\t\t\t\t\t@UnassignedReturnAndReplacementRequestCount = @UnassignedReturnAndReplacementRequestCount\tOUTPUT\r\n\r\n\r\n"},{"Name":"Get_UnassignedReturnAndReplacementRequest_By_Filter","Schema":"dbo","Definition":"\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/08/28\r\n--\tDescription:\tGet Unassigned Return and Replacement Request\r\n--\t\r\n--\t=======================================\r\n\r\n/*\r\n\tDECLARE\t@UnassignedDispatchRequestCount int,\r\n\t\t\t@AssignedDispatchRequestCount int,\r\n\t\t\t@ReturnedRequestCount int,\r\n\t\t\t@DelayedDeliveryCount int,\r\n\t\t\t@DelayedPickupCount int,\r\n\t\t\t@TotalCount\tINT\r\n\r\n\tEXEC\t[dbo].[Get_UnassignedReturnAndReplacementRequest_By_Filter]\r\n\t\t\t@UnassignedDispatchRequestCount = @UnassignedDispatchRequestCount OUTPUT,\r\n\t\t\t@AssignedDispatchRequestCount = @AssignedDispatchRequestCount OUTPUT,\r\n\t\t\t@ReturnedRequestCount = @ReturnedRequestCount OUTPUT,\r\n\t\t\t@DelayedDeliveryCount = @DelayedDeliveryCount OUTPUT,\r\n\t\t\t@DelayedPickupCount = @DelayedPickupCount OUTPUT,\r\n\t\t\t@TotalCount = @TotalCount OUTPUT,\r\n\t\t\t@PageIndex = 0,\r\n\t\t\t@PageSize = 100,\r\n\t\t\t@OperationStaffId = 1121\r\n\r\n\tSELECT\t@UnassignedDispatchRequestCount as N\u0027@UnassignedDispatchRequestCount\u0027,\r\n\t\t\t@AssignedDispatchRequestCount as N\u0027@AssignedDispatchRequestCount\u0027,\r\n\t\t\t@ReturnedRequestCount as N\u0027@ReturnedRequestCount\u0027,\r\n\t\t\t@DelayedDeliveryCount as N\u0027@DelayedDeliveryCount\u0027,\r\n\t\t\t@DelayedPickupCount as N\u0027@DelayedPickupCount\u0027,\r\n\t\t\t@TotalCount AS N\u0027@TotalCount\u0027\r\n\r\n*/\r\nCREATE    PROCEDURE [dbo].[Get_UnassignedReturnAndReplacementRequest_By_Filter]\r\n\t    --@ProvinceId\tSMALLINT = NULL,\r\n\t\t@CityIds VARCHAR(MAX) = NULL,\r\n\t\t@PolygonIds VARCHAR(MAX) = NULL,\r\n\t\t@StoreIds VARCHAR(MAX) = NULL,\r\n\t\t@ParcelReferenceCode BIGINT = NULL,\r\n\t\t@CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n\t\t@StartDeliveryTime BIGINT = NULL,\r\n\t\t@EndDeliveryTime BIGINT = NULL,\r\n\t\t@VendorParcelCode VARCHAR(32) = NULL,\r\n\t\t@VendorID\t\tINT = NULL,\r\n\t\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t\t@UnassignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@AssignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@ReturnedRequestCount INT = 0 OUTPUT,\r\n\t\t@DelayedDeliveryCount INT = 0 OUTPUT,\r\n\t\t@DelayedPickupCount INT = 0 OUTPUT,\r\n\t\t@NotPickUpRequestCount INT = 0 OUTPUT,\r\n\t\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t\t@OperationStaffId\t\t\t\t\t\tINT \r\n\r\nAS \r\n\tSET NOCOUNT ON\r\n    --############################################ Preparation Data ##################################\r\n\r\n    drop table if EXISTS    #DispatchRequest,\r\n                            #Shipment,\r\n                            #Fleet,\r\n                            #FinalResult,\r\n\t\t\t\t\t\t\t#AllDispatchRequests\r\n     SELECT\r\n\t\t\t@CityIds                                 =ISNULL(@CityIds,\u00270\u0027),\r\n            @PolygonIds\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),\r\n            @StoreIds\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n            @ParcelReferenceCode\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n            @CourierRequestTypeIds                  =ISNULL(@CourierRequestTypeIds,0),\r\n            @StartDeliveryTime                      =ISNULL(@StartDeliveryTime,0),\r\n            @EndDeliveryTime                        =ISNULL(@EndDeliveryTime,0),\r\n            @VendorParcelCode\t\t\t\t\t    =ISNULL(@VendorParcelCode,\u00270\u0027),\r\n\t\t\t@OperationStaffId                        =ISNULL(@OperationStaffId,0),\r\n\t\t\t@VendorID                                =ISNULL(@VendorID,0)\r\n\r\n\t\tDECLARE @CityId TABLE\r\n\t\t(\r\n\t\t\tId INT\r\n\t\t)\r\n\t\tINSERT INTO @CityId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS INT)\r\n\t\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\r\n        DECLARE @PolygonId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @PolygonId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\r\n        DECLARE @StoreId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @StoreId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS INT)\r\n\t\tFROM string_split(@StoreIds,\u0027,\u0027)\r\n\r\n\t\tDECLARE @CourierRequestTypeId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CourierRequestTypeId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CourierRequestTypeIds,\u0027,\u0027)\r\n\r\n\t\tDECLARE @Today INT,@Yesterday int\r\n\t\tSELECT @Today = CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n\t\tselect @Yesterday = CAST(SUBSTRING(CONVERT(char(8),GETDATE()-1,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-1, 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT)     \r\n\t \r\n\t\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\r\n\t--SET @NotPickupRequestCount = NULL\r\n\t--SET @DelayedPickupCount = NULL\r\n\t--SET @ReturnedRequestCount = NULL\r\n\t--SET @AssignedDispatchRequestCount = NULL\r\n\t--SET @UnassignedDispatchRequestCount = NULL\r\n\t--SET @DelayedDeliveryCount = NULL\r\n\r\n\t--EXEC Get_OperationPanel_Count\r\n\t--\t@OperationStaffId = @OperationStaffId,\r\n\t--\t@CityIds = @CityIds,\r\n\t--\t@PolygonIds = @PolygonIds,\r\n\t--\t@VendorID = @VendorID,\r\n\t--\t@UnassignedDispatchRequestCount\t\t\t\t = @UnassignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t@AssignedDispatchRequestCount\t\t\t\t = @AssignedDispatchRequestCount\t\t\t\tOUTPUT,\r\n\t--\t@ReturnedRequestCount\t\t\t\t\t\t = @ReturnedRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t@DelayedDeliveryCount\t\t\t\t\t\t = @DelayedDeliveryCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t@NotPickupRequestCount\t\t\t\t\t\t = @NotPickupRequestCount\t\t\t\t\t\tOUTPUT,\r\n\t--\t@DelayedPickupCount\t\t\t\t\t\t\t = @DelayedPickupCount\t\t\t\t\t\t\tOUTPUT\r\n\r\n\t--SELECT \r\n\t--\t@UnassignedDispatchRequestCount = ISNULL(@UnassignedDispatchRequestCount,0),\t\t\t\r\n\t--\t@AssignedDispatchRequestCount = ISNULL(@AssignedDispatchRequestCount,0),\t\t\t\t\r\n\t--\t@ReturnedRequestCount = ISNULL(@ReturnedRequestCount,0),\t\t\t\t\t\r\n\t--\t@DelayedDeliveryCount = ISNULL(@DelayedDeliveryCount,0),\t\t\t\t\t\t\r\n\t--\t@NotPickupRequestCount = ISNULL(@NotPickupRequestCount,0),\t\t\t\t\t\t\r\n\t--\t@DelayedPickupCount = ISNULL(@DelayedPickupCount,0)\t\t\r\n\t\t; WITH CTE_DR AS \r\n\t\t(\r\n\t\t\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\t\t\tddr.DeliveryStartTime,\r\n\t\t\t\t\t\tddr.DeliveryDeadLineTime,\r\n\t\t\t\t\t\tddr.IsWaitingForSupport\r\n\r\n\t\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\t\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\t\tAND (dp.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n\t\t\tand (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n\t\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\t\t\tAND ( ddr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\t\tAND ( ddr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\t\t\tAND ( ddr.VendorId = @VendorID OR @VendorID = 0)\r\n\t\t) \r\n\t\tSELECT \r\n\t\t\t@UnassignedDispatchRequestCount = COUNT(DISTINCT SQ.UnassignedDispatchRequestCount),\r\n\t\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT SQ.AssignedDispatchRequestCount),\r\n\t\t\t@ReturnedRequestCount = COUNT(DISTINCT SQ.ReturnedRequestCount),\r\n\t\t\t@DelayedDeliveryCount = COUNT(DISTINCT SQ.DelayedDeliveryCount),\r\n\t\t\t@DelayedPickupCount = COUNT(DISTINCT SQ.DelayedPickupCount),\r\n\t\t\t@NotPickupRequestCount = COUNT(DISTINCT SQ.NotPickupRequestCount)\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (5,6,7)  AND LEFT(DeliveryStartTime,8) IN(@Today,@Yesterday) --= @Today\r\n\t\t\t\t\tTHEN dr.DispatchRequestId \r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS UnassignedDispatchRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,50,51,47,48,49,52,53,54) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS AssignedDispatchRequestCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t(DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n\t\t\t\t\t\t\tOR\r\n\t\t\t\t\t\t\t(DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\n\t\t\t\t\t\t\tAND dr.DeliveryDeadLineTime \u003E=@ToDate) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS ReturnedRequestCount,\t\r\n\t\t\t\tNULL AS DelayedDeliveryCount,\r\n\t\t\t\tNULL AS DelayedPickupCount,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN \r\n\t\t\t\t\t\tdr.IsWaitingForSupport = 1 \r\n\t\t\t\t\t\tAND dr.DispatchRequestStatusId IN ( 15,16 ) \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL \r\n\t\t\t\tEND AS NotPickupRequestCount\r\n\t\t\t\r\n\t\t\tFROM CTE_DR dr\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT\r\n\t\t\tNULL AS UnassignedDispatchRequestCount,\r\n\t\t\tNULL AS AssignedDispatchRequestCount,\r\n\t\t\tNULL AS ReturnedRequestCount,\r\n\t\t\tNULL AS DelayedDeliveryCount,\r\n\t\t\tCASE \r\n\t\t\t\t\tWHEN sdp.ID IS NOT NULL \r\n\t\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS DelayedPickupCount,\r\n\t\t\tNULL AS NotPickupRequestCount\r\n\t\t\tFROM CTE_DR dr\r\n\t\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId AND dr.DispatchRequestStatusId in (10,11,15,16)\r\n\t\t\tINNER JOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId AND sdp.OperationTypeId = 5 AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= getdate() \r\n\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT\r\n\t\t\tNULL AS UnassignedDispatchRequestCount,\r\n\t\t\tNULL AS AssignedDispatchRequestCount,\r\n\t\t\tNULL AS ReturnedRequestCount,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN sdp.ID IS NOT NULL \r\n\t\t\t\tTHEN dr.ParcelReferenceCode\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND AS DelayedDeliveryCount,\r\n\t\t\tNULL AS DelayedPickupCount,\r\n\t\t\tNULL AS NotPickupRequestCount\r\n\t\t\tFROM CTE_DR dr\r\n\t\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr (NOLOCK)  ON sdpdr.DispatchRequestId = dr.DispatchRequestId AND dr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\t\t\tINNER JOIN DP.ShipmentDestinationPoint AS sdp (NOLOCK)  ON sdp.Id = sdpdr.ShipmentDestinationPointId AND sdp.OperationTypeId IN (10) AND DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \u003C= getdate() \r\n\r\n\t\t) SQ\r\n\t\t\r\n/************************************************************************/\r\n/*\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (5,6)\r\n\t\t\t  AND dr.DeliveryStartTime_Date = @Today\r\n--------------------------------------------------------------------------------------\r\n\r\n\t\tSELECT \r\n\t\t\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,47,48,49,50,51,52,53,54)\r\n/*********************************************************************************/\r\n\tSELECT @ReturnedRequestCount=COUNT( dr.ParcelReferenceCode)\r\n\tFROM #AllDispatchRequests dr\r\n        join dp.DispatchRequestStatus drs on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n        join dp.Polygon p1 on ps.PolygonId = p1.Id\r\n        --INNER JOIN @PolygonId p2\tON p1.Id = p2.Id\r\n        --JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        join dp.Store s on ps.StoreId = s.Id\r\n\r\n        where (\r\n                (DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n                OR\r\n                (DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\nAND dr.DeliveryDeadLineTime \u003E=@ToDate)\r\n\r\n\r\n\r\n/***************************************************************/\r\n\r\n\t\t--SELECT\r\n\t\t--\t\t@ReturnedRequestCount = COUNT(dr.DispatchRequestId)\r\n  --      FROM #AllDispatchRequests dr\r\n\t\t--JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\t--JOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\t--WHERE dr.DispatchRequestStatusId in (5,10,15)\r\n\t\t--AND sdp.OperationTypeId = 15\r\n\r\n\t\tSELECT\r\n\t\t\t\t@DelayedDeliveryCount = COUNT(DISTINCT dr.DispatchRequestId)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE sdp.OperationTypeId IN (10) \r\n\t\t--AND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t\tAND dr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n/******************************************************************************/\r\n\t\tSELECT\r\n\t\t\t\t@DelayedPickupCount = COUNT(DISTINCT dr.DispatchRequestId)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE dr.DispatchRequestStatusId in (10,11,15,16)\r\n\t\t--AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30\r\n\t\tAND sdp.OperationTypeId = 5\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\r\n    --############################################ Pre Calculate Result ##############################################\r\n        */\r\n\r\n\t\tSELECT \r\n                    [dr].[Id],\r\n                    [dr].[DispatchRequestStatusId],\r\n                    drs.Title  as StatusTitle,\r\n\t\t\t\t\ts.VendorId,\r\n                    [dr].[ParcelReferenceCode],\r\n                    dr.CourierRequestTypeId,\r\n                    p1.CityId,\r\n                    ps.PolygonId,\r\n                    p1.Title as PolygonTitle,\r\n                    StoreId,\r\n                    s.Title as StoreTitle,\r\n\t\t\t\t\ts.Location.STY\t\t\t\t\tStoreLocationLatitude,\r\n\t\t\t\t\ts.Location.STX\t\t\t\t\tStoreLocationLongitude,\r\n                    dr.DeliveryStartTime,\r\n                    dr.DeliveryStartTimePersian,\r\n                    dr.DeliveryDeadLineTime,\r\n                    dr.DeliveryDeadLineTimePersian,                    \r\n\t\t\t\t\tdr.ClientLocation.STY\t\t\tClientlocationLatitude,\r\n\t\t\t\t\tdr.ClientLocation.STX\t\t\tClientlocationLongitude,\r\n                    dr.VendorParcelCode,\r\n\t\t\t\t\tdr.CreateDate,\r\n                    dr.CreateDatePersian,\r\n\t\t\t\t\tClientAddress,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly\r\n        into #DispatchRequest\r\n        FROM dp.DispatchRequest dr\r\n        join dp.DispatchRequestStatus drs on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n       \r\n        join dp.Polygon p1 on ps.PolygonId = p1.Id\r\n        join dp.Store s on ps.StoreId = s.Id\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        where (dr.DispatchRequestStatusId = 5 AND dr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70))\r\n        and ((dr.DeliveryStartTime BETWEEN @StartDeliveryTime and @EndDeliveryTime or dr.DeliveryDeadLineTime BETWEEN @StartDeliveryTime and @EndDeliveryTime) or @StartDeliveryTime = 0 or @EndDeliveryTime = 0)\r\n        and ((s.Id IN (Select Id from @StoreId)) OR (@StoreIds=\u00270\u0027))\r\n        and (p1.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and ((dr.CourierRequestTypeId in (Select Id from @CourierRequestTypeId)) OR (@CourierRequestTypeIds = \u00270\u0027))\r\n        and (p1.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n        and (dr.ParcelReferenceCode = @ParcelReferenceCode OR @ParcelReferenceCode = 0)\r\n        and (dr.VendorParcelCode = @VendorParcelCode or @VendorParcelCode = \u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\t\tAND ( dr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\tAND ( dr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\t\tAND ( dr.VendorId = @VendorID OR @VendorID = 0)\r\n\t\tOPTION(RECOMPILE)\r\n\t\tSET @TotalCount = @@ROWCOUNT\r\n        \r\n    --############################################ Calculate Result ##############################################\r\n        select distinct\r\n                    [dr].[Id] DispatchRequestId,\r\n                    [dr].[DispatchRequestStatusId],\r\n                    [dr].[StatusTitle] as DispatchRequestStatusTitle,\r\n\t\t\t\t\t[dr].VendorId,\r\n                    [dr].[ParcelReferenceCode],\r\n\t\t\t\t\t[dr].[VendorParcelCode],\r\n                    [dr].[CourierRequestTypeId],\r\n                    [dr].[CityId],\r\n                    [dr].[PolygonId],\r\n                    [dr].[PolygonTitle],\r\n                    [dr].[StoreId],\r\n                    [dr].[StoreTitle],\r\n\t\t\t\t\tStoreLocationLatitude,\r\n\t\t\t\t\tStoreLocationLongitude,\t\t\t\t\t\r\n                    FORMAT([dr].[DeliveryStartTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryStartTimeStr,\r\n                    FORMAT([dr].[DeliveryStartTimePersian],\u0027####/##/## ##:##:##\\.###\u0027)DeliveryStartTimePersianStr,\r\n                    FORMAT([dr].[DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryDeadLineTimeStr,\r\n                    FORMAT([dr].[DeliveryDeadLineTimePersian],\u0027####/##/## ##:##:##\\.###\u0027) DeliveryDeadLineTimePersianStr,\r\n\t\t\t\t\tFORMAT([dr].[CreateDatePersian],\u0027####/##/## ##:##:##\\.###\u0027) CreateDatePersianStr,\r\n\t\t\t\t\tCAST(DATEDIFF(\r\n                                                            SECOND,\r\n                                                            GETDATE(),\r\n                                                            CAST(CONVERT(VARCHAR, FORMAT(dr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)\r\n                                                            \t\t\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t    ) as BIGINT) AS [RemainedToDeadlineSeconds],\r\n\t\t\t\t\tClientlocationLatitude,\r\n\t\t\t\t\tClientlocationLongitude,\r\n\t\t\t\t\tClientAddress,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly\r\n        from #DispatchRequest dr\r\n\r\n\t\tORDER BY CAST(DATEDIFF(\r\n                                                            SECOND,\r\n                                                            GETDATE(),\r\n                                                            CAST(CONVERT(VARCHAR, FORMAT(dr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)\r\n                                                            \t\t\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t    ) as BIGINT)\r\n\t\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\r\n\tSET @DelayedDeliveryCount\t\t\t\t\t\t = ISNULL(@DelayedDeliveryCount,0)\r\n\tSET @DelayedPickupCount\t\t\t\t\t\t\t = ISNULL(@DelayedPickupCount,0)\r\n\tSET @ReturnedRequestCount\t\t\t\t\t\t = ISNULL(@ReturnedRequestCount,0)\r\n\tSET @AssignedDispatchRequestCount\t\t\t\t = ISNULL(@AssignedDispatchRequestCount,0)\r\n\tSET @UnassignedDispatchRequestCount\t\t\t\t = ISNULL(@UnassignedDispatchRequestCount,0)\r\n\tSET @NotPickUpRequestCount\t\t\t\t\t\t = ISNULL(@NotPickUpRequestCount,0)"},{"Name":"Get_UnassignedReturnAndReplacementRequest_By_Filter_BACKUP","Schema":"dbo","Definition":"\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/08/28\r\n--\tDescription:\tGet Unassigned Return and Replacement Request\r\n--\t\r\n--\t=======================================\r\n\r\n/*\r\n\tDECLARE\t@UnassignedDispatchRequestCount int,\r\n\t\t\t@AssignedDispatchRequestCount int,\r\n\t\t\t@ReturnedRequestCount int,\r\n\t\t\t@DelayedDeliveryCount int,\r\n\t\t\t@DelayedPickupCount int,\r\n\t\t\t@TotalCount\tINT\r\n\r\n\tEXEC\t[dbo].[Get_UnassignedReturnAndReplacementRequest_By_Filter]\r\n\t\t\t@UnassignedDispatchRequestCount = @UnassignedDispatchRequestCount OUTPUT,\r\n\t\t\t@AssignedDispatchRequestCount = @AssignedDispatchRequestCount OUTPUT,\r\n\t\t\t@ReturnedRequestCount = @ReturnedRequestCount OUTPUT,\r\n\t\t\t@DelayedDeliveryCount = @DelayedDeliveryCount OUTPUT,\r\n\t\t\t@DelayedPickupCount = @DelayedPickupCount OUTPUT,\r\n\t\t\t@TotalCount = @TotalCount OUTPUT,\r\n\t\t\t@PageIndex = 0,\r\n\t\t\t@PageSize = 100,\r\n\t\t\t@OperationStaffId = 1121\r\n\r\n\tSELECT\t@UnassignedDispatchRequestCount as N\u0027@UnassignedDispatchRequestCount\u0027,\r\n\t\t\t@AssignedDispatchRequestCount as N\u0027@AssignedDispatchRequestCount\u0027,\r\n\t\t\t@ReturnedRequestCount as N\u0027@ReturnedRequestCount\u0027,\r\n\t\t\t@DelayedDeliveryCount as N\u0027@DelayedDeliveryCount\u0027,\r\n\t\t\t@DelayedPickupCount as N\u0027@DelayedPickupCount\u0027,\r\n\t\t\t@TotalCount AS N\u0027@TotalCount\u0027\r\n\r\n*/\r\nCREATE      PROCEDURE [dbo].[Get_UnassignedReturnAndReplacementRequest_By_Filter_BACKUP]\r\n\t    --@ProvinceId\tSMALLINT = NULL,\r\n\t\t@CityIds NVARCHAR(MAX) = NULL,\r\n\t\t@PolygonIds NVARCHAR(MAX) = NULL,\r\n\t\t@StoreIds NVARCHAR(MAX) = NULL,\r\n\t\t@ParcelReferenceCode BIGINT = NULL,\r\n\t\t@CourierRequestTypeIds NVARCHAR(MAX) = NULL,\r\n\t\t@StartDeliveryTime BIGINT = NULL,\r\n\t\t@EndDeliveryTime BIGINT = NULL,\r\n\t\t@VendorParcelCode VARCHAR(32) = NULL,\r\n\t\t@VendorId INT = NULL,\r\n\t\t@IsExclusiveDelivery\t\t\t\t\t\tBIT = NULL,\r\n\t\t@IsNightly\t\t\t\t\t\t\t\t\tBIT = NULL,\r\n\t\t@UnassignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@AssignedDispatchRequestCount INT = 0 OUTPUT,\r\n\t\t@ReturnedRequestCount INT = 0 OUTPUT,\r\n\t\t@DelayedDeliveryCount INT = 0 OUTPUT,\r\n\t\t@DelayedPickupCount INT = 0 OUTPUT,\r\n\t\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=0,\t\t\t\t\r\n\t\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t= NULL,--=10,\t\r\n\t\t@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t\t@OperationStaffId\t\t\t\t\t\tINT \r\n\r\nAS \r\n\tSET NOCOUNT ON\r\n    --############################################ Preparation Data ##################################\r\n\r\n    drop table if EXISTS    #DispatchRequest,\r\n                            #Shipment,\r\n                            #Fleet,\r\n                            #FinalResult,\r\n\t\t\t\t\t\t\t#AllDispatchRequests\r\n     SELECT\r\n\t\t\t@CityIds                                 =ISNULL(@CityIds,\u00270\u0027),\r\n            @PolygonIds\t\t\t\t\t\t\t\t=ISNULL(@PolygonIds,\u00270\u0027),\r\n            @StoreIds\t\t\t\t\t\t\t\t=ISNULL(@StoreIds,\u00270\u0027),\r\n            @ParcelReferenceCode\t\t\t\t\t=ISNULL(@ParcelReferenceCode,0),\r\n            @CourierRequestTypeIds                  =ISNULL(@CourierRequestTypeIds,0),\r\n            @StartDeliveryTime                      =ISNULL(@StartDeliveryTime,0),\r\n            @EndDeliveryTime                        =ISNULL(@EndDeliveryTime,0),\r\n            @VendorParcelCode\t\t\t\t\t    =ISNULL(@VendorParcelCode,\u00270\u0027),\r\n\t\t\t@OperationStaffId                        =ISNULL(@OperationStaffId,0)\r\n\r\n\r\n\r\n\t\tDECLARE @CityId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CityId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CityIds,\u0027,\u0027)\r\n\r\n        DECLARE @PolygonId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @PolygonId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@PolygonIds,\u0027,\u0027)\r\n\r\n        DECLARE @StoreId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @StoreId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@StoreIds,\u0027,\u0027)\r\n\r\n\t\tDECLARE @CourierRequestTypeId TABLE\r\n\t\t(\r\n\t\t\tId SMALLINT\r\n\t\t)\r\n\t\tINSERT INTO @CourierRequestTypeId\r\n\t\tSELECT \r\n\t\t\tCAST(ISNULL(value,0) AS SMALLINT)\r\n\t\tFROM string_split(@CourierRequestTypeIds,\u0027,\u0027)\r\n\r\n\t\tDECLARE @Today INT\r\n\t\tSELECT @Today = CAST(SUBSTRING(CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),0,9) AS INT);\r\n     \r\n\t \r\n\t\tDECLARE @ToDate BIGINT=CONVERT(char(8),GETDATE()-7,112)\u002BREPLACE(CONVERT(char(12),GETDATE()-7, 114),\u0027:\u0027,\u0027\u0027)\r\n\r\n\t\tSELECT\tddr.Id DispatchRequestId,\r\n\t\t\t\tddr.ParcelReferenceCode,\r\n\t\t\t\tddr.DispatchRequestStatusId,\r\n\t\t\t\tddr.CourierRequestTypeId,\r\n\t\t\t\tLEFT(DeliveryStartTime,8) DeliveryStartTime_Date,\r\n\t\t\t\tddr.PolygonStoreId,\r\n\t\t\t\tdp.Id PolygonId,\r\n\t\t\t\tdp.Title PolygonTitle,\r\n\t\t\t\tps.StoreId,\r\n\t\t\t\ts.title\tStoreTitle,\r\n\t\t\t\tdp.CityId,\r\n\t\t\t\tddr.VendorParcelCode,\r\n\t\t\t\tClientAddress\r\n\t\t\t\t,DeliveryDeadLineTime\r\n\t\tINTO #AllDispatchRequests\r\n\t\tFROM DP.DispatchRequest(NOLOCK) ddr\r\n\t\tINNER JOIN DP.DispatchRequestStatus(NOLOCK) drs\t\tON ddr.DispatchRequestStatusId = drs.Id\r\n\t\tINNER JOIN DP.PolygonStore(NOLOCK) ps\t\t\t\tON ps.Id = ddr.PolygonStoreId\r\n\t\tINNER JOIN DP.Polygon(NOLOCK) dp\t\t\t\t\tON dp.Id = ps.PolygonId\r\n\t\tINNER JOIN DP.Store(NOLOCK) AS s\t\t\t\t\tON ps.StoreId = s.Id\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = dp.Id AND pos.IsActive = 1\r\n\t\tWHERE ddr.DeliveryDeadLineTime \u003E=@ToDate\r\n\t\tAND (dp.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and (dp.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n/************************************************************************/\r\n\r\n\t\tSELECT \r\n\t\t\t\t@UnassignedDispatchRequestCount = COUNT(dr.DispatchRequestId)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (5,6)\r\n\t\t\t  AND dr.DeliveryStartTime_Date = @Today\r\n--------------------------------------------------------------------------------------\r\n\r\n\t\tSELECT \r\n\t\t\t\t@AssignedDispatchRequestCount = COUNT(DISTINCT dr.ParcelReferenceCode)\r\n\t\tFROM #AllDispatchRequests dr\r\n\t\tWHERE dr.DispatchRequestStatusId IN (10,11,15,16,20,25,45,46,47,48,49,50,51,52,53,54)\r\n/*********************************************************************************/\r\n\tSELECT @ReturnedRequestCount=COUNT( dr.ParcelReferenceCode)\r\n\tFROM #AllDispatchRequests dr\r\n        join dp.DispatchRequestStatus drs on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n        join dp.Polygon p1 on ps.PolygonId = p1.Id\r\n        --INNER JOIN @PolygonId p2\tON p1.Id = p2.Id\r\n        --JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        join dp.Store s on ps.StoreId = s.Id\r\n\r\n        where (\r\n                (DispatchRequestStatusId not in (30,35,100) and CourierRequestTypeId = 25)\r\n                OR\r\n                (DispatchRequestStatusId in (45,46,47,48,49) and CourierRequestTypeId in (5,10,15))\r\nAND dr.DeliveryDeadLineTime \u003E=@ToDate)\r\n\r\n\r\n\r\n/***************************************************************/\r\n\r\n\t\t--SELECT\r\n\t\t--\t\t@ReturnedRequestCount = COUNT(dr.DispatchRequestId)\r\n  --      FROM #AllDispatchRequests dr\r\n\t\t--JOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\t--JOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\t--WHERE dr.DispatchRequestStatusId in (5,10,15)\r\n\t\t--AND sdp.OperationTypeId = 15\r\n\r\n\t\tSELECT\r\n\t\t\t\t@DelayedDeliveryCount = COUNT(DISTINCT dr.DispatchRequestId)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE sdp.OperationTypeId IN (10) \r\n\t\t--AND sdp.ShipmentDestinationPointStatusId IN (5,10,15)\r\n\t\tAND dr.DispatchRequestStatusId IN (20/*Picked up*/,25/*Arrived at Delivery Point*/)\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME))\r\n/******************************************************************************/\r\n\t\tSELECT\r\n\t\t\t\t@DelayedPickupCount = COUNT(DISTINCT dr.DispatchRequestId)\r\n        FROM #AllDispatchRequests dr\r\n\t\tJOIN DP.ShipmentDestinationPointDispatchRequest AS sdpdr ON sdpdr.DispatchRequestId = dr.DispatchRequestId\r\n\t\tJOIN DP.ShipmentDestinationPoint AS sdp ON sdp.Id = sdpdr.ShipmentDestinationPointId\r\n\t\tWHERE dr.DispatchRequestStatusId in (10,11,15,16)\r\n\t\t--AND sdp.ShipmentDestinationPointStatusId \u003C\u003E 30\r\n\t\tAND sdp.OperationTypeId = 5\r\n\t\tAND getdate() \u003E DATEADD(SECOND,sdp.EstimatedOperationTimeSeconds,CAST(CONVERT(VARCHAR, FORMAT(EstimatedArrivalTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)) \r\n\r\n    --############################################ Pre Calculate Result ##############################################\r\n        \r\n\t\tSELECT \r\n                    [dr].[Id],\r\n                    [dr].[DispatchRequestStatusId],\r\n                    drs.Title  as StatusTitle,\r\n\t\t\t\t\ts.VendorId,\r\n                    [dr].[ParcelReferenceCode],\r\n                    dr.CourierRequestTypeId,\r\n                    p1.CityId,\r\n                    ps.PolygonId,\r\n                    p1.Title as PolygonTitle,\r\n                    StoreId,\r\n                    s.Title as StoreTitle,\r\n\t\t\t\t\ts.Location.STY\t\t\t\t\tStoreLocationLatitude,\r\n\t\t\t\t\ts.Location.STX\t\t\t\t\tStoreLocationLongitude,\r\n                    dr.DeliveryStartTime,\r\n                    dr.DeliveryStartTimePersian,\r\n                    dr.DeliveryDeadLineTime,\r\n                    dr.DeliveryDeadLineTimePersian,                    \r\n                    (\r\n                                    select CAST(DATEDIFF(\r\n                                                            SECOND,\r\n                                                            GETDATE(),\r\n                                                            CAST(CONVERT(VARCHAR, FORMAT(dr.DeliveryDeadLineTime, \u0027####-##-## ##:##:##\\.###\u0027), 120) AS DATETIME)\r\n                                                            \t\t\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t    ) as BIGINT)\r\n                    ) as RemainedToDeadlineSeconds,\r\n\t\t\t\t\tdr.ClientLocation.STY\t\t\tClientlocationLatitude,\r\n\t\t\t\t\tdr.ClientLocation.STX\t\t\tClientlocationLongitude,\r\n                    dr.VendorParcelCode,\r\n\t\t\t\t\tdr.CreateDate,\r\n                    dr.CreateDatePersian,\r\n\t\t\t\t\tClientAddress,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly\r\n\r\n        into #DispatchRequest\r\n        FROM dp.DispatchRequest dr\r\n        join dp.DispatchRequestStatus drs on dr.DispatchRequestStatusId = drs.Id\r\n        join dp.PolygonStore ps on dr.PolygonStoreId = ps.Id\r\n       \r\n        join dp.Polygon p1 on ps.PolygonId = p1.Id\r\n        join dp.Store s on ps.StoreId = s.Id\r\n\t\tINNER JOIN DP.PolygonOperationStaff(NOLOCK) pos\t\tON pos.PolygonId = p1.Id AND pos.IsActive = 1\r\n        where (dr.DispatchRequestStatusId = 5 AND dr.CourierRequestTypeId IN (26,30,35,40,45,50,60,65,70))\r\n        and ((dr.DeliveryStartTime BETWEEN @StartDeliveryTime and @EndDeliveryTime or dr.DeliveryDeadLineTime BETWEEN @StartDeliveryTime and @EndDeliveryTime) or @StartDeliveryTime = 0 or @EndDeliveryTime = 0)\r\n        and ((s.Id IN (Select Id from @StoreId)) OR (@StoreIds=\u00270\u0027))\r\n        and (p1.Id IN (SELECT Id FROM @PolygonId) OR @PolygonIds=\u00270\u0027)\r\n        and ((dr.CourierRequestTypeId in (Select Id from @CourierRequestTypeId)) OR (@CourierRequestTypeIds = \u00270\u0027))\r\n        and (p1.CityId IN (SELECT Id FROM @CityId) OR @CityIds=\u00270\u0027)\r\n        and (dr.ParcelReferenceCode = @ParcelReferenceCode OR @ParcelReferenceCode = 0)\r\n        and (dr.VendorParcelCode = @VendorParcelCode or @VendorParcelCode = \u00270\u0027)\r\n\t\tAND (pos.OperationStaffId = @OperationStaffId)\r\n\t\tAND ( dr.IsExclusiveDelivery = @IsExclusiveDelivery OR @IsExclusiveDelivery IS NULL )\r\n\t\tAND ( dr.IsNightly = @IsNightly OR @IsNightly IS NULL )\r\n\t\tSET @TotalCount = @@ROWCOUNT\r\n        \r\n    --############################################ Calculate Result ##############################################\r\n        select distinct\r\n                    [dr].[Id] DispatchRequestId,\r\n                    [dr].[DispatchRequestStatusId],\r\n                    [dr].[StatusTitle] as DispatchRequestStatusTitle,\r\n\t\t\t\t\t[dr].VendorId,\r\n                    [dr].[ParcelReferenceCode],\r\n\t\t\t\t\t[dr].[VendorParcelCode],\r\n                    [dr].[CourierRequestTypeId],\r\n                    [dr].[CityId],\r\n                    [dr].[PolygonId],\r\n                    [dr].[PolygonTitle],\r\n                    [dr].[StoreId],\r\n                    [dr].[StoreTitle],\r\n\t\t\t\t\tStoreLocationLatitude,\r\n\t\t\t\t\tStoreLocationLongitude,\t\t\t\t\t\r\n                    FORMAT([dr].[DeliveryStartTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryStartTimeStr,\r\n                    FORMAT([dr].[DeliveryStartTimePersian],\u0027####-##-## ##:##:##\\.###\u0027)DeliveryStartTimePersianStr,\r\n                    FORMAT([dr].[DeliveryDeadLineTime],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryDeadLineTimeStr,\r\n                    FORMAT([dr].[DeliveryDeadLineTimePersian],\u0027####-##-## ##:##:##\\.###\u0027) DeliveryDeadLineTimePersianStr,\r\n\t\t\t\t\tFORMAT([dr].[CreateDatePersian],\u0027####-##-## ##:##:##\\.###\u0027) CreateDatePersianStr,\r\n\t\t\t\t\t[dr].[RemainedToDeadlineSeconds],\r\n\t\t\t\t\tClientlocationLatitude,\r\n\t\t\t\t\t\tClientlocationLongitude,\r\n\t\t\t\t\tClientAddress,\r\n\t\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\t\tdr.IsNightly\r\n        from #DispatchRequest dr\r\n\r\n\t\tORDER BY dr.RemainedToDeadlineSeconds\r\n\t\tOFFSET @pageIndex * @pageSize ROWS FETCH NEXT @pageSize ROWS ONLY\r\n"},{"Name":"Get_VendorParcelCode_By_Score","Schema":"dbo","Definition":"CREATE   PROC [dbo].[Get_VendorParcelCode_By_Score]\r\n(\r\n\t@StoreId int ,\r\n\t@RunCode bigint ,\r\n\t@Result NVARCHAR(MAX) OUTPUT\r\n)\r\nAS\r\n\r\n\r\nDECLARE\r\n\t@StoreId_Local int ,\r\n\t@RunCode_Local bigint \r\n\t\r\nSELECT \r\n\t@StoreId_Local = @StoreId ,\r\n\t@RunCode_Local = @RunCode\r\n\r\n;WITH CTE_Data AS\r\n(\r\n\tSELECT \r\n\t\tpass.Score,\r\n\t\tdr.VendorParcelCode,\r\n\t\tspasd.DispatchRequestPoint AS Point\r\n\tFROM \r\n\t[DP].[PreAssignmentStoreScore] pass WITH(NOLOCK)\r\n\tINNER JOIN [DP].[StorePreAssignmentScoreDetail] spasd WITH(NOLOCK)\r\n\t\tON pass.ID = spasd.PreAssignmentStoreScoreId\r\n\tINNER JOIN DP.DispatchRequest dr WITH(NOLOCK)\r\n\t\tON spasd.DispatchRequestId = dr.ID\r\n\t/*INNER JOIN DP.StoreScoreSetting sss WITH(NOLOCK)\r\n\t\tON spasd.StoreScoreSettingId = sss.ID*/\r\n\tWHERE pass.StoreId = @StoreId_Local\r\n\tAND pass.RunCode = @RunCode_Local\r\n),CTE_ScoringDetail AS\r\n(\r\n\tSELECT \r\n\t\tCount(DISTINCT ff.VendorParcelCode) VendorParcelCode_Count,\r\n\t\tff.Point\r\n\tFROM CTE_Data ff\r\n\tGroup By \r\n\t\tff.Point\r\n),CTE_Parcels AS\r\n(\r\n\tSELECT DISTINCT sd.Point,d.VendorParcelCode\r\n\tFROM CTE_ScoringDetail sd\r\n\tINNER JOIN CTE_Data d\r\n\t\tON sd.Point = d.Point\r\n)\r\nSELECT @Result = \r\n(\r\n\tSELECT DISTINCT\r\n\t\t( \r\n\t\t\tSELECT DISTINCT Score FROM CTE_Data d\r\n\t\t) Score,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tsd.Point,\r\n\t\t\t\tCAST(sd.Point*sd.VendorParcelCode_Count AS DECIMAL(8,2)) AS SumPoints,\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT \r\n\t\t\t\t\t\tp.VendorParcelCode\r\n\t\t\t\t\tFROM CTE_Parcels p\r\n\t\t\t\t\tWHERE p.Point = sd.Point\r\n\t\t\t\t\tFOR JSON PATH\r\n\t\t\t\t) Parcels\r\n\t\t\tFROM CTE_ScoringDetail sd\r\n\t\t\tFOR JSON PATH\r\n\t\t) ScoringDetail\r\n\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n)\r\n\r\n\r\n/*\r\nDROP TABLE IF EXISTS #Temp\r\n;WITH CTE_DR AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\t--dr.ID DispatchRequestID,\r\n\t\tdr.VendorParcelCode,\r\n\t\tps.PolygonId,\r\n\t\tps.StoreId,\r\n\t\tDATEDIFF(second,GetDATE(),FORMAT(dr.DeliveryDeadLineTime,\u0027####-##-## ##:##:##\\.###\u0027)) DeadLine\r\n\tFROM [DP].[DispatchRequest] dr WITH (NOLOCK)\r\n\tINNER JOIN [DP].[PolygonStore] ps WITH (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.ID\r\n\t--LEFT JOIN [DP].[StorePreAssignmentScoreDetail] spasd WITH (NOLOCK)\r\n\t--\tON dr.ID = spasd.DispatchRequestId\r\n\tWHERE dr.DispatchRequestStatusId = 5\r\n\tAND ps.StoreId = @StoreId_Local\r\n\t--AND spasd.ID IS NULL\r\n), CTE_DispatchRequests AS\r\n(\r\n\tSELECT \r\n\t\t* ,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tID\r\n\t\t\tFROM [DP].[StoreScoreCategoryConfiguration] WITH (NOLOCK)\r\n\t\t\tWHERE isActive = 1\r\n\t\t\tAND ( dr.DeadLine \u003E= [From] OR [From] IS NULL )\r\n\t\t\tAND ( dr.DeadLine \u003C [To] OR [To] IS NULL )\r\n\t\t) StoreScoreCategoryConfigurationId\r\n\tFROM CTE_DR dr\r\n),CTE_Temp AS\r\n(\r\nSELECT \r\n\tdr.*,\r\n\tsss.ID StoreScoreSettingId,\r\n\tsss.Point\r\nFROM CTE_DispatchRequests dr\r\nINNER JOIN [DP].[StoreScoreSetting] sss WITH (NOLOCK)\r\n\tON dr.PolygonId = sss.PolygonId\r\n\tAND dr.StoreScoreCategoryConfigurationId = sss.StoreScoreCategoryConfigurationId\r\n)\r\nSELECT @Result = \r\n\t(\r\n\t\tSELECT \r\n\t\t\tSUM(Point) Score,\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\t\ttt.VendorParcelCode,\r\n\t\t\t\t\ttt.Point\r\n\t\t\t\tFROM CTE_Temp tt\r\n\t\t\t\t--INNER JOIN DP.DispatchRequest dr WITH(NOLOCK)\r\n\t\t\t\t--\tON tt.DispatchRequestID = dr.ID\r\n\t\t\t\tWHERE tt.StoreId = t.StoreId\r\n\t\t\t\tFOR JSON PATH\r\n\t\t\t)ScoringHistory\r\n\t\tFROM CTE_Temp t\r\n\t\tGroup By StoreId\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t)\r\n\t/*\r\nIF EXISTS ( SELECT * FROM #Temp )\r\nBEGIN\r\n\t\r\n\tDECLARE @Per BIGINT,\r\n\t\t\t@Gre BIGINT,\r\n\r\n\t\t\t@PreAssignmentStoreScore BIGINT = NULL\r\n\r\n\tSELECT @Per = FORMAT(GETDATE(), \u0027yyyyMMddHHmmss\u0027, \u0027fa\u0027)\u002BCAST(DATEPART(ms,GETDATE()) AS CHAR(3))\r\n\tSELECT @Gre = FORMAT(GETDATE(), \u0027yyyyMMddHHmmss\u0027)\u002BCAST(DATEPART(ms,GETDATE()) AS CHAR(3))\r\n\r\n\tINSERT INTO [DP].[PreAssignmentStoreScore] (StoreId ,Score ,RunCode ,CreateDate ,CreateDatePersian )\r\n\tSELECT \r\n\t\tStoreId,\r\n\t\tSUM(Point),\r\n\t\t@RunCode,\r\n\t\t@Gre,\r\n\t\t@Per\r\n\tFROM #Temp\r\n\tGroup By StoreId\r\n\r\n\tSET @PreAssignmentStoreScore = SCOPE_IDENTITY()\r\n\r\n\tINSERT INTO [DP].[StorePreAssignmentScoreDetail] (PreAssignmentStoreScoreId ,StoreScoreSettingId ,DispatchRequestId ,CreateDate ,CreateDatePersian)\r\n\tSELECT \r\n\t\t@PreAssignmentStoreScore,\r\n\t\tStoreScoreSettingId,\r\n\t\tDispatchRequestId,\r\n\t\t@Gre,\r\n\t\t@Per\r\n\tFROM #Temp\r\n\r\n\tSELECT @Result = \r\n\t(\r\n\t\tSELECT \r\n\t\t\tSUM(Point) Score,\r\n\t\t\t(\r\n\t\t\t\tSELECT DISTINCT\r\n\t\t\t\t\tdr.VendorParcelCode,\r\n\t\t\t\t\ttt.Point\r\n\t\t\t\tFROM #Temp tt\r\n\t\t\t\tINNER JOIN DP.DispatchRequest dr WITH(NOLOCK)\r\n\t\t\t\t\tON tt.DispatchRequestID = dr.ID\r\n\t\t\t\tWHERE tt.StoreId = t.StoreId\r\n\t\t\t\tFOR JSON PATH\r\n\t\t\t)ScoringHistory\r\n\t\tFROM #Temp t\r\n\t\tGroup By StoreId\r\n\t\tFOR JSON PATH , WITHOUT_ARRAY_WRAPPER\r\n\t)\r\n\t\r\nEND\r\n*/\r\n*/\r\n\r\n\r\n\r\n"},{"Name":"Insert_FleetShiftHistory_Test","Schema":"dbo","Definition":"\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1402/04/12\r\n--\tDescription:\tInsert Fleet Shit History\r\n--\r\n--\t=======================================\r\n\r\n/*\r\n\tEXEC Insert_FleetShiftHistory\r\n*/\r\n\r\nCREATE PROCEDURE [dbo].[Insert_FleetShiftHistory_Test]\r\nAS\r\n\tSET NOCOUNT ON\r\n    \r\n    --========================================================= Preparation Data --=========================================================\r\n\tDROP TABLE IF EXISTS #FleetShiftPick,\r\n\t\t\t\t\t\t #FleetShiftNormal\r\n\tDECLARE @WorkDate INT\r\n\tSELECT @WorkDate = dd.DateKey FROM DW_CourierService.DIM.DimDate AS dd (NOLOCK) WHERE dd.DateKey = CAST(REPLACE(CONVERT(Date,GETDATE()-1),\u0027-\u0027,\u0027\u0027) AS BIGINT)\r\n\r\n\tSELECT \r\n\t\t\tfs.Id,\r\n\t\t\tsc.Id AS ShiftConfigurationId,\r\n\t\t\tfs.FleetId,\r\n\t\t\tfs.WeekDayId,\r\n\t\t\tsc.StartTime,\r\n\t\t\tsc.EndTime,\r\n\t\t\tsc.IsPeakTime\r\n\tINTO #FleetShiftPick\r\n\tFROM DP.Fleet AS f\r\n\tJOIN DP.FleetShift AS fs ON fs.FleetId = f.Id\r\n\tJOIN DP.ShiftConfiguration AS sc ON sc.Id = fs.ShiftConfigurationId\r\n\tWHERE f.IsActive = 1 \r\n\tAND fs.IsDeleted = 0\r\n\tAND sc.IsPeakTime = 1\r\n\tAND CAST(LEFT(fs.CreateDate,8) AS INT) = @WorkDate \r\n\tORDER BY fs.FleetId,fs.WeekDayId\r\n\r\n\tSELECT \r\n\t\t\tfs.Id,\r\n\t\t\tsc.Id AS ShiftConfigurationId,\r\n\t\t\tfs.FleetId,\r\n\t\t\tfs.WeekDayId,\r\n\t\t\tsc.StartTime,\r\n\t\t\tsc.EndTime,\r\n\t\t\tsc.IsPeakTime\r\n\tINTO #FleetShiftNormal\r\n\tFROM DP.Fleet AS f\r\n\tJOIN DP.FleetShift AS fs ON fs.FleetId = f.Id\r\n\tJOIN DP.ShiftConfiguration AS sc ON sc.Id = fs.ShiftConfigurationId\r\n\tWHERE f.IsActive = 1 \r\n\tAND fs.IsDeleted = 0\r\n\tAND sc.IsPeakTime = 0\r\n\tAND CAST(LEFT(fs.CreateDate,8) AS INT) = @WorkDate \r\n\tORDER BY fs.FleetId,fs.WeekDayId\r\n\t\r\n\tDECLARE @FleetId BIGINT,\r\n\t\t\t@StartPick TIME(7),\r\n\t\t\t@EndPick TIME(7),\r\n\t\t\t@StartNormal TIME(7),\r\n\t\t\t@EndNormal TIME(7)\r\n    DECLARE Fleet CURSOR\r\n    FOR SELECT DISTINCT\r\n\t\t\tfsn.FleetId,\r\n\t\t\tfsp.StartTime,\r\n\t\t\tfsp.EndTime,\r\n\t\t\tfsn.StartTime,\r\n\t\t\tfsn.EndTime\r\n\t\tFROM #FleetShiftNormal AS fsn\r\n\t\tLEFT JOIN #FleetShiftPick AS fsp ON fsp.FleetId = fsn.FleetId\r\n\t\tWHERE fsp.StartTime IS NOT NULL \r\n\t\t--ORDER BY fs.FleetId,fs.WeekDayId\r\n    OPEN Fleet;\r\n\r\n    FETCH NEXT FROM Fleet INTO \r\n        @FleetId,\r\n\t\t@StartPick,\r\n\t\t@EndPick,\r\n\t\t@StartNormal,\r\n\t\t@EndNormal\r\n\r\n    WHILE @@FETCH_STATUS = 0\r\n    BEGIN\r\n            \r\n\r\n\t\t--SELECT @FleetId,\r\n\t\t--@StartPick StartPick,\r\n\t\t--@EndPick EndPick,\r\n\t\t--@StartNormal StartNormal,\r\n\t\t--@EndNormal EndNormal \r\n\r\n\t\t--========================================================= B\u003CA\u003CB\u0027 and A\u0027 out of B-B\u0027 ================================================================\r\n\t\tIF @StartPick BETWEEN @StartNormal AND @EndNormal AND @EndPick \u003E @EndNormal AND @StartPick \u003C\u003E @EndNormal\r\n\t\tBEGIN\r\n\t\t\t--SELECT 1\r\n\t\t\tINSERT INTO dbo.FleetShiftTest\r\n\t\t\t(\r\n\t\t\t    FleetId,\r\n\t\t\t    StartTime,\r\n\t\t\t    EndTime,\r\n\t\t\t    IsPeakTime,\r\n\t\t\t    WorkDate,\r\n\t\t\t    CreateDate,\r\n\t\t\t    CreateDatePersian\r\n\t\t\t)\r\n\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@EndNormal,\r\n\t\t\t\t@EndPick,\r\n\t\t\t\t0,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\tUNION ALL\r\n\t\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@StartPick,\r\n\t\t\t\t@EndNormal,\r\n\t\t\t\t1,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\tUNION ALL\r\n\t\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@EndNormal,\r\n\t\t\t\t@EndPick,\r\n\t\t\t\t1,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\t\t--CONVERT(time(7),dateadd(second,datediff(second,@StartPick,@EndNormal),0))\r\n\t\tEND\r\n\r\n\t\t--========================================================= A\u003CB\u003CA\u0027 and B\u0027 out of A-A\u0027 ================================================================\r\n\t\tELSE IF @EndNormal BETWEEN @StartPick AND @EndPick AND @EndNormal \u003E @EndPick\r\n\t\tBEGIN\r\n\t\t\t--SELECT 2\r\n\t\t\tINSERT INTO dbo.FleetShiftTest\r\n\t\t\t(\r\n\t\t\t    FleetId,\r\n\t\t\t    StartTime,\r\n\t\t\t    EndTime,\r\n\t\t\t    IsPeakTime,\r\n\t\t\t    WorkDate,\r\n\t\t\t    CreateDate,\r\n\t\t\t    CreateDatePersian\r\n\t\t\t)\r\n\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@EndNormal,\r\n\t\t\t\t@EndPick,\r\n\t\t\t\t0,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\tUNION ALL\r\n\t\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@EndPick,\r\n\t\t\t\t@EndNormal,\r\n\t\t\t\t1,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\t\r\n\t\tEND\r\n\r\n\t\t--========================================================= B\u003CA\u0027\u003CB\u0027 and A out of B-B\u0027 ================================================================\r\n\t\tELSE IF @EndPick BETWEEN @StartNormal AND @EndNormal AND @StartPick \u003C @StartNormal AND @EndPick \u003C\u003E @StartNormal\r\n\t\tBEGIN\r\n\t\t\t--SELECT 3\r\n\t\t\tINSERT INTO dbo.FleetShiftTest\r\n\t\t\t(\r\n\t\t\t    FleetId,\r\n\t\t\t    StartTime,\r\n\t\t\t    EndTime,\r\n\t\t\t    IsPeakTime,\r\n\t\t\t    WorkDate,\r\n\t\t\t    CreateDate,\r\n\t\t\t    CreateDatePersian\r\n\t\t\t)\r\n\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@EndPick,\r\n\t\t\t\t@EndNormal,\r\n\t\t\t\t0,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\tUNION ALL\r\n\t\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@StartPick,\r\n\t\t\t\t@StartNormal,\r\n\t\t\t\t1,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\tUNION ALL\r\n\t\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@StartNormal,\r\n\t\t\t\t@EndPick,\r\n\t\t\t\t1,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\t\r\n\t\tEND\r\n\r\n\t\t--========================================================= A\u003CB\u0027\u003CA\u0027 and B out of A-A\u0027 ================================================================\r\n\t\tELSE IF @EndNormal BETWEEN @StartPick AND @EndPick AND @StartNormal \u003E @EndPick\r\n\t\tBEGIN\r\n\t\t\t--SELECT 4\r\n\t\t\tINSERT INTO dbo.FleetShiftTest\r\n\t\t\t(\r\n\t\t\t    FleetId,\r\n\t\t\t    StartTime,\r\n\t\t\t    EndTime,\r\n\t\t\t    IsPeakTime,\r\n\t\t\t    WorkDate,\r\n\t\t\t    CreateDate,\r\n\t\t\t    CreateDatePersian\r\n\t\t\t)\r\n\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@StartNormal,\r\n\t\t\t\t@StartPick,\r\n\t\t\t\t0,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\tUNION ALL\r\n\t\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@StartPick,\r\n\t\t\t\t@EndNormal,\r\n\t\t\t\t1,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\tUNION ALL\r\n\t\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@EndNormal,\r\n\t\t\t\t@EndPick,\r\n\t\t\t\t1,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\t\r\n\t\tEND\r\n\r\n\t\t--========================================================= B\u003CA-A\u0027\u003CB\u0027 ================================================================\r\n\t\tELSE IF @StartPick \u003E @StartNormal AND @EndPick \u003C @EndNormal\r\n\t\tBEGIN\r\n\t\t\t--SELECT 5\r\n\t\t\tINSERT INTO dbo.FleetShiftTest\r\n\t\t\t(\r\n\t\t\t    FleetId,\r\n\t\t\t    StartTime,\r\n\t\t\t    EndTime,\r\n\t\t\t    IsPeakTime,\r\n\t\t\t    WorkDate,\r\n\t\t\t    CreateDate,\r\n\t\t\t    CreateDatePersian\r\n\t\t\t)\r\n\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@StartNormal,\r\n\t\t\t\t@StartPick,\r\n\t\t\t\t0,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\tUNION ALL\r\n\t\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@EndPick,\r\n\t\t\t\t@EndNormal,\r\n\t\t\t\t0,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\tUNION ALL\r\n\t\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@StartPick,\r\n\t\t\t\t@EndPick,\r\n\t\t\t\t1,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\t\r\n\t\tEND\r\n\r\n\t\t--========================================================= A\u003CB-B\u0027\u003CA\u0027 ================================================================\r\n\t\tELSE IF @EndNormal BETWEEN @StartPick AND @EndPick AND @StartNormal \u003E @EndPick\r\n\t\tBEGIN\r\n\t\t\t--SELECT 6\r\n\t\t\tINSERT INTO dbo.FleetShiftTest\r\n\t\t\t(\r\n\t\t\t    FleetId,\r\n\t\t\t    StartTime,\r\n\t\t\t    EndTime,\r\n\t\t\t    IsPeakTime,\r\n\t\t\t    WorkDate,\r\n\t\t\t    CreateDate,\r\n\t\t\t    CreateDatePersian\r\n\t\t\t)\r\n\t\t\tSELECT \r\n\t\t\t\t@FleetId,\r\n\t\t\t\t@StartPick,\r\n\t\t\t\t@EndPick,\r\n\t\t\t\t1,\r\n\t\t\t\t@WorkDate,\r\n\t\t\t\tCONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027),\r\n\t\t\t\tREPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n\t\t\t\t\t\t\r\n\t\tEND\r\n\r\n        FETCH NEXT FROM Fleet INTO \r\n                        @FleetId,\r\n\t\t@StartPick,\r\n\t\t@EndPick,\r\n\t\t@StartNormal,\r\n\t\t@EndNormal\r\n        END;\r\n\r\n    CLOSE Fleet;\r\n\r\n    DEALLOCATE Fleet;\r\n\r\n\tDELETE FROM dbo.FleetShiftTest WHERE StartTime = EndTime;\r\n\t;WITH SameShift AS\r\n    (\r\n\t\tSELECT \r\n\t\t\t\t*,\r\n\t\t\t\tROW_NUMBER() OVER(PARTITION BY fsh.FleetId,fsh.StartTime,fsh.EndTime,fsh.IsPeakTime ORDER BY fsh.FleetId) AS SameShift\r\n\t\tFROM dbo.FleetShiftTest AS fsh\r\n\t)\r\n\tDELETE fsh \r\n\tFROM dbo.FleetShiftTest AS fsh\r\n\tJOIN SameShift ON fsh.Id = SameShift.Id\r\n\tWHERE SameShift.SameShift \u003E1\r\n\r\n\t;WITH PickPriority AS \r\n\t(\r\n\t\tSELECT \r\n\t\t\t\t*,\r\n\t\t\t\tROW_NUMBER() OVER(PARTITION BY fsh.FleetId,fsh.StartTime,fsh.EndTime ORDER BY fsh.FleetId,fsh.IsPeakTime DESC) AS PickShift\r\n\t\tFROM dbo.FleetShiftTest AS fsh\r\n\t)\r\n\r\n\tDELETE fsh\r\n\tFROM dbo.FleetShiftTest AS fsh\r\n\tJOIN PickPriority ON fsh.Id = PickPriority.Id\r\n\tWHERE PickPriority.PickShift \u003E1 AND fsh.IsPeakTime = 0"},{"Name":"Insert_ShipmentModificationStatus_By_ShipmentIds","Schema":"dbo","Definition":"\r\nCREATE   PROC [dbo].[Insert_ShipmentModificationStatus_By_ShipmentIds] \r\n(\r\n\t@ShipmentIds NVARCHAR(MAX) ,\r\n\t@ShipmentModiicationReasonId TINYINT,\r\n\t@ShipmentModifier NVARCHAR(MAX),\r\n\t@IsInsertLogSuccessful  BIT OUTPUT\r\n)\r\nAS\r\n\r\n\r\nDROP TABLE IF EXISTS #ShipmentID\r\nDROP TABLE IF EXISTS #Final\r\n\r\n DECLARE @Per BIGINT,\r\n\t\t@Gre BIGINT\r\nSELECT @Per = FORMAT(GETDATE(), \u0027yyyyMMddHHmmss\u0027, \u0027fa\u0027)\u002BCAST(DATEPART(ms,GETDATE()) AS CHAR(3))\r\nSELECT @Gre = FORMAT(GETDATE(), \u0027yyyyMMddHHmmss\u0027)\u002BCAST(DATEPART(ms,GETDATE()) AS CHAR(3))\r\n\r\n\r\nSELECT DISTINCT\r\n\tCAST(ss.value AS BIGINT) ShipmentID\r\nINTO #ShipmentID\r\nFROM String_split(@ShipmentIds,\u0027,\u0027) ss\r\n\r\nBEGIN TRY\r\n\r\n\t; WITH CTE_ShipmentID AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\ts.ID ShipmentID,\r\n\t\t\ts.FleetId,\r\n\t\t\ts.TotalEstimatedDurationSeconds,\r\n\t\t\ts.TotalDistanceMeter,\r\n\t\t\ts.SuggestedRoute,\r\n\t\t\ts.ArrivalDelaySeconds\r\n\t\tFROM #ShipmentID s1\r\n\t\tINNER JOIN CS_Dispatcher.DP.Shipment s (NOLOCK)\r\n\t\t\tON s1.ShipmentID = s.ID\r\n\t), CTE_ShipmentDestinationPoint AS\r\n\t(\r\n\r\n\t\tSELECT \r\n\t\t\tsdp.ShipmentID,\r\n\t\t\tsdp.ID ShipmentDestinationPointID,\r\n\t\t\tsdp.OperationTypeId,\r\n\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\tsdp.AssignmentMethodId,\r\n\t\t\tsdp.MapServiceProviderId,\r\n\t\t\tsdp.Location,\r\n\t\t\tsdp.IsVendorLocation,\r\n\t\t\tsdp.SequenceNumber,\r\n\t\t\tsdp.DisplacementMeter,\r\n\t\t\tsdp.DistanceMeter,\r\n\t\t\tsdp.EstimatedDurationSeconds,\r\n\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\tsdp.EstimatedArrivalTimePersian,\r\n\t\t\tsdp.UpdateDate,\r\n\t\t\tsdp.UpdateDatePersian\r\n\t\tFROM\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tsdp.ID\r\n\t\t\tFROM CTE_ShipmentID s\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\tON s.ShipmentID = sdp.ShipmentId\r\n\t\t\tEXCEPT\r\n\t\t\tSELECT \r\n\t\t\t\tsdp.ID\r\n\t\t\tFROM CTE_ShipmentID s\r\n\t\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\t\tON s.ShipmentID = sdp.ShipmentId\r\n\t\t\t\tAND sdp.ShipmentDestinationPointStatusId IN ( 30,35,40,100 )\r\n\t\t) SQ\r\n\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\tON SQ.Id = sdp.ID\r\n\t),CTE_DispatchRequest AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tsdp.ShipmentID,\r\n\t\t\tsdp.ShipmentDestinationPointID,\r\n\t\t\tsdpdr.DispatchRequestId,\r\n\t\t\tdr.DispatchRequestStatusId,\r\n\t\t\tdr.CourierRequestTypeId,\r\n\t\t\tdr.VendorParcelCode,\r\n\t\t\tdr.ParcelReferenceCode,\r\n\t\t\tdr.ClientAddress,\r\n\t\t\tdr.DeliveryStartTime,\r\n\t\t\tdr.DeliveryStartTimePersian,\r\n\t\t\tdr.DeliveryDeadLineTime,\r\n\t\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\t\tdr.AssignmentTryCount,\r\n\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\tdr.UpdateDate,\r\n\t\t\tdr.UpdateDatePersian,\r\n\t\t\tps.PolygonId,\r\n\t\t\tps.StoreId\r\n\t\tFROM CTE_ShipmentDestinationPoint sdp\r\n\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\tON sdp.ShipmentDestinationPointID = sdpdr.ShipmentDestinationPointId\r\n\t\tINNER JOIN CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\t\tON dr.PolygonStoreId = ps.ID\r\n\t\tEXCEPT\r\n\t\tSELECT \r\n\t\t\tsdp.ShipmentID,\r\n\t\t\tsdp.ShipmentDestinationPointID,\r\n\t\t\tsdpdr.DispatchRequestId,\r\n\t\t\tdr.DispatchRequestStatusId,\r\n\t\t\tdr.CourierRequestTypeId,\r\n\t\t\tdr.VendorParcelCode,\r\n\t\t\tdr.ParcelReferenceCode,\r\n\t\t\tdr.ClientAddress,\r\n\t\t\tdr.DeliveryStartTime,\r\n\t\t\tdr.DeliveryStartTimePersian,\r\n\t\t\tdr.DeliveryDeadLineTime,\r\n\t\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\t\tdr.AssignmentTryCount,\r\n\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\tdr.UpdateDate,\r\n\t\t\tdr.UpdateDatePersian,\r\n\t\t\tps.PolygonId,\r\n\t\t\tps.StoreId\r\n\t\tFROM CTE_ShipmentDestinationPoint sdp\r\n\t\tINNER JOIN CS_Dispatcher.DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\tON sdp.ShipmentDestinationPointID = sdpdr.ShipmentDestinationPointId\r\n\t\tINNER JOIN CS_Dispatcher.DP.DispatchRequest dr (NOLOCK)\r\n\t\t\tON sdpdr.DispatchRequestId = dr.ID\r\n\t\t\tAND dr.DispatchRequestStatusId IN ( 17,40,100 )\r\n\t\tINNER JOIN CS_Dispatcher.DP.PolygonStore ps (NOLOCK)\r\n\t\t\tON dr.PolygonStoreId = ps.ID\r\n\t),CTE_DRC AS\r\n\t(\r\n\t\tSELECT \r\n\t\t\tdr.ShipmentId, \r\n\t\t\tCOUNT(DISTINCT dr.DispatchRequestId) DispatchRequestCount\r\n\t\tFROM CTE_DispatchRequest dr\r\n\t\tGROUP BY dr.ShipmentId\r\n\t)\r\n\r\n\tSELECT \r\n\t\tSQ.ShipmentID,\r\n\t\tSQ.FleetId,\r\n\t\tSQ.PolygonId,\r\n\t\tSQ.StoreId,\r\n\t\tSQ.DispatchRequestCount ,\r\n\t\tSQ.TotalEstimatedDurationSeconds,\r\n\t\tSQ.TotalDistanceMeter,\r\n\t\tSQ.SuggestedRoute,\r\n\t\tSQ.ArrivalDelaySeconds,\r\n\t\r\n\t\t(\r\n\t\t\tSELECT DISTINCT\r\n\t\t\t\tdr.DispatchRequestId AS Id,\r\n\t\t\t\tdr.DispatchRequestStatusId,\r\n\t\t\t\tdr.CourierRequestTypeId,\r\n\t\t\t\tdr.VendorParcelCode,\r\n\t\t\t\tdr.ParcelReferenceCode,\r\n\t\t\t\tdr.ClientAddress,\r\n\t\t\t\tdr.DeliveryStartTime,\r\n\t\t\t\tdr.DeliveryStartTimePersian,\r\n\t\t\t\tdr.DeliveryDeadLineTime,\r\n\t\t\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\t\t\tdr.AssignmentTryCount,\r\n\t\t\t\tdr.IsExclusiveDelivery,\r\n\t\t\t\tdr.UpdateDate,\r\n\t\t\t\tdr.UpdateDatePersian\r\n\t\t\tFROM CTE_DispatchRequest dr\r\n\t\t\tWHERE dr.ShipmentID = sq.ShipmentID\r\n\t\t\tFOR JSON PATH\r\n\t\t) DispatchRequests,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\tsdp.ShipmentDestinationPointID AS Id,\r\n\t\t\t\tsdp.OperationTypeId,\r\n\t\t\t\tsdp.ShipmentDestinationPointStatusId,\r\n\t\t\t\tsdp.AssignmentMethodId,\r\n\t\t\t\tsdp.MapServiceProviderId,\r\n\t\t\t\tJSON_QUERY((\r\n\t\t\t\t\tSELECT CAST(sdp.Location AS GEOMETRY).STY AS latitude, CAST(sdp.Location AS GEOMETRY).STX AS longitude\r\n\t\t\t\t\tFOR JSON PATH \r\n\t\t\t\t))Location,\r\n\t\t\t\tsdp.IsVendorLocation,\r\n\t\t\t\tsdp.SequenceNumber,\r\n\t\t\t\tsdp.DisplacementMeter,\r\n\t\t\t\tsdp.DistanceMeter,\r\n\t\t\t\tsdp.EstimatedDurationSeconds,\r\n\t\t\t\tsdp.EstimatedOperationTimeSeconds,\r\n\t\t\t\tsdp.EstimatedArrivalTime,\r\n\t\t\t\tsdp.EstimatedArrivalTimePersian,\r\n\t\t\t\tsdp.UpdateDate,\r\n\t\t\t\tsdp.UpdateDatePersian,\r\n\t\t\t\tJSON_QUERY((\r\n\t\t\t\t\tSELECT \u0027[\u0027\u002BSTRING_AGG(dr.DispatchRequestId,\u0027,\u0027)\u002B\u0027]\u0027\r\n\t\t\t\t\tFROM\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT DISTINCT dr.DispatchRequestId\r\n\t\t\t\t\t\tFROM CTE_DispatchRequest dr\r\n\t\t\t\t\t\tWHERE sdp.ShipmentDestinationPointID = dr.ShipmentDestinationPointID\r\n\t\t\t\t\t) dr\r\n\t\t\t\t)) RelatedDispatchRequests\r\n\t\t\tFROM CTE_ShipmentDestinationPoint sdp\r\n\t\t\tWHERE sdp.ShipmentID = sq.ShipmentID\r\n\t\t\tFOR JSON PATH\r\n\t\t)ShipmentDestinationPoints\r\n\tINTO #Final\r\n\tFROM \r\n\t(\r\n\t\tSELECT \r\n\t\t\ts.ShipmentID,\r\n\t\t\ts.FleetId,\r\n\t\t\tdr.PolygonId,\r\n\t\t\tdr.StoreId,\r\n\t\t\tdrc.DispatchRequestCount ,\r\n\t\t\ts.TotalEstimatedDurationSeconds,\r\n\t\t\ts.TotalDistanceMeter,\r\n\t\t\ts.SuggestedRoute,\r\n\t\t\ts.ArrivalDelaySeconds,\r\n\t\t\tROW_NUMBER() OVER ( PARTITION BY s.ShipmentID ORDER BY s.ShipmentID ) RowNum\r\n\t\tFROM CTE_ShipmentID s\r\n\t\tINNER JOIN CTE_DispatchRequest dr\r\n\t\t\tON s.ShipmentID = dr.ShipmentID\r\n\t\tINNER JOIN CTE_DRC drc\r\n\t\t\tON s.ShipmentID = drc.ShipmentId\r\n\t) SQ \r\n\tWHERE SQ.RowNum = 1\r\n\r\n\tINSERT INTO [DP].[ShipmentModificationHistory]\r\n\t(\r\n\t\t[ShipmentId], \r\n\t\t[ShipmentModificationReasonId], \r\n\t\t[FleetId], \r\n\t\t[PolygonId], \r\n\t\t[StoreId], \r\n\t\t[DispatchRequestCount], \r\n\t\t[TotalEstimatedDurationSeconds], \r\n\t\t[TotalDistanceMeter], \r\n\t\t[SuggestedRoute], \r\n\t\t[ArrivalDelaySeconds], \r\n\t\t[ShipmentData], \r\n\t\t[CreateDate], \r\n\t\t[CreateDatePersian], \r\n\t\t[ShipmentModifier]\r\n\t)\r\n\tSELECT \r\n\t\tShipmentID,\r\n\t\t@ShipmentModiicationReasonId,\r\n\t\tFleetId,\r\n\t\tPolygonId,\r\n\t\tStoreId,\r\n\t\tDispatchRequestCount ,\r\n\t\tTotalEstimatedDurationSeconds,\r\n\t\tTotalDistanceMeter,\r\n\t\tSuggestedRoute,\r\n\t\tArrivalDelaySeconds,\r\n\t\t\u0027{\u0027\u002B\r\n\t\tCASE \r\n\t\t\tWHEN DispatchRequests IS NULL OR DispatchRequests = \u0027\u0027 \r\n\t\t\t\tTHEN \u0027\u0027\r\n\t\t\tELSE \u0027\u0022DispatchRequests\u0022:\u0027\u002BDispatchRequests\r\n\t\tEND \u002B\r\n\t\tCASE WHEN DispatchRequests IS NOT NULL AND DispatchRequests \u003C\u003E \u0027\u0027 AND ShipmentDestinationPoints IS NOT NULL AND ShipmentDestinationPoints \u003C\u003E \u0027\u0027  THEN \u0027,\u0027 ELSE \u0027\u0027 END \u002B\r\n\t\tCASE \r\n\t\t\tWHEN ShipmentDestinationPoints IS NULL OR ShipmentDestinationPoints = \u0027\u0027 \r\n\t\t\t\tTHEN \u0027\u0027\r\n\t\t\tELSE \u0027\u0022ShipmentDestinationPoints\u0022:\u0027\u002BShipmentDestinationPoints\r\n\t\tEND \u002B\r\n\t\t\u002B\u0027}\u0027 AS ShipmentData,\r\n\t\t@Gre,\r\n\t\t@Per,\r\n\t\t@ShipmentModifier\r\n\r\n\t\t--\u0027{\u0027\u002BISNULL(\u0027\u0022DispatchRequests\u0022:\u0027\u002BDispatchRequests,\u0027\u0027)\u002BISNULL(\u0027,\u0022ShipmentDestinationPoints\u0022:\u0027\u002BShipmentDestinationPoints,\u0027\u0027)\u002B\u0027}\u0027 AS ShipmentData\r\n\tFROM #Final\r\n\r\n\tSET @IsInsertLogSuccessful = 1\r\nEND TRY\r\nBEGIN CATCH\r\n\tSET @IsInsertLogSuccessful = 0\r\nEND CATCH"},{"Name":"Report_NotPickupDispatchRequest","Schema":"dbo","Definition":"\r\nCREATE     PROC [dbo].[Report_NotPickupDispatchRequest]\r\n(\r\n\t@ProvinceId TINYINT = NULL,\r\n\t@CityId SMALLINT = NULL,\r\n\t@PolygonIds VARCHAR(MAX) = NULL,\r\n\t@StoreIds VARCHAR(MAX) = NULL,\r\n\t@VendorId INT = NULL,\r\n\t@VendorParcelCode VARCHAR(MAX) = NULL,\r\n\t@ParcelReferenceCode bigint = NULL,\r\n\t@CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t@StartDeliveryTime BIGINT ,\r\n\t@EndDeliveryTime BIGINT ,\r\n\t@ShipmentNumber BIGINT = NULL,\r\n\t@FleetId  INT = NULL,\r\n\t@DispatchRequestStatusId TINYINT = NULL,\r\n\t@DeliveryServiceProviderIds VARCHAR(MAX) = NULL,\r\n\t@NotPickupReasonId\tINT = NULL,\r\n\t@IsFirstNotPickupRequestApproved BIT = NULL,\r\n\t@StartNotPickupRequestTime BIGINT = NULL,\r\n\t@EndNotPickupRequestTime BIGINT = NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t,--=10,\t\r\n\t--@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t@Result NVARCHAR(MAX) OUTPUT\r\n\t\t\r\n)\r\nAS\r\n\r\nSET @Result =\r\n(\r\n\r\n\tSELECT \r\n\tNULL AS dispatchRequestId\t\r\n\t,NULL AS dispatchRequestStatusId\t\r\n\t,NULL AS dispatchRequestStatusTitle\t\r\n\t,NULL AS vendorParcelCode\t\r\n\t,NULL AS parcelReferenceCode\t\r\n\t,NULL AS deliveryStartTimePersian\t\r\n\t,NULL AS deliveryDeadLineTime\t\r\n\t,NULL AS provinceId\t\r\n\t,NULL AS provinceTitle\t\r\n\t,NULL AS cityId\t\r\n\t,NULL AS cityTitle\t\r\n\t,NULL AS polygonId\t\r\n\t,NULL AS polygonTitle\t\r\n\t,NULL AS storeId\t\r\n\t,NULL AS storeTitle\t\r\n\t,NULL AS storeCode\t\r\n\t,NULL AS firstShipmentNumber\t\r\n\t,NULL AS firstFleetId\t\r\n\t,NULL AS firstDriverName\t\r\n\t,NULL AS firstDriverMobile\t\r\n\t,NULL AS firstNotPickupRequestTimeStr\t\r\n\t,NULL AS firstNotPickupReasonIdOfFleet\t\r\n\t,NULL AS firstNotPickupReasonTitleOfFleet\t\r\n\t,NULL AS firstNotPickupResultTimeStr\t\r\n\t,NULL AS firstNotPickupReasonIdOfOperationStaff\t\r\n\t,NULL AS firstNotPickupReasonTitleOfOperationStaff\t\r\n\t,NULL AS firstOperationName\t\r\n\t,NULL AS isFirstNotPickupApprovedBySystem\t\r\n\t,NULL AS isFirstNotPickupRequestApproved\t\r\n\t,NULL AS isRequestCanceledInFirstNotPickupRequest\t\r\n\t,NULL AS secondShipmentNumber\t\r\n\t,NULL AS secondFleetId\t\r\n\t,NULL AS secondDriverName\t\r\n\t,NULL AS secondDriverMobile\t\r\n\t,NULL AS secondNotPickupRequestTimeStr\t\r\n\t,NULL AS secondNotPickupReasonIdOfFleet\t\r\n\t,NULL AS secondNotPickupReasonTitleOfFleet\t\r\n\t,NULL AS secondNotPickupResultTimeStr\t\r\n\t,NULL AS secondNotPickupReasonIdOfOperationStaff\t\r\n\t,NULL AS secondNotPickupReasonTitleOfOperationStaff\t\r\n\t,NULL AS secondOperationName\t\r\n\t,NULL AS isSecondNotPickupApprovedBySystem\t\r\n\t,NULL AS isSecondNotPickupRequestApproved\t\r\n\t,NULL AS deliveryServiceProviderId\t\r\n\t,NULL AS deliveryServiceProviderTitle\t\r\n\t,NULL AS firstDescription\t\r\n\t,NULL AS secondDescription\t\r\n\t,NULL AS vendorId\t\r\n\t,NULL AS vendorBrandName\t\r\n\t,NULL AS courierRequestTypeId\t\r\n\t,NULL AS courierRequestTypeTitle\t\r\n\t,NULL AS deliveryDatePersianStr\r\n\tFOR JSON PATH, INCLUDE_NULL_VALUES , ROOT (\u0027Result\u0027)\r\n)\r\n\r\nSET @Result = Replace(@result,\u0027\\\u0027,\u0027\u0027)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.totalCount\u0027,0)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.pageSize\u0027,1)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.currentPage\u0027,1 )\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.totalPages\u0027,(0 \u002B 1 - 1) / 1)\r\nSELECT @Result\r\nRETURN\r\n\r\nDROP TABLE IF EXISTS #STOREIDS,#PolygonIDS,#CourierRequestTypeIDS,#CityIDs,#Final,#DeliveryServiceProviderIds\r\n\r\nDECLARE @TotalCount INT = 0\r\n\r\nSELECT \r\n\tc.Id\r\nINTO #CityIDs\r\nFROM CS_Public.HAF.City c (NOLOCK)\r\nWHERE (c.ID = @CityId OR ISNULL(@CityId,0) = 0)\r\nAND (c.ProvinceId = @ProvinceId OR ISNULL(@ProvinceId,0) = 0)\r\n\r\nSELECT\r\n\tS.ID\r\nINTO #STOREIDS\r\nFROM DP.STORE S (NOLOCK)\r\nINNER JOIN string_split(ISNULL(@STOREIdS,\u00270\u0027),\u0027,\u0027) ss\r\n\tON S.Id = ss.value\r\n\tOR ISNULL(@STOREIdS,\u00270\u0027) = \u00270\u0027\r\n\r\nSELECT \r\n    P.Id\r\nINTO #PolygonIDS\r\nFROM DP.Polygon P (NOLOCK)\r\nINNER JOIN #CityIDs cID\r\n\tON p.CityId = cID.Id\r\nINNER JOIN string_split(ISNULL(@PolygonIDS,\u00270\u0027),\u0027,\u0027)SS\r\n\tON P.ID=SS.value\r\n\tOR ISNULL(@PolygonIDS,\u00270\u0027) = \u00270\u0027\r\n\r\nSELECT \r\n    cr.Id\r\nINTO #CourierRequestTypeIDS\r\nFROM CS_Public.[PUB].[CourierRequestType] cr (NOLOCK)\r\nINNER JOIN string_split(ISNULL(@CourierRequestTypeIds,\u00270\u0027),\u0027,\u0027)SS\r\n\tON cr.ID=SS.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\nSELECT \r\n    dsp.Id\r\nINTO #DeliveryServiceProviderIds\r\nFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\nINNER JOIN string_split(ISNULL(@DeliveryServiceProviderIds,\u00270\u0027),\u0027,\u0027)SS\r\n\tON dsp.ID=SS.value\r\n\tOR ISNULL(@DeliveryServiceProviderIds,\u00270\u0027) = \u00270\u0027\r\n\r\n;WITH CTE_DR AS\r\n(\r\n\tSELECT \r\n\t\tdr.Id AS DispatchRequestId,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdrs.Title AS DispatchRequestStatusTitle,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.DeliveryStartTimePersian,\r\n\t\tdr.DeliveryDeadLineTime,\r\n\t\tdr.DeliveryServiceProviderId,\r\n\t\tdsp.Title AS DeliveryServiceProviderTitle,\r\n\t\tdr.VendorId,\r\n\t\tdr.CourierRequestTypeId,\r\n\r\n\t\tpr.Id AS ProvinceId,\r\n\t\tpr.Name AS ProvinceTitle,\r\n\r\n\t\tc.Id AS CityId,\r\n\t\tc.Name AS CityTitle,\r\n\r\n\t\tp.Id AS PolygonId,\r\n\t\tp.Title AS PolygonTitle,\r\n\r\n\t\ts.Id AS StoreId,\r\n\t\ts.Title AS StoreTitle,\r\n\t\ts.VendorCode AS StoreCode\r\n\r\n\tFROM DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN DP.DispatchRequestStatus drs (NOLOCK)\r\n\t\tON dr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.Id\r\n\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\tON ps.StoreId = s.Id\r\n\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.Id\r\n\tINNER JOIN CS_Public.Haf.Province pr (NOLOCK)\r\n\t\tON c.ProvinceId = pr.Id\r\n\tINNER JOIN #PolygonIDS PLI\r\n\t\tON p.ID = PLI.Id\r\n\tINNER JOIN #STOREIDS SI\r\n\t\tON SI.ID = PS.StoreId\r\n\tINNER JOIN #CourierRequestTypeIDS crtID\r\n\t\tON dr.CourierRequestTypeId = crtID.Id\r\n\r\n\tINNER JOIN #DeliveryServiceProviderIds dspID\r\n\t\tON dr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\t\tON dr.DeliveryServiceProviderId = dsp.Id\r\n\r\n\tWHERE \r\n\t\tdr.DeliveryStartTime \u003E= @StartDeliveryTime\r\n\tAND dr.DeliveryStartTime \u003C= @EndDeliveryTime\r\n\tAND (dr.VendorId = @VendorId OR ISNULL(@VendorId,0) = 0)\r\n\tAND (dr.VendorParcelCode = @VendorParcelCode OR ISNULL(@VendorParcelCode,\u00270\u0027) = \u00270\u0027)\r\n\tAND (dr.ParcelReferenceCode = @ParcelReferenceCode OR ISNULL(@ParcelReferenceCode,0) = 0)\r\n\tAND (dr.DispatchRequestStatusId = @DispatchRequestStatusId OR ISNULL(@DispatchRequestStatusId,0) = 0)\t\r\n\tAND EXISTS \r\n\t(\r\n\t\tSELECT * FROM DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK)\r\n\t\tWHERE dr.Id = uorh.DispatchRequestId\r\n\t)\r\n),CTE_Shipment AS\r\n(\r\n\tSELECT \r\n\t\tSQ.*,\r\n\t\td1.FirstName \u002B \u0027 \u0027 \u002B d1.LastName AS FirstDriverName,\r\n\t\t\u00270\u0027\u002BCAST(d1.Mobile AS VARCHAR(MAX)) AS FirstDriverMobile,\r\n\t\td2.FirstName \u002B \u0027 \u0027 \u002B d2.LastName AS SecondDriverName,\r\n\t\t\u00270\u0027\u002BCAST(d2.Mobile AS VARCHAR(MAX)) AS SecondDriverMobile\r\n\tFROM\r\n\t(\r\n\t\tSELECT DISTINCT\r\n\t\t\tsdpdr.DispatchRequestId,\r\n\t\t\tFIRST_VALUE(s.Id) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID , s.CreateDate ) FirstShipmentId,\r\n\t\t\tFIRST_VALUE(s.ShipmentNumber) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID , s.CreateDate ) FirstShipmentNumber,\r\n\t\t\tFIRST_VALUE(s.FleetId) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID , s.CreateDate ) FirstFleetId,\r\n\t\t\tFIRST_VALUE(s.Id) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID DESC, s.CreateDate DESC) SecondShipmentId,\r\n\t\t\tFIRST_VALUE(s.ShipmentNumber) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID DESC, s.CreateDate DESC) SecondShipmentNumber,\r\n\t\t\tFIRST_VALUE(s.FleetId) OVER ( PARTITION BY sdpdr.DispatchRequestId ORDER BY s.ID DESC, s.CreateDate DESC) SecondFleetId\r\n\t\tFROM CTE_DR dr\r\n\t\tINNER JOIN DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\t\t\tON dr.DispatchRequestId = sdpdr.DispatchRequestId\r\n\t\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\t\tINNER JOIN DP.Shipment s (NOLOCK)\r\n\t\t\tON sdp.ShipmentId = s.Id\r\n\t) SQ\r\n\tLEFT JOIN CS_DriverManagement.DM.Fleet f1 (NOLOCK)\r\n\t\tON SQ.FirstFleetId = f1.ID\r\n\tLEFT JOIN CS_DriverManagement.DM.Driver d1 (NOLOCK)\r\n\t\tON f1.DriverId = d1.Id\r\n\r\n\tLEFT JOIN CS_DriverManagement.DM.Fleet f2 (NOLOCK)\r\n\t\tON SQ.SecondFleetId = f2.ID\r\n\tLEFT JOIN CS_DriverManagement.DM.Driver d2 (NOLOCK)\r\n\t\tON f2.DriverId = d2.Id\r\n),CTE_UOR AS\r\n(\r\n\tSELECT \r\n\t\tdr.DispatchRequestId ,\r\n\t\tuorh.CreatorUserName\r\n\tFROM CTE_DR dr\r\n\tINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK) \r\n\t\tON dr.DispatchRequestId = uorh.DispatchRequestId\r\n\t\tAND uorh.OperationTypeId = 7\r\n),CTE_Main AS\r\n(\r\n\tSELECT \r\n\t\tdr.DispatchRequestId,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdr.DispatchRequestStatusTitle,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.DeliveryStartTimePersian,\r\n\t\tdr.DeliveryDeadLineTime,\r\n\t\tdr.ProvinceId,\r\n\t\tdr.ProvinceTitle,\r\n\t\tdr.CityId,\r\n\t\tdr.CityTitle,\r\n\t\tdr.PolygonId,\r\n\t\tdr.PolygonTitle,\r\n\t\tdr.StoreId,\r\n\t\tdr.StoreTitle,\r\n\t\tdr.StoreCode,\r\n\t\tdr.DeliveryServiceProviderId,\r\n\t\tdr.DeliveryServiceProviderTitle,\r\n\t\tdr.VendorId,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\ts.FirstShipmentNumber,\r\n\t\ts.FirstFleetId,\r\n\t\ts.FirstDriverName,\r\n\t\ts.FirstDriverMobile,\r\n\t\tCASE WHEN s.FirstShipmentId \u003C\u003E s.SecondShipmentId AND s.SecondShipmentId IS NOT NULL THEN 0 ELSE 1 END AS IsRequestCanceledInFirstNotPickupRequest,\r\n\t\tCASE WHEN s.FirstShipmentId \u003C\u003E s.SecondShipmentId THEN s.SecondShipmentNumber ELSE NULL END SecondShipmentNumber,\r\n\t\tCASE WHEN s.FirstShipmentId \u003C\u003E s.SecondShipmentId THEN s.SecondFleetId ELSE NULL END SecondFleetId,\r\n\t\tCASE WHEN s.FirstShipmentId \u003C\u003E s.SecondShipmentId THEN s.SecondDriverName ELSE NULL END SecondDriverName,\r\n\t\tCASE WHEN s.FirstShipmentId \u003C\u003E s.SecondShipmentId THEN s.SecondDriverMobile ELSE NULL END SecondDriverMobile,\r\n\t\tCASE WHEN s.FirstFleetId \u003C\u003E s.SecondFleetId THEN 1 ELSE 0 END IsFleetChanged\r\n\tFROM CTE_DR dr\r\n\tINNER JOIN CTE_Shipment s\r\n\t\tON dr.DispatchRequestId = s.DispatchRequestId\r\n),CTE_FirstFleet AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tSQ.DispatchRequestId,\r\n\t\tFIRST_VALUE(SQ.CreateDatePersian) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.FirstNotPickupRequest DESC , SQ.CreateDate DESC ) AS FirstNotPickupRequestDateTimePersian,\r\n\t\tFIRST_VALUE(SQ.CreateDate) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.FirstNotPickupRequest DESC , SQ.CreateDate DESC ) AS FirstNotPickupRequestDateTime,\r\n\t\tFIRST_VALUE(SQ.OperationFailureReasonId) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.FirstNotPickupRequest DESC , SQ.CreateDate DESC ) AS FirstNotPickupReasonOfFleet,\r\n\t\tFIRST_VALUE(SQ.CreateDatePersian) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.FirstNotPickupResult DESC , SQ.CreateDate DESC ) AS FirstNotPickupResultDateTimePersian,\r\n\t\tFIRST_VALUE(SQ.OperationFailureReasonId) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.[First] DESC , SQ.CreateDate DESC ) AS FirstNotPickupReasonOfOperation,\r\n\t\tFIRST_VALUE(SQ.CreatorUserName) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.[First] DESC , SQ.CreateDate DESC ) AS FirstResponsibleOperationStaff,\r\n\t\tFIRST_VALUE(SQ.Description) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.[First] DESC , SQ.CreateDate DESC) AS FirstDescription,\r\n\t\tFIRST_VALUE(SQ.IsFirstNotPickupApprovedBySystem) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.IsFirstNotPickupApprovedBySystem DESC ) AS IsFirstNotPickupApprovedBySystem\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tuorh.DispatchRequestId,\r\n\t\t\tuorh.CreateDate,\r\n\t\t\tuorh.CreateDatePersian,\r\n\t\t\tuorh.OperationFailureReasonId,\r\n\t\t\tuorh.CreatorUserName,\r\n\t\t\tuorh.Description,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN 1 ELSE 0 END FirstNotPickupRequest ,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 7,8,9,35 ) THEN 1 ELSE 0 END FirstNotPickupResult,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN 1 ELSE 0 END [First],\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.CreateDatePersian ELSE NULL END FirstNotPickupRequestDateTimePersian,/*,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.CreateDate ELSE NULL END FirstNotPickupRequestDateTime,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.OperationFailureReasonId ELSE NULL END FirstNotPickupReasonOfFleet,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 7,8,9,35 ) THEN uorh.CreateDatePersian ELSE NULL END FirstNotPickupResultDateTimePersian,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.OperationFailureReasonId ELSE NULL END FirstNotPickupReasonOfOperation,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.CreatorUserName ELSE NULL END FirstResponsibleOperationStaff,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.Description ELSE NULL END FirstDescription,--NULL FirstDescription*/\r\n\t\t\tCASE WHEN uorh.OperationTypeId = 8 AND CreatorUserName = \u0027system|system\u0027 THEN 1 ELSE 0 END AS IsFirstNotPickupApprovedBySystem\r\n\t\tFROM CTE_Shipment f\r\n\t\tINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK) \r\n\t\t\tON f.DispatchRequestId = uorh.DispatchRequestId\r\n\t\t\tAND f.FirstFleetId = uorh.FleetId\r\n\t\t\tAND f.FirstShipmentId = uorh.ShipmentId\r\n\t\r\n\t) SQ\r\n),CTE_SecondFleet AS\r\n(\r\n\t--SELECT DISTINCT\r\n\t--\tSQ.DispatchRequestId,\r\n\t--\tFIRST_VALUE(SQ.SecondNotPickupRequestDateTimePersian) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.CreateDate DESC) AS SecondNotPickupRequestDateTimePersian,\r\n\t--\tFIRST_VALUE(SQ.SecondNotPickupRequestDateTime) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.CreateDate DESC) AS SecondNotPickupRequestDateTime,\r\n\t--\tFIRST_VALUE(SQ.SecondNotPickupReasonOfFleet) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.CreateDate DESC) AS SecondNotPickupReasonOfFleet,\r\n\t--\tFIRST_VALUE(SQ.SecondNotPickupResultDateTimePersian) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.CreateDate DESC) AS SecondNotPickupResultDateTimePersian,\r\n\t--\tFIRST_VALUE(SQ.SecondNotPickupReasonOfOperation) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.CreateDate DESC) AS SecondNotPickupReasonOfOperation,\r\n\t--\tFIRST_VALUE(SQ.SecondResponsibleOperationStaff) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.CreateDate DESC) AS SecondResponsibleOperationStaff,\r\n\t--\tFIRST_VALUE(SQ.IsSecondNotPickupApprovedBySystem) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.CreateDate DESC) AS IsSecondNotPickupApprovedBySystem,\r\n\t--\tFIRST_VALUE(SQ.SecondDescription) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.CreateDate DESC) AS SecondDescription\r\n\t--FROM\r\n\t--(\r\n\t--\tSELECT \r\n\t--\t\tuorh.DispatchRequestId,\r\n\t--\t\tuorh.CreateDate,\r\n\t--\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.CreateDatePersian ELSE NULL END SecondNotPickupRequestDateTimePersian,\r\n\t--\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.CreateDate ELSE NULL END SecondNotPickupRequestDateTime,\r\n\t--\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.OperationFailureReasonId ELSE NULL END SecondNotPickupReasonOfFleet,\r\n\t--\t\tCASE WHEN uorh.OperationTypeId IN ( 7,8,9,35 ) THEN uorh.CreateDatePersian ELSE NULL END SecondNotPickupResultDateTimePersian,\r\n\t--\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.OperationFailureReasonId ELSE NULL END SecondNotPickupReasonOfOperation,\r\n\t--\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.CreatorUserName ELSE NULL END SecondResponsibleOperationStaff,\r\n\t--\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.Description ELSE NULL END SecondDescription,--NULL SecondDescription,\r\n\t--\t\tCASE WHEN uorh.OperationTypeId = 8 AND CreatorUserName = \u0027system|system\u0027 THEN 1 ELSE 0 END AS IsSecondNotPickupApprovedBySystem\r\n\t--\tFROM CTE_Main f\r\n\t--\tINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK) \r\n\t--\t\tON f.DispatchRequestId = uorh.DispatchRequestId\r\n\t--\t\tAND f.SecondFleetId = uorh.FleetId\r\n\t--\t\tAND f.IsFleetChanged = 1\r\n\t--) SQ\r\n\tSELECT DISTINCT\r\n\t\tSQ.DispatchRequestId,\r\n\t\tFIRST_VALUE(SQ.CreateDatePersian) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.SecondNotPickupRequest DESC , SQ.CreateDate DESC ) AS SecondNotPickupRequestDateTimePersian,\r\n\t\tFIRST_VALUE(SQ.CreateDate) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.SecondNotPickupRequest DESC , SQ.CreateDate DESC ) AS SecondNotPickupRequestDateTime,\r\n\t\tFIRST_VALUE(SQ.OperationFailureReasonId) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.SecondNotPickupRequest DESC , SQ.CreateDate DESC ) AS SecondNotPickupReasonOfFleet,\r\n\t\tFIRST_VALUE(SQ.CreateDatePersian) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.SecondNotPickupResult DESC , SQ.CreateDate DESC ) AS SecondNotPickupResultDateTimePersian,\r\n\t\tFIRST_VALUE(SQ.OperationFailureReasonId) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.[Second] DESC , SQ.CreateDate DESC ) AS SecondNotPickupReasonOfOperation,\r\n\t\tFIRST_VALUE(SQ.CreatorUserName) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.[Second] DESC , SQ.CreateDate DESC ) AS SecondResponsibleOperationStaff,\r\n\t\tFIRST_VALUE(SQ.Description) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.[Second] DESC , SQ.CreateDate DESC) AS SecondDescription,\r\n\t\tFIRST_VALUE(SQ.IsSecondNotPickupApprovedBySystem) OVER ( PARTITION BY SQ.DispatchRequestId ORDER BY SQ.IsSecondNotPickupApprovedBySystem DESC ) AS IsSecondNotPickupApprovedBySystem\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tuorh.DispatchRequestId,\r\n\t\t\tuorh.CreateDate,\r\n\t\t\tuorh.CreateDatePersian,\r\n\t\t\tuorh.OperationFailureReasonId,\r\n\t\t\tuorh.CreatorUserName,\r\n\t\t\tuorh.Description,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN 1 ELSE 0 END SecondNotPickupRequest ,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 7,8,9,35 ) THEN 1 ELSE 0 END SecondNotPickupResult,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN 1 ELSE 0 END [Second],\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.CreateDatePersian ELSE NULL END SecondNotPickupRequestDateTimePersian,/*,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.CreateDate ELSE NULL END FirstNotPickupRequestDateTime,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.OperationFailureReasonId ELSE NULL END FirstNotPickupReasonOfFleet,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 7,8,9,35 ) THEN uorh.CreateDatePersian ELSE NULL END FirstNotPickupResultDateTimePersian,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.OperationFailureReasonId ELSE NULL END FirstNotPickupReasonOfOperation,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.CreatorUserName ELSE NULL END FirstResponsibleOperationStaff,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.Description ELSE NULL END FirstDescription,--NULL FirstDescription*/\r\n\t\t\tCASE WHEN uorh.OperationTypeId = 8 AND CreatorUserName = \u0027system|system\u0027 THEN 1 ELSE 0 END AS IsSecondNotPickupApprovedBySystem\r\n\t\tFROM CTE_Shipment f\r\n\t\tINNER JOIN DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK) \r\n\t\t\tON f.DispatchRequestId = uorh.DispatchRequestId\r\n\t\t\tAND f.SecondFleetId = uorh.FleetId\r\n\t\t\tAND f.SecondShipmentId = uorh.ShipmentId\r\n\t\r\n\t) SQ\r\n),CTE_Final AS\r\n(\r\n\r\nSELECT \r\n\tf.DispatchRequestId,\r\n\tf.DispatchRequestStatusId,\r\n\tf.DispatchRequestStatusTitle,\r\n\tf.VendorParcelCode,\r\n\tf.ParcelReferenceCode,\r\n\tf.DeliveryStartTimePersian,\r\n\tf.DeliveryDeadLineTime,\r\n\tf.ProvinceId,\r\n\tf.ProvinceTitle,\r\n\tf.CityId,\r\n\tf.CityTitle,\r\n\tf.PolygonId,\r\n\tf.PolygonTitle,\r\n\tf.StoreId,\r\n\tf.StoreTitle,\r\n\tf.StoreCode,\r\n\tf.DeliveryServiceProviderId,\r\n\tf.DeliveryServiceProviderTitle,\r\n\r\n\tf.FirstShipmentNumber,\r\n\tf.FirstFleetId,\r\n\tf.FirstDriverName,\r\n\tf.FirstDriverMobile,\r\n\tff.FirstNotPickupRequestDateTimePersian,\r\n\tff.FirstNotPickupRequestDateTime,\r\n\tff.FirstNotPickupReasonOfFleet AS FirstNotPickupReasonIdOfFleet,\r\n\tofrFF.Title AS FirstNotPickupReasonTitleOfFleet, \r\n\tff.FirstNotPickupResultDateTimePersian,\r\n\tff.FirstNotPickupReasonOfOperation AS FirstNotPickupReasonIdOfOperation,\r\n\tofrFO.Title AS FirstNotPickupReasonTitleOfOperationStaff, \r\n\tISNULL(ff.IsFirstNotPickupApprovedBySystem,0) IsFirstNotPickupApprovedBySystem,\r\n\tCASE \r\n\t\tWHEN uor.DispatchRequestId IS NULL\r\n\t\t\tTHEN 1\r\n\t\tELSE \r\n\t\t\tCASE \r\n\t\t\t\tWHEN IsRequestCanceledInFirstNotPickupRequest = 0\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\tELSE\r\n\t\t\t\t\t0\r\n\t\t\tEND\r\n\tEND AS IsFirstNotPickupRequestApproved,\r\n\tISNULL(f.IsRequestCanceledInFirstNotPickupRequest,0) IsRequestCanceledInFirstNotPickupRequest,\r\n\r\n\tf.SecondShipmentNumber,\r\n\tf.SecondFleetId,\r\n\tf.SecondDriverName,\r\n\tf.SecondDriverMobile,\r\n\tsf.SecondNotPickupRequestDateTimePersian,\r\n\tsf.SecondNotPickupRequestDateTime,\r\n\tsf.SecondNotPickupReasonOfFleet AS SecondNotPickupReasonIdOfFleet,\r\n\tofrSF.Title AS SecondNotPickupReasonTitleOfFleet, \r\n\tsf.SecondNotPickupResultDateTimePersian,\r\n\tsf.SecondNotPickupReasonOfOperation AS SecondNotPickupReasonIdOfOperation,\r\n\tofrSO.Title AS SecondNotPickupReasonTitleOfOperationStaff, \r\n\tISNULL(sf.IsSecondNotPickupApprovedBySystem,0) IsSecondNotPickupApprovedBySystem,\r\n\tCASE \r\n\t\tWHEN IsRequestCanceledInFirstNotPickupRequest = 0 AND f.DispatchRequestStatusId = 40\r\n\t\t\tTHEN 1\r\n\t\tELSE \r\n\t\t\t0\r\n\tEND AS IsSecondNotPickupRequestApproved,\r\n\r\n\tuor.CreatorUserName,\r\n\tff.FirstResponsibleOperationStaff,\r\n\tsf.SecondResponsibleOperationStaff,\r\n\tff.FirstDescription,\r\n\tsf.SecondDescription,\r\n\tf.VendorId,\r\n\tf.CourierRequestTypeId\r\n\r\nFROM CTE_Main f\r\nLEFT JOIN CTE_UOR uor\r\n\tON f.DispatchRequestId = uor.DispatchRequestId\r\nLEFT JOIN CTE_FirstFleet ff\r\n\tON f.DispatchRequestId = ff.DispatchRequestId\r\nLEFT JOIN CTE_SecondFleet sf\r\n\tON f.DispatchRequestId = sf.DispatchRequestId\r\n\r\nLEFT JOIN DP.OperationFailureReason ofrFF (NOLOCK)\r\n\tON ff.FirstNotPickupReasonOfFleet =  ofrFF.Id\r\nLEFT JOIN DP.OperationFailureReason ofrFO (NOLOCK)\r\n\tON ff.FirstNotPickupReasonOfOperation =  ofrFO.Id\r\n\r\nLEFT JOIN DP.OperationFailureReason ofrSF (NOLOCK)\r\n\tON sf.SecondNotPickupReasonOfFleet =  ofrSF.Id\r\nLEFT JOIN DP.OperationFailureReason ofrSO (NOLOCK)\r\n\tON sf.SecondNotPickupReasonOfOperation =  ofrSO.Id\r\n)\r\nSELECT\r\n\t dispatchRequestId\t\r\n\t,dispatchRequestStatusId\t\r\n\t,dispatchRequestStatusTitle\t\r\n\t,vendorParcelCode\t\r\n\t,parcelReferenceCode\t\r\n\t,deliveryStartTimePersian\t\r\n\t,deliveryDeadLineTime\t\r\n\t,provinceId\t\r\n\t,provinceTitle\t\r\n\t,cityId\t\r\n\t,cityTitle\t\r\n\t,polygonId\t\r\n\t,polygonTitle\t\r\n\t,storeId\t\r\n\t,storeTitle\t\r\n\t,storeCode\t\r\n\t,firstShipmentNumber\t\r\n\t,firstFleetId\t\r\n\t,firstDriverName\t\r\n\t,firstDriverMobile\t\r\n\t,RIGHT(FORMAT(firstNotPickupRequestDateTimePersian,\u0027####/##/## ##:##:##\\.###\u0027),12) AS firstNotPickupRequestTimeStr\t\r\n\t,firstNotPickupReasonIdOfFleet\t\r\n\t,firstNotPickupReasonTitleOfFleet\t\r\n\t,RIGHT(FORMAT(firstNotPickupResultDateTimePersian,\u0027####/##/## ##:##:##\\.###\u0027),12) AS firstNotPickupResultTimeStr\t\t\r\n\t,firstNotPickupReasonIdOfOperation\t AS firstNotPickupReasonIdOfOperationStaff\t\r\n\t,firstNotPickupReasonTitleOfOperationStaff\t\r\n\t,TRIM(SUBSTRING(FirstResponsibleOperationStaff,CHARINDEX(\u0027|\u0027,FirstResponsibleOperationStaff,1)\u002B1,LEN(FirstResponsibleOperationStaff)))  AS firstOperationName\r\n\t,isFirstNotPickupApprovedBySystem\t\r\n\t,isFirstNotPickupRequestApproved\t\r\n\t,isRequestCanceledInFirstNotPickupRequest\t\r\n\t,secondShipmentNumber\t\r\n\t,secondFleetId\t\r\n\t,secondDriverName\t\r\n\t,secondDriverMobile\t\r\n\t,RIGHT(FORMAT(secondNotPickupRequestDateTimePersian,\u0027####/##/## ##:##:##\\.###\u0027),12)\t  AS secondNotPickupRequestTimeStr\r\n\t,secondNotPickupReasonIdOfFleet\t\r\n\t,secondNotPickupReasonTitleOfFleet\t\r\n\t,RIGHT(FORMAT(secondNotPickupResultDateTimePersian,\u0027####/##/## ##:##:##\\.###\u0027),12) AS secondNotPickupResultTimeStr\t\r\n\t,secondNotPickupReasonIdOfOperation AS secondNotPickupReasonIdOfOperationStaff\t\r\n\t,secondNotPickupReasonTitleOfOperationStaff\t\r\n\t,TRIM(SUBSTRING(SecondResponsibleOperationStaff,CHARINDEX(\u0027|\u0027,SecondResponsibleOperationStaff,1)\u002B1,LEN(SecondResponsibleOperationStaff))) AS secondOperationName\r\n\t,isSecondNotPickupApprovedBySystem\t\r\n\t,isSecondNotPickupRequestApproved\r\n\t,deliveryServiceProviderId\r\n\t,deliveryServiceProviderTitle\r\n\t,firstDescription\r\n\t,secondDescription\r\n\t,vendorId\r\n\t,vendorBrandName\r\n\t,courierRequestTypeId\r\n\t,courierRequestTypeTitle \r\nINTO #Final\r\nFROM\r\n(\r\n\tSELECT \r\n\t\t DispatchRequestId\t\r\n\t\t,DispatchRequestStatusId\t\r\n\t\t,DispatchRequestStatusTitle\t\r\n\t\t,VendorParcelCode\t\r\n\t\t,ParcelReferenceCode\t\r\n\t\t,DeliveryStartTimePersian\t\r\n\t\t,DeliveryDeadLineTime\t\r\n\t\t,ProvinceId\t\r\n\t\t,ProvinceTitle\t\r\n\t\t,CityId\t\r\n\t\t,CityTitle\t\r\n\t\t,PolygonId\t\r\n\t\t,PolygonTitle\t\r\n\t\t,StoreId\t\r\n\t\t,StoreTitle\t\r\n\t\t,StoreCode\t\r\n\t\t,FirstShipmentNumber\t\r\n\t\t,FirstFleetId\t\r\n\t\t,FirstDriverName\t\r\n\t\t,FirstDriverMobile\t\r\n\t\t,FirstNotPickupRequestDateTimePersian \r\n\t\t,FirstNotPickupReasonIdOfFleet\t\r\n\t\t,FirstNotPickupReasonTitleOfFleet\t\r\n\t\t,FirstNotPickupResultDateTimePersian \r\n\t\t,FirstNotPickupReasonIdOfOperation \r\n\t\t,FirstNotPickupReasonTitleOfOperationStaff\t\r\n\t\t,CASE WHEN IsFirstNotPickupRequestApproved = 0 THEN CreatorUserName ELSE FirstResponsibleOperationStaff END  FirstResponsibleOperationStaff\r\n\t\t,IsFirstNotPickupApprovedBySystem\t\r\n\t\t,IsFirstNotPickupRequestApproved\t\r\n\t\t,IsRequestCanceledInFirstNotPickupRequest\t\r\n\t\t,SecondShipmentNumber\t\r\n\t\t,SecondFleetId\t\r\n\t\t,SecondDriverName\t\r\n\t\t,SecondDriverMobile\t\r\n\t\t,SecondNotPickupRequestDateTimePersian\r\n\t\t,SecondNotPickupReasonIdOfFleet\t\r\n\t\t,SecondNotPickupReasonTitleOfFleet\t\r\n\t\t,SecondNotPickupResultDateTimePersian \r\n\t\t,SecondNotPickupReasonIdOfOperation\t \r\n\t\t,SecondNotPickupReasonTitleOfOperationStaff\t\r\n\t\t,\r\n\t\tCASE \r\n\t\t\tWHEN SecondNotPickupRequestDateTimePersian IS NOT NULL \r\n\t\t\tTHEN \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN IsSecondNotPickupRequestApproved = 0 \r\n\t\t\t\t\t\tTHEN CreatorUserName \r\n\t\t\t\t\tELSE \r\n\t\t\t\t\t\tSecondResponsibleOperationStaff \r\n\t\t\t\tEND\r\n\t\t\tELSE NULL\r\n\t\tEND  SecondResponsibleOperationStaff\r\n\t\t,IsSecondNotPickupApprovedBySystem\t\r\n\t\t,IsSecondNotPickupRequestApproved\r\n\t\t,DeliveryServiceProviderId\r\n\t\t,DeliveryServiceProviderTitle\r\n\t\t,FirstDescription\r\n\t\t,SecondDescription\r\n\t\t,VendorId\r\n\t\t,v.BrandName AS VendorBrandName\r\n\t\t,CourierRequestTypeId\r\n\t\t,crt.Title AS CourierRequestTypeTitle \t\t\r\n\tFROM CTE_Final f\r\n\tINNER JOIN CS_UserManagement.[UM].[Vendor] V (NOLOCK)\r\n\t\tON f.VendorId = v.Id\r\n\tINNER JOIN CS_Public.PUB.CourierRequestType crt (NOLOCK)\r\n\t\tON f.CourierRequestTypeId = crt.Id\r\n  WHERE \r\n\t\t(DispatchRequestStatusId = @DispatchRequestStatusId or ISNULL(@DispatchRequestStatusId,0) = 0)\t\r\n\tAND (VendorParcelCode = @VendorParcelCode or ISNULL(@VendorParcelCode,\u00270\u0027) = \u00270\u0027) \r\n\tAND (ParcelReferenceCode = @ParcelReferenceCode or ISNULL(@ParcelReferenceCode,0) = 0) \r\n\tAND (ProvinceId = @ProvinceId or ISNULL(@provinceId,0) = 0) \r\n\tAND (CityId = @CityId OR ISNULL(@CityId,0) = 0)\t\r\n\tAND (FirstShipmentNumber = @ShipmentNumber  OR SecondShipmentNumber= @ShipmentNumber or ISNULL(@ShipmentNumber,0) = 0) \r\n\tAND (FirstFleetId = @FleetId OR SecondFleetId = @FleetId or ISNULL(@FleetId,0) = 0) \r\n\tAND (FirstNotPickupReasonIdOfFleet = @NotPickupReasonId or SecondNotPickupReasonIdOfFleet = @NotPickupReasonId OR FirstNotPickupReasonIdOfOperation = @NotPickupReasonId or SecondNotPickupReasonIdOfOperation = @NotPickupReasonId or ISNULL(@NotPickupReasonId ,0) = 0)\t \r\n\tAND (IsFirstNotPickupRequestApproved = @IsFirstNotPickupRequestApproved OR @IsFirstNotPickupRequestApproved IS NULL)\r\n\tAND \r\n\t(\r\n\t\t(\r\n\t\t\t\t(FirstNotPickupRequestDateTime \u003E= @StartNotPickupRequestTime OR ISNULL(@StartNotPickupRequestTime,0) = 0)\r\n\t\t\tAND (FirstNotPickupRequestDateTime \u003C= @EndNotPickupRequestTime OR ISNULL(@EndNotPickupRequestTime,0) = 0)\r\n\t\t) \r\n\t\tOR\r\n\t\t(\r\n\t\t\t\t(SecondNotPickupRequestDateTime \u003E= @StartNotPickupRequestTime OR ISNULL(@StartNotPickupRequestTime,0) = 0)\r\n\t\t\tAND (SecondNotPickupRequestDateTime \u003C= @EndNotPickupRequestTime OR ISNULL(@EndNotPickupRequestTime,0) = 0)\r\n\t\t)\r\n\t)\r\n\r\n\r\n)SQ\r\n\r\nSET @TotalCount = @@ROWCOUNT\r\nSET @TotalCount = ISNULL(@TotalCount,0)\r\nSET @pageIndex = ISNULL(@pageIndex,0)\r\n\r\nIF ISNULL(@pageSize,0) = 0\r\nBEGIN\r\n\tIF @TotalCount = 0\r\n\t\tSET @pageSize = 1\r\n\tELSE\r\n\t\tSET @pageSize = @TotalCount\r\nEND\r\n\r\n\r\nSET @Result =\r\n(\r\n\tSELECT \r\n\t\t*,\r\n\tSUBSTRING(FORMAT(DeliveryStartTimePersian,\u0027####/##/## ##:##:##\\.###\u0027),0,11) \u002B \u0027 (\u0027 \u002B SUBSTRING(FORMAT(DeliveryStartTimePersian,\u0027####/##/## ##:##:##\\.###\u0027),12,5) \u002B \u0027 - \u0027 \u002B\r\n\t\t\t\t\t\t\t\t\t\t\tSUBSTRING(FORMAT(DeliveryDeadLineTime,\u0027####/##/## ##:##:##\\.###\u0027),12,5) \u002B \u0027)\u0027  AS deliveryDatePersianStr\r\n\tFROM #Final\r\n\tORDER BY ProvinceTitle,DeliveryStartTimePersian\r\n\tOFFSET (@pageIndex * @pageSize) ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\tFOR JSON PATH, INCLUDE_NULL_VALUES , ROOT (\u0027Result\u0027)\r\n)\r\n\r\n\r\n\r\nSET @Result = Replace(@result,\u0027\\\u0027,\u0027\u0027)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.totalCount\u0027,@TotalCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.pageSize\u0027,@PageSize)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.currentPage\u0027,@PageIndex )\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.totalPages\u0027,(@TotalCount \u002B @PageSize - 1) / @PageSize)\r\n\r\n\r\nDROP TABLE IF EXISTS #STOREIDS,#PolygonIDS,#CourierRequestTypeIDS,#CityIDs,#Final,#DeliveryServiceProviderIds\r\n\r\n"},{"Name":"Report_NotPickupDispatchRequest_New","Schema":"dbo","Definition":"CREATE       PROC [dbo].[Report_NotPickupDispatchRequest_New]\r\n(\r\n\t@ProvinceId TINYINT = NULL,\r\n\t@CityId SMALLINT = NULL,\r\n\t@PolygonIds VARCHAR(MAX) = NULL,\r\n\t@StoreIds VARCHAR(MAX) = NULL,\r\n\t@VendorId INT = NULL,\r\n\t@VendorParcelCode VARCHAR(MAX) = NULL,\r\n\t@ParcelReferenceCode bigint = NULL,\r\n\t@CourierRequestTypeIds VARCHAR(MAX) = NULL,\r\n\t@StartDeliveryTime BIGINT ,\r\n\t@EndDeliveryTime BIGINT ,\r\n\t@ShipmentNumber BIGINT = NULL,\r\n\t@FleetId  INT = NULL,\r\n\t@DispatchRequestStatusId TINYINT = NULL,\r\n\t@DeliveryServiceProviderIds VARCHAR(MAX) = NULL,\r\n\t@NotPickupReasonId\tINT = NULL,\r\n\t@IsFirstNotPickupRequestApproved BIT = NULL,\r\n\t@StartNotPickupRequestTime BIGINT = NULL,\r\n\t@EndNotPickupRequestTime BIGINT = NULL,\r\n\t@PageIndex\t\t\t\t\t\t\t\t\tINT\t\t\t\t,--=0,\t\t\t\t\r\n\t@PageSize\t\t\t\t\t\t\t\t\tINT\t\t\t\t,--=10,\t\r\n\t--@TotalCount\t\t\t\t\t\t\t\t\tINT OUTPUT,\r\n\t@Result NVARCHAR(MAX) OUTPUT\r\n\t\t\r\n)\r\nAS\r\nSET NOCOUNT ON\r\n\r\nDROP TABLE IF EXISTS #STOREIDS,#PolygonIDS,#CourierRequestTypeIDS,#CityIDs,#Final,#DeliveryServiceProviderIds\r\n\r\nDECLARE @TotalCount INT = 0\r\n\r\nSELECT \r\n\tc.Id\r\nINTO #CityIDs\r\nFROM CS_Public.HAF.City c (NOLOCK)\r\nWHERE (c.ID = @CityId OR ISNULL(@CityId,0) = 0)\r\nAND (c.ProvinceId = @ProvinceId OR ISNULL(@ProvinceId,0) = 0)\r\n\r\nSELECT\r\n\tS.ID\r\nINTO #STOREIDS\r\nFROM DP.STORE S (NOLOCK)\r\nINNER JOIN string_split(ISNULL(@STOREIdS,\u00270\u0027),\u0027,\u0027) ss\r\n\tON S.Id = ss.value\r\n\tOR ISNULL(@STOREIdS,\u00270\u0027) = \u00270\u0027\r\n\r\nSELECT \r\n    P.Id\r\nINTO #PolygonIDS\r\nFROM DP.Polygon P (NOLOCK)\r\nINNER JOIN #CityIDs cID\r\n\tON p.CityId = cID.Id\r\nINNER JOIN string_split(ISNULL(@PolygonIDS,\u00270\u0027),\u0027,\u0027)SS\r\n\tON P.ID=SS.value\r\n\tOR ISNULL(@PolygonIDS,\u00270\u0027) = \u00270\u0027\r\n\r\nSELECT \r\n    cr.Id\r\nINTO #CourierRequestTypeIDS\r\nFROM CS_Public.[PUB].[CourierRequestType] cr (NOLOCK)\r\nINNER JOIN string_split(ISNULL(@CourierRequestTypeIds,\u00270\u0027),\u0027,\u0027)SS\r\n\tON cr.ID=SS.value\r\n\tOR ISNULL(@CourierRequestTypeIds,\u00270\u0027) = \u00270\u0027\r\n\r\nSELECT \r\n    dsp.Id\r\nINTO #DeliveryServiceProviderIds\r\nFROM DP.DeliveryServiceProvider dsp (NOLOCK)\r\nINNER JOIN string_split(ISNULL(@DeliveryServiceProviderIds,\u00270\u0027),\u0027,\u0027)SS\r\n\tON dsp.ID=SS.value\r\n\tOR ISNULL(@DeliveryServiceProviderIds,\u00270\u0027) = \u00270\u0027\r\n\r\nDROP TABLE IF EXISTS #DR\r\n\r\n\tSELECT --TOP 1\r\n\t\tdr.Id AS DispatchRequestId,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdrs.Title AS DispatchRequestStatusTitle,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.DeliveryStartTimePersian,\r\n\t\tdr.DeliveryStartTime,\r\n\t\tdr.DeliveryDeadLineTime,\r\n\r\n\r\n\t\tpr.Id AS ProvinceId,\r\n\t\tpr.Name AS ProvinceTitle,\r\n\r\n\t\tc.Id AS CityId,\r\n\t\tc.Name AS CityTitle,\r\n\r\n\t\tp.Id AS PolygonId,\r\n\t\tp.Title AS PolygonTitle,\r\n\r\n\t\ts.Id AS StoreId,\r\n\t\ts.Title AS StoreTitle,\r\n\t\ts.VendorCode AS StoreCode,\r\n\t\tdr.VendorId,\r\n\t\tv.BrandName AS VendorBrandName,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\tcrt.Title AS CourierRequestTypeTitle,\r\n\t\tdr.Version AS DispatchRequestVersion\r\n\tINTO #DR\r\n\tFROM DP.DispatchRequest dr (NOLOCK)\r\n\tINNER JOIN DP.DispatchRequestStatus drs (NOLOCK)\r\n\t\tON dr.DispatchRequestStatusId = drs.Id\r\n\tINNER JOIN DP.PolygonStore ps (NOLOCK)\r\n\t\tON dr.PolygonStoreId = ps.Id\r\n\tINNER JOIN DP.Polygon p (NOLOCK)\r\n\t\tON ps.PolygonId = p.Id\r\n\tINNER JOIN DP.Store s (NOLOCK)\r\n\t\tON ps.StoreId = s.Id\r\n\r\n\tINNER JOIN CS_Public.Haf.City c (NOLOCK)\r\n\t\tON p.CityId = c.Id\r\n\tINNER JOIN CS_Public.Haf.Province pr (NOLOCK)\r\n\t\tON c.ProvinceId = pr.Id\r\n\tINNER JOIN #PolygonIDS PLI\r\n\t\tON p.ID = PLI.Id\r\n\tINNER JOIN #STOREIDS SI\r\n\t\tON SI.ID = PS.StoreId\r\n\tINNER JOIN #CourierRequestTypeIDS crtID\r\n\t\tON dr.CourierRequestTypeId = crtID.Id\r\n\tINNER JOIN CS_Public.PUB.CourierRequestType crt (NOLOCK)\r\n\t\tON dr.CourierRequestTypeId = crt.Id\r\n\tINNER JOIN CS_UserManagement.UM.Vendor v (NOLOCK)\r\n\t\tON dr.VendorId = v.Id\r\n\tINNER JOIN #DeliveryServiceProviderIds dspID\r\n\t\tON dr.DeliveryServiceProviderId = dspID.Id\r\n\tINNER JOIN DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\t\tON dr.DeliveryServiceProviderId = dsp.Id\r\n\r\n\tWHERE \r\n\t\tdr.DeliveryStartTime \u003E= @StartDeliveryTime\r\n\tAND dr.DeliveryStartTime \u003C= @EndDeliveryTime\r\n\tAND (dr.VendorId = @VendorId OR ISNULL(@VendorId,0) = 0)\r\n\tAND (dr.VendorParcelCode = @VendorParcelCode OR ISNULL(@VendorParcelCode,\u00270\u0027) = \u00270\u0027)\r\n\tAND (dr.ParcelReferenceCode = @ParcelReferenceCode OR ISNULL(@ParcelReferenceCode,0) = 0)\r\n\tAND (dr.DispatchRequestStatusId = @DispatchRequestStatusId OR ISNULL(@DispatchRequestStatusId,0) = 0)\t\r\n\tAND EXISTS \r\n\t(\r\n\t\tSELECT * FROM DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK)\r\n\t\tWHERE dr.Id = uorh.DispatchRequestId\r\n\t)\r\n\r\nSET @TotalCount = @@ROWCOUNT\r\nSET @TotalCount = ISNULL(@TotalCount,0)\r\nSET @pageIndex = ISNULL(@pageIndex,0)\r\n\r\nIF ISNULL(@pageSize,0) = 0\r\nBEGIN\r\n\tIF @TotalCount = 0\r\n\t\tSET @pageSize = 1\r\n\tELSE\r\n\t\tSET @pageSize = @TotalCount\r\nEND\r\n\r\n;WITH CTE_DR AS\r\n(\r\n\tSELECT\r\n\t\tdr.DispatchRequestId,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdr.DispatchRequestStatusTitle,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.DeliveryStartTimePersian,\r\n\t\tdr.DeliveryStartTime,\r\n\t\tdr.DeliveryDeadLineTime,\r\n\t\tdr.ProvinceId,\r\n\t\tdr.ProvinceTitle,\r\n\t\tdr.CityId,\r\n\t\tdr.CityTitle,\r\n\t\tdr.PolygonId,\r\n\t\tdr.PolygonTitle,\r\n\t\tdr.StoreId,\r\n\t\tdr.StoreTitle,\r\n\t\tdr.StoreCode,\r\n\t\tdr.VendorId,\r\n\t\tdr.VendorBrandName,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\tdr.CourierRequestTypeTitle,\r\n\t\tdr.DispatchRequestVersion\r\n\r\n\tFROM #DR dr\r\n\tORDER BY ProvinceTitle,DeliveryStartTimePersian\r\n\tOFFSET (@pageIndex * @pageSize) ROWS FETCH NEXT @pageSize ROWS ONLY\r\n\r\n),CTE_Shipment AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tsdpdr.DispatchRequestId,\r\n\t\tsdpdr.Version AS ShipmentDestinationPointDispatchRequestVersion,\r\n\t\tsdp.ShipmentId,\r\n\t\ts.ShipmentNumber,\r\n\t\ts.FleetId,\r\n\t\ts.DeliveryServiceProviderId\r\n\tFROM DP.ShipmentDestinationPointDispatchRequest sdpdr (NOLOCK)\r\n\tINNER JOIN DP.ShipmentDestinationPoint sdp (NOLOCK)\r\n\t\tON sdpdr.ShipmentDestinationPointId = sdp.Id\r\n\tINNER JOIN DP.Shipment s (NOLOCK)\r\n\t\tON sdp.ShipmentId = s.Id\r\n),CTE_UORH AS\r\n(\r\n\tSELECT \r\n\t\tSQ.DispatchRequestId,\r\n\t\tSQ.ShipmentId,\r\n\t\tSQ.FleetId,\r\n\t\tMAX(Description) AS Description,\r\n\t\tMAX(NotPickupRequestTime) AS NotPickupRequestTime,\r\n\t\tMAX(NotPickupReasonIdOfFleet) AS NotPickupReasonIdOfFleet,\r\n\t\tMAX(NotPickupReasonTitleOfFleet) AS NotPickupReasonTitleOfFleet,\r\n\t\tMAX(NotPickupResultTime) AS NotPickupResultTime,\r\n\t\tMAX(NotPickupReasonIdOfOperationStaff) AS NotPickupReasonIdOfOperationStaff,\r\n\t\tMAX(NotPickupReasonTitleOfOperationStaff) AS NotPickupReasonTitleOfOperationStaff,\r\n\t\tMAX(OperationName) AS OperationName,\r\n\t\tMAX(isNotPickupApprovedBySystem) AS isNotPickupApprovedBySystem\r\n\tFROM\r\n\t(\r\n\t\tSELECT \r\n\t\t\tuorh.OperationTypeId,\r\n\t\t\tuorh.ShipmentId,\r\n\t\t\tuorh.FleetId,\r\n\t\t\tuorh.Version,\r\n\t\t\tuorh.DispatchRequestId,\r\n\t\t\tuorh.Description,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.CreateDate ELSE NULL END NotPickupRequestTime,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN uorh.OperationFailureReasonId ELSE NULL END NotPickupReasonIdOfFleet,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 6,9 ) THEN ofr.Title ELSE NULL END AS NotPickupReasonTitleOfFleet,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 7,8,9,35 ) THEN uorh.CreateDate ELSE NULL END NotPickupResultTime,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.OperationFailureReasonId ELSE NULL END NotPickupReasonIdOfOperationStaff,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN ofr.Title ELSE NULL END NotPickupReasonTitleOfOperationStaff,\r\n\t\t\tCASE WHEN uorh.OperationTypeId IN ( 8,35 ) THEN uorh.CreatorUserName ELSE NULL END OperationName,\r\n\t\t\tCASE WHEN uorh.OperationTypeId = 8 AND CreatorUserName = \u0027system|system\u0027 THEN 0 ELSE 1 END AS isNotPickupApprovedBySystem\r\n\t\tFROM DP.UnsuccessfulOperationRequestHistory uorh (NOLOCK)\r\n\t\tINNER JOIN DP.OperationFailureReason ofr (NOLOCK)\r\n\t\t\tON uorh.OperationFailureReasonId = ofr.Id\r\n\t) SQ\r\n\tGroup BY\r\n\t\tSQ.DispatchRequestId,\r\n\t\tSQ.ShipmentId,\r\n\t\tSQ.FleetId\r\n)\r\n\r\nSELECT @Result =\r\n( \r\n\tSELECT \r\n\t\tdr.DispatchRequestId,\r\n\t\tdr.DispatchRequestStatusId,\r\n\t\tdr.DispatchRequestStatusTitle,\r\n\t\tdr.VendorParcelCode,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.DeliveryStartTimePersian,\r\n\t\tdr.DeliveryDeadLineTime,\r\n\t\tdr.ProvinceId,\r\n\t\tdr.ProvinceTitle,\r\n\t\tdr.CityId,\r\n\t\tdr.CityTitle,\r\n\t\tdr.PolygonId,\r\n\t\tdr.PolygonTitle,\r\n\t\tdr.StoreId,\r\n\t\tdr.StoreTitle,\r\n\t\tdr.StoreCode,\r\n\t\tdr.VendorId,\r\n\t\tdr.VendorBrandName,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\tdr.CourierRequestTypeTitle,\r\n\t\tSUBSTRING(CAST(dr.DeliveryStartTimePersian AS VARCHAR(MAX)),1,4) \u002B \u0027/\u0027 \u002B\r\n\t\tSUBSTRING(CAST(dr.DeliveryStartTimePersian AS VARCHAR(MAX)),5,2) \u002B \u0027/\u0027 \u002B \r\n\t\tSUBSTRING(CAST(dr.DeliveryStartTimePersian AS VARCHAR(MAX)),7,2) \u002B \u0027 (\u0027 \u002B\r\n\t\tSUBSTRING(CAST(dr.DeliveryStartTimePersian AS VARCHAR(MAX)),9,2) \u002B \u0027:\u0027 \u002B\r\n\t\tSUBSTRING(CAST(dr.DeliveryStartTimePersian AS VARCHAR(MAX)),11,2) \u002B \u0027 - \u0027 \u002B\r\n\t\tSUBSTRING(CAST(dr.DeliveryStartTimePersian AS VARCHAR(MAX)),13,2) \u002B \u0027:\u0027 \u002B\r\n\t\tSUBSTRING(CAST(dr.DeliveryStartTimePersian AS VARCHAR(MAX)),15,2) \u002B \u0027)\u0027 AS deliveryDatePersianStr,\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\t\ts.ShipmentDestinationPointDispatchRequestVersion AS [Version],\r\n\t\t\t\ts.ShipmentNumber,\r\n\t\t\t\ts.DeliveryServiceProviderId,\r\n\t\t\t\tdsp.Title AS DeliveryServiceProviderTitle,\r\n\t\t\t\ts.FleetId,\r\n\t\t\t\td.FirstName \u002B \u0027 \u0027 \u002B d.LastName AS DriverName,\r\n\t\t\t\td.Mobile AS DriverMobile,\r\n\t\t\t\tCAST(CONVERT(varchar,FORMAT(uorh.NotPickupRequestTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS Time) AS NotPickupRequestTimeStr,\r\n\t\t\t\tuorh.NotPickupReasonIdOfFleet,\r\n\t\t\t\tuorh.NotPickupReasonTitleOfFleet,\r\n\t\t\t\tCAST(CONVERT(varchar,FORMAT(uorh.NotPickupResultTime,\u0027####-##-## ##:##:##\\.###\u0027),120) AS Time) AS NotPickupResultTimeStr,\r\n\t\t\t\tuorh.NotPickupReasonIdOfOperationStaff,\r\n\t\t\t\tuorh.NotPickupReasonTitleOfOperationStaff,\r\n\t\t\t\tuorh.OperationName,\r\n\t\t\t\tuorh.isNotPickupApprovedBySystem,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN uorh.DispatchRequestId IS NULL\r\n\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tELSE \r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN dr.DispatchRequestVersion \u003C\u003E s.ShipmentDestinationPointDispatchRequestVersion\r\n\t\t\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\t\t0\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND AS IsFirstNotPickupRequestApproved,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN dr.DispatchRequestVersion \u003C\u003E s.ShipmentDestinationPointDispatchRequestVersion AND dr.DispatchRequestStatusId = 40\r\n\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\t0\r\n\t\t\t\t\tEND isRequestCanceledByNotPickupRequest,\r\n\t\t\t\t\tuorh.Description\r\n\t\t\tFROM CTE_Shipment s\r\n\t\t\tINNER JOIN CTE_UORH uorh\r\n\t\t\t\tON s.ShipmentId = uorh.ShipmentId\r\n\t\t\t\tAND s.FleetId = uorh.FleetId\r\n\t\t\t\tAND s.DispatchRequestId = uorh.DispatchRequestId\r\n\t\t\tINNER JOIN DP.DeliveryServiceProvider dsp (NOLOCK)\r\n\t\t\t\tON s.DeliveryServiceProviderId = dsp.Id\r\n\t\t\tINNER JOIN CS_DriverManagement.DM.Fleet f (NOLOCK)\r\n\t\t\t\tON s.FleetId = f.Id\r\n\t\t\tINNER JOIN CS_DriverManagement.DM.Driver d (NOLOCK)\r\n\t\t\t\tON f.DriverId = d.Id\r\n\t\t\tWHERE s.DispatchRequestId = dr.DispatchRequestId\r\n\t\t\tFOR JSON PATH, INCLUDE_NULL_VALUES\r\n\t\t) [Version]\r\n\tFROM CTE_DR dr\r\n\tFOR JSON PATH, INCLUDE_NULL_VALUES , ROOT (\u0027Result\u0027)\r\n)\r\n\r\n\r\n\r\nSET @Result = Replace(@result,\u0027\\\u0027,\u0027\u0027)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.totalCount\u0027,@TotalCount)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.pageSize\u0027,@PageSize)\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.currentPage\u0027,@PageIndex )\r\nSET @Result = JSON_MODIFY(@Result,\u0027$.totalPages\u0027,(@TotalCount \u002B @PageSize - 1) / @PageSize)\r\n\r\n\r\n"},{"Name":"sp_alterdiagram","Schema":"dbo","Definition":"\r\n\tCREATE PROCEDURE dbo.sp_alterdiagram\r\n\t(\r\n\t\t@diagramname \tsysname,\r\n\t\t@owner_id\tint\t= null,\r\n\t\t@version \tint,\r\n\t\t@definition \tvarbinary(max)\r\n\t)\r\n\tWITH EXECUTE AS \u0027dbo\u0027\r\n\tAS\r\n\tBEGIN\r\n\t\tset nocount on\r\n\t\r\n\t\tdeclare @theId \t\t\tint\r\n\t\tdeclare @retval \t\tint\r\n\t\tdeclare @IsDbo \t\t\tint\r\n\t\t\r\n\t\tdeclare @UIDFound \t\tint\r\n\t\tdeclare @DiagId\t\t\tint\r\n\t\tdeclare @ShouldChangeUID\tint\r\n\t\r\n\t\tif(@diagramname is null)\r\n\t\tbegin\r\n\t\t\tRAISERROR (\u0027Invalid ARG\u0027, 16, 1)\r\n\t\t\treturn -1\r\n\t\tend\r\n\t\r\n\t\texecute as caller;\r\n\t\tselect @theId = DATABASE_PRINCIPAL_ID();\t \r\n\t\tselect @IsDbo = IS_MEMBER(N\u0027db_owner\u0027); \r\n\t\tif(@owner_id is null)\r\n\t\t\tselect @owner_id = @theId;\r\n\t\trevert;\r\n\t\r\n\t\tselect @ShouldChangeUID = 0\r\n\t\tselect @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname \r\n\t\t\r\n\t\tif(@DiagId IS NULL or (@IsDbo = 0 and @theId \u003C\u003E @UIDFound))\r\n\t\tbegin\r\n\t\t\tRAISERROR (\u0027Diagram does not exist or you do not have permission.\u0027, 16, 1);\r\n\t\t\treturn -3\r\n\t\tend\r\n\t\r\n\t\tif(@IsDbo \u003C\u003E 0)\r\n\t\tbegin\r\n\t\t\tif(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id\r\n\t\t\tbegin\r\n\t\t\t\tselect @ShouldChangeUID = 1 ;\r\n\t\t\tend\r\n\t\tend\r\n\r\n\t\t-- update dds data\t\t\t\r\n\t\tupdate dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;\r\n\r\n\t\t-- change owner\r\n\t\tif(@ShouldChangeUID = 1)\r\n\t\t\tupdate dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;\r\n\r\n\t\t-- update dds version\r\n\t\tif(@version is not null)\r\n\t\t\tupdate dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;\r\n\r\n\t\treturn 0\r\n\tEND\r\n\t"},{"Name":"sp_creatediagram","Schema":"dbo","Definition":"\r\n\tCREATE PROCEDURE dbo.sp_creatediagram\r\n\t(\r\n\t\t@diagramname \tsysname,\r\n\t\t@owner_id\t\tint\t= null, \t\r\n\t\t@version \t\tint,\r\n\t\t@definition \tvarbinary(max)\r\n\t)\r\n\tWITH EXECUTE AS \u0027dbo\u0027\r\n\tAS\r\n\tBEGIN\r\n\t\tset nocount on\r\n\t\r\n\t\tdeclare @theId int\r\n\t\tdeclare @retval int\r\n\t\tdeclare @IsDbo\tint\r\n\t\tdeclare @userName sysname\r\n\t\tif(@version is null or @diagramname is null)\r\n\t\tbegin\r\n\t\t\tRAISERROR (N\u0027E_INVALIDARG\u0027, 16, 1);\r\n\t\t\treturn -1\r\n\t\tend\r\n\t\r\n\t\texecute as caller;\r\n\t\tselect @theId = DATABASE_PRINCIPAL_ID(); \r\n\t\tselect @IsDbo = IS_MEMBER(N\u0027db_owner\u0027);\r\n\t\trevert; \r\n\t\t\r\n\t\tif @owner_id is null\r\n\t\tbegin\r\n\t\t\tselect @owner_id = @theId;\r\n\t\tend\r\n\t\telse\r\n\t\tbegin\r\n\t\t\tif @theId \u003C\u003E @owner_id\r\n\t\t\tbegin\r\n\t\t\t\tif @IsDbo = 0\r\n\t\t\t\tbegin\r\n\t\t\t\t\tRAISERROR (N\u0027E_INVALIDARG\u0027, 16, 1);\r\n\t\t\t\t\treturn -1\r\n\t\t\t\tend\r\n\t\t\t\tselect @theId = @owner_id\r\n\t\t\tend\r\n\t\tend\r\n\t\t-- next 2 line only for test, will be removed after define name unique\r\n\t\tif EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)\r\n\t\tbegin\r\n\t\t\tRAISERROR (\u0027The name is already used.\u0027, 16, 1);\r\n\t\t\treturn -2\r\n\t\tend\r\n\t\r\n\t\tinsert into dbo.sysdiagrams(name, principal_id , version, definition)\r\n\t\t\t\tVALUES(@diagramname, @theId, @version, @definition) ;\r\n\t\t\r\n\t\tselect @retval = @@IDENTITY \r\n\t\treturn @retval\r\n\tEND\r\n\t"},{"Name":"sp_dropdiagram","Schema":"dbo","Definition":"\r\n\tCREATE PROCEDURE dbo.sp_dropdiagram\r\n\t(\r\n\t\t@diagramname \tsysname,\r\n\t\t@owner_id\tint\t= null\r\n\t)\r\n\tWITH EXECUTE AS \u0027dbo\u0027\r\n\tAS\r\n\tBEGIN\r\n\t\tset nocount on\r\n\t\tdeclare @theId \t\t\tint\r\n\t\tdeclare @IsDbo \t\t\tint\r\n\t\t\r\n\t\tdeclare @UIDFound \t\tint\r\n\t\tdeclare @DiagId\t\t\tint\r\n\t\r\n\t\tif(@diagramname is null)\r\n\t\tbegin\r\n\t\t\tRAISERROR (\u0027Invalid value\u0027, 16, 1);\r\n\t\t\treturn -1\r\n\t\tend\r\n\t\r\n\t\tEXECUTE AS CALLER;\r\n\t\tselect @theId = DATABASE_PRINCIPAL_ID();\r\n\t\tselect @IsDbo = IS_MEMBER(N\u0027db_owner\u0027); \r\n\t\tif(@owner_id is null)\r\n\t\t\tselect @owner_id = @theId;\r\n\t\tREVERT; \r\n\t\t\r\n\t\tselect @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname \r\n\t\tif(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound \u003C\u003E @theId))\r\n\t\tbegin\r\n\t\t\tRAISERROR (\u0027Diagram does not exist or you do not have permission.\u0027, 16, 1)\r\n\t\t\treturn -3\r\n\t\tend\r\n\t\r\n\t\tdelete from dbo.sysdiagrams where diagram_id = @DiagId;\r\n\t\r\n\t\treturn 0;\r\n\tEND\r\n\t"},{"Name":"sp_helpdiagramdefinition","Schema":"dbo","Definition":"\r\n\tCREATE PROCEDURE dbo.sp_helpdiagramdefinition\r\n\t(\r\n\t\t@diagramname \tsysname,\r\n\t\t@owner_id\tint\t= null \t\t\r\n\t)\r\n\tWITH EXECUTE AS N\u0027dbo\u0027\r\n\tAS\r\n\tBEGIN\r\n\t\tset nocount on\r\n\r\n\t\tdeclare @theId \t\tint\r\n\t\tdeclare @IsDbo \t\tint\r\n\t\tdeclare @DiagId\t\tint\r\n\t\tdeclare @UIDFound\tint\r\n\t\r\n\t\tif(@diagramname is null)\r\n\t\tbegin\r\n\t\t\tRAISERROR (N\u0027E_INVALIDARG\u0027, 16, 1);\r\n\t\t\treturn -1\r\n\t\tend\r\n\t\r\n\t\texecute as caller;\r\n\t\tselect @theId = DATABASE_PRINCIPAL_ID();\r\n\t\tselect @IsDbo = IS_MEMBER(N\u0027db_owner\u0027);\r\n\t\tif(@owner_id is null)\r\n\t\t\tselect @owner_id = @theId;\r\n\t\trevert; \r\n\t\r\n\t\tselect @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;\r\n\t\tif(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound \u003C\u003E @theId ))\r\n\t\tbegin\r\n\t\t\tRAISERROR (\u0027Diagram does not exist or you do not have permission.\u0027, 16, 1);\r\n\t\t\treturn -3\r\n\t\tend\r\n\r\n\t\tselect version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; \r\n\t\treturn 0\r\n\tEND\r\n\t"},{"Name":"sp_helpdiagrams","Schema":"dbo","Definition":"\r\n\tCREATE PROCEDURE dbo.sp_helpdiagrams\r\n\t(\r\n\t\t@diagramname sysname = NULL,\r\n\t\t@owner_id int = NULL\r\n\t)\r\n\tWITH EXECUTE AS N\u0027dbo\u0027\r\n\tAS\r\n\tBEGIN\r\n\t\tDECLARE @user sysname\r\n\t\tDECLARE @dboLogin bit\r\n\t\tEXECUTE AS CALLER;\r\n\t\t\tSET @user = USER_NAME();\r\n\t\t\tSET @dboLogin = CONVERT(bit,IS_MEMBER(\u0027db_owner\u0027));\r\n\t\tREVERT;\r\n\t\tSELECT\r\n\t\t\t[Database] = DB_NAME(),\r\n\t\t\t[Name] = name,\r\n\t\t\t[ID] = diagram_id,\r\n\t\t\t[Owner] = USER_NAME(principal_id),\r\n\t\t\t[OwnerID] = principal_id\r\n\t\tFROM\r\n\t\t\tsysdiagrams\r\n\t\tWHERE\r\n\t\t\t(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND\r\n\t\t\t(@diagramname IS NULL OR name = @diagramname) AND\r\n\t\t\t(@owner_id IS NULL OR principal_id = @owner_id)\r\n\t\tORDER BY\r\n\t\t\t4, 5, 1\r\n\tEND\r\n\t"},{"Name":"sp_renamediagram","Schema":"dbo","Definition":"\r\n\tCREATE PROCEDURE dbo.sp_renamediagram\r\n\t(\r\n\t\t@diagramname \t\tsysname,\r\n\t\t@owner_id\t\tint\t= null,\r\n\t\t@new_diagramname\tsysname\r\n\t\r\n\t)\r\n\tWITH EXECUTE AS \u0027dbo\u0027\r\n\tAS\r\n\tBEGIN\r\n\t\tset nocount on\r\n\t\tdeclare @theId \t\t\tint\r\n\t\tdeclare @IsDbo \t\t\tint\r\n\t\t\r\n\t\tdeclare @UIDFound \t\tint\r\n\t\tdeclare @DiagId\t\t\tint\r\n\t\tdeclare @DiagIdTarg\t\tint\r\n\t\tdeclare @u_name\t\t\tsysname\r\n\t\tif((@diagramname is null) or (@new_diagramname is null))\r\n\t\tbegin\r\n\t\t\tRAISERROR (\u0027Invalid value\u0027, 16, 1);\r\n\t\t\treturn -1\r\n\t\tend\r\n\t\r\n\t\tEXECUTE AS CALLER;\r\n\t\tselect @theId = DATABASE_PRINCIPAL_ID();\r\n\t\tselect @IsDbo = IS_MEMBER(N\u0027db_owner\u0027); \r\n\t\tif(@owner_id is null)\r\n\t\t\tselect @owner_id = @theId;\r\n\t\tREVERT;\r\n\t\r\n\t\tselect @u_name = USER_NAME(@owner_id)\r\n\t\r\n\t\tselect @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname \r\n\t\tif(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound \u003C\u003E @theId))\r\n\t\tbegin\r\n\t\t\tRAISERROR (\u0027Diagram does not exist or you do not have permission.\u0027, 16, 1)\r\n\t\t\treturn -3\r\n\t\tend\r\n\t\r\n\t\t-- if((@u_name is not null) and (@new_diagramname = @diagramname))\t-- nothing will change\r\n\t\t--\treturn 0;\r\n\t\r\n\t\tif(@u_name is null)\r\n\t\t\tselect @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname\r\n\t\telse\r\n\t\t\tselect @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname\r\n\t\r\n\t\tif((@DiagIdTarg is not null) and  @DiagId \u003C\u003E @DiagIdTarg)\r\n\t\tbegin\r\n\t\t\tRAISERROR (\u0027The name is already used.\u0027, 16, 1);\r\n\t\t\treturn -2\r\n\t\tend\t\t\r\n\t\r\n\t\tif(@u_name is null)\r\n\t\t\tupdate dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId\r\n\t\telse\r\n\t\t\tupdate dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId\r\n\t\treturn 0\r\n\tEND\r\n\t"},{"Name":"SP_Stimul_FleetInfo","Schema":"dbo","Definition":"\r\n\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/12/22\r\n--\tDescription:\tGet Returned List By Filter\r\n--\r\n--\t=======================================\r\n\r\nCREATE      PROCEDURE [dbo].[SP_Stimul_FleetInfo]\r\n\r\nAS \r\n\tSET NOCOUNT ON;\r\n    --############################################ Calculate Result ##############################################\r\n    SELECT DISTINCT Top (100)\r\n\t\t   \r\n\t\t   f.Id FleetId,\r\n\t\t   fs2.Title FleetStatusTitle,\r\n\t\t   d.Code FleetNational,\r\n\t\t   d.Mobile,\r\n\t\t   d.FirstName,\r\n\t\t   d.LastName,\r\n\t\t   vt.Title VehicleTypeTitle,\r\n\t\t   v.PlateNumber\r\n\t\r\n\tFROM DP.Fleet AS f\r\n\tLEFT JOIN DP.FleetShift AS fs ON fs.FleetId = f.Id\r\n\tLEFT JOIN DP.Driver AS d ON d.Id = f.DriverId\r\n\tLEFT JOIN DP.Vehicle AS v ON v.Id = f.VehicleId\r\n\tLEFT JOIN DP.FleetStatus AS fs2 ON f.FleetStatusId = fs2.Id\r\n\tLEFT JOIN DP.VehicleType AS vt ON v.VehicleTypeId = vt.Id\r\n\r\n\tWHERE f.IsActive = 1 AND d.IsActive = 1"},{"Name":"sp_upgraddiagrams","Schema":"dbo","Definition":"\r\n\tCREATE PROCEDURE dbo.sp_upgraddiagrams\r\n\tAS\r\n\tBEGIN\r\n\t\tIF OBJECT_ID(N\u0027dbo.sysdiagrams\u0027) IS NOT NULL\r\n\t\t\treturn 0;\r\n\t\r\n\t\tCREATE TABLE dbo.sysdiagrams\r\n\t\t(\r\n\t\t\tname sysname NOT NULL,\r\n\t\t\tprincipal_id int NOT NULL,\t-- we may change it to varbinary(85)\r\n\t\t\tdiagram_id int PRIMARY KEY IDENTITY,\r\n\t\t\tversion int,\r\n\t\r\n\t\t\tdefinition varbinary(max)\r\n\t\t\tCONSTRAINT UK_principal_name UNIQUE\r\n\t\t\t(\r\n\t\t\t\tprincipal_id,\r\n\t\t\t\tname\r\n\t\t\t)\r\n\t\t);\r\n\r\n\r\n\t\t/* Add this if we need to have some form of extended properties for diagrams */\r\n\t\t/*\r\n\t\tIF OBJECT_ID(N\u0027dbo.sysdiagram_properties\u0027) IS NULL\r\n\t\tBEGIN\r\n\t\t\tCREATE TABLE dbo.sysdiagram_properties\r\n\t\t\t(\r\n\t\t\t\tdiagram_id int,\r\n\t\t\t\tname sysname,\r\n\t\t\t\tvalue varbinary(max) NOT NULL\r\n\t\t\t)\r\n\t\tEND\r\n\t\t*/\r\n\r\n\t\tIF OBJECT_ID(N\u0027dbo.dtproperties\u0027) IS NOT NULL\r\n\t\tbegin\r\n\t\t\tinsert into dbo.sysdiagrams\r\n\t\t\t(\r\n\t\t\t\t[name],\r\n\t\t\t\t[principal_id],\r\n\t\t\t\t[version],\r\n\t\t\t\t[definition]\r\n\t\t\t)\r\n\t\t\tselect\t \r\n\t\t\t\tconvert(sysname, dgnm.[uvalue]),\r\n\t\t\t\tDATABASE_PRINCIPAL_ID(N\u0027dbo\u0027),\t\t\t-- will change to the sid of sa\r\n\t\t\t\t0,\t\t\t\t\t\t\t-- zero for old format, dgdef.[version],\r\n\t\t\t\tdgdef.[lvalue]\r\n\t\t\tfrom dbo.[dtproperties] dgnm\r\n\t\t\t\tinner join dbo.[dtproperties] dggd on dggd.[property] = \u0027DtgSchemaGUID\u0027 and dggd.[objectid] = dgnm.[objectid]\t\r\n\t\t\t\tinner join dbo.[dtproperties] dgdef on dgdef.[property] = \u0027DtgSchemaDATA\u0027 and dgdef.[objectid] = dgnm.[objectid]\r\n\t\t\t\t\r\n\t\t\twhere dgnm.[property] = \u0027DtgSchemaNAME\u0027 and dggd.[uvalue] like N\u0027_EA3E6268-D998-11CE-9454-00AA00A3F36E_\u0027 \r\n\t\t\treturn 2;\r\n\t\tend\r\n\t\treturn 1;\r\n\tEND\r\n\t"},{"Name":"spHeartbeat","Schema":"dbo","Definition":"CREATE PROCEDURE spHeartbeat\r\nAS\r\n\tSELECT 1\r\n"},{"Name":"StorePolygonAssignmentsCount","Schema":"dbo","Definition":"CREATE   PROC StorePolygonAssignmentsCount\r\n(\r\n\t@OperationStaffId INT ,\r\n\r\n\t@VendorId\tINT = NULL,\r\n\t@ProvinceId\tTINYINT = NULL,\r\n\t@CityId\t\tSMALLINT = NULL,\r\n\t@PolygonId\tSMALLINT = NULL,\r\n\t@StoreId\tINT = NULL,\r\n\t@CreateDate\tBIGINT = NULL,\r\n\t@DefaultDeliveryServiceProviderId TINYINT = NULL,\r\n\t@StorePolygonAssignmentCount\tINT = NULL OUTPUT,\r\n\t@StorePolygonAssignmentAllCount\tINT = NULL OUTPUT,\r\n\t@StorePolygonAssignmentFailureCount\tINT = NULL OUTPUT\t\r\n)\r\nAS\r\nSET NOCOUNT ON\r\n\r\nSELECT\r\n\t@VendorId = ISNULL(@VendorId,0),\r\n\t@ProvinceId = ISNULL(@ProvinceId,0),\r\n\t@CityId = ISNULL(@CityId,0),\r\n\t@PolygonId = ISNULL(@PolygonId,0),\r\n\t@StoreId = ISNULL(@StoreId,0),\r\n\t@DefaultDeliveryServiceProviderId = ISNULL(@DefaultDeliveryServiceProviderId,0)\r\n\r\n;WITH CTE_Polygons AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tpos.PolygonId\r\n\tFROM DP.PolygonOperationStaff pos (NOLOCK)\r\n\tWHERE pos.IsActive = 1\r\n\tAND pos.OperationStaffId = @OperationStaffId\r\n)\r\nSELECT \r\n\t@StorePolygonAssignmentFailureCount = COUNT(DISTINCT par.StoreId)\r\nFROM CTE_Polygons pos\r\nINNER JOIN DP.Polygon p (NOLOCK)\r\n\tON pos.PolygonId = p.ID\r\nINNER JOIN DP.PolygonAssignmentResult par (NOLOCK)\r\n\tON p.Id = par.PolygonId\r\n\tAND par.IsSuccessful = 0\r\nINNER JOIN DP.StoreTechnicalBasicInformationLog stbil\r\n\tON par.StoreId = stbil.StoreId\r\nINNER JOIN DP.Store s (NOLOCK)\r\n\tON par.StoreId = s.Id\r\nINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\tON p.CityId = c.Id\r\nINNER JOIN CS_Public.HAF.Province pv (NOLOCK)\r\n\tON c.ProvinceId = pv.Id\r\nWHERE \r\n\t( par.StoreId = @StoreId OR @StoreId = 0 )\r\nAND ( s.VendorId = @VendorId OR @VendorId = 0 )\r\nAND ( c.ProvinceId = @ProvinceId OR @ProvinceId = 0 )\r\nAND ( stbil.DefaultDeliveryServiceProviderId = @DefaultDeliveryServiceProviderId OR @DefaultDeliveryServiceProviderId = 0 )\r\n\r\n;WITH CTE_Polygons AS\r\n(\r\n\tSELECT DISTINCT\r\n\t\tpos.PolygonId\r\n\tFROM DP.PolygonOperationStaff pos (NOLOCK)\r\n\tWHERE pos.IsActive = 1\r\n\tAND pos.OperationStaffId = @OperationStaffId\r\n)\r\nSELECT \r\n\t@StorePolygonAssignmentCount = COUNT(DISTINCT par.StoreId)\r\nFROM CTE_Polygons pos\r\nINNER JOIN DP.Polygon p (NOLOCK)\r\n\tON pos.PolygonId = p.ID\r\nINNER JOIN DP.PolygonAssignmentResult par (NOLOCK)\r\n\tON p.Id = par.PolygonId\r\n\tAND par.IsSuccessful = 0\r\nINNER JOIN DP.StoreTechnicalBasicInformationLog stbil\r\n\tON par.StoreId = stbil.StoreId\r\nINNER JOIN DP.Store s (NOLOCK)\r\n\tON par.StoreId = s.Id\r\nINNER JOIN CS_Public.HAF.City c (NOLOCK)\r\n\tON p.CityId = c.Id\r\nINNER JOIN CS_Public.HAF.Province pv (NOLOCK)\r\n\tON c.ProvinceId = pv.Id\r\nWHERE \r\n\t( par.StoreId = @StoreId OR @StoreId = 0 )\r\nAND ( s.VendorId = @VendorId OR @VendorId = 0 )\r\nAND ( c.ProvinceId = @ProvinceId OR @ProvinceId = 0 )\r\nAND ( stbil.DefaultDeliveryServiceProviderId = @DefaultDeliveryServiceProviderId OR @DefaultDeliveryServiceProviderId = 0 )\r\n\r\n\r\n\r\nSELECT\r\n\t@StorePolygonAssignmentCount = ISNULL(@StorePolygonAssignmentCount,0),\r\n\t@StorePolygonAssignmentFailureCount = ISNULL(@StorePolygonAssignmentFailureCount,0),\r\n\t@StorePolygonAssignmentAllCount = ISNULL(@StorePolygonAssignmentAllCount,0)\r\n\t"},{"Name":"Test_Track_DispatchRequests","Schema":"dbo","Definition":"/*\r\nEXECUTE  [dbo].[Test_Track_DispatchRequests] \r\n   @DispatchRequestId=200\r\n  ,@StoreId=null\r\n  ,@VendorCode=null\r\n  ,@ParcelReferenceCode=null\r\n  ,@PolygonId=null\r\nGO\r\n*/\r\nCREATE    PROCEDURE [dbo].[Test_Track_DispatchRequests]\r\n\t@DispatchRequestId\t\tBIGINT=NULL,\t\r\n\t@StoreId\t\t\t\tINT=NULL,\r\n\t@VendorCode\t\t\t\tINT=NULL,\r\n\t@ParcelReferenceCode\tBIGINT=NULL,\r\n\t@PolygonId\t\t\t\tSMALLINT=NULL\r\nAS\r\n\r\n\r\nSELECT  dr.Id,\r\n\t\tdr.PolygonStoreId,\r\n\t\tps.PolygonId,\r\n\t\tPolygon.Title AS PolygonTitle,\r\n\t\tps.StoreId,\r\n\t\ts.Title AS StoreName,\r\n\t\ts.Location AS StoreLocation,\r\n\t\tCity.Name,\r\n\t\ts.Address AS StoreAddress,\r\n\t\ts.VendorCode,\r\n\t\tv.BrandName,\r\n\t\tdr.CourierRequestTypeId,\r\n\t\tcrt.Title AS RequestTypeName,\r\n\t\tdr.ParcelReferenceCode,\r\n\t\tdr.ClientLocation,\r\n\t\tdr.ClientAddress,\r\n\t\tdr.DeliveryStartTime,\r\n\t\tdr.DeliveryStartTimePersian,\r\n\t\tdr.DeliveryDeadLineTime,\r\n\t\tdr.DeliveryDeadLineTimePersian,\r\n\t\tDP.DispatchRequestStatusHistory.DispatchRequestStatusId,\r\n\t\tdrs.Name AS StatusName,\r\n\t\tDP.DispatchRequestStatusHistory.Location AS StatusLocation,\r\n\t\tDP.DispatchRequestStatusHistory.CreateDate,\r\n\t\tDP.DispatchRequestStatusHistory.CreateDatePersian\r\nFROM DP.DispatchRequest dr\r\n\tLEFT JOIN DP.DispatchRequestStatusHistory\t\tON dr.Id = DP.DispatchRequestStatusHistory.DispatchRequestId \r\n\tLEFT JOIN DP.PolygonStore\t ps\t\t\t\t\tON dr.PolygonStoreId = ps.Id \r\n\tLEFT JOIN DP.DispatchRequestStatus drs\t\t\tON DP.DispatchRequestStatusHistory.DispatchRequestStatusId = drs.Id \r\n\tLEFT JOIN DP.Polygon\t\t\t\t\t\t\tON ps.PolygonId = Polygon.Id \r\n\tLEFT JOIN CS_Public.pub.Store s\t\t\t\tON s.Id=ps.StoreId\r\n\tLEFT JOIN cs_public.Haf.City\t\t\t\t\tON s.CityId = City.Id \r\n\tLEFT JOIN cs_usermanagement.um.Vendor v\t\tON s.VendorId=v.Id\r\n\tLEFT JOIN CS_Public.PUB.CourierRequestType crt\tON crt.Id=dr.CourierRequestTypeId\r\nWHERE ((dr.id=@DispatchRequestId ) OR (@DispatchRequestId IS NULL))\r\n\tAND ((ps.StoreId=@StoreId)OR (@StoreId IS NULL))\r\n\tAND ((s.VendorCode=@VendorCode) OR (@VendorCode IS NULL))\t\t\t\t\r\n\tAND ((dr.ParcelReferenceCode=@ParcelReferenceCode) OR (@ParcelReferenceCode IS NULL))\r\n\tAND ((Polygon.Id=@PolygonId\t) OR (@PolygonId IS NULL))"},{"Name":"Update_StoreTechnical_ForcedAssignmentRadius","Schema":"dbo","Definition":"\r\n\r\nCREATE PROCEDURE [dbo].[Update_StoreTechnical_ForcedAssignmentRadius]\r\n\r\n\t \t @ForcedRadiusChangeType\t \t \t int\r\n\r\n\r\nAS\r\nSET NOCOUNT ON\r\nBEGIN\r\n\r\nDROP TABLE IF EXISTS #AllData\r\n\r\nSELECT P.Id,\r\n       P.CityId,\r\n       STBI.[ForcedAssignmentRadius],\r\n\t   STBI.StoreId\r\n     INTO #AllData\r\n  FROM  [CS_Dispatcher].[DP].[StoreTechnicalBasicInformation] STBI WITH(NOLOCK)\r\n  JOIN  [CS_Dispatcher].[DP].[PolygonStore]  PS WITH(NOLOCK) \r\n\t\tON STBI.StoreId = PS.StoreId\r\n  JOIN [CS_Dispatcher].[DP].[Polygon] P  WITH(NOLOCK) \r\n\t\tON PS.PolygonId = P.ID --AND P.IsActive=1\r\n  WHERE P.CityId IN (306 /*TEHRAN*/,464 /*MASHHAD*/,670  /*SHIRAZ*/)\r\n\r\n\r\n\r\nINSERT INTO [DP].[StoreTechnicalBasicInformationLog]\r\n           ([StoreId]\r\n           ,[IsCheckingArrivalPossible]\r\n           ,[CreateDate]\r\n           ,[CreateDatePersian]\r\n           ,[CreatorUserName]\r\n           ,[ScoreFactor]\r\n           ,[TimeIntervalUntilCancellation]\r\n           ,[NotPickupRequestReviewMethodId]\r\n           ,[NumberOfRequestsForNotPickupWithVendorProblem]\r\n           ,[NotPickupRequestReviewThresholdMinutes]\r\n           ,[FleetRecaptureAfterOriginArrivalMinutes]\r\n           ,[FleetAssignmentFirstNotifyMinutes]\r\n           ,[FleetAssignmentSecondNotifyMinutes]\r\n           ,[FleetRecaptureAfterAssignmentMinutes]\r\n           ,[ReturnRequestResponseThresholdMinutes]\r\n           ,[FleetForcedBikerWaiting]\r\n           ,[FleetPickupNotificationMinutes]\r\n           ,[FleetRecaptureMinutes]\r\n           ,[IsDeliveryCodeRequired]\r\n           ,[IsReturnCodeRequired]\r\n           ,[MinimumValueForDeliveryCode]\r\n           ,[IsDeliveryCodeIssuedByVendor]\r\n           ,[StoreOrderPriority]\r\n           ,[MaximumAssignmentRadius]\r\n           ,[ForcedAssignmentRadius]\r\n           ,[MaximumOriginArrivalEtaSeconds])\r\n     \r\n\t select STBI.[StoreId]\r\n           ,[IsCheckingArrivalPossible]\r\n           ,CONVERT(char(8),GETDATE(),112)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n           ,REPLACE(FORMAT(GETDATE(),\u0027yyyy/MM/dd\u0027,\u0027fa\u0027),\u0027/\u0027,\u0027\u0027)\u002BREPLACE(CONVERT(char(12),GETDATE(), 114),\u0027:\u0027,\u0027\u0027)\r\n           ,N\u00271|REMINDER\u0027\r\n           ,[ScoreFactor]\r\n           ,[TimeIntervalUntilCancellation]\r\n           ,[NotPickupRequestReviewMethodId]\r\n           ,[NumberOfRequestsForNotPickupWithVendorProblem]\r\n           ,[NotPickupRequestReviewThresholdMinutes]\r\n           ,[FleetRecaptureAfterOriginArrivalMinutes]\r\n           ,[FleetAssignmentFirstNotifyMinutes]\r\n           ,[FleetAssignmentSecondNotifyMinutes]\r\n           ,[FleetRecaptureAfterAssignmentMinutes]\r\n           ,[ReturnRequestResponseThresholdMinutes]\r\n           ,[FleetForcedBikerWaiting]\r\n           ,[FleetPickupNotificationMinutes]\r\n           ,[FleetRecaptureMinutes]\r\n           ,[IsDeliveryCodeRequired]\r\n           ,[IsReturnCodeRequired]\r\n           ,[MinimumValueForDeliveryCode]\r\n           ,[IsDeliveryCodeIssuedByVendor]\r\n           ,[StoreOrderPriority]\r\n           ,[MaximumAssignmentRadius]\r\n           ,[ForcedAssignmentRadius]\r\n           ,[MaximumOriginArrivalEtaSeconds]\r\nFROM [CS_Dispatcher].[DP].[StoreTechnicalBasicInformation] STBI\r\n  JOIN  [CS_Dispatcher].[DP].[PolygonStore]  PS WITH(NOLOCK) \r\n\t\tON STBI.StoreId = PS.StoreId\r\n  JOIN [CS_Dispatcher].[DP].[Polygon] P  WITH(NOLOCK) \r\n\t\tON PS.PolygonId = P.ID --AND P.IsActive=1\r\n  WHERE P.CityId IN (306 /*TEHRAN*/,464 /*MASHHAD*/,670  /*SHIRAZ*/)\r\n\r\n\r\nIF @ForcedRadiusChangeType =1 \r\n\tBEGIN\r\n\t\t\r\n\t\tUPDATE [CS_Dispatcher].[DP].[StoreTechnicalBasicInformation]\r\n\t\tSET [ForcedAssignmentRadius]=4000\r\n\t\tWHERE StoreId IN (SELECT StoreId \r\n\t\t\t\t\t\t  FROM #AllData\r\n\t\t\t\t\t\t  WHERE CityId=306  )\r\n\r\n\r\n        UPDATE [CS_Dispatcher].[DP].[StoreTechnicalBasicInformation]\r\n\t\tSET [ForcedAssignmentRadius]=5000\r\n\t\tWHERE StoreId IN (SELECT StoreId \r\n\t\t\t\t\t\t  FROM #AllData\r\n\t\t\t\t\t\t  WHERE CityId IN (464,670)  )\r\n\r\n\tEND\r\n\r\n\r\n\r\nIF @ForcedRadiusChangeType =2 \r\n\tBEGIN\r\n\t\t\r\n\t\tUPDATE [CS_Dispatcher].[DP].[StoreTechnicalBasicInformation]\r\n\t\tSET [ForcedAssignmentRadius]=2000\r\n\t\tWHERE StoreId IN (SELECT StoreId \r\n\t\t\t\t\t\t  FROM #AllData\r\n\t\t\t\t\t\t  WHERE CityId=306 AND Id != 79 /*R1.TEHRAN.P42 FD*/ )\r\n\r\n      \tUPDATE [CS_Dispatcher].[DP].[StoreTechnicalBasicInformation]\r\n\t\tSET [ForcedAssignmentRadius]=3000\r\n\t\tWHERE StoreId IN (SELECT StoreId \r\n\t\t\t\t\t\t  FROM #AllData\r\n\t\t\t\t\t\t  WHERE    (CityId = 306 AND ID = 79)\r\n\t\t                        OR  CityId IN (464,670))\r\n\r\n\tEND\r\n\r\n\r\n\r\nEND\r\n"},{"Name":"Update_StoreTechnicalBasicInformation","Schema":"dbo","Definition":"\r\nCREATE PROCEDURE [dbo].[Update_StoreTechnicalBasicInformation]\r\n\r\nAS\r\nBEGIN\r\nDROP TABLE IF EXISTS #t\r\ndeclare  @date bigint =FORMAT(GETDATE(), \u0027yyyyMMdd\u0027)\r\nselect id into #t from  [CS_Dispatcher].[DP].[Store] with(nolock)\r\nwhere [VendorId] not in (37,726)\r\n  and left (createdate,8)=@date\r\ncreate index ix_1 on #t (id);\r\nupdate [CS_Dispatcher].[DP].[StoreTechnicalBasicInformation]\r\nset\r\n  [ScoreFactor]=900,\r\n  [StoreOrderPriority]=2,\r\n  [NotPickupRequestReviewMethodId]=1\r\nwhere [StoreId] in (select id from #t)\r\n\r\nEND\r\n"}],"Functions":[{"Name":"ConvertToShamsi","Schema":"dbo","Definition":"\r\ncreate   FUNCTION [dbo].[ConvertToShamsi] ( @intDate DATETIME )\r\n\r\nRETURNS NVARCHAR(max)\r\n\r\nBEGIN\r\n\r\n \r\n\r\nDECLARE @shYear AS INT ,@shMonth AS INT ,@shDay AS INT ,@intYY AS INT ,@intMM AS INT ,@intDD AS INT ,@Kabiseh1 AS INT ,@Kabiseh2 AS INT ,@d1 AS INT ,@m1 AS INT, @shMaah AS NVARCHAR(max),@shRooz AS NVARCHAR(max),@DayCnt AS INT,@shdaay AS NVARCHAR(max)\r\n\r\nDECLARE @DayDate AS NVARCHAR(max)\r\n\r\n \r\n\r\nSET @intYY = DATEPART(yyyy, @intDate)\r\n\r\n \r\n\r\nIF @intYY \u003C 1000 SET @intYY = @intYY \u002B 2000\r\n\r\n \r\n\r\nSET @intMM = MONTH(@intDate)\r\n\r\nSET @intDD = DAY(@intDate)\r\n\r\nSET @shYear = @intYY - 622\r\n\r\nSET @DayCnt = datepart(dw, \u002701/02/\u0027 \u002B CONVERT(CHAR(4), @intYY))\r\n\r\n \r\n\r\nSET @m1 = 1\r\n\r\nSET @d1 = 1\r\n\r\nSET @shMonth = 10\r\n\r\nSET @shDay = 11\r\n\r\n \r\n\r\nIF ( ( @intYY - 1993 ) % 4 = 0 ) SET @shDay = 12\r\n\r\n \r\n\r\nWHILE ( @m1 != @intMM ) OR ( @d1 != @intDD )\r\n\r\nBEGIN\r\n\r\n \r\n\r\n  SET @d1 = @d1 \u002B 1\r\n\r\n  SET @DayCnt = @DayCnt \u002B 1\r\n\r\n \r\n\r\n  IF ( ( @intYY - 1992 ) % 4 = 0) SET @Kabiseh1 = 1 ELSE SET @Kabiseh1 = 0\r\n\r\n \r\n\r\n  IF ( ( @shYear - 1371 ) % 4 = 0) SET @Kabiseh2 = 1 ELSE SET @Kabiseh2 = 0\r\n\r\n \r\n\r\n  IF\r\n\r\n  (@d1 = 32 AND (@m1 = 1 OR @m1 = 3 OR @m1 = 5 OR @m1 = 7 OR @m1 = 8 OR @m1 = 10 OR @m1 = 12))\r\n\r\n  OR\r\n\r\n  (@d1 = 31 AND (@m1 = 4 OR @m1 = 6 OR @m1 = 9 OR @m1 = 11))\r\n\r\n  OR\r\n\r\n  (@d1 = 30 AND @m1 = 2 AND @Kabiseh1 = 1)\r\n\r\n  OR\r\n\r\n  (@d1 = 29 AND @m1 = 2 AND @Kabiseh1 = 0)\r\n\r\n  BEGIN\r\n\r\n    SET @m1 = @m1 \u002B 1\r\n\r\n    SET @d1 = 1\r\n\r\n  END\r\n\r\n \r\n\r\n  IF @m1 \u003E 12\r\n\r\n  BEGIN\r\n\r\n    SET @intYY = @intYY \u002B 1\r\n\r\n    SET @m1 = 1\r\n\r\n  END\r\n\r\n \r\n\r\n  IF @DayCnt \u003E 7 SET @DayCnt = 1\r\n\r\n \r\n\r\nSET @shDay = @shDay \u002B 1\r\n\r\n \r\n\r\n  IF\r\n\r\n  (@shDay = 32 AND @shMonth \u003C 7)\r\n\r\n  OR\r\n\r\n  (@shDay = 31 AND @shMonth \u003E 6 AND @shMonth \u003C 12)\r\n\r\n  OR\r\n\r\n  (@shDay = 31 AND @shMonth = 12 AND @Kabiseh2 = 1)\r\n\r\n  OR\r\n\r\n  (@shDay = 30 AND @shMonth = 12 AND @Kabiseh2 = 0)\r\n\r\n  BEGIN\r\n\r\n    SET @shMonth = @shMonth \u002B 1\r\n\r\n    SET @shDay = 1\r\n\r\n  END\r\n\r\n \r\n\r\n  IF @shMonth \u003E 12\r\n\r\n  BEGIN\r\n\r\n    SET @shYear = @shYear \u002B 1\r\n\r\n    SET @shMonth = 1\r\n\r\n  END\r\n\r\n \r\n\r\nEND\r\n\r\n \r\n\r\nIF @shMonth=1 SET @shMaah=\u002701\u0027\r\n\r\nIF @shMonth=2 SET @shMaah=\u002702\u0027\r\n\r\nIF @shMonth=3 SET @shMaah=\u002703\u0027\r\n\r\nIF @shMonth=4 SET @shMaah=\u002704\u0027\r\n\r\nIF @shMonth=5 SET @shMaah=\u002705\u0027\r\n\r\nIF @shMonth=6 SET @shMaah=\u002706\u0027\r\n\r\nIF @shMonth=7 SET @shMaah=\u002707\u0027\r\n\r\nIF @shMonth=8 SET @shMaah=\u002708\u0027\r\n\r\nIF @shMonth=9 SET @shMaah=\u002709\u0027\r\n\r\nIF @shMonth=10 SET @shMaah=\u002710\u0027\r\n\r\nIF @shMonth=11 SET @shMaah=\u002711\u0027\r\n\r\nIF @shMonth=12 SET @shMaah=\u002712\u0027\r\n\r\nset @shdaay = LTRIM(STR(@shDay,2))  \r\nif @shDay\u003C10 \r\n\tSET @shdaay= \u00270\u0027 \u002B @shdaay\r\n\r\nSET @DayDate =    STR(@shYear,4) \u002B \u0027/\u0027 \u002B @shMaah \u002B \u0027/\u0027 \u002B @shdaay\r\n\r\nRETURN @DayDate\r\n\r\nEND\r\n","Type":"Scalar Function"},{"Name":"FN_DateDiff","Schema":"dbo","Definition":"/*\r\n-- =============================================\r\n-- Create by: Davood Taherkhani\r\n-- Create date: 1400/08/24\r\n\r\n-- Update Proc: ROSHANAK RAHIMI\r\n-- Update Date : 1400/08/26\r\n-- =============================================\r\n*/\r\n/*\r\nselect dbo.FN_DateDiff(20211113161236608,20211214161236608)\r\n*/\r\n\r\nCREATE   FUNCTION [dbo].[FN_DateDiff] (\r\n\t@FromDate\tBIGINT,\r\n\t@ToDate\t\tBIGINT\r\n\t)\r\nRETURNS INT\r\nAS\r\nBEGIN\r\n\r\n\tIF (@FromDate IS NULL) OR (@ToDate IS NULL )\r\n\t\tRETURN -1\r\n\r\n\tDECLARE @Days iNT\r\n\tSET @Days=(SELECT DATEDIFF(DAY, CAST (\tCONCAT(LEFT(LEFT(@FromDate,8),4),\u0027-\u0027,\r\n\t\t\t\t\tSUBSTRING(LEFT(@FromDate,8),5,2),\u0027-\u0027,\r\n\t\t\t\t\tRIGHT(LEFT(@FromDate,8),2)\r\n\t\t\t\t   )\r\n\t\t\t\t   AS DATE\r\n\t\t\t\t   )\r\n\t\t\t\t   ,\r\n\t\t\t\t  CAST (CONCAT(LEFT(LEFT(@ToDate,8),4),\u0027-\u0027,\r\n\t\t\t\t\tSUBSTRING(LEFT(@ToDate,8),5,2),\u0027-\u0027,\r\n\t\t\t\t\tRIGHT(LEFT(@ToDate,8),2)\r\n\t\t\t\t   )\r\n\t\t\t\t   AS DATE\r\n\t\t\t\t   ))\r\n\t\t\t  )\r\n\tRETURN  @Days\r\n\r\nEND\r\n","Type":"Scalar Function"},{"Name":"fn_diagramobjects","Schema":"dbo","Definition":"\r\n\tCREATE FUNCTION dbo.fn_diagramobjects() \r\n\tRETURNS int\r\n\tWITH EXECUTE AS N\u0027dbo\u0027\r\n\tAS\r\n\tBEGIN\r\n\t\tdeclare @id_upgraddiagrams\t\tint\r\n\t\tdeclare @id_sysdiagrams\t\t\tint\r\n\t\tdeclare @id_helpdiagrams\t\tint\r\n\t\tdeclare @id_helpdiagramdefinition\tint\r\n\t\tdeclare @id_creatediagram\tint\r\n\t\tdeclare @id_renamediagram\tint\r\n\t\tdeclare @id_alterdiagram \tint \r\n\t\tdeclare @id_dropdiagram\t\tint\r\n\t\tdeclare @InstalledObjects\tint\r\n\r\n\t\tselect @InstalledObjects = 0\r\n\r\n\t\tselect \t@id_upgraddiagrams = object_id(N\u0027dbo.sp_upgraddiagrams\u0027),\r\n\t\t\t@id_sysdiagrams = object_id(N\u0027dbo.sysdiagrams\u0027),\r\n\t\t\t@id_helpdiagrams = object_id(N\u0027dbo.sp_helpdiagrams\u0027),\r\n\t\t\t@id_helpdiagramdefinition = object_id(N\u0027dbo.sp_helpdiagramdefinition\u0027),\r\n\t\t\t@id_creatediagram = object_id(N\u0027dbo.sp_creatediagram\u0027),\r\n\t\t\t@id_renamediagram = object_id(N\u0027dbo.sp_renamediagram\u0027),\r\n\t\t\t@id_alterdiagram = object_id(N\u0027dbo.sp_alterdiagram\u0027), \r\n\t\t\t@id_dropdiagram = object_id(N\u0027dbo.sp_dropdiagram\u0027)\r\n\r\n\t\tif @id_upgraddiagrams is not null\r\n\t\t\tselect @InstalledObjects = @InstalledObjects \u002B 1\r\n\t\tif @id_sysdiagrams is not null\r\n\t\t\tselect @InstalledObjects = @InstalledObjects \u002B 2\r\n\t\tif @id_helpdiagrams is not null\r\n\t\t\tselect @InstalledObjects = @InstalledObjects \u002B 4\r\n\t\tif @id_helpdiagramdefinition is not null\r\n\t\t\tselect @InstalledObjects = @InstalledObjects \u002B 8\r\n\t\tif @id_creatediagram is not null\r\n\t\t\tselect @InstalledObjects = @InstalledObjects \u002B 16\r\n\t\tif @id_renamediagram is not null\r\n\t\t\tselect @InstalledObjects = @InstalledObjects \u002B 32\r\n\t\tif @id_alterdiagram  is not null\r\n\t\t\tselect @InstalledObjects = @InstalledObjects \u002B 64\r\n\t\tif @id_dropdiagram is not null\r\n\t\t\tselect @InstalledObjects = @InstalledObjects \u002B 128\r\n\t\t\r\n\t\treturn @InstalledObjects \r\n\tEND\r\n\t","Type":"Scalar Function"},{"Name":"GetFleetPreAssignmentStateCount","Schema":"dbo","Definition":"/*\r\n--\t=======================================\r\n--\tAuthor:\t\t\tParisa Khorshidi\r\n--\tCreate date:\t1401/07/16\r\n--\tDescription:\tGet Not PickedUp Parcel List\r\n--\r\n--\t=======================================\r\n*/\r\n/*\r\nselect [dbo].[GetFleetPreAssignmentStateCount](27961)\r\n*/\r\n\r\nCREATE FUNCTION [dbo].[GetFleetPreAssignmentStateCount] (\r\n\t@DispatchRequestId\tBIGINT\r\n\t)\r\nRETURNS INT\r\nAS\r\nBEGIN\r\n\r\n\tIF (@DispatchRequestId IS NULL) \r\n\t\tRETURN -1\r\n\r\n\tDECLARE @FleetPreAssignmentStateCount iNT\r\n\tSET @FleetPreAssignmentStateCount=(\r\n                                            SELECT \r\n                                                    COUNT(CreateDate)\r\n                                            FROM \r\n                                            (\r\n                                                SELECT LEFT(drfpas.CreateDate,12) CreateDate\r\n                                                FROM DP.DispatchRequestFleetPreAssignmentState drfpas \r\n                                                WHERE drfpas.DispatchRequestId=@DispatchRequestId\r\n                                                GROUP BY LEFT(drfpas.CreateDate,12)\r\n                                            )UnsuccessfulCount\r\n                                        )\r\n\tRETURN  @FleetPreAssignmentStateCount\r\n\r\nEND\r\n","Type":"Scalar Function"}]}